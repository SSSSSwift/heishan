function Set_Eff_Text(id, txwz, str)
	if WAR.Person[id][txwz] ~= nil then
		WAR.Person[id][txwz] = WAR.Person[id][txwz].."+"..str
	else
		WAR.Person[id][txwz] = str
	end
end

function DWPD12(a,d)
    if WAR.Person[a]['我方'] ~= WAR.Person[d]['我方'] then 
        return true
    end
    return false
end


function PersonStatus(t,page)
   local bx = CC.ScreenW/1360
   local by = CC.ScreenH/768
   local size = CC.DefaultFont*0.6
   local size1 = CC.DefaultFont*0.5
   local size2 = CC.DefaultFont*0.45
   local h = by*size1*1.2
   local cx = 1 
   local cx1 = 1
   local fy = 0 --属性说明翻页
   local fymax = 0 --最大翻页
   local team = {}
   if JY.Restart == 1 then
		do return end
	end
   for tt = 1,CC.TeamNum do 
       if JY.Base['队伍'..tt] >= 0 then 
	      team[#team+1] = JY.Base['队伍'..tt]
	   end
   end 
   if page == nil then 
      page = 1 
   end
   
	
   
   -- if JY.Status == GAME_WMAP then
	    -- if WAR.Person[teamid]["我方"] == false then
	        -- pagenum = 2
	    -- end
	-- end

   while true do
   Cls()
   local id = -1
   if JY.Status == GAME_WMAP then

	  id=WAR.Person[t-1]["人物编号"]
   else 
      id = JY.Base['队伍'..t]
   end
   local p = JY.Person[id]
   
 		local hid = nil
		--主角
		if id == 0 and JY.Base["畅想"] == 0 then
			--标主
			if JY.Base["标准"] > 0 then
				if p["性别"] == 0 then
					hid = 546 + JY.Base["标准"]
				else
					hid = 555 + JY.Base["标准"]
				end
			--特殊
			else
				if p["性别"] == 0 then
					hid = 290
				else
					hid = 368
				end
			end
		--畅想主角和队友
		else
			hid = p["头像代号"]
			if p["头像代号"] == 217 then
			hid = 389
			end
			if p["头像代号"] == 93 then
			   if (id == 0 and JY.Base["畅想"] == 507) or id == 507 then
			   hid = 206
			   end
			end
			   if (id == 0 and JY.Base["畅想"] == 646) or id == 646 then
			   hid = 584
			   end
		end
		
   local picx,picy = lib.GetPNGXY(1,hid*2)
   local lb = {{},{},{},{},{}}
   local lb1 = {}
   local lb2 = {nil,nil,nil,nil,nil}
   local function DrawAttrib(str, x,y,color1,size)
		local i = 0
		--DrawString(x1, y1 + h * i, string.sub(4), color1, size)
		--额外系数显示
		--local str;

		
		if str == "御剑能力" then
			local bonus = 0
			--五岳剑法
			if WuyueJF(id) then
				bonus=bonus+ 50
			end
			
			if bonus > 0 then
				DrawString(x, y, string.format("↑ %s",bonus), color1, size)
			end
		end
		
		
		
		
		
		--战场情侣加成暗器技巧
		if JY.Status == GAME_WMAP then
				if str == "医疗能力" then
					for k,v in pairs(CC.AddDoc) do
						if match_ID(id, v[1]) then
							for wid = 0, WAR.PersonNum - 1 do
								if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
									DrawString(x,y, "↑ "..v[3], color1, size)
									--break
								end
							end
						end
					end
					
				end
				if str == "用毒能力" then
					for k,v in pairs(CC.AddPoi) do
						if match_ID(id, v[1]) then
							for wid = 0, WAR.PersonNum - 1 do
								if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
									DrawString(x,y, "↑ "..v[3], color1, size)
									--break
								end
							end
						end
					end
					
				end
				
			i = i + 1
		end
	end

	-- if case == nil then
		-- if JY.Status ~= GAME_WMAP then
			-- DrawString(x1-size*5, y1 + h * (i)+2, "上下键换人 →键显示人物天赋 ESC退出", M_PaleTurquoise, size*0.7)
		-- else
			-- DrawString(x1-size*5, y1 + h * (i)+2, "上下键换人 →键显示人物天赋 ESC退出", Snow3, size*0.7)
		-- end
	-- else
		-- DrawString(x1-size*5, y1 + h * (i)+2, "上下键选择属性 左右键减少/增加 回车键确认加点", Snow3, size*0.7)
	-- end


  --[[ if psx(id,'天赋外功1') > 0 or psx(id,'天赋外功2') > 0 or psx(id,'天赋内功') > 0 or psx(id,'天赋轻功') > 0  then 
      lb1[#lb1+1] = 1
	  lb2[1] = #lb1
	  lb2[2] = lb2[1]
   end]]
   local i = 0
   --背景图
   --lib.PicLoadCache(99,121*2,CC.ScreenW/2,CC.ScreenH/2,2,256,nil,bx*1360)
   lib.LoadPNG(91, 149 * 2 ,0 , 0, 1)
   --人物半身像
   pngxy(90,hid*2,bx*200,CC.ScreenH-by*300,2)
   --门派
   -- if MPPD(id) ~= nil and MPPD(id) > 0 then 
	  -- DrawString(bx*30,by*70,CC.MP[MPPD(id)][1]..CC.MPDJ[MPPD(id)][MPDJ(id)],C_ORANGE,size)
   -- else 
	  -- DrawString(bx*30,by*70,'江湖人士',C_WHITE,size)
   -- end
	if MPPD(id) ~= 0 then
		local mptype, mpdj = MPDISPLAY(id)
		local str = ""
		local str1 = ""
		local color = ""
		if mptype ~= nil then
			if MPPD(id) == 5 and match_ID(id,66) then
				str = "【".."波斯明教".."】"
				str1 = "【".."圣女".."】"
				color = M_Red
				--DrawString(bx*30,by*70, , M_Red, size*0.8)
			elseif MPPD(id) == 5 and (id == 0 and JY.Base["畅想"] == 0 and MPDJ(id) > 4) then
				str = "【".."明教".."】"
				str1 = "【".."代行使者".."】"
				color = C_GOLD
				--DrawString(bx*30,by*70, "【".."明教代行使者".."】", C_GOLD, size*0.8)								
			else
				str = "【"..mptype.."】"
				str1 = "【"..mpdj.."】"
				color =  M_DeepSkyBlue
				--DrawString(bx*30,by*70, "【"..mptype..mpdj.."】", M_DeepSkyBlue, size*0.8)
			end
		else
			str = "【江湖人士】"
			str1 = "【无】"
			color = C_ORANGE
		end
		DrawString(bx*55,by*70, "所属门派："..str, color, size)
		DrawString(bx*55,by*70+size+5, "门派位阶："..str1, color, size)
	else
		local str = "【江湖人士】"
		local str1 = "【无】"
		local color = C_ORANGE
		DrawString(bx*55,by*70, "所属门派："..str, color, size)
		DrawString(bx*55,by*70+size+5, "门派位阶："..str1, color, size)
	end
		local ch = nil
		local chcl = C_CYGOLD
		--local fj = {[0] = {"传说",C_ORANGE},{"宗师",M_DarkRed},{"豪侠",C_RED},{"一流",M_Pink},{"二流",M_Pink},{"三流",M_Blue},{"弟子",M_LightBlue},{"菜鸟",C_CYGOLD}}

        --local fjstr = "【"..fj[p["畅想分阶"]][1].."】"
        local nametre = p["姓名"]
        local djstr = p["等级"].."级"
        
        --local namex = CC.ScreenW/2-string.len(fjstr..nametre..djstr)/4*size
        --local fjx = namex + string.len(nametre)/2*size
       -- local djx = fjx + string.len(fjstr)/2*size
		-- DrawString(fjx, dx*24, fjstr, fj[JY.Person[id]["畅想分阶"]][2], size*0.8)
		-- DrawString(namex, dx*20, nametre, C_CYGOLD, size)		
		-- DrawString(djx, dx*24, djstr, C_CYGOLD, size*0.8)
   --人物姓名
   --DrawString(bx*280,by*70,name(id),C_WHITE,size)
	   DrawString(bx*150,by*10,JY.Person[id]['姓名'],M_Yellow,size*1.3)--..fjstr
	   local tfx1 = bx*55
	   local fty1 = by*79+50
	   local fty2 = 0
	   local fty3 = 0
	   --主角
	   if id == 0 then
			local main_tf;
			--标主
			if JY.Base["标准"] > 0 then
				main_tf = ZJTF[JY.Base["标准"]]
			--特殊
			elseif JY.Base["特殊"] > 0 then
				main_tf = " "
			--畅想
			elseif JY.Base["畅想"] > 0 then
				if RWTFLB[p["代号"]] ~= nil then
					main_tf = RWTFLB[p["代号"]]
				end
			end
			if main_tf ~= nil then
				DrawString(tfx1, fty1,"一般称号：".."【"..main_tf.."】", C_ORANGE, size)
			--else
				--main_tf = "卧龙伏凤"
				--DrawString(tfx1 -string.len(main_tf)/4*size*0.8, fty1,"一般称号："..main_tf , C_ORANGE, size)
			fty2 = size + 5
			end
			
		end

		--普通角色天赋
		if id ~= 0 and RWTFLB[id] ~= nil then
			--DrawString(x1-7, y1 + h * (i)-142,RWTFLB[id], C_CYGOLD, size*0.8)
		    DrawString(tfx1, fty1,"一般称号：".."【".. RWTFLB[id].."】", C_ORANGE, size)
			fty2 = size	+5	
		end
	  
		fty1 = fty1+fty2
		--主角称号
		if id == 0 then
			local main_ch;
			--标主
			if JY.Base["标准"] > 0 then
				if p["六如觉醒"] == 0 then
					main_ch = "江湖小虾米"
				else
					main_ch = "觉醒之苍龙"
				end
			--特殊
			elseif JY.Base["特殊"] > 0 then
				main_ch = ''--TSTF[JY.Base["特殊"]]
			--畅想
			elseif JY.Base["畅想"] > 0 then
				if RWWH[JY.Base["畅想"]] ~= nil and JY.Base["畅想"] ~= 35 and JY.Base["畅想"] ~= 38 and JY.Base["畅想"] ~= 49 then
					main_ch = RWWH[JY.Base["畅想"]]
				elseif JY.Base["畅想"] == 35 then
					if JY.Person[id]["个人觉醒"] >= 2 then
						main_ch = RWWH["35"]
						--DrawString(tfx1 -string.len(RWWH["35"])/4*size*0.8, by*122,  RWWH["35"], C_ORANGE, size)	
					elseif JY.Person[id]["个人觉醒"] >= 1 then
						main_ch = RWWH[35]
						--DrawString(x1-7, y1 + h * (i)-100, RWWH[35], C_CYGOLD, size*0.8)
						 --DrawString(tfx1 -string.len(RWWH["35"])/4*size*0.8, by*122,  RWWH["35"], C_ORANGE, size)		
					end
				elseif JY.Base["畅想"] == 38 then
					if JY.Person[id]["个人觉醒"] >= 2 then
						main_ch =  RWWH["38-2"]
					elseif JY.Person[id]["个人觉醒"] >= 1 then
						main_ch =  RWWH["38"]
					else
						main_ch =  RWWH[38]
					end
				elseif JY.Base["畅想"] == 49 then
					if JY.Person[id]["个人觉醒"] >= 1 then
						main_ch = RWWH["49"]
						--DrawString(x1-7, y1 + h * (i)-100, RWWH["49"], C_CYGOLD, size*0.8)
					   --DrawString(tfx1 -string.len(RWWH["49"])/4*size*0.8, by*122,  RWWH["49"], C_ORANGE, size)	
					else
						main_ch = RWWH[49]
						--DrawString(x1-7, y1 + h * (i)-100, RWWH[49], C_CYGOLD, size*0.8)
					   --DrawString(tfx1 -string.len(RWWH[49])/4*size*0.8, by*122,  RWWH[49], C_ORANGE, size)	
					end			
				end
			end
			if main_ch ~= nil then
				--DrawString(x1-7, y1 + h * (i)-100, main_ch, C_CYGOLD, size*0.8)
				 DrawString(tfx1, fty1,"天赋称号：".."【"..main_ch.."】", C_ORANGE, size)	
				fty3 = size+5
			end
		end
		
		--其他人称号
		if RWWH[id] ~= nil and id ~= 35 and id ~= 38 and id ~= 49 then
			--DrawString(x1-7, y1 + h * (i)-100, RWWH[id], C_CYGOLD, size*0.8)
		    DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH[id].."】", C_ORANGE, size)	
			fty3 = size+5
		end

		--令狐冲
		if id == 35 then
			if JY.Person[id]["个人觉醒"] >= 2 then
				--DrawString(x1-7, y1 + h * (i)-100, RWWH["35"], C_CYGOLD, size*0.8)
				DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH["35"].."】", C_ORANGE, size)
				fty3 = size
			elseif JY.Person[id]["个人觉醒"] >= 1 then
			--	DrawString(x1-7, y1 + h * (i)-100, RWWH[35], C_CYGOLD, size*0.8)
				 DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH[35].."】", C_ORANGE, size)
				fty3 = size+5
			end
		end

		--虚竹
		if id == 49 then
			if JY.Person[id]["个人觉醒"] >= 1 then
				--DrawString(x1-7, y1 + h * (i)-100, RWWH["49"], C_CYGOLD, size*0.8)
				  DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH["49"].."】", C_ORANGE, size)	
				fty3 = size+5
			else
				--DrawString(x1-7, y1 + h * (i)-100, RWWH[49], C_CYGOLD, size*0.8)
				  DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH[49].."】", C_ORANGE, size)	
				fty3 = size+5
			end
		end
	  
		--石破天
		if id == 38 then
			if JY.Person[id]["个人觉醒"] >= 1 then
				--DrawString(x1-7, y1 + h * (i)-100, RWWH["38"], C_CYGOLD, size*0.8)
				  DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH["38"].."】", C_ORANGE, size)	
				fty3 = size+5
			end
		end
		
		--郭襄
		if id == 626 then
			if JY.Person[id]["个人觉醒"] >= 1 then
			--	DrawString(x1-7, y1 + h * (i)-100, RWWH["626"], C_CYGOLD, size*0.8)
				  DrawString(tfx1, fty1,"天赋称号：".."【"..RWWH["626"].."】", C_ORANGE, size)	
				fty3 = size+5
			end
		end
	fty1 = fty1 + fty3
	local fj = {[0] = {"传说",C_ORANGE},{"宗师",M_DarkRed},{"豪侠",C_RED},{"一流",M_Pink},{"二流",M_Pink},{"三流",M_Blue},{"弟子",M_LightBlue},{"菜鸟",C_CYGOLD}}
    local fjstr = "【"..fj[p["畅想分阶"]][1].."】"
	DrawString(tfx1, fty1,"修为称号："..fjstr, fj[p["畅想分阶"]][2], size)
   --人物说明
    -- --人物天赋2
local T = {M_RED, LightSkyBlue,C_GOLD,M_Orange}
local D = {"初","中","高","极"}
local dj = "未"
local dj1 = "未"
local dj2 = "未"
local dj3 = "未"
   if psx(id,'天赋外功1') > 0 then 
      local str = M_Sienna
			if wglw(id,p["天赋外功1"])<1 then

			else
			str = T[wglw(id,p["天赋外功1"])]
			dj = D[wglw(id,p["天赋外功1"])]
			end
         DrawString(bx*420,by*60+0*h,"天赋外功："..JY.Wugong[psx(id,'天赋外功1')]['名称'].."."..dj,str,size1)
	--	 i = i + 1
	--  end
	else
		DrawString(bx*420,by*60+0*h,"天赋外功：无",C_WHITE,size1)
	--	 i = i + 1
   end
   
   if psx(id,'天赋外功2') > 0 then 
			local str = M_Sienna
			if wglw(id,p["天赋外功2"])<1 then

			else
			str = T[wglw(id,p["天赋外功2"])]
			dj1 = D[wglw(id,p["天赋外功2"])]
			end
         DrawString(bx*420,by*60+1*h,"天赋外功："..JY.Wugong[psx(id,'天赋外功2')]['名称'].."."..dj1,str,size1)
	--	 i = i + 1
	--  end
	else
		DrawString(bx*420,by*60+1*h,"天赋外功：无",C_WHITE,size1)
	--	 i = i + 1
   end
   if psx(id,'天赋内功') > 0 then 
			local str = M_Sienna
			if nglw(id,p["天赋内功"])<1 then

			else
			str = T[nglw(id,p["天赋内功"])]
			dj2 = D[nglw(id,p["天赋内功"])]
			end
         DrawString(bx*420,by*60+2*h,"天赋内功："..JY.Wugong[psx(id,'天赋内功')]['名称'].."."..dj2,str,size1)
	--	 i = i + 1
	--  end
	else
		DrawString(bx*420,by*60+2*h,"天赋内功：无",C_WHITE,size1)
	--	 i = i + 1
   end
   if psx(id,'天赋轻功') > 0 then 
			local str = M_Sienna
			D = {"初","极"}
			if qglw(id,p["天赋轻功"])<1 then

			else
			str = T[qglw(id,p["天赋轻功"])]
			dj3 = D[qglw(id,p["天赋轻功"])]
			end
         DrawString(bx*420,by*60+3*h,"天赋轻功："..JY.Wugong[psx(id,'天赋轻功')]['名称'].."."..dj3,str,size1)
	--	 i = i + 1
	--  end
	else
		DrawString(bx*420,by*60+3*h,"天赋轻功：无",C_WHITE,size1)
	--	 i = i + 1
   end
   
local tfid;
		--主角
		if id == 0 then
			--标主
			if JY.Base["标准"] > 0 then
				tfid = 280 + JY.Base["标准"]
			--特殊
			elseif JY.Base["特殊"] > 0 then
				tfid = 290
			--畅想
			else
				tfid = JY.Base["畅想"]
				--畅想袁承志
				if JY.Base["畅想"] == 54 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "54-1"
				elseif JY.Base["畅想"] == 1 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "1-1"
				elseif JY.Base["畅想"] == 2 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "2-1"
				elseif JY.Base["畅想"] == 3 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "3-1"
				elseif JY.Base["畅想"] == 4 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "4-1"
				elseif JY.Base["畅想"] == 26 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "26-1"
				elseif JY.Base["畅想"] == 47 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "47-1"
				elseif JY.Base["畅想"] == 48 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "48-1"
				elseif JY.Base["畅想"] == 49 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "49-1"
				elseif JY.Base["畅想"] == 72 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "72-1"
				elseif JY.Base["畅想"] == 103 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "103-1"
				elseif JY.Base["畅想"] == 38 and JY.Person[id]["个人觉醒"] >= 1 then
					if JY.Person[id]["个人觉醒"] < 2 then
					tfid = "38-1"
					else
					tfid = "38-2"
					end
				end
			end
		--队友
		else
			tfid = id
			--畅想袁承志
			if id == 54 and JY.Person[id]["个人觉醒"] >= 1 then
				tfid = "54-1"
				elseif id == 1 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "1-1"
				elseif id == 2 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "2-1"
				elseif id == 3 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "3-1"
				elseif id == 4 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "4-1"
				elseif id == 26 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "26-1"
				elseif id == 47 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "47-1"
				elseif id == 48 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "48-1"
				elseif id == 49 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "49-1"
				elseif id == 72 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "72-1"
				elseif id == 103 and JY.Person[id]["个人觉醒"] >= 1 then
					tfid = "103-1"
				elseif id == 38 and JY.Person[id]["个人觉醒"] >= 1 then
					if JY.Person[id]["个人觉醒"] < 2 then
					tfid = "38-1"
					else
					tfid = "38-2"
				    end
				elseif id == 645 and D1ZSF(id) then
				    tfid = "645-1"
				elseif id == 645 and D2ZBT(id) then
				    tfid = "645-2"
				elseif id == 645 and D3FQY(id) then
				    tfid = "645-3"
			end
		end
	if psx(id,'天赋外功1') >= 0 then 
		lb[1][#lb[1]+1] = '天赋外功1'
	end	 
	if psx(id,'天赋外功2') >= 0 then 
		lb[1][#lb[1]+1] = '天赋外功2'
	end
	if psx(id,'天赋内功') >= 0 then 
		lb[1][#lb[1]+1] = '天赋内功'
	end	 
	if psx(id,'天赋轻功') >= 0 then 
		lb[1][#lb[1]+1] = '天赋轻功'
	end
	local me = {}
	local me1 = {}
	local me2 = {}
	local me3 = {}
	local me4 = {}
	local mid = tfid 
	local bz = {'拳','指','剑','刀','奇','罡','仁','医','毒','棍'}
	if JY.Base["标准"] > 0 and id == 0 then 
		mid = bz[JY.Base["标准"]]
	end
	
	local row = 0
	if TFJS[mid] ~= nil then
		for i = 1, #TFJS[mid] do
			me1[#me1+1] = TFJS[mid][i]
			if i == #TFJS[mid] then 
				me1[#me1+1] = "Ｎ"				
			end
		end
	end
	if FY[mid] ~= nil then
		for i = 1, #FY[mid] do
			me2[#me2+1] = FY[mid][i]
			if i == #FY[mid] then 
				me2[#me2+1] = "Ｎ"				
			end
		end
	end
	
	if TSZL[mid] ~= nil then
		for i = 1, #TSZL[mid] do
			me3[#me3+1] = TSZL[mid][i]
			if i == #TSZL[mid] then 
				me3[#me3+1] = "Ｎ"				
			end
		end
	end

	if BOSSZT[mid] ~= nil then
		for i = 1, #BOSSZT[mid] do
			me4[#me4+1] = BOSSZT[mid][i]
			if i == #BOSSZT[mid] then 
				me4[#me4+1] = "Ｎ"				
			end
		end
	end

	local size = CC.DefaultFont
	local tfjsbh = 0
	local tfjswz = {}
	local tfjsbh1 = 0
	local tfjswz1 = {}
	local bossztwz = {}
	local rwzlwz = {}
	local fyjywz = {}
	local pdl = true
	for k = 1, #me1 do
		--local tfstr = me[k]
		local tfstr1 = me1[k]
		local h1 = 0
		-- if #tfstr > math.floor(bx*345/size2)+5 then
			-- --	i = i + 1
				-- row = row + 1
		-- end		
		--if string.sub(tfstr,1,2) == "Ｎ" then
			--row = row + 1
		--else
		if string.sub(tfstr1,1,2) == 'Ｌ' and pdl then
			tjm(bx*420,by*155+i*h-0.9*h,tfstr1,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			
			--h1=--tfstr = tfstr .. "Ｎ"
		--	i = i + 1
			lb[1][#lb[1]+1] = tfstr1
			
			pdl = false
		end
		if string.sub(tfstr1,1,2) == 'Ｗ' then
		--	h1 = tjm(bx*60, by*110 + size*0.8 * (row-istart), tfstr, C_WHITE, size*0.8,32,size*0.8,istart-row,max_row+1-row+istart)
		--	tjm9(bx*30,by*80+k*h,TFJS[id][k],C_WHITE,size2,math.floor(bx*345/size2)-1,h)
			--tjm9(bx*30,by*80+i*h+20,tfstr,C_WHITE,size2,math.floor(bx*345/size2)-1,h)
			--row = row + 1
			--DrawString(bx*420,by*160+i*h,tfstr,C_WHITE,size1)--,math.floor(bx*345/size2)+2,h
			--tjm(bx*420,by*155+i*h,tfstr,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			--tfjsbh1 = tfjsbh1 + 1
			if tfjswz1[mid] == nil then
				tfjswz1[mid] = tfstr1
			else
				tfjswz1[mid] = tfjswz1[mid] .."；".. tfstr1
			end	
			--h1=--tfstr = tfstr .. "Ｎ"
		--	i = i + 1
			--lb[1][#lb[1]+1] = tfstr
		end
		-- row = row + 1
		-- i = i + 0.33
	end
	for k = 1, #me2 do
		local tfstr = me2[k]
		local h1 = 0
		if string.sub(tfstr,1,2) == 'Ｇ' then
			tjm(bx*420,by*175+i*h-0.9*h,tfstr,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			lb[1][#lb[1]+1] = tfstr
		end
		if string.sub(tfstr,1,2) == 'Ｗ' then
			--tfjsbh = tfjsbh + 1
			tfjswz[#tfjswz+1] = tfstr
			--bossztwz[#bossztwz+1] = tfstr
		end
		i = i + 0.33
		--row = row + 1
	end
	for k = 1, #me3 do
		local tfstr = me3[k]
		local h1 = 0
		if string.sub(tfstr,1,2) == 'Ｒ' then
			tjm(bx*420,by*175+i*h-0.9*h,tfstr,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			lb[1][#lb[1]+1] = tfstr
			--row = row + 1

		end
		if string.sub(tfstr,1,2) == 'Ｗ' then
			--tfjsbh = tfjsbh + 1
			tfjswz[#tfjswz+1] = tfstr
			--rwzlwz[#rwzlwz+1] = tfstr
		end
		i = i + 0.33
	end
	for k = 1, #me4 do
		local tfstr = me4[k]
		local h1 = 0
		if string.sub(tfstr,1,2) == 'Ｚ' then
			tjm(bx*420,by*175+i*h-0.9*h,tfstr,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			lb[1][#lb[1]+1] = tfstr
			
		end
		if string.sub(tfstr,1,2) == 'Ｗ' then
			--tfjsbh = tfjsbh + 1
			tfjswz[#tfjswz+1] = tfstr
			--fyjywz[#fyjywz+1] = tfstr
		end
		i = i + 0.33
		--row = row + 1
	end
	for k = 1, #me do
		local tfstr = me[k]
		--local tfstr1 = me1[k]
		local h1 = 0
		-- if #tfstr > math.floor(bx*345/size2)+5 then
			-- --	i = i + 1
				-- row = row + 1
		-- end		
		--if string.sub(tfstr,1,2) == "Ｎ" then
			--row = row + 1
		--else
		
		
		if string.sub(tfstr,1,2) == 'Ｌ' then
		--	h1 = tjm(bx*60, by*110 + size*0.8 * (row-istart), tfstr, C_WHITE, size*0.8,32,size*0.8,istart-row,max_row+1-row+istart)
		--	tjm9(bx*30,by*80+k*h,TFJS[id][k],C_WHITE,size2,math.floor(bx*345/size2)-1,h)
			--tjm9(bx*30,by*80+i*h+20,tfstr,C_WHITE,size2,math.floor(bx*345/size2)-1,h)
			--row = row + 1
			--DrawString(bx*420,by*160+i*h,tfstr,C_WHITE,size1)--,math.floor(bx*345/size2)+2,h
			tjm(bx*420,by*175+i*h-0.3*h,tfstr,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			
			--h1=--tfstr = tfstr .. "Ｎ"
		--	i = i + 1
			lb[1][#lb[1]+1] = tfstr
		end
		if string.sub(tfstr,1,2) == 'Ｗ' then
		--	h1 = tjm(bx*60, by*110 + size*0.8 * (row-istart), tfstr, C_WHITE, size*0.8,32,size*0.8,istart-row,max_row+1-row+istart)
		--	tjm9(bx*30,by*80+k*h,TFJS[id][k],C_WHITE,size2,math.floor(bx*345/size2)-1,h)
			--tjm9(bx*30,by*80+i*h+20,tfstr,C_WHITE,size2,math.floor(bx*345/size2)-1,h)
			--row = row + 1
			--DrawString(bx*420,by*160+i*h,tfstr,C_WHITE,size1)--,math.floor(bx*345/size2)+2,h
			--tjm(bx*420,by*155+i*h,tfstr,C_WHITE,size1,math.floor(bx*345/size1)+2,h)
			--tfjsbh = tfjsbh + 1
			tfjswz[#tfjswz+1] = tfstr
			--h1=--tfstr = tfstr .. "Ｎ"
		--	i = i + 1
			--lb[1][#lb[1]+1] = tfstr
		end
		row = row + 1
		i = i + 0.33
	end
   --if psx(id,'天赋外功1') > 0 or psx(id,'天赋外功2') > 0 or psx(id,'天赋内功') > 0 or psx(id,'天赋轻功') > 0  then 
	lb1[#lb1+1] = 1
	lb2[1] = #lb1
	lb2[2] = lb2[1]
   --end
   -- if TFJS[id] ~= nil then 
	  -- for i = 1,#TFJS[id]  do
		-- tjm9(bx*30,by*80+i*h,TFJS[id][i],C_WHITE,size2,math.floor(bx*345/size2)-1,h)
	-- --	DrawString(bx*30,by*80+i*h,TFJS[id][i],C_WHITE,size)
	  -- end
   
      
   -- end
   
	
   
   --装备增加的属性
		local str_gain, def_gain, agi_gain = 0, 0, 0
		local fb = 1

		local str_gain, def_gain, agi_gain = 0, 0, 0
		if p["武器"] > -1 then
			if JY.Thing[p["武器"]]["加攻击力"] > 0 then
				str_gain = str_gain + JY.Thing[p["武器"]]["加攻击力"]*10 + JY.Thing[p["武器"]]["加攻击力"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			elseif JY.Thing[p["武器"]]["加攻击力"] < 0 then
				str_gain = str_gain + JY.Thing[p["武器"]]["加攻击力"]*10 - JY.Thing[p["武器"]]["加攻击力"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["武器"]]["加防御力"] > 0 then
				def_gain = def_gain + JY.Thing[p["武器"]]["加防御力"]*10 + JY.Thing[p["武器"]]["加防御力"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			elseif JY.Thing[p["武器"]]["加防御力"] < 0 then
				def_gain = def_gain + JY.Thing[p["武器"]]["加防御力"]*10 - JY.Thing[p["武器"]]["加防御力"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["武器"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["武器"]]["加轻功"]*10 + JY.Thing[p["武器"]]["加轻功"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			elseif JY.Thing[p["武器"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["武器"]]["加轻功"]*10 - JY.Thing[p["武器"]]["加轻功"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			end
		end
		if p["防具"] > -1 then
			if JY.Thing[p["防具"]]["加攻击力"] > 0 then
				str_gain = str_gain + JY.Thing[p["防具"]]["加攻击力"]*10 + JY.Thing[p["防具"]]["加攻击力"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			elseif JY.Thing[p["防具"]]["加攻击力"] < 0 then
				str_gain = str_gain + JY.Thing[p["防具"]]["加攻击力"]*10 - JY.Thing[p["防具"]]["加攻击力"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["防具"]]["加防御力"] > 0 then
				def_gain = def_gain + JY.Thing[p["防具"]]["加防御力"]*10 + JY.Thing[p["防具"]]["加防御力"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			elseif JY.Thing[p["防具"]]["加防御力"] < 0 then
				def_gain = def_gain + JY.Thing[p["防具"]]["加防御力"]*10 - JY.Thing[p["防具"]]["加防御力"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["防具"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["防具"]]["加轻功"]*10 + JY.Thing[p["防具"]]["加轻功"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			elseif JY.Thing[p["防具"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["防具"]]["加轻功"]*10 - JY.Thing[p["防具"]]["加轻功"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			end
		end
		if p["坐骑"] > -1 then
			if JY.Thing[p["坐骑"]]["加攻击力"] > 0 then
				str_gain = str_gain + JY.Thing[p["坐骑"]]["加攻击力"]*10 + JY.Thing[p["坐骑"]]["加攻击力"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			elseif JY.Thing[p["坐骑"]]["加攻击力"] < 0 then
				str_gain = str_gain + JY.Thing[p["坐骑"]]["加攻击力"]*10 - JY.Thing[p["坐骑"]]["加攻击力"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["坐骑"]]["加防御力"] > 0 then
				def_gain = def_gain + JY.Thing[p["坐骑"]]["加防御力"]*10 + JY.Thing[p["坐骑"]]["加防御力"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			elseif JY.Thing[p["坐骑"]]["加防御力"] < 0 then
				def_gain = def_gain + JY.Thing[p["坐骑"]]["加防御力"]*10 - JY.Thing[p["坐骑"]]["加防御力"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["坐骑"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["坐骑"]]["加轻功"]*10 + JY.Thing[p["坐骑"]]["加轻功"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			elseif JY.Thing[p["坐骑"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["坐骑"]]["加轻功"]*10 - JY.Thing[p["坐骑"]]["加轻功"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			end
		end
		if p["饰品"] > -1 then
			if JY.Thing[p["饰品"]]["加攻击力"] > 0 then
				str_gain = str_gain + JY.Thing[p["饰品"]]["加攻击力"]*10 + JY.Thing[p["饰品"]]["加攻击力"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			elseif JY.Thing[p["饰品"]]["加攻击力"] < 0 then
				str_gain = str_gain + JY.Thing[p["饰品"]]["加攻击力"]*10 - JY.Thing[p["饰品"]]["加攻击力"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["饰品"]]["加防御力"] > 0 then
				def_gain = def_gain + JY.Thing[p["饰品"]]["加防御力"]*10 + JY.Thing[p["饰品"]]["加防御力"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			elseif JY.Thing[p["饰品"]]["加防御力"] < 0 then
				def_gain = def_gain + JY.Thing[p["饰品"]]["加防御力"]*10 - JY.Thing[p["饰品"]]["加防御力"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			end
			if JY.Thing[p["饰品"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["饰品"]]["加轻功"]*10 + JY.Thing[p["饰品"]]["加轻功"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			elseif JY.Thing[p["饰品"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["饰品"]]["加轻功"]*10 - JY.Thing[p["饰品"]]["加轻功"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			end
		end
		
	local tmp1, tmp2, tmp3 = 0, 0, 0 --攻防轻
	local tmp4, tmp5, tmp6, tmp7 = 0, 0, 0, 0 --医毒解暗
	local tmpa, tmpb, tmpc, tmpd, tmpe = 0, 0, 0, 0, 0 --拳剑刀特
	

	tmp1 = tmp1 + MPAttrib(id, 1)
	tmp2 = tmp2 + MPAttrib(id, 2)
	tmp3 = tmp3 + MPAttrib(id, 3)
	tmp4 = tmp4 + MPAttrib(id, 4)
	tmp5 = tmp5 + MPAttrib(id, 5)
	tmp6 = tmp6 + MPAttrib(id, 6)
	tmp7 = tmp7 + MPAttrib(id, 7)
	
		--易筋经加成
		local level = 0
		local gj = 0
		local qg = 0
		local fy = 0
		local str1_gain, def1_gain, agi1_gain = 0, 0, 0
        --战场各种加成 
        if JY.Status == GAME_WMAP then

		if PersonKF(id,108) then
		 gj = math.modf (JY.Person[id]["攻击力"]*0.3)
		   str_gain = str_gain +gj
		 end
		if PersonKF(id,108) then 
		 fy = math.modf(JY.Person[id]["防御力"]*0.3)
		   def_gain = def_gain +fy
		 end
	    --霍青桐，我方人数人越多，伤害越高    
		if match_ID(id, 74) then
		 local hqtgj= 0
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
				 def_gain =  def_gain+10
			    end		
	        end	
	    end		 		 
			--队友攻击力加成
			for i,v in pairs(CC.AddAtk) do
				if match_ID(id, v[1]) then
					for wid = 0, WAR.PersonNum - 1 do
						if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
							str1_gain = str1_gain + v[3]
						end
					end
				end
			end
			--队友防御力加成
			for i,v in pairs(CC.AddDef) do
				if match_ID(id, v[1]) then
					for wid = 0, WAR.PersonNum - 1 do
						if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
							def1_gain = def1_gain + v[3]
						end
					end
				end
			end
			--队友轻功加成
			for i,v in pairs(CC.AddSpd) do
				if match_ID(id, v[1]) then
					for wid = 0, WAR.PersonNum - 1 do
						if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
							agi1_gain = agi1_gain + v[3] 
						end
					end
				end
			end
			
		end
   
   
   
   --装备显示
	local pyl = -40
	lib.LoadPNG(91,170*2,bx*450+pyl,by*470,1)
	lib.LoadPNG(91,172*2,bx*450+pyl+158,by*470,1)
	lib.LoadPNG(91,171*2,bx*450+pyl,by*470+158,1)
	lib.LoadPNG(91,173*2,bx*450+pyl+158,by*470+158,1)
	if p["武器"] > -1 then
		lib.PicLoadCache(2,p["武器"] * 2,bx*450+pyl,by*470,1,0,0,-1,-1,0,0,72)
		lib.PicLoadCache(92,58*2,bx*450+pyl,by*470,1)
		DrawString(bx*450+pyl,by*470, "LV"..JY.Thing[p["武器"]]["装备等级"], M_DeepSkyBlue, size*0.5)
		DrawString(bx*450+pyl,by*470+75, JY.Thing[p["武器"]]["名称"],C_RED , size*0.5)

	end
	if p["防具"] > -1 then
		lib.PicLoadCache(2,p["防具"] * 2,bx*450+pyl+159,by*470,1,0,0,-1,-1,0,0,72)
		lib.PicLoadCache(92,58*2,bx*450+pyl+159,by*470,1)
		DrawString( bx*450+pyl+159,by*470, "LV"..JY.Thing[p["防具"]]["装备等级"], M_DeepSkyBlue, size*0.5)
		DrawString( bx*450+pyl+159+75,by*470, JY.Thing[p["防具"]]["名称"], C_ORANGE, size*0.5)
	end		
	if p["坐骑"] > -1 then
		lib.PicLoadCache(2,p["坐骑"] * 2,bx*450+pyl,by*470+150,1,0,0,-1,-1,0,0,72)
		lib.PicLoadCache(92,58*2,bx*450+pyl,by*470+150,1)
		DrawString( bx*450+pyl,by*470+154, "LV"..JY.Thing[p["坐骑"]]["装备等级"], M_DeepSkyBlue, size*0.5)
		DrawString( bx*450+pyl,by*470+154+75, JY.Thing[p["坐骑"]]["名称"], M_Yellow, size*0.5)
	end
	if p["饰品"] > -1 then
		lib.PicLoadCache(2,p["饰品"] * 2,bx*450+pyl+159,by*470+150,1,0,0,-1,-1,0,0,72)
		lib.PicLoadCache(92,58*2,bx*450+pyl+159,by*470+150,1)
		DrawString( bx*450+pyl+159,by*470+154, "LV"..JY.Thing[p["饰品"]]["装备等级"], M_DeepSkyBlue, size*0.5)
		DrawString( bx*450+pyl+159+75,by*470+154+75, JY.Thing[p["饰品"]]["名称"], M_Yellow, size*0.5)
	end
   
     
   i = 0
   --local wgbh = {'Ⅰ','Ⅱ','Ⅲ','Ⅳ','Ⅴ','Ⅵ','Ⅶ','Ⅷ','Ⅸ','Ⅹ','Ⅺ','Ⅻ','ⅩⅢ','ⅩⅣ','ⅩⅤ'}
   --人物武学
   --lib.LoadPNG(91,124*2,bx*660+bx*70,by*60+by*25/2,2,180,nil,bx*180)
   --lib.LoadPNG(91,124*2,bx*660+bx*70,by*60+by*25/2,1)
   for k = 1,CC.Kungfunum  do 
       if psx(id,'武功'..k) > 0 then
		----lib.LoadPNG(91, 18 * 2 ,dx*500, dy*90 + h * (i), 1)
		  local wugong = psx(id,'武功'..k)
	      local lv = limitX(math.modf(psx(id,'武功等级'..k)/100),1)
		  local lx = JY.Wugong[psx(id,'武功'..k)]['武功类型']
		  local wugongwl = get_skill_power(id, wugong, lv)
		  -- lib.LoadPNG(91,(lv+74)*2,bx*660+size1*6,by*60+i*h+size1/2,2,240,nil,bx*25)
		  -- lib.LoadPNG(91,(lx+149)*2,bx*660+size1*6+bx*50,by*60+i*h+size1/2,2,240,nil,bx*25)
		if psx(id,'武功等级'..k) > 900 then
			lib.LoadPNG(91,167*2,bx*660+size*3.1,by*60+i*h,1)
		else	
		 lib.LoadPNG(91,(lv+149)*2,bx*663+size*3.1,by*60+i*h,1)
		end 
		 lib.LoadPNG(91,(lx+74)*2,bx*660+size*3.1+bx*40,by*60+i*h,1)
          local cclor = C_WHITE
 					if Given_WG(id, wugong) or Given_NG(id, wugong) then
						cclor = PinkRed
					--五岳剑法组合颜色
					elseif wugong >= 30 and wugong <= 34 and WuyueJF(id) then
						cclor = LightPurple
					--琴棋书画组合颜色
					elseif (wugong == 73 or wugong == 72 or wugong == 84 or wugong == 142) and QinqiSH(id) then
						cclor = LightPurple
					--桃花绝技组合颜色
					elseif (wugong == 12 or wugong == 18 or wugong == 38) and TaohuaJJ(id) then
                        cclor = LightPurple
					end  
          DrawString(bx*660,by*60+i*h,JY.Wugong[psx(id,'武功'..k)]['名称'],cclor,size*0.5)
		  i = i + 1
		  lb[2][#lb[2]+1] ={ psx(id,'武功'..k),k}
	   end
   end
   -- if psx(id,'左右互搏') == 1 then 
      -- local lv = limitX(math.modf(psx(id,'左右等级')/25),1)
      -- lib.LoadPNG(91,(lv+149)*2,bx*660+size1*6,by*60+i*h+size1/2,2,240,nil,bx*25)
	  -- lib.LoadPNG(91,129*2,bx*660+size1*6+bx*50,by*60+i*h+size1/2,2,240,nil,bx*25)
	  -- DrawString(bx*660,by*60+i*h,'左右互搏',C_WHITE,size1)
	  -- i = i + 1
	  -- lb[2][#lb[2]+1] = '左右互搏'
	  
   -- end 
   -- if psx(id,'斗转') == 1 then 
      -- local lv = limitX(math.modf(psx(id,'斗转等级')/25),1)
      -- lib.LoadPNG(91,(lv+149)*2,bx*660+size1*6,by*60+i*h+size1/2,2,240,nil,bx*25)
	  -- lib.LoadPNG(91,129*2,bx*660+size1*6+bx*50,by*60+i*h+size1/2,2,240,nil,bx*25)
	  -- DrawString(bx*660,by*60+i*h,'斗转星移',C_WHITE,size1)
	  -- i = i + 1
	  -- lb[2][#lb[2]+1] = '斗转'
   -- end 
   
   if #lb[2] > 0 then 
      lb1[#lb1+1] = 2
	  --lb2[2] = lb2[1] + 1
	  lb2[2] = #lb1
   end
   
   i = 0
   --人物基础技能
   for k = 1,CC.Skillnum do 
       local skill = psx(id,'技能'..k)
       if skill > 0 then 
          local cclor = C_WHITE					
          DrawString(bx*900,by*60+i*h,CC.JL[skill].name,cclor,size*0.6)
		  i = i + 1
		  lb[3][#lb[3]+1] ={ psx(id,'技能'..k),k}
	   end
   end

   if lb[3]~=nil and #lb[3] > 0 then
      lb1[#lb1+1] = 3
	  --lb2[3] = lb2[2] + 1
	  lb2[3] = #lb1
   end
   
   lb1[#lb1+1] = 4
   --lb2[4] = lb2[3] + 1
   lb2[4] = #lb1
   lb1[#lb1+1] = 5
   lb2[5] = #lb1
   --lb2[5] = lb2[4] + 1
   --人物运功
   i = 0
   local yg = {{'优先使用',1,'外功'},{'主运技能',2,'技能'},{'主运内功',3,'内功'},{'主运轻功',4,'轻功'},}
   -- if psx(id,'左右互搏') == 0 then 
	  -- table.remove(yg,2)
   -- end
   for k = 1,#yg do 
	   local cl =C_GOLD
	   local str = ''
       --if yg[k][2] == 1 then
	   ----lib.LoadPNG(91, 18 * 2 ,dx*500, dy*90 + h * (i), 1)
	    --  lib.LoadPNG(91,160*2,bx*1242,by*60+i*by*48+by*18,1)
		  lib.LoadPNG(91,160*2,bx*1125+size1,by*60+i*bx*48+bx*18-size1,1)
		  if psx(id,yg[k][1]) > 0 then
             if k~= 2 then		  
		     str = JY.Wugong[psx(id,yg[k][1])]['名称']
			 else
			 str = CC.JL[psx(id,yg[k][1])].name
			 end
		  else 
		     str = '无'..yg[k][3]
			 cl =  C_WHITE
		  end
	      if lb1[cx1] == 4 and page == 2 then 
	         if cx == k then 
		        cl = C_RED
		     end
	      end
		  --DrawString(bx*935-string.len('未开启第二运功')/4*size,by*136-size/2,'未开启第二运功',C_WHITE,size)
		  DrawString(bx*1233+size1-string.len(str)/4*size1,by*60+i*bx*48+bx*18-size1/2-bx*3,str,cl,size1)
		  i = i + 1
		  lb[4][#lb[4]+1] = yg[k][1]
	   --end
   end
   -- lb[4][#lb[4]+1] = '加力'
   -- lib.LoadPNG(91,160*2,bx*1242,by*60+i*bx*48+bx*18,2,240,nil,bx*200)
   -- -- if lb1[cx1] == 4 and cx == #lb[4] and page == 2 then
      -- -- DrawString(bx*1140+size1,by*60+i*bx*48+bx*18-size1/2,'内力运气：'..psx(id,'加力'),C_RED,size1)
   -- -- else 
      -- -- DrawString(bx*1140+size1,by*60+i*bx*48+bx*18-size1/2,'内力运气：'..psx(id,'加力'),C_WHITE,size1)
   -- -- end
   
   -- lb[5] = {'武器','防具','头饰','饰品','鞋子'}
   -- --人物装备
   -- i = 0
   -- for k = 1,#lb[5] do 
       -- lib.LoadPNG(91,160*2,bx*522,by*470+i*by*48+by*18,2,240,nil,bx*200)
	   -- local cl = C_WHITE
	   -- local str = ''
	   -- if psx(id,lb[5][k]) > 0 then 
	      -- str = JY.Thing[psx(id,lb[5][k])]['名称']
	   -- else 
	      -- str = '无'..lb[5][k]
		  -- cl = C_GOLD
	   -- end
	   -- if lb1[cx1] == 5 then 
	      -- if cx == k then 
		     -- cl = C_RED
		  -- end
	   -- end
	   -- DrawString(bx*420+size1,by*470+i*bx*48+bx*18-size1/2,str,cl,size1)
	   -- i = i + 1
   -- end
	local bonus_q,bonus_z,bonus_j,bonus_d,bonus_t = 0,0,0,0,0

   
   --武常 实战 集气
	local jqz = 0
	local jqz0 = 8
	local jqz1 = 0
	local jqz3 = 0
	local x = JY.Person[id]["轻功"]
	local jqz2 = 0
    local y = JY.Person[id]["内力"]	
	--local x3 = dx*427
	--local y3 = y1
	-- DrawString(x3 , y3,p["武学常识"], C_CYGOLD, size*0.7)
     -- if p["实战"] >= 500 then
			-- DrawString(x3, y3+dh, string.format("%s", "极"), C_RED, size*0.7)
		-- else
			-- DrawString(x3, y3+dh, string.format("%s", p["实战"]), C_CYGOLD, size*0.7)
		-- end	
	--集气条
	

   
   
   local cl = M_DeepSkyBlue
   local strcl = '(阴内)'
   if JY.Person[id]["内力性质"] == 0 then
		cl = M_DeepSkyBlue
		strcl = '(阴内)'
   elseif JY.Person[id]["内力性质"] == 1 then
		cl = C_ORANGE
		strcl = '(阳内)'
   elseif JY.Person[id]["内力性质"] == 2 then
		cl = C_CYGOLD
		strcl = '(调和)'
   end
   --人物属性1
   i = 0 
   DrawString(bx*660,by*475,'生命　　　'..string.format('%5s',psx(id,'生命')),M_PaleGreen,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'内力　　　'..string.format('%5s',psx(id,'内力'))..strcl,cl,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'内伤　　　'..string.format('%5s',psx(id,'受伤程度')),C_WHITE,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'中毒　　　'..string.format('%5s',psx(id,'中毒程度')),C_WHITE,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'带毒　　　'..string.format('%5s',psx(id,'攻击带毒')),C_WHITE,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'抗毒　　　'..string.format('%5s',psx(id,'抗毒能力')),C_WHITE,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'武常　　　'..string.format('%5s',p["武学常识"]),C_WHITE,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'实战　　　'..string.format('%5s',p["实战"]),C_WHITE,size1)
   i = i + 1
   DrawString(bx*660,by*475+i*h,'资质　　　'..string.format('%5s',p["资质"]),C_WHITE,size1)
   i = i + 1
   -- DrawString(bx*660,by*475+i*h,'经验　　'..string.format('%9s',psx(id,'实战经验')),C_WHITE,size1)
   -- i = i + 1
   -- DrawString(bx*660,by*475+i*h,'潜能　　'..string.format('%9s',psx(id,'武学潜能')),C_WHITE,size1)
   -- i = i + 1
   --人物属性1
   
   
   i = 0 
   DrawString(bx*900,by*475,'最大生命　'..string.format('%5s',psx(id,'生命最大值')),M_PaleGreen,size1)
   i = i + 1
   DrawString(bx*900,by*475+i*h,'最大内力　'..string.format('%5s',psx(id,'内力最大值'))..strcl,cl,size1)
   i = i + 1
  DrawString(bx*900,by*475+i*h,'拳掌　　　'..string.format('%5s',p["拳掌功夫"]+bonus_q),M_YellowGreen,size1)
	DrawAttrib("拳掌功夫", bx*900+150,by*475+i*h,M_YellowGreen,size1)
  i = i + 1
  DrawString(bx*900,by*475+i*h,'指法　　　'..string.format('%5s',p["指法技巧"]+bonus_z),M_YellowGreen,size1)
   DrawAttrib("指法技巧", bx*900+150,by*475+i*h,M_YellowGreen,size1)
   i = i + 1
  DrawString(bx*900,by*475+i*h,'御剑　　　'..string.format('%5s',p["御剑能力"]+bonus_j),M_YellowGreen,size1)
   DrawAttrib("御剑能力", bx*900+150,by*475+i*h,M_YellowGreen,size1)
   i = i + 1
   DrawString(bx*900,by*475+i*h,'耍刀　　　'..string.format('%5s',p["耍刀技巧"]+bonus_d),M_YellowGreen,size1)
   DrawAttrib("耍刀技巧", bx*900+150,by*475+i*h,M_YellowGreen,size1)
   i = i + 1
   DrawString(bx*900,by*475+i*h,'奇门　　　'..string.format('%5s',p["特殊兵器"]+bonus_t),M_YellowGreen,size1)
   DrawAttrib("特殊兵器", bx*900+150,by*475+i*h,M_YellowGreen,size1)
   i = i + 1
 -- DrawString(bx*900,by*475+i*h,'暗器　　　'..string.format('%5s',p["暗器技巧"]),C_WHITE,size1)
  DrawString(bx*900,by*475+i*h,'枪棒　　　'..string.format('%5s',p["枪棒技巧"]),M_YellowGreen,size1)
  
	i = i + 1
	DrawString(bx*900,by*475+i*h,'暗器　　　'..string.format('%5s',p["暗器技巧"]),M_Orange,size1)
	i = i + 1
	DrawString(bx*900,by*475+i*h,'体质　　　'..string.format('%5s',p["生命增长"]),M_Red,size1)
	i = i + 1
   
   -- DrawString(bx*900,by*475+i*h,'武常　　　'..string.format('%5s',p["武学常识"]),C_WHITE,size1)
   -- i = i + 1
	local zyhb = nil
	if p["左右互搏"] == 1 then
		zyhb  = "◎"
		else
		zyhb  = "※"
		end
	
      local zyzd = nil	
	if PersonKF(id,84) then
		zyzd  = "◎"
		else
		zyzd  = "※"
		end		
	
     local mrdz = nil	
	if PersonKF(id,43)  then
		mrdz  = "◎"
		else
		mrdz  = "※"
		end		
	
   
   --人物属性2
   i = 0
    if str_gain>-1 then
	DrawString(bx*1140,by*475,'攻击　　　'..string.format('%3s %1s %2s',p["攻击力"]+str1_gain,"↑",str_gain),M_Yellow,size1)
	else
	str_gain = -(str_gain)
	DrawString(bx*1140,by*475,'攻击　　　'..string.format('%3s %1s %2s',p["攻击力"]+str1_gain,"↓",str_gain),M_Yellow,size1)
	end
	

   i = i + 1
     if def_gain>-1 then
	 DrawString(bx*1140,by*475+i*h,'防御　　　'..string.format('%3s %1s %2s',p["防御力"]+def1_gain,"↑",def_gain),M_Yellow,size1)
	else
	def_gain = -(def_gain)
	 DrawString(bx*1140,by*475+i*h,'防御　　　'..string.format('%3s %1s %2s',p["防御力"]+def1_gain,"↓",def_gain),M_Yellow,size1)
	end  
 
  i = i + 1
  --DrawString(bx*1140,by*475+i*h,'轻功　　　'..string.format('%5s %2s %2s',p["轻功"],"↑",agi1_gain),M_Yellow,size1)
	if agi_gain > -1 then
		DrawString(bx*1140,by*475+i*h,'轻功　　　'..string.format('%3s %1s %2s',p["轻功"]+agi1_gain,"↑",agi_gain),M_Yellow,size1)
	--	DrawString(x1+w1*2,y1+dh*2, agi_gain, M_Yellow, size*0.7)			
	else
		agi_gain = -(agi_gain)
		DrawString(bx*1140,by*475+i*h,'轻功　　　'..string.format('%3s %1s %2s',p["轻功"]+agi1_gain,"↓",agi_gain),M_Yellow,size1)
	--	DrawString(x1+w1*2,y1+dh*2, agi_gain, M_Yellow, size*0.7)			
	end
i = i + 1
  DrawString(bx*1140,by*475+i*h,'医疗　　　'..string.format('%3s',psx(id,'医疗能力')+tmp4),M_PaleGreen,size1)
   i = i + 1
  DrawString(bx*1140,by*475+i*h,'用毒　　　'..string.format('%3s',psx(id,'用毒能力')+tmp5),M_PaleGreen,size1)
   i = i + 1
  DrawString(bx*1140,by*475+i*h,'连击　　　'..string.format('%3s',Person_LJ(id)..'％'),M_DeepSkyBlue,size1)
   i = i + 1
  DrawString(bx*1140,by*475+i*h,'暴击　　　'..string.format('%3s',Person_BJ(id)..'％'),C_RED,size1)
   i = i + 1
   DrawString(bx*1140,by*475+i*h,'左右互搏　　　　'..string.format('%3s',zyhb),M_LightBlue,size1)
   i = i + 1
   DrawString(bx*1140,by*475+i*h,'倚天屠龙　　　　'..string.format('%3s',zyzd),M_LightBlue,size1)
   i = i + 1
   DrawString(bx*1140,by*475+i*h,'斗转星移　　　　'..string.format('%3s',mrdz),M_LightBlue,size1)
   i = i + 1
   
   
   
   DrawString(bx*1140,by*475-160, "修炼", C_CYGOLD, size*0.7)
	local thingid = p["修炼物品"]
		if thingid > 0 then
			--lib.PicLoadCache(2, p["修炼物品"] * 2, x1 + size*4, y1*19+96-100, 1)
            DrawString(bx*1140,by*475-140, JY.Thing[thingid]["名称"], M_DeepSkyBlue, size*0.7)			
			i = i + 1
			local n = TrainNeedExp(id)
			if n < math.huge then
				DrawString(bx*1140,by*475-120, string.format("%5d/%5d", p["修炼点数"], n), C_CYGOLD, size*0.7)
			else
				DrawString(bx*1140,by*475-120, string.format("%5d/===", p["修炼点数"]), C_CYGOLD, size*0.7)
			end
		else


	  --经验值
	  ---i = i + 1
		--DrawString(x1-130, y1 + 12*h * (i)-40, "升级", C_CYGOLD, size*0.8)
		local kk = nil
		if p["等级"] >= 30 then
			kk = "   ="
		else
			p["等级"] = limitX(p["等级"],1,30)
			kk = 2 * (p["经验"] - CC.Exp[p["等级"] - 1])
			if kk < 0 then
				kk = "  0"
			elseif kk < 10 then
				kk = "   " .. kk
			elseif kk < 100 then
				kk = "  " .. kk
			elseif kk < 1000 then
				kk = " " .. kk
			end
		end		
		
		
		
		--等级
	--	DrawString(dx*189, dy*390, kk, C_CYGOLD, size*0.8)
	--	local tmp = nil
	--	if CC.Level <= p["等级"] then
	--		tmp = "="
	--	else
	--		tmp = 2 * (CC.Exp[p["等级"]] - CC.Exp[p["等级"] - 1])
	--	end
	--	DrawString(dx*209, dy*390, "/" .. tmp, C_CYGOLD, size*0.8)
	end
   
   --生命内力大小
	local ww = bx*78
	--local h = bx*7
	--生命坐标
	local x1,y1 = bx*200,bx*840
	--内力坐标
	local x2,y2 = bx*200,bx*858
	--生命
	local sm = JY.Person[id]['生命']
	--内力
	local nl = JY.Person[id]['内力']
	--最大生命
	local smmax = JY.Person[id]['生命最大值']
	--最大内力
	local nlmax = JY.Person[id]['内力最大值']
	lib.LoadPNG(91, 35*2, x1, y1, 2)
	lib.LoadPNG(91, 35*2, x2, y2, 2)
	--生命条
	lib.SetClip(x1-ww,y1-bx*7,(x1-ww)+(ww*2)*(sm/smmax),y1+bx*7)
	lib.LoadPNG(91, 31*2, x1, y1, 2)
	
	lib.SetClip(0,0,0,0)
	--内力条
	lib.SetClip(x2-ww,y2-bx*7,(x2-ww)+(ww*2)*(nl/nlmax),y2+bx*7)
	lib.LoadPNG(91, 32*2, x2, y2, 2)
	
	lib.SetClip(0,0,0,0)
	-- --内力属性
	-- local sx = {'阴','阳','调和','天罡'}
	-- --内力属性
	-- local nlsx = sx[JY.Person[0]['内力性质']+1]
	local cl = M_DeepSkyBlue
   local strcl = '阴内'
   if JY.Person[id]["内力性质"] == 0 then
		cl = M_DeepSkyBlue
		strcl = '阴内'
   elseif JY.Person[id]["内力性质"] == 1 then
		cl = C_ORANGE
		strcl = '阳内'
   elseif JY.Person[id]["内力性质"] == 2 then
		cl = C_CYGOLD
		strcl = '调和'
   elseif JY.Person[id]["内力性质"] == 3 then
		cl = C_RED
		strcl = '天罡'
   end
	
	--生命数字
	local smwz = sm..'/'..smmax
	--内力数字
	local nlwz = nl..'/'..nlmax--..'（'..strcl..'）'
	
	--生命
	DrawString(x1-string.len(smwz)/4*size2,y1-size2/2,smwz,C_WHITE,size2)
	--内力
	DrawString(x2-string.len(nlwz)/4*size2,y2-size2/2,nlwz,cl,size2)
   
   
   i = 0
   local hh = 60
   local wh = lb1[cx1]
   if lb1[cx1] ~=nil and lb1[cx1] > 4 then 
      hh = 475
	  wh = 1
   end
   if page == 2 then
	if lb1[cx1] < 4 then
		--lib.LoadPNG(91,161*2,0,0,1,nil,nil,bx*420)
	    lib.LoadPNG(91,162*2,bx*420+bx*240*(wh-1)+bx*70-bx*70,by*hh+by*25/2+cx*h-h-by*15,1)
		if lb1[cx1] == 2 then
			local wz = 100
			local jg = 0
			local lv = math.modf(JY.Person[id]["武功等级" .. lb[2][cx][2]]/100)+1;
			local kungfuatk = get_skill_power(id, JY.Person[id]["武功" .. lb[2][cx][2]], lv)
			lib.LoadPNG(91,161*2,0,0,1)
			--lib.LoadPNG(91,161*2,0,0,1,nil,nil,bx*420)
			--say("测试位置"..lb[lb1[cx1]][cx][1],0,1)
			local name = JY.Wugong[JY.Person[id]["武功" .. lb[2][cx][2]]]['名称']
	        DrawString(bx*50,by*12,name,M_Yellow,size)
			DrawString(bx*300,by*12,'编号'..lb[2][cx][2],M_YellowGreen,size2)
			--武功攻击范围显示
			if JY.Wugong[JY.Person[id]["武功" .. lb[2][cx][2]]]['武功类型'] == 6 then
				local wz = 100
				local jg = 0
				local lv = math.modf(JY.Person[id]["武功等级" .. lb[2][cx][2]]/100)+1;
				local kungfuatk = get_skill_power(id, JY.Person[id]["武功" .. lb[2][cx][2]], lv)
				--lib.LoadPNG(91,161*2,0,0,1)
				--lib.LoadPNG(91,161*2,0,0,1,nil,nil,bx*420)
				--say("测试位置"..lb[lb1[cx1]][cx][1],0,1)
				
				
				--武功攻击范围显示
				DrawString(bx*50,by*80,'攻击范围',C_BLACK,size)
				
				tjm30(id,lb[lb1[cx1]][cx][1],bx*50,by*90+size)
				DrawString(bx*50,by*270+wz*by,'武功威力',C_BLACK,size)
					--  DrawString(bx*50,by*270+wz*by+size,string.format('%4s',wgwl(id,wg)),C_BLACK,size2)
					--  DrawString(bx*50,by*270+wz*by+size,string.format('%6s','/'),C_BLACK,size2)
				DrawString(bx*50,by*270+wz*by+size,kungfuatk..' / '..get_skill_power(id, JY.Person[id]["武功" .. lb[2][cx][2]], 11).."(最大威力)",C_ORANGE,size)
			
				-- --武功内力性质
				--DrawString(bx*50,by*270+wz*by+(by*40+size),'武功招式',C_RED,size)
				--local wgid = JY.Person[id]["武功" .. lb[3][cx][2]]
				--[[if CC.KFMove[wgid] ~= nil then
					for i=1 ,#CC.KFMove[wgid] do 
						DrawString(bx*50,by*360+wz*by+i*30,CC.KFMove[wgid][i][1].."   气攻: "..CC.KFMove[wgid][i][2],C_GOLD,size*0.6)
					end
				--	DrawString(bx*50,by*270+wz*by+(by*40+size),CC.KFMove[wgid][1][1],C_BLACK,size)
				end	]]										
			elseif JY.Wugong[JY.Person[id]["武功" .. lb[2][cx][2]]]['武功类型'] < 6 then
		       DrawString(bx*50,by*80,'攻击范围',C_BLACK,size)
			
			--DrawString(bx*200,by*80,'编号:'..lb[2][cx][2],M_YellowGreen,size)
			
		       tjm30(id,lb[lb1[cx1]][cx][1],bx*50,by*90+size)
			
			  DrawString(bx*50,by*270+wz*by,'武功威力',C_BLACK,size)
		        --  DrawString(bx*50,by*270+wz*by+size,string.format('%4s',wgwl(id,wg)),C_BLACK,size2)
		        --  DrawString(bx*50,by*270+wz*by+size,string.format('%6s','/'),C_BLACK,size2)
		      DrawString(bx*50,by*270+wz*by+size,kungfuatk..' / '..get_skill_power(id, JY.Person[id]["武功" .. lb[2][cx][2]], 11).."(最大威力)",C_ORANGE,size)
			
			
			   DrawString(bx*50,by*270+wz*by+(by*40+size),'武功招式',C_RED,size)
		       local wgid = JY.Person[id]["武功" .. lb[2][cx][2]]
			   if CC.KFMove[wgid] ~= nil then
				   for i=1 ,#CC.KFMove[wgid] do 
					  DrawString(bx*50,by*360+wz*by+i*30,CC.KFMove[wgid][i][1].."   气攻: "..CC.KFMove[wgid][i][2],C_GOLD,size*0.6)
				    end
			--	DrawString(bx*50,by*270+wz*by+(by*40+size),CC.KFMove[wgid][1][1],C_BLACK,size)
			   end			
			end

			
			--JY.Person[id]["武功等级" .. i]
			--JY.Person[pid]["武功" .. lb[2][cx][2]]
			-- lb[2][#lb[2]+1] ={ psx(id,'武功'..k),k}
			--lb[2][cx][1]
			--显示武功详细
		elseif lb1[cx1] == 3 then
		local wz = 100
			lib.LoadPNG(91,161*2,0,0,1)
			local name = CC.JL[JY.Person[id]["技能" .. lb[3][cx][2]]].name
			DrawString(bx*50,by*12,name,M_Yellow,size)
			local tfstr = CC.JL[JY.Person[id]["技能" .. lb[3][cx][2]]].js
			tjm(bx*35,by*60,tfstr,M_Yellow,size*0.8,10,h+3)
			--DrawString(bx*200,by*80,'编号:'..lb[3][cx][2],M_YellowGreen,size)

		elseif lb1[cx1] == 1 and cx > 4 then
			lib.LoadPNG(91,161*2,0,0,1)
			local name = lb[1][cx]
			tjm(bx*50,by*10,name,M_Yellow,size)
			if cx == 5 then --tfjswz = [#tfjswz+1] = tfstr
				--for j = 1, #tfjswz1 do
					local tfstr = tfjswz1[mid]
					if mid == 0 and JY.Base['标准'] > 0 then
						tjm(bx*35,by*60,tfstr,M_Yellow,size*0.8,10,h+3)
					else
						tfstr = tfjswz1[mid]
						tjm(bx*35,by*60,tfstr,C_BLACK,size*0.8,10,h+3)
					--	tjm(bx*50,by*80,tfstr,C_BLACK,size*0.7,14,h+10)
					end	
				--end
			--elseif cx == 6 and (match_ID(id,26) or match_ID(id,592) or match_ID(id,577)) then
				
			else
				--for j = 1, #tfjswz do
					local tfstr = tfjswz[cx-5]
					if cx == 6 and (match_ID(id,26) or match_ID(id,592) or match_ID(id,577)) then
						tjm(bx*35,by*60,tfstr,M_Yellow,size*0.8,10,h+3)
					else	
					--	tfstr = tfjswz1[j]
						tjm(bx*35,by*60,tfstr,C_BLACK,size*0.8,10,h+3)
					end	
				--end
			end	
			--DrawString
			--DrawString(bx*300,by*12,'编号'..lb[3][cx][2],M_YellowGreen,size2)
			--DrawString(bx*200,by*80,'编号:'..lb[3][cx][2],M_YellowGreen,size)
			--for j = 1, #bossztwz do
				--local tfstr = bossztwz[j]
				--tjm(bx*50,by*80,tfstr,C_BLACK,size,10,h+10)
			--end	
		    --DrawString(bx*50,by*270+wz*by+(by*40+size),'武功招式',C_RED,size)
		end
	end
     
   end
	
	
	
   ShowScreen()
   local X,ktype,mx,my = lib.GetKey()
   if X == VK_SPACE or X == VK_RETURN then
      --if JY.Status ~= GAME_WMAP then
		  if page == 1 then
			 page = 2		 
		  elseif page == 2 then 
			 if lb1[cx1] == 5 then
			 --   Personzb(id,cx)
			 elseif lb1[cx1] == 4 then	
				if cx == #lb[4] then 
				--  Menu_Jiali(id)
				--	say("测试位置1"..cx,0,1)
					Menu_Gongti(id,yg[cx][2])
				else 
				  Menu_Gongti(id,yg[cx][2])
				end
			 elseif lb1[cx1] == 3 then	
				--detailed_info(cur_thing)
				if cx <= #lb[3] then
					--say("现在位置："..lb[3][cx][1],0,1)
					local p = JY.Person[id]
					local thingid = 0
				
					for j = 0, JY.ThingNum - 1 do  --读取物品
						if JY.Thing[j]["练出技能"] >= 0 and JY.Thing[j]["练出技能"] == lb[3][cx][1] then											
							thingid = j
							break
						end	
					end
					
					--detailed_info(thingid)
				
				detailed_info(thingid)
				end
			 elseif lb1[cx1] == 2 then
				if cx <= #lb[2] then
					local p = JY.Person[id]
					local thingid = 0
				
					for j = 0, JY.ThingNum - 1 do  --读取物品
						if JY.Thing[j]["练出武功"] >= 0 and JY.Thing[j]["练出武功"] == lb[2][cx][1] then											
							thingid = j
							break
						end	
					end
					
					--detailed_info(thingid)
				
				detailed_info(thingid)
				end
			 elseif lb1[cx1] == 1 then
				-- if cx >= 5 then 
				-- --  Menu_Jiali(id)
				-- --say("测试位置1"..cx,0,1)
					-- --Menu_Gongti(id,yg[cx][2])
					-- --lib.LoadPNG(91,165*2,bx*500,by*46+(cx*15),1)
					-- lib.LoadPNG(91,161*2,0,0,1)
					-- --local name = JY.Wugong[JY.Person[id]["武功" .. lb[3][cx][2]]]['名称']
					-- --DrawString(bx*50,by*12,name,M_Yellow,size)
					-- --DrawString(bx*300,by*12,'编号'..lb[3][cx][2],M_YellowGreen,size2)
					-- --DrawString(bx*200,by*80,'编号:'..lb[3][cx][2],M_YellowGreen,size)
					-- --for j = 1, #bossztwz do
						-- --local tfstr = bossztwz[j]
						-- --tjm(bx*50,by*80,tfstr,C_BLACK,size,10,h+10)
					-- --end	
					-- --for k = 1, tfjsbh do
						-- local n = 0
						-- local tfstr = tfjswz[cx-n] --= tfstr
						-- --local tfstr1 = tfjswz[cx-n] --= tfstr
						-- local h1 = 0
						-- if cx == 5 then
							-- --n = 5
							-- for j = 1 ,#tfjswz1 do
							-- tfstr = tfjswz1[j]
							-- tjm(bx*50,by*40+j*60,tfstr,C_BLACK,size*0.7,14,h+3)
							-- --tjm(bx*550,by*46+(cx*15)+j*20,tfstr,C_WHITE,size1,math.floor(bx*350/(size1)*0.8)+15,h+10)
							-- end
						-- --	say("专属天赋",0,1)
						-- else
							-- n = 5
							-- tfstr = tfjswz[cx-n]
							-- tjm(bx*50,by*80,tfstr,C_BLACK,size*0.7,14,h+10)
							-- --tjm(bx*550,by*46+(cx*15),tfstr,C_WHITE,size*0.8,math.floor(bx*350/(size)*0.8)+2,h+10)
						-- end

					-- --DrawString(bx*935-string.len('未开启第二运功')/4*size,by*136-size/2,'未开启第二运功',C_WHITE,size)
					-- ShowScreen()
					-- WaitKey()
				-- else 
				  -- --Menu_Gongti(id,yg[cx][2])
				-- end
			 end
		  end
	  --end
   elseif X == VK_ESCAPE or ktype == 4 then 
      if page == 2 then 
	     page = page - 1 
		 cx = 1 
		 cx1 = 1
	  else 	 
         break
	  end
	  fy = 0
   elseif X == VK_UP then
	  --page2人物属性选择
	  --if JY.Status ~= GAME_WMAP then
		if page == 2 then 
			cx = cx - 1
			if cx < 1 then
				cx = #lb[lb1[cx1]]
			end	
			
		end
		fy = 0
	 -- end
   elseif X == VK_DOWN then
	  --page2人物属性选择
	 -- if JY.Status ~= GAME_WMAP then
		  if page == 2 then 
			 cx = cx + 1
			 if cx > #lb[lb1[cx1]] then
				cx = 1
			 end
			 fy = 0
		  end
	  --end
   elseif X == VK_LEFT  then
      --page1人物页面切换
	  if JY.Status ~= GAME_WMAP then
		  if page == 1 then 
			 t = t - 1 
			 if t < 1 then
				t = #team
			 end
		  end
	  end  --page2人物属性选择
		  if page == 2 then 
			 cx1 = cx1 - 1
			 cx = 1
			 if cx1 < 1 then 
				cx1 = #lb1
			 end
			 fy = 0
		  end
	-- end
   elseif X == VK_RIGHT  then
      --page1人物页面切换
	  if JY.Status ~= GAME_WMAP then
		  if page == 1 then
			 t = t + 1 
			 if t > #team then 
				t = 1
			 end
		  end
	 end
		  --page2人物属性选择
		  if page == 2 then 
			 cx1 = cx1 + 1
			 cx = 1
			 if cx1 > #lb1 then 
				cx1 = 1
			 end	
			 fy = 0
		  end	
    --  end	  
   elseif X == VK_PGUP then
      --if JY.Status ~= GAME_WMAP then
		  if page == 2 and lb1[cx1] == 2 then 
			 fy = fy - 1
			 if fy < 0 then 
				fy = 0
			 end	
		  end
	  --end
   elseif X == VK_PGDN then
      --if JY.Status ~= GAME_WMAP then
		  if page == 2 and lb1[cx1] == 2 then 
			 fy = fy + 1
			 if fy > fymax then
				fy = fymax 
			 end
		  end
	  --end
   else 
     -- if JY.Status ~= GAME_WMAP then
      local mxx = false 
	  if page == 1 then 
	     if ktype == 3 then 
		    page = 2
		 end
	  elseif page == 2 then 
	     if #lb[1] > 0 then 
		    for ii = 1,#lb[1] do 
			    if mx >= bx*420 and mx <= bx*420 + bx*160 and 
				   my >= by*60+(ii-1)*h and my <= by*60+(ii-1)*h + size1 then 
				   cx = ii
				   cx1 = lb2[1]
				   mxx = true 
				   break
				end
			end
		 end	
		 if #lb[2] > 0 then 
		    for ii = 1,#lb[2] do 
			    if mx >= bx*660 and mx <= bx*660 +size1*4 and 
				   my >= by*60+(ii-1)*h and my <= by*60+(ii-1)*h + size1 then 
				   cx = ii 
				   cx1 = lb2[2]
				   mxx = true 
				   break
				end
			end
		 end
		 if #lb[3] > 0 and mxx == false then 
		    for ii = 1,#lb[3] do 
			    if mx >= bx*900 and mx <= bx*900 +size1*4 and 
				   my >= by*60+(ii-1)*h and my <= by*60+(ii-1)*h + size1 then 
				   cx = ii 
				   cx1 = lb2[3]
				   mxx = true 
				   break
				end
			end
		 end
		 if #lb[4] > 0 then 
		    for ii = 1,#lb[4] do 
			    if mx >= bx*1142 and mx <= bx*1345 and 
				   my >= by*78+(ii-1)*by*48-by*18 and my <= by*78+(ii-1)*by*48+by*18 then 
				   cx = ii 
				   cx1 = lb2[4]
				   mxx = true 
				   break
				end
			end
		 end
		 if #lb[5] > 0 then 
		    for ii = 1,#lb[5] do 
			    if mx >= bx*422 and mx <= bx*622 and 
				   my >= by*488+(ii-1)*by*48-by*18 and my <= by*488+(ii-1)*by*48+by*18 then 
				   cx = ii 
				   cx1 = lb2[5]
				   mxx = true 
				   break
				end
			end
		 end
		 if mxx == true and ktype == 3 then 
	        if lb1[cx1] == 5 then
		    --   Personzb(id,cx)
		    elseif lb1[cx1] == 4 then	
		       if cx == #lb[4] then 
			    
				Menu_Gongti(id,yg[cx][2])
			   else 
			      Menu_Gongti(id,yg[cx][2])
			   end
		    elseif lb1[cx1] == 2 then
		    
		    end
		 end
	  end
	  --end
   end
   
   
   end
end 

--顶部特效文字 
function TXWZXS(str,cl,n)
    if n == nil then 
	   n = 0
	end
	local i = n 
	if i > 20 then 
		i = 20 
	end	
	Cls()
	DrawStrBox(-1, 24, str, cl, 10 + i)
	ShowScreen()
	lib.Delay(CC.BattleDelay)
    if n == 40 then
	   return
	else
	   return TXWZXS(str,cl,n+5)
	end
end

function zhanyi(pp, aa, flag)
	if aa > 0 and flag == nil then
		if Curr_NG(pp, 92) then
			aa = aa * 1.5
		elseif PersonKF(pp, 92) then
			aa = aa * 1.2
		end  
	end
	aa = math.modf(aa)
	WAR.SPIRIT[pp] = limitX((WAR.SPIRIT[pp] or 100) + aa, (WAR.SPIRITMIN[pp] or 80), (WAR.SPIRITMAX[pp] or 140))	
end

function jiazhanyi(pid) --加战意

	return 0
end

function sixi(pid, t)
	local a = 0
	if t == 1 then
		a = JY.Person[pid]["拳掌功夫"] + MPAttrib(pid, 10)
	elseif t == 3 then
		a = TrueYJ(pid) + MPAttrib(pid, 12)
	elseif t == 4 then
		a = JY.Person[pid]["耍刀技巧"] + MPAttrib(pid, 13)		
	elseif t == 5 then
		a = JY.Person[pid]["特殊兵器"] + MPAttrib(pid, 14)	
	elseif t == 2 then
		a = JY.Person[pid]["指法技巧"] + MPAttrib(pid, 11)			
	end
	return a
end

function yongquan(pp)
	if JY.Wugong[pp]["武功类型"] == 1 then
		return true
	else
		return false
	end
end

function yongjian(pp)
	if JY.Wugong[pp]["武功类型"] == 3 then
		return true
	else
		return false
	end
end

function yongdao(pp)
	if JY.Wugong[pp]["武功类型"] == 4 then
		return true
	else
		return false
	end
end

function yongte(pp)
	if JY.Wugong[pp]["武功类型"] == 5 then
		return true
	else
		return false
	end
end

function yongzhi(pp)
	if JY.Wugong[pp]["武功类型"] == 2 then
		return true
	else
		return false
	end
end

function yongnei(pp)
	if JY.Wugong[pp]["武功类型"] == 6 then
		return true
	else
		return false
	end
end

function wgnumber(tmppid, wgtype, flag)
	local wg = 0
	local ji = true
	if flag == nil then
		ji = false
	end
	if wgtype == 0 then
		for i = 1, CC.Kungfunum do
			if ji or JY.Person[tmppid]["武功等级" .. i] >= 999 then
				wg = wg + 1
			end
		end
	elseif wgtype == 1 then 
		for i = 1, CC.Kungfunum do
		  if yongquan(JY.Person[tmppid]["武功" .. i]) and (ji or JY.Person[tmppid]["武功等级" .. i] >= 999) then
			wg = wg + 1
		  end
		end
	elseif wgtype == 2 then
		for i = 1, CC.Kungfunum do
		  if yongzhi(JY.Person[tmppid]["武功" .. i]) and (ji or JY.Person[tmppid]["武功等级" .. i] >= 999) then
			wg = wg + 1
		  end
		end
	elseif wgtype == 3 then
		for i = 1, CC.Kungfunum do
		  if yongjian(JY.Person[tmppid]["武功" .. i]) and (ji or JY.Person[tmppid]["武功等级" .. i] >= 999) then
			wg = wg + 1
		  end
		end
	elseif wgtype == 4 then
		for i = 1, CC.Kungfunum do
		  if yongdao(JY.Person[tmppid]["武功" .. i]) and (ji or JY.Person[tmppid]["武功等级" .. i] >= 999) then
			wg = wg + 1
		  end
		end
	elseif wgtype == 5 then
		for i = 1, CC.Kungfunum do
			if yongte(JY.Person[tmppid]["武功" .. i]) and (ji or JY.Person[tmppid]["武功等级" .. i] >= 999) then
				wg = wg + 1
			end
		end	
	elseif wgtype == 6 then
		for i = 1, CC.Kungfunum do
          	if yongnei(JY.Person[tmppid]["武功" .. i]) and (ji or JY.Person[tmppid]["武功等级" .. i] >= 999) then
				wg = wg + 1			
			end  
		end			
	end
	return wg
end

function douzhuankekong(person)
	local p = JY.Person[person]
    local dzlv = JY.Person[person]["拳掌功夫"] + JY.Person[person]["御剑能力"] + 
		JY.Person[person]["耍刀技巧"] + JY.Person[person]["特殊兵器"] + JY.Person[person]["指法技巧"]
	if dzlv >= 390 or match_ID(person, 113) or match_ID_awakened(person, 51,1) then --試做測試-斗轉數值設定
		return true
	elseif wglw(person,74)>=1  and WAR.SHJG[person] ~=nil and WAR.SHJG[person] == 2 and  WAR.DZXYLV[person] ~= nil then
        return true
	elseif match_ID_awakened(person,55,1) and WAR.DZXYLV[person] == 120 and JY.Person[55]["品德"] == 70 and WAR.GBGJ == -2 then
        return true
	else
		return false
	end
end

function zhuijikekong(person)
	local p = JY.Person[person]
    local dzlv = sixi(person,5)
	if dzlv >= 120 or wglw(person,84)>1 then --試做測試-斗轉數值設定
		return true
	end
end

function nokillspeed(pid)
	if wglw(pid,58)>2 and WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100 then
	   return true
	end
	return false
end

function zssdz(pid) ----
   local a = JY.Person[pid]["头像代号"]*2
   local dx=0
   local dr =0
   if pid == 65 then----
      dx = 200
	  dr = 150
   end
   if  pid == 0 and JY.Base["标准"] >0 then--

   end
   
   for i = 1,121,60 do 
   lib.LoadPNG(90, a, CC.ScreenW/2+dx, CC.ScreenH/2+dr)
   	ShowScreen()
   end
	ShowScreen()
	lib.Delay(100)
end

function zssdz2(pid) ----
   local dx=0
   local dr =200
   if pid == 65 then----
      dx = 200
	  dr = 150
   end
   for i = 1,121,60 do 
    lib.LoadPNG(90, pid*2, CC.ScreenW/2+dx, CC.ScreenH/2+dr)
	ShowScreen()
	--lib.Delay(200)
   end
	ShowScreen()
	lib.Delay(100)
end

function randomanqi() --返回随机暗器 武骧金星：改为随机获得一种
	--local num = 0
	--local menu = {}
	--for i = 1, CC.MyThingNum do
	--	if JY.Base["物品" .. i] >= 0 and JY.Base["物品数量" .. i] > 0 
	--		and JY.Thing[JY.Base["物品" .. i]]["类型"] == 4 then
	--		num = num + 1
	--		menu[num] = {JY.Base["物品" .. i], JY.Base["物品数量" .. i]}
	--	end
	--end
	--if num > 0 then
	--	local r = math.random(#menu)
	--	return menu[r][1]
	--end
	--return -1
	return math.random(28,35)
end

function nomiss(pid) --必命中
	if match_ID(pid,447) and WAR.HUANJIAN==1 then
		return true
	end
	if match_ID(pid,78) then
	   return true
	end
	if match_ID(pid, 13) then
	   return true
	end
	if match_ID(pid, 130) then
	   return true
	end
	if nglw(pid,96)>1 and WAR.XLZ_FM==1 then
		return true
	end
	if wglw(pid,25)>1 and WAR.ARZS==4  then----
	   return true
	end
	if wglw(pid,162)>1 and WAR.KFKJ2>= 1 then
	return true	
    end
	if match_ID_awakened(pid,78,1) then
    return true	
	end
	if JY.Person[pid]["饰品"] == 194 and JLSD(10,50,pid) then
	return true
	end
    if match_ID_awakened(pid, 35, 1)  then
       return true	
	end
	if WAR.WYSQ==2 then--
	   return true
	end	
	return false
end

function nohuti(pid) --无视护体
	if match_ID(pid,448) and WAR.BADAO==1 then
		return true
	end
	if WAR.LHQ_FM==1 then
		return true
	end
	if match_ID(pid, 64) and WAR.KMZWD >=1 then
	return true
	end
	if wglw(pid,25)>1 and WAR.ARZS==3  then----
	   return true
	end
	if WAR.LXYZ==1 then--
	   return true
	end
	if WAR.WYSQ==2 then--
	   return true
	end	
	if wglw(pid,74)>=1  and WAR.SHJG[pid] ~=nil and WAR.SHJG[pid] == 2 and WAR.YCHX == 2 then
	   return true
	end
	
	return false
end

function nohuti2(eid) --无视护体
    if WAR.WFHT[eid]~=nil  then
	return true
	end
	if WAR.YZSP[eid] ~= nil then
	return true
	end
	return false
end

function notan(pid) --不反弹
	if match_ID(pid,447) and WAR.HUANJIAN==1 then
		return true
	end
	if wglw(pid,25)>1 and WAR.ARZS==4  then----
	   return true
	end
	return false
end

function BXZT(pid)
local aa = 0
	if WAR.PEACE[pid] ~=nil then
		aa = 1
	end
	return aa
end

function Fanji(eid)---反击
  if match_ID(eid, 517) and JLSD(20, 80, eid) then
  return true
  end
  		if wglw(eid,74)>=1 and WAR.SHJG[eid] ~=nil and WAR.SHJG[eid] == 2 and JLSD(20, 80, eid) then
		return true
		end
  return false
end

function DF(move,wf)		--单法 move=攻击距离 wf=是否选择我方 返回r,x,y,emid,em
	War_CalMoveStep(WAR.CurID, move, 1)
	local nx, ny = nil, nil
	local em = -1
	local emid = -1
	local r = 1
	while true do
		nx, ny = War_SelectMove() --显示+选择步数
		if nx == nil then
			return 0
		end
		if nx ~= nil then
			if lib.GetWarMap(nx, ny, 2) < 0 and lib.GetWarMap(nx, ny, 5) < 0 then
				QZXS("此处无人，请重新选择")
			elseif GetWarMap(nx, ny, 2) == nil or GetWarMap(nx, ny, 2) < 0 then
				QZXS("此处无人，请重新选择")
			else
				em = GetWarMap(nx, ny, 2)
				emid = WAR.Person[em]["人物编号"]
				if wf == 1 and not WAR.Person[em]["我方"] then
					QZXS("不能选择敌方人物")
				elseif wf == 0 and WAR.Person[em]["我方"] then
					QZXS("不能选择我方人物")
				else
					break;
				end
			end
		end
	end
	return r, nx, ny, WAR.Person[em]["人物编号"] , em
end

function QF(hit,xg,wf)	--群法 hit=攻击数量0为全体攻击 xg=命中效果 wf是否作用于我方
	--计算敌人数量并按生命升序摆列
	local dr = {}
	local num = 0
	local id = WAR.Person[WAR.CurID]["人物编号"]
	for i = 0, WAR.PersonNum - 1 do
		if ((wf == 0 and not WAR.Person[i]["我方"]) or (wf == 1 and WAR.Person[i]["我方"])) and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 then
			num = num + 1
			dr[num] = i
		end
	end

	for i = 1, num - 1 do
		for j = i, num - 1 do
			local dr1 = WAR.Person[dr[j]]["人物编号"]
			local dr2 = WAR.Person[dr[j+1]]["人物编号"]
			if JY.Person[dr1]["生命"] > JY.Person[dr2]["生命"] then
				local temp = dr[j]
				dr[j] = dr[j+1]
				dr[j+1] = temp
			end
		end
	end

	if hit > num or hit == 0 then
		hit = num
	end
	if hit ~= 0 then
		local maxhit = math.modf(JY.Person[id]["内力"] / 300)
		if hit > maxhit then
			hit = maxhit
		end
	end
	CleanWarMap(4,0)
	for i = 1, hit do
		SetWarMap(WAR.Person[dr[i]]["坐标X"],WAR.Person[dr[i]]["坐标Y"],4,xg)
	end
	return dr, hit
end

function QF2(hit,xg,wf)	--群法 hit=攻击数量0为全体攻击 xg=命中效果 wf是否作用于我方
	--计算敌人数量并按生命升序摆列
	local dr = {}
	local num = 0
	local id = WAR.Person[WAR.CurID]["人物编号"]
	for i = 0, WAR.PersonNum - 1 do
		if ((wf == 0 and not WAR.Person[i]["我方"]) or (wf == 1 and WAR.Person[i]["我方"])) and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 then
			num = num + 1
			dr[num] = i
		end
	end
	
	if hit > num or hit == 0 then
		hit = num
	end
	if hit ~= 0 then
		local maxhit = math.modf(JY.Person[id]["内力"] / 300)
		if hit > maxhit then
			hit = maxhit
		end
	end
	CleanWarMap(4,0)
	for i = 1, hit do
		SetWarMap(WAR.Person[dr[i]]["坐标X"],WAR.Person[dr[i]]["坐标Y"],4,xg)
	end
	return dr, hit
end

function DS(wf)	--计算生命值最低人员 wf是否作用于我方
	--计算敌人数量并按生命升序摆列
	local dr = {}
	local num = 0
	local id = WAR.Person[WAR.CurID]["人物编号"]
	for i = 0, WAR.PersonNum - 1 do
		if ((wf == 0 and not WAR.Person[i]["我方"]) or (wf == 1 and WAR.Person[i]["我方"])) and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 then
			num = num + 1
			dr[num] = i
		end
	end
	for i = 1, num - 1 do
		for j = i, num - 1 do
			local dr1 = WAR.Person[dr[j]]["人物编号"]
			local dr2 = WAR.Person[dr[j+1]]["人物编号"]
			if JY.Person[dr1]["生命"] > JY.Person[dr2]["生命"] then
				local temp = dr[j]
				dr[j] = dr[j+1]
				dr[j+1] = temp
			end
		end
	end
    local tid = WAR.Person[dr[1]]["人物编号"]
	return tid
end

function Tianluo(personid)
	local xwperson;	--沼跃鱼:判定天赋觉醒人
	local num=0
	if personid == 0 then
		xwperson = 0
	else
		xwperson = personid
	end	
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]	
	    if id  == xwperson and qglw(id,148) >=1 then
	        for j = 0, WAR.PersonNum-1 do 
			    local df = WAR.Person[j]["人物编号"] 
			    local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
                local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			    local offset=offset1+offset2
                local mpdj = qglw(xwperson,148)+3			
			    if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
                    num = num + 1
			    end
           end		    
	   end
	end
	return num
end

function War_AutoKHYX()
 local nx, ny = nil, nil
  War_CalMoveStep(WAR.CurID,12, 1)
  WarDrawMap(1)
  ShowScreen()
  local starttime = lib.GetTime()
  local array = {}
  local num = 0
  
  for i = 0, CC.WarWidth - 1 do
    for j = 0, CC.WarHeight - 1 do		
		if GetWarMap(i, j, 2) > 0 and GetWarMap(i, j, 2) ~= WAR.CurID then		
		elseif GetWarMap(i, j, 5) > 0 and GetWarMap(i, j, 5) ~= WAR.Person[WAR.CurID]["贴图"] then		
		elseif GetWarMap(i, j, 3) < 128 then
			local minDest = math.huge
			for k = 0, WAR.PersonNum - 1 do
			  if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[k]["我方"] and WAR.Person[k]["死亡"] == false then
				local dx = math.abs(i - WAR.Person[k]["坐标X"])
				local dy = math.abs(j - WAR.Person[k]["坐标Y"])
				  if dx + dy < minDest then		--计算当前距离敌人最近的位置
					minDest = dx + dy
				  end
			  end
			end
			num = num + 1
			array[num] = {}
			array[num].x = i
			array[num].y = j
			array[num].p = minDest
		end
    end
  end
  
  for i = 1, num - 1 do
    for j = i, num do
      if array[i].p < array[j].p then
        array[i], array[j] = array[j], array[i]
      end
    end
  end
  for i = 2, num do
    if array[i].p < array[1].p / 2 then
      num = i - 1
    end
  end
  for i = 1, num do
    array[i].p = array[i].p * 5 + GetMovePoint(array[i].x, array[i].y, 1)
  end
  for i = 1, num - 1 do
    for j = i, num do
      if array[i].p < array[j].p then
        array[i], array[j] = array[j], array[i]
      end
    end
  end
  nx = array[1].x
  ny = array[1].y
  if nx == WAR.Person[WAR.CurID]["坐标X"] and ny == WAR.Person[WAR.CurID]["坐标Y"] then 
     nx = WAR.KHYX[WAR.Person[WAR.CurID]["人物编号"]][1]
	 ny = WAR.KHYX[WAR.Person[WAR.CurID]["人物编号"]][2] 
  end
  local endtime = starttime + 200 - lib.GetTime()
  if endtime > 0 then
    lib.Delay(endtime)
  end
	War_CalMoveStep(WAR.CurID,12, 1)	
                          --   local nx, ny = math.random(i-2,i+3), math.random(j-3,j+2)
                            -- if lib.GetWarMap(nx, ny, 2) < 0 and lib.GetWarMap(nx, ny, 5) < 0 and CC.SceneWater[lib.GetWarMap(nx, ny, 2)] == nil and CC.SceneWater[lib.GetWarMap(nx, ny, 5)] == nil then--GetWarMap(nx, ny, 1) > 0 do
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
	    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
end

function selectPerson(num, flag)--1敌2我3both
	War_CalMoveStep(WAR.CurID, num, 1) 
	local nx, ny = nil, nil
	local victim = -1
	local victimid = -1
	while true do
		nx, ny = War_SelectMove()
		if nx == nil then
			return -1, -1, -1, -1
		end
		if nx ~= nil then
			if lib.GetWarMap(nx, ny, 2) < 0 and lib.GetWarMap(nx, ny, 5) < 0 then
				QZXS("此处无人，请重新选择")			
			elseif GetWarMap(nx, ny, 2) == nil or GetWarMap(nx, ny, 2) < 0 then
				QZXS("此处无人，请重新选择")	
			else
				victim = GetWarMap(nx, ny, 2)
				victimid = WAR.Person[victim]["人物编号"]
				if flag == 1 and WAR.Person[WAR.CurID]["我方"] == WAR.Person[victim]["我方"] then
					QZXS("不能选择我方人物")	
				elseif flag == 2 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[victim]["我方"] then
					QZXS("不能选择敌方人物")	
				else
					break;
				end
			end
		end
	end
	return nx, ny, victim, victimid
end

--返回两人之间的实际距离
function War_realjl(ida, idb)
	if ida == nil then
		ida = WAR.CurID
	end
	CleanWarMap(3, 255)
	local x = WAR.Person[ida]["坐标X"]
	local y = WAR.Person[ida]["坐标Y"]
	local steparray = {}
	steparray[0] = {}
	steparray[0].bushu = {}
	steparray[0].x = {}
	steparray[0].y = {}
	SetWarMap(x, y, 3, 0)
	steparray[0].num = 1
	steparray[0].bushu[1] = 0		--还能移动的步数
	steparray[0].x[1] = x
	steparray[0].y[1] = y
	return War_FindNextStep1(steparray, 0, ida, idb)
end

--AI选择目标的函数
function unnamed(kfid)
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  local kungfuid = JY.Person[pid]["武功" .. kfid]
  local kungfulv = JY.Person[pid]["武功等级" .. kfid]
  if kungfulv == 999 then
    kungfulv = 11
  else
    kungfulv = math.modf(kungfulv / 100) + 1
  end
  local m1, m2, a1, a2, a3, a4, a5 = refw(kungfuid, kungfulv)
  local mfw = {m1, m2}
  local atkfw = {a1, a2, a3, a4, a5}
  if kungfulv == 11 then
    kungfulv = 10
  end
  --AI也用新的威力判定
  local kungfuatk = get_skill_power(pid, kungfuid, kungfulv)
  local atkarray = {}
  local num = 0
  CleanWarMap(4, -1)
  local movearray = War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
  WarDrawMap(1)
  ShowScreen()
  for i = 0, WAR.Person[WAR.CurID]["移动步数"] do
    local step_num = movearray[i].num
    if step_num ~= nil then
	    for j = 1, step_num do
	      local xx = movearray[i].x[j]
	      local yy = movearray[i].y[j]
	      num = num + 1
	      atkarray[num] = {}
	      atkarray[num].x, atkarray[num].y = xx, yy
	      atkarray[num].p, atkarray[num].ax, atkarray[num].ay = GetAtkNum(xx, yy, mfw, atkfw, kungfuatk)
	      
	    end
    end
  end
  for i = 1, num - 1 do
    for j = i + 1, num do
      if atkarray[i].p < atkarray[j].p then
        atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
      end
    end
  end
  if atkarray[1].p > 0 then
    for i = 2, num do
      if atkarray[i].p == 0 or atkarray[i].p < atkarray[1].p / 2 then
        num = i - 1
        break;
      end
    end
    for i = 1, num do
		if WAR.Person[WAR.CurID]["我方"] == true then
			--flag: approach enemies.
			atkarray[i].p = atkarray[i].p + GetMovePoint(atkarray[i].x, atkarray[i].y)
		else
			--flag: aviod enemies. avoiding as many enemies as possible while retaining targeting the spot with higher threat
			atkarray[i].p = atkarray[i].p + GetMovePoint(atkarray[i].x, atkarray[i].y, 1)
		end
    end
    for i = 1, num - 1 do
      for j = i + 1, num do
        if atkarray[i].p < atkarray[j].p then
          atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
        elseif atkarray[i].p == atkarray[j].p and math.random(2) > 1 then
        	atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
        end
      end
    end
    for i = 2, num do
      if atkarray[i].p < atkarray[1].p *4/5 then
        num = i - 1
        break;
      end
    end
	
    local select = 1
    
    War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
    War_MovePerson(atkarray[select].x, atkarray[select].y)
    War_Fight_Sub(WAR.CurID, kfid, atkarray[select].ax, atkarray[select].ay)
	--阿凡提攻击完躲开
	if pid == 606 then
		WAR.Person[WAR.CurID]["移动步数"] = 10
		War_AutoEscape()
		War_RestMenu()
	end
  else
	--打不到人，考虑吃药
    local jl, nx, ny = War_realjl()
    AutoMove()
	--默认为休息
	local what_to_do = 0
	local can_eat_drug = 0
	--非我方，会考虑吃药
	if WAR.Person[WAR.CurID]["我方"] == false then
		can_eat_drug = 1
	--如果是我方，只有在队且允许才会吃药
	else
		if inteam(pid) and JY.Person[pid]["是否吃药"] == 1 then
			can_eat_drug = 1
		end
	end
	--不是左右第二下，考虑吃药
	if WAR.ZYHB == 2 then
		can_eat_drug = 0
	end
	--1:吃体力药 2：吃血 3：医疗 4：吃内力 5：吃解毒
	if can_eat_drug == 1 then
		local r = -1
		--体力低于10，吃体力药
		if JY.Person[pid]["体力"] < 10 then
			r = War_ThinkDrug(4)
			if r >= 0 then
				what_to_do = 1
			end
		end
		local rate = -1
		if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
			rate = 90
		elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
			rate = 70
		elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
			rate = 50
		elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
			rate = 25
		end
		--内伤也增加吃血药几率
		if JY.Person[pid]["受伤程度"] > 50 then
			rate = rate + 50
		end
		if Rnd(100) < rate then
			r = War_ThinkDrug(2)
			if r >= 0 then				--如果有药吃药
				what_to_do = 2
			else
				r = War_ThinkDoctor()		--如果没有药，考虑医疗
				if r >= 0 then
					what_to_do = 3
				end
			end
		end
		--考虑内力
		rate = -1
		if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
			rate = 100
		elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
			rate = 75
		elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
			rate = 50
		end
		if Rnd(100) < rate then
			r = War_ThinkDrug(3)
			if r >= 0 then
				what_to_do = 4
			end
		end
		rate = -1
		if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
			rate = 60
		else
			if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
				rate = 30
			end
		end
		--半血以下，才吃解毒药
		if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and Rnd(100) < rate then
			r = War_ThinkDrug(6)
			if r >= 0 then
				what_to_do = 5
			end
		end
	end
	--吃药flag 2：生命 3：内力 4：体力 6：解毒
	if what_to_do == 0 then
		War_RestMenu()
	elseif what_to_do == 1 then
		War_AutoEatDrug(4)
	elseif what_to_do == 2 then
		War_AutoEatDrug(2)
	elseif what_to_do == 3 then
		War_AutoDoctor()
	elseif what_to_do == 4 then
		War_AutoEatDrug(3)
	elseif what_to_do == 5 then
		War_AutoEatDrug(6)
	end
  end
end

function AutoMove()
  local x, y = nil, nil
  local minDest = math.huge
  local enemyid=War_AutoSelectEnemy()   --选择最近敌人
  
    if enemyid== -1 then
	enemyid = WAR.CurID
	end

	War_CalMoveStep(WAR.CurID,100,0);   --计算移动步数 假设最大100步

	for i=0,CC.WarWidth-1 do
     for j=0,CC.WarHeight-1 do
				local dest=GetWarMap(i,j,3);
        if dest <128 then
          local dx=math.abs(i-(WAR.Person[enemyid]["坐标X"] or i))
          local dy=math.abs(j-(WAR.Person[enemyid]["坐标Y"] or j))
          if minDest>(dx+dy) then        --此时x,y是距离敌人的最短路径，虽然可能被围住
            minDest=dx+dy;
            x=i;
            y=j;
          elseif minDest==(dx+dy) then
            if Rnd(2)==0 then
                x=i;
                y=j;
            end
          end
        end
    end
	end

	if minDest<math.huge then   --有路可走
	    while true do    --从目的位置反着找到可以移动的位置，作为移动的次序
				local i=GetWarMap(x,y,3);
			if i<=WAR.Person[WAR.CurID]["移动步数"] then
				break;
			end

			if GetWarMap(x-1,y,3)==i-1 then
				x=x-1;
			elseif GetWarMap(x+1,y,3)==i-1 then
				x=x+1;
			elseif GetWarMap(x,y-1,3)==i-1 then
				y=y-1;
			elseif GetWarMap(x,y+1,3)==i-1 then
				y=y+1;
			end
	    end
	  War_MovePerson(x,y);    --移动到相应的位置
  end
end

function GetMovePoint(x, y, flag)
	local point = 0
	local wofang = WAR.Person[WAR.CurID]["我方"]
	local movearray = MY_CalMoveStep(x, y, 16, 1)
	for i = 1, 16 do
		local step_num = movearray[i].num
		if step_num ~= nil then
			if step_num == 0 then
				break;
			end
			for j = 1, step_num do
				local xx = movearray[i].x[j]
				local yy = movearray[i].y[j]
				local v = GetWarMap(xx, yy, 2)
				if v ~= -1 then
					if v == WAR.CurID then
						break;
					else   
						if WAR.Person[v]["我方"] == wofang then
							point = point + i * 2 - 26
						elseif WAR.Person[v]["我方"] ~= wofang then
							if flag ~= nil then
								point = point + i - 17
							else
								point = point + 26 - i
							end
						end
					end
				end
			end
		end
	end
	return point
end

function MY_CalMoveStep(x, y, stepmax, flag)
  CleanWarMap(3, 255)
  local steparray = {}
  for i = 0, stepmax do
    steparray[i] = {}
    steparray[i].bushu = {}
    steparray[i].x = {}
    steparray[i].y = {}
  end
  SetWarMap(x, y, 3, 0)
  steparray[0].num = 1
  steparray[0].bushu[1] = stepmax
  steparray[0].x[1] = x
  steparray[0].y[1] = y
  War_FindNextStep(steparray, 0, flag)
  return steparray
end

--战斗会跳出的问题
function GetAtkNum(x, y, movfw, atkfw, atk)
  local point = {}
  local num = 0
  local kind, len = movfw[1], movfw[2]
  
  if kind == 0 then
    local array = MY_CalMoveStep(x, y, len, 1)
    for i = 0, len do
      local step_num = array[i].num
      if step_num ~= nil then
        if step_num == 0 then
          break;
        end
	      for j = 1, step_num do
	        num = num + 1
	        point[num] = {array[i].x[j], array[i].y[j]}
	      end
	    end
    end
  elseif kind == 1 then
    local array = MY_CalMoveStep(x, y, len * 2, 1)
    for r = 1, len * 2 do
      for i = 0, r do
        local j = r - i
        if len < i or len < j then
          SetWarMap(x + i, y + j, 3, 255)
          SetWarMap(x + i, y - j, 3, 255)
          SetWarMap(x - i, y + j, 3, 255)
          SetWarMap(x - i, y - j, 3, 255)
        end
      end
    end
    for i = 0, len do
      local step_num = array[i].num
      if step_num ~= nil then
        if step_num == 0 then
          break;
        end
	      for j = 1, step_num do
	        if GetWarMap(array[i].x[j], array[i].y[j], 3) < 128 then
	          num = num + 1
	          point[num] = {array[i].x[j], array[i].y[j]}
	        end
	      end
	    end
    end
  elseif kind == 2 then
    if not len then
      len = 1
    end
    for i = 1, len do
      if x + i < CC.WarWidth - 1 and GetWarMap(x + i, y, 1) > 0 and CC.WarWater[GetWarMap(x + i, y, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x + i, y}
    end
    for i = 1, len do
      if x - i > 0 and GetWarMap(x - i, y, 1) > 0 and CC.WarWater[GetWarMap(x - i, y, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x - i, y}
    end
    for i = 1, len do
      if y + i < CC.WarHeight - 1 and GetWarMap(x, y + i, 1) > 0 and CC.WarWater[GetWarMap(x, y + i, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x, y + i}
    end
    for i = 1, len do
      if y - i > 0 and GetWarMap(x, y - i, 1) > 0 and CC.WarWater[GetWarMap(x, y - i, 0)] == nil then
        break;
      end
      num = num + 1
      point[num] = {x, y - i}
    end
  elseif kind == 3 then
    if x + 1 < CC.WarWidth - 1 and GetWarMap(x + 1, y, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y, 0)] == nil then
      num = num + 1
      point[num] = {x + 1, y}
    end
    if x - 1 > 0 and GetWarMap(x - 1, y, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y, 0)] == nil then
      num = num + 1
      point[num] = {x - 1, y}
    end
    if y + 1 < CC.WarHeight - 1 and GetWarMap(x, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x, y + 1, 0)] == nil then
      num = num + 1
      point[num] = {x, y + 1}
    end
    if y - 1 > 0 and GetWarMap(x, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x, y - 1, 0)] == nil then
      num = num + 1
      point[num] = {x, y - 1}
    end
    if x + 1 < CC.WarWidth - 1 and y + 1 < CC.WarHeight - 1 and GetWarMap(x + 1, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y + 1, 0)] == nil then
      num = num + 1
      point[num] = {x + 1, y + 1}
    end
    if x - 1 > 0 and y + 1 < CC.WarHeight - 1 and GetWarMap(x - 1, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y + 1, 0)] == nil then
      num = num + 1
      point[num] = {x - 1, y + 1}
    end
    if x + 1 < CC.WarWidth - 1 and y - 1 > 0 and GetWarMap(x + 1, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y - 1, 0)] == nil then
      num = num + 1
      point[num] = {x + 1, y - 1}
    end
    if x - 1 > 0 and y - 1 > 0 and GetWarMap(x - 1, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y - 1, 0)] == nil then
    	num = num + 1
    	point[num] = {x - 1, y - 1}
  	end
  end
  local maxx, maxy, maxnum, atknum = 0, 0, 0, 0
  

  for i = 1, num do
    atknum = GetWarMap(point[i][1], point[i][2], 4)
    
    if atknum == -1 or atkfw[1] > 9 then
      atknum = WarDrawAtt(point[i][1], point[i][2], atkfw, 2, x, y, atk)
      SetWarMap(point[i][1], point[i][2], 4, atknum)
    end
    if atknum~= nil and maxnum < atknum then
      maxnum, maxx, maxy = atknum, point[i][1], point[i][2]
    end
  end
  
  return maxnum, maxx, maxy
end

function War_FindNextStep1(steparray,step,id,idb)      --设置下一步可移动的坐标
	--被上面的函数调用   
	local num=0;
	local step1=step+1;
	
	    steparray[step1]={};
		steparray[step1].bushu={};
        steparray[step1].x={};
        steparray[step1].y={};
	
	local function fujinnum(tx,ty)
		local tnum=0
		local wofang=WAR.Person[id]["我方"]
		local tv;
		tv=GetWarMap(tx+1,ty,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		tv=GetWarMap(tx-1,ty,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		tv=GetWarMap(tx,ty+1,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		tv=GetWarMap(tx,ty-1,2);
		if idb==nil then
			if tv~=-1 then
				if WAR.Person[tv]["我方"]~=wofang then
					return -1
				end
			end
		elseif tv==idb then
			return -1
		end
		if tv~=-1 then
			if WAR.Person[tv]["我方"]~=wofang then
				tnum=tnum+1
			end
		end
		return tnum
	end
	
	
	
	for i=1,steparray[step].num do
		--if steparray[step].bushu[i]<128 then
		steparray[step].bushu[i]=steparray[step].bushu[i]+1;
	    local x=steparray[step].x[i];
	    local y=steparray[step].y[i];
	    if x+1<CC.WarWidth-1 then                        --当前步数的相邻格
		    local v=GetWarMap(x+1,y,3);
			if v ==255 and War_CanMoveXY(x+1,y,0)==true then
                num= num+1;
                steparray[step1].x[num]=x+1;
                steparray[step1].y[num]=y;
				SetWarMap(x+1,y,3,step1);
				local mnum=fujinnum(x+1,y);
				if mnum==-1 then 
					return steparray[step].bushu[i],x+1,y
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end

	    if x-1>0 then                        --当前步数的相邻格
		    local v=GetWarMap(x-1,y,3);
			if v ==255 and War_CanMoveXY(x-1,y,0)==true then
                 num=num+1;
                steparray[step1].x[num]=x-1;
                steparray[step1].y[num]=y;
				SetWarMap(x-1,y,3,step1);
				local mnum=fujinnum(x-1,y);
				if mnum==-1 then 
					return steparray[step].bushu[i],x-1,y
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end

	    if y+1<CC.WarHeight-1 then                        --当前步数的相邻格
		    local v=GetWarMap(x,y+1,3);
			if v ==255 and War_CanMoveXY(x,y+1,0)==true then
                 num= num+1;
                steparray[step1].x[num]=x;
                steparray[step1].y[num]=y+1;
				SetWarMap(x,y+1,3,step1);
				local mnum=fujinnum(x,y+1);
				if mnum==-1 then 
					return steparray[step].bushu[i],x,y+1
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end

	    if y-1>0 then                        --当前步数的相邻格
		    local v=GetWarMap(x ,y-1,3);
			if v ==255 and War_CanMoveXY(x,y-1,0)==true then
                num= num+1;
                steparray[step1].x[num]=x ;
                steparray[step1].y[num]=y-1;
				SetWarMap(x ,y-1,3,step1);
				local mnum=fujinnum(x,y-1);
				if mnum==-1 then 
					return steparray[step].bushu[i],x,y-1
				else
					steparray[step1].bushu[num]=steparray[step].bushu[i]+mnum;
				end
			end
		end
		--end
	end
	if num==0 then return -1 end;
    steparray[step1].num=num;
	for i=1,num-1 do
		for j=i+1,num do
			if steparray[step1].bushu[i]>steparray[step1].bushu[j] then
				steparray[step1].bushu[i],steparray[step1].bushu[j]=steparray[step1].bushu[j],steparray[step1].bushu[i]
				steparray[step1].x[i],steparray[step1].x[j]=steparray[step1].x[j],steparray[step1].x[i]
				steparray[step1].y[i],steparray[step1].y[j]=steparray[step1].y[j],steparray[step1].y[i]
			end
		end
	end

	return War_FindNextStep1(steparray,step1,id,idb)
end
--修炼物品
function War_PersonTrainDrug(pid)
  local p = JY.Person[pid]
  local thingid = p["修炼物品"]
  if thingid < 0 then
    return 
  end
  if JY.Thing[thingid]["练出物品需经验"] <= 0 then
    return 
  end
  local needpoint = (7 - math.modf(p["资质"] / 15)) * JY.Thing[thingid]["练出物品需经验"]
  if p["物品修炼点数"] < needpoint then
    return 
  end
  
  local haveMaterial = 0
  local MaterialNum = -1
  for i = 1, CC.MyThingNum do
    if JY.Base["物品" .. i] == JY.Thing[thingid]["需材料"] then
      haveMaterial = 1
      MaterialNum = JY.Base["物品数量" .. i]
    end
  end
  
	--材料足够
	if haveMaterial == 1 then
		local enough = {}
		local canMake = 0
		for i = 1, 5 do
			if JY.Thing[thingid]["练出物品" .. i] >= 0 and JY.Thing[thingid]["需要物品数量" .. i] <= MaterialNum then
				canMake = 1
				enough[i] = 1
			else
				enough[i] = 0
			end
		end
		--可以练出
		if canMake == 1 then
			local makeID = nil
			while true do
				makeID = Rnd(5) + 1
				if thingid == 221 and pid == 88 and enough[4] == 1 then
					makeID = 4
				end
				if thingid == 220 and pid == 89 and enough[4] == 1 then
					makeID = 4
				end
				if enough[makeID] == 1 then
					break;
				end
			end
			
			local newThingID = JY.Thing[thingid]["练出物品" .. makeID]
			DrawStrBoxWaitKey(string.format("%s 制造出 %s", p["姓名"], JY.Thing[newThingID]["名称"]), C_WHITE, CC.DefaultFont)
			if instruct_18(newThingID) == true then
				instruct_32(newThingID, 1)
			else
				instruct_32(newThingID, 1)
			end
			instruct_32(JY.Thing[thingid]["需材料"], -JY.Thing[thingid]["需要物品数量" .. makeID])
			p["物品修炼点数"] = 0
		end
	end
end
--计算敌人中毒点数
--pid 使毒人，
--enemyid  中毒人
function War_PoisonHurt(pid, enemyid)
	local vv = math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5) - JY.Person[enemyid]["抗毒能力"]) / 4)
	--胡青牛在场王难姑用毒+50
	if JY.Status == GAME_WMAP then
		for i,v in pairs(CC.AddPoi) do
			if match_ID(pid, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						vv = vv + v[3] / 4
					end
				end
			end
		end
	end
	vv = vv - JY.Person[enemyid]["内力"] / 200
	for i = 1, 10 do
		if JY.Person[enemyid]["武功" .. i] == 108 then
			vv = 0
		end
	end
	vv = math.modf(vv)
	if vv < 0 then
		vv = 0
	end

		 	if wglw(pid, 142)>=1  then
		       local aa = WAR.XFZ
			   if WAR.FZ2[enemyid] == nil then
			   WAR.FZ2[enemyid] = {nil,nil,nil,nil,nil,nil}
			   end
		       WAR.FZ2[enemyid][aa] = (WAR.FZ2[enemyid][aa] or 0) + 1 + wglw(pid, 142)
		        if WAR.FZ2[enemyid][aa]>= 1+wglw(pid, 142)*3 then
		           WAR.FZ2[enemyid][aa] = 1+wglw(pid, 142)*3
		        end
	        end
			
			if PersonJL(pid,6) then
			local v = math.modf((JY.Person[enemyid]["中毒程度"] + vv)/5)
			   WAR.L_WNGZL[enemyid] = (WAR.L_WNGZL[enemyid] or 0) + math.modf(vv/5)
               if  Curr_JL(pid,6) then
                   for i = 0, WAR.PersonNum - 1 do
		               local id = WAR.Person[i]["人物编号"]
					   if enemyid == id then
					   WAR.Person[i]["精神崩溃"] = WAR.Person[i]["精神崩溃"] + v
					   end
		           end
				   if Kaiyan_ID(pid,17) and WAR.XFZ2>0 then
				        if WAR.XFZ2 == 1 then
					       WAR.JSCL[enemyid] = (WAR.JSCL[enemyid] or 0) + math.modf(vv/5)
					    elseif  WAR.XFZ2 == 2  then
					       WAR.XRZT[enemyid] = (WAR.XRZT[enemyid] or 0) + math.modf(vv/5)
					    elseif WAR.XFZ2 == 3  then
					       WAR.WMYH[enemyid] = (WAR.WMYH[enemyid] or 0) + math.modf(vv/5)
					    elseif WAR.XFZ2 == 4  then
						   WAR.BYCX[enemyid] = (WAR.BYCX[enemyid] or 0) + math.modf(vv/5)
						else
					  
					  end
				   end
               end			   
			end


	return AddPersonAttrib(enemyid, "中毒程度", vv)
end


--人物按轻功进行排序
function WarPersonSort(flag)
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		local add = 0
		local p = JY.Person[id]
		if p["武器"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["武器"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["武器"]]["加轻功"]*10 + JY.Thing[p["武器"]]["加轻功"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			elseif JY.Thing[p["武器"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["武器"]]["加轻功"]*10 - JY.Thing[p["武器"]]["加轻功"]*(JY.Thing[p["武器"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end
		if p["防具"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["防具"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["防具"]]["加轻功"]*10 + JY.Thing[p["防具"]]["加轻功"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			elseif JY.Thing[p["防具"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["防具"]]["加轻功"]*10 - JY.Thing[p["防具"]]["加轻功"]*(JY.Thing[p["防具"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end
		if p["坐骑"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["坐骑"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["坐骑"]]["加轻功"]*10 + JY.Thing[p["坐骑"]]["加轻功"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			elseif JY.Thing[p["坐骑"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["坐骑"]]["加轻功"]*10 - JY.Thing[p["坐骑"]]["加轻功"]*(JY.Thing[p["坐骑"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end	
		if p["饰品"] > -1 then
			local agi_gain = 0	
			if JY.Thing[p["饰品"]]["加轻功"] > 0 then
				agi_gain = agi_gain + JY.Thing[p["饰品"]]["加轻功"]*10 + JY.Thing[p["饰品"]]["加轻功"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			elseif JY.Thing[p["饰品"]]["加轻功"] < 0 then
				agi_gain = agi_gain + JY.Thing[p["饰品"]]["加轻功"]*10 - JY.Thing[p["饰品"]]["加轻功"]*(JY.Thing[p["饰品"]]["装备等级"]-1)*2
			end
			add = add + agi_gain
		end	
			add = add + MPAttrib(id, 3)
		WAR.Person[i]["轻功"] = JY.Person[id]["轻功"] + (add)
		--敌方的战场轻功会根据内力和等级加成
		if WAR.Person[i]["我方"] then
		  
		else
			WAR.Person[i]["轻功"] = WAR.Person[i]["轻功"] + math.modf(JY.Person[id]["内力最大值"] / 50) + JY.Person[id]["等级"]
		end
		--情侣加成
		for ii,v in pairs(CC.AddSpd) do
			if match_ID(id, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						WAR.Person[i]["轻功"] = WAR.Person[i]["轻功"] + v[3]
					end
				end
			end
		end
	end
	if flag ~= nil then
		return 
	end
	for i = 0, WAR.PersonNum - 2 do
		local maxid = i
		for j = i, WAR.PersonNum - 1 do
			if WAR.Person[maxid]["轻功"] < WAR.Person[j]["轻功"] then
				maxid = j;
			end
		end
		WAR.Person[maxid], WAR.Person[i] = WAR.Person[i], WAR.Person[maxid]
	end
end

--显示非攻击时的点数
function War_Show_Count(id, str)
	if JY.Restart == 1 then
		return
	end
	
	local pid = WAR.Person[id]["人物编号"];
	local x = WAR.Person[id]["坐标X"];
	local y = WAR.Person[id]["坐标Y"];
	
	local hp = WAR.Person[id]["生命点数"];
	local mp = WAR.Person[id]["内力点数"];
	local tl = WAR.Person[id]["体力点数"];
	local ed = WAR.Person[id]["中毒点数"];
	local dd = WAR.Person[id]["解毒点数"];
	local ns = WAR.Person[id]["内伤点数"];
  
	local show = {x, y, nil, nil, nil, nil, nil, nil, nil, nil, nil,nil,nil};		--x, y, 解毒, 生命, 内力, 体力, 封穴, 流血, 中毒, 内伤,迟缓,麻痹
	
	if hp ~= nil and hp ~= 0 then		--显示生命
		if hp > 0 then
			show[3] = "生命+"..hp;
		else
			show[3] = "生命"..hp;
		end
	end
	
	if mp ~= nil and mp ~= 0 then		--显示内力
		if mp > 0 then
			show[5] = "内力+"..mp;
		else
			show[5] = "内力"..mp;
		end
	end
	
	if tl ~= nil and tl ~= 0 then		--显示体力
		if tl > 0 then
			show[6] = "体力+"..tl;
		else
			show[6] = "体力"..tl;
		end
	end
	
    if WAR.FXXS[WAR.Person[id]["人物编号"]] ~= nil and WAR.FXXS[WAR.Person[id]["人物编号"]] == 1 then			--显示是否封穴
       	show[7] = "封穴 "..(WAR.FXDS[WAR.Person[id]["人物编号"]] or 0);
       	WAR.FXXS[WAR.Person[id]["人物编号"]] = 0
    end
      
    if WAR.LXXS[WAR.Person[id]["人物编号"]] ~=nil and WAR.LXXS[WAR.Person[id]["人物编号"]] == 1 then		--显示是否被流血
      	show[8] = "流血 "..(WAR.LXZT[WAR.Person[id]["人物编号"]] or 0);
        WAR.LXXS[WAR.Person[id]["人物编号"]] = 0
    end
	
	if ed ~= nil and ed ~= 0 then		--显示中毒
		show[9] = "中毒+"..ed;
	end
	
	if dd ~= nil and dd ~= 0 then		--显示解毒
		show[4] = "中毒-"..dd;
	end
	
	if ns ~= nil and ns ~= 0 then		--显示内伤
		if ns > 0 then
			show[10] = "内伤↑"..ns;
		else
			show[10] = "内伤↓"..-ns;
		end
	end

    if WAR.CHXS[WAR.Person[id]["人物编号"]] ~= nil and WAR.CHXS[WAR.Person[id]["人物编号"]] == 1 then			--显示是否封穴
       	show[11] = "迟缓 "..(WAR.CHZ[WAR.Person[id]["人物编号"]] or 0);
       	WAR.CHXS[WAR.Person[id]["人物编号"]] = 0
    end
      
    if WAR.MBXS[WAR.Person[id]["人物编号"]] ~=nil and WAR.MBXS[WAR.Person[id]["人物编号"]] == 1 then		--显示是否被流血
      	show[12] = "麻痹 "..(WAR.MBZ[WAR.Person[id]["人物编号"]] or 0);
        WAR.MBXS[WAR.Person[id]["人物编号"]] = 0
    end
	
	--记录哪个位置上有点数
	local showValue = {};
	local showNum = 0;
	for i=3, 12 do
		if show[i] ~= nil then
			showNum = showNum + 1;
			showValue[showNum] = i;
		end
	end

	if showNum == 0 then
		return;
	end
	
	local hb = GetS(JY.SubScene, x, y, 4);
  
	local ll = string.len(show[showValue[1]]);	--长度
	
	local w = ll * CC.DefaultFont / 2 + 1
	local clip = {x1 = CC.ScreenW / 2 - w/2 - CC.XScale/2, y1 = CC.YScale + CC.ScreenH / 2 - hb, x2 = CC.XScale + CC.ScreenW / 2 + w, y2 = CC.YScale + CC.ScreenH / 2 + CC.DefaultFont + 1}
	local area = (clip.x2 - clip.x1) * (clip.y2 - clip.y1) + CC.DefaultFont*4		--绘画的范围
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)		--绘画句柄

	for i = 5, 18 do
		if JY.Restart == 1 then
			break
		end
		local tstart = lib.GetTime()
		local y_off = i * 2
		
		lib.SetClip(0, 0, CC.ScreenW, CC.ScreenH)
		lib.LoadSur(surid, 0, 0)
		--显示文字
		if str ~= nil then
			DrawString(clip.x1 - #str*CC.Fontsmall/5 + 30, clip.y1 - y_off - CC.DefaultFont*4, str, C_WHITE, CC.Fontsmall);
		end
		for j=1, showNum do
			local c = showValue[j] - 1;
			if showValue[j] == 3 and (string.sub(show[3],1,1) == "-" or string.sub(show[3],2,2) == "-") then		--减少生命，显示为红色
				c = 1;
			end
			DrawString(clip.x1, clip.y1 - y_off - (showNum-j+1)*CC.DefaultFont, show[showValue[j]], WAR.L_EffectColor[c], CC.DefaultFont); 	
		end 

		ShowScreen(1)
		lib.SetClip(0, 0, 0, 0)		--清除
		local tend = lib.GetTime()
		if tend - tstart < CC.BattleDelay then
			lib.Delay(CC.BattleDelay - (tend - tstart))
		end
	end
  
	lib.SetClip(0, 0, 0, 0)		--清除
	WAR.Person[id]["生命点数"] = nil;
	WAR.Person[id]["内力点数"] = nil;
	WAR.Person[id]["体力点数"] = nil;
	WAR.Person[id]["中毒点数"] = nil;
	WAR.Person[id]["解毒点数"] = nil;
	WAR.Person[id]["内伤点数"] = nil;
  
	lib.FreeSur(surid)
end




--计算医疗量
--id1 医疗id2, 返回id2生命增加点数
function ExecDoctor(id1, id2)
	if JY.Person[id1]["体力"] < 50 then
		return 0
	end
	local add = JY.Person[id1]["医疗能力"]
	local value = JY.Person[id2]["受伤程度"]
	if add + 20 < value then
		return 0
	end
  
	-- 平一指，医疗量和杀人数有关
	if match_ID(id1, 28) and JY.Status == GAME_WMAP then
		add = math.modf(JY.Person[id1]["医疗能力"] * (1 + WAR.PYZ / 10))
	end
 
			  if PersonJL(id1,1) and JY.Status == GAME_WMAP then
			     add = math.modf(JY.Person[id1]["医疗能力"] * (1 + 0.5))
			  end
 
	--战斗状态的医疗
	--胡斐在场程灵素医疗+120
	--王难姑在场胡青牛医疗+50
	if JY.Status == GAME_WMAP then
		for i,v in pairs(CC.AddDoc) do
			if match_ID(id1, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						add = add + v[3]
					end
				end
			end
		end
	end
  
	add = add - (add) * value / 200
	add = math.modf(add) + Rnd(5)
    add = add + MPAttrib(id1, 4)
	
	local n = AddPersonAttrib(id2, "受伤程度", -math.modf((add) / 10))
	--蓝烟清：医疗时显示内伤减少
	if JY.Status == GAME_WMAP then
		local p = -1;
		for wid = 0, WAR.PersonNum - 1 do
			if WAR.Person[wid]["人物编号"] == id2 and WAR.Person[wid]["死亡"] == false then
				p = wid;
				break;
			end
		end
		WAR.Person[p]["内伤点数"] = n;
	end
			  if wglw(id1, 142)>=1 and JY.Status == GAME_WMAP  then
				if WAR.FZ[id2] == nil then
				WAR.FZ[id2] = {nil,nil,nil,nil,nil,nil}
				end
		        WAR.FZ[id2][WAR.XFZ] = (WAR.FZ[id2][WAR.XFZ] or 0) + 1
		        if WAR.FZ[id2][WAR.XFZ]>= 1+wglw(id1, 142)*3 then
		           WAR.FZ[id2][WAR.XFZ] = 1+wglw(id1, 142)*3
		        end
	          end	
			  
			  if PersonJL(id1,2) and JY.Status == GAME_WMAP then
			     add = add + math.modf(((WAR.LXZT[id2] or 0) + (WAR.FXDS[id2] or 0) + (WAR.CHZ[id2] or 0) + (WAR.MBZ[id2] or 0) + JY.Person[id2]["冰封程度"]+JY.Person[id2]["灼烧程度"]+JY.Person[id2]["中毒程度"]+JY.Person[id2]["受伤程度"]) * 0.1)
			     WAR.LXZT[id2] = nil
				 WAR.FXDS[id2] = nil
				 WAR.CHZ[id2] = nil
				 WAR.MBZ[id2] = nil
				 JY.Person[id2]["冰封程度"] = 0
				 JY.Person[id2]["灼烧程度"] = 0
				 JY.Person[id2]["中毒程度"] = 0
				 JY.Person[id2]["受伤程度"] = 0
			  end
			  
			  if PersonJL(id1,4) and JY.Status == GAME_WMAP then
                 WAR.L_HQNZL[id2] = math.modf(add/10)
			  end
			  
		if PersonJL(id1,3) and JY.Status == GAME_WMAP then
		local p = -1;
		  for wid = 0, WAR.PersonNum - 1 do
			if WAR.Person[wid]["人物编号"] == id2 and WAR.Person[wid]["死亡"] == false then
				p = wid;
				break;
			end
		  end
		WAR.Person[p]["护盾"] = (WAR.Person[p]["护盾"] or 0) + math.modf(add/2)
		    if  Curr_JL(id1,3)  then
			WAR.Person[p]["内力点数"] = (WAR.Person[p]["内力点数"] or 0) + AddPersonAttrib(WAR.Person[p]["人物编号"], "内力", add*3)
				    WAR.Person[p].Time = WAR.Person[p].Time + add*2
	                if WAR.Person[p].Time > 999 then
	                   WAR.Person[p].Time = 999
	                end
			end
		end

			  if PersonJL(id1,5) and JY.Status == GAME_WMAP then
                 if JY.Person[id2]["生命"]<= math.modf(JY.Person[id2]["生命"]*0.5)  then
				 add = math.modf(add*1.5)
				 end
			  end
	
	return AddPersonAttrib(id2, "生命", add)
end

--无酒不欢：计算武功伤害，WAR.CurID为攻击方
function War_WugongHurtLife(enemyid, wugong, level, ang, x, y)

	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local eid = WAR.Person[enemyid]["人物编号"]
	--气防
	local dng = 0
	local WGLX = JY.Wugong[wugong]["武功类型"]

	--是否为敌人
	local function DWPD()
		--逆转乾坤状态下默认为敌人
		if WAR.HIDE2[eid] ~= nil then
		    return false
		elseif WAR.HIDE3[eid] ~= nil then
		    return false
		elseif WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.NZQK == 0 and WAR.NZQK1 == 0 then
			return true			
		elseif WAR.WXXY1 ~=0 and WAR.Person[enemyid]["我方"] == WAR.Person[WAR.CurID]["我方"] then
		    return true
		else
			return false
		end
	end
  
	local mywuxue = 0
	local emenywuxue = 0
	for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		
		--武学常识共用....
		if WAR.Person[i]["死亡"] == false and JY.Person[id]["武学常识"] > 10 then
			if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and mywuxue < JY.Person[id]["武学常识"] then
				mywuxue = JY.Person[id]["武学常识"]
			end
			if WAR.Person[enemyid]["我方"] == WAR.Person[i]["我方"] and emenywuxue < JY.Person[id]["武学常识"] then
				emenywuxue = JY.Person[id]["武学常识"]
			end
		end
		
		if emenywuxue < 50 then
			emenywuxue = 50
		end
	end
  
	--计算实际使用武功等级
	while true do
		if JY.Person[pid]["内力"] < math.modf((level + 1) / 2) * JY.Wugong[wugong]["消耗内力点数"] then
			level = level - 1
		else
			break;
		end
	end

	--防止出现左右互博时第一次攻击完毕，第二次攻击没有内力的情况。
	if level <= 0 then
	  level = 1
	end

	
	--无酒不欢：计算内功护体，互为敌方才会触发
	--周伯通空明之武道,归海一刀的霸刀和伏虎罗汉拳使被攻击者不会护体
	--部分状态也让被攻击者无法护体
	if DWPD() and not nohuti(pid)  and not nohuti2(eid) then
		local ht = {};		
		local num = 0;	--当前学了多少个内功
		for i = 1, CC.Kungfunum do
			local kfid = JY.Person[eid]["武功" .. i]
			local kflvl = JY.Person[eid]["武功等级" .. i]
			if kflvl == 999 then
				kflvl = 11
			else
				kflvl = math.modf(kflvl / 100) + 1
			end
			--先把内功都存入表格，吸功不护体,奇门遁甲不护体
			if JY.Wugong[kfid]["武功类型"] == 6 and kfid ~= 85 and kfid ~= 87 and kfid ~= 88 and kfid ~= 181 then
				num = num + 1;
				ht[num] = {kfid,i,get_skill_power(eid, kfid, kflvl)};
			end
		end
				
		--如果学有内功
		if num > 0 then	
			--按照威力从大到小排序，威力一样的话按照面板的先后顺序
			for i = 1, num - 1 do
				for j = i + 1, num do
					if ht[i][3] < ht[j][3] or (ht[i][3] == ht[j][3] and ht[i][2] > ht[j][2])then
						ht[i], ht[j] = ht[j], ht[i]
					end
				end
			end
			--按顺序判定触发
			for i = 1, num do
				if myrandom(10, eid) then
					dng = ht[i][3];
					WAR.Person[enemyid]["特效文字2"] = JY.Wugong[ht[i][1]]["名称"] .. "护体"
					WAR.Person[enemyid]["特效动画"] =  87 + math.random(6)
					WAR.NGHT = ht[i][1];
					break;
				end
			end
		end

	
	
		--运行天赋内功气防+200，有35%几率再+300
		if JY.Person[eid]["主运内功"] > 0 and JY.Person[eid]["主运内功"] == JY.Person[eid]["天赋内功"] then
			dng = dng + 200;
			if JLSD(30, 65, eid) then
				dng = dng + 300;
				if WAR.Person[enemyid]["特效文字3"] ~= nil then
					WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+天赋内功护体"
				else
					WAR.Person[enemyid]["特效文字3"] = "天赋内功护体"
				end
			end
		elseif MP_ZY(eid) then --运行门派内功气防+200，有35%几率再+300
			dng = dng + 200;
			if JLSD(30, 65, eid) then
				dng = dng + 300;
				if WAR.Person[enemyid]["特效文字3"] ~= nil then
					WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+门派内功护体"
				else
					WAR.Person[enemyid]["特效文字3"] = "门派内功护体"
				end
			end
		end
				
		if PersonKF(eid,172) then
		   dng = dng * 2
		   if Curr_NG(eid,172) then
		   local nlDam = math.modf(JY.Person[eid]["内力最大值"]*0.1)
		   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", nlDam)
		   end
		end
	
		if WAR.NGHT >0 and nglw(eid,90)>1 and JY.Person[eid]["体力"]>10 then
		    WAR.HYTZ1=math.random(2,5)
			JY.Person[eid]["体力"]=JY.Person[eid]["体力"]-WAR.HYTZ1
			dng = dng + WAR.HYTZ1*300;
			WAR.Person[enemyid]["特效文字2"] = "混元童子功.万川归海"
			WAR.Person[enemyid]["特效动画"] = 81
		end
	
		--蛤蟆功补偿护体
		if WAR.NGHT == 0 and PersonKF(eid, 95) then
			dng = dng + 900;
			WAR.Person[enemyid]["特效文字2"] = "蛤蟆功补偿护体"
			WAR.Person[enemyid]["特效动画"] = 87 + math.random(6)
			WAR.NGHT = 0.5
		end


	--张无忌 九阳神功护体
	if match_ID(eid, 9) and WAR.NGHT == 0 and PersonKF(eid, 106) then
		WAR.Person[enemyid]["特效动画"] = 87 + math.random(6)
		WAR.Person[enemyid]["特效文字2"] = "九阳神功护体"
		dng = dng + 1200
		WAR.NGHT = 0.5
	end
	
	--NPC内功补完系统
	if  WAR.NGHT == 0 then
	    if JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) or (not inteam(eid)) then
		local htName, htPower = G["NPC内功补完系统"](eid)
		if htName then
			WAR.Person[enemyid]["特效动画"] = 87 + math.random(6)
			WAR.Person[enemyid]["特效文字2"] = htName.."护体"
			dng = dng + htPower
			if not inteam(eid) then--
			dng = dng + htPower
			end
			WAR.NGHT = 0.5
		end
	    end
	end		

		if WAR.YMD[eid] ~= nil and WAR.YMD[eid] > 0 then
			if WAR.NGHT > 0 then WAR.NGHT = 0 end
		end

				if JY.Person[eid]["受伤程度"] >0 then
				   dng = dng - JY.Person[eid]["受伤程度"] * 10
				end

	if WAR.NGHT>0 then
	 if WAR.HOT2[eid]~=nil then
	    WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + 10 ,0,50)
		local nlDam = math.modf(JY.Person[eid]["生命"]*0.1)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -nlDam)
		WAR.Person[enemyid]["特效文字4"] = "火毒攻心"
		WAR.Person[enemyid]["特效动画"] = 111
	 end	
	 if WAR.ICE2[eid]~=nil then
	    WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + 10 ,0,50)
		local nlDam = math.modf(JY.Person[eid]["内力"]*0.15)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -nlDam)
		WAR.Person[enemyid]["特效文字4"] = "寒毒激发"
		WAR.Person[enemyid]["特效动画"] = 116
	 end
	 if WAR.FMZZ[eid]~=nil then	    
		local nlDam = math.modf(JY.Person[eid]["内力"]*0.01)
		WAR.MENG[eid]=nlDam
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", nlDam)
		WAR.Person[enemyid]["特效文字4"] = "业障缠身"
		WAR.Person[enemyid]["特效动画"] = 98
	 end	 
	   if WAR.JHLY3[eid]~=nil and WAR.JHLY3[eid]>0 then
		local nlDam = JY.Person[eid]["灼烧程度"]
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -nlDam)
		WAR.Person[enemyid]["特效文字4"] = "内火焚心"
		WAR.Person[enemyid]["特效动画"] = 105
	   end
	 if WAR.L_HBJD[eid]~=nil then
	    local nlDam = math.modf(JY.Person[pid]["内力"]*0.1)
        WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + nlDam,0,100)
		WAR.Person[enemyid]["特效文字4"] = "红冰激发：血毒"
		WAR.Person[enemyid]["特效动画"] = 75		
	 end
		if  WAR.QBLY[eid]~=nil and WAR.QBLY[eid]>0 then----
		local nlDam = WAR.LXZT[eid] or 0
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -nlDam)
		WAR.Person[enemyid]["特效文字4"] = "千本落英"
		WAR.Person[enemyid]["特效动画"] = 104
	    end
		if  WAR.L_WNGZL3[eid]~=nil and WAR.L_WNGZL3[eid]>0 then----
            if WAR.LXZT[eid] ~=nil then
			WAR.LSQ[eid] = (WAR.LSQ[eid] or 0) +20
		    WAR.Person[enemyid]["特效文字4"] = "凝血.乱"
		    WAR.Person[enemyid]["特效动画"] = 104
		    end
	    end
		if  WAR.QSLZ[eid]~=nil and WAR.QSLZ[eid]>0 then----
		local nlDam = math.modf(JY.Person[eid]["中毒程度"]*1.15)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -nlDam)
		WAR.Person[enemyid]["特效文字4"] = "七死爆毒"
		WAR.Person[enemyid]["特效动画"] = 64
		end
	    if WAR.HDQM[eid]~=nil and WAR.HDQM[eid]>0  then----
		WAR.Person[enemyid]["特效动画"] = 116
		WAR.Person[enemyid]["特效文字4"] = "寒毒侵袭"
		local nlDam = math.modf(JY.Person[eid]["内力"]*0.15)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -nlDam)
		JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] + math.modf(nlDam/20)
		if JY.Person[eid]["冰封程度"]> 50 then
		local aa = JY.Person[eid]["冰封程度"] - 50
		WAR.LRHF[eid] = (WAR.LRHF[eid] or 0) + aa
		JY.Person[eid]["冰封程度"] = 50
		if WAR.LRHF[eid]>= 50 then
		WAR.LRHF[eid] = 50
		end
		end
	   end
	   if WAR.MK_CP[eid]~= nil then----
	   WAR.Person[enemyid]["特效文字4"] = "秘孔.喘破"
		WAR.Person[enemyid]["特效动画"] = 105
	   dng = 0
	   end

	   if WAR.JYWR[eid]~= nil and WAR.JYWR[eid]>=3 then----
	   WAR.Person[enemyid]["特效文字4"] = "阳气污染.过热"
		WAR.Person[enemyid]["特效动画"] = 103
		local bb =  - WAR.JYWR[eid]
	   WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid,"体力", bb)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid,"生命", bb*50)
	   end

	   if WAR.NKZT[eid]~= nil then----
	   WAR.Person[enemyid]["特效文字4"] = "内溃"
		WAR.Person[enemyid]["特效动画"] = 104
	   dng = 0
	   end
	
	   if KUIHUA(eid) == 1 then----
       addeffect2(WAR.YANG,eid,nglw(eid,105))
	   end
	
	   if WAR.MK_JM[eid]~= nil then----
	   WAR.Person[enemyid]["特效文字4"] = "秘孔.健明"
		WAR.Person[enemyid]["特效动画"] = 105
	   dng = math.modf(dng*2)
	   end
	   
	   if wglw(eid,78)>=1 and (WAR.SHAH[eid] or 0) > 500 then
	   dng = dng + math.modf((WAR.SHAH[eid] or 0)/5) 	   
	   end
	   
	end

	
	end
	

	
	--防御状态
	if WAR.Defup[eid] == 1 then
		WAR.Person[enemyid]["特效动画"] = 90
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+防御状态"
		else
			WAR.Person[enemyid]["特效文字1"] = "防御状态"
		end
		if PersonKF(eid, 101) then     --八荒气防+1000
			dng = dng + 1000
		else
			dng = dng + 500
		end
	  if MPPD(eid) == 3 then
		dng = dng + 500
		  if MPPB_SL(eid) == 2 then
		  local aa= JY.Person[eid]["内力"]
		  dng = dng + math.modf(aa/4)
		      if nglw(eid, 108)>=1  then
		      ang=ang-math.modf(aa/4)
			  if ang<0 then
			  ang=0
			  end
	          end	
		  end
		  if MPZJ(eid,3) >=1 then
		  ang = ang - math.modf(JY.Person[eid]["内力"]/5)
		  	  if ang<0 then
			  ang=0
			  end
		  end
	  end
		if eid==0 and JY.Person[49]["论剑奖励"] == 1 then
		   dng = dng + math.modf(JY.Person[eid]["内力"]/5)
		end
	end
	
	
	--六如的林山阴
	if eid==0 and JY.Person[eid]["六如觉醒"] > 0 then
		local rate = limitX(math.modf(20 + (101-JY.Person[eid]["资质"])/10 + JY.Person[eid]["实战"]/50 + JY.Person[eid]["防御力"]/40 + JY.Person[eid]["武学常识"]/10),0,100);
		local low = 25;
		
		--天书数量增加几率
		low = low - JY.Base["天书数量"]

		local rl = 0
		local rs = 0
		local ry = 0
		local tt = 0
		local times = 1
		--仁者二次判定+循环两次，即一次可以触发两种六如特效
		if JY.Base["标准"] == 7 then
			times = 2
		end
		if nglw(eid,102)>1 then
		    times = times + 1
		end
		for i = 1, times do
			if JLSD(low, rate, eid) or (JY.Base["标准"] == 7 and JLSD(low, rate, eid)) or (nglw(eid,102)>1 )then
				local lr = math.random(3)
				if lr == 1 then
					rl = 1
				elseif lr == 2 then
					rs = 1
				elseif lr == 3 then
					ry = 1
				end
				tt = 1
			end
		end
		
		--其徐如林
		if rl == 1 and JY.Base["天书数量"] >= 8 then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "其徐如林")
			if JY.Base["标准"] == 3 then
			Set_Eff_Text(enemyid, "特效文字2", ".迅疾剑意")
			end
			local aa=1
			if JY.Base["标准"] == 3 then
			aa=aa+1
			end
			WAR.FLHS2 = WAR.FLHS2 + math.random(2+aa, 3+aa)
			if WAR.FLHS2 > 20  then
			if JY.Base["标准"] == 3 then
			
			else
			WAR.FLHS2 = 20
			end
			end
		end
		--不动如山
		if rs == 1 and JY.Base["天书数量"] >= 10 then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "不动如山")
			if JY.Base["标准"] == 6 then
			Set_Eff_Text(enemyid, "特效文字2", ".气焰调息") 
			end
			WAR.FLHS4 = 1
		end
		--难知如阴
		if ry == 1 and JY.Person[eid]["六如觉醒"] == 2 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "难知如阴")
			if JY.Base["标准"] == 7 then
			Set_Eff_Text(enemyid, "特效文字2", ".后发制人")  
			end
			WAR.ACT = 10
			--如果是由斗转触发的如阴，则不打断左右
			if WAR.DZXY == 0 then
				WAR.ZYHB = 0
			end
			WAR.FLHS5 = 1
		end
		if nglw(eid,80)>2 and tt == 1 then
		local HDJY = {"打狗心法·引字诀","打狗心法·封字诀"};
		local aa = math.random(1,2)
		local str = "【苍龙真血】"..HDJY[aa]
		      if aa==1 then
			  			  for j = 0, WAR.PersonNum - 1 do
			                   local df = WAR.Person[j]["人物编号"]
			                   local fhurt2 = math.modf(JY.Person[WAR.Person[j]["人物编号"]]["内力"]*0.05)
				               if WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[j]["死亡"] == false then
					              WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - fhurt2
                                  JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] = JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] + math.random(5, 9)
				               end
			              end			  
			  else
			  WAR.BZ[pid]=1
			  end
		Set_Eff_Text(enemyid, "特效文字0", str)
		end
		
	end

	--象之般若
	if nglw(eid,103)>2  then
		local rate = limitX(math.modf(25  + JY.Person[eid]["实战"]/50 + JY.Person[eid]["防御力"]/40 + JY.Person[eid]["武学常识"]/10+JY.Person[eid]["资质"]/10),0,100);
		local low = 25;
		
		--天书数量增加几率
		low = low - JY.Base["天书数量"]

		local rl = 0
		local rs = 0
		local ry = 0
		local tt = 0
		local times = 1+math.modf(JY.Person[eid]["资质"]/50)
		--仁者二次判定+循环两次，即一次可以触发两种六如特效
		for i = 1, times do
			if JLSD(low, rate, eid)  then
				rl = math.random(3)
				if rl == 1 then
					WAR.TGDQ2 = 1
				elseif rl == 2 then
					WAR.TGDQ4 = 1
				elseif rl == 3 then
					WAR.TGDQ6 = 1
				end
			end
		end
		if nglw(eid,184)>1 then
		    addeffect(WAR.LHXT, eid, nglw(eid,184)-1)
		end		
		--其徐如林
		if rl == 1  then
			WAR.Person[enemyid]["特效动画"] = 77
            Set_Eff_Text(enemyid, "特效文字1", "观照般若")
			WAR.BRZH2[eid] =  1			
		--不动如山
		elseif rl == 2  then
			WAR.Person[enemyid]["特效动画"] = 77
            Set_Eff_Text(enemyid, "特效文字1", "实相般若")
			WAR.BRZH2[eid] =  2
		elseif rl == 3  then
			WAR.Person[enemyid]["特效动画"] = 77
            Set_Eff_Text(enemyid, "特效文字1", "眷属般若")
			WAR.BRZH2[eid] =  3
		end		
	end

	--六如的林山阴
	if force_ID(eid) or (eid == 645 and JY.Person[eid]["品德"]>0 and JY.Base["特殊"]>0) then
		local rate = limitX(math.modf(40 + JY.Person[eid]["实战"]/25 + JY.Person[eid]["武学常识"]/10),0,100);
		local low = 20;
		
		--天书数量增加几率
		low = low - JY.Base["天书数量"]

		local r1 = 0
		local r2 = 0
		local r3 = 0
		local r4 = 0
		local times = 1
		--斗神二次判定+循环两次，即一次可以触发两种太古斗气特效
		if eid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0 then
			times = 2
		end
		if nglw(eid,102)>1 then
		    times = times + 1
		end

		for i = 1, times do
			if JLSD(low, rate, eid) or ((eid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0) and (JLSD(low, rate, eid) or WAR.DSTG[eid]~=nil)) or (nglw(eid,102)>1 )then
				local lr = math.random(2)
				if eid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0 then--
				lr = math.random(4)
				end
				if lr == 1 then
					r1 = 1
				elseif lr == 2 then
					r2 = 1
				elseif lr == 3 then
					r3 = 1
				elseif lr == 4 then
					r4 = 1
				end
			end
		end
		
		--其徐如林
		if r1 == 1 and JY.Base["天书数量"] >= 3 then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "太古.后土斗气")
			WAR.TGDQ2 = 1
		end
		--不动如山
		if r2 == 1 and JY.Base["天书数量"] >= 5 then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "太古.共工斗气")
			WAR.TGDQ4 = 1
		end
		if r3 == 1 and JY.Base["天书数量"] >= 4 then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "真武.句芒斗气")
			WAR.TGDQ6 = 1
		end
		--难知如阴
		if r4 == 1 and JY.Person[0]["六如觉醒"] == 1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			WAR.Person[enemyid]["特效动画"] = 177
            Set_Eff_Text(enemyid, "特效文字2", "真武.帝江斗气")
			WAR.ACT = 10
			--如果是由斗转触发的如阴，则不打断左右
			if WAR.DZXY == 0 then
				WAR.ZYHB = 0
			end
			WAR.TGDQ8 = 1
			WAR.DJDQ[eid] = 1
		end
	end
	
	--无酒不欢：NPC的真气效果为2倍
	--乔峰 擒龙功护体
	if match_ID(eid, 50) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 1000
		if not inteam(eid) then
			dng = dng + 1000
		end
		zhanyi(eid, 1)
		local str = "擒龙功护体"
		if match_ID_awakened(eid, 50,1) then
		   str = "擒龙真诀.天锁苍龙"
		   WAR.FXXS[pid] = 1 
	       WAR.FXDS[pid] = (WAR.FXDS[pid] or 0)+20 
		   if JLSD(10,60,eid) then
		   WAR.TSCL[eid] = 1 
		   str = "逆鳞.帝释天威"
		   end
		end
		WAR.Person[enemyid]["特效动画"] = 111
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+"..str
		else
			WAR.Person[enemyid]["特效文字2"] = str
		end
	end
	
	--鸠摩智
	if match_ID(eid, 103) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		WAR.Person[enemyid]["特效动画"] = math.fmod(98, 10) + 85
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+明王真气"
		else
			WAR.Person[enemyid]["特效文字2"] = "明王真气"
		end
	end
	
	--成昆
	if match_ID(eid, 18) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = math.fmod(106, 10) + 85
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+混元霹雳功"
		else
			WAR.Person[enemyid]["特效文字2"] = "混元霹雳功护体"
		end
	end

	--洪七公
    if match_ID(eid, 69) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end	
		if WAR.LHXT[eid]~=nil  then
		WAR.MSTX = WAR.MSTX + (WAR.LHXT[eid]) * 5
		WAR.GTEID = eid
		end		
		addeffect2(WAR.LHXT,eid,1)
		WAR.Person[enemyid]["特效动画"] = 67
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+丐王真气"
		else
			WAR.Person[enemyid]["特效文字2"] = "丐王真气"
		end
    end
 
     if match_ID_awakened(eid, 3, 1) and WAR.NGHT>0 and DWPD() then
		local aa = math.modf((TrueYJ(pid) )/5)
		local str=""
		if JY.Person[3]["论剑奖励"] == 1 then
		aa = math.modf(aa*2.5)
		str=".金佛护身"
		end
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid,"生命",-aa)
		WAR.ZSXS[pid] = 1
		WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0)+AddPersonAttrib(pid,"受伤程度",10)
        WAR.HOT[pid] = (WAR.HOT[pid] or 0) + 10
		if JY.Person[3]["论剑奖励"] == 2 and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		WAR.JSCL[pid] = 30
		str=".天凤幻魔"
		end
		WAR.Person[enemyid]["特效动画"] = 16
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+凤火剑意"..str
		else
			WAR.Person[enemyid]["特效文字2"] = "凤火剑意"..str
		end
    end
 
      if match_ID_awakened(eid, 1, 1) and (WAR.NGHT>0 or JY.Person[1]["论剑奖励"] == 2) and DWPD() then
		local aa = math.modf((JY.Person[eid]["耍刀技巧"] )/5)
		if JY.Person[1]["论剑奖励"] == 2 then
		aa = math.modf(aa*2.5)
		end
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid,"生命",-aa)
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid,"生命",aa)
		AddPersonAttrib(pid,"冰封程度",10)
		WAR.BFXS[pid] = 1
        WAR.ICE[pid] = (WAR.ICE[pid] or 0) + 10		
		WAR.Person[enemyid]["特效动画"] = 16
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+冷月刀意"
		else
			WAR.Person[enemyid]["特效文字2"] = "冷月刀意"
		end
    end
 
       if match_ID_awakened(eid, 72, 1) and WAR.NGHT>0 and DWPD() then
	    local aa = math.modf((JY.Person[eid]["耍刀技巧"] + TrueYJ(eid))/10)
		if JY.Person[72]["论剑奖励"] == 1 then
		aa = math.modf((TrueYJ(eid))/5)
		end
		if JY.Person[72]["论剑奖励"] == 2 then
		aa = math.modf((JY.Person[eid]["耍刀技巧"] )/5)
		end
		if JY.Person[eid]["武器"] == 202 and JY.Person[72]["论剑奖励"]>0 then
		aa = math.modf(aa*2.5)
		end
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid,"生命",-aa)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid,"生命",aa)
		WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0)+AddPersonAttrib(pid,"受伤程度",10)		
		WAR.Person[enemyid]["特效动画"] = 16
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+天龙心诀.刀剑相杀"
		else
			WAR.Person[enemyid]["特效文字2"] = "天龙心诀.刀剑相杀"
		end
    end
 
	--黄药师
    if match_ID(eid, 57) and WAR.NGHT>0 and DWPD() then
	    local str = ""
		local str1 = "奇门奥义"
		local aa = 0
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		if math.random(10)< 7 and WAR.ACT> 1 then
		WAR.JSCL[pid] = 10
		str = ".碧海魔音"
		end
		if math.random(10)< 7 or match_ID_awakened(eid, 57,1) then
		local bb = JY.Person[pid]["内力"]/10000
		local cc = JY.Person[eid]["内力"]/10000
		cc = cc - bb
		if cc>=0 then
		cc = 1-cc
		else
		cc = 1
		end
		WAR.QMZT = cc
		ang = math.modf(ang*cc)
        aa = math.random(1,8)
		local QMDJ = {"开门", "生门", "景门", "伤门","杜门","惊门","休门","死门"}
		str1= "奇门阵图."..QMDJ[aa]
		if aa==1 then
        WAR.LUCK[eid] = (WAR.LUCK[eid] or 0) + 10
		elseif aa==2 then
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*1)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*1)		
		elseif aa==3 then
		WAR.ACT = 10
		WAR.ZYHB = 0
        WAR.FLHS5 = 2
		elseif aa==4 then
		WAR.QBLY[pid] = 30
		WAR.YZSG[pid] = 30
		elseif aa==5 then
		WAR.MZLL[eid] = 10
		elseif aa==6 then
		WAR.MENG[pid] = 30
		WAR.TKJQ[pid] = 1
		elseif aa==7 then
        WAR.L_HQNZL[eid] = 20
		WAR.L_WNGZL[pid] = 20
		else
		WAR.SJSD[pid] = 30
		JY.Person[pid]["灼烧程度"]=math.min(JY.Person[eid]["灼烧程度"]+JY.Person[pid]["灼烧程度"],50)
		JY.Person[pid]["冰封程度"]=math.min(JY.Person[eid]["冰封程度"]+JY.Person[pid]["冰封程度"],50)
		JY.Person[pid]["受伤程度"]=math.min(JY.Person[eid]["受伤程度"]+JY.Person[pid]["受伤程度"],100)
		JY.Person[pid]["中毒程度"]=math.min(JY.Person[eid]["中毒程度"]+JY.Person[pid]["中毒程度"],100)
		local dd= JY.Person[pid]["受伤程度"]+JY.Person[pid]["中毒程度"]+JY.Person[pid]["灼烧程度"]+JY.Person[pid]["冰封程度"]
		AddPersonAttrib(eid,"内力",dd)
		AddPersonAttrib(pid,"生命",math.modf(dd/3))
		JY.Person[eid]["受伤程度"]=0
		JY.Person[eid]["灼烧程度"]=0
		JY.Person[eid]["中毒程度"]=0
		JY.Person[eid]["冰封程度"]=0
		end
		
		end
		WAR.Person[enemyid]["特效动画"] = 95+aa
		aa = 0
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+"..str1..str
		else
			WAR.Person[enemyid]["特效文字2"] = str1..str
		end
    end
	
	if nglw(eid,172)>1 and DWPD() and JLSD(10,40+nglw(eid,172)*5+WAR.ACT*10,eid) then
		WAR.JSCL[pid] = (WAR.JSCL[pid] or 0) + 5
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+".."碧海魔音.夺魂"
		else
			WAR.Person[enemyid]["特效文字2"] = "碧海魔音.夺魂"
		end
	end

    if nglw(eid,181)>1 and DWPD() and JLSD(10,40+nglw(eid,181)*5+WAR.ACT*10,eid) then
	    local aa = 0
		local bb = JY.Person[pid]["内力"]/10000
		local cc = JY.Person[eid]["内力"]/10000
		cc = cc - bb
		if cc>=0 then
		cc = 1-cc
		else
		cc = 1
		end
		WAR.QMZT = cc
		ang = math.modf(ang*cc)
        aa = math.random(1,8)
		local QMDJ = {"开门", "生门", "景门", "伤门","杜门","惊门","休门","死门"}
		local str1= "奇门阵图."..QMDJ[aa]
		if aa==1 then
        WAR.LUCK[eid] = (WAR.LUCK[eid] or 0) + 10
		elseif aa==2 then
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*1)
		JY.Person[eid]["内力"] = math.modf(JY.Person[eid]["内力最大值"]*1)		
		elseif aa==3 then
		WAR.ACT = 10
		WAR.ZYHB = 0
		elseif aa==4 then
		WAR.QBLY[pid] = 30
		WAR.YZSG[pid] = 30
		elseif aa==5 then
		WAR.MZLL[eid] = 10
		elseif aa==6 then
		WAR.MENG[pid] = 30
		WAR.TKJQ[pid] = 1
		elseif aa==7 then
        WAR.L_HQNZL[eid] = 20
		WAR.L_WNGZL[pid] = 20
		else
		WAR.SJSD[pid] = 30
		JY.Person[pid]["灼烧程度"]=math.min(JY.Person[eid]["灼烧程度"]+JY.Person[pid]["灼烧程度"],50)
		JY.Person[pid]["冰封程度"]=math.min(JY.Person[eid]["冰封程度"]+JY.Person[pid]["冰封程度"],50)
		JY.Person[pid]["受伤程度"]=math.min(JY.Person[eid]["受伤程度"]+JY.Person[pid]["受伤程度"],100)
		JY.Person[pid]["中毒程度"]=math.min(JY.Person[eid]["中毒程度"]+JY.Person[pid]["中毒程度"],100)
		local dd= JY.Person[eid]["受伤程度"]+JY.Person[eid]["中毒程度"]+JY.Person[eid]["灼烧程度"]+JY.Person[eid]["冰封程度"]
		AddPersonAttrib(eid,"内力",dd)
		JY.Person[eid]["受伤程度"]=0
		JY.Person[eid]["灼烧程度"]=0
		JY.Person[eid]["中毒程度"]=0
		JY.Person[eid]["冰封程度"]=0
		end
		WAR.Person[enemyid]["特效动画"] = 95+aa
		aa = 0
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+"..str1
		else
			WAR.Person[enemyid]["特效文字2"] = str1
		end
    end
	
	--谢烟客
    if match_ID(eid, 164) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		WAR.Person[enemyid]["特效动画"] = 23
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+摩天居士"
		else
			WAR.Person[enemyid]["特效文字2"] = "摩天居士"
		end
    end
	
	--任我行
	if match_ID(eid, 26) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 6
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+日月·同辉"
		else
			WAR.Person[enemyid]["特效文字2"] = "日月·同辉"
		end
	end
	
	--戚长发
    if match_ID(eid, 594) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 93
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+铁锁横江"
		else
			WAR.Person[enemyid]["特效文字2"] = "铁锁横江"
		end
    end
	
	--慕容博
    if match_ID(eid, 113) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 600
		if not inteam(eid) then
			dng = dng + 600
		end
		WAR.Person[enemyid]["特效动画"] = 93
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+参合真气"
		else
			WAR.Person[enemyid]["特效文字2"] = "参合真气"
		end
    end
	
	--枯荣
    if match_ID(eid, 102) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 800
		if not inteam(eid) then
			dng = dng + 800
		end
		WAR.Person[enemyid]["特效动画"] = 93
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+枯荣真气"
		else
			WAR.Person[enemyid]["特效文字2"] = "枯荣真气"
		end
    end

   if match_ID(eid,4) and match_ID_awakened(eid,4,1) and DWPD() then
    local aa=math.modf((JY.Person[eid]["用毒能力"]+MPAttrib(eid, 5))/100)+1
  	if JLSD(10,40+aa*15,eid) or WAR.NGHT> 0 then
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 5)
	local bb=math.modf(JY.Person[pid]["中毒程度"]*3)+50
	WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -bb)
	WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", math.random(aa*10-5, aa*10+5))
	
	if JY.Person[4]["论剑奖励"] == 1 then
	local cc=math.modf((JY.Person[eid]["医疗能力"])/10)+100
	  for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and WAR.Person[j]["人物编号"]~= pid then
					local tmppid = WAR.Person[j]["人物编号"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] +cc*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + cc*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		end
	 end
	end
	
	if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "千金毒方.暗送无常"
	else
		WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "千金毒方.暗送无常"
	end	
	WAR.Person[enemyid]["特效动画"] = 47
	end
	dng=dng+aa*200
  end
	
  	if (PersonKF(eid,100) and nglw(eid,100)>1 and JLSD(20,80,eid)) and 0 < JY.Person[eid]["生命"] then
      WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", 80*nglw(eid,100));
	  if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .. "+炼虚化神"    --精气流转·炼虚化神
		else
			WAR.Person[enemyid]["特效文字3"] = "精气流转·炼虚化神"
		end
    end	
	
	--何铁手
    if match_ID(eid, 83) and WAR.NGHT>0 then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		WAR.Person[enemyid]["特效动画"] = 92
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+红袖拂风"
		else
			WAR.Person[enemyid]["特效文字2"] = "红袖拂风"
		end
    end
	
	--左冷禅
    if match_ID(eid, 22) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + 500
		if not inteam(eid) then
			dng = dng + 500
		end
		local str=""
		if WAR.NGHT>0 and match_ID_awakened(eid,22,1) then
		str=".玄冰"
        dng = dng + 100*math.modf(JY.Person[pid]["冰封程度"]/5)
		JY.Person[pid]["冰封程度"] = JY.Person[pid]["冰封程度"] + 20
		WAR.ICE[pid] = 10
		if JY.Person[pid]["冰封程度"] > 100 then 
		JY.Person[pid]["冰封程度"] = 100
		WAR.LRHF[pid] = 10
		end
		end
		WAR.Person[enemyid]["特效动画"] = 1
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+寒冰真气"..str
		else
			WAR.Person[enemyid]["特效文字2"] = "寒冰真气"..str
		end
    end
	

	
	--殷天正
    if match_ID(eid, 12) and WAR.NGHT>0 then
        addeffect2(WAR.DR, eid, 2)
		WAR.Person[enemyid]["特效动画"] = 92
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+鹰隼返喙"
		else
			WAR.Person[enemyid]["特效文字2"] = "鹰隼返喙"
		end
    end

	--周伯通斗神
    if D2ZBT(eid)  and ((WAR.KMSH[eid]~=nil and WAR.KMSH[eid]>0) or (JLSD(20,50+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid)) and WAR.NGHT>0 ) then
	    if WAR.KMSH[eid]~=nil and WAR.KMSH[eid]>0  then
        reseteffect2(WAR.KMSH, eid, 1)
		end
		WAR.MJZS[pid]=200+JY.Base["天书数量"]*20
		WAR.MSTX = 34
		WAR.GTEID = eid
		WAR.Person[enemyid]["特效动画"] = 92
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+空明守护"
		else
			WAR.Person[enemyid]["特效文字2"] = "斗神.空明守护"
		end
    end
	
	--阿青
    if match_ID(eid, 604) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		dng = dng + TrueYJ(eid)*10
		if not inteam(eid) then
			dng = dng + TrueYJ(eid)*10
		end
		WAR.Person[enemyid]["特效动画"] = 121
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+九霄仙息"
		else
			WAR.Person[enemyid]["特效文字2"] = "九霄仙息"
		end
    end
	
	--三神功的真气
	if PersonKF(eid, 106) and (JY.Person[eid]["内力性质"] == 1 or (eid == 0 and JY.Base["标准"] == 6 and GetS(112,0,0,0) == 1)) and JLSD(30, 50 + JY.Base["天书数量"]*3+nglw(eid,106)*10,eid) then
		dng = dng + 650
		local nl1 = JY.Person[eid]["内力"]
		local nl2 = JY.Person[pid]["内力"]
		nl1 = math.modf(math.max(nl1 - nl2,0)/500*nglw(eid,106))
		local str3 ="九阳真气"
        local str=""
		local str1 = ""
		local aa = (JY.Person[eid]["生命"]/5*nglw(eid,107))
		if nglw(eid,106)>=1 then

		    if nglw(eid,106)>=3 and Curr_NG(eid,106) then
		      if WAR.JYHT[eid]~=nil and WAR.JYHT[eid]>0 then
				 aa= aa*1.5
			  end
		     end
		str=".内息篇"
		aa=math.modf(aa)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", aa);
		    if JLSD(30-math.modf(nl1/2)-nglw(eid,106)*5, 50 + math.modf(nl1/2)+nglw(eid,106)*10,eid) or (nglw(eid,106)>2) then
		    str3 ="【九阳总纲】"
			local str4 = ""
			local dd = math.random(1,3)
			aa=math.modf(aa/4)+nl1
			local ZS = {"<明月照大江>","<清风拂山岗>","<自有真气足>"}
			str4 = ZS[dd]
			   if dd == 1 then
			      if JY.Person[eid]["生命"]>0 then
			         WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", aa)
			         if nglw(eid,106)>1 and WAR.JYHT[eid]~=nil then
				        str4 = "<至阳.烈日灼大江>"
				        WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +AddPersonAttrib(pid, "内力", -aa*5)
				     end
			      end
			   elseif dd == 2 then
			      WAR.MJZS[pid] = aa *5
			      if nglw(eid,106)>1 and WAR.JYHT[eid]~=nil then
				  str4 = "<少阳.青木相生长>"
				  WAR.L_HQNZL[eid] = math.modf(aa/4)
				  end
			   else
			      dng = dng + nl1*10
				  WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +AddPersonAttrib(pid, "生命", -aa)
			      if nglw(eid,106)>1  then
				  str4 = "<纯阳.罡阳回气生>"
				  WAR.JYHT[eid] = (WAR.JYHT[eid] or 0) + math.modf(aa/10)
				  end								
			   end			
			str3 =str3..str4
		    end
		end		
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] =  87 + math.random(6)
		end
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+"..str3..str
		else
			WAR.Person[enemyid]["特效文字1"] = str3..str
		end
	end
	
	if PersonKF(eid, 107) and (JY.Person[eid]["内力性质"] == 0 or (eid == 0 and JY.Base["标准"] == 6 and GetS(112,0,0,0) == 0)) and JLSD(30, 50 + JY.Base["天书数量"]*3+nglw(eid,107)*10,eid) then
		dng = dng + 650
		local str=""
		if nglw(eid,107)>=1 then
		local aa = (JY.Person[eid]["内力"]/50*nglw(eid,107))
		if nglw(eid,107)>=3 and Curr_NG(eid,107) then
		      if WAR.JYZQ[eid]~=nil and WAR.JYZQ[eid]>0 then
			     WAR.JYZQ[eid] = WAR.JYZQ[eid] - 1
				 aa= aa*1.5
			  end
		   end
		str=".疗伤篇"
		aa=math.modf(aa)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", aa);
		end		
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] =  87 + math.random(6)
		end
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+九阴真气"..str
		else
			WAR.Person[enemyid]["特效文字1"] = "九阴真气"..str
		end
	end

	if JLSD(30, 50 + JY.Base["天书数量"]*3+nglw(eid,104)*10,eid) and nglw(eid,104)>=1 and WAR.NGHT == 104 then
		dng = dng + 650
		local aa = (JY.Person[eid]["生命"]*10*nglw(eid,104))
		if nglw(eid,104)>=3 then
		      if WAR.NYZQ[eid]~=nil and WAR.NYZQ[eid]>0 then
			     WAR.NYZQ[eid] = WAR.NYZQ[eid] - 1
				 aa= aa*1.5
			  end
		   end
		aa=math.modf(aa)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", aa);	
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] =  58
		end
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+逆运调息篇"
		else
			WAR.Person[enemyid]["特效文字1"] = "逆运调息篇"
		end
	end

	if JLSD(30, 50 + JY.Base["天书数量"]*3+nglw(eid,104)*10,eid) and nglw(eid,104)>=2 and WAR.NGHT == 104 then
		WAR.YHLP = 1
		WAR.PZPID = pid
	    WAR.NYZQ[eid] = (WAR.NYZQ[eid] or 0) + 1
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] =  58
		end
		if WAR.Person[enemyid]["特效文字0"] ~= nil then
			WAR.Person[enemyid]["特效文字0"] = WAR.Person[enemyid]["特效文字1"].."+逆运移魂"
		else
			WAR.Person[enemyid]["特效文字0"] = "逆运移魂"
		end
	end

  if nglw(eid,104)>1 and WAR.NGHT == 104 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
	local d = math.modf((JY.Person[eid]["内力"] - JY.Person[pid]["内力"]) / 100)
	local str=""
    if d < 10 then
      d = 10
    end
	local n=math.random(1,2)
    if n==1 then
	WAR.LSQ[pid] = limitX((WAR.LSQ[eid] or 0) + d, 0, 100)
    str=".夺魄"
	elseif n== 2then 
	WAR.LHFM[pid]=	limitX((WAR.LHFM[eid] or 0) + d, 0, 100)
	str=".惊魄"
	else
	WAR.SKWJ[pid] = d
	str = ".魔境狂乱"
	end
	if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "【逆运魔音】"..str
	else
		WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "【逆运摄心术】"..str
	end	
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 32
		end
  end

    if eid== 0 and zylw(6)>=1 then
		    local zzr=0
		    for i = 1, CC.Kungfunum do
			    if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 6 then
				zzr = zzr + 1
			    end
		    end
			dng = dng + 100*zzr
		    WAR.MSTX = 0.05 * (zzr)
		    WAR.GTEID = eid
	   end


      if pid== 0 and zylw(6)>=1 and yongnei(wugong) then
		    local zzr=0
		    for i = 1, CC.Kungfunum do
			    if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 6 then
				zzr = zzr + 1
			    end
		    end
			ang = ang + 100*zzr
		    WAR.MSTX2 = 0.05 * (zzr)
		    WAR.GTEID = eid
	   end
	
	if PersonKF(eid, 108) and (JLSD(30, 50 + JY.Base["天书数量"]*3 + MPZJ(eid,3) * 10,eid) or WAR.NGHT == 108) then
		dng = dng + 650
		local str="易筋真气"
		if MPPB_SL(eid) == 2 and MPZJ(eid,3)>=1 then
		str = "易筋真气.六根清净"
		WAR.LGQJ = 1
		   if MPZJ(eid,3)>2 then
		   str = "九阳易筋真气.六根清净"
		   WAR.ACT = 10
		   for j = 0, WAR.PersonNum - 1 do
		       if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and WAR.Person[j]["人物编号"]~= pid and RealJL(enemyid, j, 3) then
					local tmppid = WAR.Person[j]["人物编号"]
					WAR.L_HQNZL[tmppid] = (WAR.L_HQNZL[tmppid] or 0) + 10
		       end
	        end
		   end
		end
		
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] =  87 + math.random(6)
		end
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+"..str
		else
			WAR.Person[enemyid]["特效文字1"] = str
		end
	end
	
	--北冥真气，无崖子必发动，学有北冥/虚竹觉醒后几率发动
	if (PersonKF(eid, 85) or match_ID_awakened(eid, 49, 1)) and (JLSD(30, 75, eid) or match_ID(eid, 116)) then
		dng = dng + 800
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 85
		end
		if WAR.Person[enemyid]["特效文字2"] == nil then
			WAR.Person[enemyid]["特效文字2"] = "北冥真气"
		else
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "北冥真气"
		end
		WAR.B_BMJQ = 1;
	end
	
	if match_ID_awakened(eid,153,1) and JLSD(10, 50, eid) and DWPD() then --唐门反击 and anqinum() > 0 武骧金星：取消暗器数量判断
	WAR.ZBS[eid] = {eid, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
  end
	
	if wglw(eid,67)>2 and JY.Person[eid]["武器"] == 48 and JLSD(10, 60, eid) and DWPD() then --唐门反击 and anqinum() > 0 武骧金星：取消暗器数量判断
	WAR.YFZ[eid] = {eid, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
  end
	
	--斗转星移
	--50%几率发动，慕容复几率提高，慕容博必发动
    if (PersonKF(eid, 43) and JY.Person[eid]["体力"] > 10  and WAR.Person[enemyid]["反击武功"] == -1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and (JLSD(30, math.max(80,JY.Person[eid]["资质"]), eid) or (match_ID(eid, 51) and JLSD(20, 80, eid)) or match_ID(eid, 113) or WAR.TJXY[eid] ~= 1) ) and WAR.DZXY ~= 1 then
		local dzlv = Xishu_sum(eid)
		local dzwz = nil
		local dzfj = nil
		local dzfj2 = nil
		
		
		if wglw(eid,43)>=1 then
			   WAR.MSTX = WAR.MSTX+10*math.random(5,5+wglw(eid,43))
			   WAR.GTEID = eid
		end
		
        if match_ID_awakened(eid,51,1) then		
			  WAR.MSTX = WAR.MSTX+20
			  WAR.GTEID = eid
			  WAR.DZXY3P[eid] = math.random(1,5)
			  local wjdz = {"趣果无间","受苦无间","时无间","命无间","身形无间"}
			  dzfj2 = "无间斗转."..wjdz[WAR.DZXY3P[eid]]
			  WAR.ACT = 10
		end
		
		--兵器值之和大于等于360出离合参商
		--慕容复，慕容博，天罡必出
		if dzlv >= 360 or (match_ID(eid, 51) or match_ID(eid, 113) or (pid == 0 and JY.Base["标准"] == 6)) then
			local hm = 0
			--兵器值之和超过480，有几率出幻梦星辰反击
			--几率为兵器值之和-480
			if dzlv > 480 then
				if JLSD(0, dzlv-480, eid) then
					hm = 1
				end
			end
						--慕容复指令必出幻梦
			if WAR.TZ_MRF == 1 then
				hm = 1
			end
						
			if hm == 1 then
				dzwz = "幻梦星辰"
				WAR.DZXYLV[eid] = 4
			else
				dzwz = "离合参商"
				WAR.DZXYLV[eid] = 3
			end
		--兵器值之和大于等于240出斗转星移
		elseif dzlv >= 240 then
			dzwz = "斗转星移"
			WAR.DZXYLV[eid] = 2
		--都不满足，则是北斗移辰
		else
			dzwz = "北斗移辰"
			WAR.DZXYLV[eid] = 1
		end
		
		if wglw(eid,43)>1 then --东方未明乾坤斗转
		 if yongquan(wugong) then
		 WAR.DFWM3P=1
		 dzfj=".真拳荡江湖"
		 end
		if yongjian(wugong) then
        WAR.DFWM3P=2
        dzfj=".傲剑镇山河"	
        WAR.DZXYLV[eid] = 4		
        end
	  if yongdao(wugong) then
        WAR.DFWM3P=3
        dzfj=".狂刀破苍穹"			
        end
	  if yongte(wugong) then
		WAR.DFWM3P=4
        dzfj=".天机动乾坤"			
        end
	  if yongzhi(wugong) then
		WAR.DFWM3P=5
        dzfj=".灵犀变星辰"			
        end
	  if yongnei(wugong) then
		WAR.DFWM3P=6
        dzfj=".罡气乱天下"			
        end
		WAR.DZXYSX[eid] = JY.Person[pid]["内力性质"]
	 end
		
		if dzfj ~= nil then
		dzwz=dzwz..dzfj
		end
		if dzfj2 ~= nil then
		dzwz=dzfj2..dzwz
		end
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. dzwz
		else
			WAR.Person[enemyid]["特效文字2"] = dzwz
		end
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 93
		end
		WAR.Person[enemyid]["反击武功"] = wugong

    end
  
  	--反击
    if (JY.Person[eid]["体力"] > 10  and WAR.Person[enemyid]["反击武功"] == -1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and Fanji(eid)) and WAR.DZXY ~= 1 then
		local dzlv = Xishu_sum(eid)
		local dzwz = nil
        local txdh = 93	
		if match_ID(eid, 517) then----
		dzwz = "秘剑.燕返"
		WAR.DZXYLV[eid] = 4
		WAR.Person[enemyid]["反击武功"] = 151
		  if match_ID_awakened(eid, 517,1) then
		  local bb = 3
		    if JY.Person[517]["论剑奖励"] == 2 then
			bb = 6
			end
		  local aa = math.random(1,bb)
		  local fj = {"秘剑.麒麟落","秘剑.凤返","秘剑.白龙","秘剑.蜉蝣笼罩","秘剑.毗沙门","秘剑.星花火"}
		  WAR.MJYF[eid] =  aa
		  dzwz = fj[WAR.MJYF[eid]]
		  end
		end
		if wglw(eid,74)>=1 and WAR.SHJG[eid] ~=nil and WAR.SHJG[eid] == 2 then
		dzwz = "咏春鹤形.反击"
		WAR.DZXYLV[eid] = 3
		WAR.Person[enemyid]["反击武功"] = 74
		txdh = 74
		end
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. dzwz
		else
			WAR.Person[enemyid]["特效文字2"] = dzwz
		end
		if WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = txdh
		end

    end
  
  
	--无酒不欢：伤害公式从这里开始，计算受到的伤害
	local hurt = nil
		
	--几率抽签函数：X值大于1时，随机返回X值的50%~100%
	local function myrnd(x)
		if x <= 1 then
			return 0
		end
		return math.random(x * 0.5, x)
	end
	
	--获取武功的真实威力
	local true_WL = get_skill_power(pid, wugong, level)
		
	--当守方为玩家时，基础伤害一 = 30 + (攻方攻击 + 攻方内力/50)/1.5 + 武功威力/2.5
	if inteam(eid) then
		hurt =  30 + (JY.Person[pid]["攻击力"] + getnl(pid)/100)/3 + true_WL/5
	--当守方为NPC时，基础伤害一 = (攻方攻击 + 攻方内力/50 + 武功威力)/3
	else
		hurt = (JY.Person[pid]["攻击力"] + getnl(pid)/100 + true_WL)/8
	end
	  	    
	--无酒不欢：攻方基础攻击
	local atk = JY.Person[pid]["攻击力"]
	--无酒不欢：守方基础防御
	local def = JY.Person[eid]["防御力"]
  
    if WAR.FZ[eid] ~=nil and WAR.FZ[eid][1] ~=nil then
	local aa= WAR.FZ[eid][1]
	def = def +50 * aa + math.max(0,aa-5)*50
	end
 
     if WAR.FZ[pid]~=nil and WAR.FZ[pid][2] ~=nil then
	local aa= WAR.FZ[pid][2]
	atk = atk +50 * aa + math.max(0,aa-5)*50
	    if aa>3 then
		def = math.modf(def*0.5)	
		end
	end
 
      if WAR.FZ2[pid]~=nil and WAR.FZ2[pid][3] ~=nil then
	local aa= WAR.FZ2[pid][3]
	atk = atk -50 * aa + math.max(0,aa-5)*50
	    if aa>3 then
		atk = math.modf(atk*0.5)	
		end
	end
 
	if WAR.ATKDOWN[pid]~=nil then
	atk=math.modf(atk*0.5)
	end

	if WAR.ATKUP[pid]~=nil then
	atk=math.modf(atk*2)
	end

  if wglw(pid, 49)>=1 and WAR.LMZS == 1  then
    atk=math.modf(atk*(1+0.5*wglw(pid,49)))
	if wglw(pid,49)>2  then
	atk = atk +200
	end
  end

  if wglw(pid, 49)>=1 and WAR.LMZS == 4  then
    def=math.modf(def*(1-0.25*wglw(pid,49)))
	if wglw(pid,49)>2  then
	def = def -50
	   if def<0 then
	   def = 1
	   end
	end
  end

  if WAR.DGPZ1[pid]~= nil and wugong == 47 then
     if WAR.DGPZ1[pid] == 1 then
	    def=math.modf(def*0.75)
	 end
     if WAR.DGPZ1[pid] == 4 then
	    def=math.modf(def*0.75)
	 end
  end

	if WAR.DEFDOWN[eid]~=nil then
	def=math.modf(def*0.5)
	end

	if WAR.DEFUP[eid]~=nil then
	def=math.modf(def*2)
	end

    if WAR.XLZS == 1 then
	def=math.modf(def*0.5)
	   if WAR.XLZS_QH == 1 then
	   def=math.modf(def*0.5)
	   end
	end

	if WAR.QSLX_SY == 1 and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 3 then
	    def=math.modf(def*0.5) 
	end

    if WAR.XLZS == 4 then
	atk=math.modf(atk*2)
	   if WAR.XLZS_QH == 4 then
	   atk=math.modf(atk*2)
	   end
	end

	if WAR.MZQL[pid]~=nil and WAR.MZQL[pid] == 1 then ----密宗脉轮
    atk = atk + JY.Person[pid]["防御力"]	    		
	end
	
    if WAR.WDZ == 62 and wglw(pid,61)>2 then
	   atk = atk + JY.Person[eid]["灼烧程度"]+sixi(pid,4)
	   def = def - JY.Person[eid]["灼烧程度"]-sixi(pid,4)
	end
	
	if JY.Status == GAME_WMAP then
		--队友攻击力加成
		for i,v in pairs(CC.AddAtk) do
			if match_ID(pid, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						atk = atk + v[3]
					end
				end
			end
		end
		--队友防御力加成
		for i,v in pairs(CC.AddDef) do
			if match_ID(eid, v[1]) then
				for wid = 0, WAR.PersonNum - 1 do
					if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
						def = def + v[3]
					end
				end
			end
		end
	end

	atk = atk + MPAttrib(pid, 1)
	def = def + MPAttrib(eid, 2)
	
	--基础伤害一 = 基础伤害一 + (攻方武常 - 守方武常)/2
	hurt = hurt + (mywuxue - emenywuxue) / 2
	
	--攻方的内力/50加成到攻方基础攻击
	atk = atk + getnl(pid) / 50	
	  
	--攻方的气攻/20，加成到攻方基础攻击
	--攻方的武常，加成到攻方基础攻击
	atk = atk + mywuxue + ang / 20
	--日纹掌加成伤害
	if WAR.RWZ==61 then
		atk = atk + JY.Person[eid]["灼烧程度"]
	end

    if wglw(pid,80)>0 then
       atk = atk +sixi(pid,5)
    end

    if WAR.LH_DZ >=1 then
       atk = atk +sixi(pid,4) + math.modf((WAR.LQZ[eid] or 0) * 1.5)
    end

	if wugong == 68 and wglw(pid,68)>=1 then
	local aa = 	math.abs(WAR.Person[WAR.CurID].Time - WAR.Person[enemyid].Time)	
         if WAR.YJQS[pid]~= nil and WAR.YJZS ==1  then
            if WAR.YJQS[pid] == 2 then
			   atk = atk + aa * wglw(pid,68)
			    if wglw(pid,68)>=2 then
			    def= def - aa * wglw(pid,68)
			    end
			end
         end		 
	end
	
	if 	KUIHUA(pid)== 0 and nglw(pid,105)>1 then--
	    atk = atk * 1.5
	end

	if WAR.Actup[pid] ~=nil then
		if MPPB_SL(pid) ==  1 then
		   atk = atk * 1.25;
		end
	end		
	
	if 	KUIHUA(eid)== 0 and nglw(eid,105)>2 then--
	   local aa = JY.Person[pid]["攻击力"]
	   local bb = JY.Person[eid]["攻击力"]
	   if bb> aa then
	      bb = bb -aa
	    atk = atk - bb
		if  atk<= 0 then
		  atk = 0
		end
	   end
	end
	
	if wglw(eid,74)>1 and WAR.SHJG[eid] ~= nil and WAR.SHJG[eid] == 4  then
       atk = math.modf(atk * 0.6)
	   if wglw(eid,74)>2 then
	    atk = math.modf(atk * 0.6)
	   end
	end


	
	--守方的内力/40，加成到守方基础防御
	--守方的武常，加成到守方基础防御
	def = def + getnl(eid) / 40 + emenywuxue

  --战意的攻防加成
  atk = atk * (0.6+WAR.SPIRIT[pid] / 250)
  def = def * (0.6+WAR.SPIRIT[eid] / 250)
  
 	if Curr_NG(pid,184) then
	  atk = atk + math.modf(0.1*WAR.SPIRIT[pid])
	   if nglw(pid,164)>=1 then
	   atk = atk + math.modf(0.2*WAR.SPIRIT[pid])
	   end
	end 
 	if Curr_NG(eid,184) then
      def = def +math.modf(0.1*WAR.SPIRIT[eid])
	   if nglw(eid,164)>=1 then
	   def = def + math.modf(0.2*WAR.SPIRIT[eid])
	   end
	end 	
	--天魔功无视敌方40%防御
	if Curr_NG(pid, 160) then
		def = math.modf(def * 0.6)
		if  nglw(pid,160)>=1 then
		   if WAR.SPIRIT[eid]~=nil  and WAR.SPIRIT[eid]<100  then
		      def = math.modf(def * 0.8)
		   end
		end
	end

		if  nglw(pid,160)>=1 then
            atk = math.modf(atk *1.5)
		end
		
		if  nglw(eid,160)>=1 then
            def = math.modf(def *1.5)
		end		

	if Curr_NG(eid, 160) then
		if  nglw(eid,160)>=1 then
		   if WAR.SPIRIT[pid]~=nil  and WAR.SPIRIT[pid]<100  then
		      atk = math.modf(atk * 0.5)
		   end
		end
	end

	if 	KUIHUA(eid) == 1 and nglw(eid,105)>1 then--
	    def = def * 2
	end	

	if WAR.Defup[eid] == 1 then
		if MPPB_SL(eid) ==  3 then
		   def = def * 2;
		end
	end	

if WAR.WXZQ[eid]~=nil and WAR.WXZQ[eid] == 5 then
    def = def *2
end

if WAR.WXZQ[pid]~=nil and WAR.WXZQ[pid] == 1 then
    atk = atk *2
end

	   if WAR.DZDJ1 == 1 then----
	      def = def-(WAR.MBZ[eid] or 0)
		  if def<=0 then
		     def = 0
		  end
	   end
	
	if 	KUIHUA(pid)== 1 and nglw(pid,105)>2 then--
	   local aa = JY.Person[eid]["防御力"]
	   local bb = JY.Person[pid]["防御力"]
	   if bb> aa then
	      bb = bb -aa
	    def = def - bb
		if  def<= 0 then
		  def = 0
		end
	   end
	end

	if 	nglw(pid,103)>1 then--
	   local bb = JY.Person[pid]["防御力"]
        atk = atk + math.modf(0.2*bb)
	end

	if 	nglw(eid,103)>1 then--
	   local bb = JY.Person[pid]["攻击力"]
        def = def + math.modf(0.2*bb)
	end
	
	if WAR.JGHJ==90 then
		def = math.modf(def * 0.85)
	end

	if WAR.KUIHUAHJ == 1 then
		def = math.modf(def * 0.85)
	end
	
	if WAR.KMZWD>1 then--
	   def = 0
	end
	
	if WAR.LQAY == 3 then
	   def = 0
	end
	
	if WAR.BDQS == 1 then----
	   atk = atk*2
	   def = 0
	end

	if WAR.JGHJ == 105 then
	   atk = math.modf(atk * 1.25)
	end

	if WAR.JGHJ == 15 then
	   atk = math.modf(atk * (1+(WAR.BDKY[pid] or 0)*0.125))
	end
	
	if WAR.LXZQ==1 and pid == 0 and zylw(1)>2 then--
	   def = math.modf(def*0.8)
	end
	
	
	--午刀减少防御	
	if WAR.WDZ==62 then
		def = def-JY.Person[eid]["灼烧程度"]
		if def<=0 then
		def = 0
		end
	end
	
	if WAR.MK_SH[eid]~= nil then----
	def = math.modf(def * 1.2)
	end

	if WAR.MK_SH[pid]~= nil then----
	atk = math.modf(atk * 1.2)
	end
	
	if WAR.PJFY[eid]~= nil  then
	   def = 0
	end

	if WAR.PBFY[pid]~= nil  then
	   atk = math.modf(atk * 0.5)
	end

	if WAR.JGDQ[eid]~= nil  then
	   def = def*2
	end

	if WAR.JGHJ == 102 then
		def = math.modf(def * 0.75)
	end

    if wglw(eid,53)>=1 then
		def = def*2
	end		

    if wglw(pid,43)>1 and yongquan(wugong) and WAR.DZXY == 1 then
		def = math.modf(def * 0.75)
		if wglw(pid,43)>2 then
		WAR.PJFY[eid] = (WAR.PJFY[eid] or 0) + 15
		end
	end		
	
	if match_ID_awakened(pid,1,1) and WAR.HFYD == 1 and WAR.HFYD2>0 then
		def = def-math.modf(WAR.HFYD2/10)
		if def<0 then
		def=0
		end
		WAR.HFYD2 = 0
	end 

	if nglw(eid,102)>2 and JLSD(10,40,eid) and PersonKF(eid,102)then
       atk = 0
	end 	

	if WAR.KBGJ[pid]~= nil  then
	   def = 0
	   if atk<=1 then
	   def = 1
	   end
	end

	if WAR.KBGJ2[eid]~= nil  then
	   atk = 0
	end	

	if WAR.KBGJ3[pid]~= nil  then
	   atk = 0
	end	


	if WAR.KBGJ2[pid]~= nil  then
	   if MPPB_SL(pid) == 3 and MPZJ(pid,3)>=2 and yongquan(wugong) then
	   def = math.modf(def*0.5)
	   end
	end	
	
	if nglw(pid,102)>2 and JLSD(10,40,pid) and PersonKF(pid,102) then
       	   def = 0
	   if atk<=1 then
	   def = 1
	   end
	end 
	
	if WAR.DFWM2 == 1 then--
	   def = math.modf(def*0.75)
	end--12
	
	if  WAR.DFWM2P == 1 then
	   atk = math.modf(atk*1.25)
	end--12
	
	if WAR.FMY==1 then
			   def = 0
	   if atk<=1 then
	   def = 1
	   end
	end 

    if WAR.XHDZ[eid]~=nil then
	    local tt = WAR.XHDZ[eid] or 0
		if tt>10 then
		tt = 10
		end
		def = def - math.modf(def*0.1*tt)
	end

	if WAR.WDLH1 == 1  then
	atk = math.modf(atk*1.25)
	end
	
	if WAR.WDLH == 1  then
	def = math.modf(def*0.85)
	end

	if WAR.WYSQ == 1  then
	def = math.modf(def*0.75)
	end
	
	if WAR.YCHX == 2 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 2 then
	def = math.modf(def*0.75)
	end

	if WAR.YCHX == 1 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 2 then
	   if wglw(pid,74)>1 then
	   def = 0
	   end
	end

   if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 3 and WAR.NGJL>0 then
      def = math.modf(def*JY.Person[eid]["内力"]/JY.Person[eid]["内力最大值"])
   end

  if WAR.JYBG == 1 and wglw(pid,11)>= 1 then
     atk = math.modf(atk*1.25)
  end

  if  wglw(pid,83)>= 1 then
     atk = math.modf(atk*(1+0.25*wglw(pid,83)))
  end

  if WAR.JYBG == 2 and wglw(pid,11)>= 1 then
     def = math.modf(def*0.75)
  end

if WAR.PJTX == 2 then
def = math.modf(def*0.75)
end

    if JY.Person[eid]["武器"] == 36 and wglw(eid,45)>1 then
    def = def + JY.Thing[36]["装备等级"] * 100
    end
	
	if WAR.BLC==5   then
		def = def - (WAR.BG[pid] or 0)
	end	
	
	if atk>999 then
	atk=999
	end
	
	if def>999 then
	def=999
	end

    if atk<=1 then
	atk = 1
	end

	if def<=1 then
	def=1
	end	
	
		--伤害一 = 基础伤害一 * 攻方基础攻击/(攻方基础攻击 + 守方基础防御)
	hurt = (hurt) * (atk) / (math.max((atk + def),1))
  
	--伤害一 = 伤害一 - 守方基础防御/5
	hurt = hurt - (def) / 5
	
	--伤害一 = 伤害一 + (攻方体力 - 守方体力)/5 - (攻方内伤 - 守方内伤)/3 - (攻方中毒 - 守方中毒)/2
	hurt = hurt - (dng) / 30 + JY.Person[pid]["体力"] / 5 - JY.Person[eid]["体力"] / 5 + JY.Person[eid]["受伤程度"] / 3 - JY.Person[pid]["受伤程度"] / 3 + JY.Person[eid]["中毒程度"] / 2 - JY.Person[pid]["中毒程度"] / 2

	if WAR.YZSG[eid]~=nil and DWPD()then
	hurt =hurt + JY.Person[eid]["中毒程度"] / 2 
	   if WAR.YZSY[eid]~=nil then
	   hurt =hurt + JY.Person[eid]["中毒程度"] / 2 
	   end
	end
	
	if WAR.YZSG[pid]~=nil and DWPD() then
	hurt = hurt- JY.Person[pid]["中毒程度"] / 2
	   if WAR.YZSY[pid]~=nil  then
	hurt = hurt- JY.Person[pid]["中毒程度"] / 2 
	   end
	end
	
	--毒王的中毒补偿
	--每5点中毒程度增伤1%
	if pid == 0 and JY.Base["标准"] == 9 and DWPD() then
		hurt = hurt + JY.Person[pid]["中毒程度"] / 2
		hurt = math.modf(hurt * (1 + JY.Person[pid]["中毒程度"]/500))
	end
	
	if MPPD(pid) == 7 and DWPD() then
	local mpdj=MPDJ(pid)
	   hurt = hurt + JY.Person[pid]["中毒程度"] + JY.Person[eid]["中毒程度"]
	end

	if MPPD(eid) == 7 and DWPD() then
	local mpdj=MPDJ(pid)
	   hurt = hurt - JY.Person[pid]["中毒程度"] - JY.Person[eid]["中毒程度"]
	   if  hurt<0 then
	   hurt = 0
	   end
	end
	
	--每5点中毒程度减伤1%
	if eid == 0 and JY.Base["标准"] == 9 then
		hurt = hurt - JY.Person[eid]["中毒程度"] / 2
		hurt = math.modf(hurt * (1 - JY.Person[eid]["中毒程度"]/500))
	end
	
	--伤害一 = 伤害一 + 装备攻击 * 装备加成系数
	--NPC的装备不带等级

	if inteam(pid) then
		if JY.Person[pid]["武器"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["武器"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["武器"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["武器"]]["装备等级"]-1)*2
		end
		if JY.Person[pid]["防具"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["防具"]]["装备等级"]-1)*2
				if MPPD(pid) == 1 then--
		        hurt = hurt + JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["防具"]]["装备等级"]-1)*2
		        end
		end
		if JY.Person[pid]["饰品"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["饰品"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["饰品"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["饰品"]]["装备等级"]-1)*2
		end	
		if JY.Person[pid]["坐骑"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["坐骑"]]["加攻击力"]*10+JY.Thing[JY.Person[pid]["坐骑"]]["加攻击力"]*(JY.Thing[JY.Person[pid]["坐骑"]]["装备等级"]-1)*2
		end	
	else
		if JY.Person[pid]["武器"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["武器"]]["加攻击力"]*10
		end
		if JY.Person[pid]["防具"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*10
				if MPPD(pid) == 1 then--
		        hurt = hurt + JY.Thing[JY.Person[pid]["防具"]]["加攻击力"]*10
		        end
		end
		if JY.Person[pid]["饰品"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["饰品"]]["加攻击力"]*10
		end	
		if JY.Person[pid]["坐骑"] >= 0 then
			hurt = hurt + JY.Thing[JY.Person[pid]["坐骑"]]["加攻击力"]*10
		end	
	end
	
	if inteam(eid) then
		if JY.Person[eid]["武器"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["武器"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["武器"]]["加防御力"]*(JY.Thing[JY.Person[eid]["武器"]]["装备等级"]-1)*2
		end
		if JY.Person[eid]["防具"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*(JY.Thing[JY.Person[eid]["防具"]]["装备等级"]-1)*2
				if MPPD(eid) == 1 then--
		        hurt = hurt - JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*(JY.Thing[JY.Person[eid]["防具"]]["装备等级"]-1)*2
		        end
		end
		if JY.Person[eid]["饰品"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["饰品"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["饰品"]]["加防御力"]*(JY.Thing[JY.Person[eid]["饰品"]]["装备等级"]-1)*2
		end	
		if JY.Person[eid]["坐骑"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["坐骑"]]["加防御力"]*10+JY.Thing[JY.Person[eid]["坐骑"]]["加防御力"]*(JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"]-1)*2
		end	
	else
		if JY.Person[eid]["武器"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["武器"]]["加防御力"]*10
		end
		if JY.Person[eid]["防具"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*10
				if MPPD(eid) == 1 then--
		        hurt = hurt - JY.Thing[JY.Person[eid]["防具"]]["加防御力"]*10
		        end
		end
		if JY.Person[eid]["饰品"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["饰品"]]["加防御力"]*10
		end	
		if JY.Person[eid]["坐骑"] >= 0 then
			hurt = hurt - JY.Thing[JY.Person[eid]["坐骑"]]["加防御力"]*10
		end
	end

WAR.YSSH = hurt

    if WAR.MK_XR[eid]~=nil and DWPD() then----
       local aa=(WAR.MKDS[eid] or 0) + 1
	   hurt = hurt+aa*50
	end	
	
	--欧阳锋根据蛤蟆蓄力增加伤害
	if match_ID(pid, 60) and WAR.OYFXL > 0 and DWPD() then
		hurt = hurt + WAR.OYFXL
	end

  if WAR.JYBG == 1 and DWPD() then
     hurt = hurt + 100
  end
	
	--伤害随距离递减，上限11格差值，最多衰减30%
	--九剑真传，离剑式不递减
	--NPC不递减
	if (inteam(pid) or WAR.ZLLY[pid]~=nil or WAR.FZLY[pid]~=nil) and (WAR.JJZC ~= 1 and WAR.JJZC ~= 5 ) then
		local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) + math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
		if offset > 11 then
			offset = 11
		end
		if WAR.FZLY[pid] ~=nil  then
		   if offset == 1 then
		      WAR.BJ=1
		   elseif offset<=10 then
		      hurt = (hurt) * (100 + offset) / 100
		   end		   
		elseif WAR.SPT ==4  then
		   if offset==1 then
		      WAR.BJ=1
		   elseif offset<=10 then
		      hurt = (hurt) * (100 + offset) / 100
		   end
		elseif wglw(pid,25)>1 and WAR.ARZS==1 and wugong== 25 then
		     hurt = (hurt) * (100 + offset) / 100
			 if WAR.LQZ[pid]~=nil and WAR.LQZ[pid] == 100 and wglw(pid,25)>2  then
			 hurt = hurt + 50 * offset	
			 end
	    elseif WAR.XLAY == 2 and wugong== 26 then
		     hurt = hurt + 50 * offset
		else
		hurt = (hurt) * (100 - (offset - 1) * 3) / 100
		    if  WAR.ZLLY[pid]~=nil then
			    hurt = math.modf(hurt*0.5)
				if offset >= 11  then
				hurt = 0
				end
			end
		end
	end
  
   if WAR.Person[WAR.CurID]["我方"] then --连锁加伤害和杀气--17-2-10
	if DWPD() and WAR.MYCHAIN > 1 then
		hurt = math.modf(hurt * (1 + (WAR.MYCHAIN / 100)))
		ang = math.modf(ang * (1 + (WAR.MYCHAIN / 100)))
	end
  else
 	if DWPD() and WAR.URCHAIN > 1 then
		hurt = math.modf(hurt * (1 + (WAR.URCHAIN / 100)))
		ang = math.modf(ang * (1 + (WAR.URCHAIN / 100)))
	end 
  end 
  
	--暴击
	if WAR.BJ == 1 then
		local SLWX = 0
		for i = 1, CC.Kungfunum do
			if JY.Person[eid]["武功" .. i] == 106 or JY.Person[eid]["武功" .. i] == 107 then
				SLWX = SLWX + 1
			end
		end
    local thurt = hurt
		if SLWX == 2 then
			WAR.Person[enemyid]["特效动画"] = 6
			if WAR.Person[enemyid]["特效文字2"] ~= nil then
				WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+森罗万象"
			else
				WAR.Person[enemyid]["特效文字2"] = "森罗万象"
			end	
		elseif nglw(pid,96)>1 and JY.Person[pid]["资质"]<=50 then
		    local cri_factor = 3
			if JY.Person[pid]["资质"]<=31  then
			cri_factor = 4
			end
		    hurt = hurt *cri_factor
        elseif CiBeiLD(pid) then
            hurt = hurt *2		
		--四大恶人 暴击时伤害一*200%
		elseif match_ID(pid, 44) or match_ID(pid, 98) or match_ID(pid, 99) or match_ID(pid, 100) then
			hurt = hurt * 2
		--袁承志，暴击效果随天书数量提高
		--仅限我方
		elseif match_ID(pid, 54) and inteam(pid) then
		    local cri_factor = (1.5 + 0.1 * JY.Base["天书数量"])
			if JY.Person[54]["论剑奖励"] == 2 then
			cri_factor = cri_factor + math.modf((JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])/20)*0.1
			end
			hurt = hurt * cri_factor
		elseif wglw(pid, 47)>1 and WAR.ASKD2 == 1 then
		    local cri_factor = 3
			if WAR.Weakspot[eid] ~=nil then
			cri_factor = cri_factor + (WAR.Weakspot[eid] or 0)*0.2
			end
			hurt = hurt * cri_factor
		--逆运 暴击时伤害一*170%
		elseif Curr_NG(pid, 104) then
			hurt = hurt * 1.7
		--其他人 暴击时伤害一*150%	
		else
			hurt = hurt * 1.5
		end
		if MPPB_GB(pid) >=2  then
		   addeffect2(WAR.GBLJ,pid,1)
		   if WAR.GBLJ[pid]>= 10 then
		   WAR.GBLJ[pid] = 10
		   end
		end
		if YCRW(pid) ==2 and YCDJ(pid)>0 and WAR.ZBX[pid]~=nil  then
           hurt = hurt * 1.5
		end
		
		if WAR.QYC[pid]~=nil  then
           if JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.5)  then
		   hurt = hurt * (2-JY.Person[pid]["生命"]/JY.Person[pid]["生命最大值"])
		   end
		end	

		
		
		if WAR.BSYJ[pid]~=nil then
		   local bb = JY.Person[eid]["冰封程度"]
		   hurt = hurt * (1+bb/100)
		   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid,"内力",-bb)
		end
		
        if wglw(pid,28)>=1 and WAR.ACT > 1 then
		   local aa = WAR.ACT + 0.1 * JY.Base["天书数量"]
		   hurt = hurt * (1 + 0.25 * WAR.ACT)
		   if wglw(pid,28)>1 then
		   local aa = -50 * WAR.ACT
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid,"生命",aa)
		   addeffect2(WAR.XRZT,eid,15)
		   end	
		 end
		  if WAR.BLC == 1 then
		     hurt=hurt*3
		   end
		if MPPB_SL(pid) == 1 then--
	       hurt = hurt * 1.25
		   if MPZJ(pid,3)>=1 then
		   hurt = hurt + hurt*(0.1*MPDJ(pid))
		   end
	    end
		if  MPPB_MZ(eid) == 2 then		 	
		    local mpdj = MPDJ(eid)
		    local BJ = 100 - 10*mpdj	
            hurt = math.modf(hurt * (BJ/100))
			WAR.MZQL[eid] = (WAR.MZQL[eid] or 0) + 1
			if WAR.MZQL[eid] == 3 and WAR.MZ_LH[eid]~=nil and JY.Person[eid]["生命"]>0 then
			local bb = WAR.MZ_LH[eid]*(MPZJ(eid,4)+1)
			WAR.MZ_LH[eid] = nil
			WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid,"生命",-bb)
			end
			if WAR.MZQL[eid] == 4 and WAR.MZ_LH[eid]~=nil and JY.Person[eid]["生命"]>0  then
			local bb = WAR.MZ_LH[eid] *(MPZJ(eid,4)+1)
			WAR.MZ_LH[eid] = nil
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid,"生命",bb)
			end
			if WAR.MZQL[eid]>4+MPZJ(eid,4) then
			WAR.MZQL[eid] = 1
			end
		end
		if PersonKF(pid,175) and SLWX < 2 then
		   local aa = 1.25
		   if Curr_NG(pid,175) then
		   aa = aa + 0.25
		   end
		   if JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3)  then
		   aa = aa+ 1
		   end
	       hurt = hurt * aa
	    end
 
       if JY.Person[pid]["武器"] == 43 and wglw(pid,67)>2  then
	       hurt = hurt * 1.5
	   end

	   if WAR.LHQ_WX1>0 and WAR.LHQ_WX == 5 and DWPD() then --炮劲
          hurt = hurt * (1+WAR.LHQ_WX1)
	   end	

       if WAR.ZBXZ == 4 and DWPD() then
         hurt = hurt * WAR.ACT
         end	
	   
	   	if WAR.LSDZ[pid]~= nil and WAR.LSDZ[pid] == 4 then
       	   local aa = -math.modf(JY.Person[pid]["内力最大值"]*0.05)
		   if WAR.LRHF[eid] ~= nil then
		   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid,"内力",aa)  	
		   end
	    end
		
	   	if WAR.GSSL[pid]~= nil and WAR.GSSL[pid] == 4 then
		   if WAR.LRHF[eid] ~= nil then
		   hurt = hurt + sixi(pid,4)
           WAR.BS_ZT[eid] = limitX((WAR.BS_ZT[eid] or 0) + 20, 0, 50)		   
		   end
	    end		
	   
	   if WAR.ZJZC>=1 then
       	   local aa = -math.modf(JY.Person[pid]["内力最大值"]*0.05)
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid,"生命",aa)   
       end	

    if WAR.THSB == 2 then
	   local bashu = sixi(pid,2) /200
	   hurt = hurt*(1+bashu) 
	end

		if nglw(pid,90)>2 and HunZi(pid) and DWPD()  then
           local aa = 2-(JY.Person[eid]["内力"]/JY.Person[eid]["内力最大值"])
		   local bb = 2-(JY.Person[eid]["体力"]/100)
		   hurt = math.modf(hurt * aa * bb) 
		end	

		if nglw(eid,90)>2 and HunZi(eid) and DWPD()  then
           local aa = JY.Person[pid]["内力"]/JY.Person[pid]["内力最大值"]
		   local bb = JY.Person[pid]["体力"]/100
		   hurt = math.modf(hurt * aa * bb) 
		end	 		
	   
	   if wglw(pid,81)>=1 and wugong == 81 then
	      local aa = math.modf(JY.Person[eid]["中毒程度"]/30)	  
		  if WAR.SPXT[pid]~=nil then
		  aa = aa +0.1*WAR.SPXT[pid]
		  end
		  hurt = math.modf(hurt * aa)
		  if WAR.DSXF == 2 then
		  hurt = hurt * 2
		  end
	   end
		
			--血刀连击
	   if MPPB_MZ(pid) == 3 and SLWX < 2 then
		  local ynjl = WAR.LXZT[eid] or 0 ;
		  if match_ID(pid, 97) then
			ynjl = ynjl+15
		  end
		-- 刀系连斩
		  local kfkind = JY.Wugong[wugong]["武功类型"]
		  if kfkind  == 4 then
          hurt = math.modf(hurt * (1+ynjl/100))
		  end
	    end
		if WAR.UNLUCK[pid]~=nil then
		    hurt = math.modf(hurt * 0.5)
		end
		
		if WAR.ASKD2 == 5 then
		   hurt = hurt + JY.Person[eid]["受伤程度"]*2
		end
		
		if SLWX == 2 and (nglw(eid,106)>=1 or nglw(eid,107)>=1) then
		   hurt = math.min(thurt,hurt)
		end
		
		hurt =math.modf(hurt)
	end
 
 local kfkind = JY.Wugong[wugong]["武功类型"]
   --五岳剑派
  if MPPD(pid) == 6 and kfkind  == 3 then
    local mpdj = MPDJ(pid)*0.05
  	hurt = math.modf(hurt*(1 + (mpdj)));
  end

	if WAR.MZSM[pid] ~=nil and WAR.MZSM[pid] == 1 then
		hurt = math.modf(hurt*1.2)
	end

	if WAR.MZSM[eid] ~=nil and WAR.MZSM[eid] == 1 then
	   local aa = (JY.Person[pid]["内力最大值"]-JY.Person[pid]["内力"])/JY.Person[pid]["内力最大值"]
		hurt = math.modf(hurt*(1-aa))
	end

	if WAR.MZSM[eid] ~=nil and WAR.MZSM[eid] == 2 then
		hurt = math.modf(hurt*0.8)
	end
	if WAR.MZSM[pid] ~=nil and WAR.MZSM[pid] == 2 then
	   local aa = (100-JY.Person[pid]["体力"])/100
		hurt = math.modf(hurt*(1+aa))
	end

  --五岳剑派
  if MPPB_WYJZ(pid) == 1  and kfkind  == 3 then
  	hurt = hurt+math.modf(TrueYJ(pid)*0.5);
  end
  
    if MPPB_MJAS(pid) >= 1 and WAR.HIDE[pid]~=nil and WAR.HIDE[pid] > 0 then  --沼跃鱼：滕青山豹王.潜影杀机
	 local str="焚影圣诀.暗影突袭"
	 local kfkind = JY.Wugong[wugong]["武功类型"]
	 local aa=100
	 hurt = math.modf(hurt*1.5)
	 if kfkind  == 4 then
	 aa=aa+50*MPDJ(pid)
	 str="焚影圣诀.影刀突杀"
	 AddPersonAttrib(eid,"中毒程度", 30);
	 WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -aa);
	 end
	 WAR.HIDE[pid] = nil
	 hurt = math.modf(hurt*(1+aa/200))
	if WAR.Person[enemyid]["特效文字2"] ~= nil then
  		WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .."+" ..str
  	else
  		WAR.Person[enemyid]["特效文字2"] = str
  	end 
  end  
  
			  --沼跃鱼：张召重火手剑意
  if wugong == 36 and WAR.NSTJ1>0 and match_ID_awakened(pid,80,1) and WAR.ACT==1 and DWPD() then
    hurt = hurt + math.modf(TrueYJ(pid)* 0.1* WAR.NSTJ1);
  end
	
  if T7DFWM(pid) and WAR.DFWM2P == 5 and DWPD() then --崩劲
	hurt = hurt + math.modf((JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])*0.1)
  end		

  if WAR.LHQ_WX == 1 and DWPD() then --五行崩拳
	hurt = hurt + math.modf((JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])*0.1*(1+WAR.LHQ_WX1))
	if wglw(pid,1)>1 and  PersonKFJ(pid,13) then --学了铁掌
	hurt = hurt + math.modf((JY.Person[pid]["内力"])*0.05)+math.modf((JY.Person[eid]["受伤程度"])*0.5)
	end
  end
  

  if WAR.DGPZ1[pid]~= nil and wugong == 47  and DWPD()  then
     if WAR.DGPZ1[pid] == 6 then
	    hurt = hurt + math.max(math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"])*0.25),0)
	 end
  end  

  if  WAR.LHQ_WX == 2 and DWPD() then --五行横拳
	hurt = hurt + math.modf((JY.Person[pid]["防御力"] )*0.75)
	if wglw(pid,1)>1 and PersonKFJ(pid,22) then --学了金刚掌
	hurt = hurt + math.modf((JY.Person[eid]["防御力"])*0.75)
	WAR.BHJS[pid] = limitX((WAR.BHJS[pid] or 0) + 20, 0, 50)
	end
	if WAR.LHQ_WX1>0 then --缚龙柱
	local aa = math.modf((JY.Person[eid]["受伤程度"])*0.75*WAR.LHQ_WX1)
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -aa);
	end
  end

   if T7DFWM(pid) and WAR.DFWM2 == 5 then --陈家洛横扫千军
	hurt = hurt + math.modf(JY.Person[pid]["内力"]*0.1)
  end	 
 
   if WAR.YKX1 == 1 and DWPD()  then --陈家洛横扫千军
	hurt = hurt + math.modf(JY.Person[pid]["内力"]*0.1)
	hurt =  hurt + (100-JY.Person[eid]["体力"])*5
  end	
 
  if WAR.ZBT3>0 and match_ID_awakened(pid,64,1) and DWPD() then
    hurt = hurt + math.modf(JY.Person[pid]["拳掌功夫"]* 0.1* WAR.ZBT3);
  end
  
    if WAR.ZBT3>0 and pid == 645 and JY.Base["斗神"] == 64 and DWPD() then
    hurt = hurt + math.modf(JY.Person[pid]["拳掌功夫"]* 0.1* WAR.ZBT3);
  end

    if WAR.DFMQ>0  and DWPD() then
    hurt = hurt + math.modf(hurt* 0.1* WAR.DFMQ);
  end
 
    if WAR.FMZF>0  and DWPD() then
    hurt = hurt + math.modf(hurt* 0.1* WAR.FMZF);
  end
 
	--蓝烟清：燃木刀法，普通内功加力额外增加伤害
	if wugong == 65 and WAR.NGJL > 0 and DWPD() then
	    local aa = 100
		if WAR.NGJL >= 1 then
		aa = math.modf(JY.Wugong[WAR.NGJL]["攻击力10"]/12)
		end
		hurt  = hurt + aa;
		if wglw(pid,65)>=1 then
		local aa = math.modf(JY.Person[eid]["灼烧程度"] *0.5)
		 WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) +AddPersonAttrib(eid, "中毒程度", aa)
		end
	end
    
	 if nglw(pid,95)>1 and WAR.L_CZJT1 == 1 and DWPD() then--蛤蟆九天17-2-23
	   hurt = hurt + math.min(math.modf(WAR.HMJT[pid]/10),500)
	   WAR.HMJT[pid] = 1000
	end
	
 if WAR.ZBX[pid] ~= nil and DWPD() then --醉八仙攻击*2
	hurt = math.modf(hurt * 2)
  end
  
    if WAR.FZ[eid] ~=nil and WAR.FZ[eid][1] ~=nil and WAR.FZ[eid][1]>3 then
	hurt = math.modf(hurt * 0.5)
	end  
 
     if WAR.FZ2[pid] ~=nil and WAR.FZ2[pid][3] ~=nil and WAR.FZ2[pid][3]>6 then
	hurt = math.modf(hurt * 0.5)
	end 
 
 if WAR.QYC[pid] ~= nil and DWPD() then --犬夜叉攻击*2，上毒
	hurt = math.modf(hurt * 2)
	 WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) +AddPersonAttrib(eid, "中毒程度", 20)
	   if JY.Person[eid]["中毒程度"]>=75 and WAR.KQB[eid] == nil then
	   WAR.KQB[eid] = 1
	   end
  end
 
  if WAR.ZBX2[pid] ~= nil and DWPD() then --醉八仙攻击*2
	hurt = math.modf(hurt * 1.4)
  end
 
  if T7DFWM(pid) and WAR.DFWM == 1 and DWPD() then --东方未明觉醒后生命50%以下，25%几率攻击加倍
	hurt = math.modf(hurt * 2)
  end
 
   if MPPB_MZ(pid)== 3 and DWPD() then --血祭
	if WAR.XJ[pid] ~= nil then
		hurt = math.modf(hurt * (1 + 0.05 * WAR.XJ[pid]))
	end
  end 
 
   if MPPD(pid) == 2 and WAR.YJZD2[pid] ~= nil then --以静制动
	if WAR.YJZD2[pid][1] ~= nil then
		AddPersonAttrib(eid, "受伤程度", WAR.YJZD2[pid][1])
	end
	if WAR.YJZD2[pid][2] ~= nil then
		AddPersonAttrib(eid, "中毒程度", WAR.YJZD2[pid][2])
	end
	if WAR.YJZD2[pid][3] ~= nil then
		WAR.FXXS[eid] = 1 
		if WAR.FXDS[eid] == nil then
			WAR.FXDS[eid] = WAR.YJZD2[pid][3]
		else
			WAR.FXDS[eid] = WAR.FXDS[eid] + WAR.YJZD2[pid][3]
		end
	end
	if WAR.YJZD2[pid][4] ~= nil then
		WAR.LXXS[eid] = 1
		if WAR.LXZT[eid] == nil then
			WAR.LXZT[eid] = WAR.YJZD2[pid][4]
		else
			WAR.LXZT[eid] = WAR.LXZT[eid] + WAR.YJZD2[pid][4]
		end	
	end
	if WAR.YJZD2[pid][5] ~= nil then
		AddPersonAttrib(eid, "冰封程度", WAR.YJZD2[pid][5])
	end	
	if WAR.YJZD2[pid][6] ~= nil then
		AddPersonAttrib(eid, "灼烧程度", WAR.YJZD2[pid][6])
	end	
	if WAR.YJZD2[pid][7] ~= nil then
		WAR.CHXS[eid] = 1
		if WAR.CHZ[eid] == nil then
			WAR.CHZ[eid] = WAR.YJZD2[pid][7]
		else
			WAR.CHZ[eid] = WAR.CHZ[eid] + WAR.YJZD2[pid][7]
		end	
	end	
	if WAR.YJZD2[pid][8] ~= nil then
				WAR.MBXS[eid] = 1
		if WAR.MBZ[eid] == nil then
			WAR.MBZ[eid] = WAR.YJZD2[pid][8]
		else
			WAR.MBZ[eid] = WAR.MBZ[eid] + WAR.YJZD2[pid][8]
		end	
	end	
	hurt = math.modf(hurt * 2)
  end 
	--brolycjw：龙岛主，攻击时伤害一*120%

		if WAR.LXZL>0 then
		hurt = hurt + math.modf((JY.Person[pid]["内力"])/200*WAR.LXZL);
				if match_ID(pid, 39) then
		        WAR.XRZT[eid] = 30
	            end	
	    end	

	if match_ID(pid, 39) then
		hurt = math.modf(hurt * 1.2)
	end	
	
	
	if wugong == 25 and WAR.ARZS==4 and wglw(pid,25)>0 and DWPD() then
		hurt  = hurt + math.modf((JY.Person[pid]["指法技巧"]+JY.Person[pid]["拳掌功夫"])/30);
		if JY.Person[pid]["指法技巧"]<=320 then
		JY.Person[pid]["指法技巧"]=320
		end
	end	

	--黯然天外效果
	if wugong == 25 and (WAR.NGJL > 0 or WAR.ARZS>0) and wglw(pid,25)>0 and DWPD() then
	    local aa= WAR.ARZS-2
		if aa<0 then
		aa=0
		end
		hurt  = hurt + math.modf(JY.Person[pid]["内力"]/60*(aa+1))
	end

	--乔峰龙牙天引效果
	if match_ID_awakened(pid,50,1) and WAR.FS2 ==1 and wugong == 26 and DWPD() then
		hurt  = hurt + math.modf(JY.Person[pid]["内力最大值"]/60)
	end	

	   if WAR.SXJ == 1 and DWPD() then
    local cc=math.modf(JY.Person[pid]["内力"]*0.02)
	 hurt = hurt+cc
	 ang = ang + math.modf(cc*3)
  end
	
	if wglw(pid,25)>1 and WAR.ARZS==1 and wugong== 25 and DWPD() then
	    hurt  = math.modf(hurt *0.85)
		WAR.ACT = 10
		WAR.ZYHB = 0
	end

 
	
	--谢逊，被攻击时伤害一*60%
	if match_ID(eid, 13) then
		hurt = math.modf(hurt * 0.6)
	end
  
	--程英，半血以下，攻击时伤害一*120%
	if match_ID(pid, 63) and JY.Person[pid]["生命"] < math.modf(JY.Person[pid]["生命最大值"] / 2) then
		hurt = math.modf(hurt * 1.2)
	end
  
   if WAR.ZBX[eid] ~= nil then --醉八仙伤害/2
	hurt = math.modf(hurt * 0.5)
  end   
  
   if WAR.QYC[eid] ~= nil then --醉八仙伤害/2
	hurt = math.modf(hurt * 0.5)
  end 
  
	--brolycjw: 木岛主，被攻击时伤害一*80%
	if match_ID(eid, 40) then
		hurt = math.modf(hurt * 0.8)
	end
  
	--刀剑归真，攻击时伤害一*150%
	if WAR.DJGZ >= 1 and not match_ID(pid,72) then
		hurt = math.modf(hurt * 1.5)
	end


	
	if WAR.WS == 1 then
	   if Curr_NG(pid,183) then
	   hurt = math.modf(hurt * 1.2)
	   elseif PersonKF(pid,183) then
	   hurt = math.modf(hurt * 1.1)	   
	   end
	end
	
	if WAR.LXJY>=1 then
	   hurt = math.modf(hurt * WAR.LXJY)
	end
	
	if WAR.DJGZ3 >= 1 then
		hurt = math.modf(hurt * 1.5)
	end
	
	if WAR.SXJZ == 1 then
		hurt = math.modf(hurt * 9)
	end	
	
	if WAR.YTMX >= 1 then
		hurt = hurt + WAR.YTMX*100
	end	
	
 if MPPD(pid) == 3 and JY.Person[pid]["品德"] > 50 and DWPD() then --袈裟伏魔
	hurt = math.modf((1 + (JY.Person[pid]["品德"] - 50) / 200) * hurt)
	 if MPZJ(pid,3)>2 and MPPB_SL(pid) == 1 then
	 hurt = hurt + math.modf(JY.Person[pid]["内力"]* 0.05)
	 end
  end
 
     if wglw(pid,43)>1 and yongjian(wugong) and WAR.DZXY == 1 then
		hurt = hurt+math.modf(JY.Person[pid]["攻击力"]* 0.35+JY.Person[pid]["内力"]* 0.05)
		WAR.BLX = 1
		if wglw(pid,43)>2  then
		WAR.QBLY[eid] =  (WAR.QBLY[eid] or 0) + 30
		end
	end	

	if WAR.YCHX == 2 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 2 then		
		if wglw(pid,74)>1  then
		local aa = WAR.LXZT[eid] or 0
		aa = aa *1.25
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid,"生命", -aa)
		end
		if wglw(pid,74)>2  then
		WAR.QBLY[eid] =  (WAR.QBLY[eid] or 0) + 30
		end
		WAR.LXXS[eid] = 1
		WAR.LXZT[eid]=(WAR.LXZT[eid] or 0) + math.random(10,15)
		if WAR.LXZT[eid]>=100 then
		    WAR.LXZT[eid]=100
		 end
	end
	
    if wglw(pid,43)>1 and yongzhi(wugong) and WAR.DZXY == 1 and DWPD() then
		WAR.LXYZ= 1
		WAR.BFX = 1
		if wglw(pid,43)>2  then
		WAR.XRZT[eid] =  (WAR.XRZT[eid] or 0) + 30
		end
	end		

    if wglw(pid,43)>1 and yongte(wugong) and WAR.DZXY == 1 and DWPD() then
		WAR.BJ= 1
		hurt = math.modf(hurt * 1.5)
		if wglw(pid,43)>2  then
		WAR.POISON[eid] =  (WAR.POISON[eid] or 0) + 30
		end
	end	

   if wglw(pid,43)>1 and yongnei(wugong) and WAR.DZXY == 1 then
		hurt = hurt+math.modf(JY.Person[pid]["内力"]* 0.1)
		local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
	    ang = math.modf(ang * (1 + mp_percentage))
	    hurt = math.modf(hurt* (1 + mp_percentage))
		if wglw(pid,43)>2  then
		WAR.LSQ[eid] =  (WAR.LSQ[eid] or 0) + 30
		end
	end	

	if WAR.JGHJ == 15 and DWPD() then
	   	local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
	    ang = math.modf(ang * (1 + mp_percentage))
	    hurt = math.modf(hurt* (1 + mp_percentage))
		local aa = (WAR.BDKY[pid] or 0) *100
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid,"内力", -aa)
	end

	if WAR.JGHJ == 115 and DWPD() then
	   	local mp_percentage = (JY.Person[pid]["内力"])/JY.Person[pid]["内力最大值"]
	    ang = math.modf(ang * (1 + mp_percentage))
	    hurt = math.modf(hurt* (1 + mp_percentage))
		local aa = (WAR.BDKY[pid] or 0) *10
		local bb = (WAR.BDKY[pid] or 0) *100
		WAR.LHXX = WAR.LHXX + aa
		WAR.LHXX2 = WAR.LHXX2 + bb
	end
	
    if WAR.MKDS[eid]~=nil then----
	   hurt = math.modf(hurt * 1.5)
	end
	
	if WAR.CHD == 4 and match_ID_awakened(pid,103,1) and DWPD() then --残火刀初式
		hurt=hurt+math.modf(1*JY.Person[eid]["受伤程度"])
	end

   if MPPD(pid) == 5 and DWPD() then   
      local tymj = Xishu_sum(pid)
	  local mpdj = MPDJ(pid)
      hurt = math.modf(hurt * (1 + (tymj) * 0.001*mpdj))
   end
	
	if WAR.DJGZ >1 and DWPD() then----
		hurt = hurt+math.modf((TrueYJ(pid)+JY.Person[pid]["耍刀技巧"])* 0.15)
	end

	if WAR.LSDF == 1 and DWPD() then----
		hurt = math.modf(hurt * (1 + 0.2))
		if WAR.BJ == 1 then
		zhanyi(eid, -3)
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", 300)
		end
	end

	if WAR.YSDF == 1 and DWPD() then----
		hurt = hurt+math.modf(1*JY.Person[eid]["中毒程度"])
	end
	
	if WAR.YSDF == 4 and DWPD() then----
		hurt = hurt+ (WAR.LQZ[eid] or 0)
	end

	if WAR.LSDF == 3 and DWPD() then----
		hurt = hurt+math.modf(0.015*JY.Person[pid]["内力"])
	end	
	
	if wglw(pid, 22)>2 and wugong == 22 and WAR.ARJY == 1 and WAR.ACT==1 and DWPD() then
       hurt = hurt * (1 + math.random(200) / 100)
	end
	
	if wglw(pid,162)> 0 and wugong == 162 and DWPD() then
	local aa=math.modf(WAR.JQSD[pid] or 0)
	   hurt = math.modf(TrueYJ(pid) *(aa/100+1)*0.1) + hurt
	end

	if wglw(pid,27)> 0 and JY.Wugong[wugong]["武功类型"]==3 and DWPD() then
	local aa=math.modf(WAR.JQSD[pid] or 0)
	   hurt = math.modf(TrueYJ(pid) *(aa/100+1)*0.1) + hurt
	end
	
	if WAR.CY == 1 and match_ID_awakened(pid,63,1) and DWPD() then--程英加伤
	   local aa=math.modf(JY.Person[eid]["内力"]*0.1)
	   local bb=math.modf(JY.Person[eid]["内力最大值"]*0.1)
	   local bb1=math.modf((bb-aa)*0.5)
	   local cc=math.modf(JY.Person[pid]["内力"]*0.05)
	   hurt = hurt+bb1+cc
	end

		if WAR.XLZS == 8 and DWPD() then
           local aa=math.modf(JY.Person[eid]["内力"]*0.1)
	       local bb=math.modf(JY.Person[eid]["内力最大值"]*0.1)
	       local bb1=math.modf((bb-aa)*0.5)
	       local cc=math.modf(JY.Person[pid]["内力"]*0.05)
	       hurt = hurt+bb1+cc   	   
		end

		if WAR.XLAY == 1 and DWPD() then
	       hurt = hurt+50*WAR.XLAY_BL   	   
		end

	if WAR.HQT == 1 and match_ID_awakened(pid,74,1) and DWPD() then--霍青桐
	   local aa=2-JY.Person[eid]["体力"]/100
	   local bb=1+JY.Person[pid]["体力"]/100
	   hurt = math.modf(hurt*aa*bb)
	end
	
	if WAR.DJGZ2>0 or WAR.XLEB>0 then
		hurt = math.modf(hurt * 1.25)
	end	

	if WAR.QSLX>0 and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 1 then
		hurt = math.modf(hurt * 2)
	end

	if WAR.QSLX_SY == 1 and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 3 then
	    WAR.Person[enemyid]["伤害爆裂"] = (WAR.Person[enemyid]["伤害爆裂"] or 0) + math.modf(JY.Person[pid]["内力"]/20)
	end

	if WAR.QSLX>0 and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 3 then
		WAR.Person[enemyid]["伤害爆裂"] = math.modf((WAR.Person[enemyid]["伤害爆裂"] or 0) *1.25)
	end		
	
	if WAR.DJDAO == 1 or WAR.DJJIAN==1 or WAR.HUANJIAN==1 or WAR.BADAO==1 then
		hurt = math.modf(hurt * 1.25)
	end

	if WAR.DJGZ2==2  then
		hurt = hurt+math.modf(TrueYJ(pid) * 0.25)
	end	
	
	if WAR.DJGZ2==3  or WAR.YYDAO == 1  then
		hurt = hurt+math.modf(JY.Person[pid]["耍刀技巧"]* 0.25)
	end	

	if WAR.BLC==2   then
		hurt = hurt+math.modf(JY.Person[pid]["轻功"]* 0.25)
	end

	if WAR.BLC==4   then
		hurt = hurt+math.modf(JY.Person[pid]["内力"]* 0.02)
	end
	
	if match_ID_awakened(pid,65,1) and JY.Wugong[wugong]["武功类型"]== 2 and DWPD() then
		hurt = hurt+math.modf((JY.Person[pid]["指法技巧"]+TrueYJ(pid))* 0.075)
	end	
	
	if WAR.DJGZ2==1 and DWPD() then --阎基毒刀附加用毒伤害
	   hurt = hurt + math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5))* 0.25)+ math.modf(JY.Person[eid]["中毒程度"] *0.75)
	   if JY.Person[4]["论剑奖励"] == 1 then
	   hurt = hurt + math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5))* 0.25)
	   end
    end

	if WAR.OYK == 2 and DWPD() then --欧阳克毒手
	   hurt = hurt + math.modf(JY.Person[eid]["中毒程度"] *0.75)+ math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5))* 0.25)
    end	
	
	if WAR.TZQJ == 7 and yongnei(wugong) and DWPD() then
      hurt = hurt + math.modf(JY.Person[eid]["中毒程度"] *0.75)+ math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5))* 0.25)
	  WAR.XRZT[eid] = math.modf(JY.Person[eid]["中毒程度"] *0.25)
	  WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) +AddPersonAttrib(eid,"中毒程度", 15)
	end
	
	if wugong==22 and WAR.JGZB == 2 and DWPD() then----金刚掌刚掌波
       hurt = hurt + math.modf(WAR.JGZB1*0.25)
	   WAR.BHJS[pid] = 30
	end	
	
    if WAR.TZQJ == 1 and wugong == 18 and DWPD() then----紫霞弹指气劲
	   WAR.ZXJY=WAR.ZXJY+math.random(5,10)
	   hurt = hurt + WAR.ZXJY*20
	end

    if WAR.TZQJ == 1 and yongnei(wugong) and DWPD() then----紫霞天罡
		local NS;
		NS=JY.Person[pid]["受伤程度"]+JY.Person[pid]["灼烧程度"]+JY.Person[pid]["中毒程度"]+JY.Person[pid]["冰封程度"]
	   WAR.ZXJY=WAR.ZXJY+math.random(5,10)+math.modf(NS/20)
	   hurt = hurt + WAR.ZXJY*20
	end

    if WAR.TZQJ == 2 and yongnei(wugong) and DWPD() then----混元天罡
		local NS;
		NS=JY.Person[pid]["体力"] - JY.Person[eid]["体力"]
		if NS<10 then
		NS = 10
		end
	   local bb=math.modf(NS/2)
	   hurt = hurt + bb*10
	   WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid,"体力", bb)
	end

	if (WAR.HDMC == 6 or  WAR.HDMC2 == 6) and DWPD() then
	  local aa = math.modf(JY.Person[pid]["耍刀技巧"]* 0.3)+math.modf(JY.Person[pid]["攻击力"]* 0.15)
      hurt = hurt + aa
	end


	
	if wglw(pid,77)>1 and WAR.DZDJ==4 and DWPD() then
	     hurt = hurt + math.modf(TrueYJ(pid)* 0.3)
	     hurt = hurt + math.modf(JY.Person[pid]["攻击力"]* 0.15)
		 if wglw(pid,77)>2 then
		 hurt = hurt + math.modf(JY.Person[pid]["攻击力"]* 0.15)
		 
		 end
	 if WAR.KHCM[eid] ~=nil  then
	 hurt =  math.modf(hurt*2)
	 end
	 if WAR.LXZT[eid]~=nil then
	 hurt =  math.modf(hurt*2)
	 end
	end
	
	if WAR.DGXF == 5 and DWPD() then
	local cc2=math.modf(JY.Person[pid]["内力"]*0.1)
	hurt = hurt + math.modf(sixi(pid,5)* 0.15)+cc2
	end

	if wglw(pid,77)>1 and WAR.DZDJ==3 and DWPD() then
	local cc2=math.modf(JY.Person[pid]["内力"]*0.1)
	hurt = hurt + math.modf(TrueYJ(pid)* 0.15)+cc2
	end
	
	if wglw(pid,77)>1 and WAR.DZDJ==1 and DWPD() then
	hurt = hurt + math.modf(JY.Person[pid]["耍刀技巧"]* 0.3)
	hurt = hurt + math.modf(JY.Person[pid]["防御力"]* 0.5)
	end
	
	if wglw(pid,77)>1 and WAR.DZDJ==2 and DWPD() then
	hurt = hurt + math.modf(JY.Person[pid]["耍刀技巧"]* 0.35)
	end
	
	if WAR.DJSX==1 and DWPD() then --田归农刀剑十杀附加刀剑系数伤害
	   hurt = hurt+math.modf((JY.Person[pid]["御剑能力"]+JY.Person[pid]["耍刀技巧"])* 0.35)
    end

	if  WAR.HQGS == 1 and DWPD() then ----沼跃鱼：洪七龙纹打狗棒
		hurt = hurt + math.modf((JY.Person[pid]["特殊兵器"]+JY.Person[pid]["攻击力"])* 0.3)
		WAR.BJ = 1
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid,"受伤程度", math.random(10,25))
		ang = math.modf(ang *2) + math.modf(JY.Person[pid]["内力最大值"] / 40)
		dng = math.modf(dng/2)
	end

	if WAR.LM_JQ1 == 1 and DWPD() then
	    local d = math.modf((JY.Person[pid]["内力"] ) / 50)
		local d2 = math.modf((JY.Person[pid]["体力"] ) * 1.5)
		hurt = hurt + d	+d2
	end

	if WAR.LM_JQ1 == 4 and DWPD() then
	    local d = math.modf((JY.Person[eid]["内力"] ) / 10)
		hurt = hurt + d	
		ang= ang + d*10
	end

	   	if WAR.LSDZ[pid]~= nil and WAR.LSDZ[pid] == 4 then
		   if WAR.LRHF[eid] ~= nil then
		  WAR.BJ = 1 	
		   end
	    end	
	
	if JY.Base["标准"] == 3 and pid == 0 and zylw(3)>0 and DWPD() then
                if JY.Person[pid]["内力性质"] == 0 then
                 hurt = hurt + math.modf((TrueYJ(pid)+JY.Person[pid]["攻击力"])* 0.35)
				 end
	            if JY.Person[pid]["内力性质"] == 1 then
                 hurt = hurt + math.modf(JY.Person[pid]["内力"]* 0.085)
                 ang= ang + math.modf(JY.Person[pid]["内力"]* 0.15)
				 end
	end

	if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 3 then
	ang = ang + math.modf(JY.Person[pid]["内力"] * 0.15)
	end	
	
    --玄冥火刀
	if WAR.YY~=0 and DWPD() then
		local shanghai=math.random(1,2)
		if WAR.YY==1 then --玄冥内伤
		        WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) +AddPersonAttrib(eid,"受伤程度", 15)		
				hurt=hurt+math.modf(shanghai*JY.Person[eid]["受伤程度"])
				WAR.ICE[eid]=(WAR.ICE[eid] or 0) + math.modf(JY.Person[eid]["中毒程度"]/5*shanghai)
				if WAR.ICE[eid]>50 then
				WAR.ICE[eid]=50
				end
		else --火刀上毒
				WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) +AddPersonAttrib(eid,"中毒程度", 15)			
				hurt=hurt+math.modf(shanghai*JY.Person[eid]["中毒程度"])
				WAR.HOT[eid]=(WAR.HOT[eid] or 0) + math.modf(JY.Person[eid]["受伤程度"]/5*shanghai)
				if WAR.HOT[eid]>50 then
				WAR.HOT[eid]=50
				end
		end
	end

	if WAR.YY2~=0 and DWPD() then
		local shanghai=math.random(1,2)*10
		if WAR.YY2==1 then --玄冥内伤
			WAR.BFXS[eid] = 1
				JY.Person[eid]["冰封程度"]=JY.Person[eid]["冰封程度"] or 0+15
                if JY.Person[eid]["冰封程度"]>100 then----
                JY.Person[eid]["冰封程度"]=100
                end
				if WAR.ICE2[eid] == nil then
				 WAR.ICE2[eid] = 1
				end
                WAR.LRHF[eid]=math.modf(JY.Person[eid]["冰封程度"]/2)
                WAR.POISON[eid]=math.modf(JY.Person[eid]["中毒程度"]/2)				
				dng=dng-math.modf(shanghai*(JY.Person[eid]["冰封程度"]+JY.Person[eid]["中毒程度"]))
				if dng<0 then
				dng=0
				end
		elseif WAR.YY2>=3 then --冰蚕丝雨
				hurt=hurt+math.modf(shanghai*JY.Person[eid]["冰封程度"]*0.025)
					WAR.BFXS[eid] = 1
				JY.Person[eid]["冰封程度"]=(JY.Person[eid]["冰封程度"] or 0)+15
                if JY.Person[eid]["冰封程度"]>100 then----
                JY.Person[eid]["冰封程度"]=100
                end
                WAR.LRHF[eid]=math.modf(JY.Person[eid]["冰封程度"]/2)				
				dng=dng-math.modf(shanghai*(JY.Person[eid]["冰封程度"])*1.5)
				if dng<0 then
				dng=0
				end
				if WAR.YY2 == 4 then --黯灭之吻
				   WAR.PJFY[eid] = (WAR.PJFY[eid] or 0) + math.modf(JY.Person[eid]["冰封程度"]/2)
				end
				if WAR.YY2 == 5 then --迷乱之伤
				WAR.MLZS[eid] = (WAR.MLZS[eid] or 0) + math.modf(JY.Person[eid]["冰封程度"]/2)
				end
		else --火刀上毒
			WAR.ZSXS[eid] = 1
				JY.Person[eid]["灼烧程度"]=(JY.Person[eid]["灼烧程度"] or 0) +15
                if JY.Person[eid]["灼烧程度"]>50 then----
                JY.Person[eid]["灼烧程度"]=50
                end
				if WAR.HOT2[eid] == nil then
				 WAR.HOT2[eid] = 1
				elseif JuHuoLY(pid) then
                 WAR.HOT2_JH[eid] = 10
				end
                WAR.JHLY[eid]=math.modf(JY.Person[eid]["灼烧程度"]) 			
                ang=ang+math.modf(shanghai*2*(JY.Person[eid]["受伤程度"]+JY.Person[eid]["灼烧程度"]))
		end
	end

	if WAR.YY3~=0 and DWPD() then
		local shanghai=math.random(1,2)
		if WAR.YY3==1 then --相柳
		        local aa = JY.Person[eid]["冰封程度"]*shanghai*10
				local bb = JY.Person[eid]["中毒程度"]*shanghai
				if WAR.ICE2[eid]~=nil then
				aa = aa + math.modf(JY.Person[eid]["内力"]/2)
				end
                WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -bb)
				if JY.Person[eid]["内力"] >= aa then
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa)
				else
				aa = math.modf((aa-JY.Person[eid]["内力"])/10)
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -JY.Person[eid]["内力"])
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa)
				end
		else --毕方
		        local aa = JY.Person[eid]["灼烧程度"]*shanghai
				local bb = JY.Person[eid]["受伤程度"]*shanghai*10
				if WAR.HOT2[eid]~=nil then
				aa = aa + math.modf(JY.Person[eid]["生命"]/5)
				end
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa)
				if JY.Person[eid]["内力"] >= bb then
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -bb)
				else
				bb = math.modf((bb-JY.Person[eid]["内力"])/10)
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -JY.Person[eid]["内力"])
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -bb)
				end
		end
	end

  if (wugong ~= 16 or MPZJ(pid,2)>=1) and MPPD(pid) == 2 and WAR.BG[pid] ~= nil and DWPD() then --武当八卦
	hurt = hurt + WAR.BG[pid]
	 if WAR.WDKTJ == 1 then
        hurt = hurt + WAR.BG[pid]
        if WAR.TJZX[pid]~= nil and WAR.TJZX[pid]>0 then--
        hurt = hurt + WAR.BG[pid]*(WAR.TJZX[pid]-1)
        end		
	end
    if WAR.RWZ==42 and MPPB_WD(pid) == 2 and MPZJ(pid,2)>1 then
       hurt = hurt + WAR.BG[pid]*(WAR.TJZX[pid] or 0)
    end
    if MPPB_WD(pid) == 2 and MPZJ(pid,2)>=1 then	
	
	else
    WAR.BG[pid] = nil
	end
  end	
	

   if WAR.RMDY>0 and JuHuoLY(pid) and DWPD()  then
	  WAR.GTSHAQI = WAR.GTSHAQI + JY.Person[eid]["灼烧程度"]
	  WAR.GTPID2 = pid
	  if WAR.JHLY2[eid]~=nil then
	  WAR.GTSHAQI = WAR.GTSHAQI * 2
	  end
   end
	
  if WAR.RMDY==2 and DWPD() then----
  ang=math.modf(ang * (1+(JY.Person[eid]["灼烧程度"]/100)))
  WAR.JHLY2[eid]=(WAR.JHLY2[eid] or 0) +math.modf(JY.Person[eid]["灼烧程度"])
  end  
  
  if WAR.RMDY2==1 and DWPD() then----
    if WAR.JHLY2[eid]~=nil then
	local aa = WAR.JHLY2[eid]
	local bb =  WAR.HTZD2[eid] or 0
	   if JuHuoLY(pid) and bb>0  then
	      WAR.JHLY2[eid] = 1
		  WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -100*aa);
	      WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -20*aa);
	   else
        addeffect(WAR.HTZD2, eid, 1)
	   end
    end
  local aa = math.modf(JY.Person[eid]["中毒程度"]/2)
  WAR.JHLY2[eid]=(WAR.JHLY2[eid] or 0) +aa
  end 
 
   if WAR.QJJQ==1 and DWPD() then----
  ang=math.modf(ang * (1+(JY.Person[eid]["灼烧程度"]/100)))
  WAR.WMYH[eid] = (WAR.WMYH[eid] or 0) + JY.Person[eid]["灼烧程度"]
  WAR.JHLY2[eid] = (WAR.JHLY2[eid] or 0) + JY.Person[eid]["灼烧程度"]
  WAR.PJZT[eid] = 40
  		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
  end  
  
  if wglw(pid,44)>2 and WAR.SQGJ ==1 and WAR.DZXY ~= 1 and WAR.HFLY ~= 1 and War_isEnd() == 0 and DWPD() then----
     WAR.LXBZ[eid] = 10
  end
 
  if MPPB_WYQZ(pid) ==1 and WAR.ZXXS2[pid]~=nil and DWPD() then--沼跃鱼：重峦叠嶂
    local aa = WAR.ZXXS2[pid] or 0
	if aa >= 10 then
	   dng = 0
	else 
       dng = math.modf(dng*(1-aa/10))	
	end
	   ang = math.modf(ang*(1+aa/20))
	local bb = ang -dng
	if  bb<0 then
	bb=0
	end
	local nn=math.modf(bb/100)
	hurt = hurt + nn
   if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "气宗紫霞.山居剑意"	
	else
		WAR.Person[enemyid]["特效文字2"] = "气宗紫霞.山居剑意+"..WAR.Person[enemyid]["特效文字2"]	
	end	
	WAR.Person[enemyid]["特效动画"] = 85
	end  
 
  if WAR.JSKW == 1 and DWPD() then
  local aa=math.modf(JY.Person[pid]["用毒能力"]/100)
   hurt = math.modf(hurt * (1+(JY.Person[eid]["中毒程度"]/150*aa)))
   ang=math.modf(ang * (1+(JY.Person[eid]["中毒程度"]/150)))
   end
   
if nglw(pid,89)>1 and PersonKF(pid,89) and DWPD() then --紫霞神功二阶
     local aa=0.015
	 if JY.Person[pid]["内力"]> math.modf(JY.Person[pid]["内力"]* 0.5) then----
	 aa=0.025
	 end
     hurt = hurt+math.modf(JY.Person[pid]["内力"]* aa)
	end
 
 if WAR.DR[pid]~=nil and DWPD() then
    local aa = math.min(WAR.DR[pid],10)
    hurt = hurt + WAR.DR[pid]*25
 end
 

 
   	if nglw(pid,89)>2 and WAR.ZXJY>0 and Curr_NG(pid,89) then --紫霞混沌剑气
       hurt = math.modf(hurt * (1+(WAR.ZXJY/15)))
       dng = math.modf(dng * (1-(WAR.ZXJY/30)))
	   	if dng<=0 then
		  dng=0
		 end
	end
 
   	if nglw(pid,88)>2 and WAR.XXPG>0 and PersonKF(pid,88) then --日月捧月派气攻加成
	   local aa=WAR.XXPG
	   if WAR.XXQF[eid]~=nil and WAR.XXQF[eid]>=0 then
		  dng=dng-WAR.XXQF[eid]*aa
		  if dng<=0 then
		  dng=0
		  end
       end
	   hurt= hurt + math.modf(WAR.XXPG*0.5)
	end
   
  	if nglw(eid,88)>2 and WAR.XXQG[eid]~=nil  and DWPD() and PersonKF(eid,88) then --日月捧月派气防加成
       local aa=10
	   if Curr_NG(eid, 88) then
	   aa=aa+10
	   end 
	   ang = math.modf(ang/2)
	   WAR.XXQG[eid]= (WAR.XXQG[eid] or 0) +math.modf(ang/10)
	   if WAR.XXQF[pid]~=nil and WAR.XXQF[pid]>=0 then
		  dng=dng+WAR.XXQF[pid]*aa
       end
       if WAR.XXQG[eid]~=nil and WAR.XXQF[pid]~=nil then
          hurt = hurt - math.modf((WAR.XXQG[eid] + WAR.XXQF[pid])*0.15)
		  if hurt<0 then
		  hurt = 0
		  end
       end	   
       Set_Eff_Text(enemyid, "特效文字1", "群星捧月·月汇星光")	    
       WAR.Person[enemyid]["特效动画"] = 81	   
	end   
  
  	if nglw(eid,89)>2 and WAR.ZXJQ[eid]~=nil and DWPD() and PersonKF(eid,89) then --紫霄剑气气防加成
       local aa=math.random(5,20)
	   if Curr_NG(eid, 89) then
	   aa=aa*2
	   end
				if WAR.ZXJQ[eid]>aa then
				WAR.ZXJQ[eid]=WAR.ZXJQ[eid]-aa
				else 
				aa=WAR.ZXJQ[eid]
				WAR.ZXJQ[eid]=0
				end	   
       ang=ang-aa*100
	   if ang<0 then
	   ang=0
	   end
	   hurt = math.modf(hurt * (1-(aa/50)))
       Set_Eff_Text(enemyid, "特效文字1", "紫宵御剑.护体")	    
       WAR.Person[enemyid]["特效动画"] = 132	   
	end 

	if wglw(pid,17)>0 and PersonKFJ(pid,17) and DWPD() then --日月捧月派气攻加成
	   if WAR.FXDS[eid]~=nil and WAR.FXDS[eid]>=0 then
		 local aa=WAR.FXDS[eid]
		 dng=dng-50*aa
		  if dng<=0 then
		  dng=0
		  end
		  hurt = hurt + aa*2
       end
	end
	
	if WAR.JGHJ == 90 and DWPD() then
		ang = math.modf(ang * 1.25)
		WAR.HMZT[eid] = 1
	end
	
	if MPPB_SL(pid) == 3 and  JY.Wugong[wugong]["武功类型"] == 2 and (WAR.NGJL>0 or JLSD(10,40+MPDJ(pid)*10,pid)) and DWPD() then--
	   if MPZJ(pid,3)>=1 then
	       if WAR.PJFY[eid]~=nil then
		      WAR.BLX = 1
	          WAR.QBLY[eid] = (WAR.QBLY[eid] or 0) + 5*MPDJ(pid)
			  if MPZJ(pid,3)>=2 then
			   hurt = hurt+math.modf(JY.Person[eid]["受伤程度"]* 0.15*WAR.PJFY[eid])
			  end
	       end
	   end
	   WAR.PJFY[eid] = (WAR.PJFY[eid] or 0) + 5*MPDJ(pid)
	end
	
	if WAR.JSYX == 1 and zylw(3)>2 and DWPD() then
	WAR.BLX = 1
	local aa = math.random(1,3)
	addeffect2(WAR.JHFJ,eid,aa)
    local aa=(WAR.LXZT[eid] or 0)
	local bb= (WAR.JHFJ[eid] or 0)
    local cc=math.modf(aa*bb)   
    WAR.Person[enemyid]["伤害爆裂"] = (WAR.Person[enemyid]["伤害爆裂"] or 0) + cc 
	WAR.JSYX1 = 1
	end

	if WAR.DJGZ2==1 and DWPD() then
	WAR.QSLZ[eid] = 50
	WAR.BPYZ[eid] = 30 
	end	

	if  WAR.TWBL >= 1 then
	WAR.SJSD[eid] = 50
	WAR.BZ[eid] = math.max(WAR.TWBL,(WAR.BZ[eid] or 0))
	end

  if WAR.DFWM2P == 3 and DWPD() then --钻劲附加异常状态
	local yk = 20 + math.modf(JY.Person[pid]["实战"] / 20)
	if JLSD(10, 35, pid) and (WAR.XRZT[eid] == nil or WAR.XRZT[eid] <= 0) then
		WAR.XRZT[eid] = limitX(yk, 0, 50)
	end
	if JLSD(10, 35, pid) and (WAR.QBLY[eid] == nil or WAR.QBLY[eid] <= 0) then
		WAR.QBLY[eid] = limitX(yk, 0, 50)
	end	
	if JLSD(10, 30, pid) and (WAR.QSLZ[eid] == nil or WAR.QSLZ[eid] <= 0) then
		WAR.QSLZ[eid] = limitX(yk, 0, 50)
	end		
	if JLSD(10, 25, pid) and (WAR.L_WNGZL[eid] == nil or WAR.L_WNGZL[eid] <= 0) then
		WAR.L_WNGZL[eid] = limitX(yk, 0, 50)
	end		
	if JLSD(10, 25, pid) and (WAR.L_NOT_MOVE[eid] == nil or WAR.L_NOT_MOVE[eid] <= 0) then
		WAR.L_NOT_MOVE[eid] = 1
	end		
	if JLSD(10, 15, pid) and (WAR.HDQM[eid] == nil or WAR.HDQM[eid] <= 0) then
		WAR.HDQM[eid] = limitX(yk, 0, 50)
	end			
	if JLSD(10, 15, pid) and (WAR.BZ[eid] == nil or WAR.BZ[eid] <= 0) then
		WAR.BZ[eid] = 1
	end			
  end

 if WAR.LHQ_WX == 3 and DWPD() then --五行钻拳
		local yk = 20 + math.modf(JY.Person[pid]["实战"] / 20)
	if JLSD(10, yk, pid) and (WAR.XRZT[eid] == nil or WAR.XRZT[eid] <= 0) then
		WAR.XRZT[eid] = limitX(yk, 0, 50)
	end
	if JLSD(10, yk, pid) and (WAR.QBLY[eid] == nil or WAR.QBLY[eid] <= 0) then
		WAR.QBLY[eid] = limitX(yk, 0, 50)
	end	
	if JLSD(10, yk, pid) and (WAR.QSLZ[eid] == nil or WAR.QSLZ[eid] <= 0) then
		WAR.QSLZ[eid] = limitX(yk, 0, 50)
	end		

	if wglw(pid,1)>1 and  PersonKFJ(pid,23) then --学了七伤拳
		if JLSD(10, yk, pid) and (WAR.SKWJ[eid] == nil or WAR.SKWJ[eid] <= 0) then
		WAR.SKWJ[eid] = limitX(yk, 0, 50)
	    end		

    	if JLSD(10, yk, pid) and (WAR.HDQM[eid] == nil or WAR.HDQM[eid] <= 0) then
		WAR.HDQM[eid] = limitX(yk, 0, 50)
	    end			
	end
	if WAR.LHQ_WX1>0 then
		   WAR.GTSHAQI = WAR.GTSHAQI+ limitX((100+yk) * WAR.LHQ_WX1, 0, 1000)
	       WAR.GTPID2 = pid
	end
  end	 

    if WAR.LYLZ2[pid] ~= nil and WAR.LYLZ2[pid] == 5 then
			    local bb = WAR.LQZ[eid] or 0
				WAR.LQZ[eid] = 0
				WAR.BFXS[eid] = 1
				JY.Person[eid]["冰封程度"]=(JY.Person[eid]["冰封程度"] or 0)+bb
                if JY.Person[eid]["冰封程度"]>100 then----
                JY.Person[eid]["冰封程度"]=100
                end
				WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力",bb*10)
	end

    if WAR.LYLZ2[pid] ~= nil and WAR.LYLZ2[pid] == 1 then
	local bb = math.random(3,5)
			    WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力",-bb)
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",bb*50)
				local aa = math.modf((JY.Person[eid]["灼烧程度"]+JY.Person[pid]["灼烧程度"])*1.25)
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命",-aa)
	end

    if WAR.LYLZ2[pid] ~= nil and WAR.LYLZ2[pid] == 4 then
	   WAR.ICE2[eid] = 1
	end
	
	if WAR.GPQG == 1 and DWPD() then
	   hurt = hurt + math.modf(JY.Person[pid]["内力"]/2)
	end
	
	if WAR.JX_QLJJ == 1 and DWPD()  then
         local aa = math.random(7,8)
		WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -aa);
		if wglw(pid,114)>2 and WAR.ACT ~= WAR.ATNum then
		WAR.LCJY1[pid] = (WAR.LCJY1[pid] or 0) + 1
		end
		if WAR.ACT>1 then
		local SN=math.modf(JY.Person[eid]["内力"]/200)
	    JY.Person[eid]["冰封程度"] = limitX((JY.Person[eid]["冰封程度"] or 0) + SN, 0, 100) 	
		end

		if WAR.ACT>2 then
           WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力",300)
		   WAR.HDQM[eid] = (WAR.HDQM[eid] or 0) + 10
		   WAR.YINFU[pid] = (WAR.YINFU[pid] or 0) + 10
		end

		if WAR.ACT>3 then
           hurt = hurt + math.modf(JY.Person[pid]["内力"]/5)
		end
		
		if WAR.ACT>4 then
			local bb = WAR.LQZ[eid] or 0
			WAR.LQZ[eid] = 0
            WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",-bb*10)
		end	
		if  WAR.JX_QLJJ3>0 then
		QF(WAR.JX_QLJJ3,1,0)
		    WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力",150*WAR.JX_QLJJ3)
			WAR.ACT = 10
		end	
	end

	if WAR.JX_QLJJ == 2 and DWPD() then
         WAR.GTSHAQI = WAR.GTSHAQI + 100;
		 WAR.GTPID2 = pid
		if wglw(pid,114)>2 and WAR.ACT ~= WAR.ATNum then
		WAR.LCJY2[pid] = (WAR.LCJY2[pid] or 0) + 1
		end
		if WAR.ACT>1 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
  	       WAR.LXXS[eid] = 1
	       WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + d, 0, 100)	
		end

		if WAR.ACT>2 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + d, 0, 50)	
		end

		if WAR.ACT>3 then
           WAR.L_WNGZL[eid] = (WAR.L_WNGZL[eid] or 0) + 10
	       WAR.POISON[eid] = (WAR.POISON[eid] or 0) + 10
		end
		
		if WAR.ACT>4 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.YZSG[eid] = limitX((WAR.YZSG[eid] or 0) + d, 0, 50)
		end	
		if  WAR.JX_QLJJ3>0 then
		QF(WAR.JX_QLJJ3,1,0)
		    WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度",WAR.JX_QLJJ3)
			WAR.ACT = 10
		end
	end

	if WAR.JX_QLJJ == 3 and DWPD() then
         hurt = hurt+math.modf(TrueYJ(pid)*0.5)
		if WAR.MJBCJ[eid] ~= nil then
         hurt = hurt*(1+WAR.MJBCJ[eid])
        end		
		if wglw(pid,114)>2 and WAR.ACT ~= WAR.ATNum then
		WAR.LCJY3[pid] = (WAR.LCJY3[pid] or 0) + 1
		end 
		if WAR.ACT>1 then
           WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命",-150)
		end

		if WAR.ACT>2 then
           WAR.QBLY[eid] = (WAR.QBLY[eid] or 0) + 10
		end

		if WAR.ACT>3 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.XRZT[eid]  = limitX((WAR.XRZT[eid] or 0) + d, 0, 50)	
		end
		
		if WAR.ACT>4 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.YZSF[eid] = limitX((WAR.YZSF[eid] or 0) + d, 0, 50)
		end	
		if  WAR.JX_QLJJ3>0 then
		    QF(WAR.JX_QLJJ3,1,0)
		    WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度",WAR.JX_QLJJ3)
			WAR.ACT = 10
		end
	end

	if WAR.JX_QLJJ == 4 and DWPD() then
         ang = ang+math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 10)
		
		if wglw(pid,114)>2 and WAR.ACT ~= WAR.ATNum then
		WAR.LCJY4[pid] = (WAR.LCJY4[pid] or 0) + 1
		end 
		 
		if WAR.ACT>1 then
           local SN=math.modf(JY.Person[eid]["内力"]/200)
	       JY.Person[eid]["灼烧程度"] = limitX((JY.Person[eid]["灼烧程度"] or 0) + SN, 0, 50) 
		end

		if WAR.ACT>2 then
           WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",150)
		   WAR.YANGFU[pid] = (WAR.YANGFU[pid] or 0) + 10
		end

		if WAR.ACT>3 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.HOT[eid]  = limitX((WAR.HOT[eid] or 0) + d, 0, 50)	
		end
		
		if WAR.ACT>4 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.YZSX[eid] = limitX((WAR.YZSX[eid] or 0) + d, 0, 50)
		end	
		
		if  WAR.JX_QLJJ3>0 then
		QF(WAR.JX_QLJJ3,1,0)
		    WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",50*WAR.JX_QLJJ3)	
WAR.ACT = 10			
		end
		
	end

	if WAR.JX_QLJJ == 5 and DWPD() then
         WAR.PJFY[eid] = (WAR.PJFY[eid] or 0)+ 10
		 
		if wglw(pid,114)>2 and WAR.ACT ~= WAR.ATNum then
		WAR.LCJY5[pid] = (WAR.LCJY5[pid] or 0) + 1
		end 
	
		if WAR.ACT>1 then
           local SN=math.modf(JY.Person[eid]["内力"]/200)
	       WAR.KBGJ2[pid] = limitX((WAR.KBGJ2[pid] or 0) + SN, 0, 50) 
		end

		if WAR.ACT>2 then
		   WAR.MLZS[eid] = (WAR.MLZS[eid] or 0) + 10
		end

		if WAR.ACT>3 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.KBGJ[pid]  = limitX((WAR.KBGJ[pid] or 0) + d, 0, 50)	
		end
		
		if WAR.ACT>4 then
	       local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
           if d < 10 then
              d = 10
           end
	       WAR.YZSP[eid] = limitX((WAR.YZSP[eid] or 0) + d, 0, 50)
		end	
		if  WAR.JX_QLJJ3>0 then
		QF(WAR.JX_QLJJ3,1,0)
		    WAR.FXDS[eid] = (WAR.FXDS[eid] or 0) + WAR.JX_QLJJ3
			WAR.FXXS[eid] = 1
			WAR.ACT = 10
		end
	end

if WAR.JX_QLJJ2 > 0 and DWPD() then
    if WAR.JX_QLJJ2 == 1 then
	   if WAR.HMZT[eid]~=nil then
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度",20)
	   WAR.POISON[eid] = 30
	   else
	   WAR.HMZT[eid] = 1
	   end
	   
	elseif WAR.JX_QLJJ2 == 2 then
	   WAR.PBFY[eid] = 30
	   WAR.ATKDOWN[eid] = 30
	elseif WAR.JX_QLJJ2 == 3 then
		   if WAR.BZ[eid]~=nil then
	          WAR.TLQJ2[eid] = 200
		   else
		   WAR.BZ[eid] = 1
	       end
    elseif WAR.JX_QLJJ2 == 5 then
           WAR.LRHF[eid] = (WAR.LRHF[eid] or 0) + 10
           WAR.ICE[eid] = (WAR.ICE[eid] or 0) + 10		   
	else
	WAR.SJSD[eid] = 50
	end
end
	
	if WAR.JGDQ[pid]~=nil then
	   if WAR.MKDS[eid] ~= nil then
	   addeffect2(WAR.MK_XXC,eid,1)
	   addeffect2(WAR.MK_SH,pid,30)
	   end
	   addeffect2(WAR.MKDS,eid,1)
	   							 if WAR.MKDS[eid]>= 7  then
								 WAR.MKDS[eid] = 7
								 end
	   addeffect2(WAR.FXDS,eid,1)
	end
	
	
	if wglw(pid,74)>1 and WAR.SHJG[pid] ~= nil and WAR.SHJG[pid] == 4 and DWPD() and JLSD(10.30,pid) then
 WAR.HMZT[eid] = 1
			end
	
	if wglw(pid,74)>1 and WAR.PLGF >= 1  then
	   local aa = math.modf(JY.Person[eid]["内力"]*0.1)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",-aa)
	   WAR.GTSHAQI = WAR.GTSHAQI + aa
	   
	      if WAR.PLGF == 3 then
		  local bb = math.modf(JY.Person[pid]["内力"]*0.1)
		  WAR.GTSHAQI = WAR.GTSHAQI + bb
		  end
		WAR.GTPID2 = pid
	end

  if WAR.JYBG == 2 and wglw(pid,11)>= 1 and DWPD() then--魔爪
     local SN=math.modf(JY.Person[eid]["内力"]/200)
	 WAR.MENG[eid] = (WAR.MENG[eid] or 0) + SN
	 if wglw(pid,11)>= 2 then
	 WAR.XRZT[eid] = SN
	 	if JLSD(10,40,pid) or wglw(pid,11)>2 then
		addeffect2(WAR.JYZQ,pid,1)
		end	
	 local times = wglw(pid,11)
	 		for i = 1, times do
				local lr = math.random(1,4)
				if lr == 1 then
					WAR.QSLZ[eid] = SN
				elseif lr == 2 then
					WAR.HDQM[eid] = SN
				elseif lr == 3 then
					WAR.QBLY[eid] = SN
				elseif lr == 4 then
					WAR.JHLY3[eid] = SN
				end
		end	 
	 end
	 if wglw(pid,11)>2 then	
     WAR.ICE[eid] = (WAR.ICE[eid] or 0) + SN	 
	 local times2 = 2
	 		for i = 1, times2 do
				local lr2 = math.random(1,4)
				if lr2 == 1 then
					WAR.LRHF[eid] = (WAR.LRHF[eid] or 0)+ SN
				elseif lr2 == 2 then
					WAR.JHLY[eid] = (WAR.JHLY[eid]  or 0)+ SN
				elseif lr2 == 3 then
					WAR.L_WNGZL2[eid] = (WAR.L_WNGZL2[eid]  or 0) + SN
				elseif lr2 == 4 then
					WAR.POISON[eid] = (WAR.POISON[eid]  or 0) + SN
				end
		end	
	
	 end
  end

  if WAR.JYBG == 1 and wglw(pid,11)>= 2 and DWPD() then--神爪
     local SN=math.modf(JY.Person[eid]["内力"]/200)
		 local times = wglw(pid,11)
				local lr = math.random(1,3)
				if lr == 1 then
					WAR.BHJS2[pid] =  SN
					WAR.MLZS[eid] = (WAR.MLZS[eid] or 0) + SN
				elseif lr == 2 then
					WAR.BHJS[pid] =  SN
				elseif lr == 3 then
					WAR.MZLL[pid] = SN
					WAR.MZLL2[eid] = SN
				end
		WAR.GTSHAQI = WAR.GTSHAQI + 1
		WAR.GTPID2 = pid
		if JLSD(10,40,pid) or wglw(pid,11)>2 then
		addeffect2(WAR.JYZQ,pid,1)
		end	
	 if wglw(pid,11)> 2 then
        local dd = JY.Person[eid]["中毒程度"]+JY.Person[eid]["受伤程度"]+JY.Person[eid]["灼烧程度"]+JY.Person[eid]["冰封程度"]+(WAR.CHZ[eid] or 0) + (WAR.MBZ[eid] or 0) +(WAR.LXZT[eid] or 0) + (WAR.FXDS[eid] or 0)
		WAR.GTSHAQI = WAR.GTSHAQI + dd
		WAR.GTPID2 = pid
		hurt = hurt +dd
	 end
  end

    if  WAR.JYWR_CF >= 1 and DWPD() then
	    local d = math.modf((JY.Person[pid]["内力"] ) / 50)
		hurt = hurt + d
	end

if WAR.WJJS == 2 and DWPD() then --三环套月
   local aa = WAR.CYZY[pid] or 0  
   hurt = math.modf(hurt * (1.5 + (aa*0.05)))
end

if WAR.WJJS >0 and MPZJ(pid,2)>2 and DWPD() then --三环套月
   local aa = WAR.CYZY[pid] or 0  
   hurt = hurt + aa*50
end




	if nglw(pid,166)>2 and WAR.BHJS[pid]~=nil and DWPD() then--
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   if JY.Person[eid]["受伤程度"]>0 then
	   WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -d)
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",d*30)
	   end
	   local dd = d *2
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", dd)
	end

    if WAR.ZJZC == 3 and DWPD() then
	   WAR.PBFY[eid] = 20
	   WAR.NKZT[eid] = 20
	end

    if (WAR.LZPX == 1 or  WAR.LZPX == 5) and DWPD() then
	  WAR.WMYH[eid] = (WAR.WMYH[eid] or 0) + 20
	  WAR.JHLY3[eid] = (WAR.JHLY3[eid] or 0) + 20
	  if nglw(pid,103)>2 then
	  WAR.JHLY2[eid] = 30
	  end
	end
    
    if (WAR.LZPX == 2 or  WAR.LZPX == 5) and DWPD() then
	  WAR.HDQM[eid] = (WAR.HDQM[eid] or 0) + 20
	  if nglw(pid,103)>2 then
	  WAR.LRHF[eid] = 30
	  end
	end
 

    if (WAR.LZPX == 4 or WAR.LZPX == 5) and DWPD() then	
      WAR.TLQJ[eid] = limitX((WAR.TLQJ[eid] or 0)+hurt,0,300)
    end

    if WAR.HBMZ >= 1 and DWPD() then	
	   if WAR.HBMZ >= 2  then
	      local aa = WAR.HBYJ[eid] or 0
		    WAR.PJZT[eid] = 10*aa
  		    if WAR.PJJL[eid] == nil then
			   WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		    end
			 for j = 0, WAR.PersonNum - 1 do
			  local tmppid = WAR.Person[j]["人物编号"]
		       if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and WAR.Person[j]["人物编号"]~= pid and RealJL(enemyid, j, 3+MPDJ(eid)) then
		          WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) + AddPersonAttrib(tmppid, "内力", -aa*50)
		          WAR.LRHF[tmppid] = limitX((WAR.LRHF[tmppid] or 0) + aa*5, 0, 50)
				    if WAR.HBMZ >= 3 then
			           local dd = WAR.HBYJ[tmppid] or 0
					   WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -dd*20)
					   WAR.HBYJ[tmppid] = nil
			        end
		       end
	          end
			WAR.HBYJ[eid] = nil
	   end
      WAR.HBYJ[eid] = limitX((WAR.HBYJ[eid] or 0)+1,0,3+wglw(pid,5)*3)
	  if WAR.LRHF[eid]~=nil then
	  WAR.HBYJ[eid] = limitX((WAR.HBYJ[eid] or 0)+1,0,3+wglw(pid,5)*3)
	  end
			  if WAR.HBMZ >= 3 then
			  WAR.HBYJ[eid] = limitX((WAR.HBYJ[eid] or 0)+3,0,3+wglw(pid,5)*3)
			  end
    end
---醉八仙效果
   if WAR.ZBXZ>0 and DWPD() then
      if WAR.ZBXZ == 2 then
         WAR.SH[eid] = 20
       end
      if WAR.ZBXZ == 3 then
         WAR.YZSX[eid] = 20
      end
      if WAR.ZBXZ == 3 then
         WAR.BYCX[eid] = 20
      end
   end

   if WAR.MYJY >= 1 and DWPD() then
      WAR.ATKDOWN[eid] = (WAR.ATKDOWN[eid] or 0) + 10
	  if WAR.MYJY >= 2  then
	  WAR.DEFDOWN[eid] = (WAR.DEFDOWN[eid] or 0) + 10
	     if WAR.ATKDOWN[eid]>=50 and WAR.DEFDOWN[eid]>=50 then
		 WAR.XRZT[eid] = (WAR.XRZT[eid] or 0) + 10
		 end
	  end
	  if WAR.MYJY >= 3  then
      WAR.SPDDOWN[eid] = (WAR.SPDDOWN[eid] or 0) + 10
	  	 if WAR.SPDDOWN[eid]>=50 then
		 WAR.L_NOT_MOVE[eid] = 1
		 WAR.MENG[eid] = (WAR.MENG[eid] or 0) + 10
		 end
	  end
	  if WAR.MYJY >= 4  then
      WAR.UNLUCK[eid] = (WAR.UNLUCK[eid] or 0) + 10
	  	 if WAR.UNLUCK[eid]>=50 then
		 WAR.SJSD[eid] = (WAR.SJSD[eid] or 0) + 10
		 end
	  end
	  if WAR.MYJY >= 5  then
      WAR.SH[eid] = (WAR.SH[eid]  or 0) + 10
	  	 if WAR.SH[eid]>=50 then
		 WAR.BZ[eid] = 1
		 end
	  end
   end


    if  WAR.JYWR_CF >= 1 and DWPD() then
	    WAR.JYWR[eid] = (WAR.JYWR[eid] or 0) + 1
        if WAR.JYWR_CF == 2  then
		   if WAR.JYWR_XF[eid] == nil then
		   	WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + 10, 0, 100)
	        WAR.LXXS[eid] = 1
		   else
           WAR.JYWR_XF[eid] = 1
		   end
        end
        if WAR.JYWR_CF == 3  then
        WAR.JYWR_JH[eid] = 50
        end	
        if WAR.JYWR_CF == 4  then
        WAR.JYWR_JH2[eid] = 50
        end			
	end

--天罡气劲debuff
	if WAR.TZQJ == 5 and yongnei(wugong) and DWPD() then
	   local SN=math.modf(JY.Person[eid]["内力"]/200)
	   JY.Person[eid]["灼烧程度"] = limitX((JY.Person[eid]["灼烧程度"] or 0) + SN, 0, 50)
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",SN*5)
	end	
	
	if WAR.TZQJ == 8 and yongnei(wugong) and DWPD() then
		WAR.GTSHAQI = WAR.GTSHAQI + 100
		WAR.GTPID2 = pid
	end	

    if WAR.HYS == 1 and DWPD() then
	    if WAR.JHLY2[eid]~=nil then
		JY.Person[eid]["灼烧程度"] = limitX((JY.Person[eid]["灼烧程度"] or 0) + WAR.JHLY2[eid], 0, 50)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",WAR.JHLY2[eid]*5)
		end
	    WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + 10, 0, 50)
	end

	
    if WAR.YYDAO_PK == 1 and DWPD()  then
 		WAR.GTSHAQI = WAR.GTSHAQI + 100
		WAR.GTPID2 = pid      
    end	
	
    if WAR.YYDAO_HB == 1 and DWPD()  then
       WAR.LSQ[eid] = (WAR.LSQ[eid] or 0) + 10
       	   
    end	

	if WAR.XLDF == 2 and DWPD() then
		WAR.GYZ[eid] = WAR.XLBD
	end	

    if WAR.DGXF_KQ == 1  then
       local aa = JY.Person[eid]["中毒程度"]
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命",-aa*2)
	   JY.Person[eid]["中毒程度"] = 0
	   WAR.CHZ[eid] = limitX((WAR.CHZ[eid] or 0) + aa, 0, 100)
	   WAR.CHXS[eid] = 1
	   WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + aa, 0, 100)
	   WAR.LXXS[eid] = 1
    end

   if WAR.TONY2 ==1 and DWPD() then
	   if YCDJ(pid) >3 and ((JY.Person[eid]["生命"]<=math.modf(JY.Person[eid]["生命最大值"])*0.2 or JY.Person[eid]["内力"]<=math.modf(JY.Person[eid]["内力最大值"])*0.1) or (WAR.BDYJ[eid]~=nil and WAR.BDYJ[eid]>5 ))then
	   WAR.BZSC[eid] = 25
	   end
       if JY.Person[eid]["灼烧程度"]>25 or (WAR.LHYJ[eid]~=nil and WAR.LHYJ[eid]>=3) then
	   WAR.BDYJ[eid] = (WAR.BDYJ[eid] or 0) + 1
	   end
   end

				if WAR.WYSQ>0 and wugong == 63 and DWPD()  then
	            WAR.XQZZ[eid] = limitX((WAR.XQZZ[eid] or 0) + 1, 0, 10)
	            end

	if WAR.YYJ[pid]~=nil and WAR.YYJ[pid]==2 and WAR.TJYQ1 == 2 then
	   WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + 10, 0, 50)
	   if WAR.JHLY2[eid] >= 35  then
	   WAR.HOT2[eid] = 1
	   end
	end
	
--天罡气劲buff	
	if WAR.TZQJ == 6 and yongnei(wugong) and DWPD() then
		WAR.TJYM[pid] = 30
	end	
    if WAR.TZQJ == 9 and yongnei(wugong) and DWPD() then----乾坤天罡气劲
        WAR.MZLL2[eid] = 50
	end	
----弹指气劲的负面debuff
	if WAR.TZQJ == 4 and wugong == 18 and DWPD() then
		WAR.HMZT[eid] = 1
	end
	

	
	if WAR.TZQJ == 20 and (wugong == 18 or yongnei(wugong) )  then----逆运弹指气劲
        WAR.BHJS2[pid] = 50
		local aa=JY.Person[eid]["中毒程度"]+JY.Person[eid]["受伤程度"]+JY.Person[eid]["灼烧程度"]+JY.Person[eid]["冰封程度"]
        WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",aa)
	end	
	
	if WAR.TZQJ == 5 and wugong == 18 and DWPD() then
		WAR.JHLY2[eid] = (WAR.JHLY2[eid] or 0) + 15
	end
	
	if WAR.TZQJ == 6 and wugong == 18 then
		WAR.PJFY[eid] = (WAR.PJFY[eid] or 0) + 15
	end
	
	if WAR.TZQJ == 8 and wugong == 18 then
		WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 15
	end
	
	if WAR.TZQJ == 7 and wugong == 18 then
      WAR.L_WNGZL[eid] = (WAR.L_WNGZL[eid] or 0) + 10
	  WAR.POISON2[eid] = (WAR.POISON[eid] or 0) + 10
	end

	if WAR.TZQJ == 12 and wugong == 18 then----先天弹指气劲
        WAR.L_HQNZL[pid] = math.random(3,6)*10
	end
 
 	if WAR.TZQJ == 12 and yongnei(wugong) then----先天弹指气劲
        WAR.L_HQNZL[pid] = math.random(3,6)*10
	end
 
 	if WAR.TZQJ == 15 and (wugong == 18 or yongnei(wugong) ) then----龙象弹指气劲
		WAR.POISON[eid] = (WAR.POISON[eid] or 0) + 10
		WAR.JHLY3[eid] = (WAR.JHLY3[eid] or 0) + 15
	end
	
	if WAR.TZQJ == 16 and (wugong == 18 or yongnei(wugong) ) then----逆运弹指气劲
        WAR.PJZT[eid] = 50
				if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
		WAR.LSQ[eid] = 30
	end

	if WAR.TZQJ == 18 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----九阳弹指气劲
        WAR.HOT[eid] = 20
	end	
	
	if WAR.TZQJ == 19 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----九阴弹指气劲
        WAR.YHDF[eid] = 1
	end

	if WAR.TZQJ == 22 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----玉女弹指气劲
       WAR.LRHF[eid] = 30
	   WAR.ICE[eid] = 20
	end
	
	if WAR.TZQJ == 24 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----血河弹指气劲
       addeffect2(WAR.XQZZ, eid, 1)
	end

	if WAR.TZQJ == 27 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----太极弹指气劲
       WAR.BZ[eid] = 1
	end

	if WAR.TZQJ == 28 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----太极弹指气劲
       WAR.MENG[eid] = 30
	end	

	if WAR.TZQJ == 25 and (wugong == 18 or yongnei(wugong) )and DWPD() then----逆运弹指气劲
       WAR.BHJS[pid] = 50
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力",500)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",-500)
	end
	
	if WAR.TZQJ == 29 and wugong == 18 and DWPD() then----落英弹指气劲
	   local nlDam = math.modf((WAR.LXZT[eid] or 0)*1.25)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -nlDam)
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
  	   WAR.LXXS[eid] = 1
	   WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + d, 0, 100)
	end	

	if WAR.TZQJ == 30 and wugong == 18 and DWPD() then----魔音弹指气劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + d, 0, 50)
	   local dd = d *10
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -dd)
	end	

	if WAR.TZQJ == 31 and wugong == 18 and DWPD() then----飞石弹指气劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.YZSP[eid] = limitX((WAR.YZSP[eid] or 0) + d, 0, 50)
	   local dd = d *2
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", dd)
	end	

	if WAR.TZQJ == 33 and wugong == 18 and DWPD() then----幽兰弹指气劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.FXDS[eid] = limitX((WAR.FXDS[eid] or 0) + d, 0, 100)
	   WAR.FXXS[eid] = 1
	   WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + d, 0, 100)
	end	

	if WAR.TZQJ == 33 and yongnei(wugong) and DWPD() then----金关弹指气劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.JSCL[eid] = limitX((WAR.JSCL[eid] or 0) + d, 0, 100)
	end	

	if WAR.TZQJ == 34 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----金关弹指气劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.MLZS[eid] = limitX((WAR.MLZS[eid] or 0) + d, 0, 100)
	end	
	
	if WAR.TZQJ == 35 and (wugong == 18 or yongnei(wugong) ) and DWPD() then----寒冰弹指气劲
       WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0) + 10, 0, 100)
	   WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + 10, 0, 100)
	end		

	if WAR.WDLH2 == 1 and DWPD() then --烈风腿
	   local nlDam = math.modf((WAR.LXZT[eid] or 0)*1.25)
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
  	   WAR.LXXS[eid] = 1
	   WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + d, 0, 100)
	end			
	
	if WAR.WDLH2 == 2 and DWPD() then --旋风腿
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.YZSP[eid] = limitX((WAR.YZSP[eid] or 0) + d, 0, 50)
	   local dd = d *2
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", dd)
	 	   WAR.GTSHAQI = WAR.GTSHAQI+200
	       WAR.GTPID2 = pid
	end		

	if WAR.WDLH2 == 3 and DWPD() then --狂风腿
	   WAR.LHFM[eid] = limitX((WAR.LHFM[eid] or 0) + 15,0,30)
	   if  JLSD(10,30,pid) and WAR.HMZT[eid] == nil then
	   WAR.HMZT[eid] = 1
	   end
	   WAR.GTJIQI = limitX(WAR.GTJIQI+200,0,500)
	   WAR.GTPID = pid
	end	

	if WAR.BFTX == 2 and DWPD() then --胧刀
	   local nlDam = math.modf((WAR.LXZT[eid] or 0)*1.25)
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
  	   WAR.YHDF[eid] = 1
	   local dd = d *2
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", dd)
	   WAR.GTSHAQI = WAR.GTSHAQI+200
	   WAR.GTPID2 = pid
	end			
	
	if WAR.BFTX == 3 and DWPD() then --梦霞
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.MENG[eid] = (WAR.MENG[eid] or 0) + d
	   if WAR.MENG[eid]>= 50then
	   WAR.MENG[eid] = 50
	   WAR.CSZT[eid] = 1
	   end

	end		

	if WAR.BFTX == 4 and DWPD() then --细雪
	   WAR.LHFM[eid] = limitX((WAR.LHFM[eid] or 0) + 15,0,30)
       WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + 20, 0, 100)
	end	
	
	if WAR.DFWM2P == 2 and DWPD() then --炮捶劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.YZSP[eid] = limitX((WAR.YZSP[eid] or 0) + d, 0, 50)
	   local dd = d *2
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", dd)
	 	   WAR.GTSHAQI = WAR.GTSHAQI+200
	       WAR.GTPID2 = pid
	end	

    if WAR.DSXF == 2 and DWPD() then
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   local dd = d *2
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", dd)
    end	

    if WAR.DSXF == 3 and DWPD() then
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   local dd = d *2
	   WAR.LSQ[eid] = limitX((WAR.LSQ[eid] or 0) + 20, 0, 100)
    end	

    if WAR.DSXF == 4 and DWPD() then
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   local dd = d *2
	   WAR.JHLY2[eid] = dd
    end		

	if WAR.LM_JQ1 == 3 then
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   local dd = d *2
	   WAR.HDQM[eid] = dd	
	end

	if WAR.LM_JQ1 == 2 then
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   local dd = d *2
	   WAR.QBLY[eid] = dd	
	end

	if WAR.LM_JQ1 == 6 then
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   local dd = d *2
	   WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + 20, 0, 100)	
	end

	if  WAR.LHQ_WX == 5 and DWPD() then --炮劲
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + d, 0, 50)
	   if wglw(pid,1) > 1 and PersonKFJ(pid,8) then
	   local dd = d *2
	   WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + 20, 0, 100)
	 	   WAR.GTSHAQI = WAR.GTSHAQI+200
	       WAR.GTPID2 = pid
	   end
	   if WAR.LHQ_WX1>0 then
          WAR.BJ = 1
	   end
	end	

	if  WAR.LHQ_WX == 4 and DWPD() then --炮劲
	   local d = math.modf((JY.Person[pid]["攻击力"] ) / 10)
       if d < 10 then
          d = 10
       end
	   WAR.KBGJ3[eid] = limitX((WAR.KBGJ3[eid] or 0) + d, 0, 50)
	   if wglw(pid,1) > 1 and PersonKFJ(pid,26) then
       WAR.KBGJ[pid] = limitX((WAR.KBGJ3[pid] or 0) + d, 0, 50)
	   end
	   if WAR.LHQ_WX1>0 then
        local nlDam = math.modf(JY.Person[eid]["生命最大值"]*0.05*WAR.LHQ_WX1)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -nlDam)
	   end
	end	

	if WAR.DFWM2P == 3 and DWPD() then --炮捶劲
	   WAR.MENG[eid] = 30
	   if  JLSD(10,30,pid) and WAR.HMZT[eid] == nil then
	   WAR.HMZT[eid] = 1
	   end
	   WAR.GTJIQI = limitX(WAR.GTJIQI+200,0,500)
	   WAR.GTPID = pid
	end		
	
	  if WAR.WMSF == 3  and DWPD() then
	  WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + 20, 0, 50)
	  WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + 20, 0, 50)
	  end
	  
	if WAR.LSDF == 4 and DWPD() then
		WAR.LRHF[eid] = 20
	end	  

		if WAR.LSDF == 6 and DWPD() then
		zhanyi(eid, -3)
		end

    if wugong == 134 and wglw(pid,134)>1 and DWPD() then
		if WAR.L_WNGZL3[eid]~=nil then
		WAR.XQZZ[eid] = limitX((WAR.XQZZ[eid] or 0) + 1, 0, 10)
		end
        if WAR.LXZT[eid]~=nil and JLSD(10,70,pid) then
           WAR.L_WNGZL3[eid] = limitX((WAR.L_WNGZL3[eid] or 0) +10 , 0,50)			   
		end
     end
	  
-----------------------------------------------------------------
      if WAR.BLC>0 and DWPD() then
	     if WAR.BLC == 1 then
		 WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + 20, 0, 50)
		 end
		 if WAR.BLC == 2 then
		 WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + 20, 0, 50)
		 end
		 if WAR.BLC == 3 then
		 WAR.WMYH[eid] = limitX((WAR.WMYH[eid] or 0) + 20, 0, 50)
		 end
		 if WAR.BLC == 4 then
		 WAR.NKZT[eid] = limitX((WAR.NKZT[eid] or 0) + 20, 0, 50)
		 end		 
		 if WAR.BLC == 6 then
		 WAR.L_NOT_MOVE[eid] = 1
		 end		 	 
	  end

    if WAR.SXB>0 and DWPD()  then
	     if WAR.SXB == 1 then
		    if WAR.L_NOT_MOVE[eid]~=nil then
			WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + 20, 0, 50)
			else
		    WAR.L_NOT_MOVE[eid] = 1
		    end
		 end
		 if WAR.SXB == 2 then
		 WAR.JCGD[eid] = 1
		 WAR.JJGD[eid] = 3
		 end
		 if WAR.SXB == 3 then
		 WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0) + 20, 0, 50)
		 end
		 if WAR.SXB == 4 then
		 WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + 20, 0, 50)
		 end		 
	end

if WAR.WJJS>=1 and DWPD()then
   WAR.CYJY[eid] = limitX((WAR.CYJY[eid] or 0) + 1, 0, 5)  
end

if WAR.WJJS == 3 and DWPD() then --八荒归元
   local aa = 0
   if WAR.CYJY[eid]~=nil  then
   aa = 50 * WAR.CYJY[eid]  
   end
   if MPZJ(pid,2)>2 then
   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa*10)
   end
   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa)
end

if WAR.WJJS == 4 and DWPD() then --万剑归宗
   local aa = 0
   if WAR.CYJY[eid]~=nil  then
   aa = WAR.CYJY[eid] *10 
   end
   WAR.JCYY[pid] = aa
   WAR.DEFDOWN[eid] = aa
   if MPZJ(pid,2)>2 then
   WAR.ATKUP[pid] = aa
   WAR.JCYY1[eid] = aa
   end
end

if WAR.WJJS == 5 and DWPD() then --无我无剑
   WAR.JCYY2[eid] = limitX((WAR.JCYY2[eid] or 0) + 1, 0, 5)  
end

--------------------------------------------		
	
    if WAR.WDMZ2> 0 and wugong == 3  and DWPD()then
	   if WAR.WDMZ2 ==3 then
	      WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + 30, 0, 100)
		  WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -300)
	   elseif WAR.WDMZ2 ==2 then
	   WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + 20, 0, 50)
	   WAR.SJSD[eid] = limitX((WAR.SJSD[eid] or 0) + 20, 0, 50)
	   else
	   WAR.QBLY[eid] = limitX((WAR.QBLY[eid] or 0) + 20, 0, 50)
	   WAR.YZSX[eid] = limitX((WAR.YZSX[eid] or 0) + 20, 0, 50)
	   end
	   WAR.L_WNGZL2[eid] = 20
	   WAR.L_HQNZL[pid] = 20 
	   WAR.JJGD[eid] = 2
	   WAR.JCGD[eid] = 1
	   WAR.WDMZ2 = 0
	end

    if WAR.WDMZ4> 0 and wugong == 3  and DWPD() then
       WAR.XHDZ[eid] = (WAR.XHDZ[eid] or 0) + WAR.WDMZ4
	   WAR.JJGD[eid] = 3
	   WAR.JCGD[eid] = 1
	   WAR.WDMZ4 = 0
	end
	
-------------------------------------------------------------	

   if WAR.ZYHB ==  2  and (WAR.HDMC == 8 or  WAR.HDMC2 == 8) and DWPD() then --胡刀双龙
       WAR.L_WNGZL[eid] = 30
	  WAR.POISON[eid] = 30
	  WAR.L_HQNZL[pid] = 30 
   end
	
	if (WAR.HDMC == 1 or  WAR.HDMC2 == 1) and DWPD() then
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(12, 15));
	   WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 15
	   if  JLSD(10,50,pid) and WAR.HMZT[eid] == nil then
	   WAR.HMZT[eid] = 1
	   end
	end
	
	if (WAR.HDMC == 5 or  WAR.HDMC2 == 5) and DWPD() then
      local shanghai=math.random(1,2)
	  local bb = math.modf(JY.Person[eid]["耍刀技巧"]/10)
       JY.Person[eid]["中毒程度"]=JY.Person[eid]["中毒程度"]+bb		
	   hurt=hurt+math.modf(shanghai*JY.Person[eid]["中毒程度"]*bb/20)
	   WAR.QSLZ[eid] = 30
	   WAR.XRZT[eid] = 30
	end	
	
	if (WAR.HSDF_DF1 == 4) and DWPD() then
      local shanghai=math.random(1,2)	
	   hurt=hurt+math.modf(shanghai*JY.Person[eid]["中毒程度"]/20)
	   WAR.L_WNGZL[eid] = 30
	   WAR.POISON[eid] = 30
	end		
	
  if WAR.SHAOLIN2 == 1 and DWPD() then
    hurt = math.modf(hurt * 1.25)
	WAR.FMZZ[eid]=(WAR.FMZZ[eid] or 0)+30
	if WAR.BJ==1 then
	hurt = math.modf(hurt * 1.5)
	end
  end	
	
	
	if (WAR.HDMC == 4 or  WAR.HDMC2 == 4) and DWPD() then
	   local SN=math.modf(JY.Person[pid]["耍刀技巧"]/4)
	   JY.Person[eid]["冰封程度"] = limitX((JY.Person[eid]["冰封程度"] or 0) + SN, 0, 100)
	   local aa = math.random(1,2)
	   if aa == 1 then----
	   WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + SN, 0, 100)
	   end
	   if aa == 2 then----
	   WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0) + math.modf(0.5*SN), 0, 100)
	   end
	   WAR.TXXS[eid] = 1
	end	
	
	if (WAR.HDMC == 3 or  WAR.HDMC2 == 3) and DWPD() then
       addeffect2(WAR.XQZZ, eid, 1)
	   WAR.YZSF[eid] = 30
	   WAR.QBLY[eid] = 40   
	end
	
	if (WAR.HDMC == 5 or  WAR.HDMC2 == 5) and DWPD() then
	  local aa = math.modf(JY.Person[pid]["耍刀技巧"]* 0.15)+math.modf(JY.Person[pid]["攻击力"]* 0.05)
      hurt = hurt + aa
	end

   if (WAR.HDMC == 9 or  WAR.HDMC2 == 9) and DWPD() then --胡刀双龙
   local SN=math.modf(JY.Person[pid]["耍刀技巧"]/4)
   WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + SN, 0, 100)
   end	
	
-------------------------------------------------------------

    if WAR.ARZS == 6 and wugong == 25 and wglw(pid,25)>1 and DWPD() then
       WAR.YHDF[eid] = 1
    end	

    if WAR.ARZS == 5 and wugong == 25 and wglw(pid,25)>1 and DWPD() then
       WAR.LSQ[eid] = 30
	   WAR.PJZT[eid] = 50
	   		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
    end	

	if  WAR.ARJY_LZ == 3 and wugong == 25 and wglw(pid,25)>2 and DWPD() then
        zhanyi(eid,-1)
        zhanyi(pid,0.5)
        hurt = hurt+math.max(math.modf(WAR.SPIRIT[pid]-WAR.SPIRIT[eid]),0)*30
        if WAR.SPIRIT[eid]<100  then
        WAR.JSCL[eid] = (WAR.JSCL[eid] or 0) + 10
        end 		
	end

	if  WAR.ARJY_LZ == 4 and wugong == 25 and wglw(pid,25)>2 and DWPD() then
        WAR.CSZT[eid] = 1
        WAR.CSSX[eid] = 1		
	end

	if  WAR.ARJY_LZ == 2 and wugong == 25 and wglw(pid,25)>2 and DWPD() then
        hurt = hurt+math.modf(ang *0.1) 
	end
	
	if  WAR.ARJY_LZ == 6 and wugong == 25 and wglw(pid,25)>2 and DWPD() then
	   local aa=math.max(math.modf(JY.Person[eid]["内力"]*0.1),100)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa)	
	   local bb = math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])* 0.015)+math.modf(JY.Person[pid]["攻击力"]* 0.05)     
       if bb == 100 then
       bb = bb *2
       end
       hurt = hurt + bb	   
	end

    if WAR.THSB == 1 and DWPD()  then
	   hurt = hurt+math.modf(sixi(pid,1) *1.25) 
	   if WAR.LXZT[eid]~=nil then
	   hurt = hurt+math.modf(sixi(pid,1) *1.25) 
	   end	
	end

    if WAR.THSB == 4 and DWPD()  then
       WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 15	
	end

	if wglw(pid,12)>1 and (WAR.LYBF==3 or WAR.LYBF==1) and DWPD() then
	   WAR.QBLY[eid]=30
	end
	
	if wglw(pid,126)>2 and WAR.XLMH == 1 and DWPD()  then
       WAR.ZLBH[eid] = (WAR.ZLBH[eid] or 0) +1	
	end

	if wglw(pid,126)>2 and WAR.XLMH == 2 and DWPD()  then
       WAR.XSBL[eid] = (WAR.XSBL[eid] or 0) +1	
	end

	if wglw(pid,126)>2 and WAR.XLMH == 3 and DWPD()  then
       WAR.BAHK[eid] = (WAR.BAHK[eid] or 0) +1	
	end	
	
	if wglw(pid,38)>=1 and JY.Wugong[wugong]["武功类型"]==3 and DWPD() and JLSD(10,40+math.modf(TrueYJ(pid)* 0.1),pid) then
       WAR.JSCL[eid] = (WAR.JSCL[eid] or 0) + 20
	   local aa=math.modf(JY.Person[eid]["内力"]*0.1)
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa)
	end

  if wglw(pid,43)>1 and yongdao(wugong) and WAR.DZXY == 1 then
		WAR.ASKD1 = 1
		if WAR.LQZ[eid]~=nil then
		local aa = WAR.LQZ[eid] or 0
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa)
		end
		if wglw(pid,43)>2 then
		WAR.JHLY2[eid] = (WAR.JHLY2[eid] or 0) + 20
		end
	end	

    if WAR.KHSL == 1 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 2 ) and DWPD() then----葵花梦弹
	local SN=math.modf(JY.Person[pid]["内力"]/100)
       WAR.MENG[eid] = (WAR.MENG[eid] or 0) +SN
	   WAR.LSQ[eid] = (WAR.LSQ[eid] or 0) + SN
	end	

    if WAR.KUIHUADZ == 1 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 2 ) and DWPD() then
	   WAR.SH[eid] = 50
	   WAR.JHLY2[eid] = 30
	   WAR.PJZT[eid] = 30
	   		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
	end

    if WAR.KHSL == 2 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 2 ) and DWPD() then----葵花豺华
	local SN=math.modf(JY.Person[eid]["内力"]/100)
       WAR.HDQM[eid] = (WAR.HDQM[eid] or 0) +SN
	end	

   

    if WAR.KHSL == 3 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 2 ) and DWPD() then----葵花焰瓯
	local SN=math.modf(JY.Person[eid]["内力"]/100)
       WAR.XRZT[eid] = limitX((WAR.XRZT[eid] or 0) + SN, 0, 50)
	   WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + SN, 0, 50)
	   if WAR.LRHF[eid]~=nil then
	   WAR.BJ = 1
	   end
	end	

   if WAR.KUIHUADZ == 2 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 1 ) and DWPD() then
      local SN=math.modf(JY.Person[eid]["内力"]/2)
	  local SN2 = math.modf(JY.Person[eid]["内力"]/20)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -SN2)--攻击被裁决者的赏金
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -SN)
	end

    if WAR.KHSL == 4 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 1 )and DWPD() then----葵花荒咬
	local SN=math.modf(JY.Person[eid]["内力"]/200)
       WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + SN, 0, 50)
	
	end	

    if WAR.KHSL == 5 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 1 ) and DWPD() then----葵花九伤
	local SN=math.modf(JY.Person[pid]["内力"]/200)
       WAR.YZSX[eid]=limitX((WAR.YZSX[eid] or 0) + SN, 0, 50)
	   WAR.PJZT[eid] = limitX((WAR.PJZT[eid] or 0) + SN, 0, 50)
	   		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
	end	

    if WAR.KHSL == 6 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 1 ) and DWPD() then----葵花八獍
	local SN=math.modf(JY.Person[pid]["内力"]/200)
       WAR.POISON[eid] = SN
       WAR.ASKD1 = 1
	end

   if WAR.KUIHUADZ == 3 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 5 ) and DWPD() then
      local SN=math.modf(JY.Person[eid]["内力"]/200)
      WAR.WGSD[eid] = SN
	  WAR.SJSD[eid] = SN
	end

   if WAR.KUIHUAHJ == 1 and DWPD() then
      local SN=math.modf(JY.Person[eid]["内力"]/200)
      WAR.WFHT[eid] = SN
	  addeffect2(WAR.YIN,pid,2)
	end
	
   if WAR.KUIHUAHJ == 2 and DWPD() then
      local SN=math.modf(JY.Person[eid]["内力"]/200)
      WAR.JHLY[eid] = SN
	  addeffect(WAR.YANG,pid,2)
	end	


   if WAR.KUIHUAHJ == 3  and DWPD() then
      local SN=math.modf(JY.Person[eid]["内力"]/200)
      WAR.NWSS[eid] = SN
	  WAR.NWHD[pid] = JY.Person[eid]["天赋内功"]
	  WAR.NWCX[pid] = SN
	  addeffect(WAR.BZ,eid,1)
	  addeffect2(WAR.XING,pid,2)
	end

    if WAR.KHSL == 7 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 5 )and DWPD() then----葵花息吹
	local SN=math.modf(JY.Person[pid]["内力"]/200)
       WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + SN, 0, 50)
	   WAR.GTSHAQI = WAR.GTSHAQI + SN*4
	   WAR.GTPID2 = pid
	   WAR.L_WYJFA4 = 1
	end	

    if WAR.KHSL == 8 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 5 ) and DWPD() then----葵花天瑞
	local SN=math.modf(JY.Person[pid]["内力"]/200)
       WAR.UNLUCK[eid]=limitX((WAR.UNLUCK[eid] or 0) + SN, 0, 50)
	   WAR.PJZT[eid] = limitX((WAR.PJZT[eid] or 0) + SN, 0, 50)
	   		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
	end	

    if WAR.KHSL == 9 and (wugong == 105 or JY.Wugong[wugong]["武功类型"]== 5 ) and DWPD() then----葵花玉响
       WAR.BZ[eid] = 2
	   WAR.JGHJ = 90
	end
	
	if  WAR.DZDJ1>0 and DWPD() then--阴阳倒转刃领悟雷刀
	local SN=math.modf(JY.Person[eid]["内力"]/200)
	 WAR.MBZ[eid] = limitX((WAR.MBZ[eid] or 0) + SN, 0, 100)
	 WAR.MBXS[eid] = 1

	   if WAR.DZDJ1 == 2 then----
	   local aa = WAR.MBZ[eid] or 0
	   
	      if JY.Person[eid]["灼烧程度"]+aa >= 50 then
		  local bb = JY.Person[eid]["灼烧程度"]+aa-50
		  JY.Person[eid]["灼烧程度"] = 50
		  WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + bb, 0, 50)
		  else
		  JY.Person[eid]["灼烧程度"] = limitX((JY.Person[eid]["灼烧程度"] or 0) + aa, 0, 50)	        
	      end
	   end
	end
	
	if  WAR.DZDJ2>0 and DWPD()   then--阴阳倒转刃领悟风剑
	local SN=math.modf(JY.Person[eid]["内力"]/200)
	 WAR.CHZ[eid] = limitX((WAR.CHZ[eid] or 0) + SN, 0, 100)
	 WAR.CHXS[eid] = 1
	   if WAR.DZDJ2 == 1 then----
          WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + SN, 0, 50)
	   end
	
	   if WAR.DZDJ2 == 2 then----
	   	   local aa = WAR.CHZ[eid] or 0	   
	      if JY.Person[eid]["冰封程度"]+aa >= 100 then
		  local bb = JY.Person[eid]["冰封程度"]+aa-100
		  JY.Person[eid]["冰封程度"] = 100
		  WAR.BFXS[eid] = 1
		  WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0) + bb, 0, 50)
		  else
		  JY.Person[eid]["冰封程度"] = limitX((JY.Person[eid]["冰封程度"] or 0) + aa, 0, 100) 
          WAR.BFXS[eid] = 1		  
	      end
	   end
	end
	
	if wglw(pid,127)>1 and wugong ==127 and DWPD()  then--秘孔封穴
      local str=""
		  if WAR.MKDS[eid] ~= nil then
		    local str="秘孔"
			local aa=math.random(1,4)
			if wglw(pid,127)>2 and  JLSD(10,20,pid) then
			aa = 5
			end
			local YZQS={".新血愁",".幽泉",".醒锐",".喘破",".残悔"}
			str=str..YZQS[aa]
			if aa>0 then
			addeffect2(WAR.MKDS,eid,1)
		   if aa==1 then
		   addeffect2(WAR.MK_XXC,eid,1)
		   elseif aa==2 then
		   addeffect2(WAR.MK_YQ,eid,1)
		   elseif aa==3 then
		   addeffect2(WAR.MK_XR,eid,1)
		   elseif aa==4 then
		   addeffect2(WAR.MK_CP,eid,1) 
		   else 
		   addeffect2(WAR.MK_CH,eid,1)
		   end
		end
            addeffect2(WAR.MKDS,eid,1)
	        Set_Eff_Text(enemyid, "特效文字2", str)
	        WAR.Person[enemyid]["特效动画"] = 131+aa
	      end
	end

   if WAR.MJBCJ[eid] ~=nil and DWPD() then
       local aa=WAR.MJBCJ[eid]
	   if aa==3 then--三次裁决为重大通缉犯，伤害2倍
	   aa=10
       end
       hurt=math.modf(hurt*(1+0.1*aa))
	   local SN=math.modf(hurt*0.1*aa)
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +AddPersonAttrib(pid, "生命", SN)--攻击被裁决者的赏金
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +AddPersonAttrib(pid, "内力", SN*10)
	end

  if T7DFWM(pid) and WAR.DFWM2 == 2 and DWPD() then --东方未明拳系封穴20
	WAR.FXXS[eid] = 1 	
	if WAR.FXDS[eid] == nil then
		WAR.FXDS[eid] = 20
	else
		WAR.FXDS[eid] = WAR.FXDS[eid] + 20
	end
  end

	
  	if MPPD(eid) == 5 then	
		if DWPD() or (MPPB_MJAS(eid)>1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"]) then
		Set_Eff_Text(enemyid, "特效文字2", "焚我残躯")
		local nlDam = MPDJ(eid) * 30
		local nlDam2 = MPDJ(eid) * 5
		if MPPB_MJAS(eid) >= 1 then--
				nlDam = nlDam +(MPDJ(eid) * 30)
				nlDam2 =nlDam2+(MPDJ(eid) * 5)
		end
				if WAR.MJBCJ[pid] ~=nil then
				nlDam = nlDam +(WAR.MJBCJ[pid] * 50)
				nlDam2 =nlDam2+(WAR.MJBCJ[pid] * 10)
				end	
				if WAR.GMYS1[pid] ~=nil then
				nlDam = nlDam +(WAR.GMYS1[pid] * 50)
				end	
		WAR.Person[enemyid]["特效动画"] = 81
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
        WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", nlDam2)
		JY.Person[pid]["灼烧程度"] = limitX((JY.Person[pid]["灼烧程度"] or 0) + (MPDJ(eid) * 5), 0, 50)
		   if JY.Person[pid]["灼烧程度"] >= 25 and MPPB_MJAS(eid)>1 then
		   WAR.JHLY[pid] = MPDJ(eid) * 5
		   end
		   if MPPB_MJAS(eid)>2 then
		   	  for j = 0, WAR.PersonNum - 1 do
			  local tmppid = WAR.Person[j]["人物编号"]
		       if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[j]["人物编号"]~= pid and RealJL(enemyid, j, 3+MPDJ(eid)) then
		          WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -nlDam)
                  WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(tmppid, "受伤程度", nlDam2)
		          JY.Person[tmppid]["灼烧程度"] = limitX((JY.Person[tmppid]["灼烧程度"] or 0) + (MPDJ(eid) * 5), 0, 50)
		       end
	          end
		   end
		   
		end
	end
	
	if WAR.DJJIAN2>0 and DWPD() then
	local SN=math.modf(JY.Person[eid]["内力"]/200)
    WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + SN, 0, 50)
	end
	
	if WAR.DJDAO2>0 and DWPD() then
	local SN=math.modf(JY.Person[eid]["内力"]/200)
    WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + SN, 0, 100)
	end
	
	if WAR.DJSX2>0 and DWPD() then
	local SN=math.modf(JY.Person[eid]["内力"]/200)
	WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0) + math.modf(0.5*SN), 0, 100)
	WAR.JHLY2[eid] = limitX((WAR.JHLY2[eid] or 0) + math.modf(0.5*SN), 0, 50)
	end
	

	
	--冰结环
    if wglw(eid, 5)>1 and DWPD() then
		if wglw(eid, 5)>2 then
		hurt = hurt - math.modf(JY.Person[pid]["冰封程度"]*(WAR.HBYJ[pid] or 0)*0.5)
		   if hurt<20 then
		     hurt=20
		   end
		end
		if WAR.BSFW[eid]~=nil then 
           reseteffect2(WAR.BSFW, eid, 1)
		   WAR.LRHF[pid] = limitX((WAR.LRHF[pid] or 0)+10,0,50)
		   if JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) then
		   WAR.HBYJ[pid] = limitX((WAR.HBYJ[pid] or 0)+1,0,3+wglw(eid,5)*3)
		   end
		 	WAR.TXXS[pid] = 1
		    WAR.Person[enemyid]["特效动画"] = 1
		    if WAR.Person[enemyid]["特效文字2"] ~= nil then
			   WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+冰结环"
		    else
			   WAR.Person[enemyid]["特效文字2"] = "冰结环"
		    end
		end
    end

    if wglw(eid, 5)>1 and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[eid]["实战"]/50),eid) and DWPD() then
	    dng = dng + 100*math.modf(JY.Person[pid]["冰封程度"]/5)
		hurt = hurt - JY.Person[pid]["冰封程度"]
		if hurt<20 then
		hurt=20
		end
		JY.Person[pid]["冰封程度"] = JY.Person[pid]["冰封程度"] + 20
		if JY.Person[pid]["冰封程度"] > 100 then 
		JY.Person[pid]["冰封程度"] = 100
		WAR.LRHF[pid] = 10
		end
		WAR.TXXS[pid] = 1
		WAR.Person[enemyid]["特效动画"] = 1
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+玄冰御"
		else
			WAR.Person[enemyid]["特效文字2"] = "玄冰御"
		end
    end

    if wglw(eid,76)>=1 and DWPD() then
	   if WAR.DRZT[pid]~=nil then
	   WAR.Person[enemyid]["反击武功2"]    = 76
	   end	   
	   if wglw(eid,76)>1 and WAR.NGHT>0 then
	   WAR.DRZT[pid] = limitX((WAR.DRZT[pid] or 0) + 1,0,wglw(eid,76))	   
	   end	
	end

    if YCRW(eid) == 4 and DWPD() then
	   hurt = hurt - math.modf(JY.Person[pid]["灼烧程度"]*(1+0.2*YCDJ(eid)))
	      if  YCDJ(eid)>=2  then
	         if WAR.LHYJ[pid] ~= nil then
             reseteffect2(WAR.LHYJ, pid, 1)
             WAR.JHLY2[pid] = 30
             end			 
             addeffect2(WAR.LHYJ,pid,YCDJ(eid))
			 if WAR.LHYJ[pid]>= 5*YCDJ(eid) then
			 WAR.LHYJ[pid] = 5*YCDJ(eid)
			 end
		      WAR.Person[enemyid]["特效动画"] = 25
		      if WAR.Person[enemyid]["特效文字2"] ~= nil then
			     WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+炎火之拥"
		      else
			     WAR.Person[enemyid]["特效文字2"] = "炎火之拥"
		      end
        end
	end
	
    if wglw(eid,17)>1 and DWPD() then
	   JY.Person[pid]["灼烧程度"] = JY.Person[pid]["灼烧程度"] + 20
	      if  JY.Person[pid]["灼烧程度"]>=50  then
		     JY.Person[pid]["灼烧程度"] =50			 
             addeffect2(WAR.WMYH,pid,10)
             if wglw(eid,17)>2 then
                addeffect2(WAR.RMZT,pid,1)
			  	if WAR.RMZT[pid] <= (wglw(eid,17)-1)*5 then--
				   WAR.RMZT[pid] = (wglw(eid,17)-1)*5
				  end
             end			 
		      WAR.Person[enemyid]["特效动画"] = 18
		      if WAR.Person[enemyid]["特效文字2"] ~= nil then
			     WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+业火缠身"
		      else
			     WAR.Person[enemyid]["特效文字2"] = "业火缠身"
		      end
        end
	end	

	--寒冰剑
    if wglw(pid, 35)>1 and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) and JY.Wugong[wugong]["武功类型"]==3 and DWPD() then
	    ang = ang + 100*math.modf(JY.Person[eid]["冰封程度"]/5)
		JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] + 20
		if JY.Person[eid]["冰封程度"] > 100 then 
		JY.Person[eid]["冰封程度"] = 100
		WAR.LRHF[eid] = 10
		end
		WAR.TXXS[eid] = 1
		WAR.Person[enemyid]["特效动画"] = 1
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+冰龙霰"
		else
			WAR.Person[enemyid]["特效文字2"] = "冰龙霰"
		end
    end

  --五岳剑派：五岳剑法，增加伤害
  if WAR.L_WYJFA1 >= 1 or WAR.L_WYJFA2 >= 1 or WAR.L_WYJFA3 >= 1 or WAR.L_WYJFA4 >= 1 or WAR.L_WYJFA5 >= 1 then 	
	if  WAR.NGJL == 90 then
		hurt = math.modf(hurt * 1.15)
	else
		hurt = math.modf(hurt * 1.1)
	end
	--3增加内伤
	if WAR.L_WYJFA3 >= 1 and DWPD() then		
		AddPersonAttrib(eid, "受伤程度", 20)
		if WAR.L_WYJFA3 >= 2  then
		AddPersonAttrib(eid, "中毒程度", 20)
		end
	end
  end

  --温青青，使用雷震剑法
  if WAR.WQQ == 1 then
    hurt = math.modf(hurt * (2 + math.random(200) / 100))
  end
	
	--蓝凤凰，攻击时伤害一*110%
	if WAR.TFH == 1 then
		hurt = math.modf(hurt * 1.1)
	end

  --蓝烟清：南山刀法，伤害加成
  if WAR.L_NSDF[eid] ~= nil then
  	hurt = hurt * (1+ WAR.L_NSDF[eid]);
  	ang = ang * (1+ WAR.L_NSDF[eid]);
	if WAR.L_NSDFCC>1 then
	
	else
  	WAR.L_NSDF[eid] = nil;
	end
  end

	--蓝烟清：南山刀法命中
	if WAR.L_NSDFCC >= 1 and DWPD() then		
		if WAR.L_NSDFCC > 1 then
		WAR.L_NSDF[eid] = (WAR.L_NSDF[eid] or 0) + 1;
		else
		WAR.L_NSDF[eid] = 1;
		end
	end 

	--周伯通，每行动一次，攻击时伤害一+10%
	if match_ID(pid, 64) then
		hurt = math.modf(hurt * (1 + WAR.ZBT / 10))
	end
 
	if zylw(3)>1 and pid == 0 and JY.Wugong[wugong]["武功类型"] == 3 then
		hurt = hurt + WAR.FLHS2 * 10
	end
 
    if WAR.KUIHUAHJ == 2  then
       hurt = hurt+ sixi(pid,1)*5 + sixi(pid,3)*5
	end	
 
  	if match_ID(pid, 450) then
		hurt = math.modf(hurt * (1 + WAR.ZBT / 20))
	end
  
  	if wglw(pid, 44)>2 then	
	    WAR.ZBT2= WAR.ZBT2 + 1
	    if WAR.ZBT2>10 then
		WAR.ZBT2=10
		end
		hurt = math.modf(hurt * (1 + WAR.ZBT2 / 20))
		if JY.Person[eid]["生命"]< math.modf(JY.Person[eid]["生命最大值"]*0.5) then
		hurt = math.modf(hurt * 1.25)
		end
		if JY.Person[pid]["生命"]< math.modf(JY.Person[pid]["生命最大值"]*0.5) then
		hurt = math.modf(hurt * 1.25)
		end
	end
  
   if wglw(pid, 63)>1 then
     if WAR.XUEFU[pid]~=nil and WAR.XUEFU[pid]>=0 then
	 hurt = hurt * math.modf((1 + WAR.XUEFU[pid] / 10))
	 end
	 hurt = hurt * math.modf(2-(JY.Person[pid]["生命"] / JY.Person[pid]["生命最大值"]))
	 if WAR.XDDF2>0 and WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100 then
	 hurt = hurt+30*(WAR.XUEFU[pid] or 0)
	 WAR.XUEFU[pid] = 0
		Set_Eff_Text(enemyid, "特效文字0", "血怒四方")
	 end
  end
 


 
	--拳系大招，攻击时伤害一*133.3%
	if WAR.LXZQ == 1 then
		hurt = math.modf(hurt * 1.333)
	end
	
	if MPPD(pid) == 4 and DWPD() then		--密教增加伤害
    local mpdj = MPDJ(pid)
    hurt = hurt + mpdj*75
    end
	
   	if  wglw(eid, 67)>2 and PersonKFJ(eid,67) and DWPD() then
	    WAR.ZBT2= WAR.ZBT2 + 1
	    if WAR.ZBT2>10 then
		WAR.ZBT2=10
		end
		hurt = math.modf(hurt * (1 - WAR.ZBT2 / 20))
		if JY.Person[eid]["生命"]< math.modf(JY.Person[eid]["生命最大值"]*0.5) then
		hurt = math.modf(hurt * 0.75)
		end
		if JY.Person[pid]["生命"]< math.modf(JY.Person[pid]["生命最大值"]*0.5) then
		hurt = math.modf(hurt * 0.75)
		end
	end
 
 
  	if WAR.HYTZ1>0 and nglw(eid,90)>1 and PersonKF(eid,90) then
        local bb=1-(0.05+nglw(eid,90)*0.01)*WAR.HYTZ1		
		hurt = math.modf(hurt * bb)
	   if nglw(eid,90)>2 then
	   local force=-20*WAR.HYTZ1
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", force)
       end
       WAR.HYTZ1 = 0		
	end
    
	if nglw(pid,90)>2 and WAR.HYTZ>0 and PersonKF(pid,90) then
	   WAR.HYTZ=WAR.HYTZ-JY.Person[eid]["体力"]
	   if WAR.HYTZ<0 then
	   WAR.HYTZ=0
	   end
	   local bb=1+0.01*WAR.HYTZ
       local cc=1-0.01*WAR.HYTZ	   
	   hurt = math.modf(hurt * bb)
       ang = math.modf(ang * bb)
       dng = math.modf(dng * cc)
       local kk=math.modf((ang-dng)/300)
       if kk<0 then
       kk=0 
       end
       JY.Person[pid]["体力"]=JY.Person[pid]["体力"]+kk
       if JY.Person[pid]["体力"]>100 then
       JY.Person[pid]["体力"]=100 
       end	   
       end	 
  
	--宋青书 有女的攻击加成
	if match_ID(pid, 82) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 1 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 + (s)*0.05))
	end
	
	--骆冰 一个男的+5%伤害一
	if match_ID(pid, 154) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 0 then
				s = s + 1
			end
		end
		hurt = math.modf(hurt * (1 + s*0.05))
	end

  	    --沼跃鱼:明教圣火阵
  if MPPD(pid) == 5 then
    local shz = 0
	local xg = MPDJ(pid)
    for j = 0, WAR.PersonNum - 1 do
      if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and MPPD(WAR.Person[j]["人物编号"]) == 5 then
        shz = shz + 1
      end
    end
    if shz >= 2 then
    	hurt = math.modf(hurt * (1 + (shz)*0.02*xg))
    	ang = ang + (shz) * 100
 	end
	if shz > 10 then
	  shz = 10
	end
  end
  
  if MPPD(eid) == 5 then
    local xg = MPDJ(eid)
	local shz = 0
    for j = 0, WAR.PersonNum - 1 do
      if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and MPPD(WAR.Person[j]["人物编号"]) == 5 then
        shz = shz + 1
      end
    end
    if shz >= 2 then
    	hurt = math.modf(hurt * (1 - (shz)*0.02*xg))
    	dng = dng + (shz) * 40 * xg
  	end
	if shz > 10 then
	  shz = 10
	end
  end  
 

 
	--岳灵珊武功剑法加成
	if match_ID(pid, 79) then
		local JF = 0
		for i = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. i] < 50 and JY.Person[pid]["武功" .. i] > 26 and JY.Person[pid]["武功等级" .. i] == 999 then
				JF = JF + 1
			end
		end
		--每个剑法提高伤害一5%
		hurt = math.modf(hurt * (1 + 0.05 * (JF)))
	end
  
	--苏荃和霍青桐，为守方，在战场时，伤害一减少10%
	if not inteam(pid) then
		for j = 0, WAR.PersonNum - 1 do
			if (match_ID(WAR.Person[j]["人物编号"], 87) or match_ID(WAR.Person[j]["人物编号"], 74)) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				hurt = math.modf(hurt * 0.9)
			end
		end
	end
  
	--阿珂和张召重为攻方，在战场时，伤害一提高10%
	if inteam(pid) then
		for j = 0, WAR.PersonNum - 1 do
			if (match_ID(WAR.Person[j]["人物编号"], 86) or match_ID(WAR.Person[j]["人物编号"], 80)) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				hurt = math.modf(hurt * 1.1)
			end
		end
	end
	
	--金刚伏魔圈，伤害一减少，气防提高
	if PersonKF(eid, 82) then
		local jgfmq = 0
		local effstr = "金刚伏魔圈"
		for j = 0, WAR.PersonNum - 1 do
			if PersonKF(WAR.Person[j]["人物编号"], 82) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
				jgfmq = jgfmq + 1
			end
		end
		--上限3人
		if jgfmq > 3 then
			jgfmq = 3
		end
		if jgfmq == 3 then
			effstr = "真."..effstr
		end
		if jgfmq > 1 then
			hurt = math.modf(hurt * (1-0.15*(jgfmq-1)))
			dng = dng + 500 * (jgfmq-1)
			Set_Eff_Text(enemyid, "特效文字3", effstr)
		end
	end
	
	--七夕黄蓉，打狗棒法，缠字诀，下回合不可移动
	if wugong == 80 and match_ID(pid, 613) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		WAR.L_NOT_MOVE[eid] = 1;
	end

	
	--天罗地网，柔网势
	if Curr_QG(pid,148) and DWPD() then
		WAR.TLDW[eid] = 1;
	end

	
	--小日本 攻击伤害提高
	if WAR.BSMT == 1 then
		hurt = math.modf(hurt + 100 + math.random(50))
	end
  
	--斗转星移伤害和杀集气计算
	if WAR.DZXYLV[pid] ~= nil and WAR.DZXYLV[pid] > 10 then
		hurt = math.modf(hurt * WAR.DZXYLV[pid] / 100)
		ang = ang + WAR.DZXYLV[pid] * 10
	end
	
	if WAR.YTTLLV[pid] ~= nil and WAR.YTTLLV[pid] > 10 then
		hurt = math.modf(hurt * WAR.YTTLLV[pid] / 50)
		ang = ang + WAR.YTTLLV[pid] * 40	
	end
	
	if WAR.FQDF1[pid] ~= nil  then
		hurt = math.modf(hurt * WAR.FQDF1[pid])
		ang = ang + WAR.FQDF1[pid] * 500	
	end
	
	if WAR.FQDF2[pid] ~= nil  then
		hurt = math.modf(hurt * WAR.FQDF2[pid])
		ang = ang + WAR.FQDF2[pid] * 500	
	end	
  
  	if WAR.DZXYSX[pid] ~= nil and WAR.DZXYLV[pid] ~= nil then
		local str="星移辰转"	
		if WAR.DZXYSX[pid] == 0 then
		WAR.HDQM[eid] = (WAR.HDQM[eid] or 0) + 20
		WAR.LRHF[eid] = (WAR.LRHF[eid] or 0) + 20
		str = "星移辰转.钻石星尘"
		elseif WAR.DZXYSX[pid] == 1 then
		WAR.WMYH[eid] = (WAR.WMYH[eid] or 0) + 20
		WAR.TLQJ2[eid] = limitX((WAR.TLQJ2[eid] or 0)+hurt,0,300)
		WAR.JHLY3[eid] = 30
		str = "星移辰转.银河星爆"
		else
		local  aa = math.random(1,2)
		   if  aa== 1 then
		   WAR.QBLY[eid] = (WAR.QBLY[eid] or 0) + 20
		   WAR.L_WNGZL2[eid] = (WAR.L_WNGZL2[eid] or 0) + 20
		   str = "星移辰转.星屑旋转"
		   else
		   WAR.QSLZ[eid] = (WAR.QSLZ[eid] or 0) + 20
		   WAR.BPYZ[eid] = (WAR.BPYZ[eid] or 0) + 20
		   str = "星移辰转.星光灭绝"
		   end
		end
		Set_Eff_Text(enemyid, "特效文字0", str)
	end
  
 	if WAR.DZXY3P[pid] ~= nil and WAR.DZXY3P[pid] ~= nil then
	   local aa = WAR.DZXY3P[pid]
       if aa == 1 then
	   WAR.LUCK[pid] = (WAR.LUCK[pid] or 0) + 5
	   WAR.UNLUCK[eid] = (WAR.UNLUCK[eid] or 0) + 20
	   elseif aa == 2 then
	   WAR.SKWJ[eid] = (WAR.SKWJ[eid] or 0) + 20
	   elseif aa == 3 then
	   WAR.Person[WAR.CurID].TimeAdd = 1005
	   WAR.GTSHAQI = WAR.GTSHAQI + 100
	   WAR.GTPID2 = pid
	   elseif aa == 4 then
	   WAR.L_HQNZL[pid] = (WAR.L_HQNZL[pid] or 0) + 5
	   JY.Person[pid]["生命"] = JY.Person[pid]["生命"] + math.modf(JY.Person[eid]["生命最大值"]*0.1)
	   else
	   WAR.HIDE[pid] = (WAR.HIDE[pid] or 0) + 10
	   WAR.SATA[pid] = (WAR.SATA[pid] or 0) + 1
	   end
	   addeffect2(WAR.MRDZ,pid,1)
	end  
 
  	if WAR.MJYF[pid] ~= nil and WAR.DZXYLV[pid] ~= nil then
		  local fj = {"秘剑.麒麟落","秘剑.凤返","秘剑.白龙","秘剑.蜉蝣笼罩","秘剑.毗沙门","秘剑.星花火"}
		  local aa = WAR.MJYF[pid] 
		  if aa == 1 then
	        hurt= math.modf(JY.Person[pid]["内力"] *0.15)+hurt
	      elseif aa == 2 then
	        WAR.HOT[eid] = (WAR.HOT[eid] or 0) + 20
			WAR.JHLY[eid] = 30
	       elseif aa == 3 then
	        WAR.Person[WAR.CurID].TimeAdd = 1005
	        WAR.GTSHAQI = WAR.GTSHAQI + 100
	        WAR.GTPID2 = pid
	       elseif aa == 4 then
	        WAR.L_HQNZL[pid] = (WAR.L_HQNZL[pid] or 0) + 15
	        JY.Person[pid]["生命"] = JY.Person[pid]["生命"] + math.modf(JY.Person[eid]["生命最大值"]*0.1)
		   elseif aa == 5 then
		   WAR.MZLL[pid] = 30
		   WAR.MZLL2[eid] = 30
	       else
	          if WAR.JHLY2[eid]~=nil then
                 addeffect(WAR.HTZD2, eid, 1)
              end
			 WAR.JHLY2[eid]=(WAR.JHLY2[eid] or 0) +20
	      end
		  local dzwz = fj[WAR.MJYF[eid]]
		Set_Eff_Text(enemyid, "特效文字0", dzwz)
	end
 
      if pid == 0 and JY.Base["标准"] >0  and JY.Base["天书数量"]>=6 and DWPD() then 
	   local str=""	
	   if WAR.LMBJ4==1 then
	   str="隼旋初式.念奴娇"
		   hurt=math.modf(hurt*1.15)
		   ang = ang + 750
		    if JY.Base["标准"]==9 then
			 hurt= math.modf(JY.Person[eid]["中毒程度"] *1.15)+hurt
			 str="夜枭初式.断肠"
            end	
		   Set_Eff_Text(enemyid, "特效文字0", str)
		   	if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		    end
	   elseif WAR.LMBJ4==2 then	
	   	   str="隼旋次式.破阵子"
		   hurt=math.modf(hurt*1.3)
		   ang = ang + 1000
		    if JY.Base["标准"]==9 then
			 hurt= math.modf(JY.Person[eid]["中毒程度"] *1.3)+hurt
			 str="夜枭次式.摧心"
            end	
		   Set_Eff_Text(enemyid, "特效文字0", str)
			if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 64
		    end
	   elseif WAR.LMBJ4==3 then	
	   	   str="隼旋终式.满江红"
           hurt=math.modf(hurt*1.5)
		   ang = ang + 1500
		   if JY.Base["标准"]==9 then
			 hurt= math.modf(JY.Person[eid]["中毒程度"] *1.5)+hurt
			 str="夜枭终式.破魂"
            end	
		   Set_Eff_Text(enemyid, "特效文字0", str)
		 	if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 65
		    end
	   end 
    end
   
     if wglw(pid,55)>1 and wugong == 55 and DWPD() then 
	   if WAR.ACT>1 then
          WAR.GTJIQI = WAR.GTJIQI + WAR.ACT*100
		  if WAR.GTJIQI>= 800 then
		  WAR.GTJIQI = 800
		  end
		  WAR.GTPID = pid
	   end 
    end 

     if Curr_NG(pid,180)  and DWPD() then 
	   if JY.Person[eid]["中毒程度"]>0 then
          WAR.GTJIQI = WAR.GTJIQI + JY.Person[eid]["中毒程度"]*5
		  if WAR.GTJIQI>= 600 then
		  WAR.GTJIQI = 600
		  end
		  WAR.GTPID = pid
	   end 
    end 
	
	if wglw(pid,55)>1 and  DWPD() then 
	   if  WAR.BJ == 1 then
	      local aa = math.modf(JY.Person[pid]["轻功"]*0.5)
		  if JY.Wugong[wugong]["武功类型"] == 3 then
		  aa = math.modf(aa*1.25)
		  end
		  WAR.GTSHAQI = WAR.GTSHAQI + aa
		  WAR.GTPID2 = pid
	   end
	end 
  
	if MPPB_GB(pid)>=2 and WAR.LMBJ5>=1 then 
	   if WAR.LMBJ5==1 and DWPD() then 
		   hurt=hurt+math.modf(JY.Person[pid]["拳掌功夫"]*0.15)
		   Set_Eff_Text(enemyid, "特效文字0","乌衣丐帮.傲血战意")
		   ang = ang + 750
	   elseif WAR.LMBJ5==2 and DWPD() then	
		   hurt=hurt+math.modf(JY.Person[pid]["拳掌功夫"]*0.25)
		   Set_Eff_Text(enemyid, "特效文字0","乌衣丐帮.傲骨战意")
		   ang = ang + 1000
	   elseif WAR.LMBJ5==3 and DWPD() then	
           hurt=hurt+math.modf(JY.Person[pid]["拳掌功夫"]*0.35)
		   Set_Eff_Text(enemyid, "特效文字0","乌衣丐帮.傲魂战意")
		   ang = ang + 2000
	   end 
	   WAR.LMBJ5=0
    end
  
  
	--逆运走火
	--伤害一加成
	if WAR.tmp[1000 + pid] == 1 then
		hurt = math.modf(hurt * 1.1)
	end
  
	if WAR.tmp[1000 + eid] == 1 then
		hurt = math.modf(hurt * 0.9)
	end
  
	--守方为NPC时，伤害一 = 伤害一 * (1 - 攻方内伤 * 0.002)
	if inteam(pid) then
		hurt = math.modf(hurt * (1 - JY.Person[pid]["受伤程度"] * 0.002))
	end
	  
	--守方为玩家时，伤害一 = 伤害一 * (1 - 攻方内伤 * 0.0015)
	if inteam(eid) then
		hurt = math.modf(hurt * (1 + JY.Person[pid]["受伤程度"] * 0.0015))
	end
  
	--欧阳锋  战斗171队友伤害减少
	if pid == 60 and WAR.ZDDH == 171 then
		hurt = math.modf(hurt * 0.75)
	end
	  
	--欧阳锋  战斗171敌人伤害提高
	if eid == 60 and WAR.ZDDH == 171 then
		hurt = math.modf(hurt * 1.2)
	end

--笑傲邪线，黑木崖如果单挑东方不败，则东方会以葵花尊者形态出战
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and eid == 27 and JY.Person[eid]["生命"] <= math.modf(JY.Person[eid]["生命最大值"]*0.5) and  WAR.YJDD == 1 then
	    WAR.ACT = 10
		local dfid;
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
			if id == 27 then
				dfid = i;
				break
			end
		end
		local orid = WAR.CurID
		WAR.CurID = dfid
		
		Cls()
		local KHZZ = {"可恶","居然把我逼到这一步"}
		
		for i = 1, #KHZZ do
			lib.GetKey()
			DrawString(-1, -1, KHZZ[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end

		
		local KHZZ3 = {"为了嘉奖你，也让你看看","我最强的状态","尽情肆虐吧!月光下的葵花"}
		
		for i = 1, #KHZZ3 do
			lib.GetKey()
			DrawString(-1, -1, KHZZ3[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end
		
		CurIDTXDH(WAR.CurID, 7, 1)
		
		awakening(27,1)
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]*JY.Person[eid]["血量翻倍"]
		
		lib.Background(0,200,CC.ScreenW,400,78)
		NewDrawString(CC.ScreenW, CC.ScreenH/2 + 160, "真.月光葵尊形态", C_GOLD, 80)
		NewDrawString(CC.ScreenW, CC.ScreenH/2 + 360, "每当看到月亮都会想起我", C_RED, 70)
		
		ShowScreen()
		Cls()
		lib.Delay(2000)
		
		local KHZZ4 = {"接下来，"..JY.Person[0]["外号2"],"陷入无限的恐怖中吧"}
		
		for i = 1, #KHZZ4 do
			lib.GetKey()
			DrawString(-1, -1, KHZZ4[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end
		WAR.YJDD = 0
		WAR.CurID = orid
	end


     if MPPD(pid) == 5 then
       local xg = MPDJ(pid)
	   local shz = 0
	   
       for j = 0, WAR.PersonNum - 1 do
	     local tmppid = WAR.Person[j]["人物编号"]
          if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and MPPD(tmppid) == 5 then
             shz = shz + 1
          end
       end
       if shz >= 2 then
    	  hurt = math.modf(hurt * (1 + (shz)*0.02*xg))
    	  ang = ang + (shz) * 100 * xg
  	   end
	   if shz > 8 then
	      shz = 8
	   end
    end
	
	--圣火三使 伤害、气攻提高
	if WAR.ZDDH == 14 and (pid == 173 or pid == 174 or pid == 175) then
		local shz = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			shz = shz + 1
			end
		end
		if shz == 3 then
			hurt = math.modf(hurt * 1.5)
			ang = ang + 1000
		end
	end
  

     if MPPD(eid) == 5 then
       local xg = MPDJ(eid)
	   local shz = 0
	   
       for j = 0, WAR.PersonNum - 1 do
	     local tmppid = WAR.Person[j]["人物编号"]
          if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and MPPD(tmppid) == 5 then
             shz = shz + 1
          end
       end
       if shz >= 2 then
    	  hurt = math.modf(hurt * (1 - (shz)*0.02*xg))
    	  dng = dng + (shz) * 100 * xg
  	   end
	   if shz > 8 then
	      shz = 8
	   end
    end 
  
  	--圣火三使 受伤害减少、气防提高
	if WAR.ZDDH == 14 and (eid == 173 or eid == 174 or eid == 175) then
		local shz = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
			shz = shz + 1
			end
		end
		if shz == 3 then
			hurt = math.modf(hurt * 0.5)
			dng = dng + 1000
		end
	end
  

   
	--全真七子，天罡北斗阵，增加伤害和气攻
	if WAR.ZDDH == 73 then
		if (pid >= 123 and pid <= 128) or pid == 68 then
		
			hurt = math.modf(hurt * (1+0.30))
			ang = ang + 1200
		end
	end
	  
	--全真七子，天罡北斗阵，受伤害减少和增加气防
	if WAR.ZDDH == 73 then
		if (eid >= 123 and eid <= 128) or eid == 68 then
		
			hurt = math.modf(hurt * (1-0.30))
			dng = dng + 1200
			
			WAR.Person[enemyid]["特效动画"] = 93
			if WAR.Person[enemyid]["特效文字2"] ~= nil then
				WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+天罡北斗阵护体"
			else
				WAR.Person[enemyid]["特效文字2"] = "天罡北斗阵护体"
			end
		end
	end
	
	--无酒不欢：小无相功增加气防
	--主运
	if Curr_NG(eid, 99) then
		dng = dng * 1.3
	--被动
	elseif PersonKF(eid, 99) then
		dng = dng * 1.1
	end

	if WAR.TZQJ == 13 and  (wugong == 18 or yongnei(wugong) ) then----八荒六合弹指气劲
        hurt = hurt + math.modf(dng*0.1)
	end

	if (WAR.HDMC == 2 or  WAR.HDMC2 == 2) and wugong == 67 then
       hurt = hurt + math.modf(dng*0.1)
	   ang = ang + dng * 0.5
	end
	
	--林朝英增加总气攻
	if match_ID(pid, 605) then
		ang = ang * 1.1
	end

--莫大潇湘夜雨必附带内伤10-20点
if WAR.XXYY==1 and DWPD()  then
WAR.Person[enemyid]["内伤点数"]=(WAR.Person[enemyid]["内伤点数"] or 0)+AddPersonAttrib(eid,"受伤程度",math.random(10,20))
end	
	
	if WAR.JW_FM == 1 and  WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then --沼跃鱼：大日金乌
	   local SN=math.modf(JY.Person[eid]["内力"]/100)
	   if JY.Person[eid]["灼烧程度"] > 0 then
		  ang = ang + JY.Person[eid]["灼烧程度"]*10
		  if WAR.HOT[eid]~=nil and WAR.HOT[eid]>0 then----
		  ang = ang + JY.Person[eid]["灼烧程度"]*10
		  end
	   end
	end
	
	if wugong == 22 and wglw(pid,22)>=1 and  WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then --沼跃鱼：大日金乌
	   if JY.Person[eid]["受伤程度"] > 0 then
		  ang = ang + JY.Person[eid]["受伤程度"]*10
	   end
	   if JY.Person[eid]["灼烧程度"] > 0 then
		  dng = dng - JY.Person[eid]["灼烧程度"]*10
		  if WAR.HOT[eid]~=nil and WAR.HOT[eid]>0 then----
		  dng = dng - JY.Person[eid]["灼烧程度"]*10
		  end
		  if dng<0 then
		  dng = 0
		  end
	   end
	end
	
	if WAR.MKDS[eid]~=nil then----
	   dng = math.modf(dng * 0.5)
	end
	
	if WAR.MLZS[eid]~= nil  then
	   dng = 0
	end
	
    if match_ID_awakened(pid, 48,1) and WAR.DLY==1 and DWPD() then--游坦之大招伤害
	hurt = hurt + math.modf((JY.Person[eid]["中毒程度"] ) * 1.15)
	if JY.Person[eid]["内力"]<=math.modf(JY.Person[eid]["内力最大值"]*0.5) then
	hurt = math.modf(hurt *1.25)
	end
	if JY.Person[eid]["冰封程度"]>0 then
	hurt = math.modf(hurt*1.25)
	end
	end

  	if WAR.CHD == 1 and match_ID_awakened(pid,103,1) and DWPD() then --残火刀终式
			hurt = hurt + math.modf((JY.Person[eid]["受伤程度"] ) * 1.15)
	if JY.Person[eid]["内力"]<=math.modf(JY.Person[eid]["内力最大值"]*0.5) then
	hurt = math.modf(hurt *1.25)
	end
	if JY.Person[eid]["灼烧程度"]>0 then
	hurt = math.modf(hurt*1.25)
	end
	end	


	
	
  if wglw(pid,162)>1 and DWPD() then --烈风抚斩
	if WAR.KFKJ2== 22 then
	local SN=math.modf(JY.Person[eid]["内力"]/200*TrueYJ(pid)*0.01)
	local SN2=SN*10
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", -SN)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid, "内力", -SN2)
				JY.Person[eid]["灼烧程度"]=JY.Person[eid]["灼烧程度"] +SN
				WAR.ZSXS[eid] = 1
                if JY.Person[eid]["灼烧程度"]>50 then----
                JY.Person[eid]["灼烧程度"]=50
                end
	end
  end
  
    if wglw(pid,162)>1 and DWPD() then --烈风抚斩
	if WAR.KFKJ2== 44 then
	local SN=math.modf(JY.Person[pid]["内力"]/200*TrueYJ(pid)*0.01)
    hurt = hurt + SN
				JY.Person[eid]["冰封程度"]=JY.Person[eid]["冰封程度"] +SN
				WAR.BFXS[eid] = 1
                if JY.Person[eid]["冰封程度"]>100 then----
                JY.Person[eid]["冰封程度"]=100
                end
	end
  end

  if wglw(pid,162)>1 and DWPD() then --暴风断金
	if WAR.KFKJ2== 33 then
	local SN=math.modf(JY.Person[eid]["内力"]/200*TrueYJ(pid)*0.01)
	local SN2=SN*10
		hurt = math.modf(hurt * (1+0.001*TrueYJ(pid)))
		hurt = hurt+math.modf(TrueYJ(pid)/5)
		dng=0
	end
  end
  
    if match_ID_awakened(pid, 49,1) and WAR.LX_SSF==1 and DWPD() then--虚竹大招伤害
	local aa=500
	local bb=1
	if WAR.TZ_XZ_SSH[eid] ~= nil and WAR.TZ_XZ_SSH[eid]>0 then----
	bb=1+WAR.TZ_XZ_SSH[eid]*0.15
	end
    bb=1+JY.Person[eid]["冰封程度"]/200+bb
	aa=math.modf(aa*bb)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa);
	local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
	ang = math.modf(ang * (1 + mp_percentage)*bb)
	hurt = math.modf(hurt* (1 + mp_percentage)*bb)
	end

   if match_ID_awakened(pid, 51,1) and WAR.MR_XLWC==1 and DWPD() then--慕容大招伤害
	local bb=WAR.MRDZ[pid] or 0
	local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
	ang = math.modf(ang * (1 + mp_percentage)*bb)
	hurt = math.modf(hurt* (1 + mp_percentage)*bb)
	end

    if match_ID_awakened(pid, 53,1) and WAR.LMJQ==1 and DWPD() then--段誉大招伤害
	local aa=0
	local bb=1
	local cc=0
	if WAR.LMJQ1[pid] ~= nil and WAR.LMJQ1[pid]>0 then----
	aa=math.modf((1+WAR.LMJQ1[pid]*0.15)*200)
	WAR.LMJQ1[pid] = math.modf(WAR.LMJQ1[pid]/2)
	end
	if WAR.LMJQ2[eid] ~= nil and WAR.LMJQ2[eid]>0 then----
	bb=math.modf((1+WAR.LMJQ2[eid]*0.15)*500)
	cc=WAR.LMJQ2[eid]/100
	WAR.LMJQ2[eid] = math.modf(WAR.LMJQ2[eid]/2)
	end
    hurt = hurt+ aa
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -bb);
    WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", aa);
	WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", bb);
	local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
	ang = math.modf(ang * (1 + mp_percentage)*(1+cc))
	hurt = math.modf(hurt* (1 + mp_percentage)*(1+cc))
	end

	
  if match_ID_awakened(pid, 80,1) and WAR.NSTJ2 >0 and DWPD() then--沼跃鱼：张召重大招伤害
      local bb=JY.Person[eid]["受伤程度"]
	  local aa = math.modf(WAR.NSTJ2/20)
      hurt = hurt + aa+ bb
  end
	
  if  WAR.XTDJ >0 and DWPD() then--沼跃鱼：杨过大招伤害
	  local aa = WAR.XTDJ
      hurt = hurt + aa
  end	
	
	--霍都随机上毒
	if WAR.HDWZ == 1 and DWPD() then
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] + math.random(13, 16)
		if JY.Person[eid]["中毒程度"] > 100 then
			JY.Person[eid]["中毒程度"] = 100
		end
	end
	  
	--无酒不欢：系数减伤
	local defadd = 0
	local wgtype = JY.Wugong[wugong]["武功类型"];
	local NPCgxf = 1;
	local NPCfxf = 1;
	--NPC系数*3计算
	if inteam(pid) then
		NPCfxf = 3
	else
		NPCgxf = 3
	end
	if wgtype == 6 then
		WAR.NGXS = math.random(5)
		wgtype = WAR.NGXS
	end
	--令狐冲或剑宗任何武功攻击算剑系
	if MPPB_WYJZ(pid) == 1 then
		wgtype = 3
		if YCRW(pid) == 2 then --五岳刀宗
		wgtype = 4
		end
	end
	--令狐冲或剑宗被任何武功攻击算剑系
	if MPPB_WYJZ(eid) == 1 then
		wgtype = 3
		if YCRW(eid) == 2 then --五岳刀宗
		wgtype = 4
		end
	end
	if wgtype == 1 and wugong ~= 109 then
		local quan_gong = JY.Person[pid]["拳掌功夫"]*NPCgxf
		local quan_fang = JY.Person[eid]["拳掌功夫"]*NPCfxf
		--无酒不欢：被拳法攻击，取拳指较高者计算减伤
		if quan_fang < JY.Person[eid]["指法技巧"]*NPCfxf then
			quan_fang = JY.Person[eid]["指法技巧"]*NPCfxf
		end
		if match_ID_awakened(pid,75,1) then--
	        quan_gong = math.modf(Xishu_sum(pid)/3*NPCgxf)
	    end
	    if match_ID_awakened(eid,75,1) then--
	        quan_fang = math.modf(Xishu_sum(eid)/3*NPCgxf)
	    end
		defadd = quan_gong - quan_fang
	elseif wgtype == 2 or wugong == 109 then
		local zhi_gong = JY.Person[pid]["指法技巧"]*NPCgxf
		local zhi_fang = JY.Person[eid]["指法技巧"]*NPCfxf
		--无酒不欢：被指法攻击，取拳指较高者计算减伤
		if zhi_fang < JY.Person[eid]["拳掌功夫"]*NPCfxf then
			zhi_fang = JY.Person[eid]["拳掌功夫"]*NPCfxf
		end
		if match_ID_awakened(pid,75,1) then--
	        zhi_gong = math.modf(Xishu_sum(pid)/3*NPCgxf)
	    end
	    if match_ID_awakened(eid,75,1) then--
	        zhi_fang = math.modf(Xishu_sum(eid)/3*NPCgxf)
	    end
		defadd = zhi_gong - zhi_fang
	elseif wgtype == 3 then
		local jian_gong = TrueYJ(pid)*NPCgxf
		if MPPB_WYJZ(pid) == 1 then
		jian_gong = jian_gong *1.5
	    end
		local jian_fang = TrueYJ(eid)*NPCfxf
		if MPPB_WYJZ(pid) == 1 then
		jian_fang = jian_fang*1.5
	    end
		if match_ID_awakened(pid,75,1) then--
	        jian_gong = math.modf(Xishu_sum(pid)/3*NPCgxf)
	    end
	    if match_ID_awakened(eid,75,1) then--
	        jian_fang = math.modf(Xishu_sum(eid)/3*NPCgxf)
	    end
		--阿青天元剑气，敌方御剑系数按20%算
		if WAR.TYJQ == 1 then
			jian_fang = jian_fang / 5
		end
		defadd = jian_gong - jian_fang
	elseif wgtype == 4 then
		local dao_gong = JY.Person[pid]["耍刀技巧"]*NPCgxf
		local dao_fang = JY.Person[eid]["耍刀技巧"]*NPCfxf
		if match_ID_awakened(pid,75,1) then--
	        dao_gong = math.modf(Xishu_sum(pid)/3*NPCgxf)
	    end
	    if match_ID_awakened(eid,75,1) then--
	        dao_fang = math.modf(Xishu_sum(eid)/3*NPCgxf)
	    end
		defadd = dao_gong - dao_fang
	elseif wgtype == 5 then
		local qi_gong = JY.Person[pid]["特殊兵器"]*NPCgxf
		local qi_gfang = JY.Person[eid]["特殊兵器"]*NPCfxf
		if match_ID_awakened(pid,75,1) then--
	        qi_gong = math.modf(Xishu_sum(pid)/3*NPCgxf)
	    end
	    if match_ID_awakened(eid,75,1) then--
	        qi_gfang = math.modf(Xishu_sum(eid)/3*NPCgxf)
	    end
		defadd = qi_gong - qi_gfang
	end	

	
	defadd = defadd + math.random(10)
	--每4点系数优势增加/劣势减少1%伤害
	defadd = defadd / 4
	local xishu_str;
	if defadd >= 10 then
		xishu_str = "本系优势·伤害加深"..math.modf(defadd).."%"
	elseif defadd <= - 10 then
		xishu_str = "本系劣势·伤害减少"..math.modf(-defadd).."%"
	end
	
	--天罡大招，系数不会劣势
	if WAR.JSTG == 1 and defadd < 0 then
		defadd = 10
		xishu_str = "遇强则强"
	end
	
	--小无相功，系数不会劣势
	if Curr_NG(pid, 98) and defadd < 0 then
		defadd = 10
		xishu_str = "无我无相"
	end

	if Curr_NG(eid, 98) and defadd > 0 then
		defadd = -10
		xishu_str = "无我无相"
	end
	
	hurt = math.modf(hurt * (1 + defadd/100))
	
	if defadd >= 10 then
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
		if WAR.Person[enemyid]["特效文字0"] ~= nil then
			WAR.Person[enemyid]["特效文字0"] = WAR.Person[enemyid]["特效文字0"] .. "+"..xishu_str
		else
			WAR.Person[enemyid]["特效文字0"] = xishu_str
		end
	elseif defadd <= - 10 then
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .. "+"..xishu_str
		else
			WAR.Person[enemyid]["特效文字3"] = xishu_str
		end
	end
  
	--乔峰，防御加成提升30%，半血时防御加成提升50%，血量低于25%防御加成提升75%
	if match_ID(eid, 50) then
		hurt = math.modf(hurt * 0.7)
		local minhurt = math.modf(hurt * 0.25)
		hurt = math.modf(hurt * JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"])
		if hurt < minhurt then
			hurt = minhurt
		end
	end
 
	if MPPD(eid) == 1 and hurt > 10 and DWPD() then --丐帮打狗棍阵
		for j = 0, WAR.PersonNum - 1 do
			local tmppid = WAR.Person[j]["人物编号"]
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"]
				and MPPD(tmppid) == 1 and tmppid ~= eid then
				hurt = math.modf(hurt * 0.33)
				JY.Person[tmppid]["生命"] = JY.Person[tmppid]["生命"] - hurt	
				WAR.Person[enemyid]["特效文字3"] = "打狗棍阵"
				WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) + AddPersonAttrib(tmppid,"内力", -hurt);
				SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 2);
				addeffect2(WAR.GBLJ,tmppid,1)
		        if WAR.GBLJ[tmppid]>=5 then
		           WAR.GBLJ[tmppid] = 5
		        end
				break
			end
		end		
	end
 
	--蓄力攻击
	if WAR.Actup[pid] ~= nil then
		--被动龙象或主运蛤蟆，伤害一*150%
		if PersonKF(pid, 103) or Curr_NG(pid, 95) then
			if MPPD(pid) == 4 then
			   local aa = 0.2
			   if MPPB_MZ(pid) == 1 then--
			   aa = 0.3
			   end
		       local mpdj = MPDJ(pid)*aa
		       hurt = math.modf(hurt * (1.5 + mpdj))
		    else
               hurt = math.modf(hurt * 1.5)
	        end
		--无龙象，伤害一*125%
		else
		    if MPPD(pid) == 4 then
		       local mpdj = MPDJ(pid)*0.2
		       hurt = math.modf(hurt * (1.25 + mpdj))
		    else
               hurt = math.modf(hurt * 1.25)
	        end	
		end
		if Curr_NG(pid,180) then
		   hurt = math.modf(hurt * 1.2)
		   WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度",10)
		end
        if WAR.Actup2[pid]~=nil then
           hurt = math.modf(hurt * 2)
        end		
	end

	--主运太极神功，60%几率累积太极之形
	if Curr_NG(eid, 171) and JLSD(20,80,eid)  then
		WAR.TJZX[eid] = (WAR.TJZX[eid] or 0) + 1
		if WAR.TJZX[eid] > 10+nglw(eid,171) then
			WAR.TJZX[eid] = 10+nglw(eid,171)
		end
		if nglw(eid,171)>=1 then
		zhanyi(eid, 2)
		end
		Set_Eff_Text(enemyid, "特效文字3", "太极之形")
	end
	

	
	--蛤蟆功蓄力
	if PersonKF(eid, 95) then
		--蓄力机制
		
		if WAR.tmp[200 + eid] == nil or WAR.tmp[200 + eid] == 0 then
			WAR.tmp[200 + eid] = 50;
		else
			WAR.tmp[200 + eid] = WAR.tmp[200 + eid] + 35;
		end
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "·蛤蟆蓄力";
		else
			WAR.Person[enemyid]["特效文字2"] = "蛤蟆蓄力";
		end
	end

	if PersonKF(eid, 180) then
		--玄蛇蓄力
		if WAR.Actup[eid] == nil then
		   local xlcg = 0
		   if JLSD(10,40,eid)  then
		    xlcg = 1
		   elseif Curr_NG(eid,180) and JLSD(10,80,eid) then
		    xlcg = 1
           end
            if xlcg == 1  then
               WAR.Actup[eid] = 2			
			   if WAR.Person[enemyid]["特效文字2"] ~= nil then
			    WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "·玄蛇应激.蓄力";
		       else
			   WAR.Person[enemyid]["特效文字2"] = "玄蛇应激.蓄力";
		       end
		    end
		end
	end

	--被无招胜有招击中
	if WAR.FQY == 1 then
		if WAR.WZSYZ[eid] == nil then
			WAR.WZSYZ[eid] = 10
		else
			WAR.WZSYZ[eid] = WAR.WZSYZ[eid] + 10
		end
	end	
	
	--被灵蛇拳击中
	if WAR.OYK >= 1 and DWPD() then
		WAR.LSQ[eid] = 20
	end

	if WAR.XSBTQ >= 1 and DWPD() then
		local SN1=math.modf(JY.Person[eid]["冰封程度"])
		local SN2=math.modf(JY.Person[eid]["中毒程度"])
		WAR.ICE[eid] = SN1
		WAR.L_WNGZL2[eid] = SN2
		
		if WAR.XSBTQ >= 2 then
		WAR.BPYZ[eid] = SN1
		WAR.RXSD[eid] = SN2
		local aa = math.modf(JY.Person[pid]["用毒能力"]/100*SN1)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -aa);	
		end
	end	

	if WAR.XSBTQ2 >= 1 and DWPD() then
	    local SN1=math.modf(JY.Person[eid]["冰封程度"])
		local SN2=math.modf(JY.Person[eid]["中毒程度"])
        WAR.HDQM[eid] = SN1
     if WAR.XSBTQ2 >= 2 then
		WAR.QBLY[eid] = SN2
		WAR.XRZT[eid] = SN2
		local aa = math.modf(JY.Person[pid]["用毒能力"]/300*SN2)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -aa);
	 end
	end

	if WAR.XSBTQ3 >= 1 and DWPD() then
	    local SN1=math.modf(JY.Person[eid]["冰封程度"])
		local SN2=math.modf(JY.Person[eid]["中毒程度"])
        WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 20)

		local str = ""
		local bb = math.random(8)--火毒、寒毒、蛊毒、毒击、溶血毒、冰魄毒、猛毒、七死爆毒
		if bb == 1 then
		    WAR.BZS = 1
			WAR.JHLY3[eid] = (WAR.JHLY3[eid] or 0) + 20
			str = "火毒攻心"
		elseif bb == 2 then
			WAR.HDQM[eid] = (WAR.HDQM[eid] or 0) + 20
			str = "寒毒侵脉"
		elseif bb == 3 then
			WAR.JCGD[eid] =  1
			WAR.JJGD[eid] =  1
			str = "瘴雾蛊毒"
		elseif bb == 4 then
			WAR.L_WNGZL[eid] = (WAR.L_WNGZL[eid] or 0) + 20
			str = "绝毒重击"
		elseif bb == 5 then
		    WAR.BLX = 1
			WAR.RXSD[eid] = 20
			str = "溶血剧毒"
		elseif bb == 6 then
			WAR.BPYZ[eid] = (WAR.BPYZ[eid] or 0) + 20
			str = "冰魄奇毒"
		elseif bb == 7 then
			WAR.POISON2[eid] = (WAR.POISON2[eid] or 0) + 20
			str = "不解猛毒"
		elseif bb == 8 then
			WAR.QSLZ[eid] = (WAR.QSLZ[eid] or 0) + 1
			str = "七死爆毒"
		end
		    if WAR.Person[enemyid]["特效文字2"] == nil then
			   WAR.Person[enemyid]["特效文字2"] = "八岐怪毒·"..str
		    else
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .."八岐怪毒·"..str
		    end
	  if  WAR.XSBTQ3 >= 2 then
		local cc = JY.Person[eid]["中毒程度"] or 0
		local c = 0
		if WAR.JHLY3[eid] ~= nil then
		c= c+WAR.JHLY3[eid]
		end
 		if WAR.HDQM[eid] ~= nil then
		c= c+WAR.HDQM[eid]
		end
		if WAR.JJGD[eid] ~= nil then
		c= c+50
		end
		if WAR.L_WNGZL[eid] ~= nil then
		c= c+WAR.L_WNGZL[eid]
		end
		if WAR.RXSD[eid] ~= nil then
		c= c+WAR.RXSD[eid]
		end
		if WAR.BPYZ[eid] ~= nil then
		c= c+WAR.BPYZ[eid]
		end
		if WAR.POISON2[eid] ~= nil then
		c= c+WAR.POISON2[eid]
		end
		if WAR.QSLZ[eid] ~= nil then
		c= c+WAR.QSLZ[eid]
		end	
		if WAR.L_WNGZL2[eid] ~= nil then
		c= c+WAR.L_WNGZL2[eid]
		end	
		if WAR.LSZD2[eid] ~= nil then
		c= c+50
		end	
		if WAR.JD_SJSD[eid] ~= nil then
		c= c+WAR.JD_SJSD[eid]
		end	
        if WAR.SPXT[pid] ~= nil  then
        c = c +  WAR.SPXT[pid] * 10
        end	
        if WAR.LSQ2[eid]~=nil  then
        c = c * 2
        end		
        hurt = math.modf(hurt * (1+0.01*c))	 + cc
        if c>=300 then
        hurt = hurt * 2
        end		
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"]or 0) + AddPersonAttrib(eid,"生命",-cc)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"]or 0) + AddPersonAttrib(eid,"内力",-(cc*10))
		   if WAR.LSQ2[eid] == nil then
			  WAR.LSQ2[eid] = 30
		   end	
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[enemyid]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[enemyid]["坐标Y"] - WAR.Person[j]["坐标Y"])	
			if WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and WAR.Person[j]["死亡"] == false and offset1 <= 3 and offset2 <= 3 then
			   local a = math.random(3)
			   if a == 1 then 
			   WAR.L_WNGZL2[df] = 20
			   elseif a == 2 then 
			   WAR.LSZD2[df] = 1
			   elseif a == 3 then
			   WAR.JD_SJSD[df] = 20
			   end
			end
        end
	  end	         
	end

	if WAR.OYK >= 2 and DWPD() then
		WAR.QSLZ[eid] = (WAR.QSLZ[eid] or 0) + 30
	end	
	
	if WAR.OYF == 1 and DWPD() then
		WAR.LSQ[eid] = 20
		WAR.MENG[eid] = 20
	end
	
	if WAR.TMXZ == 1 and DWPD() then
		WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 20
	    if WAR.Person[enemyid].Time < 0 then
	      local aa = math.modf((0-WAR.Person[enemyid].Time))
          hurt= hurt+aa
	   end
	end

    if WAR.ZJZC == 5 and DWPD() then
	   WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 20
	   if WAR.Person[enemyid].Time < 0 then
	      local aa = math.modf((0-WAR.Person[enemyid].Time)/10)
	      if aa<=5 then
	         aa = 5
	      end
		  hurt = hurt + math.modf(hurt * 0.01*aa)
	   end
	end
	
	--范遥挨打加减伤，上限20%
	if match_ID(eid,10) and DWPD() then
		WAR.GMYS[eid] = (WAR.GMYS[eid] or 0) + 1
		if WAR.GMYS[eid] > 20 then
			WAR.GMYS[eid] = 20
		end
	end
	
	--被杨逍击中的人，伤害增加1%，上限20%
	if match_ID(pid,11) and DWPD() then
		WAR.GMZS[eid] = (WAR.GMZS[eid] or 0) + 1
		if WAR.GMZS[eid] > 20 then
			WAR.GMZS[eid] = 20
		end
	end

	if match_ID_awakened(eid,11,1) and JLSD(10,50,eid) and DWPD() then
		WAR.GMZS1[eid] = (WAR.GMZS1[eid] or 0) + 1
		if WAR.GMZS1[eid] > 30 then
			WAR.GMZS1[eid] = 30
		end
	end

	if match_ID_awakened(pid,10,1) and JLSD(10,50,pid) and DWPD() then
		WAR.GMYS1[pid] = (WAR.GMYS1[pid] or 0) + 1
		if WAR.GMYS1[pid] > 30 then
			WAR.GMYS1[pid] = 30
		end
	end
	
	--防御状态
	if WAR.Defup[eid] == 1 then
		--有八荒，减伤40%
		if nglw(eid,144)>2 and Curr_NG(eid, 144) then
		    hurt = math.modf(hurt * 0.5)
		elseif PersonKF(eid, 101) then
			hurt = math.modf(hurt * 0.6)
		--无八荒，减伤25%
		else
			hurt = math.modf(hurt * 0.75)
		end
		if WAR.LUCK[eid]~=nil then
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", 100);
		end
		if WAR.UNLUCK[eid]~=nil then
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", -100);
		end
	end
   
   
   
  
	--连击，伤害，气攻计算
	if WAR.ACT > 1 then
		local LJ_fac = 0.7	--通常为70%
		--东方不败不减少
		--六脉神剑，夫妻刀法不减少
		--夭矫空碧不减少
		if match_ID(pid, 27) or wugong == 49 or wugong == 62 or WAR.YNXJ == 1 or match_ID_awakened(pid,152,1) then
			LJ_fac = 1
		end
		if MPPB_GB(pid) >=2 and JY.Wugong[wugong]["武功类型"] == 1 then
		   LJ_fac = 1
		   addeffect2(WAR.GBLJ,pid,1)
		   	if  WAR.ACT == WAR.ATNum and WAR.GBLJ[pid]~= nil then
            local aa = WAR.GBLJ[pid]
	         WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", -50*aa)
			 WAR.GBGF_LJ = 1
	        end	
		end
		if (MPPB_GB(pid) ==1 or MPPB_GB(pid) ==3 ) and JY.Wugong[wugong]["武功类型"] == 5 then
		   LJ_fac = 1
		end
		if WAR.UNLUCK[pid]~=nil then
		   LJ_fac = 0
		end
        if Curr_NG(pid,172)then
		   LJ_fac = 1
		end
	if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 2 then
	LJ_fac = 1
	end
	if  wugong == 1 and wglw(pid,1)>=1 then
	LJ_fac = LJ_fac * 2
	end
	if  match_ID(pid,149) then
	LJ_fac = LJ_fac * 2
	end
		--瑜伽密乘减少被连击的伤害，气攻
		--主运减少25%
		--被动减少15%
		--临济主运时减少50%
		if Curr_NG(eid, 169) then
			LJ_fac = LJ_fac - 0.25
		elseif PersonKF(eid, 169) then
			LJ_fac = LJ_fac - 0.15
		end
		if Curr_NG(eid, 175) then
			LJ_fac = LJ_fac - 0.5
		elseif PersonKF(eid, 175) then
			LJ_fac = LJ_fac - 0.25
		end
		if nglw(eid,169) >=1 then--
		   LJ_fac = LJ_fac - 0.1*WAR.ACT
		   if nglw(eid,169) >1 then--
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", 25*WAR.ACT)
		   end
		end

		if wugong == 5 then--
		   LJ_fac = LJ_fac + JY.Person[eid]["冰封程度"]/400
		end
	
        if wglw(pid, 49)>=1 and WAR.LMZS == 5 then
		   LJ_fac = LJ_fac + JY.Person[pid]["轻功"]/200
		   if wglw(pid,49)>2 then
		   LJ_fac = LJ_fac * 2
		   end
		end
	
		hurt = math.modf(hurt * LJ_fac)
		ang = math.modf(ang * LJ_fac)
		if match_ID_awakened(pid,152,1) then
		hurt = hurt + 50
		end
		if match_ID_awakened(pid,151,1) then
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", -50*WAR.ACT);
		end
		if pid==0 and zylw(1)>1 then
		local aa = -10*(WAR.ACT+3)
		if aa<=-150 then
		aa=-150
		end
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", aa);
		end
	end
  
	--无酒不欢：这里引入伤害二，计算保底伤害
	local hurt2 = 0

	--攻击方为我方，伤害二 = INT(攻方基础攻击/7 + 随机1~5) + INT(武功威力/15)
	if inteam(pid) then
		hurt2 = math.modf(math.random(5) + (atk) / 7) + math.modf(true_WL / 15)
	--攻击方为NPC，伤害二 = INT(攻方基础攻击/6 + 随机1~20) + INT(武功威力/13)
	else
		hurt2 = math.modf(math.random(20) + (atk) / 6) + math.modf(true_WL / 13)
	end
	--攻击方为NPC，伤害二 = 伤害二 * 1.2
	if not inteam(pid) then
		hurt2 = math.modf(hurt2 * 1.2)
	end
	
	--如果伤害一小于伤害二，则采用伤害二继续计算
	if hurt < hurt2 then
		hurt = hurt2
	end
	
	--无酒不欢：最终伤害计算，难度系数
	local difficulty_factor = 1;
	--我方攻击时
	if inteam(pid) then
		--难1，难2
		if JY.Base["难度"] == 1 or JY.Base["难度"] == 2 then
			difficulty_factor = 0.9;
		--难6
		elseif JY.Base["难度"] == 6 then
			difficulty_factor = 1.1;
		end
	--NPC攻击时
	else
		--难1
		if JY.Base["难度"] == 1 then
			difficulty_factor = 0.6;
		--难2
		elseif JY.Base["难度"] == 2 then
			difficulty_factor = 0.8;
		--难3，难4
		elseif JY.Base["难度"] == 3 or JY.Base["难度"] == 4 then
			difficulty_factor = 1.1;
		--难5
		elseif JY.Base["难度"] == 5 then
			difficulty_factor = 1.3;
		--难6
		elseif JY.Base["难度"] == 6 then
			difficulty_factor = 1.5;
		end
	end
	hurt = math.modf(hurt * 0.7 * difficulty_factor)
	
	--最终伤害 = 最终伤害 * (1 - 守方防御/5000)
	hurt =  math.modf(hurt * (1 - JY.Person[eid]["防御力"]/5000))
		
	--攻方面板上每个极+4%伤害，守方面板每个极-4%伤害
	hurt =  math.modf(hurt * (1 + (calc_mas_num(pid) - calc_mas_num(eid))* 0.04))
	
	--击中破绽，25%最高优先级伤害，行动前没有破绽，最多击中3次破绽
	--防御状态无破绽
	--主运圣火60%几率无视位置
	local pozhanpd = 0
	
	if WAR.CHZ[eid]~=nil and WAR.CHZ[eid]>=50 and JLSD(20,WAR.CHZ[eid],eid) then
	pozhanpd = 1
	end
	if WAR.Person[enemyid].Time >= -200 and WAR.Person[enemyid].Time <= 200 then
	pozhanpd = 1
	end
	if Curr_NG(pid, 93) and JLSD(20,80+nglw(pid,93)*10,pid) then
	pozhanpd = 1
	end
	if wglw(pid, 74)>1 and JLSD(20,80,pid) then
	pozhanpd = 1
    end
	if wglw(pid, 49)>=1 and WAR.LMZS== 2 and JLSD(20,80,pid) then
	pozhanpd = 1
    end
	if wglw(pid,47)>1 and WAR.DGPZ1[pid]~=nil and wugong == 47 and JLSD(20,80,pid) then
	pozhanpd = 2
	   if  WAR.Weakspot[eid] == nil then
	   WAR.Weakspot[eid] = 0
	   end
	end
	if WAR.MBZ[pid]~=nil and WAR.MBZ[pid]>=50 and JLSD(20,WAR.MBZ[pid],pid) then
	pozhanpd = 0
	end	
	if Curr_NG(eid,183) then
	pozhanpd = 0
	hurt = math.modf(0.8*hurt)
	end

	if WAR.Defup[eid] == nil and pozhanpd >= 1 and WAR.Weakspot[eid] ~= nil and (WAR.Weakspot[eid] < 3 or pozhanpd >1 ) and DWPD() then
		local xhurt = hurt
		if wglw(pid,47)>1 and wugong == 47 then
		hurt = math.modf(hurt * (1.25 +(WAR.Weakspot[eid] or 0) * 0.25 ))
		else
		hurt = math.modf(hurt * 1.25)
		end
		if PersonKF(eid,183) then
		hurt = xhurt
		end
		local a=0
		local pz_str = "击中破绽";
		if WAR.Weakspot[eid] == 1 then
			pz_str = "再中破绽";
		elseif WAR.Weakspot[eid] == 2 then
			pz_str = "三中破绽";
		elseif WAR.Weakspot[eid] > 2 and pozhanpd >1  then
		    pz_str = "屡中破绽";
		end
		WAR.Weakspot[eid] = WAR.Weakspot[eid] + 1
		if nglw(pid,87)>=1 then----
		 local YD=math.modf(JY.Person[eid]["中毒程度"]*nglw(pid,87)/3*WAR.Weakspot[eid])  
		 WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -YD)
		 pz_str = pz_str ..".毒爆";
		 a=10
		end
		if WAR.LMZS== 2 then
		WAR.BJ=1
		   if wglw(pid,49)>2 then
		   WAR.HTZD = {hurt, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
		   end
		end
		if wglw(pid,47)>=1 then----
         WAR.BJ=1
		 if wglw(pid,47)>1 and wugong == 47 then
		 WAR.ASKD1=1
		 WAR.ASKD2=WAR.DGPZ1[pid] or 0
		 end
		 pz_str = "【九破】"..pz_str ;
		 a=8 + WAR.ASKD2
		end
	   if wglw(pid, 74)>=1 and WAR.SHJG[pid] ~=nil and WAR.SHJG[pid]==1 and WAR.BJ==1 and DWPD() then
	    local aa= math.random(1,2)
		if aa ==1 then
		local bb =  math.modf(JY.Person[eid]["生命"]*0.05)
		local cc =  math.modf(JY.Person[eid]["生命"]*0.1)
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", bb)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -cc)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", cc)
		pz_str = pz_str ..".蝰吻";
		a = 3
		elseif aa == 2 then
		WAR.L_NOT_MOVE[eid] =1
		WAR.BZ[eid] = 1
		pz_str = pz_str ..".蟒缠";
		a= -2
		end
	   end	
		if MPPB_MJAS(pid) >= 1 and JLSD(10,40,pid) then--
		   WAR.BJ = 1
		   JY.Person[eid]["灼烧程度"]=JY.Person[eid]["灼烧程度"] +10
		   if JY.Person[eid]["灼烧程度"]>=50 then
		   JY.Person[eid]["灼烧程度"]=50
		   end
		      if JY.Wugong[wugong]["武功类型"] == 4 then
			     hurt = math.modf(hurt * 1.25)
			  end
		   pz_str = pz_str ..".神圣连剿";

		end
		if nglw(pid,93)>=1 and PersonKF(pid,93) then----
		 local YD=math.modf(JY.Person[eid]["灼烧程度"]*nglw(pid,93)/3*WAR.Weakspot[eid])  
		 WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -YD)
		 pz_str = pz_str ..".圣焰";
		 a=10
		end
		if match_ID_awakened(eid,38,2) then----
		hurt = 0
		pz_str ="红心.飒影"
		a=1
		end
		if match_ID_awakened(eid,43,1) then----
		hurt = 0
		WAR.ICE[pid] = 20
		WAR.L_HQNZL[eid] = (WAR.L_HQNZL[eid] or 0) + 10
		pz_str ="自在极意功.逍遥自在"
		a=1
		end
		if match_ID_awakened(pid,38,2) then----
		WAR.BJ=1
		pz_str =pz_str .."+红心.迅杀"
		a=WAR.Weakspot[eid]
		end
		
		if WAR.LYLZ2[pid] ~= nil and WAR.LYLZ2[pid] == 6 then
        WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0)+10*WAR.Weakspot[eid],0 ,50)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -150*WAR.Weakspot[eid])
		pz_str =pz_str .."+清阴.肃杀"
		a=WAR.Weakspot[eid]
		end
		
		if WAR.Person[enemyid]["特效文字0"] ~= nil then
			WAR.Person[enemyid]["特效文字0"] = pz_str.."+"..WAR.Person[enemyid]["特效文字0"]
		else
			WAR.Person[enemyid]["特效文字0"] = pz_str
		end
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63+a
		end
	end
	
	--落英神剑掌，配合桃花绝技，根据敌方内力耗损量追加伤害，上限+100%
	if wugong == 12 and TaohuaJJ(pid) and DWPD() then
		local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
		hurt = math.modf(hurt * (1 + mp_percentage))
	end

  	if WAR.JGHJ == 22 and DWPD() then
	    local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
        if d < 0 then
        d = 0
        end
  	    AddPersonAttrib(eid, "受伤程度",  d);
	    local SN=math.modf(JY.Person[eid]["受伤程度"]*1.5)
	    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -SN)
	    ;
  end
  
  if WAR.RWZ== 61 and DWPD() then --大日.日纹掌戾炎
         local d = math.modf(JY.Person[pid]["内力"]  / 300)
		   if d < 10 then
           d = 10
           end
		 local bb = WAR.LQZ[eid] or 0	 
         local aa = (WAR.LQZ[pid] or 0) + d
		 local SN=math.modf(aa+bb)
		 WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + SN, 0, 50)
		 AddPersonAttrib(eid,"受伤程度", SN)
		 WAR.MENG[eid] = SN
		 if wglw(pid,61)>2 then
		  WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -bb*3)
		  WAR.JHLY3[eid] = SN
		 end
		 if JuHuoLY(pid) then
		  WAR.HOT[eid] = SN
		 end
  end
 
  if WAR.RWZ== 41 and DWPD() then --大日.日纹掌戾炎
         local SN = MPDJ(pid)
		 WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + SN, 0, 50)
		 WAR.FXDS[eid] = limitX((WAR.FXDS[eid] or 0) + SN, 0, 50)
		 WAR.FXXS[eid] = 1
  end
  
   if WAR.RWZ== 42 and DWPD() then --大日.日纹掌戾炎
            local SN = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 300)
		   if SN < 0 then
           SN = 0
           end
		 WAR.CHZ[eid] = limitX((WAR.CHZ[eid] or 0) + SN, 0, 100)
		 WAR.CHXS[eid] = 1
  end
 
    if WAR.RWZ== 43 and DWPD() then --田归农血龙剑
            local SN = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 200)
		   if SN < 0 then
           SN = 0
           end
		 WAR.L_WNGZL2[eid] = limitX((WAR.L_WNGZL2[eid] or 0) + SN, 0, 100)
  end
  
    if WAR.RWZ== 44 and DWPD() then --田归农皇龙刀
            local SN = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 50)
		   if SN < 0 then
           SN = 0
           end
		 WAR.TLQJ[eid] = limitX((WAR.TLQJ[eid] or 0) + SN, 0, 500)
  end 
 
     if (WAR.SXB2== 1 or WAR.SXB2 == 5 )  and DWPD() then --田归农皇龙刀
		 WAR.TLQJ[eid] = limitX((WAR.TLQJ[eid] or 0) + 100, 0, 500)
     end 
 
    if WAR.WDZ == 62 and DWPD() then --大日.午刀一斩
         local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
		   if d < 10 then
           d = 10
           end
		local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
		local bb= math.modf(JY.Person[eid]["灼烧程度"] * (1 + mp_percentage))	 
		 local SN=math.modf(bb+d)
		 WAR.WMYH[eid] = SN
		 if JuHuoLY(pid) then
		 WAR.JHLY3[eid] = SN
		 end
  end
  
   if WAR.RMD_FM == 1 and DWPD() then --沼跃鱼：流刃若火
	local SN=math.modf(JY.Person[eid]["内力"]/100)
	local SN2=math.modf(SN*5)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -SN2);
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -SN);
	WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + SN, 0, 50)
	end
 
  if WAR.LH_DZ == 2 and DWPD() then --沼跃鱼：流刃若火
	local SN=WAR.LQZ[eid] or 0
	local SN2=math.modf(SN*5)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -SN2);
	hurt = hurt + math.modf(SN*1.5)
	WAR.LQZ[eid] = 0
	end
 
  if WAR.LFHM == 1 and DWPD() then --沼跃鱼：流刃若火
	local SN=WAR.LQZ[eid] or 0
	local SN2=math.modf(SN*5)
	hurt = hurt + math.modf(SN*1.5)
	WAR.HOT[eid] = WAR.LQZ[eid]
	WAR.LQZ[eid] = nil
	end 
 
   if WAR.LFHM == 2 and DWPD() then --沼跃鱼：流刃若火
	local SN=WAR.LQZ[eid] or 0
	local SN2=math.modf(SN*5)
	hurt = hurt + math.modf(SN*1.5)
	WAR.ICE[eid] = WAR.LQZ[eid]
	WAR.LQZ[eid] = nil
	end 
 
   if WAR.LQAY == 6 and DWPD() then --沼跃鱼：天翔十字凤
	local SN=math.modf(JY.Person[eid]["内力"]/100)
	local SN2=math.modf(SN*5)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) - SN2;
  	AddPersonAttrib(eid, "内力", -SN2);
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) - SN;
	AddPersonAttrib(eid, "生命", -SN);
	WAR.HOT[eid] = limitX((WAR.HOT[eid] or 0) + SN, 0, 50)
	end
  
 if WAR.XLDF == 1 and DWPD() then --沼跃鱼：修罗邪光斩
	local SN=WAR.LQZ[eid] or 0
	local SN2=math.modf(SN*5)
	WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +AddPersonAttrib(pid, "内力", SN2);
	WAR.LQZ[eid] = 0
	WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + SN, 0, 100)
	end 
 
    if WAR.XLDF == 3 and DWPD() then --沼跃鱼：修罗魔闪光
	local SN=WAR.LQZ[eid] or 0
	local aa = WAR.GYZ[eid] or 0
	local SN2=math.modf(SN*aa)
		JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] + SN
		WAR.ZSXS[eid] = 1
		if JY.Person[eid]["灼烧程度"]  >= 50 then
		JY.Person[eid]["灼烧程度"] = 50		
		end
		if SN>=50 then
		WAR.JHLY2[eid] = 50
		end
	     for j = 0, WAR.PersonNum - 1 do
			  local tmppid = WAR.Person[j]["人物编号"]
		       if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"]  and RealJL(enemyid, j, 3) and j~= enemyid then
		          WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -SN2)
		          JY.Person[tmppid]["灼烧程度"] = limitX((JY.Person[tmppid]["灼烧程度"] or 0) + SN, 0, 50)
				  WAR.TXXS[tmppid] = 1
		       end
	          end
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -SN2);
	WAR.LQZ[eid] = nil
	WAR.GYZ[eid] = nil
	end
 
  	if WAR.JGHJ  == 135 and DWPD() then
	    if JLSD(20,50,pid) then
		local mp_percentage = (JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])/JY.Person[eid]["内力最大值"]
		hurt = math.modf(hurt * (1 + mp_percentage))
	    local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
    if d < 10 then
      d = 10
    end
  	WAR.LXXS[eid] = 1
	WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + d, 0, 100)
	local n=math.random(1,6)
	if n>4 and n<6 then
	WAR.BZ[eid]=1
	end
       end	
  end
 
	--虚弱状态，伤害和杀气都减半
	if WAR.XRZT[pid] ~= nil and DWPD() then
		hurt = math.modf(hurt * 0.5)
		ang = math.modf(ang * 0.5)
	end

	if WAR.MBZ[pid] ~= nil and DWPD() then
	   if wglw(eid,126)>2 then
		hurt = math.modf(hurt * (1-WAR.MBZ[pid]/100))
		ang = math.modf(ang * (1-WAR.MBZ[pid]/100))
	   end
	end

	if WAR.MBZ[eid] ~= nil and DWPD() then
	   if WAR.ZLBH[eid]~=nil then
       WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -WAR.ZLBH[eid]*WAR.MBZ[eid]);
	   end
	   if WAR.XSBL[eid]~=nil then
       hurt = hurt + WAR.MBZ[eid]* WAR.XSBL[eid] ;
	   end
	   if WAR.BAHK[eid]~=nil then
       ang = ang + WAR.MBZ[eid]* WAR.BAHK[eid] * 10
	   end
	end
	
	if WAR.YANGFU[eid] ~= nil and DWPD() then
		hurt = math.modf(hurt * 0.5)
		ang = math.modf(ang * 0.5)
	end	

	if WAR.TZ_XZ_SSH[pid]~= nil and WAR.TZ_XZ_SSH[pid]>1 and DWPD() then--
	    local aa = 1-(WAR.TZ_XZ_SSH[pid] * 0.05)
		if  aa< 0.25 then
		aa = 0.25
		end
		hurt = math.modf(hurt * aa)
		ang = math.modf(ang * aa)
		if WAR.NGJL > 0 then
		WAR.FXDS[pid] = limitX((WAR.FXDS[pid] or 0)+WAR.TZ_XZ_SSH[pid]*5,0,50)
		WAR.FXXS[pid] = 1
		JY.Person[pid]["冰封程度"] = limitX(JY.Person[pid]["冰封程度"] + WAR.TZ_XZ_SSH[pid]*5,0,100)
		WAR.BFXS[pid] = 1
		end
	end
 
	--尼摩星伤害永久提高1.5倍
	if match_ID(pid, 159) and DWPD() then
		hurt = math.modf(hurt * 1.5)
	end

		--范遥挨打加减伤，上限20%
	if WAR.GMYS[eid] ~= nil  and DWPD()then
		local rd = 100 - (WAR.GMYS[eid])
		hurt = math.modf(hurt * rd/100)
	end

	--虚弱状态，伤害和杀气都加倍
	if WAR.XRZT[eid] ~= nil  and DWPD() then
		hurt = math.modf(hurt * 2)
		ang = math.modf(ang * 2)
	end
	
	if WAR.YANGFU[pid] ~= nil  and DWPD() then
		hurt = math.modf(hurt * 2)
		ang = math.modf(ang * 2)
	end

	if WAR.TZ_XZ_SSH[eid]~= nil and WAR.TZ_XZ_SSH[eid]>1 and DWPD() then--
	    local aa = 1+(WAR.TZ_XZ_SSH[eid] * 0.05)
		if  aa> 1.75 then
		aa = 1.75
		end
		hurt = math.modf(hurt * aa)
		ang = math.modf(ang * aa)
		if WAR.NGHT > 0 then
		WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0)+WAR.TZ_XZ_SSH[eid]*5,0,100)
		WAR.LXXS[eid] = 1
		JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] + WAR.TZ_XZ_SSH[eid]*5
		WAR.ZSXS[eid] = 1
		if JY.Person[eid]["灼烧程度"]  >= 50 then
		JY.Person[eid]["灼烧程度"] = 50		
		end
		end
	end
	
	--被杨逍击中的人，伤害增加1%，上限20%
	if WAR.GMZS[eid] ~= nil and DWPD() then
		local bn = 100 + WAR.GMZS[eid]
		hurt = math.modf(hurt * bn/100)
	end

 --陈家洛
if match_ID(eid,75) then
   if JY.Person[pid]["性别"] ~= 0 then
   hurt = math.modf(hurt * 0.85)
   end
end	

if match_ID(pid,75) then
   if JY.Person[eid]["性别"] ~= 0 then
   hurt = math.modf(hurt * 1.15)
   end
end	
	
	if wglw(pid, 58)>0 and WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100 then
		hurt = math.modf(hurt * 1.15)
		if WAR.LQZ[eid]==nil then
		hurt = math.modf(hurt * 1.25)
		elseif (WAR.LQZ[eid]~=nil and WAR.LQZ[eid]<=50 )  then
		hurt = math.modf(hurt * (1+(50-WAR.LQZ[eid])/200))
		end
	end

	if wglw(eid, 58)>2 and WAR.LQZ[eid]~=nil and WAR.LQZ[eid]==100 then
		hurt = math.modf(hurt * 0.75)
	end	
	
	--周芷若，每个内功减少受到的5%伤害
	if match_ID(eid, 631) then
		local zzr = 0
		for i = 1, CC.Kungfunum do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 6 then
				zzr = zzr + 1
			end
		end
		hurt = math.modf(hurt * (1 - 0.05 * (zzr)));
	end


	
	--主角拳系，每个拳法练到极，增加造成的5%伤害
	if JY.Base["标准"] == 1 and pid == 0 then
		local lxzq = 0
		for i = 1, CC.Kungfunum do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功等级" .. i] == 999 then
				lxzq = lxzq + 1
			end
		end
		if lxzq > 7 then
			lxzq = 7
		end
		hurt = math.modf(hurt * (1 + 0.05 * (lxzq)))
	end

	--陈家洛，每个拳法练到极，增加造成的5%伤害
	if T7DFWM(pid) or wglw(pid,10)>=1 then
		local lxzq = wgnumber(pid, 1)
		hurt = math.modf(hurt * (1 + 0.05 * (lxzq)))
	end
	
	--主角拳系，每个拳法练到极，减少受到的5%伤害
	if JY.Base["标准"] == 1 and eid == 0 then
		local lxzq = 0
		for i = 1, CC.Kungfunum do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 1 and JY.Person[0]["武功等级" .. i] == 999 then
				lxzq = lxzq + 1
			end
		end
		if lxzq > 7 then
			lxzq = 7
		end
		hurt = math.modf(hurt * (1 - 0.05 * (lxzq)));
	end
	  
	--主角刀系，每个刀法练到极，减少受到的5%伤害
	if JY.Base["标准"] == 4 and eid == 0 then
		local askd = math.min(wgnumber(eid, 4),7)
		hurt = math.modf(hurt * (1 - 0.05 * (askd)))
	end
	
	if T7DFWM(eid) then
		local askd = wgnumber(eid, 4)
		hurt = math.modf(hurt * (1 - 0.05 * (askd)))
	end	

  if MPPD(eid) == 5 then --沼跃鱼：明教防御效果
    local p = JY.Person[eid]
    local tymj2 = p["内力"]
	if tymj2 >= 7000 then
      hurt = math.modf(hurt * 0.8)
	elseif tymj2 >= 5000 then
	  hurt = math.modf(hurt * 0.85)
	elseif tymj2 >= 3000 then
	  hurt = math.modf(hurt * 0.9)	  
	elseif tymj2 >= 1000 then
	  hurt = math.modf(hurt * 0.95)
	end
  end 

  if MPPD(eid) == 2 then --武当防御+15%
	hurt = math.modf(hurt * 0.85)
  end

   if MPPD(pid) == 2 then --武当攻击-10%
	hurt = math.modf(hurt * 0.9)
  end 
  
	--罗汉伏魔提升伤害和杀气效果为：[(当前内力值/500)×(武功消耗内力/140)]%
	if WAR.NGJL == 96 then
		local nlmod = JY.Person[pid]["内力"]/5000
		local wgmod = JY.Wugong[wugong]["消耗内力点数"]/200
		local totalmod = 1 + nlmod * wgmod;
		--石破天效果提高1.1倍
		if match_ID(pid, 38) then
			totalmod = totalmod * 1.1;
		end
		if nglw(pid,96)>0 then
		    totalmod = totalmod * (1+0.2*nglw(pid,96));
			if WAR.LHT>0 then
			totalmod = totalmod *(1+WAR.LHT*0.05*nglw(pid,96))
			end
		end
		ang = math.modf(ang * totalmod)
		hurt = math.modf(hurt * totalmod)
	end

	if WAR.LXFM == 1 then
	    local mpdj = MPDJ(pid)
		local nlmod = 2-(JY.Person[eid]["内力"]/5000) --改弱了一点
		local wgmod = JY.Wugong[wugong]["消耗内力点数"]/200
		local totalmod = 1 + nlmod * wgmod;
		totalmod = totalmod * (1+0.1*mpdj)
	    ang = math.modf(ang * totalmod)
		hurt = math.modf(hurt * totalmod)
	end
	
		--进阶云雾，对于半血以下敌人伤害*2
	if wugong == 32 and nglw(pid, 89)>=1 and JY.Person[eid]["生命"]<JY.Person[eid]["生命最大值"]/2 then
		hurt = math.modf(hurt * 2)
	end

	if WAR.L_WYJFA2 == 2 and DWPD() then
		hurt = math.modf(hurt * 1.5)
	end
	
	if WAR.LHQ_BNZ == 1 then		--般若掌 伤害+50
		hurt = hurt + 70
		ang = ang + 500
	end
	if WAR.JGZ_DMZ == 1 then		--达摩掌 伤害+100
		hurt = hurt + 100
	end
	if WAR.WD_CLSZ >= 1 then		--赤练神掌 伤害
		hurt = hurt +70
		if match_ID_awakened(pid,161,1) or WAR.WD_CLSZ == 2 then
		local aa=JY.Person[eid]["中毒程度"]/50+math.random(1,3)
		hurt = math.modf(hurt * aa)
		end
	end

	if  WAR.WD_CLSZ == 2 then
		local aa=JY.Person[eid]["中毒程度"]/50+math.random(1,3)
		hurt = math.modf(hurt * aa)
	end	
	
	
	if WAR.LHQ_FM  == 1 then		--伏虎罗汉拳 伤害+70
		hurt = hurt + 100
		ang = ang + 300
	end	
	
	if WAR.YTML1 >0  then
	   hurt = hurt + JY.Person[eid]["中毒程度"]*1.5
	end
	
	if 	WAR.XLZ_FM  == 1 then		--摩诃掌 伤害+70
		hurt = hurt + 50
	end
    if  WAR.JGHJ > 0 then----
        hurt = hurt + 50
    end	
	if  WAR.JGHJ == 121 then---铁指寸劲
		ang = ang + 500
	end
	
	if  WAR.JGHJ == 19 then---混元化境幻阴
		ang = ang + 500
	end
	
	if  WAR.JGHJ == 35 then---自在极意
		ang = ang + JY.Person[eid]["冰封程度"]*10
	end
	

	
	--九剑真传，倒剑式强制杀集气
	if WAR.JJZC == 2 and DWPD() then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 120
		if D3FQY(pid) then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 180
		WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 20
		end
	end

	if WAR.XLAY_DZ == 1 and DWPD() then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 10*WAR.XLAY_LH
		hurt = hurt + 1000- WAR.Person[enemyid].Time
		if WAR.XLAY_LH >= 10 then
		WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 20
		end
	end

	if WAR.XLAY_DZ == 4 and DWPD() then
		local aa = WAR.SPIRIT[eid] or 0
		if aa>90  then
		WAR.SPIRIT[eid] = 90
		aa = aa - 90
		hurt = hurt + aa * 10
		else
		aa = 90 - aa
		hurt = hurt + aa * 10
		end
		if WAR.XLAY_LH >= 10 then
		WAR.JSCL[eid] = (WAR.JSCL[eid] or 0) + 20
		end
	end

	if WAR.TGDQ7 == 1 and DWPD() then
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
		WAR.LHFM[eid] = (WAR.LHFM[eid] or 0) + 20
	end
	
	--无酒不欢：最高优先级的增减伤

	--阿紫曼珠沙华，血量越低伤害越高，100%血无加成，0血100%加成
	if match_ID(pid, 47) and WAR.JYZT[pid]~=nil then
		local bonus_perctge = 0
		bonus_perctge = 2 - JY.Person[pid]["生命"] / JY.Person[pid]["生命最大值"]
		hurt = math.modf(hurt * bonus_perctge)
	end
	
	--装备鸳鸯刀，6级，夫妻伤害提高20%
	if JY.Person[pid]["武器"] == 217 and wugong == 62 and JY.Thing[217]["装备等级"] == 6 then
		hurt = math.modf(hurt*1.2);
	end
	if JY.Person[pid]["武器"] == 218 and wugong == 62 and JY.Thing[218]["装备等级"] == 6 then
		hurt = math.modf(hurt*1.2);
	end
	
	--琴棋书画之倚天屠龙功，增伤20%
	if WAR.QQSH3 == 1 then
		hurt = math.modf(hurt*1.2);
	end
	
	--九剑真传，撩剑式伤害+30%
	if WAR.JJZC == 3 and DWPD() then
		hurt = math.modf(hurt*1.3);
		if D3FQY(pid) then
		WAR.BJ = 1
		end
	end


	
	--郭靖的降龙十八掌，有余不尽
	if WAR.YYBJ > 0 then
		hurt = math.modf(hurt*(1+0.08*WAR.YYBJ));
	end
	
	--小无减伤10%
	if Curr_NG(eid, 98) then
		hurt = math.modf(hurt*0.9);
	end
	
	--九阳减伤30%
	--阳内主运或者阳罡学会九阳后
	if Curr_NG(eid, 106) and (JY.Person[eid]["内力性质"] == 1 or (eid == 0 and JY.Base["标准"] == 6)) then
		hurt = math.modf(hurt*0.7);
	--被动减伤10%
	elseif PersonKF(eid, 106) and (JY.Person[eid]["内力性质"] == 1 or (eid == 0 and JY.Base["标准"] == 6)) then
		hurt = math.modf(hurt*0.9);
	end

		if Curr_NG(eid, 166)  then--天池心法减伤
			hurt = math.modf(hurt *0.8)
			ang = math.modf(ang *0.8)
		elseif hurt > 30 and PersonKF(eid, 166)  then
			hurt = math.modf(hurt *0.9)
			ang = math.modf(ang *0.9)
		end 
	
	--九阴减伤10%
	--学会九阴并且是阴内或者天罡
	if PersonKF(eid, 107) and (JY.Person[eid]["内力性质"] == 0 or (eid == 0 and JY.Base["标准"] == 6)) then
		hurt = math.modf(hurt*0.9);
	end
	
	--九阴增伤20%
	--阴内主运或者阴罡学会九阴后
	if Curr_NG(pid, 107) and (JY.Person[pid]["内力性质"] == 0 or (pid == 0 and JY.Base["标准"] == 6)) then
		hurt = math.modf(hurt*1.2);
	end
	
	if nglw(pid,87)>1 and JLSD(25, 75, pid) and PersonKF(pid,87) and DWPD() then
	  local YD=math.modf(JY.Person[eid]["中毒程度"]*nglw(pid,87)/8)
      WAR.L_WNGZL[eid] = (WAR.L_WNGZL[eid] or 0) + YD
	  WAR.POISON[eid] = (WAR.POISON[eid] or 0) + YD
	  	if WAR.Person[enemyid]["特效文字0"] ~= nil then
			WAR.Person[enemyid]["特效文字0"] = "神木毒髓.侵入心脉".."+"..WAR.Person[enemyid]["特效文字0"]
		else
			WAR.Person[enemyid]["特效文字0"] = "神木毒髓.侵入心脉"
		end
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 79
		end
	end 

	if match_ID_awakened(eid,60,1) and  DWPD() and WAR.NGHT>0 then----
        local YD=math.modf(JY.Person[pid]["中毒程度"]/150)
		hurt = math.modf(hurt*(1-YD));
		local str = "白驼秘法.万蛇护身"
		if JLSD(10,60,eid) then
        WAR.L_WNGZL2[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
		if JY.Person[pid]["中毒程度"] >=50 then----
		WAR.RXSD[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
        str = "白驼秘法.蛇毒溶血"		
		end
		end
        Set_Eff_Text(enemyid, "特效文字1", str)
	end	

	if MPPB_BTLS(eid)>=1 and  DWPD() and WAR.NGHT>0 then----
        local YD=math.modf(JY.Person[pid]["中毒程度"]/150)
		hurt = math.modf(hurt*(1-YD));
		local str = "白驼秘法.灵蛇心诀"
        WAR.L_WNGZL2[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
		if MPPB_BTLS(eid)>=2 then
		WAR.QSLZ[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
        WAR.RXSD[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
		end
        Set_Eff_Text(enemyid, "特效文字1", str)
	end	

   if wglw(eid,134)>1 and  DWPD() then
      if WAR.L_WNGZL3[pid]~=nil then
	  WAR.LXZT[pid] = (WAR.LXZT[pid] or 0) + 20
	  if WAR.LXZT[pid]>=100 then
	  WAR.LXZT[pid] = 100
	  end
	  local reduction =  WAR.LXZT[pid]*3
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+reduction;
	   AddPersonAttrib(eid, "生命", reduction)
	  Set_Eff_Text(enemyid, "特效文字4", "凝血秘法.虹吸")
	  end  
   end
	
	if wglw(eid,3)>2 and WAR.NGHT>0 and DWPD() then----
        local YD=math.modf(JY.Person[pid]["中毒程度"]/150)
		hurt = math.modf(hurt*(1-YD));
		ang = math.modf(ang*(1-YD))
		local str = "五毒秘传.钓蟾劲"
        WAR.QSLZ[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
        WAR.RXSD[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
        Set_Eff_Text(enemyid, "特效文字1", str)
	end	
	
 if nglw(eid,169)>1 and Curr_NG(eid,169) then--沼跃鱼：二阶瑜伽主运效果
         local str=""
		 if JLSD(20,65,eid) and WAR.NGHT >0 then
		 local tmp=math.modf(hurt*nglw(eid,169));
		 local tmp1=math.modf(hurt*nglw(eid,169)/20);
		 dng=1;
		 WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +tmp;
  	     AddPersonAttrib(eid, "内力", tmp);
		 AddPersonAttrib(pid, "受伤程度", tmp1);
		 WAR.L_HQNZL[eid]=50+tmp1
		 str="瑜伽秘法.罗喉霸体"
		 else
		 str="瑜伽秘法.达迦金身"
		 if ang>= nglw(eid,169)*300 then
		 ang=ang-nglw(eid,169)*300;
		 else
		 ang=0
		 end
		 end
        Set_Eff_Text(enemyid, "特效文字3", str)
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 115
		end	
	end

  if WAR.SH[eid] ~= nil or WAR.ZBX[eid] ~= nil or WAR.SH1[eid] ~= nil then --锁喉/醉八仙/状态不被杀气--17-2-18
	ang = 0
  end	
	
  if match_ID_awakened(pid,47,1) and JLSD(25, 75, pid) and
	WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
	local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 100)
	local str=""
    if d < 10 then
      d = 10
    end
  	WAR.POISON[eid] = limitX((WAR.POISON[eid]  or 0) + d, 0, 100)
	local n=math.random(1,6)
	if n==1 then
    WAR.HMZT[eid] = 1
	str=".惊魂曲"
	elseif n==2 then
	WAR.ICE[eid] = limitX((WAR.ICE[eid] or 0) + d, 0, 100)
	str=".安魂曲"
	elseif n==3 then
	local reduction=-250
    WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+reduction*2;
	AddPersonAttrib(eid, "内力", reduction*2);
	str=".洗魂曲"
    elseif n==4 then
	WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + d, 0, 100)
    str=".断魂曲"
	elseif n==5 then
	WAR.LHFM[eid]=	limitX((WAR.LHFM[eid] or 0) + d, 0, 100)
	str=".夺魂曲"
    else
	WAR.BZ[eid]=1
	str=".镇魂曲"
	end
	WAR.AZ=WAR.AZ+50
	if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "紧那罗.彼岸夜曲"..str
	else
		WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "紧那罗.彼岸夜曲"..str
	end	
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 65
		end
  end	

  if nglw(pid,107)>1 and WAR.NGJL >0 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
	local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 100)
	local str=""
    if d < 10 then
      d = 10
    end
	local n=math.random(1,5)
	if n==1 then
    WAR.HMZT[eid] = 1
	str=".惊魂"
	elseif n==2 then
	WAR.ICE[eid] = d
	str=".安魂"
    elseif n==3 then
	WAR.MENG[eid] = limitX((WAR.MENG[eid] or 0) + d, 0, 100)
    str=".断魂"
	elseif n==4 then
	WAR.LHFM[eid]=	limitX((WAR.LHFM[eid] or 0) + d, 0, 100)
	str=".夺魂"
    else
	WAR.BZ[eid]=1
	WAR.L_NOT_MOVE[eid] = 1
	str=".无相音罡"
	end
	if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "【鬼狱阴风功】"..str
	else
		WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "【鬼狱阴风功】"..str
	end	
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 65
		end
  end
	
	--龙象减伤10%
	if Curr_NG(eid, 103) then
		hurt = math.modf(hurt*0.9);
	end
	
	--龙象增伤10%
	if Curr_NG(pid, 103) then
		hurt = math.modf(hurt*1.1);
	end
	
	--血河神鉴增伤10%
	if Curr_NG(pid, 163) then
		hurt = math.modf(hurt*1.1);
	end
	
	--无崖子被异性攻击减伤20%
	if match_ID(eid, 116) and JY.Person[pid]["性别"] == 1 then
		hurt = math.modf(hurt*0.8);
	end
	
	--无崖子对异性攻击增伤20%
	if match_ID(pid, 116) and JY.Person[eid]["性别"] == 1 then
		hurt = math.modf(hurt*1.2);
	end

	if match_ID_awakened(pid,2,1) and JY.Person[eid]["中毒程度"]>0 then --程灵素七星神木
       hurt = math.modf(hurt*1.2)
	   hurt = hurt + math.modf((JY.Person[eid]["中毒程度"]) * 0.5)
	end

	if match_ID_awakened(eid,2,1) and JY.Person[pid]["中毒程度"]>0 then --程灵素七星神木
       hurt = math.modf(hurt*0.8)
	   local YD=math.modf(JY.Person[pid]["中毒程度"]*0.3)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", YD)
	end

    if wglw(eid,74)>1 then
	   if WAR.SHJG[eid]~=nil and WAR.SHJG[eid] == 1 then
	   local aa = JY.Person[pid]["中毒程度"]
       hurt = math.modf(hurt*1-(aa/200))
	   local YD=math.modf(aa*0.3)
	   local YD2 = math.modf(JY.Person[pid]["内力"]*0.01)
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -YD)
       WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", YD2) 
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
    	WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "咏春蛇形.蛇御手"
        else
    	WAR.Person[enemyid]["特效文字2"] = "咏春蛇形.蛇御手"
        end
WAR.Person[enemyid]["特效动画"] = 113		
		end	
	end

   if wglw(pid,74)>1 then
	   if WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 1  and wugong == 74 and WAR.BJ== 1 then
	   local YD=math.modf(JY.Person[pid]["中毒程度"]*1.25)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -YD)
       WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命",-YD) 
	   if wglw(pid,81)>=1 then
	   addeffect2(WAR.SPXT,pid,1)
	   end
	   if wglw(pid,74)>2 then
	   addeffect2(WAR.LSQ,eid,30)
	   addeffect2(WAR.QSLZ,eid,30)
	   end
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
    	WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "咏春蛇形.烈咬"
        else
    	WAR.Person[enemyid]["特效文字2"] = "咏春蛇形.烈咬"
        end	
		end	
	end
	
  if nglw(eid,100)>1 and hurt > 0 and WAR.NGHT>0 and JY.Person[eid]["内力"] >= hurt and DWPD()  then --沼跃鱼：大理天南护体
    hurt = math.modf(hurt*0.5)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", -hurt);
	Set_Eff_Text(enemyid, "特效文字0", "先天一炁.气脉御心")
	WAR.Person[enemyid]["特效动画"] = 43	
  end	

      	if Curr_NG(eid, 87) and nglw(eid,87)>= 3 then --化功三阶
		local jj = math.max(math.modf(JY.Person[eid]["用毒能力"]/10),6)
		if JLSD(10, 25 + jj, eid) then
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 5)
			WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", math.random(jj-5, jj+5))
			local bl = math.modf((jj + 2)*20)
			local bl2 = math.modf((jj + 2)*4)
			WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -bl2)
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", bl2)
			WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -bl)
			WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", bl)			
			WAR.Person[enemyid]["特效动画"] = 40
			Set_Eff_Text(enemyid, "特效文字2", "神木毒王.天星飞舞") 	
		end
	end 
  
   if match_ID_awakened(eid,75,1) and DWPD() then --陈家洛觉醒后25%几率内力代替伤害
	if hurt > 10 and JY.Person[eid]["内力最大值"] >= 5000 and 
		JY.Person[eid]["内力"] >= math.modf(hurt * 1.5) and JLSD(10, 35, eid) then		
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) - math.modf(hurt * 1.5)
		AddPersonAttrib(eid, "内力", -math.modf(hurt * 1.5))
		hurt = 10
		Set_Eff_Text(enemyid, "特效文字0", "卸劲护元")
	end
  end 
 
  if match_ID_awakened(eid,75,1) and DWPD() then --东方未明觉醒后35%伤害-1/3
	if JY.Person[eid]["防御力"] >= 350 and JLSD(30, 65, eid) then
		hurt = math.modf(hurt * (2 / 3))
        Set_Eff_Text(enemyid, "特效文字0", "铜身铁臂")
		WAR.Person[enemyid]["特效动画"] = 39
	end
  end  
 
	for j = 0, WAR.PersonNum - 1 do --沼跃鱼：萧峰帝释天威效果--己方加防
	  if match_ID(WAR.Person[j]["人物编号"], 50) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
		 local aa=WAR.Person[j]["人物编号"]
		 local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end	
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 hurt = math.modf(hurt * (1-cc))
		 end
	 end
	 
	for j = 0, WAR.PersonNum - 1 do --沼跃鱼：萧峰帝释天威效果--敌方减攻
	  if  match_ID(WAR.Person[j]["人物编号"], 50) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
		 local aa=WAR.Person[j]["人物编号"]
		 local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end		 
		 if  WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 hurt = math.modf(hurt * (1-cc))
		 end
	 end

	for j = 0, WAR.PersonNum - 1 do --沼跃鱼：萧峰帝释天威效果--敌方减防
	  if match_ID(WAR.Person[j]["人物编号"], 50)  and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] then
		 local aa=WAR.Person[j]["人物编号"]
         local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 hurt = math.modf(hurt * (1+cc))
		 end
	 end
	 
	for j = 0, WAR.PersonNum - 1 do --沼跃鱼：萧峰帝释天威效果--己方加攻
	  if match_ID(WAR.Person[j]["人物编号"], 50)  and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
		 local aa=WAR.Person[j]["人物编号"]
         local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 hurt = math.modf(hurt * (1+cc))
		 end
	 end	 

	for j = 0, WAR.PersonNum - 1 do --沼跃鱼：凶魂阵效果--己方加攻
	     local aa=WAR.Person[j]["人物编号"]
	  if WAR.LSDZ[aa] ~= nil and WAR.LSDZ[aa] == 1  and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and RealJL(j, WAR.CurID, 1+wglw(aa,51)*2) then		 
         local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 hurt = math.modf(hurt * (1+cc))
		 end
	 end


 	if wglw(eid,127)>2 and PersonKF(eid,39) and WAR.Defup[eid]~=nil and WAR.ACT == 1 then----
			local s= WAR.CurID
            WAR.CurID = enemyid
			hurt = math.modf(hurt *0.6)
			ang = math.modf(ang *0.6)
            CurIDTXDH(WAR.CurID, 135,1, "最终奥义.天破活杀", C_RED)
			WAR.Person[enemyid]["特效动画"] = 135
			WAR.FXDS[pid] = 30
			WAR.MKDS[pid] = 7
			if JLSD(10,40,eid)then----
			WAR.MK_CH[pid] = 1
			end
            WAR.CurID = s			
	end	
 
	--扫地老僧
	if match_ID(eid, 114) and JLSD(25, 50 + math.modf(JY.Person[eid]["实战"]/20),eid) then
	    local str = "天佛化生·金刚护体"
		hurt = math.modf(hurt*0.5);
		if match_ID_awakened(eid, 114,1) or JLSD(25, 50 + math.modf(JY.Person[eid]["实战"]/20),eid) then--
		   str = "孔雀明王·大悲悯世"
		   hurt = math.modf(hurt*0.5);
		   WAR.KONGQUE[eid] = limitX((WAR.KONGQUE[eid] or 0) + 1,0,5) 
		end
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+"..str
		else
			WAR.Person[enemyid]["特效文字3"] = str
		end
	end
	
	if match_ID(eid, 114) and JLSD(10,60,eid)  then
		WAR.FLHS4_2 = 1
		local str ="天佛.如山"
		WAR.KONGQUE[eid] = limitX((WAR.KONGQUE[eid] or 0) + 1,0,5)
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+"..str
		else
			WAR.Person[enemyid]["特效文字3"] = str
		end
	end	

	if wglw(eid, 53)>=2 and JLSD(10,60,eid)  then
		WAR.FLHS4 = 2
		local str ="南山天柱.如山"
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+"..str
		else
			WAR.Person[enemyid]["特效文字3"] = str
		end
	end	

	if match_ID(eid, 400) and JLSD(25, 50 + math.modf(JY.Person[eid]["实战"]/20),eid) then
		hurt = math.modf(hurt*0.75);
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+少林罗汉·铁布衫"
		else
			WAR.Person[enemyid]["特效文字3"] = "少林罗汉·铁布衫"
		end
	end
	
	if Curr_NG(eid,102) and WAR.NGHT>0 and FanPuGZ(eid) then
		hurt = math.modf(hurt*0.75);
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", 200)
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+返璞归真·混元太玄"
		else
			WAR.Person[enemyid]["特效文字3"] = "返璞归真·混元太玄"
		end
	end	

	if wglw(eid,2)>1 and JLSD(25, 50 + wglw(eid,2) * 10,eid) then
	    local aa = math.modf(JY.Person[pid]["轻功"]*0.1* wglw(eid,2))
		hurt = hurt-aa;
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", aa*10)
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+逍遥·鹏飞诀"
		else
			WAR.Person[enemyid]["特效文字3"] = "逍遥·鹏飞诀"
		end
	end

	if wglw(eid,1)>1 and JLSD(25, 50 + math.modf(JY.Person[eid]["实战"]/20),eid) and WAR.NQHR[eid]~=nil then
	local str = "天地玄宗.金光咒"
    reseteffect2(WAR.NQHR, eid, 1)	
	    if wglw(eid,1)>2 and WAR.NGHT>0 then
		   if hurt>0 then
		   hurt = -hurt
		   end
		WAR.KHCM[pid] = 2
		str = "以炁化形.明光铠"
		else
		hurt = math.modf(hurt*0.66);
		end
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+"..str
		else
			WAR.Person[enemyid]["特效文字3"] = str
		end
	end
	
	if match_ID_awakened(eid,97,1) and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and hurt > 10 then --eid == 616 武骧金星：单通判定修正
		for j = 0, WAR.PersonNum - 1 do
			if WAR.XDLZ2[WAR.Person[j]["人物编号"]] == 1 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
				hurt = math.modf(hurt*0.33)
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - hurt	
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - hurt;
				SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 2);
				WAR.Person[enemyid]["特效文字3"] = "血神子·傀儡移伤"
				break
			end
		end
	end	
	
if nglw(eid,163)>2 and  PersonKF(eid,163) then
     if WAR.LXZT[eid]~=nil then
	    local aa= WAR.LXZT[eid]
		hurt = math.modf(hurt * (1-(aa/200)))
		WAR.XQZZ[pid]=(WAR.XQZZ[pid] or 0) + 1
		WAR.Person[enemyid]["特效动画"] = 146
		Set_Eff_Text(enemyid,"特效文字2","血神.血盾御敌");
	end
 end

  if wglw(eid,63)>1 and PersonKFJ(eid,63) then
          local aa=math.modf((JY.Person[eid]["生命最大值"]-JY.Person[eid]["生命"] )/40)
	      local bb=aa*0.01
	           if bb>=0.35 then
	              bb=0.35
	           end
	      hurt = math.modf(hurt * (1-bb))
		 if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "血纹奥义.凝血成符"
		else
			WAR.Person[enemyid]["特效文字2"] ="血纹奥义.凝血成符"
		end	
		addeffect2(WAR.XUEFU,eid,1)
  end
  
  if wglw(eid,63)>2 and JY.Person[eid]["生命"]<= math.modf(JY.Person[eid]["生命最大值"]*0.25) and PersonKFJ(eid,63) then
       if WAR.XUEFU[eid]~=nil and WAR.XUEFU[eid]>= 0 then
	        local aa=WAR.XUEFU[eid]
	         WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa*100)
		 if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "血纹奥义.血气唤醒"
		else
			WAR.Person[enemyid]["特效文字2"] ="血纹奥义.血气唤醒"
		end	
		WAR.XUEFU[eid]=0
	 end
  end
 
   if wglw(eid,120)>1 and JY.Person[eid]["生命"]<= math.modf(JY.Person[eid]["生命最大值"]*0.5) and WAR.BCB1 == 0 then
	   Set_Eff_Text(enemyid,"特效文字0","冰蚕奥义.妖蝶变");
       WAR.BCB[eid]=50
	   WAR.BCB1 = 1
	   WAR.Person[enemyid]["特效动画"] = 47
  end
 
   if wglw(eid,120)>1 and WAR.YDXT[eid]~=nil and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and JLSD(25, 50 + math.modf(JY.Person[eid]["实战"]/20),eid) then
 
	   Set_Eff_Text(enemyid,"特效文字2","夜蝶.月影暗浮");
	   WAR.ICE[pid]=(WAR.ICE[pid] or 0) +10
       WAR.HIDE[eid] = (WAR.HIDE[eid] or 0) +10	   
	   WAR.Person[enemyid]["特效动画"] = 49
  end
 

 
	--黄蓉奇门遁甲，红色增伤
	if WAR.Person[WAR.CurID]["我方"] == true and GetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"],6) == 2 then
		hurt = math.modf(hurt*1.2);
	end
	
	--黄蓉奇门遁甲，绿色减伤
	if WAR.Person[enemyid]["我方"] == true and GetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"],6) == 1 then
		hurt = math.modf(hurt*0.8);
	end
	
	--黄蓉奇门遁甲，蓝色增加杀气
	if WAR.Person[WAR.CurID]["我方"] == true and GetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"],6) == 3 then
		ang = ang + 2000
	end
	
	if WAR.TZQJ == 12 and wugong == 18 then----先天弹指气劲
        hurt = hurt + math.modf(ang*0.35)
	end	

	if WAR.TZQJ == 12 and yongnei(wugong) then----先天弹指气劲
        hurt = hurt + math.modf(ang*0.35)
	end	
	
	--天罡大招，伤害增加30%
	if WAR.JSTG == 1 then
		hurt = math.modf(hurt*1.3);
	end
	
	--灼烧追加真实伤害
	if JY.Person[eid]["灼烧程度"] > 0 and DWPD() then
	    local a = hurt
		hurt = hurt + JY.Person[eid]["灼烧程度"]
		if WAR.HOT[eid]~=nil and WAR.HOT[eid]>0 then----
		hurt = hurt + math.modf(JY.Person[eid]["灼烧程度"]/2)
		end
		if wglw(eid,8)>2 or match_ID_awakened(eid, 116,1) or match_ID_awakened(eid, 117,1) then
		hurt = a
		hurt = math.modf(hurt*JY.Person[eid]["灼烧程度"]/75)
		end
		if wglw(pid,61)>=1 then----
		if WAR.JWLeech < wglw(pid,61) *50 then
			WAR.JWLeech = WAR.JWLeech + limitX(math.modf(0.3* JY.Person[eid]["灼烧程度"]),0,wglw(pid,61) *50)
			if WAR.JWLeech  > wglw(pid,61) *50 then
				WAR.JWLeech  = wglw(pid,61) *50
			end
		end
		end
		if match_ID_awakened(pid,3,1) and JY.Person[3]["论剑奖励"] == 1 then----
		if WAR.JWLeech < 200 then
			WAR.JWLeech = WAR.JWLeech + limitX(math.modf(0.3* JY.Person[eid]["灼烧程度"]),0,200)
			if WAR.JWLeech  > 200 then
				WAR.JWLeech  = 200
			end
		end
		end
		if WAR.FLHS3 == 1 and zylw(4)>1 then--
		WAR.JHLY2[eid] = math.modf(0.5* JY.Person[eid]["灼烧程度"])   
		end
		if WAR.LYLZ[pid]~=nil and WAR.LYLZ[pid]==2 then
		local aa = JY.Person[eid]["灼烧程度"]
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa*2)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", aa*2)
		end
		if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid] == 3 then
		local aa = JY.Person[eid]["灼烧程度"]
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", aa*2)
		JY.Person[pid]["灼烧程度"] = limitX(JY.Person[pid]["灼烧程度"] + aa, 0, 50)
		end
	end

	--雪山剑法冰封追加额外伤害
	if JY.Person[eid]["冰封程度"] > 0 and DWPD() then
		if wglw(pid,35)>=1 then----
		hurt = hurt + math.min(JY.Person[eid]["冰封程度"],100)
		end
		if WAR.LYLZ[pid]~=nil and WAR.LYLZ[pid]==6 then
		local aa = JY.Person[eid]["冰封程度"]
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa*20)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", aa*3)
		end
		if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid]==5 then
		local aa = JY.Person[eid]["冰封程度"]
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa*20)
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa*20)
		JY.Person[pid]["冰封程度"] = limitX(JY.Person[pid]["冰封程度"] + aa, 0, 100)
		end
		if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid]==6 then
		local aa = math.modf(JY.Person[eid]["冰封程度"]/2)
		WAR.GTSHAQI = WAR.GTSHAQI+aa*2
		WAR.GTPID2 = pid
		WAR.Person[enemyid]["内伤点数"]=(WAR.Person[enemyid]["内伤点数"] or 0)+AddPersonAttrib(eid,"受伤程度",aa)
		end
		if WAR.BSFW[pid]~=nil then
		hurt = hurt + math.modf(math.min(JY.Person[eid]["冰封程度"],100)*WAR.BSFW[pid]*0.5)
		end
	end	

	if JY.Person[eid]["中毒程度"] > 0 and DWPD() then
		if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid]==5 then
		local aa = JY.Person[eid]["中毒程度"]
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa*20)
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa*3)
		end
	end	

	if WAR.LXZT[eid]~=nil and WAR.LXZT[eid]>0 then
		if wglw(pid,12)>=1 and DWPD() then----
		hurt = hurt + WAR.LXZT[eid]
		end
	end	
	
	if WAR.MBZ[pid]~=nil and WAR.MBZ[pid]>0  then
	hurt = hurt - WAR.MBZ[pid]
	end

	if WAR.MBZ[eid]~=nil and WAR.MBZ[eid]>0  then
	   if wglw(pid,28)>=1 and wugong == 28 and DWPD() then
	      hurt = hurt + WAR.MBZ[eid]
	   end
	end

 if WAR.XLDF>0 and DWPD() then --修罗刀招式伤害
    local aa = 1 + (WAR.BDKY[pid] or 0)
    hurt = hurt + math.modf(JY.Person[pid]["内力"]*0.015*aa)
end

	
  	if wglw(eid,61)>1 and (JLSD(30,70,eid) or (WAR.NGHT>0 and JuHuoLY(eid))) then	
		if WAR.Person[WAR.CurID]["我方"] ~=true then
                 local txwz = "大日天仪.焰章铠"	
				 local aa = (wglw(eid,61) * 30)
				if wglw(eid,61)>2 then
				txwz = "大日天仪.阳炎焰章铠"
                aa = aa + JY.Person[pid]["灼烧程度"] * 3 + JY.Person[pid]["受伤程度"] * 3	
                JY.Person[pid]["受伤程度"]=JY.Person[pid]["受伤程度"]+math.modf(JY.Person[pid]["受伤程度"]*0.25)				
				end				 
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+ AddPersonAttrib(pid, "生命", - aa)
				JY.Person[pid]["受伤程度"]=JY.Person[pid]["受伤程度"]+(wglw(eid,61) * 5)
				WAR.HOT[pid]=(WAR.HOT[pid] or 0) +(wglw(eid,61) * 5)

                WAR.Person[enemyid]["特效动画"] = 77
                Set_Eff_Text(enemyid, "特效文字2", txwz)				
		end
	end
	
	--丁春秋攻击，根据敌方中毒追加真实伤害
	if match_ID(pid, 46) and JY.Person[eid]["中毒程度"] > 0 and DWPD() then
		hurt = hurt + math.modf(JY.Person[eid]["中毒程度"]*0.75)
	end	

    --开太极
	if WAR.WDKTJ == 1 then
	    local s = 0
        local s1 = 2-JY.Person[pid]["生命"]/JY.Person[pid]["生命最大值"]
		local s2 = WAR.tmp[3000+pid] or 0
		local s3 = WAR.TJZX[pid] or 0
		 s = math.modf(s2*s3*s1) 
		if s > 600 then
		hurt = hurt+s
		 else
		hurt = hurt+200
       end		
	end	

    if WAR.FZ[pid] ~=nil and WAR.FZ[pid][2] ~=nil then
	local aa= WAR.FZ[eid][2]
	    if aa>=5 then
		  hurt = hurt+ 100*5
		  if aa>=10 then
		  hurt = math.modf(hurt*1.5)
		  end
		end
	end
	
	if match_ID_awakened(pid, 129,1) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0 and DWPD() then
		hurt = hurt + (8-WAR.BDQS)*80
		ang = ang +  (8-WAR.BDQS)*200
	end
	
	if match_ID_awakened(pid, 65,1) and WAR.LMZL > 0 and DWPD() then
		hurt = hurt + (7-WAR.LMZL)*60 +math.modf(TrueYJ(pid)*0.5 + JY.Person[pid]["指法技巧"]*0.5)
		ang = ang +  (7-WAR.LMZL)*200
	end	
	
	--韦小宝机敏无双，开场前50时序，受伤害不超过50
	if match_ID(eid, 601) and WAR.SXTJ <= 50 and hurt > 50 then
		hurt = math.random(40,49)
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "机敏无双"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+机敏无双"
		end
		WAR.Person[enemyid]["特效动画"] = 90
	end
		
----------------------------------------------------------------------------------
 

	--郭靖蛇行狸翻，打断连击，畅想主角专属
	if match_ID(eid, 55) and PersonKF(eid, 107) and DWPD() and eid == 0 and JLSD(50, 50+JY.Base["天书数量"]*2,eid) then
		WAR.ACT = 10
		WAR.Person[enemyid]["特效动画"] = 51
		Set_Eff_Text(enemyid, "特效文字2", "蛇行狸翻")
	end
 
 	--一灯复活后，不受连击伤害
	if match_ID(eid, 65) and DWPD() and WAR.WCY[eid] ~= nil and WAR.ACT > 1 then
		hurt = 0
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 200
		if WAR.Person[enemyid].TimeAdd >= 1005  then
		WAR.Person[enemyid].TimeAdd = 1005
		end
		WAR.Person[enemyid]["特效动画"] = 136
		Set_Eff_Text(enemyid, "特效文字2", "燃灯复生")
	end
 
 
 
 
 if Curr_NG(eid, 105) then
		--葵花尊者必定移形
		local khzz = 0
		if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and eid == 27 then
			khzz = 1
		end
		if (khzz == 1 or JLSD(50, 80, eid))  and WAR.Miss[eid] == nil then
			hurt = math.modf(hurt *0.7)
			ang = math.modf(ang *0.7)
			WAR.Person[enemyid]["特效动画"] = 51
			if WAR.Person[enemyid]["特效文字2"] ~= nil then
				WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+葵花移形"
			else
				WAR.Person[enemyid]["特效文字2"] = "葵花移形"
			end
		end
	end
 
 --无酒不欢：神行百变，12%几率闪避
	if Curr_QG(eid, 146) then
		local c_up = 0
		--袁承志觉醒后，闪避率+5%
		if match_ID_awakened(eid, 54, 1) then
			c_up = 5
			if JY.Person[54]["品德"] == 80 then
			c_up = 15
			end
		end
        if JLSD(40, 65+c_up, eid) and WAR.Miss[eid] == nil then
			hurt = math.modf(hurt *0.7)
			ang = math.modf(ang *0.7)
			if match_ID_awakened(eid,629,1) then
			hurt = math.modf(hurt *0.7)
			ang = math.modf(ang *0.7)
			end
			WAR.Person[enemyid]["特效动画"] = 51
			if WAR.Person[enemyid]["特效文字2"] ~= nil then
				WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+神行百变减伤"
			else
				WAR.Person[enemyid]["特效文字2"] = "神行百变减伤"
			end
		end
	end
 
 	--无酒不欢：凌波微步，15%几率闪避
	if Curr_QG(eid, 147) then
       if JLSD(40, 60, eid) and WAR.Miss[eid] == nil then
			hurt = math.modf(hurt *0.6)
			ang = math.modf(ang *0.6)
			WAR.Person[enemyid]["特效动画"] = 51
			if WAR.Person[enemyid]["特效文字2"] ~= nil then
				WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"].."+凌波微步减伤"
			else
				WAR.Person[enemyid]["特效文字2"] = "凌波微步减伤"
			end
		end
	end
 

 
	--主角 不动如山，伤害强制为30


    if WAR.FZ[eid] ~=nil and WAR.FZ[eid][1] ~=nil then
	local aa= WAR.FZ[eid][1]
	    if aa>=10 then
		  hurt = -hurt
		elseif aa>=5 then
		  hurt = 30
		end
	end

	if  WAR.MZQL[eid]~= nil  then
		if  WAR.MZQL[eid] == 1 then			
			hurt = 0
		elseif WAR.MZQL[eid] == 2 then			
			AddPersonAttrib(eid, "内力", hurt*10)
			WAR.MZ_LH[eid] = (WAR.MZ_LH[eid] or 0) + math.max(math.modf(hurt*0.1),20)
		end
	end

	--主角 不动如山，伤害强制为30
	if (force_ID(eid) or (eid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0) ) and WAR.TGDQ2 > 0 then
		hurt = math.modf(hurt *0.2)		
	end	

	if nglw(eid,103)>2 and WAR.TGDQ2 > 0 then
		hurt = math.modf(hurt *0.2)
	end	

	if (eid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0) and WAR.TGDQ6 > 0 then
	    local reduction2 = math.modf((JY.Person[eid]["生命最大值"]-JY.Person[eid]["生命"]) * 0.2)
		if hurt<20 and hurt>=0 then
	       hurt = hurt + reduction2
        elseif hurt<0 then
           hurt = 0-hurt + reduction2		
	    end
		hurt = -hurt
	end	
	
	if nglw(eid,103)>2 and WAR.TGDQ6 > 0 then
	    local reduction2 = math.modf((JY.Person[eid]["生命最大值"]-JY.Person[eid]["生命"]) * 0.2)
		if hurt<20 and hurt>=0 then
	       hurt = hurt + reduction2
        elseif hurt<0 then
           hurt = 0-hurt + reduction2		
	    end
		hurt = -hurt
	end	

	
	--黄药师奇门阵图
	if match_ID_awakened(eid,57,1) and WAR.QMZT > 0 and hurt > 30 then
		hurt = math.modf(hurt*WAR.QMZT)
		WAR.QMDJ[pid] = limitX((WAR.QMDJ[pid] or 0)+math.random(1,5),0,50)
	end	
	
	if WAR.YYJ[pid]~=nil and WAR.YYJ[pid]==2 and WAR.TJYQ>0 then
	   hurt = math.modf(hurt*(1+WAR.TJYQ))
	end
	
  if MPPD(eid) == 6 and WAR.ACT > 1  then --五岳剑派抗连击
    local mpdj = MPDJ(eid) * 0.1
		local reduction = math.modf(ang * mpdj)
		AddPersonAttrib(eid, "内力", reduction)
		ang = math.modf(ang*(1-mpdj))
	Set_Eff_Text(enemyid, "特效文字3", "吞气入体·气脉悠长")
	WAR.Person[enemyid]["特效动画"] = 11 
  end
	
	  if wglw(eid,162)>=1 and WAR.ACT > 1 then --五岳剑派抗连击
    local mpdj = wglw(eid,162) * 0.1
	hurt = math.modf(hurt*(1-mpdj))
	ang = math.modf(ang*(1-mpdj))
	local str="狂风气墙"
	    if PersonKFJ(eid,33) and wglw(eid,162)>1 then----
		ang = 0
		WAR.JJPZ[pid] = 1
		str=str..".岚之山"
		end
	Set_Eff_Text(enemyid, "特效文字1", str)
	WAR.Person[enemyid]["特效动画"] = 11 
  end
	
	if (nglw(eid,95)>1 and WAR.NGHT > 0) and WAR.HMJT[eid] ~= nil and WAR.HMJT[eid] > 0 and DWPD() then --蛤蟆九天17-2-23
       local a = math.modf(hurt * 0.25*nglw(eid,95))
       WAR.HMJT[eid] = WAR.HMJT[eid] - a
	   if WAR.HMJT[eid] <= 0 then 
	      WAR.HMJT[eid] = nil 
	   end	  
       hurt = hurt-a
    if WAR.Person[enemyid]["特效文字1"] == nil then 
       WAR.Person[enemyid]["特效文字1"] = "气吞山河·御"
	else 
 	   WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+气吞山河·御"
	end   
  end

	if wglw(eid,76)>1 and DWPD() and JLSD(10,60,eid) then
	WAR.DRZT[pid] = limitX((WAR.DRZT[pid] or 0)+math.random(1,3),0,wglw(eid,76)*5)	
    if WAR.Person[enemyid]["特效文字1"] == nil then 
       WAR.Person[enemyid]["特效文字1"] = "海叟·反饵"
	else 
 	   WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+海叟·反饵"
	end 
	end

  if wglw(eid,36)>=2 and (JLSD(10,60,eid) or wglw(eid,36)>2) then --蛤蟆九天17-2-23
        local str = "绵云"
		if WAR.MYZT[eid] == nil or WAR.MYZT[eid] == 0 then
			WAR.MYZT[eid] = 1
		elseif WAR.MYZT[eid]>= 5 then 	
			WAR.MYZT[eid] = nil
		else
			WAR.MYZT[eid] = WAR.MYZT[eid] + 1;
			if  WAR.MYZT[eid] > 5 then 
		    WAR.MYZT[eid] = 5 
		    end	
		end

		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = str
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+"..str
		end
	end

  if nglw(eid,95)>2  and Curr_NG(eid,95) and DWPD() then --蛤蟆九天17-2-23
  local a = math.random(3)
  local str = ""
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[enemyid]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[enemyid]["坐标Y"] - WAR.Person[j]["坐标Y"])
			--local offset=offset1+offset2		
			if WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[j]["死亡"] == false and offset1 <= 8 and offset2 <= 8 then
			WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(df, "中毒程度", 25)
			   if a == 1 then 
               WAR.POISON[df] = limitX((WAR.POISON[df]  or 0) + 10, 0, 100)
			   str = "毒蟾·蟾酥袭人"
			   elseif a == 2 then 
			   WAR.HOT[df] = (WAR.HOT[df] or 0) + 30
			   if WAR.HOT[df] > 50 then 
			      WAR.HOT[df] = 50 
				  WAR.JHLY[df] = 10	
			   end	  
			   str = "火蟾·烈气缠身"
			   elseif a == 3 then
			   WAR.ICE[df] = (WAR.ICE[df] or 0) + 30
			   if WAR.ICE[df] > 50 then 
			      WAR.ICE[df] = 50
                  WAR.LRHF[df] = 10				  
			   end	
			   str = "冰蟾·冰毒环绕"
			   end
			end
        end
		if WAR.Person[enemyid]["特效文字0"] == nil and str ~= "" then
			WAR.Person[enemyid]["特效文字0"] = str
		elseif WAR.Person[enemyid]["特效文字0"] ~= nil and str ~= "" then
			WAR.Person[enemyid]["特效文字0"] = WAR.Person[enemyid]["特效文字0"].."+"..str
		end
  end
  
  	if nglw(eid, 97)>1 and JLSD(10,80,eid)  then
	    local d = 0
		for j = 0, WAR.PersonNum - 1 do
		  if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] then
			d = d + 1
		  end
		end
		if d > 1 and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
		   	if WAR.Person[enemyid]["特效文字1"] ~= nil then
			   WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+".."阿萨辛秘技·妄想心音"
		    else
			   WAR.Person[enemyid]["特效文字1"] = "阿萨辛秘技·妄想心音"
		    end
			WAR.Person[enemyid]["特效动画"] = 87
		    CleanWarMap(4,0)
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] and j ~= WAR.CurID then
					SetWarMap(WAR.Person[j]["坐标X"],WAR.Person[j]["坐标Y"],4,1)
				end
			end
			WAR.WXXY1 = 1
		end
	end
  
	--以下减伤效果，只在伤害大于30时才会触发
	if hurt > 30 or hurt<0 then
		--乾坤大挪移反弹，内力高于对方才触发
		--误伤不触发
		local tt = 0
		local pt = 0
        if eid == 0 and WAR.NZQK == 1 then
		tt=1
		end
   

   
		if nglw(eid, 97)>1 then
        pt = 1
		end
		
		if WAR.MZLL[eid]~=nil  then
		tt=1
		end
		
		if PersonKF(eid, 97) and (JY.Person[eid]["内力"] > JY.Person[pid]["内力"] or MPPB_MJBL(eid) >= 1 or nglw(eid, 97)>=1) then
		pt =1
		end
		
		if WAR.GMZS1[eid]~=nil then
		pt = 1
		   if WAR.GMZS1[eid]>=10 then
		   tt = 1
		   end
		end

	
		if notan(pid) then
		tt = 0
		pt = 0
		   if nglw(eid, 97)>2 then
		   pt = 1
		   tt = 1
		   end
		end
		
		if (pt == 1 and DWPD()) or tt==1 then
			WAR.fthurt = 0
			local nydx = {}
			local nynum = 1
			local str = "乾坤大挪移·反弹"
			for i = 0, WAR.PersonNum - 1 do
			    local df = WAR.Person[i]["人物编号"]
				if WAR.Person[i]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[i]["死亡"] == false then
					nydx[nynum] = i
					nynum = nynum + 1
				end
			end
			
			
			--反弹的人
			local nyft = nydx[math.random(nynum - 1)]
			--张无忌可以反弹两人
			local nyft2 = nydx[math.random(nynum - 1)]
			
			local h = 0;
			--被动反弹几率50%，弹伤20%
			--主运反弹几率75%，弹伤30%
			local chance = 51
			local cfr = 0.8
			if Curr_NG(eid, 97) then
				chance = 76
				cfr = 0.7
			end
			--张无忌反弹40%
			if match_ID(eid, 9) then
				cfr = 0.6
			end
						
			--逆转乾坤，必定反弹50%
			if WAR.NZQK == 1 then
				chance = 101
				cfr = 0.5
			end

		if nglw(eid, 97)>1 then
		chance = 60+nglw(eid, 97)*10
		end

			if tt == 1 then
				chance = 101
			end
			
			if MPPB_MJBL(eid) >= 1 then--
			   cfr = 0.7 -MPDJ(eid)*0.1
			    if WAR.NGHT >0  then--
				cfr = 0
				str = "明尊琉璃·反弹"
				end
			end
			
			if WAR.MZLL[eid]~=nil then
				chance = 101
				cfr = 0.2
				if MPPB_MJBL(eid) == 1 then
				cfr = 0
				end
			end
			
			if (math.random(100) < chance) and WAR.L_QKDNY[WAR.Person[nyft]["人物编号"]] == nil then
				WAR.fthurt = math.modf(hurt*(1-cfr))			
				hurt = math.modf(hurt*cfr)
			   if WAR.GMZS1[eid]~=nil then
                  local ft = WAR.GMZS1[eid] * 0.1
				  WAR.fthurt = math.modf(WAR.fthurt*(1+ft))
		       end

				if WAR.fthurt<0 then
				WAR.fthurt = -WAR.fthurt
				end

				h = math.modf(WAR.fthurt + Rnd(10));		--反弹的伤害
				SetWarMap(WAR.Person[nyft]["坐标X"], WAR.Person[nyft]["坐标Y"], 4, 2);	--反弹者标识为被命中

				if WAR.WXZQ[eid]~=nil and MPPB_MJBL(eid) > 2 then
				local h3 = math.modf(h*0.1*(MPPB_MJBL(eid)-1))
				   if WAR.WXZQ[eid] == 1 then -- 巨木
				   WAR.Person[nyft]["中毒点数"] = (WAR.Person[nyft]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[nyft]["人物编号"], "中毒程度", h3);
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft]["人物编号"]]["中毒程度"]>=75 then
                      WAR.BPYZ[WAR.Person[nyft]["人物编号"]] = 20
                      end
                      if MPPB_MJBL(eid) > 3 then
                      h = math.modf(h * (1+JY.Person[WAR.Person[nyft]["人物编号"]]["中毒程度"]/100))
                      end				   
				   end	
				   if WAR.WXZQ[eid] == 2 then --锐金
				   WAR.LXZT[WAR.Person[nyft]["人物编号"]] = limitX((WAR.LXZT[WAR.Person[nyft]["人物编号"]] or 0)+h3,0,100)	
                      if MPPB_MJBL(eid) > 3 and  WAR.LXZT[WAR.Person[nyft]["人物编号"]]~=nil and WAR.LXZT[WAR.Person[nyft]["人物编号"]]>=75 then
                      WAR.XRZT[WAR.Person[nyft]["人物编号"]] = 20
                      end				   
				   end	
				   if WAR.WXZQ[eid] == 3 then --洪水
				   JY.Person[WAR.Person[nyft]["人物编号"]]["冰封程度"] = limitX((JY.Person[WAR.Person[nyft]["人物编号"]]["冰封程度"] or 0 )+ h3, 0, 100)
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft]["人物编号"]]["冰封程度"]>=75-(MPPB_MJBL(eid)-3)*25 then
                      WAR.LRHF[WAR.Person[nyft]["人物编号"]] = 20
                      end
                      if MPPB_MJBL(eid) > 3 then
                      h = math.modf(h * (1+JY.Person[WAR.Person[nyft]["人物编号"]]["冰封程度"]/100))
                      end					  
				   end	
				   if WAR.WXZQ[eid] == 4 then --烈火
				   JY.Person[WAR.Person[nyft]["人物编号"]]["灼烧程度"] = limitX((JY.Person[WAR.Person[nyft]["人物编号"]]["灼烧程度"] or 0) + h3, 0, 50);
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft]["人物编号"]]["灼烧程度"]>=40-(MPPB_MJBL(eid)-3)*20 then
                      WAR.JHLY2[WAR.Person[nyft]["人物编号"]] = 20
                      end
                      if MPPB_MJBL(eid) > 3 then
                      h = math.modf(h * (1+JY.Person[WAR.Person[nyft]["人物编号"]]["灼烧程度"]/50))
                      end						  
				   end	
				   if WAR.WXZQ[eid] == 5 then -- 厚土
				   WAR.Person[nyft]["内伤点数"] = (WAR.Person[nyft]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[nyft]["人物编号"], "受伤程度", h3);	
                   if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft]["人物编号"]]["受伤程度"]>=75 then
                      h=h*2
                      end    
					  if MPPB_MJBL(eid) > 3 then
                      h = math.modf(h * (1+JY.Person[WAR.Person[nyft]["人物编号"]]["受伤程度"]/100))
                      end					   
				   end	
                WAR.TXXS[WAR.Person[nyft]["人物编号"]] = 1				   
				end
				
				WAR.L_QKDNY[WAR.Person[nyft]["人物编号"]] = 1;
			
				WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - h;
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - h
				if JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] < 1 then
					JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = 1
				end
				

				
				if WAR.Person[enemyid]["特效文字3"] ~= nil then
					WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .."+"..str
				else
					WAR.Person[enemyid]["特效文字3"] = str
				end
				  
				--张无忌，可以反弹两个人
				if MPPB_MJBL(eid) >= 1 and nyft ~= nyft2 then
				    WAR.L_QKDNY[WAR.Person[nyft2]["人物编号"]] = 1
					local h2 = h
					if match_ID_awakened(eid, 9,1) then
                    h2= math.modf(h*1.25)					
					end
				if WAR.WXZQ[eid]~=nil and MPPB_MJBL(eid) > 1 then
				local h3 = math.modf(h*0.1*(MPPB_MJBL(eid)-1))
				   if WAR.WXZQ[eid] == 1 then -- 巨木
				   WAR.Person[nyft2]["中毒点数"] = (WAR.Person[nyft2]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[nyft2]["人物编号"], "中毒程度", h3);
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft2]["人物编号"]]["中毒程度"]>=75 then
                      WAR.BPYZ[WAR.Person[nyft2]["人物编号"]] = 20
                      end
                      if MPPB_MJBL(eid) > 3 then
                      h2 = math.modf(h2 * (1+JY.Person[WAR.Person[nyft2]["人物编号"]]["中毒程度"]/100))
                      end				   
				   end	
				   if WAR.WXZQ[eid] == 2 then --锐金
				   WAR.LXZT[WAR.Person[nyft2]["人物编号"]] = limitX((WAR.LXZT[WAR.Person[nyft2]["人物编号"]] or 0)+h3,0,100)	
                      if MPPB_MJBL(eid) > 3 and  WAR.LXZT[WAR.Person[nyft2]["人物编号"]]~=nil and WAR.LXZT[WAR.Person[nyft2]["人物编号"]]>=75-(MPPB_MJBL(eid)-3)*25 then
                      WAR.XRZT[WAR.Person[nyft2]["人物编号"]] = 20
                      end				   
				   end	
				   if WAR.WXZQ[eid] == 3 then --洪水
				   JY.Person[WAR.Person[nyft2]["人物编号"]]["冰封程度"] = limitX((JY.Person[WAR.Person[nyft2]["人物编号"]]["冰封程度"] or 0 )+ h3, 0, 100)
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft2]["人物编号"]]["冰封程度"]>=75 then
                      WAR.LRHF[WAR.Person[nyft2]["人物编号"]] = 20
                      end
                      if MPPB_MJBL(eid) > 3 then
                      h2 = math.modf(h2 * (1+JY.Person[WAR.Person[nyft2]["人物编号"]]["冰封程度"]/100))
                      end					  
				   end	
				   if WAR.WXZQ[eid] == 4 then --烈火
				   JY.Person[WAR.Person[nyft2]["人物编号"]]["灼烧程度"] = limitX((JY.Person[WAR.Person[nyft2]["人物编号"]]["灼烧程度"] or 0) + h3, 0, 50);
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft2]["人物编号"]]["灼烧程度"]>=40 then
                      WAR.JHLY2[WAR.Person[nyft2]["人物编号"]] = 20
                      end
                      if MPPB_MJBL(eid) > 3 then
                      h2 = math.modf(h2 * (1+JY.Person[WAR.Person[nyft2]["人物编号"]]["灼烧程度"]/50))
                      end						  
				   end	
				   if WAR.WXZQ[eid] == 5 then -- 厚土
				   WAR.Person[nyft2]["内伤点数"] = (WAR.Person[nyft2]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[nyft2]["人物编号"], "受伤程度", h3);
                      if MPPB_MJBL(eid) > 3 and JY.Person[WAR.Person[nyft2]["人物编号"]]["受伤程度"]>=75 then
                      h2=h2*2
                      end				   
                      if MPPB_MJBL(eid) > 3 then
                      h2 = math.modf(h2 * (1+JY.Person[WAR.Person[nyft2]["人物编号"]]["受伤程度"]/100))
                      end					  
				   end	
                WAR.TXXS[WAR.Person[nyft2]["人物编号"]] = 1				   
				end
					WAR.Person[nyft2]["生命点数"] = (WAR.Person[nyft2]["生命点数"] or 0) - h2;
					JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] - h2;
					if JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] < 1 then
						JY.Person[WAR.Person[nyft2]["人物编号"]]["生命"] = 1
					end
					WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .. "·双"
					SetWarMap(WAR.Person[nyft2]["坐标X"], WAR.Person[nyft2]["坐标Y"], 4, 2);	--反弹者标识为被命中
				end
				
				if nglw(eid, 97)>1 and JLSD(10,40+10*nglw(eid,97),eid) then
				    local h2 = h
				    WAR.Person[enemyid]["特效文字0"] = "琉璃白莲"
					for p = 0, WAR.PersonNum - 1 do
                        if WAR.Person[p]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[p]["死亡"] == false and WAR.L_QKDNY[WAR.Person[p]["人物编号"]] == nil then
						   WAR.L_QKDNY[WAR.Person[p]["人物编号"]] = 1
		                   WAR.Person[p]["生命点数"] = (WAR.Person[p]["生命点数"] or 0) - h2;
                           JY.Person[WAR.Person[p]["人物编号"]]["生命"] = JY.Person[WAR.Person[p]["人物编号"]]["生命"] - h2;
	                       if JY.Person[WAR.Person[p]["人物编号"]]["生命"] < 1 then
                              JY.Person[WAR.Person[p]["人物编号"]]["生命"] = 1
		                      WAR.FXXS[WAR.Person[p]["人物编号"]]=1 
		                      WAR.FXDS[WAR.Person[p]["人物编号"]]=50 
	                       end
                          SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 2);	--反弹者标识为被命中
                        end
                    end
				end
				
			end
		end
		
		if WAR.MZLL2[pid] ~=nil and WAR.L_QKDNY[pid] == nil  then
		   		local cfr = 0.5
				local nyft = WAR.CurID
				WAR.fthurt = math.modf(hurt*(1-cfr))			
				hurt = math.modf(hurt*cfr)
				if WAR.fthurt<0 then
				WAR.fthurt = -WAR.fthurt
				end
				local h = math.modf(WAR.fthurt + Rnd(10));		--反弹的伤害
				SetWarMap(WAR.Person[nyft]["坐标X"], WAR.Person[nyft]["坐标Y"], 4, 2);	--反弹者标识为被命中
				
				WAR.L_QKDNY[WAR.Person[nyft]["人物编号"]] = 1;
			
				WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - h;
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - h
				if JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] < 1 then
					JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = 1
				end
		       WAR.L_QKDNY[pid] = 1		
		end

    if wglw(eid,12)>1 then
	if hurt> 0 then
	   if WAR.LXZT[pid]~=nil then
	   local bb=math.modf((JY.Person[eid]["拳掌功夫"]+WAR.LXZT[pid])/800)
	   local aa=math.modf(hurt * 0.2)	
	   hurt = math.modf(hurt * (1-bb))
        if WAR.QBLY[pid]~=nil then
        hurt = math.modf(hurt * 0.5)
        end	
       	
	   	WAR.LXXS[pid] = 1
		WAR.LXZT[pid] = limitX((WAR.LXZT[pid] or 0)+aa,0,100)
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
    	WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "落英剑意护体"
        else
    	WAR.Person[enemyid]["特效文字2"] = "落英剑意护体"
        end	
		end	
		end
	end
		


		


	if (WAR.NGHT == 103 and nglw(eid,103)>=1 )  or (nglw(eid,103)>=2 and WAR.NGHT>0 and JLSD(10,40,eid) ) and hurt> 20 and DWPD() then
		local str = "龙象之御"
		if nglw(eid,103)>= 1 then
		local juzl = {"一","二","三","四","五","六","七","八","九","十","十一","十二"}
		local DXZY = math.random(1,9+nglw(eid,103))
		if match_ID(eid,40) then
		DXZY = math.random(5,9+nglw(eid,103))
		local bb = DXZY * 25
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", bb);
		end
		str = juzl[DXZY].."象之御"
		   if WAR.BRZH1[eid] == 2 then
		   DXZY = 13
		   str ="慧象般若【方便】"
		   WAR.BRZH1[eid] = nil
		   end
		local fhurt = hurt
		hurt = math.modf(hurt *(1-DXZY*0.07))
		ang = math.modf(ang *(1-DXZY*0.07))
		   if WAR.BRZH1[eid] == 3 then
		   local aa = fhurt - hurt
                for j = 0, WAR.PersonNum - 1 do
		           if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and WAR.Person[j]["人物编号"]~= eid then
					local tmppid = WAR.Person[j]["人物编号"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] +aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] +3*aa
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) +3*aa;
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		           end
	            end
		   str ="慧象般若【方便】"
		   WAR.BRZH1[eid] = nil
		   end
		end		
		if nglw(eid,103)> 1 then
		local lzpx = {".长生天象",".吉祥天象",".优乐天象",".妙音天象"}
		local cc = math.random(1,2*nglw(eid,103)-2)
		local str1 = lzpx[cc]
		   if WAR.BRZH1[eid] == 1 then
		   	 WAR.L_HQNZL[eid] = 30
			WAR.L_HQNZL2[eid] = 30
			WAR.L_WNGZL2[pid] = 30
			WAR.LUCK[eid] =30
			WAR.UNLUCK[pid] = 30
			 WAR.SKWJ[pid] = 30
			WAR.TJYM[eid] =30
			WAR.JSCL[pid] = 30
			WAR.BYCX[pid] = 30
		   str1 =".慧象般若【文字】"
		   WAR.BRZH1[eid] = nil
		   end
		str = str..str1
		if  cc == 1  then
		    WAR.L_HQNZL[eid] = 30
			WAR.L_HQNZL2[eid] = 30
			if nglw(eid,103)> 2 then
			WAR.L_WNGZL2[pid] = 30
			end
			elseif cc == 2 then
			WAR.LUCK[eid] =30
			if nglw(eid,103)> 2 then
			WAR.UNLUCK[pid] = 30
			end
			elseif cc == 3 then
		    WAR.SKWJ[pid] = 30
			WAR.TJYM[eid] =30
			else
			WAR.JSCL[pid] = 30
			WAR.BYCX[pid] = 30
		   end
		   
		end

		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" ..str
		else
			WAR.Person[enemyid]["特效文字1"] = str
		end
	end

 	if eid == 0 and WAR.FLHS4 > 0 and hurt > 30 then
		hurt = 30
		if JY.Base["标准"] == 6 then
		local reduction = math.modf(JY.Person[eid]["内力最大值"] * 0.1)
		local reduction2 = math.modf(JY.Person[eid]["生命最大值"] * 0.02)
		AddPersonAttrib(eid, "内力", reduction)
		AddPersonAttrib(eid, "生命", reduction2)
		end
	end
	   
		--无酒不欢：金刚不坏主运
		if Curr_NG(eid, 144)   and (JLSD(30, 90, eid) or nglw(eid,144)>=1 ) then
		    local str="金钟罩"
			local str1 = ""
			local fhurt = hurt
			hurt = math.modf(hurt *0.7)
			ang = math.modf(ang *0.7)

			if MPPB_SL(eid) == 3 and (JLSD(40, 60+MPDJ(eid)*10, eid) or WAR.NGHT>0 ) then
			     
			local tmp=math.modf(hurt*MPDJ(eid));
		    local tmp1=math.modf(hurt*MPDJ(eid)/20);
			local HN2=JY.Person[eid]["内力最大值"]- JY.Person[eid]["内力"]
			if tmp1>HN2 then
			local HN1 = math.modf((tmp1-HN2)/5)
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", HN1);
			WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", HN2);
			else
		    WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", tmp);
			end
			if MPZJ(eid,3)>=1  then
			local HN3= math.modf(JY.Person[eid]["内力"]*0.01)
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", HN3);
			   if WAR.KBGJ[eid]~=nil then
			   str="虎啸金钟罩"
			   WAR.HMZT[pid] = 2
			   end
			   if MPZJ(eid,3)>=2  then
			        local tmp3= math.modf(JY.Person[pid]["受伤程度"]*(1+0.2*MPDJ(pid)))
			   		hurt = hurt-tmp3
			            if hurt<1 then
			               hurt=1
			            end		   
			   end
			   if MPZJ(eid,3)>=3  then
			   str="少林九阳.虎啸金钟罩"
			   		if hurt>=0 then
					hurt = -fhurt
                    end	
		       local nyft = WAR.CurID
		        WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - fhurt;
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - fhurt
				if JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] < 1 then
					JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = 1
					WAR.FXDS[WAR.Person[nyft]["人物编号"]] = 10
					WAR.FXXS[WAR.Person[nyft]["人物编号"]] = 1
				end					
			   end
			end
            WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", tmp1)
			str1="刚相."
			   if WAR.NGHT> 0 then
			   local tmp2= math.modf(JY.Person[pid]["受伤程度"]*1.5)
			    if MPZJ(eid,3)>=1  then
				 tmp2= tmp2 + math.modf(JY.Person[pid]["受伤程度"]*(0.5*MPDJ(eid)))
			     WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", tmp2);
			   end
			   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -tmp2)

			   str1="真"..str1
			   end
		       WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", tmp1)
			end

		--被动
		elseif hurt > 30 and PersonKF(eid, 144) and JLSD(30, 65, eid) then
			hurt = math.modf(hurt *0.8)
			ang = math.modf(ang *0.8)
			Set_Eff_Text(enemyid, "特效文字0", "金刚不坏")
			WAR.Person[enemyid]["特效动画"] = 88
		end

    if WAR.BHJS[eid]~=nil then
	    if hurt> 0 then
		hurt = 0
		WAR.Person[enemyid]["特效文字1"] = "不坏金身"		
		WAR.Person[enemyid]["特效动画"] = 88
		end
	end

    if WAR.TJYM[eid]~=nil then
	    if hurt> 0 then
		local h = hurt * 10
		hurt = 0
		if JY.Person[pid]["内力"] + h > JY.Person[pid]["内力最大值"] then
		local h1 = JY.Person[pid]["内力"] + h - JY.Person[pid]["内力最大值"]
		local h2 = h-h1
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", h2)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", math.modf(h1/10))
		else
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", h)
		end
		WAR.Person[enemyid]["特效文字1"] = "天降御免"		
		WAR.Person[enemyid]["特效动画"] = 63
		end
	end
	
	if WAR.BCB[eid]~= nil  then
	if hurt> 0 then
	    local h = hurt
		local nyft = WAR.CurID
	    hurt = 0
		WAR.Person[nyft]["生命点数"] = (WAR.Person[nyft]["生命点数"] or 0) - h;
				JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] - h
				if JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] < 1 then
					JY.Person[WAR.Person[nyft]["人物编号"]]["生命"] = 1
					WAR.FXDS[WAR.Person[nyft]["人物编号"]] = 10
					WAR.FXXS[WAR.Person[nyft]["人物编号"]] = 1
				end
	    WAR.Person[enemyid]["特效文字1"] = "蛹化.反射"	--妖蝶变.蛹化反射
		if WAR.Person[enemyid]["特效动画"] == nil then
        WAR.Person[enemyid]["特效动画"] = 51
		end
	end
	end	


	
		--论剑打赢独孤，九剑真传70%几率减伤15%，并降低攻方下回合集气位置
		--七夕令狐冲自带
		if ((eid == 0 and JY.Person[592]["论剑奖励"] == 1 and JLSD(15, 85,eid)) or match_ID(eid, 610) ) and DWPD() then
			local jpwz;
			local wgtype = 0
			if JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2 then
				jpwz = "九剑真传·破掌式"
				wgtype = 1
			elseif JY.Wugong[wugong]["武功类型"] == 3 then
				jpwz = "九剑真传·破剑式"
				wgtype = 2
			elseif JY.Wugong[wugong]["武功类型"] == 4 then
				jpwz = "九剑真传·破刀式"
				wgtype = 3
			elseif JY.Wugong[wugong]["武功类型"] == 5 then
				jpwz = "九剑真传·破棍式"
				wgtype = 4
			elseif JY.Wugong[wugong]["武功类型"] == 6 then
				jpwz = "九剑真传·破气式"
				wgtype = 5
			end
			WAR.Person[enemyid]["特效动画"] = 83
			hurt = math.modf(hurt * 0.85)
			WAR.JJPZ[pid] = 1	--九剑破招
			if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+"..jpwz
			else
				WAR.Person[enemyid]["特效文字1"] = jpwz
			end
		end
 
 
 		--斗神风清扬
		if D3FQY(eid) or match_ID_awakened(eid,592,1) and DWPD()  then
			local jpwz;
			local wgtype = 0
			if JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2 then
				jpwz = "九剑真传·破掌式"
				wgtype = 1
			elseif JY.Wugong[wugong]["武功类型"] == 3 then
				jpwz = "九剑真传·破剑式"
				wgtype = 2
			elseif JY.Wugong[wugong]["武功类型"] == 4 then
				jpwz = "九剑真传·破刀式"
				wgtype = 3
			elseif JY.Wugong[wugong]["武功类型"] == 5 then
				jpwz = "九剑真传·破棍式"
				wgtype = 4
			elseif JY.Wugong[wugong]["武功类型"] == 6 then
				jpwz = "九剑真传·破气式"
				wgtype = 5
			end
 			if wgtype == WAR.L_DGQB_DEF then
			   hurt = 0;
			   ang = 0;
			   WAR.L_DGQB_X = WAR.L_DGQB_X + 1;
			      if WAR.L_DGQB_X >= 10 then--
			         WAR.L_DGQB_X = 10
			      end
                 jpwz = "识破."..jpwz
			     WAR.ACT = 10;
		       else
			   hurt = math.modf(hurt*(1-WAR.L_DGQB_X/10));
			   ang = 0;
			   WAR.L_DGQB_X = WAR.L_DGQB_X + 1;
			      if WAR.L_DGQB_X >= 10 then--
			         WAR.L_DGQB_X = 10
			      end
		          if wgtype > 0 then
			         WAR.L_DGQB_DEF = wgtype;
		          end		
			end
			WAR.JJPZ[pid] = 1	--九剑破招
			Set_Eff_Text(enemyid, "特效文字0", jpwz)
		end
 
 		if wglw(eid,47)>=2 and DWPD() and (JLSD(15, 65,eid) or (match_ID_awakened(pid, 35, 1) and WAR.ACT > 1 and JLSD(15, 65,eid) ) ) then
			local jpwz;
			local wgtype = JY.Wugong[wugong]["武功类型"]
			local jpwz1 ={"九剑秘传.封拳","九剑秘传.禁指","九剑秘传.锢剑","九剑秘传.锁刀","九剑秘传.止戈","九剑秘传.闭气"}
			jpwz = jpwz1[wgtype]
			WAR.DGPZ2[pid] = wgtype
			Set_Eff_Text(enemyid, "特效文字0", jpwz)
		end
		
 		if wglw(eid,47)>=1 and DWPD() and WAR.DGPZ1[eid]~=nil then
			local jpwz = WAR.DGPZ1[eid]
			local wgtype = JY.Wugong[wugong]["武功类型"]
			local jpwz1 ={"九剑秘传.破拳","九剑秘传.破指","九剑秘传.破剑","九剑秘传.破刀","九剑秘传.破奇","九剑秘传.破气"}
			local jpwz2 = jpwz1[wgtype]
			if wgtype == jpwz then
			Set_Eff_Text(enemyid, "特效文字1", jpwz2)
			hurt = math.modf(hurt*(1-0.15*wglw(eid,47)))
			end
		end		
 
		--无酒不欢：八荒六合功
		if ((PersonKF(eid, 101) and JLSD(40, 60, eid)) or (Curr_NG(eid, 101) and JLSD(20, 80, eid)) or WAR.NGHT == 101) and DWPD() then
			local reduction = math.modf(hurt * 0.333)
			--童姥吸内
			if match_ID(eid, 117)then
			    if hurt>0 then
				hurt = hurt - reduction
				end
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid, "内力", reduction*2);			
			--北冥真气不耗内
			elseif WAR.B_BMJQ == 1 then	
				hurt = hurt - reduction
			elseif JY.Person[eid]["内力"] > reduction and nglw(eid,101)>=1 then
				hurt = hurt - reduction
				WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid, "内力", -reduction);
		    else
			    WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0)+AddPersonAttrib(eid, "内力", reduction*2);
			end
			local bhwz;
			if math.random(2) == 1 then
				bhwz = "八荒六合.唯我独尊"
				if nglw(eid,101)>2 or match_ID_awakened(eid, 117,1) then
				WAR.YINFU[eid] = 30
				end
			else
				bhwz = "天长地久.不老长春"
				if nglw(eid,101)>2 or match_ID_awakened(eid, 117,1) then
				WAR.YANGFU[eid] = 30
				WAR.L_HQNZL[eid] = 30
				end
			end
			if WAR.Person[enemyid]["特效文字3"] ~= nil then
				WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .."+"..bhwz;
			else
				WAR.Person[enemyid]["特效文字3"] = bhwz
			end
		end
	
	if  WAR.PD["金刚斗气"][eid] ~=nil and WAR.PD["金刚斗气"][eid] > 0 then
		WAR.Person[enemyid]["特效动画"] = 79
		Set_Eff_Text(enemyid, "特效文字1", "斗气护体")	
          if hurt < WAR.PD["金刚斗气"][eid] then	 
			 WAR.PD["金刚斗气"][eid] = WAR.PD["金刚斗气"][eid] - hurt
			 hurt = 0
	      else
            hurt = hurt - WAR.PD["金刚斗气"][eid]
			WAR.PD["金刚斗气"][eid] = nil
		    WAR.Person[enemyid]['斗气'] = nil
	      end
    end
	
		--无酒不欢：太空卸劲35%几率，减伤33.3%，敌方下回合集气位置-120
		for i = 1, CC.Kungfunum do
			if (JY.Person[eid]["武功" .. i] == 15 or JY.Person[eid]["武功" .. i] == 16) and JY.Person[eid]["武功等级" .. i] == 999 then
				WAR.TKXJ = WAR.TKXJ + 1
			end
		end
		if wglw(eid,15)>=1 or wglw(eid,16)>=1 then
		WAR.TKXJ = 2
		end
		
		if WAR.TKXJ == 2 and JLSD(30, 65+wglw(eid,15)*15+wglw(eid,16)*15, eid) then
			WAR.TKXJ = 3
		end
		if WAR.TKXJ == 3 then
		local str = "太空卸劲"
		    local aa = hurt
			hurt = math.modf(hurt * 0.666)
			aa = aa - hurt
			if wglw(eid,16)>=1 then
			WAR.tmp[3000+eid]  = (WAR.tmp[3000+eid] or 0) + aa
			str="太空卸劲.蓄势"
					if wglw(eid,16) >=2 then
		               str="太空卸劲.抽丝劲"
		               hurt = math.max(hurt - math.modf((WAR.tmp[3000+eid] or 0)/4),0)
		            end
			end
			if wglw(eid,15)>1 then
			WAR.KMXK[eid]  = (WAR.KMXK[eid] or 0) + aa
			end
			WAR.TKJQ[pid] = 1	--太空卸劲
			WAR.Person[enemyid]["特效动画"] = 113
			if WAR.Person[enemyid]["特效文字3"] ~= nil then
				WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .."+"..str
			else
				WAR.Person[enemyid]["特效文字3"] = str
			end
		end
		WAR.TKXJ = 0
	end
	
	--闪避不触发两仪守护
	if hurt > 0 then
		--无酒不欢：两仪守护50%几率，固定降低32点伤害
		for i = 1, CC.Kungfunum do
			if (JY.Person[eid]["武功" .. i] == 37 or JY.Person[eid]["武功" .. i] == 60) and JY.Person[eid]["武功等级" .. i] == 999 then
				WAR.LYSH = WAR.LYSH + 1
			end
		end
		if WAR.LYSH == 2 and JLSD(20, 70, eid) then
			WAR.LYSH = 3
		end
		if WAR.LYSH == 3 then
			hurt = hurt - 32
			--至少留1血
			if hurt < 1 then
				hurt = 1
			end
			WAR.Person[enemyid]["特效动画"] = 21
			if WAR.Person[enemyid]["特效文字3"] ~= nil then
				WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .."+两仪守护"
			else
				WAR.Person[enemyid]["特效文字3"] = "两仪守护"
			end
		end
	end

--无酒不欢：太极奥义，降低25%杀气，真太奥免疫杀气
	for i = 1, CC.Kungfunum do
		if (JY.Person[eid]["武功" .. i] == 16 or JY.Person[eid]["武功" .. i] == 46) and JY.Person[eid]["武功等级" .. i] == 999 then
		  WAR.TJAY = WAR.TJAY + 1
		end
	end
	
	  if (WAR.TJAY or 0) < 2 then	--武骧金星：赵半山特效
	if match_ID(eid, 153) then WAR.TJAY = 2 end
	if wglw(eid,16)>=1 or wglw(eid,16)>=1 then 
	WAR.TJAY = 2 
	end
	if match_ID_awakened(eid, 80,1)  then 
	WAR.TJAY = 2 
	end
	if MPPD(eid) == 2 and MPDJ(eid)>1 then
	WAR.TJAY = 2 
	end
	if nglw(eid,171)>=1 then
	WAR.TJAY = 2 
	end
	for j = 0, WAR.PersonNum - 1 do
		local jid = WAR.Person[j]["人物编号"]
		if match_ID(jid, 153) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and math.random(100) <= 15 then 
			WAR.TJAY = 2
		end
	end	
  end
	
	if WAR.TJAY == 2 then
		--张三丰75%几率
		if match_ID(eid, 5) then
			if JLSD(10, 85, eid) then
				WAR.TJAY = 3
			end
		--其他人(35+资质/4)%几率
		elseif match_ID_awakened(eid, 80,1) then
			if JLSD(10, 75, eid) then
				WAR.TJAY = 3
			elseif JLSD(10, 45 + math.modf(JY.Person[eid]["资质"] / 4), eid) then
			    WAR.TJAY = 3
			end
		else
			if JLSD(10, 45 + math.modf(JY.Person[eid]["资质"] / (4-nglw(eid,171))), eid) then
				WAR.TJAY = 3
			end
			if (wglw(eid,16)>=1 or wglw(eid,16)>=1) and JLSD(10, 45 + math.modf(JY.Person[eid]["资质"] / 4) + 10*(wglw(eid,16)+wglw(eid,16)), eid)  then
			WAR.TJAY = 3
			end
		end

	end
	--杀气降低25%
    if WAR.TJAY == 3 then
	    local sy = ang
		ang = math.modf(ang * 0.75)
		sy = sy - ang
		if MPPB_WD(eid) == 1 and MPZJ(eid,2)>2 then
		WAR.WJ[eid] = limitX((WAR.WJ[eid] or 0) + sy,0,200*MPZJ(eid,2))
		end
		if wglw(eid,16) >=1 then
		WAR.tmp[3000+eid]  = (WAR.tmp[3000+eid] or 0) + math.modf(0.1*sy)
		end
		local str="太极奥义"
		if wglw(eid,16) >=2 then
		str="太极奥义.缠丝劲"
		WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + math.modf(0.1*sy)
		end
		--学有太极神功，触发太极奥义减伤10%
		if PersonKF(eid, 171) then
			hurt = math.modf(hurt * 0.9)
		end
		if match_ID_awakened(eid, 80,1)  then
	     WAR.NSTJ[eid]=limitX((WAR.NSTJ[eid] or 0) +10,0 ,100)
		 local aa = 1-WAR.NSTJ[eid]/150
		 hurt = math.modf(hurt * aa)
	     str =str.."·火手无情"
	    AddPersonAttrib(pid, "受伤程度", math.random(10,30))
	    end
		WAR.Person[enemyid]["特效动画"] = 21


		--学有太极神功必出真太奥，否则有25%几率发动
		if PersonKF(eid, 171) or (JLSD(40, 65, eid) or MPZJ(eid,2)>1 ) then
			WAR.TJAY = 4
			local str1 = "·四两拨千斤"
		    if wglw(eid,46)>=1 and ((match_ID(eid, 5) and JLSD(10, 85, eid)) or (JLSD(10, 45 + math.modf(JY.Person[eid]["资质"] / 4), eid)))then----
		        local aa = WAR.ACT
		        WAR.ACT = 10
		        WAR.ZYHB = 0
		        str1 ="·揽雀尾"
					    if MPPB_WD(eid) == 1 or MPPB_WD(eid) == 3 then
		WAR.CYZY[eid] = (WAR.CYZY[eid] or 0) + 1
		if WAR.CYZY[eid] > 10 then
			WAR.CYZY[eid] = 10
		end
		end

	    if MPPB_WD(eid) == 2 or MPPB_WD(eid) == 3 then
		WAR.TJZX[eid] = (WAR.TJZX[eid] or 0) + 1
		  if WAR.TJZX[eid] >  10+nglw(eid,171) then
			WAR.TJZX[eid] = 10+nglw(eid,171)
		  end
		end
		    end
			
		    if wglw(eid,16)>=1 and ((match_ID(eid, 5) and JLSD(10, 85, eid)) or (JLSD(10, 45 + math.modf(JY.Person[eid]["资质"] / 4), eid)))then----
                WAR.MJZS[pid]=500
				if str1 =="·揽雀尾" then----
				str1 ="·野马分鬃"
				else
		        str1 ="·倒卷肱"
				end
				if MPPB_WD(eid) == 1 or MPPB_WD(eid) == 3 then
		           WAR.CYZY[eid] = (WAR.CYZY[eid] or 0) + 1
		           if WAR.CYZY[eid] > 10 then
			          WAR.CYZY[eid] = 10
		           end
		        end

	            if MPPB_WD(eid) == 2 or MPPB_WD(eid) == 3 then
		           WAR.TJZX[eid] = (WAR.TJZX[eid] or 0) + 1
		           if WAR.TJZX[eid] > 10+nglw(eid,171) then
			          WAR.TJZX[eid] = 10+nglw(eid,171)
		           end
		         end
		    end
			
	    if MPPB_WD(eid) == 1 or MPPB_WD(eid) == 3 then
		WAR.CYZY[eid] = (WAR.CYZY[eid] or 0) + 1
		     if WAR.CYZY[eid] > 10 then
			    WAR.CYZY[eid] = 10
		     end
		end

	    if MPPB_WD(eid) == 2 or MPPB_WD(eid) == 3 then
		    WAR.TJZX[eid] = (WAR.TJZX[eid] or 0) + 1
		    if WAR.TJZX[eid] > 10 then
			   WAR.TJZX[eid] = 10
		    end
		end
		
		if WAR.TJXY[eid] == nil  and PersonKF(eid,43) and nglw(eid, 171)>=1  then
		WAR.TJXY[eid] = 1
		    WAR.TJZX[eid] = (WAR.TJZX[eid] or 0) + nglw(eid, 171)*2+1
		           if WAR.TJZX[eid] > 10+nglw(eid,171) then
			          WAR.TJZX[eid] = 10+nglw(eid,171)
		           end
        str = str.."【星移阴阳】"		
		end
		
			str=str..str1
			Set_Eff_Text(enemyid,"特效文字1",str);
		else
			Set_Eff_Text(enemyid,"特效文字1",str);
		end
		if WAR.TJAY<= 3 then
		WAR.TJAY = 0
		end
	end	

	--张三丰：无根无形减伤
	if match_ID(eid, 5) and (JLSD(20, 70, eid) or WAR.TJAY == 4) then
	    local str= "无根无形"
		hurt = math.modf(hurt * 0.5)
             if JLSD(20, 70, eid) and match_ID_awakened(eid,5,1) then----
             hurt = math.modf(hurt * 0.5)
			 str = "阴阳无极"
             end			 
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = str.."+"..WAR.Person[enemyid]["特效文字1"]
		else
			WAR.Person[enemyid]["特效文字1"] = str
		end
	end
	
	--欧阳锋逆运走火
	--有逆运才会
	if WAR.tmp[1000+eid] ~= 1 and match_ID(eid, 60) and PersonKF(eid, 104) then
		if JY.Person[eid]["体力"] > 50 then
			WAR.Person[enemyid]["特效动画"] = math.fmod(wugong, 10) + 85
			WAR.Person[enemyid]["特效文字3"] = "真--逆运筋脉走火入魔"
			WAR.tmp[1000+eid] = 1
		end
	end
		
	--何铁手：给攻击方强制上毒
	if match_ID(eid, 83) and DWPD() then
		WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", math.random(45, 50));
	end

	--何太冲，攻击时60%几率附加琴音状态，上限20层
	if match_ID(pid, 7) and DWPD() and JLSD(20,80,pid) then
		if WAR.QYZT[eid] == nil then
			WAR.QYZT[eid] = math.random(3)
		else
			WAR.QYZT[eid] = WAR.QYZT[eid] + math.random(3)
			if WAR.QYZT[eid] > 20 then
				WAR.QYZT[eid] = 20
			end
		end
		if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
			WAR.Person[enemyid]["特效动画"] = 63
		end
		Set_Eff_Text(enemyid,"特效文字0","铁琴琴音")
	end

		--金轮，十龙十象蓄力
	if WAR.SLSX[pid] ~= nil and DWPD() then
		WAR.HMZT[eid] = 1
	end

	if match_ID_awakened(pid, 3,1) and WAR.MRF == 1 then
		WAR.PJZT[eid] = 50
		WAR.HOT[eid] = 20
		if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		end
		JY.Person[eid]["主运内功"] = 0
	end

	if match_ID_awakened(pid, 3,1) and WAR.MRF1 == 1 then
		WAR.XRZT[eid] = 50
        WAR.JSCL[eid] = 30
	end
	
	--一灯用一阳指，无明业火
	if match_ID(pid, 65) and wugong == 17 and DWPD() then
		WAR.WMYH[eid] = 50
	end

	if match_ID_awakened(pid,53,1) and wugong==49 and DWPD() then
	   local aa = limitX(math.modf(hurt/20),0 ,30)
       WAR.LMJQ1[pid]=limitX((WAR.LMJQ1[pid] or  0 ) + aa,0,100)
		if WAR.LMJQ2[eid]==nil then
		WAR.LMJQ2[eid]=0
		Set_Eff_Text(enemyid,"特效文字0","龙脉剑气.种植")
		end
    end
    
   if WAR.LMJQ2[pid]~=nil and WAR.LMJQ2[pid]>=0 then
       local aa = limitX(math.modf(hurt/20),0 ,30)
       WAR.LMJQ2[pid]=limitX((WAR.LMJQ2[pid] or 0) + aa,0,100)
   end	
	
  if match_ID_awakened(eid,53,1) then
	   local aa = limitX(math.modf(hurt/20),0 ,30)
       WAR.LMJQ1[eid]=limitX((WAR.LMJQ1[eid] or  0 ) + aa,0,100)
	   Set_Eff_Text(enemyid,"特效文字0","龙脉剑气.龙气化生")
  end
  
  if WAR.LMJQ2[eid]~=nil and WAR.LMJQ2[eid]>=0 then
	   local aa = limitX(math.modf(hurt/20),0 ,30)
       WAR.LMJQ2[eid]=limitX((WAR.LMJQ2[eid] or  0 ) + aa,0,100)
       Set_Eff_Text(enemyid,"特效文字0","龙脉剑气.剑气生长")
  end	
	
	--流星剑冰封
	--初始50%，6级100%
	if hurt > 0 and JY.Person[pid]["武器"] == 38 and DWPD() then
		if JLSD(0, 40 + JY.Thing[38]["装备等级"] * 10, pid) then
			JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] + 10
			if JY.Person[eid]["冰封程度"] > 100 then
				JY.Person[eid]["冰封程度"] = 100
			end
			WAR.BFXS[eid] = 1
			if WAR.Person[enemyid]["特效动画"] == -1 or WAR.Person[enemyid]["特效动画"] == 63 then
				WAR.Person[enemyid]["特效动画"] = 80
			end
			if WAR.Person[enemyid]["特效文字3"] ~= nil then
				WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+霜冷剑气"
			else
				WAR.Person[enemyid]["特效文字3"] = "霜冷剑气"
			end
		end
	end
	
	--张无忌 九阳神功反震
	if match_ID(eid, 9) and WAR.Person[enemyid]["特效文字3"] == nil and DWPD() and hurt > 10 and PersonKF(eid, 106) then
		WAR.Person[enemyid]["特效动画"] = math.fmod(97, 10) + 85
		WAR.Person[enemyid]["特效文字3"] = "九阳神功反震"
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		local selfhurt = math.modf(hurt * 0.2)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt)
		if JY.Person[pid]["生命"] < 1 then
			JY.Person[pid]["生命"] = 1
		end
	end

if MPPB_SL(pid) == 2 and WAR.ACT==1 then
     local aa = math.modf(hurt*0.2)
	 hurt = math.modf(hurt*0.8)
     for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["人物编号"]~= pid then
					local tmppid = WAR.Person[j]["人物编号"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] +aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] +3*aa
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) +3*aa;
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		end
	 end
 end 	

if MPPB_SL(eid) == 2 and JLSD(10,40+MPDJ(eid)*10,eid) then
     local aa = math.modf(hurt*(0.1+MPDJ(eid)*0.05))
     for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and WAR.Person[j]["人物编号"]~= eid then
					local tmppid = WAR.Person[j]["人物编号"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] +aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] +3*aa
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) +3*aa;
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		end
	 end
			if WAR.Person[enemyid]["特效动画"] == -1 or WAR.Person[enemyid]["特效动画"] == 63 then
				WAR.Person[enemyid]["特效动画"] = 78
			end
			if WAR.Person[enemyid]["特效文字3"] ~= nil then
				WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+我佛慈悲"
			else
				WAR.Person[enemyid]["特效文字3"] = "我佛慈悲"
			end
 end
 
	if Curr_NG(eid, 169) and WAR.WSMC==4 and DWPD() then --无上意密
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		local selfhurt = math.modf(hurt * 0.5)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt)
		if JY.Person[pid]["生命"] < 1 then
			JY.Person[pid]["生命"] = 1
		end		
		WAR.MZSM[eid] = 2
	end	

	if Curr_NG(eid, 169) and  WAR.WSMC==3  and DWPD() then --无上语密
        WAR.YHLP =  1
		WAR.PZPID = pid
		WAR.JSCL[pid] = 1
		WAR.MZSM[eid] = 3
	end	

	if nglw(eid,178)>=2 and Curr_NG(eid,178) then
	local reduction2 = WAR.BDKY[eid] or 0
       hurt = hurt*(1-reduction2*0.05)
	end

	  if WAR.TJXL[pid]~= nil and WAR.TJXL[pid] >= 1 then
	    local h = 0
		h = math.modf(hurt*0.3*WAR.TJXL[pid])
		hurt = hurt - h
		if WAR.TJZX[eid] ~= nil then
		hurt = math.modf(hurt * (1-0.05*WAR.TJZX[eid]))
		end
		WAR.TJYL[pid] = 1
		if WAR.YYJ[eid]~=nil and WAR.YYJ[eid] == 1 then
		WAR.TJYL[pid] = 2
		end
		if WAR.TJXL[pid] >= 2 then
		h = math.modf(h*(1+0.05*WAR.ACT))
		end
		if WAR.TJXL[pid] == 1 then
		WAR.TJXL[pid] = nil
		end
    	SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2);	--反弹者标识为被命中  	
        WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) - h;
        JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] = JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["生命"] - h
		if D1ZSF(eid) then
		WAR.BG[eid] = (WAR.BG[eid] or 0) + math.modf(h*2.5)
		end
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "以静制动"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+以静制动"
		end
	    WAR.Person[enemyid]["特效动画"] = 21
	end	

	
	--七夕赵敏天地同寿
	if match_ID(eid, 609) and DWPD() and hurt > 10 then
		WAR.Person[enemyid]["特效动画"] = 79
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."+天地同寿"
		else
			WAR.Person[enemyid]["特效文字3"] = "天地同寿"
		end
		SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		local selfhurt = math.modf(hurt)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt)
		if JY.Person[pid]["生命"] < 1 then
			JY.Person[pid]["生命"] = 1
		end
	end
  
	--软猬甲减伤20点，被拳指系武功攻击，会给攻击方强制上10点流血
	--闪避不会触发软猬甲
	if JY.Person[eid]["防具"] == 58 and hurt > 0 then
		local hurt_reduction = 20 + 2 * (JY.Thing[58]["装备等级"]-1)
		hurt = hurt - hurt_reduction
		--触发软猬甲之后至少留1血
		if hurt < 1 then
			hurt = 1
		end
		
		if WGLX == 1 or WGLX == 2 then
			WAR.LXXS[pid] = 1
			if WAR.LXZT[pid] == nil then
				WAR.LXZT[pid] = 10
			else
				WAR.LXZT[pid] = WAR.LXZT[pid] + 10
			end
			if WAR.Person[enemyid]["特效文字3"] ~= nil then
				WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"] .. "+" ..JY.Thing[58]["名称"].."尖刺伤拳"
			else
				WAR.Person[enemyid]["特效文字3"] = JY.Thing[58]["名称"].."尖刺伤拳"
			end
		end
	end
  
	--死亡



   if WAR.JYHT[eid] ~= nil and hurt > 0 and DWPD() then --17-2-8   
	 if hurt>0 then	 
	 WAR.JYHT[eid] = WAR.JYHT[eid] - 1
	    if nglw(eid,106)>2  then
		WAR.JYHT_JX[eid] = (WAR.JYHT_JX[eid] or 0) + math.modf(hurt/2)
		end
	 if WAR.JYHT[eid] == 0 then 
	    WAR.JYHT[eid] = nil 
		local aa = WAR.JYHT_JX[eid] or 0
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(aa)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(aa)
		WAR.JYHT_JX[eid] = nil
	 end
	 if PersonKF(eid,144) then
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 4, 2)
		local selfhurt = math.modf(hurt)
		JY.Person[pid]["生命"] = JY.Person[pid]["生命"] - math.modf(selfhurt)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)-math.modf(selfhurt) 
	 end
	 hurt = -hurt
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+九阳护体罡气"
		else
			WAR.Person[enemyid]["特效文字1"] = "九阳护体罡气"
		end
		WAR.Person[enemyid]["特效动画"] = 51
	 end
  end  
  
 	if JY.Person[pid]["生命"] <= 0 then
		JY.Person[pid]["生命"] = 0
	end 
  
	--误伤打到自己人
	if WAR.Person[WAR.CurID]["我方"] == WAR.Person[enemyid]["我方"] then
		--我方
		if WAR.Person[WAR.CurID]["我方"] then
			--水笙误伤加血
			if WAR.KQB[pid]~=nil then
			   hurt = math.modf(hurt * 10)
			elseif  WAR.JSCL[pid]~=nil  then
			     hurt = math.modf(hurt * 1.25)
		    elseif (wglw(pid, 17)>=1 or MPPB_SL(pid) == 2) and JY.Wugong[wugong]["武功类型"] == 2 then
				if  hurt>0 then
				hurt = -(math.modf(hurt* 1) + Rnd(3))
				else
				hurt = hurt-(math.modf(hurt* 1) + Rnd(3))
				end
				if MPZJ(pid,3)>1 then
				WAR.DEFUP[eid] = 30
				WAR.ATKUP[eid] = 30
				WAR.SPDUP[eid] = 30
				   if MPZJ(pid,3)>2 then
				   WAR.BHJS[eid] = 30
				   end
				end
		    elseif MPPB_SL(pid) == 2 and JY.Wugong[wugong]["武功类型"] == 6 then
				if  hurt>0 then
				hurt = -(math.modf(hurt* 1) + Rnd(3))
				else
				hurt = hurt-(math.modf(hurt* 1) + Rnd(3))
				end
				if MPZJ(pid,3)>1 then
				hurt = hurt - math.modf(JY.Person[pid]["内力"]/3)
				   if MPZJ(pid,3)>2 then
				   WAR.BHJS2[eid] = 30
				   end
				end
			elseif wglw(pid,58)>2 and WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100  then
			
			elseif WAR.WXXY1==1 then
			    hurt = math.modf(hurt * 1.25) + Rnd(10)
			
			elseif match_ID(pid, 589) then
				hurt = -(math.modf(hurt) + Rnd(3))
				if match_ID_awakened(pid,589,1) then--
				hurt = hurt - math.modf(JY.Person[pid]["御剑能力"]/1.5)
				   if WAR.JX_QLJJ>0 and JY.Person[589]["论剑奖励"] == 1 then
				      if WAR.JX_QLJJ == 1 then
					  WAR.YINFU[eid] = (WAR.YINFU[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 2 then
					  WAR.SPDUP[eid] = (WAR.SPDUP[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 3 then
					  WAR.KBGJ[eid] = (WAR.KBGJ[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 4  then
					  WAR.YANGFU[eid] = (WAR.YANGFU[eid] or 0) + 10
					  else 
					  WAR.MZLL[eid] = (WAR.MZLL[eid] or 0) + 10
					  end
				   end
				end
			elseif match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 2   then
			    hurt = hurt + math.modf(JY.Person[pid]["医疗能力"]/3)
				hurt = -hurt
			--其他人误伤30%
			else
				hurt = math.modf(hurt * 0.3) + Rnd(3)
			end
		--NPC，误伤=20%
		else
			--触发逆转乾坤，NPC误伤提高至50%
			if WAR.NZQK == 0 then
			  if WAR.KQB[pid]~=nil then
			   hurt = math.modf(hurt * 10)
			     elseif  WAR.JSCL[pid]~=nil  then
			     hurt = math.modf(hurt * 1.25)
		         elseif (wglw(pid, 17)>=1 or MPPB_SL(pid) == 2) and JY.Wugong[wugong]["武功类型"] == 2 then
			    	if  hurt>0 then
				        hurt = -(math.modf(hurt* 1) + Rnd(3))
				    else
				         hurt = hurt-(math.modf(hurt* 1) + Rnd(3))
				    end
				    if MPZJ(pid,3)>1 then
				       WAR.DEFUP[eid] = 30
				       WAR.ATKUP[eid] = 30
				       WAR.SPDUP[eid] = 30
				    if MPZJ(pid,3)>2 then
				       WAR.BHJS[eid] = 30
				     end
				end
		    elseif MPPB_SL(pid) == 2 and JY.Wugong[wugong]["武功类型"] == 6 then
				if  hurt>0 then
				hurt = -(math.modf(hurt* 1) + Rnd(3))
				else
				hurt = hurt-(math.modf(hurt* 1) + Rnd(3))
				end
				if MPZJ(pid,3)>1 then
				hurt = hurt - math.modf(JY.Person[pid]["内力"]/3)
				   if MPZJ(pid,3)>2 then
				   WAR.BHJS2[eid] = 30
				   end
				end
			elseif wglw(pid,58)>2 and WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100  then
			
			elseif WAR.WXXY1==1 then
			    hurt = math.modf(hurt * 1.25) + Rnd(10)
			
			elseif match_ID(pid, 589) then
				hurt = -(math.modf(hurt) + Rnd(3))
				if match_ID_awakened(pid,589,1) then--
				hurt = hurt - math.modf(JY.Person[pid]["御剑能力"]/1.5)
				   if WAR.JX_QLJJ>0 and JY.Person[589]["论剑奖励"] == 1 then
				      if WAR.JX_QLJJ == 1 then
					  WAR.YINFU[eid] = (WAR.YINFU[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 2 then
					  WAR.SPDUP[eid] = (WAR.SPDUP[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 3 then
					  WAR.KBGJ[eid] = (WAR.KBGJ[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 4  then
					  WAR.YANGFU[eid] = (WAR.YANGFU[eid] or 0) + 10
					  else 
					  WAR.MZLL[eid] = (WAR.MZLL[eid] or 0) + 10
					  end
				   end
				end
			elseif match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 2   then
			    hurt = hurt + math.modf(JY.Person[pid]["医疗能力"]/3)
				hurt = -hurt
			--其他人误伤30%
			else
				hurt = math.modf(hurt * 0.2) + Rnd(3)
			end
				
			else
				 if WAR.KQB[pid]~=nil then
			   hurt = math.modf(hurt * 10)
			elseif  WAR.JSCL[pid]~=nil  then
			     hurt = math.modf(hurt * 1.25)
		    elseif (wglw(pid, 17)>=1 or MPPB_SL(pid) == 2) and JY.Wugong[wugong]["武功类型"] == 2 then
				if  hurt>0 then
				hurt = -(math.modf(hurt* 1) + Rnd(3))
				else
				hurt = hurt-(math.modf(hurt* 1) + Rnd(3))
				end
				if MPZJ(pid,3)>1 then
				WAR.DEFUP[eid] = 30
				WAR.ATKUP[eid] = 30
				WAR.SPDUP[eid] = 30
				   if MPZJ(pid,3)>2 then
				   WAR.BHJS[eid] = 30
				   end
				end
		    elseif MPPB_SL(pid) == 2 and JY.Wugong[wugong]["武功类型"] == 6 then
				if  hurt>0 then
				hurt = -(math.modf(hurt* 1) + Rnd(3))
				else
				hurt = hurt-(math.modf(hurt* 1) + Rnd(3))
				end
				if MPZJ(pid,3)>1 then
				hurt = hurt - math.modf(JY.Person[pid]["内力"]/3)
				   if MPZJ(pid,3)>2 then
				   WAR.BHJS2[eid] = 30
				   end
				end
			elseif wglw(pid,58)>2 and WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100  then
			
			elseif WAR.WXXY1==1 then
			    hurt = math.modf(hurt * 1.25) + Rnd(10)
			
			elseif match_ID(pid, 589) then
				hurt = -(math.modf(hurt) + Rnd(3))
				if match_ID_awakened(pid,589,1) then--
				hurt = hurt - math.modf(JY.Person[pid]["御剑能力"]/1.5)
				   if WAR.JX_QLJJ>0 and JY.Person[589]["论剑奖励"] == 1 then
				      if WAR.JX_QLJJ == 1 then
					  WAR.YINFU[eid] = (WAR.YINFU[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 2 then
					  WAR.SPDUP[eid] = (WAR.SPDUP[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 3 then
					  WAR.KBGJ[eid] = (WAR.KBGJ[eid] or 0) + 10
					  elseif WAR.JX_QLJJ == 4  then
					  WAR.YANGFU[eid] = (WAR.YANGFU[eid] or 0) + 10
					  else 
					  WAR.MZLL[eid] = (WAR.MZLL[eid] or 0) + 10
					  end
				   end
				end
			elseif match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 2   then
			    hurt = hurt + math.modf(JY.Person[pid]["医疗能力"]/3)
				hurt = -hurt
			--其他人误伤30%
			else
				hurt = math.modf(hurt * 0.5) + Rnd(3)
			end
			end
		end
	else--17-1-1
	        if  WAR.JSCL[pid]~=nil  then
                 hurt = -(math.modf(hurt) + Rnd(3))
			end
	        if  WAR.HIDE3[eid]~=nil  then
                 hurt = math.modf(hurt * 0.01) + Rnd(3)
			end	
	end
  
  
 	if nglw(eid,169)>1 and WAR.BJ == 1  and DWPD()  then --沼跃鱼：瑜伽被暴击回血
		local aa = nglw(eid,169)+math.random(1,3)
		hurt=math.modf(hurt*2/aa)
		local xue=aa*30
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", xue)
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+瑜伽秘法.仁王立"
		else
			WAR.Person[enemyid]["特效文字2"] = "瑜伽秘法.仁王立"
		end	
		WAR.Person[enemyid]["特效动画"] = 75
	end   
 
	if WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and hurt > 10 then --and not DT(eid, 89) then --武骧金星：食神MT
		for j = 0, WAR.PersonNum - 1 do
			local jid = WAR.Person[j]["人物编号"]
			if match_ID(jid, 89) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then 
				local MT = math.modf(hurt * 0.35) --这个用来储存挡刀的伤害值
				hurt = hurt - MT --这里要注意，hurt是当前被打的那个人受到的伤害，跟人厨子没有关系
				if JY.Person[jid]["体力"] > math.modf(MT * 0.01) then --我觉得扣减的体力和伤害直接挂钩比较好
					WAR.Person[j]["体力点数"] = (WAR.Person[j]["体力点数"] or 0)+AddPersonAttrib(jid, "体力", math.modf(MT * -0.01))
				else
					MT = MT - JY.Person[jid]["体力"] * 10
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0)+AddPersonAttrib(jid, "生命", MT * -1)
					JY.Person[jid]["体力"] = 0
				end
				WAR.Person[j]["特效文字2"] = "食神秘法.相转移体"
			end
		end
	end--人厨子MT效果

if hurt > 0 and DWPD() then --被打到减战意	
			if match_ID(eid, 50) then
			elseif PersonKF(pid, 184) then		
			elseif match_ID(pid, 70) then
				zhanyi(eid, -1)
			else
				zhanyi(eid, -0.5)
			end
			if WAR.BJ2 >= 1 then
			zhanyi(eid, -2)
			end
	end
	
	if match_ID(pid, 70) and hurt > 0 and DWPD() then	
		zhanyi(pid, 1,1)
	end
    
  
	if DWPD() and WAR.DZXY == 0 then --非反击时连锁增加
		if WAR.Person[WAR.CurID]["我方"] then
			WAR.URCHAIN = 0
			if WAR.MYCHAINADD == 0 then
				WAR.MYCHAINADD = 1
				if WAR.MYCHAIN < 2 then
					WAR.MYCHAIN = WAR.MYCHAIN + 1
				else
					WAR.MYCHAIN = WAR.MYCHAIN + 1
				end
				if WAR.MYCHAIN > 30 then WAR.MYCHAIN = 30 end
			end
		else
			WAR.MYCHAIN  = 0
			if WAR.URCHAINADD == 0 then
				WAR.URCHAINADD = 1
				if WAR.URCHAIN < 2 then
					WAR.URCHAIN = WAR.URCHAIN + 1
				else
					WAR.URCHAIN = WAR.URCHAIN + 1
				end			
				if WAR.URCHAIN > 30 then WAR.URCHAIN = 30 end
			end		
		end	
	end
 

 
	--无酒不欢：伤害的结算到此为止，扣除被攻击方血量

---伤害修正
 if hurt > 200 then 
       local a = hurt 
	   if a > 200 then
	   a = math.modf((a-100)/1.5) + 200
	   end
	   if a > 300 then
	   a = math.modf((a-150)/2) + 300
	   end
	   if a > 400 then
	   a = math.modf((a-200)/3) + 400
	   end
	   if a > 600 then
	   a = math.modf((a-300)/4) + 600
	   end
	   if a > 800 then
	   a = math.modf((a-400)/6) + 800
	   end
	   if a > 1000 then
	   a = math.modf((a-500)/8) + 1000
	   end
--[[	   if a > 1200 then
	   a = math.modf((a-600)/10) + 1200
	   end
	   if a > 1400 then
	   a = math.modf((a-700)/12) + 1400
	   end
	   if a > 1600 then
	   a = math.modf((a-800)/14) + 1600
	   end

	   if a >= 200 then 
	      a = math.modf(a/2) + 100
	   end 
	   if a >= 400 then 
	      a = math.modf(a/2) + 200
	   end  
	   if a >= 800 then 
	      a = math.modf(a/2) + 400
	   end  --]]	   
	   hurt = a
    end 
	
    hurt=math.modf(hurt)   
	
	if hurt > 1999 then
		hurt = 1999
	end
	
	if wugong==22 and WAR.JGZB == 1 then----金刚掌刚掌波
       ang = ang + 5* hurt
	end
	


	if WAR.SZJS[eid] ~= nil and hurt < 100*nglw(eid,94) then
		AddPersonAttrib(eid, "内力", hurt)
		hurt = -(math.modf(hurt) + Rnd(3))
	end		
	
	

	 if (MPPB_GB(eid)==1 or MPPB_GB(eid) == 3) and WAR.BJ == 1  and DWPD() then--
		addeffect2(WAR.GBLJ,eid,1)
		if WAR.GBLJ[eid]>=5 then
		WAR.GBLJ[eid] = 5
		end
		if WAR.Person[enemyid]["特效文字2"] ~= nil then
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+净衣.衣袂破风"
		else
			WAR.Person[enemyid]["特效文字2"] = "净衣.衣袂破风"
		end	
		WAR.Person[enemyid]["特效动画"] = 75
	 end
	
   if match_ID(eid,455) then
      if WAR.BJ == 1 then
	  hurt = 1
	  WAR.Person[enemyid]["特效动画"] = math.fmod(97, 10) + 85
	  WAR.Person[enemyid]["特效文字3"] = "瑜伽大成.苦行坚韧"
	  end
   end






	


   if WAR.BJ==1 and WAR.LUCK[pid]~=nil and JLSD(10,80-WAR.ACT*5,pid) then
       WAR.CXLC = 1
    end	
	
   if WAR.BJ==1 and match_ID(pid,149) then
       WAR.CXLC = 1
    end	
	
   if WAR.NGJL>0 and match_ID_awakened(pid,589,1) and JLSD(10,60,pid) then
       WAR.CXLC = 1
    end		
	
     if match_ID(eid,114) then
        local aa = WAR.LQZ[pid] or 0
		hurt = hurt - math.min(math.modf(hurt*aa/100),hurt)
     end
	
	if Curr_NG(eid, 169) and WAR.WSMC==2 and DWPD() then --无上身密
	   if JY.Person[eid]["内力"] >= math.modf(hurt * 5) then
	  	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -math.modf(hurt * 5))
	    hurt = 0   
	   else
	   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", math.modf(hurt * 5))
	   end
	   WAR.MZSM[eid] = 1
	end	

    if WAR.NZWF[eid]~=nil  and hurt > 0 then
	   local aa = math.modf(hurt * WAR.NZWF[eid])
	   hurt = hurt - aa
	   WAR.NZSH[eid] = aa
	   WAR.NZWF[eid] = nil
	end

	if WAR.NYZQ[pid] ~=nil and WAR.NYZQ[pid]> 0 and DWPD() then
	   local aa = 100
	   if WAR.BLQJ>0 then
	   aa = aa + math.modf(30*WAR.BLQJ)
	   end
	   if WAR.BLQJ>10 then
	   hurt = hurt + (WAR.BLQJ-10) * 50
	   end
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", aa)
	   WAR.NYZQ[pid] = WAR.NYZQ[pid] - 1
	   if WAR.NZSH[pid] ~= nil then
	   aa = aa + WAR.NZSH[pid]
	   WAR.NZSH[pid] = nil
	   end	   
	   if WAR.NYZQ[pid] < 1 then
	   WAR.NYZQ[pid] = 0
	   end
	end

   	if nglw(pid,89)>2 and WAR.ZXJY>0 and HunZi(pid) then --紫霞混沌剑气
       hurt = hurt + WAR.ZXJY *10
	end

	if WAR.JYZQ[pid] ~=nil and WAR.JYZQ[pid]> 0 and DWPD() then
	   local aa = 100
	   
	   if WAR.YYBJ>0 and match_ID_awakened(pid,55,1) then
	   aa = aa + math.modf(30*WAR.YYBJ)
	   end
	
	if wglw(pid,11)>= 2 and wugong == 11 then --九阴真气
	   		local dd = {
						JY.Person[eid]["受伤程度"], 
						JY.Person[eid]["中毒程度"], 
						JY.Person[eid]["冰封程度"],
						JY.Person[eid]["灼烧程度"],
						(WAR.FXDS[eid] or 0),
						(WAR.LXZT[eid] or 0),
						(WAR.CHZ[eid] or 0),
						(WAR.MBZ[eid] or 0),
						}
        WAR.RJZT[eid] = (WAR.RJZT[eid] or 0) + dd[1]
        WAR.NKZT[eid] = (WAR.NKZT[eid] or 0) + dd[1]
        WAR.L_WNGZL[eid] = 	(WAR.L_WNGZL[eid] or 0) + dd[2]	
		if dd[3]>0 then
		local bb = dd[3]*5
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -bb)
		end
		if dd[4]>0 then
		local bb = (WAR.LQZ[eid] or 0)*2
		aa = aa +math.modf(bb*(1+dd[4]/50))
		end
		if wglw(pid,11)> 2 then
		--aa = aa + dd[6] + dd[5]
        if dd[5]>0 then
            WAR.PJZT[eid] = (WAR.PJZT[eid] or 0)+math.modf(dd[5]*0.1)
			if WAR.PJJL[eid] == nil then
			WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		    end
		JY.Person[eid]["主运内功"] = 0 
		aa = aa+ dd[5]
        end	
			if dd[6]> 0 then
		    WAR.KBGJ2[eid] = (WAR.KBGJ2[eid] or 0) + dd[8]
			aa = aa + dd[6]
			WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", dd[6])
		    end	
			if dd[7]> 0 then
			local bb = dd[7]
		       WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -bb)
		       WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", bb)
		    end				

			if dd[8]> 0 then
		    WAR.KBGJ2[eid] = (WAR.KBGJ2[eid] or 0) + dd[8]
		    end
		end

	   end
	   WAR.JYZQ[pid] = WAR.JYZQ[pid] - 1 
	   
	   if WAR.JYZQ[pid]>=1 and  nglw(pid,107)>1 then
	   WAR.YHDF[eid] = 1
	   WAR.JYZQ[pid] = WAR.JYZQ[pid] - 1
	   Set_Eff_Text(enemyid,"特效文字1","九阴摄魂")
	   end
	   aa = math.modf(aa)
	   if aa>= 600 then
	       if match_ID_awakened(pid,55,1) then
		   aa = 800
		   else
	       aa = 600
	       end
	   end
	   hurt = hurt + aa
	   if WAR.JYZQ[pid] < 1 then
	   WAR.JYZQ[pid] = 0
	   end
	end

   if WAR.YKX1 == 3 and DWPD()  then --陈家洛横扫千军
	local aa = 100-JY.Person[eid]["体力"]
	hurt = hurt + aa*2
  end	

	   if WAR.QSLX>0 and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 5 and DWPD() then
          hurt = hurt + JY.Person[eid]["中毒程度"]
		  if JY.Person[eid]["中毒程度"]>= 100  then
		  hurt = hurt + JY.Person[eid]["中毒程度"]* 2
		  end
	   end

 
 	if wugong == 134 and wglw(pid,134)>=1 then
	     if WAR.L_WNGZL2[eid]~=nil then
		   local aa = JY.Person[eid]["中毒程度"]
		   local bb =  WAR.LXZT[eid] or 0
		  WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", aa)
          hurt = hurt + bb			
		 end
	end
	
    if wugong == 134 and wglw(pid,134)>2 then
        if WAR.L_WNGZL3[eid]~=nil and WAR.L_WNGZL3[eid]>=25 then
			 local aa = WAR.L_WNGZL3[eid]
			 WAR.L_WNGZL3[eid] = nil
			     if WAR.L_HBJD[eid] == nil then
				  WAR.L_HBJD[eid] = 1  
				 else
				 hurt = hurt + aa*10
				 end
			   
		end
     end	
 
	if WAR.TGDQ3 == 1 and DWPD() then
		hurt = hurt + 300
	end
	
	if WAR.QSLX_SY == 1 and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 1 and DWPD() then
	    local aa = JY.Person[pid]["耍刀技巧"] * 2
        hurt = hurt + aa	 
	end
	
	if WAR.ARJY_LZ == 5 and wugong == 25 and wglw(pid,25)>2 and DWPD()  then
	   WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", 10)
	   WAR.SKWJ[eid] = (WAR.SKWJ[eid] or 0) + 10
	   hurt = hurt + JY.Person[eid]["受伤程度"]
	end
	
	if WAR.TONY1 == 1 and DWPD() then
	   local aa = WAR.LHYJ[eid] or 0
	   if aa>=5 then
	   WAR.LHYJ[eid] = nil
	   hurt = hurt + 50*aa
	   end
	end
	
	if WAR.TONY3 == 1 and DWPD() then
	   local aa = WAR.RMZT[eid] or 0
	   hurt = hurt + 50
	   if aa>=3 then
	   WAR.RMZT[eid] = nil
	   hurt = hurt + 50*aa
       WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", math.modf(aa/3))
	   end
	end

    if WAR.XLAY == 1 and DWPD() then
       hurt = hurt + math.modf(JY.Person[pid]["内力"]/100)
    end

    if WAR.HSDF>0 and DWPD() then
       hurt =  math.modf(hurt * WAR.HSDF)
	   WAR.DRZT[eid] = limitX((WAR.DRZT[eid] or 0)+1,0,wglw(pid,76)*5)
    end
	


    if WAR.DRZT[eid]~=nil and DWPD() then
       hurt =  math.modf(hurt * (2+0.25*WAR.DRZT[eid]))
    end
	
    if WAR.HSDF_STNJ>0 and DWPD() then
	   if WAR.HSDF_STNJ == 1 then
       hurt =  hurt + math.modf(JY.Person[pid]["内力"]/100)
	   elseif WAR.HSDF_STNJ == 2 then
	   	WAR.ZSXS[eid] = 1
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -JY.Person[eid]["灼烧程度"]*5)
		JY.Person[eid]["灼烧程度"]=(JY.Person[eid]["灼烧程度"] or 0) +15
        if JY.Person[eid]["灼烧程度"]>50 then----
           JY.Person[eid]["灼烧程度"]=50
        end	   
	   else
	   WAR.KHCM3[eid] = 10
	   end
    end	



  if WAR.XQZZ[eid]~=nil and DWPD() then
    hurt = hurt + WAR.XQZZ[eid]*50
 end	

if WAR.WJJS == 2 and DWPD() then --三环套月
   if MPZJ(pid,2)>2 then
   local aa = math.modf((WAR.WJ[pid]or 0) * 0.75)  
   hurt = hurt + aa
   end
end
 
   if WAR.ZBXZ>0 and DWPD() then
      if WAR.ZBXZ == 1 then
         hurt = hurt + JY.Person[pid]["攻击力"]
       end
      if WAR.ZBXZ == 6 then
         hurt = hurt + JY.Person[eid]["防御力"]
      end
   end
 
    if WAR.LMZS == 6 and DWPD() then
       hurt = hurt + (WAR.LXZT[eid] or 0) +(WAR.FXDS[eid] or 0)
   end
 
    if WAR.SZH == 1 and DWPD() then
	   local aa = 1.25
	   if WAR.MENG[eid]~=nil then
	   aa = aa+ 0.25
	   end
	   if WAR.HMZT[eid]~=nil then
	   aa = aa+ 0.25
	   end
	   hurt= hurt+ math.modf(JY.Person[eid]["受伤程度"] * aa)
	end
 
		if WAR.LSDF == 5 and DWPD() then
		hurt= hurt+ math.modf(JY.Person[eid]["中毒程度"] * 1.25)
		end 
 
 if WAR.LSDF > 0  and DWPD() then
    if match_ID_awakened(pid,90,1) and JY.Person[90]["论剑奖励"] == 1 then
	local aa = 1-JY.Person[eid]["生命"]/JY.Person[eid]["生命最大值"]
	local bb = 1-JY.Person[eid]["内力"]/JY.Person[eid]["内力最大值"]
	hurt = math.modf(hurt * (1+bb))
    WAR.LKXZLeech = WAR.LKXZLeech + math.modf(hurt * (0.2+aa))
    end
 end
 
    if WAR.SZH2 == 1 and DWPD() then
	   hurt= hurt+ 200
	   if WAR.HMZT[eid]~= nil then
	   hurt= hurt+ 200
	   end
	end
 
    if Curr_QG(pid,150) and qglw(pid,150)>1  and WAR.XKZ>0 and WAR.ACT == 1 and DWPD() then --瞬息二阶
       hurt = hurt + WAR.XKZ * 30
    end

	if WAR.LSZD2[pid] ~= nil and WAR.LSZD2[pid] == 1 then
		local aa = math.modf(hurt*1)
		if math.random(10) > 7 then
			if hurt > 0 then
				hurt = 0
			end	
			WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"]or 0) + AddPersonAttrib(pid,"生命",-aa)
		end
	end	
	

	if WAR.YYJ[pid]~=nil and WAR.YYJ[pid]==2 and WAR.TJYQ1 == 1 then
	   hurt = hurt + 100
	end

    if WAR.HSDF_STNJ>0 then
	   if WAR.DRZT[eid]~=nil then
	   hurt = hurt + 30*WAR.DRZT[eid]
	   end
	end
	
	if WAR.XTGQ[eid] ~=nil and WAR.XTGQ[eid]> 0 and DWPD() then
	   hurt = -math.modf((JY.Person[eid]["生命最大值"]- JY.Person[eid]["生命"])*0.2)
	   if JLSD(10,40,eid) then
	   hurt = -math.modf((JY.Person[eid]["生命最大值"]- JY.Person[eid]["生命"])*0.7)
	   end
	   WAR.XTGQ[eid] = WAR.XTGQ[eid] - 1
	   if WAR.XTGQ[eid] < 1 then
	   WAR.XTGQ[eid] = 0
	   end
	end
	
    if WAR.LH_DZ == 3 and DWPD()  then
	   hurt = math.max(WAR.YSSH,hurt)
	   WAR.YSSH = 0
	end
	
	if WAR.JSCL2[pid]~=nil and DWPD() then
	   local fhurt  = hurt
	   hurt = 0
	   if fhurt<0 then
	   fhurt = -fhurt * 2
	   end
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"]or 0) + AddPersonAttrib(pid,"生命",-fhurt)
	end
	
	if WAR.LSGY_SS[pid]~=nil and WAR.LSGY_SS[pid] >= 1 and DWPD() then
	hurt = math.modf(JY.Person[eid]["生命最大值"]*0.1)
	   if  WAR.LSGY_SS[pid] >= 2 then
	   hurt = hurt + math.modf(JY.Person[eid]["生命"]*0.5)
	   end
	end
	
    if WAR.DGPZ2[pid]~=nil then
       local kf = WAR.DGPZ2[pid]
	   if kf == kfkind then
	   hurt = 0
	   end
    end	

	if WAR.LM_JQ1 == 5 and DWPD() then
	    local d = math.modf((JY.Person[pid]["攻击力"] ) / 2)
		hurt = hurt + d	
	end
	
	if FanPuGZ(pid) and nglw(pid,102)>2 and DWPD() then
	   hurt = 100 + tianshu()*10
	end


 	if WAR.FLHS4 > 0 and hurt > 30 then
		hurt = 30
	end

	if match_ID(eid, 114) and WAR.FLHS4_2 >= 1 and hurt > 0 then
       hurt = 30
	end



	if nglw(eid,144)>=1  and hurt > 110 - nglw(eid,144)*10 then
	   hurt = 110 - nglw(eid,144)*10
      if nglw(eid,144)>1 then
		    local zzr=0
		    for i = 1, CC.Kungfunum do
			    if JY.Wugong[JY.Person[eid]["武功" .. i]]["武功类型"] == 6 then
				zzr = zzr + 1
			    end
		    end
		    hurt = math.modf(hurt * (1 - 0.08 * (zzr)));
	   end
       if (Curr_NG(eid, 144) or nglw(eid,144)>2 ) and nglw(eid,144)>=1 and JLSD(10, 60+nglw(eid,144)*10, eid) then	   
			   hurt = hurt-20*nglw(eid,144)
			   if hurt<1 or (nglw(eid,144)>2 and JLSD(10, 40, eid)) then
			   hurt=1
			   end
			Set_Eff_Text(enemyid, "特效文字0", "不动明王护体")
			WAR.Person[enemyid]["特效动画"] = 88			   
		end	   
	end

	if WAR.LM_JQ2 == 1 and DWPD() then
	    local d = math.modf((JY.Person[pid]["攻击力"] ) / 5)
        local dd = math.modf((JY.Person[pid]["御剑能力"] ) / 5)
		local ddd = math.modf((JY.Person[pid]["指法技巧"] ) / 5)
		hurt = hurt + d	+ dd+ddd
	    WAR.Person[enemyid]["伤害爆裂_溅射"] = (WAR.Person[enemyid]["伤害爆裂_溅射"] or 0) + math.modf(hurt / 6) 	
	end

	if eid == 0 and JY.Base["标准"] == 6 then--
	   if WAR.JSTG2> 0 then--
	      if WAR.JSTG2> hurt then
		     WAR.JSTG2 = WAR.JSTG2-hurt
			 hurt= 0
		  else
		     hurt = hurt - WAR.JSTG2
			 WAR.JSTG2 = 0
		  end
	   end
	end



	   if WAR.Person[enemyid]["护盾"]> 0 then--
	      if WAR.Person[enemyid]["护盾"]> hurt then
		     WAR.Person[enemyid]["护盾"] = WAR.Person[enemyid]["护盾"]-hurt
			 hurt= 0
		  else
		     hurt = hurt - WAR.Person[enemyid]["护盾"]
			 WAR.Person[enemyid]["护盾"] = 0
		  end
	   end

	
	JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - (hurt)
  
	
	
	--太极拳，挨打蓄力
	if PersonKF(eid, 16) then
		if WAR.tmp[3000 + eid] == nil then
			WAR.tmp[3000 + eid] = 0
		end
		WAR.tmp[3000 + eid] = WAR.tmp[3000 + eid] + hurt;
		if WAR.MJZS[pid]~=nil then --对方中了倒卷肱则进一步蓄力
		WAR.tmp[3000 + eid] = WAR.tmp[3000 + eid] + hurt
		end
		--上限1080
		if WAR.tmp[3000 + eid] > 1080 and wglw(eid,16)<1 then
			WAR.tmp[3000 + eid] = 1080
		end
	end
 
 if MPPD(eid) == 2 and DWPD() then --武当八卦储伤害
	if WAR.BG[eid] == nil then
		WAR.BG[eid] = 0
	end
	WAR.BG[eid] = WAR.BG[eid] + hurt
	if WAR.BG[eid] > math.modf(MPDJ(eid) * 300*(1+MPZJ(eid,2))) then
		WAR.BG[eid] = math.modf(MPDJ(eid) * 300*(1+MPZJ(eid,2)))
	end
  end	
 
	--获取得经验
	WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + math.modf((hurt) / 5)
	
	--装备获取经验
	if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.ZDDH ~= 226 then
		--武器获取经验
		if JY.Person[pid]["武器"] ~= - 1 then
			JY.Thing[JY.Person[pid]["武器"]]["装备经验"] = JY.Thing[JY.Person[pid]["武器"]]["装备经验"] + 5
			if JY.Thing[JY.Person[pid]["武器"]]["装备经验"] > 100 and JY.Thing[JY.Person[pid]["武器"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[pid]["武器"]]["装备经验"] = 0
				JY.Thing[JY.Person[pid]["武器"]]["装备等级"] = JY.Thing[JY.Person[pid]["武器"]]["装备等级"] + 1
			end
		end
		--防具获取经验
		if JY.Person[eid]["防具"] ~= - 1 then
			JY.Thing[JY.Person[eid]["防具"]]["装备经验"] = JY.Thing[JY.Person[eid]["防具"]]["装备经验"] + 5
			if JY.Thing[JY.Person[eid]["防具"]]["装备经验"] > 100 and JY.Thing[JY.Person[eid]["防具"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[eid]["防具"]]["装备经验"] = 0
				JY.Thing[JY.Person[eid]["防具"]]["装备等级"] = JY.Thing[JY.Person[eid]["防具"]]["装备等级"] + 1
			end
		end
		--饰品获取经验
		if JY.Person[eid]["饰品"] ~= - 1 then
			JY.Thing[JY.Person[eid]["饰品"]]["装备经验"] = JY.Thing[JY.Person[eid]["饰品"]]["装备经验"] + 5
			if JY.Thing[JY.Person[eid]["饰品"]]["装备经验"] > 100 and JY.Thing[JY.Person[eid]["饰品"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[eid]["饰品"]]["装备经验"] = 0
				JY.Thing[JY.Person[eid]["饰品"]]["装备等级"] = JY.Thing[JY.Person[eid]["饰品"]]["装备等级"] + 1
			end
		end	
		
		if JY.Person[eid]["坐骑"] ~= - 1 then
			JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] = JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] + 5
			if JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] > 100 and JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"] < 6 then
				JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] = 0
				JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"] = JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"] + 1
			end
		end			
	end
  
	--神照重生
	if JY.Person[eid]["生命"] <= 0 and PersonKF(eid, 94) and WAR.tmp[2000 + eid] == nil and WAR.KMZWD ~= 2 then
		WAR.Person[enemyid]["特效动画"] = 89
		WAR.Person[enemyid]["特效文字3"] = "神照功起死回生"
		local modifier = 0.5
		--狄云
		if match_ID(eid, 37) then
			modifier = 1
		--主运神照
		elseif Curr_NG(eid, 94) then
			modifier = 0.7+0.1*nglw(eid,94)
			JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"]) / 2)
			JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + math.modf((100 - JY.Person[eid]["体力"]) / 2)
		end
		JY.Person[eid]["生命"] = math.modf(JY.Person[eid]["生命最大值"]*modifier)
		JY.Person[eid]["中毒程度"] = math.modf(JY.Person[eid]["中毒程度"] / 2)
		JY.Person[eid]["受伤程度"] = math.modf(JY.Person[eid]["受伤程度"] / 2)
		WAR.Person[enemyid].Time = WAR.Person[enemyid].Time + 500
		if nglw(eid,94)>1 and WAR.SZJS[eid] == nil then
		   WAR.SZJS[eid] = 1
		   WAR.Person[enemyid]["特效文字0"] = "神照奥义.神灵降生"
		end
		if ShenMO(eid) then
		WAR.ACT = 10
		WAR.LQZ[eid] = 10
		   if nglw(eid,94)>=1 then
		   WAR.Person[enemyid]["护盾"] = math.modf((JY.Person[eid]["内力最大值"]) *0.1*(nglw(eid,94)))
		   end
		end
		--狄云
		if match_ID(eid, 37) then
			WAR.Person[enemyid].Time = 990
			WAR.DYSZ = 1
		end
		if match_ID_awakened(eid,37,1) and JY.Person[37]["论剑奖励"] == 1 then
		    WAR.MJBCJ[pid] = (WAR.MJBCJ[pid] or 0) + 1
			for j = 0, WAR.PersonNum - 1 do
			local tmppid = WAR.Person[j]["人物编号"]
			local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
				if WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.Person[j]["死亡"] == false  then
					local nlDam = math.modf(100*(1+JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"]/100))
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -nlDam)
					   if JY.Person[WAR.Person[j]["人物编号"]]["生命"]<1 then
					   JY.Person[tmppid]["生命"] = 1
					   WAR.HMZT[tmppid] = 1
					   end
				end
			end
		end
		if match_ID_awakened(eid,37,1) and JY.Person[37]["论剑奖励"] == 2 then
           WAR.HIDE2[eid] = 50
		end
		if WAR.Person[enemyid].Time > 990 then
			WAR.Person[enemyid].Time = 990
		end
		--6%的几率二次复活
		if math.random(100) > 6 or (math.random(100)>(26+nglw(eid,94)*10) and nglw(eid,94)>1 ) then		
			WAR.tmp[2000 + eid] = 1
		end
	end
  
	--一灯，复活
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 65) and WAR.WCY[eid] == nil then
		WAR.Person[enemyid]["特效动画"] = 19
		WAR.Person[enemyid]["特效文字3"] = "先天一阳 起死回生"
		WAR.WCY[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.7
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])* 0.5
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"])* 0.5
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] * 0.5
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] * 0.5
		WAR.Person[enemyid].Time = 980
		if JY.Person[65]["品德"] <90 then----
		JY.Person[65]["品德"]=JY.Person[65]["品德"] + 1
		   if JY.Person[65]["品德"]== 90 and not match_ID_awakened(eid,65,1) then
		   say("经过多次生死徘徊，我终于看到了生死间的秘密。", 65, 0);
		   say("原来这就是一阳指真正的源头。", 65, 0);
		   say("南诏国的遗宝，终于被我掌握了。", 65, 0);
		   DrawStrBoxWaitKey("一灯领悟了一阳指的源头——气剑指",C_GOLD, CC.DefaultFont)
		   awakening(65,1)
		   JY.Person[65]["品德"]=91
		   end
		end
		if match_ID_awakened(eid,65,1) then--
		   WAR.LMZL = 6
		end
	end
	
	--王重阳，复活
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 129) and WAR.CYZX[eid] == nil then
		WAR.LQZ[eid] = 100
		--畅想主角的七闪数量随天书增加，NPC固定为7
		if eid == 0 then
			WAR.BDQS = math.modf(JY.Base["天书数量"]/2)
		else
			WAR.BDQS = 7
		end
		WAR.Person[enemyid]["特效动画"] = 115
		WAR.Person[enemyid]["特效文字3"] = "重阳再现 论剑形态"
		WAR.CYZX[eid] = 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.7
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])* 0.5
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"])* 0.5
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] * 0.5
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] * 0.5
		WAR.Person[enemyid].Time = 980
		if JY.Person[129]["品德"] <13 then----
		   JY.Person[129]["品德"]=JY.Person[129]["品德"] + 1
		   if JY.Person[129]["品德"]== 13 and not match_ID_awakened(eid,129,1) then
		   say("经过多次生死徘徊，我终于看到了先天奥秘。", 129, 0);
		   DrawStrBoxWaitKey("王重阳领悟了先天剑罡",C_GOLD, CC.DefaultFont)
		   awakening(129,1)
		   JY.Person[129]["品德"]=30
		   end
		end
	end
	
	--戚长发，复活
	if JY.Person[eid]["生命"] <= 0 and match_ID(eid, 594) and WAR.QCF < 1 then
		WAR.Person[enemyid]["特效动画"] = 19
		WAR.Person[enemyid]["特效文字3"] = "闭气离墙.起死回生"
		WAR.QCF = WAR.QCF + 1
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * 0.7
		JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"])* 0.5
		JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"])* 0.5
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] * 0.5
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] * 0.5
		WAR.Person[enemyid].Time = 980
	end
  
	--薛慕华 复活一个人
	if JY.Person[eid]["生命"] <= 0 and WAR.XMH == 0 then
		for i = 0, WAR.PersonNum - 1 do
			if match_ID(WAR.Person[i]["人物编号"], 45) and WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[enemyid]["我方"] then
				WAR.Person[enemyid]["特效动画"] = 89
				WAR.Person[enemyid]["特效文字3"] = "阎王敌 重生"		--阎王敌 重生
				JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
				JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
				JY.Person[eid]["中毒程度"] = 0
				JY.Person[eid]["受伤程度"] = 0
				JY.Person[eid]["体力"] = 100
				WAR.FXDS[eid] = nil
				WAR.LXZT[eid] = nil
				WAR.XMH = 1
				if match_ID_awakened(WAR.Person[i]["人物编号"], 45,1) and JLSD(10,50,WAR.Person[i]["人物编号"]) then
				WAR.XMH = 0
				end
				break;
			end
		end
	end
	
	--血刀老祖或血海二阶 杀死敌人后转化为己方
	if (match_ID(pid, 97) or nglw(pid,163)>=2 ) and JY.Person[eid]["生命"] <= 0 then
		WAR.Person[enemyid]["我方"] = WAR.Person[WAR.CurID]["我方"]
		JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"]
		JY.Person[eid]["内力"] = JY.Person[eid]["内力最大值"]
		JY.Person[eid]["中毒程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["体力"] = 100
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil
		WAR.CHZ[eid] = nil
		WAR.MBZ[eid] = nil
		WAR.XDLZ[eid] = 1
		WAR.XDLZ2[eid] = 1
	end
  
	--小日本
	if eid == 553 and JY.Person[eid]["生命"] <= 0 then
		WAR.YZB = 1
	end
  
	--无酒不欢：如果被打死则不会触发反击
	if JY.Person[eid]["生命"] <= 0 then
		JY.Person[eid]["生命"] = 0
		WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + JY.Person[eid]["等级"] * 5
		WAR.Person[enemyid]["反击武功"] = -1
	end
	
	--主角刀系，每个刀法练到极，减少受到的5%杀气
	if JY.Base["标准"] == 4 and eid == 0 then
		local askd = 0
		for i = 1, CC.Kungfunum do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] == 999 then
				askd = askd + 1
			end
		end
		if askd > 7 then
			askd = 7
		end
		ang = math.modf(ang * (1 - 0.05 * (askd)))
	end
	
     if MPPB_WYQZ(eid) ==1 and WAR.ZXXS2[eid]~=nil and DWPD() then--沼跃鱼：重峦叠嶂
    local aa = WAR.ZXXS2[eid] or 0
	if aa >= 10 then
	   ang = 0
	   WAR.GTSHAQI = 0
	else 
       ang = math.modf(ang*(1-aa/10))	
	end
	   dng = dng*math.modf(1+aa/10)
	local nn=math.modf(dng/2)
	local nn2=math.modf(dng/20)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +	AddPersonAttrib(eid, "内力", nn)
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +	AddPersonAttrib(eid, "生命", nn2)
   if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "气宗紫霞.重峦叠嶂"	
	else
		WAR.Person[enemyid]["特效文字2"] = "气宗紫霞.重峦叠嶂+"..WAR.Person[enemyid]["特效文字2"]	
	end	
	WAR.Person[enemyid]["特效动画"] = 115
	end  	
	
	--两仪守护降低320点气攻
	if WAR.LYSH == 3 then
		ang = ang - 320
		if ang < 0 then
			ang = 0
		end
	end
	WAR.LYSH = 0
	
	--计算是否破气防，dng为0表示被破气防
	ang = ang - dng
	if 0 < ang then
		dng = 0
	else
		dng = -ang
		ang = 0
	end

	--真太奥免疫杀气
	if WAR.TJAY == 4 then
		dng = 1
		if MPPB_WD(eid) == 2 or MPPB_WD(eid) == 3 then--
		local aa = WAR.TJZX[eid] or 0
		WAR.MSTX = aa*7
		WAR.GTEID = eid
		end
	end
	WAR.TJAY = 0
	
	--东方不败，葵花秘法·化凤为凰免疫杀气
	if match_ID(eid, 27) and WAR.LQZ[eid] == 100 then
		dng = 1
	end
 
 			if wglw(eid,74)>1 and WAR.SHJG[eid] ~= nil and WAR.SHJG[eid] == 4 and WAR.LQZ[eid] == 100 then
               dng = 1
			   WAR.MSTX = 70
		       WAR.GTEID = eid
			   WAR.GTSHAQI = 0
			   WAR.GTPID2 = pid
			end
 
	if WAR.BHJS2[eid]~=nil then
		dng = 1
		WAR.Person[enemyid]["特效文字1"] = "稳固心神"		--稳固心神
		WAR.Person[enemyid]["特效动画"] = 89
	end
 
	--扫地  免杀气
	if match_ID(eid, 114) then
	    local str = "天地独尊"
		WAR.Person[enemyid]["特效文字2"] = str	--天地独尊
		WAR.Person[enemyid]["特效动画"] = 39
		dng = 1
	end
	
	--易筋真谛  免杀气
	if Curr_NG(eid, 108) and (JLSD(30,70,eid) or (nglw(eid,108)>=1 and JLSD(30,70,eid) )) then
		local str="+易筋真谛"
		if nglw(eid,108)>=1 then
		str="+易筋真谛.菩提化气"
		   if nglw(eid,108)>1 then
		   str="+易筋真谛.摩诃化生"
		   end
	   end
	   if match_ID(eid,149) then
	   WAR.MSTX = 70
	   local aa = 100 + math.modf((WAR.LQZ[eid] or 0)*1.75)
	   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa); 
	   end
       if PersonKF(eid,144) and nglw(eid,108)>1 then
	   WAR.MSTX = 30
	   WAR.GTEID = eid
	   str=str..".金刚印"
	   end
		dng = 1
		if MPPB_SL(eid) == 2 and MPZJ(eid,3)>1 then
		local bb = MPZJ(eid,3) * math.modf(ang/10)
	         WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", bb);
			 str="+易筋真谛.弥陀"
			if MPZJ(eid,3)>2 and  JY.Person[eid]["生命"] > 0 then--
			bb=math.modf(bb*0.1)
		    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", bb); 
            str="+易筋真谛.楞严"			
		    end
		end
		
		if nglw(eid,108)>0  then
		local aa=math.modf(ang/50)
		local bb=0
		if JY.Person[eid]["受伤程度"] > 0 then
		JY.Person[eid]["受伤程度"] = JY.Person[eid]["受伤程度"] - aa
		bb=bb+1
		end
		if JY.Person[eid]["中毒程度"] > 0 then
		JY.Person[eid]["中毒程度"] = JY.Person[eid]["中毒程度"] - aa
		bb=bb+1
		end
		if JY.Person[eid]["灼烧程度"] > 0 and nglw(eid,108)>1 then
		JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] - aa
		bb=bb+1
				if JY.Person[eid]["灼烧程度"] < 0 then
					JY.Person[eid]["灼烧程度"] = 0
				end
		end
		if JY.Person[eid]["冰封程度"] > 0 and nglw(eid,108)>1 then
		JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] - aa
		bb=bb+1
				if JY.Person[eid]["冰封程度"] < 0 then
					JY.Person[eid]["冰封程度"] = 0
				end
		end
		if WAR.LXZT[eid] ~= nil and WAR.LXZT[eid] > 0 and nglw(eid,108)>2 then
		WAR.LXZT[eid] = WAR.LXZT[eid] - aa
		bb=bb+1
				if WAR.LXZT[eid] <=0 then
		           WAR.LXZT[eid] = nil
		        end
		end
		if WAR.CHZ[eid] ~= nil and WAR.CHZ[eid] > 0 and nglw(eid,108)>2 then
		WAR.CHZ[eid] = WAR.CHZ[eid] - aa
		bb=bb+1
				if WAR.CHZ[eid] <=0 then
		           WAR.CHZ[eid] = nil
		        end
		end
		if WAR.MBZ[eid] ~= nil and WAR.MBZ[eid] > 0 and nglw(eid,108)>2 then
		WAR.MBZ[eid] = WAR.MBZ[eid] - aa
		bb=bb+1
				if WAR.MBZ[eid] <=0 then
		           WAR.MBZ[eid] = nil
		        end
		end		
		if WAR.FXDS[eid] ~= nil and WAR.FXDS[eid] > 0 and nglw(eid,108)>2 then
		WAR.FXDS[eid] = WAR.FXDS[eid] - aa
		bb=bb+1
				if WAR.FXDS[eid] <=0 then
		           WAR.FXDS[eid] = nil
		        end
		end
		bb=bb*150
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", bb);
			if nglw(eid,108)>3 and  JY.Person[eid]["生命"] > 0 then--
			bb=math.modf(bb*0.1)
		    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", bb);   	
		    end
			if match_ID_awakened(eid,114,1) and  JY.Person[eid]["生命"] > 0 then--
			bb=math.modf(bb*0.5)
		    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", bb);   	
		    end
		end
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"]..str
		else
			WAR.Person[enemyid]["特效文字1"] = str
		end
		WAR.Person[enemyid]["特效动画"] = 39
	end

	
	if Curr_NG(eid, 169) and (nglw(eid,169)>2 or (match_ID(eid,455) and JY.Person[pid]["六如觉醒"] > 0) )and WAR.NGHT>0  then --沼跃鱼：瑜伽无上密乘
		--if JLSD(10, 20 + JY.Base["天书数量"]*5, eid) then 
			WAR.WSMC=1 --
		--end
	end
	
	if Curr_NG(eid, 169) and WAR.WSMC==1 and DWPD() then --滕青山神兽斗气
       Set_Eff_Text(enemyid,"特效文字3","无上密乘")
		WAR.WSMC=math.random(3)+WAR.WSMC --2-5
		if WAR.WSMC==2 then 
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."·身密" 
			WAR.Person[enemyid]["特效动画"] = 51
		elseif WAR.WSMC==3 then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."·语密" 
			WAR.Person[enemyid]["特效动画"] = 48
		elseif WAR.WSMC==4 then 
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"].."·意密" 
			WAR.Person[enemyid]["特效动画"] = 46
		end
	end	
	
--葵花三阶
	if Curr_NG(eid, 105) and nglw(eid,105)>2 and WAR.NGHT>0 and KUIHUA(eid) == 2 then

        local aa=0
		local bb=0
		local cc=WAR.FXDS[eid] or 0
		local dd=WAR.LXZT[eid] or 0
        aa = (JY.Person[eid]["受伤程度"]+JY.Person[eid]["冰封程度"]+JY.Person[eid]["灼烧程度"]+JY.Person[eid]["中毒程度"])+cc+dd
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["中毒程度"] = 0
		WAR.FXDS[eid] = nil
		WAR.LXZT[eid] = nil 
		bb = aa* 15
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", aa)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +AddPersonAttrib(eid, "内力", bb);
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."天人化生.万物相长"
		else
			WAR.Person[enemyid]["特效文字1"] = "天人化生.万物相长"
		end
		WAR.Person[enemyid]["特效动画"] = 39
	end	

	if MPPD(eid) == 3 and JLSD(10, 40 + MPDJ(eid)*10, eid) and WAR.Defup[eid] == nil then --金钟罩
		if WAR.Person[enemyid]["特效文字3"] ~= nil then
			WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字3"]..CC.PSKILL[3][1]
		else
			WAR.Person[enemyid]["特效文字3"] = CC.PSKILL[3][1]
		end
	  WAR.Defup[eid] = 1
	end	
	
  if match_ID_awakened(eid,129,1) and WAR.NGHT > 0 and DWPD() then--沼跃鱼：重阳真打
	ang = 0
	dng = 1
	WAR.ACT=10
	WAR.MSTX = 90
	WAR.GTEID = eid
	local nn=math.modf(JY.Person[eid]["内力"]*0.15)
	if 0 < JY.Person[eid]["生命"] then
	WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", nn)
	end
   if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "先天真气.剑罡护体"	
	else
		WAR.Person[enemyid]["特效文字2"] = "先天真气.剑罡护体+"..WAR.Person[enemyid]["特效文字2"]	
	end	
	WAR.Person[enemyid]["特效动画"] = 78
	end
   
 
   
    if match_ID_awakened(eid,65,1) and WAR.NGHT > 0 and JLSD(10,60,eid) and DWPD() then--沼跃鱼：六气合一
    WAR.MSTX = 34
	WAR.GTEID = eid
	ang = math.modf(ang * 0.66)
	dng = dng+math.modf((TrueYJ(eid)+JY.Person[eid]["指法技巧"])*5)
	if eid~= 0 then--
	dng = dng + 2000
	end
	local nn=math.modf(dng/2)
    local nn2=math.modf(ang/20)
	WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) +	AddPersonAttrib(eid, "内力", nn)
    WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", -nn2)
	WAR.HOT[pid] = (WAR.HOT[pid] or 0) + (nn2 * 2)
   if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "气脉贯通.六气合一"	
	else
		WAR.Person[enemyid]["特效文字2"] = "气脉贯通.六气合一+"..WAR.Person[enemyid]["特效文字2"]	
	end	
	if WAR.WCY[eid] ~= nil and WAR.LMZL == 0 then--
	WAR.LMZL = 1
	WAR.Person[enemyid]["特效文字0"] = "神龙呼吸.龙脉代谢"
	end
	
	WAR.Person[enemyid]["特效动画"] = 140
	end 


  if match_ID_awakened(eid,58,1)  and DWPD() then --杨过攻其必救
	local sp = math.modf(TrueYJ(eid)/10)
	local sp2 = sp/100
    local str="无锋离剑式"	
	WAR.MSTX = sp2*10
	WAR.GTEID = eid
    sp= sp + math.modf((WAR.LQZ[eid] or 0) * 0.05)
	dng = dng+math.modf(TrueYJ(eid)*10)
	
	if JLSD(10, 40+sp, eid) and WAR.XTCJ ~= 1 then

	 for i = 0, WAR.PersonNum - 1 do
      if  match_ID_awakened(WAR.Person[i]["人物编号"],58,1) and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[WAR.CurID]["特效文字0"] or nil
			local tx_2 = WAR.Person[WAR.CurID]["特效文字1"] or nil
			local tx_3 = WAR.Person[WAR.CurID]["特效文字2"] or nil
			local tx_4 = WAR.Person[WAR.CurID]["特效文字3"] or nil
			local tx_5 = WAR.Person[WAR.CurID]["特效文字4"] or nil
			local tx_6 = WAR.Person[WAR.CurID]["特效动画"]
			WAR.Person[WAR.CurID]["特效文字0"] = nil
			WAR.Person[WAR.CurID]["特效文字1"] = nil
			WAR.Person[WAR.CurID]["特效文字2"] = nil
			WAR.Person[WAR.CurID]["特效文字3"] = nil
			WAR.Person[WAR.CurID]["特效文字4"] = nil
			WAR.Person[WAR.CurID]["特效动画"] = -1
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
        str=".钝击锉剑式"
		local tmppid = WAR.CurID
		WAR.CurID = i
		
        WAR.XTCJ = 1
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 101,1, "玄铁九剑.攻其自救", C_RED)    
        --玄铁反击
		    local n = 1
		    for w = 1, 12 do
			    if match_ID_awakened(eid,58,1) and JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功" .. w] == 45 then
				n = w
				end
			end	
        War_Fight_Sub(WAR.CurID, n, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"])
		WAR.YHDF[tmppid]=1
		WAR.XTCJ = 0
		lib.Delay(200)
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[tmppid]["人物编号"]]["生命"] <= 0 then
				return 1
			else		
				WAR.CurID = tmppid
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[WAR.CurID]["特效文字0"] = tx_1
				WAR.Person[WAR.CurID]["特效文字1"] = tx_2
				WAR.Person[WAR.CurID]["特效文字2"] = tx_3
				WAR.Person[WAR.CurID]["特效文字3"] = tx_4
				WAR.Person[WAR.CurID]["特效文字4"] = tx_5
				WAR.Person[WAR.CurID]["特效动画"] =  tx_6
			end		
      end
    end    
	end	
	if WAR.Person[enemyid]["特效文字0"] == nil then
		WAR.Person[enemyid]["特效文字0"] = "玄铁九剑奥义."..str	
	else
		WAR.Person[enemyid]["特效文字0"] = "玄铁九剑奥义."..str.."+"..WAR.Person[enemyid]["特效文字0"]
	end	
	WAR.Person[enemyid]["特效动画"] = 145
	end

	
	--盖世无双，免内伤，免杀气 
	for i = 1, CC.Kungfunum do
		if (JY.Person[eid]["武功" .. i] == 26 or JY.Person[eid]["武功" .. i] == 80) and JY.Person[eid]["武功等级" .. i] == 999 then
			WAR.GSWS = WAR.GSWS + 1
		end
	end
	if WAR.GSWS == 2 and JLSD(20, 45 + math.modf(JY.Person[eid]["资质"] / 4), eid) then
		dng = 1
		if WAR.Person[enemyid]["特效文字1"] ~= nil then
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+盖世无双"
		else
			WAR.Person[enemyid]["特效文字1"] = "盖世无双"
		end
		WAR.Person[enemyid]["特效动画"] = 10
	end
	WAR.GSWS = 0

	--狄云赤心连城追加连击
	if match_ID(pid, 37) then
       if hurt < 200 then
		WAR.CXLC = 1
	   elseif match_ID_awakened(pid,37,1) and WAR.BJ == 1 then--
	    WAR.CXLC = 1
	   end		
	end
 
	--伤害小于等于30 免内伤，免杀气 
	if hurt <= 30 then
		dng = 1
	end
  
	--狄云复活第一回合，免内伤，免杀气 
	if match_ID(eid, 37) and WAR.DYSZ == 1 then
		dng = 1
		WAR.DYSZ = 0
	end
  
	--不动如山，免内伤，免杀气 
	if eid == 0 and 0 < WAR.FLHS4 then
		dng = 1
	end

--刘乘风 免杀气
if match_ID(eid,95) then
WAR.Person[enemyid]["特效文字2"]="柔劲卸力"
WAR.Person[enemyid]["特效动画"]=6
dng=1
end

--定闲 60%免杀气
if match_ID(eid,21) and JLSD(20,80,eid) then
WAR.Person[enemyid]["特效文字2"]="气定神闲"
WAR.Person[enemyid]["特效动画"]=6
dng=1
end
	

  
	--刀系大招，忽视绝对气防
	if WAR.ASKD == 1 then
		dng = 0
	end

    if WAR.TZQJ == 1 and wugong == 18 then----紫霞弹指气劲
       dng = 0
	end

    if WAR.TZQJ == 1 and yongnei(wugong) then----紫霞弹指气劲
       dng = 0
	end
	
	if WAR.ASKD1 == 1 then
		dng = 0
	end

	if WAR.WYSQ == 1 then
		dng = 0
	end
	
	if WAR.LYBF == 3 then
    dng = 0
    end	
	
	if WAR.JGHJ == 102 then
		dng = 0
		WAR.MENG[eid] = (WAR.MENG[eid] or 0) + 20
	end
	
	if WAR.JGHJ == 105 then
		dng = 0
	end
	
	--胡斐大招
	if WAR.HFYD == 1 then
		dng = 0
	end

	--易筋三重天赋 伏魔印
	if WAR.FMY == 1 then
		dng = 0
	end	
	
	--天罡大招，忽视绝对气防
	if WAR.JSTG == 1 then
		dng = 0
	end
	
	--破尽天下，忽视绝对气防
	if WAR.PJTX >= 1 then
		dng = 0
	end
	
	--郭靖降龙后劲超过11道，忽视绝对气防
	if WAR.YYBJ > 11 then
		dng = 0
	end

	if WAR.BLQJ > 12 then
		dng = 0
	end

	if WAR.RMDY==3 then----
      dng = 0
      WAR.JHLY3[eid]=math.modf(JY.Person[eid]["灼烧程度"])
    end  
	
	--太玄之轻40%几率
	if Curr_NG(eid, 102) and JLSD(20, 60, eid) then
		WAR.TXZQ[eid] = 1
		if nglw(eid,102)>2 then
		WAR.TXZQ[eid] = 2
		end
	end
 
	if match_ID(eid,40) and JLSD(20, 60, eid) then
WAR.TXZQ[eid] = 2
	end
 
    if match_ID_awakened(eid,64,1)  then
	   if WAR.ZBT1[eid]~=nil then
	    dng = 0
		ang = ang+100*WAR.ZBT1[eid]
		WAR.ZBT1[eid]=nil
	   end
	end
--进一步加伤与减伤判定    
	local ffhurt = 0
    local ffhurt2 = 0
	if WAR.MSTX2> 0 and WAR.GTEID == eid then
	   if hurt>0 then
	   ffhurt= math.modf(hurt*(WAR.MSTX2*0.01))
	   else
	   ffhurt= - math.modf(hurt*(WAR.MSTX2*0.01))
	   end
	   WAR.MSTX2 = 0
	end		
   if WAR.MSTX> 0 and WAR.GTEID == eid then
	   if hurt>0 then
	   ffhurt2= math.modf(hurt*(WAR.MSTX*0.01))
	   else
	   ffhurt2= -math.modf(hurt*(WAR.MSTX*0.01))
	   end
	   WAR.MSTX = 0	   
   end	 

  if WAR.GTEID == eid then
  JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - (ffhurt) + ffhurt2 
  WAR.GTEID = -1
  end
  
	--破气防后内伤计算
	if (dng == 0 or WAR.YTML == 1 ) and hurt > 0 and DWPD() and WAR.SFXW[eid] == nil then
		local n = 0;		--内伤点数值
		if inteam(eid) then		--队友内伤计算
			n = (hurt) / 10
		else
			n = (hurt) / 16
		end
		
		if pid == 0 and zylw(1)>0 then--
		local kfkind = JY.Wugong[wugong]["武功类型"] 
		   if  kfkind == 1 then
		   local aa = math.modf(JY.Person[pid]["拳掌功夫"]/20)
		   n = n + aa
		   end
		end
		
		--张召重攻击，内伤加倍
		if match_ID(pid, 80) then
		    if match_ID_awakened(pid, 80,1) then 
			local m = TrueYJ(pid)
		    n=n + m
			end
		    n = n * 2
		end
		
		--主运先天，逆运，蛤蟆，灵蛇玄功，内伤-30%
		if Curr_NG(eid, 100) or Curr_NG(eid, 104) or Curr_NG(eid, 95) or Curr_NG(eid, 180) then
			n = n*0.7
		end
	
		if Curr_NG(pid, 104) and nglw(pid,104)>1 then
			n = n*1.5
		end

		if WAR.ASKD2 == 5  then
			n = n*2
		end

        --金关增强内伤效果
		if PersonKF(pid, 178) then
           n = n*1.25
		end

		if PersonKF(eid, 172) then
			n = n*0.7
		end

		--主运乾坤，罗汉，内伤-60%
		if Curr_NG(eid, 97) or Curr_NG(eid, 96) then
			n = n*0.4
		end

        if WAR.XYYZ == 2 and DWPD() then
		   n = n + math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])*0.01)
		   if n+JY.Person[eid]["受伤程度"]>100 then
		   local n2 = -(n+JY.Person[eid]["受伤程度"] - 100)*50
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", n2)
		   end
		end


		if Curr_NG(eid, 172) then
			n = 0
		end
		
		--装备乌蚕衣，1级内伤-5，6级内伤-10
		if JY.Person[eid]["防具"] == 59 then
			n = n - 5 - (1+nglw(eid,94))*(JY.Thing[59]["装备等级"]-1)
		end

	    if WAR.BLC==5   then
		   local aa = (WAR.BG[pid] or 0)
		   n = n+math.modf(aa/10) 
	     end	
		
		--控制范围
		n = limitX(n, 0, 100)

		--太玄之轻免疫内伤
		if WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] >= 1 then
			n = 0
		end
		if MPPB_MZ(eid) == 2 and JY.Person[eid]["生命"] > 0 then
		   local n2 = math.modf(n*10)
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", n2);  		
		   n =0
		end	

        if WAR.XYYZ == 2 and DWPD() then
		   n = n + math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])*0.01)
		   if n+JY.Person[eid]["受伤程度"]>100 then
		   local n2 = -math.modf((n+JY.Person[eid]["受伤程度"] - 100)*10*wglw(pid,2))
		   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", n2)
		   end
		end		

		if WAR.LMZS == 3 and wglw(pid,49)>2 and DWPD() then
		   n = n + math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"])*0.01)
		end
		
		n= math.modf(n)
		
    	WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + n;
  		AddPersonAttrib(eid, "受伤程度", n);
		if Curr_NG(pid, 104) and nglw(pid,104)>2 then
		local n2 = -n*10
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", n2);
		end
		if Curr_NG(pid, 95) and nglw(pid,95)>2 then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", n);	
		end

		if Curr_NG(pid, 180)  then

		   if JY.Person[pid]["中毒程度"]>= 100  then
		local n2 = -n*10
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", n2);		    
		   else
			WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", n);
		   end
		end

	end
  
	--破防杀集气计算
	if (((dng == 0 or WAR.GTSHAQI>0  )and hurt > 0) or WAR.BSQ == 1) and DWPD() then
		local killsq;
		--被杀集气随难度增加
		if JY.Base["难度"] == 1 then
			killsq = 0.8
		elseif JY.Base["难度"] == 2 then
			killsq = 1.1
		elseif JY.Base["难度"] == 3 then
			killsq = 1.5
		elseif JY.Base["难度"] == 4 then
			killsq = 1.7
		elseif JY.Base["难度"] == 5 then
			killsq = 1.9
		elseif JY.Base["难度"] == 6 then
			killsq = 2.5
		end
				
		local killjq = 0
		

		
			
		
		if inteam(eid) then  
			killjq = math.modf(ang / 10 * killsq)
		else
			killjq = math.modf(ang / 10)
		end

		 if WAR.BSQ == 1 then
		    if WAR.LQS ==3 then
			killjq = killjq + 100
			end
			if WAR.CYJG == 1 then
			killjq = killjq + 100
			end
			if WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 2 then
	        killjq = killjq + 1000  
	        end
		 WAR.BSQ = 0
		 end
         
		local yskill = killjq 
		
		if  match_ID_awakened(pid, 35, 1) and wugong == 47 then
		    yskill = math.modf(yskill * 1.25)
		end


		 
		--受伤害额外杀集气
		local spdhurt = 0
		--难5开始NPC追加伤害杀气
		if inteam(eid) and JY.Base["难度"] > 4 then
			spdhurt = math.modf(hurt * 0.6)
		end

		--龙象追加杀气
		if PersonKF(pid, 103) then
			if Curr_NG(pid, 103) then
				spdhurt = math.modf(hurt * 0.6)
			else
				spdhurt = math.modf(hurt * 0.3)
			end
		end
		


       	if WAR.LSDZ[pid]~= nil and WAR.LSDZ[pid] == 5 then
           local aa = math.modf(JY.Person[eid]["中毒程度"]/150)
		   spdhurt = spdhurt + math.modf(hurt * aa)
	    end			

		--如果学了八荒不受伤害杀集气
		if PersonKF(eid, 101) then
		   if nglw(eid,101)>=1 then
		     spdhurt = spdhurt*(nglw(eid,101)-1)
		   else
			spdhurt = 0
		   end
		end
			
		killjq = killjq + spdhurt
 
		if wglw(pid, 49)>=1 and WAR.LMZS == 3 then
		   killjq = killjq + math.modf(hurt * 1.2) + math.modf(JY.Person[pid]["内力"]*0.05)
		end
		yskill = math.min(killjq,yskill) 
		
		

 	if Curr_NG(eid,184) and WAR.LQZ[eid]~=nil and WAR.LQZ[eid] == 100 then
       killjq = killjq - WAR.SPIRIT[pid]
	end 

	  if WAR.GTSHAQI > 0 and WAR.GTPID2 == pid then
		if dng == 0 then
			killjq = killjq + WAR.GTSHAQI
		else 
			killjq = WAR.GTSHAQI
		end
	  end	

if WAR.WXZQ[pid]~=nil and WAR.WXZQ[pid] == 1 then
    killjq = killjq *2
end
		if wglw(pid,17)>1  then--
           killjq = killjq + 10 * (WAR.FXDS[eid] or 0)		
		end
	  
		if WAR.L_TLD == 1 and wglw(pid,67)>2 then
		killjq = killjq * 2
  	    end
		
		if wglw(eid,58)>2 and WAR.LQZ[eid]==100 and PersonKFJ(eid,58) then
		killjq = 0
		end

		if nglw(eid,104)>1 and PersonKF(eid,104) then
		killjq = 0
		end		

        --金关增强杀气效果
		if PersonKF(pid, 178) then
			if Curr_NG(pid, 178) then
				killjq = math.modf(killjq * 1.3)
			else
				killjq = math.modf(killjq * 1.15)
			end
			if nglw(pid,178)>=1 then
			local aa = WAR.Person[enemyid].Time+500
			killjq = aa
			end
		end

        if WAR.JGHJ ==100 and nglw(pid,100)>=2 and Curr_NG(pid,100) then
		local reduction2 = math.modf((JY.Person[pid]["内力"]) * 0.2)
		killjq =killjq + reduction2 		
		end
		
		if WAR.YZSP[eid]~=nil then----
		killjq = killjq * 2
		   if WAR.YZSY2[eid]~=nil then
		      if killjq <500 then
			  killjq = 500
			  end
		   end
		end

		if WAR.YZSP[pid]~=nil and WAR.YZSY[pid]~=nil then----
		killjq = math.modf(killjq / 2)
		end

	    if WAR.JGHJ == 105 then
		killjq = killjq * 2
	    end

         if WAR.DSXF == 1 then 
		 
		 killjq = killjq * 2
		 end

		if MPPB_MZ(pid) == 1 and WAR.BJ == 1 then
		killjq = killjq * 2
		end

		if  WAR.JGZB == 2 then----金刚掌刚掌波
		killjq = killjq*2
	    end
		
		if  WAR.JGZB >= 1 then----金刚掌刚掌波
	    WAR.JGZB1 = WAR.JGZB1 + killjq
		    if WAR.JGZB1>= 800 then
		     WAR.JGZB1 = 800
		    end
	    end
		
	if (force_ID(eid) or (eid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0) ) and WAR.TGDQ4 > 0 then
	    local reduction2 = math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"]) * 0.2)+killjq
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", reduction2)
	end	

	if nglw(eid,103)>2 and WAR.TGDQ4 > 0 then
	    local reduction2 = math.modf((JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"]) * 0.2)+killjq
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", reduction2)
	end	
		
if pid == 0 and zylw(4)>0 then
   local aa = JY.Person[pid]["耍刀技巧"]
   killjq = killjq +math.modf(aa/3)
end	

if Curr_QG(eid, 146) then
local reduction2 = killjq*(qglw(eid,146)*0.5)
killjq = -killjq
   if qglw(eid,146)>=1 and JY.Person[eid]["生命"] > 0 then
        if match_ID_awakened(eid,54,1) and JY.Person[54]["品德"] == 80 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -reduction2*2)
		else
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", reduction2)
		end
   end
end

if Curr_QG(pid, 146) then
   if qglw(pid,146)>=1 then
   local reduction2 = killjq * 10
   if reduction2<0 then
   reduction2 = -reduction2
   end
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", reduction2)
   end
end

if Curr_QG(eid, 149) then --梯云纵
   local reduction2 = killjq * 10
   if reduction2<0 then
   reduction2 = -reduction2
   end
   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", reduction2)
   if killjq>= 0 then
   killjq = math.modf(killjq/2)
   else
   killjq = math.modf(killjq*2)
   end
   if qglw(eid, 149) >= 1 then--
   WAR.TYZH[eid] = limitX((WAR.TYZH[eid] or 0) + killjq,0,800)
   end   
end
	
		if wglw(eid,22)>2 and WAR.Actup[eid]~=nil then --刚掌斗气阵 
		 	WAR.JGZB1 = WAR.JGZB1 + killjq
		    if WAR.JGZB1>= 800 then
		     WAR.JGZB1 = 800
		    end
			killjq = 0
	     end	


	

        if wglw(pid,74)>=2 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 1 then
		local aa = math.modf(killjq/3)
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", aa)
		WAR.YZHYZ = WAR.YZHYZ + aa
		end

       if wglw(pid,74)>1 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 3 then
		WAR.TLQJ[eid] = (WAR.TLQJ[eid] or 0) + killjq
		end



        if WAR.SFXW[eid]~=nil then	
		local reduction2 = killjq * 10
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", reduction2)
		killjq = 0
		end
		
		if match_ID_awakened(eid,38,2) and (JLSD(10,60,eid) or WAR.NGHT>0) then----
		local tmpjq=killjq
		killjq=0
		WAR.MJZS[pid] = (WAR.MJZS[pid] or 0) + tmpjq*2
		if WAR.MJZS[pid]~=nil and  WAR.MJZS[pid]>500 then
		WAR.MJZS[pid]=500
		end
		JY.Person[pid]["灼烧程度"]=math.min(JY.Person[eid]["灼烧程度"]+JY.Person[pid]["灼烧程度"],50)
		JY.Person[pid]["冰封程度"]=math.min(JY.Person[eid]["冰封程度"]+JY.Person[pid]["冰封程度"],100)
		JY.Person[pid]["受伤程度"]=math.min(JY.Person[eid]["受伤程度"]+JY.Person[pid]["受伤程度"],100)
		JY.Person[pid]["中毒程度"]=math.min(JY.Person[eid]["中毒程度"]+JY.Person[pid]["中毒程度"],100)
		JY.Person[eid]["灼烧程度"] = 0
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["受伤程度"] = 0
		JY.Person[eid]["中毒程度"] = 0
			if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+明镜止水"
			else
				WAR.Person[enemyid]["特效文字1"] = "明镜止水"
			end
		end

	if (nglw(eid,95)>1) and (JLSD(10,60,eid) or nglw(eid,95)>2)then --蛤蟆九天17-2-23
		if WAR.HMJT[eid] == nil or WAR.HMJT[eid] == 0 then
			WAR.HMJT[eid] = killjq*nglw(eid,95) + 200;
		else
			WAR.HMJT[eid] = WAR.HMJT[eid] + killjq*nglw(eid,95) + 200;
		end
		if  WAR.HMJT[eid] > 5000 then 
		    WAR.HMJT[eid] = 5000 
		end	
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "气吞山河·吞"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"].."+气吞山河·吞"
		end
		killjq = 0
	end

	if WAR.SH[eid] ~= nil or WAR.SH1[eid] ~= nil or WAR.ZBX[eid] ~= nil or WAR.YJZD[eid] ~= nil or WAR.QYC[eid]~=nil then --锁喉/醉八仙/以静制动状态不被杀气--17-2-18
		killjq = 0
	end
		
		if wglw(eid,25)>2 and JLSD(10,60,eid) then----
		local tmpjq=killjq
		killjq=0
		WAR.MJZS[pid] = (WAR.MJZS[pid] or 0) + tmpjq*2
		if WAR.MJZS[pid]~=nil and  WAR.MJZS[pid]>500 then
		WAR.MJZS[pid]=500
		end
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", tmpjq*2);
			if WAR.Person[enemyid]["特效文字0"] ~= nil then
				WAR.Person[enemyid]["特效文字0"] = WAR.Person[enemyid]["特效文字0"] .. "+黯然秘技.心惊肉跳"
			else
				WAR.Person[enemyid]["特效文字0"] = "黯然秘技.心惊肉跳"
			end
		end

		if match_ID_awakened(eid,60,1) and JLSD(10,60,eid) then----
		local tmpjq1 = killjq
		local tmpjq=math.modf(killjq * (1 - (JY.Person[pid]["中毒程度"] / 100)))
		local str = "白驼秘法.蟾酥缠身"
		killjq = tmpjq
		tmpjq1 = tmpjq1 - tmpjq
        WAR.MJZS[pid] = (WAR.MJZS[pid] or 0) + tmpjq1*2
		if WAR.MJZS[pid]~=nil and  WAR.MJZS[pid]>500 then
		WAR.MJZS[pid]=500
		end
		if JY.Person[pid]["中毒程度"] >=50 then----
		WAR.JD_SJSD[pid] = math.modf(JY.Person[pid]["中毒程度"]/2)
        str = "白驼秘法.蛇酥侵神"		
		end
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", tmpjq*2);
        Set_Eff_Text(enemyid, "特效文字1", str)
		end		

		if MPPB_BTHM(eid)>=1 and (JLSD(10,60,eid) or WAR.Defup[eid]~=nil ) then----
		local tmpjq1 = killjq
		local tmpjq=math.modf(killjq * (1 - (JY.Person[pid]["中毒程度"] / 100)))
		local str = "白驼秘传.蟾酥反噬"
		killjq = tmpjq
		tmpjq1 = tmpjq1 - tmpjq
		killjq = killjq  - (WAR.tmp[200 + eid] or 0)
        WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度",  tmpjq1)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", tmpjq1*MPPB_BTHM(eid));
		if MPPB_BTHM(eid)>1 then
		WAR.JD[eid] = (WAR.JD[eid] or 0) + tmpjq1
		   if MPPB_BTHM(eid)>2 then
		    local aa = JY.Person[eid]["灼烧程度"]+ JY.Person[eid]["冰封程度"] + JY.Person[eid]["受伤程度"] + JY.Person[eid]["中毒程度"]
			JY.Person[pid]["灼烧程度"]=math.min(JY.Person[eid]["灼烧程度"]+JY.Person[pid]["灼烧程度"],50)
		    JY.Person[pid]["冰封程度"]=math.min(JY.Person[eid]["冰封程度"]+JY.Person[pid]["冰封程度"],100)
		    JY.Person[pid]["受伤程度"]=math.min(JY.Person[eid]["受伤程度"]+JY.Person[pid]["受伤程度"],100)
		    JY.Person[pid]["中毒程度"]=math.min(JY.Person[eid]["中毒程度"]+JY.Person[pid]["中毒程度"],100)
		    JY.Person[eid]["灼烧程度"] = 0
		    JY.Person[eid]["冰封程度"] = 0
		    JY.Person[eid]["受伤程度"] = 0
		    JY.Person[eid]["中毒程度"] = 0
               if MPPB_BTHM(eid)>3  then
			   local a = (WAR.FXDS[eid] or 0)
			   local b = (WAR.LXZT[eid] or 0)
			   local c = (WAR.MBZ[eid] or 0)
			   local d = (WAR.CHZ[eid] or 0)
               aa = aa + a+b+c+d
               WAR.FXDS[pid] = limitX((WAR.FXDS[pid]  or 0) + (WAR.FXDS[eid] or 0), 0, 50)	
		       WAR.FXXS[pid] = 1
		       WAR.FXDS[eid] = nil
               WAR.CHZ[pid] = limitX((WAR.CHZ[pid]  or 0) + (WAR.CHZ[eid] or 0), 0, 100)		
		       WAR.CHXS[pid] = 1
		       WAR.CHZ[eid] = nil
               WAR.MBZ[pid] = limitX((WAR.MBZ[pid]  or 0) + (WAR.MBZ[eid] or 0), 0, 100)		
		       WAR.MBXS[pid] = 1
		       WAR.MBZ[eid] = nil
	           WAR.LXZT[pid] = limitX((WAR.LXZT[pid] or 0) + (WAR.LXZT[eid] or 0) , 0, 100)
		       WAR.LXXS[pid] = 1
		       WAR.LXZT[eid] = nil
               end			   
		    WAR.JD[eid] = (WAR.JD[eid] or 0) + aa
		   end
		end
        Set_Eff_Text(enemyid, "特效文字1", str)
		end
		
		if wglw(eid,127)>2 then----
		 if JLSD(10,60,eid) then
		    local str="秘孔"
			local aa=math.random(1,5)
			local YZQS={".定神",".刹活",".心灵台",".健明",".百会"}
			str=str..YZQS[aa]
			if aa==1 then
		   addeffect2(WAR.MK_DS,eid,30)
		   elseif aa==2 then
		   addeffect2(WAR.MK_SH,eid,30)
		   elseif aa==3 then
		   addeffect2(WAR.MK_XLT,eid,30)
		   elseif aa==4 then
		   addeffect2(WAR.MK_JM,eid,30) 
		   else 
		   addeffect2(WAR.MK_BH,eid,30)
		   end
		Set_Eff_Text(enemyid,"特效文字0",str)
		WAR.Person[enemyid]["特效动画"] = 87+aa	
        end		
		end

 	if MPPD(eid) == 2 and MPDJ(eid) >= 2 then --武当无极
		if WAR.WJ[eid] == nil then
			WAR.WJ[eid] = math.abs(killjq)
		else
		   if MPZJ(eid,2)>1 then
		       WAR.WJ[eid] = WAR.WJ[eid] + math.abs(killjq) * MPZJ(eid,2)
			   if WAR.WJ[eid] >= 200*MPZJ(eid,2) then
			   WAR.WJ[eid] = 200*MPZJ(eid,2)
			   end
		   else
			if WAR.WJ[eid] < math.abs(killjq) then
				WAR.WJ[eid] = math.abs(killjq)
			end
		   end
		end
	end
	
	if Curr_QG(eid,148) then
		killjq = killjq- 100 * Tianluo(eid)
			if killjq< 0then
				killjq = 0
			end
	end


	if Curr_NG(eid, 166) and nglw(eid,166)>=1 then -- 天池心法1阶
        local aa =killjq
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -aa)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", math.modf(aa/2))
		if WAR.NGHT> 0 and JY.Person[eid]["生命"] > 0 then
		local bb = math.modf(aa/3)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -bb)
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", bb)
		end
		if WAR.Person[enemyid]["特效文字2"] == nil then
			WAR.Person[enemyid]["特效文字2"] = "吸功奥义"
		else
			WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+" .. "吸功奥义"
		end
	end
	
	if WAR.L_TJQ == 2 then
	local aa = math.modf(WAR.tmp[3000 + pid]/10)
	killjq = killjq + aa
	WAR.XRZT[eid] = math.modf(aa/5)
	end
	
		if WAR.LXYZ == 1 and zylw(2)>2 and pid == 0 then--
		   	local fxz = math.modf(killjq/10)
			local fxz2 = 0
			if WAR.FXDS[eid] == nil then
				WAR.FXDS[eid] = fxz
			else
				WAR.FXDS[eid] = WAR.FXDS[eid] + fxz
			end
			if WAR.FXDS[eid]>50 then--
			   fxz2=WAR.FXDS[eid]-50
			   WAR.FXDS[eid] =50
			end
			WAR.FXXS[eid] = 1
			fxz2 = -(fxz2*15)
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", fxz2);
		end
  
			if nglw(pid,178)>=1 and WAR.Actup[pid]~=nil then
		   	local fxz = -killjq
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", fxz)
			end
  
			if nglw(eid,178)>=2 and Curr_NG(eid,178) then
			local reduction2 = killjq * 10
		    WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", reduction2)
			local fxz = math.modf(killjq/100)
            WAR.BDKY[eid] = (WAR.BDKY[eid] or 0) + fxz
			   if  WAR.BDKY[eid]>=5*nglw(eid,178)  then
			       WAR.BDKY[eid] = 5*nglw(eid,178)
			   end
			end
 
        if WAR.JGHJ ==100 and nglw(pid,100)>=2 and Curr_NG(pid,100) then
		local reduction2 = math.abs(killjq * 10)
        WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", reduction2)	
        WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", killjq/5)			
		end
 
		local kfkind = JY.Wugong[wugong]["武功类型"] 
		if zylw(3)>0 and pid == 0 and kfkind ==  3 then--
		   	local lxz = math.modf(math.abs(killjq)/20)
			if WAR.LXZT[eid] == nil then
				WAR.LXZT[eid] = lxz
			else
				WAR.LXZT[eid] = WAR.LXZT[eid] + lxz
			end
			if WAR.LXZT[eid]>50 then--
			   WAR.LXZT[eid] =50
			end
			WAR.LXXS[eid] = 1
		end

	if WAR.TZQJ == 8 and kfkind == 6 then
	    killjq = killjq * 3
		if killjq< 100 then
		killjq =  100
		end
	end	

	 if WAR.JYBG == 1 and wglw(pid,11)>= 3 then
		local reduction2 = math.abs(killjq) * 10
        WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", reduction2)	
		WAR.GTJIQI = WAR.GTJIQI + killjq
		WAR.GTPID = pid
	 end

		if nglw(eid,107)>=2 and Curr_NG(eid,107) then
		   if WAR.JYZQ[eid]~=nil and WAR.JYZQ[eid]>0 and JY.Person[eid]["生命"] > 0 then
		   WAR.JYZQ[eid] = WAR.JYZQ[eid] - 1
		      if WAR.JYZQ[eid]<1 then
			  WAR.JYZQ[eid] = 0
			  end
		   local reduction2=math.abs(killjq)
           WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", reduction2)	
           killjq = 0
			if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+九阴.飞絮劲"
			else
				WAR.Person[enemyid]["特效文字1"] = "九阴.飞絮劲"
			end		   
		   end
		end

		if nglw(eid,104)>=2 then
		   local h = 0
		   if WAR.NYZQ[eid]~=nil and WAR.NYZQ[eid]>0 then
		   WAR.NYZQ[eid] = WAR.NYZQ[eid] - 1
		      if WAR.NYZQ[eid]<1 then
			  WAR.NYZQ[eid] = 0
			  end
			  h = 1
		   elseif JY.Person[eid]["内力"]>=500 then
		      WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -500)
		      h=1
		   end
		   if  h == 1 then          	
           killjq = killjq - 500
			if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+逆运.洪流内息"
			else
				WAR.Person[enemyid]["特效文字1"] = "逆运.洪流内息"
			end		   
		   end
		end

		if PersonKF(eid, 101) then
		   if nglw(eid,101)>=1 and JY.Person[eid]["生命"] > 0 then
		     local aa = math.abs(killjq - yskill)
			 killjq = 0
			 WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa)	
		   end
		end
	
	if WAR.ASKD2 == 6 and killjq>0	then
		 WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -killjq)
	end	

	if WAR.SH[eid] ~= nil or WAR.SH1[eid] ~= nil or WAR.ZBX[eid] ~= nil or WAR.YJZD[eid] ~= nil or WAR.QYC[eid]~=nil then --锁喉/醉八仙/以静制动状态不被杀气--17-2-18
		killjq = 0
	end
	
	if wglw(eid,49)>2 and WAR.QXJQ[eid]~=nil then
	   local aa = WAR.QXJQ[eid]	   
	   WAR.Person[WAR.CurID]["伤害爆裂"] = (WAR.Person[WAR.CurID]["伤害爆裂"] or 0) + math.modf(0.25*aa*killjq) 
	   killjq = 0
	   WAR.Person[enemyid]["特效文字1"] = "六气合一心法"
	end

					if  nglw(eid,144)>= 2 and hurt<30+nglw(eid,144)*20 and DWPD() then----
					 killjq=-150*nglw(eid,144)
					   if nglw(eid,144)>2 then
		        		local reduction = math.modf(JY.Person[eid]["内力最大值"] * 0.1)
						local reduction2 = JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"]
                        if reduction>=reduction2 then
						local reduction3=math.modf((reduction-reduction2)*0.1)
		                JY.Person[eid]["内力"]=JY.Person[eid]["内力最大值"]
						JY.Person[eid]["生命"]=JY.Person[eid]["生命"]+reduction3
						else
		                AddPersonAttrib(eid, "内力", reduction)
						end
						end
		        end
	
		--太玄之轻，把被杀的集气转为自己的集气值
		if WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] >= 1 then
			WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + math.abs(killjq);
			if WAR.TXZQ[eid] >= 2 then
			WAR.MJZS[pid] = (WAR.MJZS[pid] or 0) + math.abs(killjq);
			   if match_ID(eid,40)  then
			    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", killjq)
			    end
			end
			if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+太玄之轻"
			else
				WAR.Person[enemyid]["特效文字1"] = "太玄之轻"
			end
		else
			WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - killjq;
		end

		--文泰来否极泰来，被杀至0集气以下时，立即行动并清除封穴,且进入幸运状态
if match_ID(eid,151) then
if WAR.Person[enemyid].TimeAdd<0 then
WAR.Person[enemyid].TimeAdd=999
WAR.FXDS[eid]=0
WAR.WTL=1
WAR.LUCK[eid]=50
Set_Eff_Text(enemyid,"特效文字2","否极泰来")
end
end		

if WAR.TZQJ == 8 and kfkind == 6 then
if WAR.Person[enemyid].TimeAdd<0  then
local fxz = math.modf((killjq-WAR.Person[enemyid].TimeAdd)/5)
   WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", -fxz);
end
end	



if pid == 0 and zylw(4)>1 then
   local fxz = math.modf(killjq/5)
   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid, "生命", fxz);
end	



else
				if JY.Person[eid]["体力"]>=90 and nglw(eid,90)>1 and Curr_NG(eid,90) then
                WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", hurt);
				Set_Eff_Text(enemyid,"特效文字2","天罡混元.心体合一")
				end
				if Curr_NG(eid, 166) and nglw(eid,166)>=1 and JY.Person[eid]["生命"] > 0 then -- 天池心法1阶
                WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0)+AddPersonAttrib(eid, "生命", 50*nglw(eid,166));
				Set_Eff_Text(enemyid,"特效文字2","天池.不坏红花")   
	            end
				if Curr_NG(eid, 144) and nglw(eid,144)>= 1 and hurt<30+nglw(eid,144)*20 and DWPD() then----
					 local killjq=-150*nglw(eid,144)
					   if nglw(eid,144)>2 then
		        		local reduction = math.modf(JY.Person[eid]["内力最大值"] * 0.1)
						local reduction2 = JY.Person[eid]["内力最大值"]-JY.Person[eid]["内力"]
                        if reduction>=reduction2 then
						local reduction3=math.modf((reduction-reduction2)*0.1)
		                JY.Person[eid]["内力"]=JY.Person[eid]["内力最大值"]
						JY.Person[eid]["生命"]=JY.Person[eid]["生命"]+reduction3
						else
		                AddPersonAttrib(eid, "内力", reduction)
						end
						end
		        end
	end
  
	--小龙女死掉，杨过吼
	if match_ID(eid, 59) and JY.Person[eid]["生命"] <= 0 then
		WAR.XK = 1
		WAR.XK2 = WAR.Person[enemyid]["我方"]
	end
	  

	
	--欧阳克攻击附加毒
    local sd = 0
	if MPPD(pid) == 7 then
	sd = 1
	end
	if match_ID_awakened(pid, 61,1) then
	sd = 1
	end
    if match_ID(pid, 60) then
	sd =1
	end

	if sd == 1 and DWPD() then
	    local aa= math.random(1,(1+MPDJ(pid)))*10
		if match_ID(pid, 60) then
		aa = 30
		end
		if match_ID_awakened(pid, 61,1) then
	    aa= math.random(1,3)*10	
	    end		
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", aa)
		if MPPB_BTLS(pid)>=1 and (WAR.ACT==1 and JLSD(10,70,pid))then
	    local NS=math.modf(JY.Person[eid]["中毒程度"]*0.75)
		local XK=math.modf(JY.Person[eid]["中毒程度"]*4)
		local str = "白驼.灵蛇化毒"	
			if MPPB_BTLS(pid)>=3 then
			   XK = XK + (WAR.JD[pid] or 0)*3
			   NS = NS + (WAR.JD[pid] or 0)
			   if WAR.RXSD[eid]~=nil then
			   local aa = WAR.RXSD[eid]
			   WAR.QSLZ[eid] = (WAR.QSLZ[eid] or 0) + aa
			   XK = XK + aa * 5
			   WAR.RXSD[eid] = nil
			   end
			   if WAR.L_WNGZL2[eid]~=nil then
			   local aa = WAR.L_WNGZL2[eid]
			   WAR.QSLZ[eid] = (WAR.QSLZ[eid] or 0) + aa
			   XK = XK + aa * 5
			   WAR.L_WNGZL2[eid] = nil
			   end
		       WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -XK)
			   WAR.XRZT[eid] = (WAR.XRZT[eid] or 0) + NS
			   str = "白驼.凶蛇噬天"
		    end
		local NK=-NS
		WAR.Person[WAR.CurID]["内伤点数"]=(WAR.Person[WAR.CurID]["内伤点数"] or 0) +AddPersonAttrib(pid, "受伤程度", NK);
		WAR.Person[WAR.CurID]["生命点数"]=(WAR.Person[WAR.CurID]["生命点数"] or 0) +AddPersonAttrib(pid, "生命", XK);
	    Set_Eff_Text(enemyid,"特效文字2",str)
	    WAR.Person[enemyid]["特效动画"] = 112
	   end
		if match_ID_awakened(pid, 60,1) and (WAR.ACT==1 and JLSD(10,70,pid))then
	    local NS=math.modf(JY.Person[eid]["中毒程度"]*2)
		local XK=NS*2
		local NK=-NS
		WAR.Person[WAR.CurID]["生命点数"]=(WAR.Person[WAR.CurID]["生命点数"] or 0) +AddPersonAttrib(pid, "生命", XK);
		WAR.Person[WAR.CurID]["内伤点数"]=(WAR.Person[WAR.CurID]["内伤点数"] or 0) +AddPersonAttrib(pid, "受伤程度", NK);
	    Set_Eff_Text(enemyid,"特效文字2","白驼化毒")
	    WAR.Person[enemyid]["特效动画"] = 112
	   end	   
	end	

	if wglw(pid, 74)>=1 and WAR.SHJG[pid] ~=nil and WAR.SHJG[pid]==1 and WAR.BJ==1 and DWPD() then
	    local aa= math.random(1,3)*10
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", aa)
	end	
	
	--西毒蛇杖
	if JY.Person[pid]["武器"] == 244 and DWPD() then
		local sz = 10 + 5 * (JY.Thing[244]["装备等级"]-1)
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", sz)
	end
	
	--赤练神掌，强制上毒20
	if WAR.WD_CLSZ == 1 then
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 20)
		
		    if wglw(pid,3)>=2 then
		      if  WAR.JCGD[eid] ~= nil and WAR.JJGD[eid] == nil then
		   	      WAR.JJGD[eid] = math.random(1,3+wglw(pid,3))	
                  Set_Eff_Text(enemyid, "特效文字0", "五毒.蛊转")				  
		      end
		   end
		if wglw(pid,3)>=1 then
		   if JY.Person[eid]["中毒程度"]>= 50 and WAR.JCGD[eid] == nil  and WAR.JJGD[eid] == nil then
		      WAR.JCGD[eid] = 50
			  Set_Eff_Text(enemyid, "特效文字0", "五毒.蛊卵寄生")
		   end
		end
	end
	
	--无酒不欢：优化钟灵闪电貂偷东西
	if WAR.TD == -2 then
		for i = 1, 4 do
			if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] and DWPD() then
				WAR.TD = JY.Person[eid]["携带物品" .. i]
				WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
				JY.Person[eid]["携带物品数量" .. i] = 0
				JY.Person[eid]["携带物品" .. i] = -1
				break
			end
		end
	else
		WAR.TD = -1
	end

	--血刀吸血，1级5%，6级10%
	--上限100点,天外则增加
	if WAR.XDDF == 1 and DWPD() then
	local leech_rate = 0
	 if wglw(pid,63)>=1 then
		local mpdj = wglw(pid,63)*2+3 
		   if Curr_NG(pid, 163) then
		   local js=1
		   if nglw(pid,163)>=1 then----
		   js=js+nglw(pid,163)
		   end
		   mpdj=mpdj+js
	       end		
		   if WAR.LXZT[eid]~=nil and WAR.LXZT[eid]>0 then
		   mpdj=mpdj*(1+WAR.LXZT[eid]*0.1)
		   end
		   if MPPB_MZ(pid) == 3 then 
		        mpdj = MPDJ(pid)*2+3+mpdj
		   		if match_ID(pid, 37) then
		        mpdj = mpdj+ 3
		        end
		   end
		   if  JY.Person[pid]["武器"] == 44 then
		   mpdj=mpdj*(1+0.1*(JY.Thing[44]["装备等级"]-1))
		   end
		   if  WAR.XUEFU[pid]~=nil and WAR.XUEFU[pid]>=0 then
		   mpdj=mpdj*(1+WAR.XUEFU[pid]*0.2)
		   end
	    leech_rate = 0.05 + 0.01*mpdj	   
		  if WAR.XDLeech < 100*(wglw(pid,63)+1) then
			WAR.XDLeech = WAR.XDLeech + limitX(math.modf((hurt) * leech_rate),0,100*(wglw(pid,63)+1))
			if WAR.XDLeech > 100*(wglw(pid,63)+1) then
				WAR.XDLeech = 100*(wglw(pid,63)+1)
			end
		  end
		if WAR.XUEFU[pid]==nil then
        WAR.XUEFU[pid] = math.random(2,3)
        else
        WAR.XUEFU[pid] = WAR.XUEFU[pid] +math.random(2,3)
        end				
		if 	WAR.XUEFU[pid]>=15 then
		WAR.XUEFU[pid]=15
		end
	elseif MPPB_MZ(pid) == 3 or WAR.XDLZ2[pid]~=nil then
	    local mpdj = MPDJ(pid)*2+3
		if match_ID(pid, 37) then
		mpdj = mpdj+ 3
		end
		if WAR.LXZT[eid]~=nil and WAR.LXZT[eid]>0 then
		   mpdj=mpdj*(1+WAR.LXZT[eid]*0.1)
		   end
		   if  JY.Person[pid]["武器"] == 44 then
		   mpdj=mpdj*(1+0.1*(JY.Thing[44]["装备等级"]-1))
		   end
		   if WAR.XDLZ2[pid]~=nil then
		   mpdj=mpdj*(1+(WAR.LXZT[pid] or 0)*0.1)
		   end
	    leech_rate = 0.05 + 0.01*mpdj	   
		  if WAR.XDLeech < 100*(wglw(pid,63)+1) then
			WAR.XDLeech = WAR.XDLeech + limitX(math.modf((hurt) * leech_rate),0,100*(wglw(pid,63)+1))
			if WAR.XDLeech > 100*(wglw(pid,63)+1) then
				WAR.XDLeech = 100*(wglw(pid,63)+1)
			end
		  end
	else
         if WAR.XDLeech < 100 then
		 	leech_rate = 0.05 + 0.01*(JY.Thing[44]["装备等级"]-1)
			WAR.XDLeech = WAR.XDLeech + limitX(math.modf((hurt) * leech_rate),0,100)
			if WAR.XDLeech > 100 then
				WAR.XDLeech = 100
			end
         end			
	end
	if wglw(pid,67)>2 and JY.Person[pid]["武器"] == 44 then
	WAR.XDLeech =WAR.XDLeech * math.random(2,3)
	end
end
	
	--韦一笑吸血10%，上限100点
	if match_ID(pid, 14) and DWPD() then
		if WAR.WYXLeech < 100 then
			WAR.WYXLeech = WAR.WYXLeech + limitX(math.modf((hurt) * 0.1),0,100)
			if WAR.WYXLeech > 100 then
				WAR.WYXLeech = 100
			end
		end
	end
	
	if WAR.HSDF_DF1==1 and DWPD()  then
			WAR.WYXLeech = WAR.WYXLeech + math.modf((hurt) * 0.1)
			if WAR.LXZT[eid]~=nil then
				WAR.WYXLeech = WAR.WYXLeech + math.modf((hurt) * 0.05)
			end
	end
	
	--天魔功吸血20%
	if Curr_NG(pid, 160) and DWPD() then
		WAR.TMGLeech = WAR.TMGLeech + math.modf(hurt * 0.2)
	end

    if T7DFWM(pid) and WAR.DFWM2 == 4 then --东方未明刀系特技吸血
       WAR.DFWMXX = WAR.DFWMXX + math.modf((hurt) * 0.15)	  
     end
	
	--天山童姥 被攻击后生命+80
	if match_ID(eid, 117) and 0 < JY.Person[eid]["生命"] then
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", 80);
	end
	  
	--宫本武藏 被攻击后生命+150
	if match_ID(eid, 516) and 0 < JY.Person[eid]["生命"] then
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", 150);
	end
	  
	--霍青桐 杀体力
	if WAR.HQT == 1 and DWPD() then
	    local aa = math.random(7,8)
		WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -aa);
		if match_ID_awakened(pid,74,1) then
		local bb = 20*aa
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", bb)
		end
	end
	    
	--程英 杀内力
	if WAR.CY == 1 and DWPD() then
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -300);
	end
 
 	if WAR.LM_JQ1 == 4 and DWPD() then
	    local d = math.modf((JY.Person[eid]["内力"] ) / 10)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid,"内力", -d)
	end
 
 	if WAR.HSDF_DF1==3 and DWPD()  then
       WAR.XRZT[eid] = (WAR.XRZT[eid] or 0) + 10
			if WAR.MBZ[eid]~=nil then
			WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -300);
			end
	end
 
 
 	if WAR.CHD == 4 and match_ID_awakened(pid,103,1) and DWPD() then --残火刀初式
		local aa=(JY.Person[eid]["灼烧程度"]+JY.Person[eid]["受伤程度"])*3
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa);
	end
 
  	if WAR.YKX >= 1 and DWPD() then  --黄沙万里鞭
		local aa = math.modf((WAR.SHAH[pid] or 0) / 20)
		local bb = math.modf((WAR.SHAH[pid] or 0) / 200)
		WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -bb);
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa);
		WAR.SHAH[pid] = limitX((WAR.SHAH[pid] or 0) + aa,0,10000)
	end
 
  	if WAR.LMZL == 1 and match_ID_awakened(pid,65,1) and DWPD() then --一灯燃火指
		local aa=(JY.Person[eid]["灼烧程度"]+(WAR.FXDS[eid] or 0))
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa*5);
		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa)
	end
 
  	if WAR.CHD == 3 and match_ID_awakened(pid,103,1) and DWPD() then --残火刀二式
		local aa=math.modf((JY.Person[eid]["灼烧程度"]+JY.Person[eid]["受伤程度"])*0.25)
		WAR.MENG[eid] = aa;
	end
	
 	if WAR.CHD == 2 and match_ID_awakened(pid,103,1) and DWPD() then --残火刀三式
		local aa=math.modf((JY.Person[eid]["灼烧程度"]+JY.Person[eid]["受伤程度"])*0.25)
		WAR.ICE[eid] = aa;
		WAR.BFXS[eid] = 1
		JY.Person[eid]["冰封程度"]=JY.Person[eid]["灼烧程度"]
	end
 

 
	if WAR.FHJ == 1 and DWPD() then
	    local aa=JY.Person[eid]["灼烧程度"]*5
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa);
	end

	--进阶万岳，杀内力
	if ((wugong == 33 and nglw(pid, 89)>=1) or WAR.L_WYJFA4 == 2) and DWPD() then
		local neiliLoss = hurt
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -neiliLoss);
	end
	
	--阎基偷钱
	if eid ~= 591 and eid < 578 and eid ~= 64 and WAR.ZDDH ~= 17 and match_ID(pid, 4) and JY.Person[eid]["生命"] <= 0 and inteam(pid) and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and not inteam(eid) then
		WAR.YJ = WAR.YJ + math.random(15) + 25
	end
  
	--田归农与阎基的加成，中毒+5 + 随机15
	if match_ID(pid, 72) then
		for j = 0, WAR.PersonNum - 1 do
		  if WAR.Person[j]["人物编号"] == 4 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			WAR.Person[enemyid]["中毒点数"] = AddPersonAttrib(eid, "中毒程度", JY.Person[eid]["中毒程度"] + 5 + math.random(15));
		  end
		end
	end


	
if wglw(pid,40)>2 and WAR.JSKW == 1 and DWPD() then
   WAR.L_WNGZL[eid]=   (WAR.L_WNGZL[eid] or 0) + 20
   WAR.BPYZ[eid] = 20
end
	
if match_ID_awakened(pid, 54, 1)  and JY.Person[54]["品德"] == 90 and WAR.JSAY >= 1 and DWPD() then
   WAR.QSLZ[eid]=  (WAR.QSLZ[eid] or 0) + 20
   if JY.Person[54]["论剑奖励"] == 1 then
   WAR.L_WNGZL[eid]=   (WAR.L_WNGZL[eid] or 0) + 20
   WAR.RXSD[eid] = 20
   end
   if JY.Person[54]["论剑奖励"] == 2 then
   		WAR.QBLY[eid] =  (WAR.QBLY[eid] or 0) + 10
		WAR.XRZT[eid] =  (WAR.XRZT[eid] or 0) + 10
   end
end

	--辟邪刺目，100%MISS
	if WAR.KHBX == 2 and 0 < hurt and DWPD() then
		WAR.KHCM[eid] = 2
	end
  
	--宫本宝藏 秒杀
	if WAR.GBWZ == 1 and math.random(10) < 6 and DWPD() then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
	end
  
  	if WAR.GBWZ3 == 1  and DWPD() then
		if JY.Person[eid]["生命"] <= math.modf(JY.Person[eid]["生命最大值"]*0.5) and math.random(10) < 6 then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
		end
	end

  	if WAR.YKX1 >= 1  and DWPD() then
		if WAR.SHAH2[eid]~=nil and WAR.SHAH2[eid]>=3000  and math.random(6000) <= WAR.SHAH2[eid] then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
	    Set_Eff_Text(enemyid,"特效文字0","终结技【砂缚柩】")
	    WAR.Person[enemyid]["特效动画"] = 42
		end
	end
  
	--无酒不欢：一些高封穴的人物
	local gfxp = {114, 26, 129, 65, 18, 39, 70, 98, 57, 185}
	for g = 1, 10 do
		if match_ID(pid, gfxp[g]) and JLSD(30, 70, pid) then
			WAR.BFX = 1
		end
	end
  
	--拳主大招，高几率封穴
	if WAR.LXZQ == 1 and JLSD(25, 75, pid) then
		WAR.BFX = 1
	end
	
		if match_ID_awakened(pid,65,1) and WAR.LMZL>0  then
	WAR.BFX = 1
	end
	
	--琴棋书画之倚天屠龙功，必封穴
	if WAR.QQSH3 == 1 or  WAR.L_WYJFA1 >= 1 then
		WAR.BFX = 1
	end
	
	--奇门主角大招，必封穴
	if WAR.GCTJ == 1 then
		WAR.BFX = 1
	end
	
	--一阳指50%几率封穴，优先判定
	if wugong == 17 and (JLSD(30,80,pid) or wglw(pid,17)>0)  then
		WAR.BFX = 1
	end

	if match_ID_awakened(pid,129,1) and JLSD(20,90,pid) then----
	   WAR.BFX = 1
	end
	
	if wugong == 18 and wglw(pid,18)>2 and WAR.TZWY==1 then
		WAR.BFX = 1
	end
	
	--拳法指法45%几率封穴
	if (WGLX == 1 or WGLX == 2) and JLSD(30, 75, pid) then
		WAR.BFX = 1
	end

	if WGLX == 2 and (JLSD(10,80+wglw(pid,127)*10,pid) and wglw(pid,127)>=1)  then
		WAR.BFX = 1
	end	
	
		if  WAR.JGHJ == 121 then---铁指寸劲
		   WAR.BFX = 1
		end
	
	--毒王大招必封穴
	if WAR.YTML == 1 then
		WAR.BFX = 1
	end	

   if wglw(pid, 49)>=1 and WAR.LMZS == 6 and DWPD() then
      WAR.BFX = 1
   end

if match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 2 and WGLX == 2 then
    WAR.BFX = 1
end

	if wglw(pid,63)>1 and WAR.XDDF2==1 then
        WAR.BFX = 1
    end	

		if WAR.DGXF == 4 then
		WAR.BFX = 1
		end
	
	--指法主角，初始15%封穴率，每个指法+5%
	if JY.Base["标准"] == 2 and pid == 0 then
		local lxyz = 15
		for i = 1, CC.Kungfunum do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 2 and JY.Person[0]["武功等级" .. i] == 999 then
				lxyz = lxyz + 5
			end
		end
		if lxyz > 50 then
			lxyz = 50
		end
		if JLSD(30, 30 + lxyz, pid) then
			WAR.BFX = 1
		end
	end
	

	
	if JLSD(30, 60, pid) then
	WAR.BFX = 1
	end

	if WAR.ASKD2 == 2 then
	WAR.BFX = 1
	end

	if Curr_NG(eid, 104) then
	WAR.BFX = 0
	end
	
	if MPPD(eid) == 7 and JLSD(10, 40+10*MPDJ(eid), eid) then
	WAR.BFX = 0
	end
	
	--主运逆运免疫封穴，伤害小于50无封穴，拳法指法额外封穴，一阳指高封穴，其他30%几率封穴
	if   DWPD() and (50 <= hurt) and WAR.BFX == 1  then	
		--无酒不欢：使用分段函数
		local fxz = 1;
		if hurt >= 50 and hurt < 100 then
			fxz = fxz + math.modf((hurt - 50)/10)
		elseif hurt >= 100 and hurt <= 200 then
			fxz = math.modf((hurt - 50)/10) + math.random(3)
		elseif hurt > 200 then
			fxz = math.modf(hurt/15) + 5 + math.random(3)
		end
		if wglw(pid,18)>2 and WAR.TZWY>0 then
		   fxz=fxz+WAR.TZNQ
		end

if match_ID_awakened(pid,28,1) and WAR.PYZ>0 then
    fxz=fxz+WAR.PYZ*10
end

				if match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 2 and JLSD(10,60,pid) then
				   local aa=math.modf((JY.Person[pid]["医疗能力"])/100)
                         fxz=fxz+aa
				end
		
		if  WAR.JGHJ == 121 then---铁指寸劲
		   fxz=fxz+math.modf(ang/50)
		end

		if match_ID_awakened(pid,65,1) and WAR.LMZL>0  then
	       fxz=fxz+math.modf(ang/50) + (7-WAR.LMZL)*5
	    end		
	
		if WGLX == 2 and wglw(pid,127)>=1  then
		   local aa=math.modf((JY.Person[pid]["内力"])/500)
		   if aa<2 then
		   aa=2
		   end
		   fxz=fxz+math.random(3,5)+aa
		   fxz=math.modf(fxz *1.5)
	    end	
		
		if match_ID_awakened(pid,129,1) then----王重阳一阳指气劲
		    local aa=math.modf((JY.Person[pid]["内力"]-JY.Person[eid]["内力"])/300)
		   if aa<2 then
		   aa=2
		   end
		fxz=fxz+math.random(3,5)+aa
		end

		if wugong == 17 and wglw(pid,17)>=1 then----一阳指劲
		local aa=math.modf((JY.Person[pid]["内力"]-JY.Person[eid]["内力"])/300)
		   if aa<2 then
		   aa=2
		   end
		fxz=fxz+math.random(3,5)+aa
	    end
		
			if WGLX == 2 and pid == 0 and zylw(2)>0  then
		       fxz = fxz*2
	        end		
		
		if wglw(pid,63)>1 and WAR.XDDF2==1 then
           if WAR.LXZT[pid]~=nil and  WAR.LXZT[pid]>0 then
	          local aa= WAR.LXZT[pid]
	          fxz=fxz+aa
	       else
              fxz=fxz+5
	       end
       end
	   
	   if WAR.DFWM2 == 2 then--
	   fxz = 0
	   end
	   
	   if wglw(pid,126)>=1 and WGLX == 2  then
	   fxz = fxz *2   
	   end
		--所有人封穴减半
		fxz = math.modf(fxz *0.5)
		--阴阳倒乱刃天外受封穴减半
		if wglw(eid,77)>=1 then
			fxz = math.modf(fxz *0.5)
		end
		--圣火受封穴减半
		if Curr_NG(eid, 93) then
			fxz = math.modf(fxz *0.5)
		end
		if match_ID(eid, 40) then
			fxz = math.modf(fxz *0.5)
		end
		--乾坤受封穴减半
		if Curr_NG(eid, 97) then
			fxz = math.modf(fxz *0.5)
		end
		--逆运被动受封穴减半
		if PersonKF(eid, 104) then
			fxz = math.modf(fxz *0.5)
		end
		--九阳被动受封穴*0.8
		if PersonKF(eid, 106) then
			fxz = math.modf(fxz *0.8)
		end
		--装备金丝背心，1级封穴-5，6级封穴-10
		if JY.Person[eid]["防具"] == 60 then
			fxz = fxz - 5 - 1*(JY.Thing[60]["装备等级"]-1)
			if fxz < 0 then
				fxz = 0
			end
		end


	if WAR.LGQJ == 1 then
	WAR.DEFUP[eid] = (WAR.DEFUP[eid] or 0) + fxz
	fxz = 0
	end	
		
		--文泰来否极泰来，被杀气到0以下时清除封穴
if match_ID(eid,151) and WAR.WTL==1 then
fxz=0
WAR.WTL=0
end
		
		
		
		if fxz > 0 then
			--玩家和NPC一样待遇
			if WAR.FXDS[eid] == nil then
				WAR.FXDS[eid] = fxz
			else
				WAR.FXDS[eid] = WAR.FXDS[eid] + fxz
			   if wugong == 17 and wglw(pid,17)>=2  then
			   	   local aa=math.modf(fxz/4)+math.random(1,2)
                   WAR.SDFX[eid] = (WAR.SDFX[eid] or 0) + aa
                   addeffect2(WAR.RMZT,eid,1)
				   if WAR.RMZT[eid] <= (wglw(pid,17)-1)*5 then--
				   WAR.RMZT[eid] = (wglw(pid,17)-1)*5
				   end
	               Set_Eff_Text(enemyid, "特效文字1", "燃灯一灭")
	               WAR.Person[enemyid]["特效动画"] = 45
	           end		   
			end
			WAR.FXXS[eid] = 1

			--封穴上限50点
			if 30 < WAR.FXDS[eid] then
			   if WAR.ASKD2 == 2 then
	              WAR.BZ[eid] = 1
	           end
			end
			
			if 50 < WAR.FXDS[eid] then
				WAR.FXDS[eid] = 50
				if wglw(pid,126)>=1 and WGLX == 2 then
				WAR.MBZ[eid] = (WAR.MBZ[eid] or 0) + fxz
				   if WAR.MBZ[eid]>=100  then
				   WAR.MBZ[eid] = 100				
				   end
				WAR.MBXS[eid] = 1
				end
			end

			if WGLX == 2 and wglw(pid,127)>=1  then
		       local str=""
	            if WAR.MKDS[eid] == nil or (WAR.MKDS[eid] ~= nil and WAR.MKDS[eid] < 7) then
		           local str="秘孔"
                   addeffect2(WAR.MKDS,eid,1)
	               Set_Eff_Text(enemyid, "特效文字0", str)
	               WAR.Person[enemyid]["特效动画"] = 145
	            end
				if match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 2 and JLSD(10,60,pid) then
				   local aa = WAR.FXDS[eid]
				   WAR.FXDS[eid] = 1
				   local bb = limitX(math.modf(aa/7),1,7)
				   if WAR.MKDS[eid] >= 7 then
				   WAR.MK_CH[eid] = 1
				   end
				   Set_Eff_Text(enemyid, "特效文字0", "爆死一指")
				   addeffect2(WAR.MKDS,eid,bb)
				end
	        end	
		end
		

		
	end
  
  
	WAR.BFX = 0
	
	--无酒不欢：一些高流血的人物
	local glxp = {6, 3, 40, 97, 103, 19, 60, 71, 189}
	for g = 1, 9 do
		if match_ID(pid, glxp[g]) and JLSD(30, 70, pid) and DWPD() then
			WAR.BLX = 1
		end
	end
	if  wglw(pid,67)>0 and PersonKF(pid,67) and JY.Person[pid]["内力性质"] == 2 and wugong== 67 and JLSD(10, 70, pid) then
	WAR.BLX = 1
	end
    if match_ID_awakened(pid,54,1) and JY.Person[54]["论剑奖励"] == 1 and yongjian(wugong) then
	   WAR.BLX = 1
	end		

    if (WAR.HDMC == 3 or  WAR.HDMC2 == 3) and DWPD() then
      WAR.BLX = 1   
	end
	
	if (WGLX == 2 ) and wglw(pid,134)>=1 and JLSD(20, 95, pid) and DWPD() then
		WAR.BLX = 1
	end
	
	--倚天剑，必流血
	--1级70%几率流血
	--4级开始追加灼烧
	if JY.Person[pid]["武器"] == 37 and DWPD() then
		if JLSD(0, 60 + JY.Thing[37]["装备等级"] * 10, pid)  then
			WAR.BLX = 1
		end
	end
	
	--田归农装备闯王军刀，必流血
	if JY.Person[pid]["武器"] == 202 and (match_ID(pid, 72) or wglw(pid,72)>2) and DWPD() then
		WAR.BLX = 1
	end
	
	if WAR.YZSF[eid]~=nil and DWPD() then
		WAR.BLX = 1
	end
	
	--剑法刀法45%几率流血
	if (WGLX == 3 or WGLX == 4) and JLSD(30, 75, pid) and DWPD() then
		WAR.BLX = 1
	end

	if (WGLX == 2 ) and wglw(pid,4)>=1 and JLSD(20, 95, pid) and DWPD() then
		WAR.BLX = 1
	end
	
	--沧溟刀法特效，必流血
	if WAR.CMDF == 1 or WAR.L_WYJFA2 >= 1 and DWPD() then
		WAR.BLX = 1
	end
	
	--学有血河神鉴，必流血
	if PersonKF(pid, 163) and DWPD() then
		WAR.BLX = 1
	end

	if wugong == 18 and wglw(pid,18)>2 and WAR.TZWY==1 and DWPD() then
		WAR.BLX = 1
	end

   if wglw(pid, 49)>=1 and WAR.LMZS == 6 and DWPD() then
      WAR.BLX = 1
   end

    if WAR.ZJZC == 4 and DWPD() then
       WAR.BLX = 1
	end

			if WAR.ASKD2 == 3 then
	           WAR.BLX = 1
	        end
	
	--毒王大招必流血
	if WAR.YTML == 1 then
		WAR.BLX = 1
	end	
	
	if WAR.LYBF>0 then
	   WAR.BLX = 1
	end
 
    if WAR.L_TLD == 1 or  WAR.GCTJ == 1 or WAR.SPT ==1 or JLSD(30, 60, pid)  then
	WAR.BLX = 1
	end
 
    if WAR.HSDF_DF1==1  then
	WAR.BLX = 1
	end
 
	--装备倚天剑，屠龙刀第一种特效，奇门标主大招，必流血，其他30%几率流血
	if hurt > 30 and DWPD() and WAR.BLX == 1  then
        local lxz = 0
        lxz = lxz + math.modf((hurt) / 10)
		if  wglw(pid,67)>0 and PersonKF(pid,67) and JY.Person[pid]["内力性质"] == 2 and wugong== 67 then
	        lxz = lxz + math.modf((hurt) / 10)
	    end
	    if WAR.LYBF>0 then
		    lxz=  lxz  + WAR.LYBF*3
	    end
		if wglw(pid,18)>2 and WAR.TZWY>0 then
		    lxz=  lxz +WAR.TZNQ
		end
	    if (WGLX == 2 ) and wglw(pid,4)>=1 then
		   lxz = lxz + math.modf((hurt) / 10)
	    end	

 	if WAR.LGQJ >0 then
	   WAR.L_HQNZL[eid] = (WAR.L_HQNZL[eid] or 0) + lxz
	   lxz = 0
	end	



		if WAR.LXZT[eid] == nil then
			WAR.LXZT[eid] = lxz
		else
			WAR.LXZT[eid] = WAR.LXZT[eid] + lxz
		end


		
		WAR.LXXS[eid] = 1

		
		if JY.Person[pid]["武器"] == 202 and  wglw(pid,72)>2 and WAR.LXZT[eid]>=50 then
		WAR.XRZT[eid]= limitX((WAR.XRZT[eid] or 0) + math.modf(hurt / 10),0,50)
	    end

	   if (WGLX == 2 ) and wglw(pid,134)>=1  then
		  WAR.L_WNGZL2[eid]= (WAR.L_WNGZL2[eid] or 0) + lxz
	   end

        if 50 < WAR.LXZT[eid] then		
			if WAR.ASKD2 == 3 then
	           WAR.QBLY[eid] = limitX((WAR.QBLY[eid] or 0) + lxz,0,50)
	        end
		end
		
		if 100 < WAR.LXZT[eid] then
			WAR.LXZT[eid] = 100
			if JY.Person[pid]["武器"] == 47 and  wglw(pid,72)>2  then
		       WAR.QBLY[eid]= limitX((WAR.QBLY[eid] or 0) + math.modf(hurt / 10),0,50)
	        end
			if WAR.ZJZC == 4  then
		       WAR.QBLY[eid]= limitX((WAR.QBLY[eid] or 0) + math.modf(hurt / 10),0,50)
	        end
		end
	end
 
	WAR.BLX = 0

	
	--迟缓计算
	if hurt > 30 and DWPD()  then
		local jl = 70
        local bch = 0
        if WAR.LXFM == 1 then
            bch = 1
        end
        if WAR.L_WYJFA4 >= 1 then
            bch = 1
        end 
		if (WAR.HDMC == 9 or  WAR.HDMC2 == 9) then
		bch = 1
		end
		if WAR.DGXF == 3 then
		bch = 1
		end
		if WAR.LSDF == 2 then
		bch = 1
		end
		--毒王大招必迟缓
	if WAR.YTML == 1 then
		bch = 1
	end

	if wglw(pid,55)>=1 and wugong == 55 then
		bch = 1
	end
	
	if  WAR.KFKJ2> 0 then
	   bch = 1
	end

	if WAR.ASKD2 == 4 then
		bch = 1
	end
	if WAR.BCH == 1 then
		bch = 1
		WAR.BCH = 0
	end
        if JY.Wugong[wugong]["迟缓系数"] == 1 and JLSD(10, 10 + jl, pid) then
            bch = 1
        end 		
		if  bch == 1 then
			local chihuan = hurt / 20
			if JY.Person[eid]["防具"] == 63 then --皮衣-迟缓5
				chihuan = chihuan - 5
				if chihuan < 0 then chihuan = 0 end
			end
		    if (WGLX == 4 ) then
		   chihuan = chihuan + math.modf((hurt) / 10)
	    end				
			chihuan = math.modf(chihuan)
	if WAR.LGQJ == 1 then
		WAR.DEFUP[eid] = (WAR.DEFUP[eid] or 0) + chihuan
		chihuan = 0
	end		
			if WAR.CHZ[eid] == nil then
			  WAR.CHZ[eid] = chihuan
			else
			  WAR.CHZ[eid] = WAR.CHZ[eid] + chihuan
			end
			WAR.CHXS[eid] = 1
			if 50 < WAR.CHZ[eid] then
				if WAR.DGXF == 3  then
				WAR.L_NOT_MOVE[eid] = 1
				end
				if WAR.LSDF == 2 then
		        WAR.GTSHAQI =WAR.GTSHAQI + WAR.CHZ[eid] * 3
				WAR.GTPID2 = pid
		        end
				if WAR.ASKD2 == 4 then
		        WAR.LSQ[eid] = WAR.CHZ[eid]
		        end
			end	
			if 100 < WAR.CHZ[eid] then
				WAR.CHZ[eid] = 100
			end				
		end
	end

--麻痹计算
	if hurt > 30 and DWPD()  then
		local jl = 70
        local bch = 0
        if JY.Wugong[wugong]["麻痹系数"] == 1 and JLSD(10, 10 + jl, pid) then
            bch = 1
        end
		--毒王大招必麻痹
	if WAR.YTML == 1 then
		bch = 1
	end 
		if WAR.DGXF == 1 then
		bch = 1
		end	
	if WAR.ZJZC >=1 then
	   bch = 1
	end
	if WAR.WYSQ>0 and kfkind == 4 then
	bch = 1
	end
	if WAR.ASKD2 == 6 then
		bch = 1
	end	
	if WAR.LZPX == 3 or WAR.LZPX == 5 then
    bch = 1
	end
	if WAR.YSDF == 2 then
	bch = 1
	end
    if WAR.XLMH>0  then
	bch = 1	
	end
	if WAR.BMB == 1 then
	bch = 1	
	WAR.BMB = 0
	end
	if WAR.HSDF_DF1==3  then
	bch = 1		
	end
		if  bch == 1 then
			local chihuan = hurt / 20
		    if (WGLX == 5 ) then
		   chihuan = chihuan + math.modf((hurt) / 10)
	        end
        if WAR.XLMH>0  then
	      chihuan = chihuan + math.modf((hurt) / 20)
	    end
		    if (WAR.ZJZC >=1) then
		   chihuan = chihuan + math.modf((hurt) / 10)
	        end				
			chihuan = math.modf(chihuan)	
	if WAR.LGQJ == 1 then
		WAR.LUCK[eid] = (WAR.LUCK[eid] or 0) + chihuan
		chihuan = 0
	end		
			if WAR.MBZ[eid] == nil then
			  WAR.MBZ[eid] = chihuan
			else
			  WAR.MBZ[eid] = WAR.MBZ[eid] + chihuan
			end
			WAR.MBXS[eid] = 1
			if 50 < WAR.MBZ[eid] then
				if WAR.DGXF == 1  then
				WAR.PBFY[eid] = 10
				end
	            if WAR.LZPX == 3 or WAR.LZPX == 5 then
                WAR.QBLY[eid] = 30
            	end
				if WAR.WYSQ>0 and kfkind == 4 then
	            WAR.XRZT[eid] = (WAR.XRZT[eid] or 0) + chihuan
	            end
			end	
			if 100 < WAR.MBZ[eid] then
				WAR.MBZ[eid] = 100
			end				
		end
	end
	
	--冰封计算 
	--阴内九阴必冰封
	if JY.Wugong[wugong]["冰封系数"] == 1 and ((PersonKF(pid, 107) and JY.Person[pid]["内力性质"] == 0) or JLSD(10,90,pid)) then
		WAR.BBF = 1
	end
	
	if PersonKF(pid, 179) then
	   if Curr_NG(pid,179) then
	   WAR.BBF = 1
	   elseif JLSD(10,50+wglw(pid,179)*10,pid) then
	   WAR.BBF = 1
	   end   
	end
	
	--林朝英流风回雪
	if WAR.LFHX == 1 then
		WAR.BBF = 1
	end
	
	if WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 4   then
	   WAR.BBF = 1
	end
	
	--琴棋书画的妙笔丹青特效
	if WAR.QQSH2 >= 1 or WAR.SPT ==1 then
		WAR.BBF = 1
	end
	
	--玉箫剑法配合桃花绝技60%冰封
	if wugong == 38 and TaohuaJJ(pid) and JLSD(20,80,pid) then
		WAR.BBF = 1
	end
	
	--左冷禅，李四，高几率冰封
	if wglw(pid,67)>0 and PersonKF(pid,67) and JY.Person[pid]["内力性质"] == 0 and JLSD(10,90,pid) and wugong== 67 then----
			WAR.BBF = 1
	end

		if  WAR.JGHJ == 19 then---混元化境幻阴
		  WAR.BBF = 1
		end		
		if  WAR.JGHJ == 35 then---混元化境幻阴
		  WAR.BBF = 1
		end	

	
	--毒王大招必冰封
	if WAR.YTML == 1 then
		WAR.BBF = 1
	end

		if wglw(pid,9)>=1 and JLSD(10,90,pid) then
		WAR.BBF = 1
		end
	
	if WAR.OYK == 2 then
	   WAR.BBF = 1
	end
	
	if  WAR.DJDAO2>0 or WAR.DJSX2> 0 then
	WAR.BBF = 1
	end
	
	if (match_ID(pid, 22) or match_ID(pid, 42)) and JLSD(10,90,pid) then
		WAR.BBF = 1
	end
	
	if WAR.YZSS[eid]~=nil then
		WAR.BBF = 1
	end

	   if Curr_NG(eid,179) then
	   WAR.BBF = 0
	   end


	
	if hurt > 30 and DWPD() and WAR.BBF == 1 then
		local bfz = math.modf(hurt / 10)

		if WAR.OYK == 2 then
	       bfz = JY.Person[eid]["中毒程度"] + bfz
	    end
		--琴棋书画的妙笔丹青特效江山如画		
		if WAR.QQSH2 == 2  or WAR.SPT ==1 or (wglw(pid,67)>0 and PersonKF(pid,67) and JY.Person[pid]["内力性质"] == 0 ) then
			bfz = bfz * 2
		end
		if  WAR.DJDAO2>0 or WAR.DJSX2> 0 then
	        bfz = bfz * 2
	    end
		if  WAR.JGHJ == 19 then---混元化境幻阴
		   bfz = bfz+math.modf(ang/50)
		end		
		if  WAR.JGHJ == 35 then---混元化境幻阴
		   bfz = bfz+math.modf(ang/50)
		end

	if WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 4   then
	   bfz = bfz + 5
	end
		
		if WAR.BSYJ[pid]~=nil then
		   bfz = bfz + math.modf(JY.Person[eid]["内力"]/200)
		end

		--装备皮衣，1级冰封-50%，6级免疫冰封
		if JY.Person[eid]["防具"] == 63 then
			local kh = 0.5 + 0.1 * (JY.Thing[63]["装备等级"]-1)
			bfz = math.modf(bfz *(1-kh))
		end
		--纯阳被动，冰封-50%
		if PersonKF(eid, 99) then
			bfz = math.modf(bfz / 2)
		end
		if wglw(pid,9)>=2 then
		local bfz = math.modf(bfz * (1+(WAR.SPXT[pid] or 0)*0.15))
		WAR.SPXT[pid] = (WAR.SPXT[pid] or 0) + 1
		end		
		if wglw(pid,9)>=1 then
		local d = bfz
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", d)
		end
		if WAR.YZSS[eid]~=nil then
		   bfz = bfz * 2
	    end

    if WAR.LGQJ == 1 then
	WAR.L_HQNZL2[eid] = (WAR.L_HQNZL2[eid] or 0) + bfz
	bfz= 0
	end	

		if WAR.LYLZ[eid]~=nil and WAR.LYLZ[eid] == 6 then
		        local a =  bfz
		        WAR.YINFU[eid] = (WAR.YINFU[eid] or 0) + a
		        if WAR.YINFU[eid]>= 50 then
		           WAR.YINFU[eid] = 50
		        end
				bfz = 0
		end
		
		if bfz > 0 then
			JY.Person[eid]["冰封程度"] = JY.Person[eid]["冰封程度"] + bfz
			WAR.BFXS[eid] = 1
			
			if WAR.JYWR[pid]~=nil  then
			WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -bfz*10)
			bfz = 0
			end

			if 100 < JY.Person[eid]["冰封程度"] then
			    local d=JY.Person[eid]["冰封程度"]-100
				JY.Person[eid]["冰封程度"] = 100
				if wglw(pid,21)>=1 then
				local dd = math.modf(JY.Person[eid]["冰封程度"]/10)
				WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", dd)
				end
				if wglw(pid,120)>=1 then
				WAR.FXDS[eid]=(WAR.FXDS[eid] or 0) + math.modf(d/2)
				if WAR.FXDS[eid]> 50 then
				WAR.FXDS[eid]=50
				end
				WAR.FXXS[eid]=1
				end
				if wglw(pid,67)>2 and  JY.Person[pid]["武器"] == 45 then
				WAR.LRHF[eid] = limitX((WAR.LRHF[eid] or 0) + d,0,50)
				end
			end
		end
	end
	
	WAR.BBF = 0

	--灼烧计算
	--阳内九阳必灼烧
	if JY.Wugong[wugong]["灼烧系数"] == 1 and ((PersonKF(pid, 106) and JY.Person[pid]["内力性质"] == 1) or JLSD(10,90,pid)) then
		WAR.BZS = 1
	end
	if  WAR.FLHS3>0 then
	WAR.BZS = 1
	end
	
	if match_ID_awakened(pid,80,1) and WAR.NSTJ1>0 then
		 WAR.BZS = 1
	end

	if WAR.YZSX[eid]~=nil then
	    WAR.BZS = 1
	end
	
	if YCRW(pid) == 4 and yongquan(wugong) then
	    WAR.BZS = 1
	end	

	if nglw(pid,93)>=1 and (JLSD(10,70,pid) or WAR.BJ == 1 ) and Curr_NG(pid,93) then
	    WAR.BZS = 1
	end
	
	if wglw(pid,17)>1 and wugong == 17 then
		 WAR.BZS = 1
	end

	if WAR.MZQL[pid]~=nil and WAR.MZQL[pid] == 3 then
		 WAR.BZS = 1
	end

	if wglw(pid,22)>=1 and wugong == 22 then
		WAR.BZS = 1
	end
	
	if JuHuoLY(pid) and yongdao(wugong) then
	    WAR.BZS = 1
	end
	
	if  WAR.DJJIAN2>0 or WAR.DJSX2> 0 then
	WAR.BZS = 1
	end
	--苗人凤，天门，张三，高几率灼烧
	if (match_ID(pid, 3) or (wglw(pid,44)>0 and PersonKF(pid,44)) or match_ID(pid, 23) or match_ID(pid, 41)) and JLSD(10,90,pid) then
		WAR.BZS = 1
	end

	if match_ID_awakened(pid,65,1) and WAR.LMZL>0  then
	WAR.BZS = 1
	end
	
		--毒王大招必zhuoshao
	if WAR.YTML == 1 then
		WAR.BZS = 1
	end
	
	if wglw(pid,67)>0 and PersonKF(pid,67) and JY.Person[pid]["内力性质"] == 1 and JLSD(10,80,pid) and wugong== 67 then
		WAR.BZS = 1	
	end

	if wglw(pid,65)>0 and PersonKF(pid,65) and JLSD(10,90,pid) then
		WAR.BZS = 1	
	end	


	
	if hurt > 30 and DWPD() and WAR.BZS == 1 then
		local zsz = math.modf(hurt / 10)
	if  WAR.FLHS3>0 then
	zsz = math.modf(zsz *1.5)
	end
	if  wglw(pid,44)>=1 and PersonKF(pid,44) then
	zsz = math.modf(zsz *1.25)
	end
	if wglw(pid,65)>=1 and PersonKF(pid,65) then
	zsz = math.modf(zsz *1.5)	
	end	
	if  wglw(pid,67)>=1 and PersonKF(pid,67) and JY.Person[pid]["内力性质"] == 1 and wugong== 67 then
	zsz = math.modf(zsz *1.25)
	end


	
	if wglw(pid,17)>1 and wugong == 17 then----一阳指二阶阳炎
	zsz = zsz+10
	end
	
	if match_ID_awakened(pid,65,1) and WAR.LMZL>0  then
	zsz = zsz+(7-WAR.LMZL)*5
	end
	
	if  WAR.DJJIAN2 > 0  or WAR.DJSX2> 0 then
	zsz = math.modf(zsz *1.25)
	end
	
	if match_ID_awakened(pid,80,1) and WAR.NSTJ1>0 then
	zsz = zsz+5*WAR.NSTJ1
	end

				if wglw(pid,66)>=1 and wugong == 66 then
				zsz = math.modf(zsz *2)
				end
	
	if WAR.YZSX[eid]~=nil then
	zsz = math.modf(zsz *2)
	end
	
		--装备佛心甲，1级灼烧-50%，6级免疫灼烧
		if JY.Person[eid]["防具"] == 62 then
			local kz = 0.5 + 0.1 * (JY.Thing[62]["装备等级"]-1)
			zsz = math.modf(zsz *(1-kz))
		end
		--玉女被动，灼烧-50%
		if PersonKF(eid, 154) then
			zsz = math.modf(zsz / 2)
		end
		
    if WAR.LGQJ == 1 then
	WAR.ATKUP[eid] = (WAR.ATKUP[eid] or 0) + zsz
	zsz = 0
	end	
	
		if zsz > 0 then
		        if WAR.LYLZ[pid]~=nil and WAR.LYLZ[pid] ==1 then
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", zsz)
				end
		        if nglw(eid,93)>=1 and JY.Person[eid]["生命"] > 0 then
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", zsz)
				zsz = 0
				end
				if nglw(pid,93)>=1 then
						for i = 0, WAR.PersonNum - 1 do
                            if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false then
					           local kid = WAR.Person[i]["人物编号"];			
					           local add = math.modf(zsz*1.25);		
					           WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					           WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				             WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
				           end	
		                end
				end
				if wglw(pid,66)>=1 then
				local zsz2=math.modf(zsz/2)
				WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", zsz)
				end
				if WAR.LYLZ[eid]~=nil and WAR.LYLZ[eid] == 3 and JY.Person[eid]["生命"] > 0 then
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", zsz)
				zsz = 0
				end
				if WAR.MZQL[eid]~=nil and WAR.MZQL[eid] == 3  then
				WAR.MZ_LH[eid] = (WAR.MZ_LH[eid] or 0) + zsz
				zsz = 0
				end
			JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] + zsz
			WAR.ZSXS[eid] = 1
			if 50 < JY.Person[eid]["灼烧程度"] then
				 local d=JY.Person[eid]["灼烧程度"]-50
				JY.Person[eid]["灼烧程度"] = 50
			end
			if WAR.YZSX[eid]~=nil and WAR.YZSY[eid]~=nil then
	          WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -zsz)
	        end
		end
	end
	
	WAR.BZS = 0
	
	--倚天剑，4级开始追加灼烧
	if JY.Person[pid]["武器"] == 37 and JY.Thing[37]["装备等级"] >= 4 then
		local zsz = (JY.Thing[37]["装备等级"]-3)*5

		--装备佛心甲，灼烧-50%
		if JY.Person[eid]["防具"] == 62 then
			zsz = math.modf(zsz / 2)
		end
		--玉女被动，灼烧-50%
		if PersonKF(eid, 154) then
			zsz = math.modf(zsz / 2)
		end
		if zsz > 0 then
				if nglw(eid,93)>=1 and JY.Person[eid]["生命"] > 0 then
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", zsz)
				zsz = 0
				end

			JY.Person[eid]["灼烧程度"] = JY.Person[eid]["灼烧程度"] + zsz
			WAR.ZSXS[eid] = 1
			if 50 < JY.Person[eid]["灼烧程度"] then
				 local d=JY.Person[eid]["灼烧程度"]-50
				JY.Person[eid]["灼烧程度"] = 50
				if wglw(pid,66)>=1 then
				WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", d)
				end

			end
		end
	end
	
	--怒气值计算，斗转星移不加怒，指法大招不加怒
	if 0 < JY.Person[eid]["生命"] and hurt > 0 and (WAR.LQZ[eid] == nil or WAR.LQZ[eid] < 100) and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.DZXY ~= 1 and WAR.LXYZ ~= 1 and BXZT(eid) == 0 then
		local lqzj = math.modf((hurt) / 6 + 1)
		lqzj = math.random(lqzj, lqzj+10)
		
		if WAR.MK_DS[eid]~=nil then----
		local xslq = 0
		   if WAR.LQZ[pid]~=nil then
		   xslq=math.modf(WAR.LQZ[pid]/2)
		   WAR.LQZ[pid] = WAR.LQZ[pid]-xslq
		   if WAR.LQZ[pid]<=0 then
		   WAR.LQZ[pid] = nil
		   end
		   end
		   lqzj = lqzj + xslq
		end
		
		--敌人难度下额外增加的怒气值
		if WAR.Person[enemyid]["我方"] == false then
			local flqzj = 0
			if JY.Base["难度"] == 1 then
				flqzj = 1
			elseif JY.Base["难度"] == 2 then
				flqzj = 5
			else
				flqzj = 8 + JY.Base["难度"]
			end
			lqzj = lqzj + flqzj;
		end
		
		
		--太玄之重，不加怒
		if WAR.TXZZ == 1 then
		--琴棋书画之持瑶琴不加怒
		elseif WAR.QQSH1 > 0 then
		
		elseif WAR.LYBF==3 then
		
		elseif WAR.WYSQ == 2 then

				  		
		else
		    lqzj = lqzj + 2
		    if wglw(pid,58) > 0 and wugong == 58 then
		    WAR.YZHYZ = WAR.YZHYZ+lqzj
		    lqzj=-lqzj
			end
			if WAR.GTNUQI~= 0 and WAR.GTPID3 == pid then
			   if lqzj>=0 then
			   lqzj = - WAR.GTNUQI
			   else
			   lqzj = lqzj - WAR.GTNUQI
			   end
			end
			if WAR.WMSF == 2 then--
		       lqzj=-lqzj
			   local aa = lqzj*50
			   WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",aa); 
		    end
			
			if T7DFWM(eid) or (eid == 0  and JY.Base["标准"] == 5 ) then --特系主角和陈家洛每个特系+怒气5%
		       local gctj = wgnumber(eid, 5)
		       lqzj = math.modf(lqzj * (1 + 0.05 * gctj))
	        end
			
			if wglw(eid,74)>1 and WAR.SHJG[eid] ~= nil and WAR.SHJG[eid] == 4 then
            lqzj = lqzj * 2
			end
			
			if PersonKF(eid,180) then
			   if Curr_NG(eid,180) then
			   lqzj = math.modf(lqzj * 1.2)
			   else
			   lqzj = math.modf(lqzj * 1.1)
			   end
			   if nglw(eid,180)>1 and JLSD(10,30+nglw(eid,180)*5,eid) then
			   lqzj = 100			   
			   end
			end
			
			
			if WAR.LQZ[eid] == nil then
				WAR.LQZ[eid] = lqzj 
			else
				WAR.LQZ[eid] = WAR.LQZ[eid] + lqzj 
			end
			if WAR.LQZ[eid] ~= nil and WAR.LQZ[eid] <= 0 then
			WAR.LQZ[eid] = nil;
		    end
		end
		  
		if WAR.LQZ[eid] ~= nil and WAR.LQZ[eid] <= 0 then
			WAR.LQZ[eid] = nil;
		end
		
		--怒气暴发
		if WAR.LQZ[eid] ~=  nil and 100 < WAR.LQZ[eid] then
			WAR.LQZ[eid] = 100
			if WAR.HOT[eid]~=nil and WAR.HOT[eid]>0 then
			WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) +AddPersonAttrib(eid, "受伤程度", 100)
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", -200)
			WAR.LQZ[eid] = nil
			end
			if wglw(eid,58)>1 and WAR.XLEB==0 and WAR.XLD[eid] == nil then
            WAR.XLEB = 3
			WAR.XLD[eid]=1
			WAR.BDKY[eid] = (WAR.BDKY[eid] or 0) + 5
				if WAR.Person[enemyid]["特效文字2"] ~= nil then
					WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+雄霸天下·阿鼻三刀"
				else
					WAR.Person[enemyid]["特效文字2"] = "雄霸天下·阿鼻三刀"
				end
			end
			if match_ID_awakened(eid,103,1) and WAR.CHD==0 and WAR.JLL[eid] == nil then
            WAR.CHD = 4
			WAR.JLL[eid]=1
				if WAR.Person[enemyid]["特效文字2"] ~= nil then
					WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+迦楼罗·明王残火刀"
				else
					WAR.Person[enemyid]["特效文字2"] = "迦楼罗·明王残火刀"
				end
			end
			if wglw(eid,74)>1 and WAR.SHJG[eid] ~= nil and WAR.SHJG[eid] == 1 then
            WAR.SHJG[eid] = 3
				if WAR.Person[enemyid]["特效文字2"] ~= nil then
					WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+咏春蛇形.化龙"
				else
					WAR.Person[enemyid]["特效文字2"] =  "咏春蛇形.化龙"
				end
			end
			if wglw(eid,74)>1 and WAR.SHJG[eid] ~= nil and WAR.SHJG[eid] == 4 then
			local bb= math.modf(JY.Person[eid]["生命最大值"]*0.5)*JY.Person[eid]["血量翻倍"]
            WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) +AddPersonAttrib(eid, "受伤程度", -100)
			WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", bb)
				if WAR.Person[enemyid]["特效文字2"] ~= nil then
					WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+咏春龟形.灵龟呼吸"
				else
					WAR.Person[enemyid]["特效文字2"] =  "咏春龟形.灵龟呼吸"
				end
			end
			if D1ZSF(eid)  then
			WAR.LSQL[eid]=1
			WAR.Person[enemyid].TimeAdd = 1005
			WAR.ACT = 10
			WAR.ZYHB = 0
				if WAR.Person[enemyid]["特效文字2"] ~= nil then
					WAR.Person[enemyid]["特效文字2"] = WAR.Person[enemyid]["特效文字2"] .. "+纯阳真解·龙蛇起陆"
				else
					WAR.Person[enemyid]["特效文字2"] = "纯阳真解·龙蛇起陆"
				end
			end
			if Curr_NG(eid,175) then
			    local HN;
				local NS;
				HN=JY.Person[eid]["受伤程度"]+JY.Person[eid]["灼烧程度"]+JY.Person[eid]["中毒程度"]+JY.Person[eid]["冰封程度"]+(WAR.LXZT[eid] or 0) + (WAR.CHZ[eid] or 0)+ (WAR.MBZ[eid] or 0)+(WAR.FXDS[eid] or 0)
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +AddPersonAttrib(eid, "生命", HN);
					JY.Person[eid]["受伤程度"]=0
					JY.Person[eid]["灼烧程度"]=0
					JY.Person[eid]["中毒程度"]=0
					JY.Person[eid]["冰封程度"]=0
					WAR.LXZT[eid] = nil
					WAR.CHZ[eid] = nil
					WAR.MBZ[eid] = nil
					WAR.FXDS[eid] = nil
			end
			--东方不败，葵花秘法·化凤为凰
			if match_ID(eid, 27) then
				WAR.Person[enemyid]["特效动画"] = 7
				if WAR.Person[enemyid]["特效文字1"] ~= nil then
					WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+葵花秘法·化凤为凰"
				else
					WAR.Person[enemyid]["特效文字1"] = "葵花秘法·化凤为凰"
				end
			else
				WAR.Person[enemyid]["特效动画"] = 6
				if WAR.Person[enemyid]["特效文字1"] ~= nil then
					WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+怒气爆发"
				else
					WAR.Person[enemyid]["特效文字1"] = "怒气爆发"
				end
			end
		end
	end

	--王重阳在北斗七闪状态下不会被清怒
	if not ((match_ID(eid, 129) and WAR.CYZX[eid] ~= nil and WAR.BDQS > 0) or wglw(pid,58)>=1 or match_ID_awakened(eid,50,1)  or (match_ID_awakened(eid,65,1) and WAR.WCY[eid] ~= nil and WAR.LMZL > 0)) then
		--指法大招清一半怒
		if WAR.LXYZ == 1 and DWPD() and WAR.LQZ[eid] ~= nil then
			WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
		end
		
		--菩提清心清一半怒
		if WAR.QQSH1 == 2 and DWPD() and WAR.LQZ[eid] ~= nil then
			WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
		end
		
		if WAR.LYBF==3 and DWPD() and WAR.LQZ[eid] ~= nil then
           WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
        end	
		
		--触发太玄之重时，敌方已经暴怒（或者三阶龙象，龙岛主等情况）的话，则有几率清怒
		if WAR.TXZZ == 1 and WAR.LQZ[eid] ~= nil and (WAR.LQZ[eid] == 100 or nglw(pid,102)>2 or match_ID(pid,39)) and JLSD(10, 60 + JY.Base["天书数量"] + math.modf(JY.Person[pid]["实战"]/50), pid) and DWPD() then
			
			if nglw(pid,102)>2 then
			local aa= (WAR.LQZ[eid] or 0)*3
			local bb = math.modf((WAR.LQZ[eid] or 0)*0.5)
			WAR.LQZ[eid] = nil
			WAR.LSQ[eid] = (WAR.LSQ[eid] or 0) + bb
			WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", bb)
			elseif match_ID(pid,39) then
			local aa= (WAR.LQZ[eid] or 0)*3
			local bb = math.modf((WAR.LQZ[eid] or 0)*0.5)
			WAR.LQZ[eid] = nil
			WAR.LSQ[eid] = (WAR.LSQ[eid] or 0) + bb
			WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", bb)			
			else
			WAR.LQZ[eid] = WAR.LQZ[eid] - 20
			end
			if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+救赵挥金锤.邯郸先震惊"
			else
				WAR.Person[enemyid]["特效文字1"] = "救赵挥金锤.邯郸先震惊"
			end
		end
	end
  
	--成不忧 被令狐冲 秒杀
	if WAR.ZDDH == 205 and eid == 141 then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
	end
	
	--丁敏君 被周芷若 秒杀
	if WAR.ZDDH == 279 and eid == 632 then
		WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
		JY.Person[eid]["生命"] = 0
	end
  
	--游坦之 上毒
	if match_ID(pid, 48) and DWPD() then
		local d = math.modf((340 - JY.Person[eid]["抗毒能力"] - JY.Person[eid]["内力"] / 50) / 4)
		if d < 0 then
			d = 0
		end
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", d);
	end
	

  
	--铁掌，高机率造成内伤12~15点
	if wugong == 13 and JLSD(30, 90, pid) and DWPD() then
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(12, 15));
	end

   if WAR.YKX1 == 2 and DWPD()  then --聚沙成兵：石锤
	local aa = 100-JY.Person[eid]["体力"]
	WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.modf(aa/2));
	WAR.XRZT[eid] = (WAR.XRZT[eid] or 0) + math.modf(aa/4)
  end	

   if WAR.YKX1 == 4 and DWPD()  then --聚沙成兵：毒刃
	local aa = 100-JY.Person[eid]["体力"]
	WAR.L_WNGZL2[eid] = (WAR.L_WNGZL2[eid] or 0) + math.modf(aa/4)
	WAR.QBLY[eid] = (WAR.QBLY[eid] or 0) + math.modf(aa/4)
  end
	
	--崩劲
	if WAR.L_TJQ == 1 and DWPD() then
	    local aa = math.modf(WAR.tmp[3000 + pid]/30)
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", aa);
		if JY.Person[eid]["受伤程度"]>=100 then
		 WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命",-aa*10);
		end
	end	
	
	--七伤拳，机率造成内伤17点
	if WAR.YZQS == 1 and DWPD() then
		local ns = 17
		--谢逊额外造成+7
		if match_ID(pid, 13) then
			ns = ns + 7
		end
		if wglw(pid,23)>0 then
			ns = ns + 7
		end
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", ns);
		--当自己内力值低于5000时，会受到内伤
		if JY.Person[pid]["内力"] < 5000 and wglw(pid,23)<1 then
			WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", 7);
		end
		if wglw(pid,23)>1 then
		local as=0
		local aa=math.random(1,5)
		local YZQS={"摧心","损肝","裂脾","伤肺","透肾"}
		local YZQS1 = YZQS[aa]
		ns = ns+math.random(5,10)
		   if match_ID(pid,8) then
		   aa = 1
		   end
		if aa>0 then
		   if aa==1 then
		   addeffect2(WAR.YZSX,eid,ns)
		   if wglw(pid,23)>2 then
		   WAR.WMYH[eid]=30
		   as=as+ns
		   if as>=30 then
		   as=30
		   end
		   WAR.YZHF = WAR.YZHF+as
		   end
		   elseif aa==2 then
		   addeffect2(WAR.YZSG,eid,ns)
		   if wglw(pid,23)>2 then
		   WAR.L_HQNZL[pid] = ns
		   JY.Person[pid]["中毒程度"] = 0
		   end
		   elseif aa==3 then
		   addeffect2(WAR.YZSP,eid,ns)
		   if wglw(pid,23)>2 then
		   JY.Person[pid]["受伤程度"] = 0
		   WAR.BHJS2[pid] = ns
		   end
		   elseif aa==4 then
		   addeffect2(WAR.YZSF,eid,ns)
		   if wglw(pid,23)>2 then
		   WAR.KBGJ[pid] = ns
		   WAR.QBLY[eid] = ns
		   end
		   else
		   addeffect2(WAR.YZSS,eid,ns)
		   if wglw(pid,23)>2 then
		   WAR.CXLC= 1
		   end
		   end
		end

		   if wglw(pid,23)>2 and (WAR.YZSY[eid] ~=nil or WAR.YZSY2[eid] ~= nil) then
           WAR.YJQS1[eid] = 50
		   YZQS1 =YZQS1.."七伤气劲"
		   end
		
		   if wglw(pid,23)>2 and WAR.YZSY[eid] ==nil and WAR.YZSY2[eid] == nil then
		   local bs=0
		   local bb=math.random(1,2)
		   local YZQS2={"阴虚","阳亢"}
		       if bb==1 then
		          addeffect2(WAR.YZSY,eid,ns)
				  addeffect2(WAR.YINFU,pid,ns)
				  	 if WAR.YINFU[pid]>= 50 then
		                WAR.YINFU[pid] = 50
		             end
		       else
		          addeffect2(WAR.YZSY2,eid,ns)
				  addeffect2(WAR.YANGFU,pid,ns)
				   if WAR.YANGFU[pid]>= 50 then
		           WAR.YANGFU[pid] = 50
		           end
		       end
		   YZQS1 =YZQS1..YZQS[bb]
		   end
		   
		   
		     if WAR.Person[enemyid]["特效文字1"] ~= nil then
				WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .."+"..YZQS1
			else
				WAR.Person[enemyid]["特效文字1"] = YZQS1
			end
			WAR.Person[enemyid]["特效动画"] = 123+aa
		end
	end
 
     if WAR.LQS == 3 and DWPD() then----
	 WAR.JJPZ[eid] = 1
	 WAR.BSQ = 1
	 end
 
    if WAR.LQS == 4  and DWPD() then
       addeffect2(WAR.YZSF,eid,30)
    end	

    if WAR.LQS == 5  and DWPD()  then
       addeffect2(WAR.LRHF,eid,30)
    end	

    if WAR.LQS == 6 and DWPD() then
       addeffect2(WAR.JHLY2,eid,30)
    end		
	
    if  WAR.LQAY == 2 and DWPD() then
	   addeffect2(WAR.ATKDOWN,eid,30)
       addeffect2(WAR.SPDDOWN,eid,30)	   
	end	
	
	  if  WAR.LQAY == 4 and DWPD() then
	   local aa = (WAR.LXZT[eid] or 0) * 5
	    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命",-aa);
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力",aa); 	
	   end
 
 	  if  WAR.LQAY == 5 and DWPD() then
	   local aa = (WAR.LXZT[eid] or 0) 
	   local aa1 = aa * 10
	    WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",-aa1);
	    WAR.MENG[eid] =  (WAR.MENG[eid] or 0) + aa
		WAR.ICE[eid] =  (WAR.ICE[eid] or 0) + aa
	   end
 
 	if WAR.YZQS1 == 1 and DWPD() then
	    local aa = math.max(JY.Person[pid]["内力"]-JY.Person[eid]["内力"],0)
		local ns = 10+math.modf(aa/10)
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度",ns);
	end
 
    if WAR.HSDF_DF1==2 and DWPD() then
	    local aa = math.max(JY.Person[pid]["内力"]-JY.Person[eid]["内力"],0)
		local ns = 10+math.modf(aa/10)
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度",ns);
		if JLSD(10,40,pid) then
		WAR.HMZT[eid] = 1
		end
	end
 
  	if WAR.ZYHB == 2 and WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 6 and DWPD() then
	   addeffect2(WAR.XRZT,eid,30)
	   addeffect2(WAR.JHLY2,eid,30)
	end
 
	if WAR.TZQJ == 4 and wugong == 18 and DWPD() then
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(12, 15));
	end 
  
	if WAR.TZQJ == 4 and yongnei(wugong) and DWPD() then		
	    local aa = math.max(JY.Person[pid]["内力"]-JY.Person[eid]["内力"],0)
		local ns = 10+math.modf(aa/100)
		local aa1 = aa * 10
		if WAR.HMZT[eid] ~= nil then
		ns = ns *2
		end
		WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", ns);
	    WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",-aa1);
		if JLSD(10,40,pid) then
		WAR.HMZT[eid] = 1
		end
	end 
  
	--乾坤反弹伤害
	if eid == -1 then
		local x, y = nil, nil
		while true do
			x = math.random(63)
			y = math.random(63)
			if not SceneCanPass(x, y) or GetWarMap(x, y, 2) < 0 then
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 2, -1)
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 5, -1)
				WAR.Person[enemyid]["坐标X"] = x
				WAR.Person[enemyid]["坐标Y"] = y
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 2, enemyid)
				SetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 5, WAR.Person[enemyid]["贴图"])
				break;
			end
		end
	end
  
	--判断是否可以加实战
	if JY.Person[eid]["生命"] <= 0 and inteam(pid) and DWPD() and WAR.SZJPYX[eid] == nil and (JY.Person[pid]["实战"] < 500 or (wglw(pid,52)>1 and JY.Person[pid]["实战"] < 1000 ) ) then
		
		--崆峒派战斗、高升客栈杀欧阳克、家里练功房、全真教练功、青城派练功、少林练功   不加实战
		local wxzd = {17, 67, 226, 220, 224, 219, 79}
		local wx = 0
		for i = 1, 7 do
		  if WAR.ZDDH == wxzd[i] then
			wx = 1
		  end
		end
		
		--丐帮门口
		if WAR.ZDDH == 82 and (GetS(10, 0, 18, 0) == 1 or wglw(pid,52)>1 ) then
		  wx = 1
		end
		--木人巷
		if WAR.ZDDH == 214 and GetS(10, 0, 19, 0) == 1 then
		  wx = 1
		end
		
		--如果可加实战
		if wx == 0 and inteam(pid) then
			local szexp = 1
			if eid < 191 and 0 < eid then
				szexp = WARSZJY[eid]
			end
			JY.Person[pid]["实战"] = JY.Person[pid]["实战"] + szexp
			if JY.Person[pid]["实战"] > 500 then
			    if wglw(pid,52)>1  then
				   if JY.Person[pid]["实战"] >= 1000 then
				   JY.Person[pid]["实战"] = 1000
				   end
				else
				JY.Person[pid]["实战"] = 500
				end
			end
			WAR.SZJPYX[eid] = 1
		end
	end

 if JY.Person[eid]["生命"] <= 0 and DWPD() then --击败敌人战意增长
	if WAR.Person[WAR.CurID]["我方"] then
		zhanyi(pid, math.modf(4 * (1 + WAR.MYCHAIN / 30)))
	else
		zhanyi(pid, math.modf(5 * (1 + WAR.MYCHAIN / 30)))
	end
  end
  
	--平一指杀人
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 28) then
		WAR.PYZ = WAR.PYZ + 1
		AddPersonAttrib(pid, "医疗能力", 1)
		if 10 < WAR.PYZ then
			WAR.PYZ = 10
		end
		if match_ID_awakened(pid, 28,1) and JY.Person[28]["论剑奖励"] == 1 then
		WAR.Person[WAR.CurID]["生命点数"]=(WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid,"生命",350)
		local jl = JY.Base["天书数量"]*10 + math.modf(JY.Person[pid]["实战"]/50)
        	for j = 0, WAR.PersonNum - 1 do
               if WAR.Person[j]["我方"] == true and WAR.Person[j]["死亡"] == false then
					local kid = WAR.Person[j]["人物编号"];
					local add = JY.Person[pid]["医疗能力"]/4 + JY.Person[pid]["医疗能力"]*jl/160 + math.random(30);
					if add > JY.Person[pid]["医疗能力"]/2 then	--最大为医疗值的一半
						add = JY.Person[pid]["医疗能力"]/2 ;
					end				
					add = math.modf(add);		
					WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end	
		   end		
		end
	end

--花铁干杀人回复生命
if JY.Person[eid]["生命"]<=0 and match_ID(pid,52) and DWPD() then
WAR.Person[WAR.CurID]["生命点数"]=(WAR.Person[WAR.CurID]["生命点数"] or 0)+AddPersonAttrib(pid,"生命",350)
end	
	
  if JY.Person[eid]["生命"] <= 0 and DWPD() then
	if MPPD(pid) == 4 and MPPB_MZ(pid)== 3 then --血祭
		if WAR.XJ[pid] == nil then
			WAR.XJ[pid] = 1
		else
			WAR.XJ[pid] = WAR.XJ[pid] + 1
		end
	end
  end	




if JY.Person[eid]["生命"] <= 0 and (MPPD(eid)== 5 and MPDJ(eid)>1) and DWPD() then --沼跃鱼：明教同仇敌忾
		local MJTC= math.random(3)
		local status = 0
		if MPPB_MJAS(eid) >= 1 then----
		MJTC=3
		end
		if match_ID(eid,16)  then----
		MJTC=4
		end
		if YCRW(eid) == 4 and YCRW(eid)> 2 then
		MJTC=3
		end
        if MJTC ==1 then
		for j = 0, WAR.PersonNum - 1 do
				if not WAR.Person[j]["死亡"] and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] 
					and WAR.Person[j]["人物编号"] ~= eid then
					local tmppid = WAR.Person[j]["人物编号"]
					WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) +AddPersonAttrib(tmppid, "中毒程度", 3*(MPDJ(eid)-1))
				end
			end	
		status=107
		
        elseif MJTC ==2 then
		for j = 0, WAR.PersonNum - 1 do
				if not WAR.Person[j]["死亡"] and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] 
					and WAR.Person[j]["人物编号"] ~= eid then
					local tmppid = WAR.Person[j]["人物编号"]
					addeffect2(WAR.BZ, tmppid, MPDJ(eid)-1) 
				end	
			end	
		status=108
		
		elseif MJTC ==3 then
		for j = 0, WAR.PersonNum - 1 do
				if not WAR.Person[j]["死亡"] and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] 
					and WAR.Person[j]["人物编号"] ~= eid then
					local tmppid = WAR.Person[j]["人物编号"]
					local aa=50
					local bb=300
					if MPPB_MJAS(eid) >= 1 then----
		            aa=aa+math.modf(JY.Person[eid]["内力"]/100*MPDJ(eid))
					bb=math.modf(aa*6)
		            end
					if YCRW(eid) == 4 and YCRW(eid)> 2 then----
		            aa=aa+math.modf(JY.Person[eid]["内力"]/30)
					local cc = (WAR.BDYJ[tmppid] or 0)*20
					local dd = (WAR.LHYJ[tmppid] or 0)* 20
					aa = aa + cc + dd
					bb=math.modf(aa*6)
					WAR.BDYJ[tmppid] = nil
					WAR.LHYJ[tmppid] = nil
		            end
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -aa*(MPDJ(eid)-1))
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) + AddPersonAttrib(tmppid, "内力", -bb*(MPDJ(eid)-1))
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
					     if MPPB_MJAS(eid) > 1 or (YCRW(eid) == 4 and YCRW(eid)> 2) then----连环爆破
						    WAR.JHLY2[tmppid] = (WAR.JHLY2[tmppid] or 0) + math.modf(aa/10)
						    if JY.Person[tmppid]["生命"] <= 0 then
		                    local dam = math.modf((MPPB_MJAS(eid)+1)*(JY.Person[tmppid]["内力最大值"]/20))
		                    WAR.MJZBZD = {dam, tmppid, WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"]}
							end
							end
		            end
				end
		status=127
		elseif MJTC ==4 then
		for j = 0, WAR.PersonNum - 1 do
				if not WAR.Person[j]["死亡"] and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] 
					and WAR.Person[j]["人物编号"] ~= eid then
					local tmppid = WAR.Person[j]["人物编号"]
					local aa=math.modf(JY.Person[eid]["医疗能力"]/40)
					local bb=math.modf(JY.Person[eid]["医疗能力"]/10)
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", aa*(MPDJ(eid)-1))
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) + AddPersonAttrib(tmppid, "内力", bb*(MPDJ(eid)-1))
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		            end
				end				
				
			end	
		status=109

	    WAR.Person[enemyid]["特效动画"] = status
		WAR.Person[enemyid]["特效文字3"] = "生亦何欢.死亦何苦"
	end	
	
		--鬼头刀杀人
	if JY.Person[eid]["生命"] <= 0 and wglw(pid,52)>1 then
		WAR.PYZ1 = WAR.PYZ1 + 1
		if wglw(pid,52)>1 then
		   for j = 0, WAR.PersonNum - 1 do
		   if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100*WAR.PYZ1
				if WAR.Person[j].TimeAdd<= -500 then
				WAR.Person[j].TimeAdd = -500
				end
				local tid = WAR.Person[j]["人物编号"]
				WAR.FXDS[tid] = limitX((WAR.FXDS[tid] or 0) + math.modf(JY.Person[pid]["实战"]/20),0,50)
				WAR.LQZ[tid] = math.modf((WAR.LQZ[tid] or 0) * 0.5)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
			end
        addeffect2(WAR.DR, pid, WAR.PYZ1)
        if WAR.DR[pid] > 10 then
            WAR.DR[pid] = 10
        end		
		end
		WAR.Person[enemyid]["特效动画"] = 54
	end

  --阿紫杀每人后杀全体气80 中毒5-15 中毒满追加减体力
	
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 47) and DWPD() then
		WAR.MZSH = WAR.MZSH + 1
		if match_ID_awakened(pid, 47,1) then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 80
				local p = WAR.Person[j]["人物编号"]
				if JY.Person[p]["中毒程度"] < 100 then
				WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(p,"中毒程度", 5 + WAR.MZSH);					
				else
				WAR.Person[j]["体力点数"] = (WAR.Person[j]["体力点数"] or 0) +AddPersonAttrib(p, "体力", -1 * (WAR.MZSH*math.random(1, 2)))
				end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
		WAR.Person[enemyid]["特效动画"] = 123
		end
	end	
	
	--无酒不欢：袁承志碧血长风
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 54) then
		WAR.BXCF = 1
			 if JY.Person[54]["论剑奖励"] == 1 and JY.Person[54]["品德"] == 80  then
                 WAR.MDSH = JY.Person[enemyid]["生命最大值"]  
			 end
	end
 
 	if JY.Person[eid]["生命"] <= 0 and wglw(pid, 2)>1 then
		WAR.XYYX = 1
			if  YCRW(pid) ==2 and YCDJ(pid)>1 then		    
		        WAR.MDSH = JY.Person[eid]["内力"]       
			end	
	end
 
	if JY.Person[eid]["生命"] <= 0 and wglw(pid,129)>1 and WAR.KFCF == 0 then
		WAR.KFCF = 1
	end 
 
 	--无酒不欢：连环补腿
	if JY.Person[eid]["生命"] <= 0  then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] and wglw(WAR.Person[j]["人物编号"],129)>1 and WAR.Person[j]["人物编号"] ~= pid then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 80
				local p = WAR.Person[j]["人物编号"]
				local x1=WAR.Person[j]["坐标X"]
	            local y1=WAR.Person[j]["坐标Y"]
                WAR.LHBT[p] = {WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"]}
			end
		end
	end
 
	--活体炸弹，燃木领悟
	if JY.Person[eid]["生命"] <= 0 and wglw(pid,65)>2 and DWPD() then
		local dam = math.modf((JY.Person[eid]["灼烧程度"]/5)*(JY.Person[eid]["内力最大值"]/20))
		WAR.HTZD = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
	end
 
 	if JY.Person[eid]["生命"] <= 0 and WAR.XDLZ2[eid]~=nil and DWPD() then--血爆
		local dam = math.modf(JY.Person[eid]["内力最大值"]/20)
				for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local bdid = WAR.Person[i]["人物编号"]
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 4 and offset2 <= 4 then
					WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
					WAR.LXXS[bdid] = 1
					WAR.LXZT[bdid] = (WAR.LXZT[bdid] or 0) + math.random(10,20)
					if WAR.LXZT[bdid] >= 100 then
					WAR.LXZT[bdid] = 100
					end
					WAR.XQZZ[bdid]=(WAR.XQZZ[bdid] or 0) + 5
					JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
					if JY.Person[bdid]["生命"] < 0 then
						JY.Person[bdid]["生命"] = 0
					end
					WAR.TXXS[bdid] = 1
				end
			end
		end
		WAR.Person[enemyid]["特效动画"] = 89
	end
 
  	if JY.Person[eid]["生命"] <= 0 and WAR.LRHF[eid]~=nil and DWPD() then----冰爆
		local dam = JY.Person[eid]["冰封程度"]*10
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local bdid = WAR.Person[i]["人物编号"]
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 4 and offset2 <= 4 then
					WAR.Person[i]["内力点数"] = (WAR.Person[i]["内力点数"] or 0) - dam
					WAR.BFXS[bdid] = 1
					JY.Person[bdid]["冰封程度"] = JY.Person[bdid]["冰封程度"] + math.random(10,20)
					if JY.Person[bdid]["冰封程度"] >= 100 then
					JY.Person[bdid]["冰封程度"] = 100
					end
					JY.Person[bdid]["内力"] = JY.Person[bdid]["内力"] - dam
					if JY.Person[bdid]["内力"] < 0 then
						JY.Person[bdid]["内力"] = 0
					end
					WAR.TXXS[bdid] = 1
				end
			end
		end
		WAR.Person[enemyid]["特效动画"] = 89
	end
 
  	if JY.Person[eid]["生命"] <= 0 and WAR.L_HBJD[eid]~=nil and DWPD() then----红冰爆炸
				local s = WAR.CurID
				WAR.CurID = enemyid	
				WarDrawMap(0)
				CurIDTXDH(WAR.CurID, 41,1, "红冰异物.爆发", C_RED)
				WAR.CurID =  s
		local dam = (WAR.LXZT[eid] or 0)*2
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local bdid = WAR.Person[i]["人物编号"]
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 4 and offset2 <= 4 then
                    WAR.JHLY2[bdid] = dam
					WAR.TXXS[bdid] = 1
				end
			end
		end
		local dam2 = math.modf(((WAR.LXZT[eid] or 0)/5)*(JY.Person[eid]["内力最大值"]/20))
		WAR.HTZD = {dam2, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]}
		WAR.Person[enemyid]["特效动画"] = 89
	end
 
  	--无酒不欢：魔帝噬魂
	if JY.Person[eid]["生命"] <= 0 and match_ID_awakened(pid, 26, 1) then
	    if  JY.Person[eid]["内力"]>0  then
		WAR.MDSH = JY.Person[eid]["内力"]
		else--17-1-1
		WAR.MDSH = -1
		end
	end
  
   	--无酒不欢：燃灯引爆
	if JY.Person[eid]["生命"] <= 0 and WAR.WMYH[eid]~=nil and WAR.WMYH[eid]>0 and match_ID(pid, 65) then
       WAR.MDSH = JY.Person[eid]["内力"]
	end
  
  	--无酒不欢：苗人凤火凤燎原
	if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 3) and match_ID_awakened(pid, 3, 1) then
		WAR.HFLY = 1
	end
  
  
    if WAR.BMXH>0 and PersonKF(eid,179) then
       WAR.BMXH = 0
    end	
  
	--北冥神功和吸星大法，加内力上限
	if (WAR.BMXH == 1 or WAR.BMXH == 2 ) and 0 < hurt and DWPD() then
		local xnl = nil
		xnl = math.modf(JY.Person[eid]["内力"] * 0.07)
		if xnl > 300 then
			xnl = 300
		end
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", math.modf(xnl + 1))
		AddPersonAttrib(pid, "内力最大值", math.modf(xnl * 10 + 1))
		--畅想无崖子发动北冥时吸取属性
		if WAR.BMXH == 1 and (match_ID(pid, 116) or nglw(pid,85)>2) and pid == 0 then
			AddPersonAttrib(pid, "攻击力", 2)
			AddPersonAttrib(pid, "防御力", 2)
			AddPersonAttrib(pid, "轻功", 2)
		end
	end
	  
	--化功大法 上毒 减内力
	if WAR.BMXH == 3 and 0 < hurt and DWPD() then
		local xnl = nil
		xnl = math.modf(JY.Person[eid]["内力"] * 0.05)
		if xnl < 100 then
			xnl = 100
		elseif xnl > 300 then
			xnl = 300
		end
		WAR.Person[enemyid]["内力点数"] = AddPersonAttrib(eid, "内力", -xnl);
		WAR.Person[enemyid]["中毒点数"] = AddPersonAttrib(eid, "中毒程度", math.random(16,20))
	end
  
	--吸星大法，一般人吸3-4体力
	if WAR.BMXH == 2 and 0 < hurt and DWPD() then
		local xt1 = 3 + Rnd(2)
		local xt2 = 0
		local n = AddPersonAttrib(eid, "体力", -xt1)
		local m = AddPersonAttrib(pid, "体力", xt1)
		
		--任我行 额外吸3体力
		if match_ID(pid, 26) then
			n = n + AddPersonAttrib(eid, "体力", -3)
			m = m + AddPersonAttrib(pid, "体力", 3)
		end
			--任我行 额外吸3体力
		if match_ID(pid, 26) then
			n = n + AddPersonAttrib(eid, "体力", -3)
			m = m + AddPersonAttrib(pid, "体力", 3)
		end

		if nglw(pid, 88)>=1 and WAR.LXZT[eid]~=nil and WAR.LXZT[eid]>0 then
		    local lx=math.modf(WAR.LXZT[eid]/2)
		    xt2 = lx + 5*xt1
			local n1 = AddPersonAttrib(eid, "生命", -xt2)
		    local m1 = AddPersonAttrib(pid, "生命", xt2)
 		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + n1;
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + m1; 		
		end

		if nglw(pid, 88)>2  then
		    local xf=math.modf(xt1*200)
	    	WAR.XXQF[eid]=WAR.XXQF[eid] or 0 + xf
			WAR.XXQG[pid]=WAR.XXQG[pid] or 0 + xf
		end
		
		WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + n;
		WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + m;
	end

	if (WAR.BMXH == 4) and 0 < hurt and DWPD() then
		local xnl = nil
		xnl = math.modf(JY.Person[eid]["内力"] * (0.07+nglw(eid,166)*0.01))
		if xnl > 300+nglw(pid,166)*50 then
			xnl = 300+nglw(pid,166)*50
		end
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", math.modf(xnl + 1))
		AddPersonAttrib(pid, "内力最大值", math.modf(xnl * 10 + 1))
        if nglw(pid,166)>2 then
			  WAR.PJZT[eid] = 50
			  local aa = JY.Person[eid]["主运内功"]
			  if WAR.PJJL[eid] == nil then
			     WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		      end
		      JY.Person[eid]["主运内功"] = 0
			  WAR.NWHD[pid] = aa
	          WAR.NWCX[pid] = 50
		end
	end
	
	if WAR.DSXF>0 and 0 < hurt and DWPD()   then
        local xnl = nil
		xnl = math.modf(JY.Person[eid]["中毒程度"] * 2.5)	
		if xnl < 100 then
			xnl = 100
		elseif xnl > 300 then
			xnl = 300
		end
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);	
        WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", math.modf(xnl *0.5))	
	end

	if WAR.XLAY_DZ == 2 and 0 < hurt and DWPD() then
		local xnl = WAR.XLAY_LH *50
		local xnl2 = 0
		if WAR.XLAY_LH >= 10 then
		xnl = 0
		xnl2 = WAR.XLAY_LH *15
		elseif xnl >= JY.Person[eid]["内力"] then
		xnl2 = math.modf((xnl - JY.Person[eid]["内力"])*0.3)
		else
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", math.modf(xnl + 1))
 		WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -xnl2);
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", xnl2); 
		end
        WAR.BMXH = 0.5		
	end	

    if  wglw(pid,2)>=2  and WAR.BMXH>0 and 0 < hurt and DWPD() then		
		local xnl = nil
		xnl = math.modf(JY.Person[eid]["内力"] * (0.07+wglw(eid,2)*0.01))		
		if xnl > 300+wglw(pid,2)*50 then
			xnl = 300+wglw(pid,2)*50
		end
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
		WAR.GTJIQI = WAR.GTJIQI + 2*xnl
		WAR.GTPID = pid
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "逍遥.鲲鹏诀"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "逍遥.鲲鹏诀"
		end		
	end	
	
	if WAR.ZJZC >=1 and 0 < hurt and DWPD() then
	AddPersonAttrib(pid, "内力最大值", 100)
	end
	
	--主运北冥挨打也吸内
	if Curr_NG(eid, 85) and 0 < hurt and DWPD() then
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -200)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", 200)
		AddPersonAttrib(eid, "内力最大值", 2000)
		WAR.Person[enemyid]["特效动画"] = 63
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "百川入海"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "百川入海"
		end
	end
	
	--主运吸星挨打也吸内
	if Curr_NG(eid, 88) and 0 < hurt and DWPD() then
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -200)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", 100)
		AddPersonAttrib(eid, "内力最大值", 1000)
		WAR.Person[enemyid]["特效动画"] = 71
		if nglw(eid, 88)>2  then
		    local xt1 = 3 + Rnd(2)
		    local xf=math.modf(xt1*200)
	    	WAR.XXQF[pid]=WAR.XXQF[pid] or 0 + xf
			WAR.XXQG[eid]=WAR.XXQG[eid] or 0 + xf
		end
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "万物相吸"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "万物相吸"
		end
	end

	--主运天池护体吸内
	if Curr_NG(eid, 166) and WAR.NGHT>0 and DWPD() then
        local aa =200
		local str = "天池玄吸"
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -aa)
		WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", math.modf(aa/2))
		AddPersonAttrib(eid, "内力最大值", 1000)
		WAR.Person[enemyid]["特效动画"] = 63
		   if nglw(eid,166)>1 and JLSD(10,60,eid) then
			  WAR.PJZT[pid] = 50
			  local aa = JY.Person[pid]["主运内功"]
			  if WAR.PJJL[pid] == nil then
			     WAR.PJJL[pid] = JY.Person[pid]["主运内功"]
		      end
		      JY.Person[pid]["主运内功"] = 0
			  if nglw(eid,166)>2  then
			  WAR.NWHD[eid] = aa
			  end
	          WAR.NWCX[eid] = WAR.PJZT[pid]
			  WAR.NYHD[eid] = WAR.PJZT[pid]
			  str = "禁断."..str
		   end

		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = str
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. str
		end
	end

      if wglw(eid,3)>=2 then
		if  WAR.JCGD[pid]~=nil and WAR.JJGD[pid]~=nil and JY.Person[eid]["生命"] >= 0 then
		    local reduction = math.modf(JY.Person[pid]["中毒程度"]*2.5)
			WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -reduction)
            WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", reduction)	
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "五毒.虫蛊反噬"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "五毒.虫蛊反噬"
		end			
		end
	  end	

      if wglw(eid,3)>=2 then
		if  WAR.JCGD[pid] ==nil then
		    WAR.JCGD[pid] = 50
			WAR.JJGD[pid] = math.random(1,3+wglw(eid,3))
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "五毒.护主虫卵"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "五毒.护主虫卵"
		end			
		end
	  end
	
	--主运化功挨打也吸内+上毒
	if Curr_NG(eid, 87) and 0 < hurt and DWPD() then
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -200)
		WAR.Person[WAR.CurID]["中毒点数"] = AddPersonAttrib(pid, "中毒程度", math.random(10,15))
		WAR.Person[enemyid]["特效动画"] = 64
		if WAR.Person[enemyid]["特效文字1"] == nil then
			WAR.Person[enemyid]["特效文字1"] = "化功大法"
		else
			WAR.Person[enemyid]["特效文字1"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "化功大法"
		end
	end

		   if Curr_NG(eid, 166) and nglw(eid,166)>2 and WAR.BHJS[eid] ~=nil then
		      local aa = 200
   		      WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -aa)
		      WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", math.modf(aa/2))
			 if WAR.Person[enemyid]["特效文字3"] == nil then
			    WAR.Person[enemyid]["特效文字3"] = "吸功.无漏仙体"
		     else
			    WAR.Person[enemyid]["特效文字3"] = WAR.Person[enemyid]["特效文字1"] .. "+" .. "吸功.无漏仙体"
		     end
		   end


	
	--被虚竹生死符击中的
	if WAR.TZ_XZ == 1 and DWPD() then
	
	    if WAR.LYLZ[pid]~=nil and WAR.LYLZ[pid] == 3 then
		WAR.YANGFU[pid] = (WAR.YANGFU[pid] or 0) + 20
		if WAR.YANGFU[pid]>= 50 then
		WAR.YANGFU[pid] = 50
		end
		end
		
	    if WAR.TZ_XZ_SSH[eid] ~=nil and wglw(pid,8)>=2 then--
		   reseteffect2(WAR.TZ_XZ_SSH, eid, 1)
		   local txwz={"少阳.佛度拜火","阳明.迦叶洞悉","太阳.烈阳穿云","少阴.灵妖拜月","厥阴.修罗化魄","太阴.玄阴满天"}
		   local aa = WAR.LYLZ[pid] or 0
		   if aa == 0 then
		   aa = 1
		   WAR.LYLZ[pid] = 1
		   end
           local str = txwz[aa]		   
		   Set_Eff_Text(enemyid, "特效文字0", str)
		   if  aa ==1 then
           JY.Person[eid]["灼烧程度"] = limitX((JY.Person[eid]["灼烧程度"] or 0) + 10, 0, 50)
		      if JY.Person[eid]["灼烧程度"]>= 25 then
		         WAR.JHLY[eid] = limitX((WAR.JHLY[eid] or 0) + 10, 0, 50)
		      end
		   elseif aa ==2 then
                WAR.JHLY3[eid] = limitX((WAR.JHLY3[eid] or 0) + 10, 0, 50)  
		   elseif aa ==3 then
		        local bb = WAR.LQZ[eid] or 0
				WAR.LQZ[eid] = 0
				WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命",-bb)
		        WAR.WMYH[eid] = 30
				WAR.HOT[eid] = 30
			elseif aa ==4 then
			    JY.Person[eid]["冰封程度"] = limitX((JY.Person[eid]["冰封程度"] or 0) + 20, 0, 100)
			  if JY.Person[eid]["冰封程度"]>= 50 then
			     local bb = JY.Person[eid]["冰封程度"]*3
		         WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力",-bb)
		      end
		   elseif aa ==5 then
		       WAR.PJZT[eid] = 50
			  if WAR.PJJL[eid] == nil then
			     WAR.PJJL[eid] = JY.Person[eid]["主运内功"]
		      end
		      JY.Person[eid]["主运内功"] = 0
			elseif aa ==6 then
		       WAR.HDQM[eid] = 50
			   WAR.ICE[eid] = 50
		   end
		end
	   
	    if match_ID_awakened(pid,49,1) then----
		local bb = math.random(1,3)
		addeffect2(WAR.TZ_XZ_SSH,eid,bb)
		else
		WAR.TZ_XZ_SSH[eid] = 1
		end
	end
  
	--中毒计算
	local poisonnum = math.modf(level * JY.Wugong[wugong]["敌人中毒点数"] + 5 * JY.Person[pid]["攻击带毒"])
		if JY.Person[pid]["武器"] == 202 and  wglw(pid,72)>2  then
		poisonnum = poisonnum+100
	    end
		if wglw(pid,40)>=1 then
		poisonnum = poisonnum+100
		end
	if ((JY.Person[eid]["抗毒能力"] < poisonnum  and dng == 0) or wglw(pid,40)>=1 or WAR.YZSG[eid]~=nil ) and match_ID(pid, 48)==false and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
		if WAR.Person[enemyid]["我方"] then
			poisonnum = math.modf(poisonnum / 10 - JY.Person[eid]["抗毒能力"]/10 - JY.Person[eid]["内力"] / 200)
		else
			poisonnum = math.modf(poisonnum / 15 - JY.Person[eid]["抗毒能力"]/5 - JY.Person[eid]["内力"] / 150)
		end
		if wglw(pid,40)>0 and  PersonKF(pid,40) then
		poisonnum = math.modf(poisonnum+JY.Person[eid]["抗毒能力"]/5+math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5))/50))
		end
		if WAR.YZSG[eid]~=nil then
		poisonnum = poisonnum+math.modf(JY.Person[eid]["抗毒能力"]/5+JY.Person[eid]["内力"] / 150)
		poisonnum = poisonnum * 2
		end
		if wglw(pid,3)>=1 then
		poisonnum = poisonnum*2
		   if wglw(pid,3)>=2 then
		      if  WAR.JCGD[eid] ~= nil and WAR.JJGD[eid] == nil then
		   	      WAR.JJGD[eid] = math.random(1,3+wglw(pid,3))
                  Set_Eff_Text(enemyid, "特效文字0", "五毒.蛊转")				  
		      end
		   end
		end
		if  Curr_NG(eid, 180) then --灵蛇玄功减少中毒
			poisonnum = math.modf(poisonnum*0.7)
		end
		if nglw(eid,99)>=1 then
		poisonnum = 0
		end

		if poisonnum < 0 then
			poisonnum = 0
		end
		--太玄之轻免疫中毒
		if WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] == 1 then
			poisonnum = 0
		end
		if wglw(eid,40)>=1 then
		poisonnum = 0
		end
		WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", math.modf(myrnd(poisonnum)))
		if wglw(pid,3)>=1 then
		   if JY.Person[eid]["中毒程度"]>= 50 and WAR.JCGD[eid] == nil  and WAR.JJGD[eid] == nil then
		      WAR.JCGD[eid] = 50
			  Set_Eff_Text(enemyid, "特效文字0", "五毒.蛊卵寄生")
		   end
		end
		if JY.Person[pid]["武器"] == 202 and  wglw(pid,72)>2  then
			if JY.Person[eid]["中毒程度"]>= 50  then
		      WAR.QSLZ[eid] = 50
		   end
	    end
	end
	
  --蓝烟清：发动蟾震九天时中毒40点
  if WAR.L_CZJT == 1 and DWPD() then	
  	local n = 10 
	if match_ID(pid, 61) then --欧阳克加5-10点
		n = n + math.random(5, 10)
	end
	if Curr_NG(pid, 95) then --主功体蛤蟆功蟾震追加中毒
		n = n + math.modf(WAR.tmp[200 + pid] / 10);				
  	end
  	WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0 ) + AddPersonAttrib(eid, "中毒程度", n);
	WAR.tmp[200 + pid] = 0
  end
	
	WAR.NGHT = 0
	WAR.FLHS4 = 0
	WAR.FLHS4_2 = 0
	WAR.BDRS1 = 0
	WAR.B_BMJQ = 0
	WAR.LGQJ = 0
	WAR.TJYQ2 = 0
	WAR.WSMC = 0
	if WAR.YHLP>0  then
	WAR.YHLP = 0
	WAR.PZPID = -1
	end

    
WAR.TGDQ4 = 0
WAR.TGDQ2 = 0
WAR.TGDQ6 = 0	
        WAR.QMZT = 0


	


if WAR.TJYL[pid] ~= nil then 
local aa = WAR.TJYL[pid]
        WAR.FXDS[pid] = limitX((WAR.FXDS[pid]  or 0) + (WAR.FXDS[eid] or 0)*aa, 0, 50)	
		WAR.FXXS[pid] = 1
		WAR.FXDS[eid] = nil
        WAR.CHZ[pid] = limitX((WAR.CHZ[pid]  or 0) + (WAR.CHZ[eid] or 0)*aa, 0, 100)		
		WAR.CHXS[pid] = 1
		WAR.CHZ[eid] = nil
        WAR.MBZ[pid] = limitX((WAR.MBZ[pid]  or 0) + (WAR.MBZ[eid] or 0)*aa, 0, 100)		
		WAR.MBXS[pid] = 1
		WAR.MBZ[eid] = nil
	    WAR.LXZT[pid] = limitX((WAR.LXZT[pid] or 0) + (WAR.LXZT[eid] or 0)*aa , 0, 100)
		WAR.LXXS[pid] = 1
		WAR.LXZT[eid] = nil
        JY.Person[pid]["冰封程度"] = limitX((JY.Person[pid]["冰封程度"] or 0) + JY.Person[eid]["冰封程度"]*aa, 0, 100)
        JY.Person[pid]["灼烧程度"] = limitX((JY.Person[pid]["灼烧程度"] or 0) + JY.Person[eid]["灼烧程度"]*aa, 0, 50)
		JY.Person[eid]["冰封程度"] = 0
		JY.Person[eid]["灼烧程度"] = 0
		WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度",JY.Person[eid]["中毒程度"]*aa)
		WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度",JY.Person[eid]["受伤程度"]*aa)
		AddPersonAttrib(eid, "受伤程度", -100)
		AddPersonAttrib(eid, "中毒程度", -100)
		WAR.TXXS[pid] = 1
		if aa>=2 then
		   if WAR.FXDS[pid]>=50 and JLSD(10,60,pid)  then
		   WAR.SKWJ[pid] = 30	   
		   end
		   if WAR.LXZT[pid]>=100 and JLSD(10,60,pid)  then
		   WAR.QBLY[pid] = 30	   
		   end
		   if WAR.CHZ[pid]>=100 and JLSD(10,60,pid)  then
		   WAR.LSQ[pid] = 30	   
		   end
		   if WAR.MBZ[pid]>=100 and JLSD(10,60,pid)  then
		   WAR.XRZT[pid] = 30	   
		   end
		   if JY.Person[pid]["灼烧程度"]>=50 and JLSD(10,60,pid)  then
		   WAR.JHLY3[pid] = 30	   
		   end
		   if JY.Person[pid]["冰封程度"]>=100 and JLSD(10,60,pid)  then
		   WAR.HDQM[pid] = 30	   
		   end
		   if JY.Person[pid]["受伤程度"]>=50 and JLSD(10,60,pid)  then
		   WAR.NKZT[pid] = 30	   
		   end
		   if JY.Person[pid]["中毒程度"]>=50 and JLSD(10,60,pid)  then
		   WAR.QSLZ[pid] = 30	   
		   end
		end		
		WAR.TJYL[pid] = nil 
	end
	
	--行动后不显示血条
	WAR.ShowHP = 0

	if WAR.Person[enemyid]["特效文字2"] == nil then
		WAR.Person[enemyid]["特效文字2"] = "  "
	end
	--误伤不显示动画
	if DWPD() == false then
		WAR.Person[enemyid]["特效动画"] = -1
		WAR.Person[enemyid]["特效文字0"] = nil
		WAR.Person[enemyid]["特效文字1"] = nil
		WAR.Person[enemyid]["特效文字2"] = nil
		WAR.Person[enemyid]["特效文字3"] = nil
		WAR.Person[enemyid]["特效文字4"] = nil
	end
	--被血刀老祖击杀的人物该回合显示动画
	if WAR.XDLZ[eid] ~= nil then
		WAR.Person[enemyid]["特效动画"] = 123
		WAR.XDLZ[eid] = nil
	end
	return limitX(hurt, 0, hurt);
end

-- 绘制战斗地图
-- flag=0  绘制基本战斗地图t
--     =1  显示可移动的路径，(v1,v2)当前移动坐标，白色背景(雪地战斗)
--     =2  显示可移动的路径，(v1,v2)当前移动坐标，黑色背景
--     =3  命中的人物用白色轮廓显示
--     =4  战斗动作动画  v1 战斗人物pic, v2贴图所属的加载文件id
--                       v3 武功效果pic  -1表示没有武功效果
function WarDrawMap(flag, v1, v2, v3, v4, v5, ex, ey,px,py)
	local x = WAR.Person[WAR.CurID]["坐标X"]
	local y = WAR.Person[WAR.CurID]["坐标Y"]
	if not v4 then
		v4 = JY.SubScene
	end
	if not v5 then
		v5 = -1;
	end
 
	px = px or 0
	
	py = py or 0
 
	if flag == 0 then
		lib.DrawWarMap(0, x, y, 0, 0, -1, v4)
	elseif flag == 1 then
		--胡斐居，雪山，有间客栈，凌霄城，北京城，华山绝顶
		if v4 == 0 or v4 == 2 or v4 == 3 or v4 == 39 or v4 == 107 or v4 == 111 then
			lib.DrawWarMap(1, x, y, v1, v2, -1, v4)
		else
			lib.DrawWarMap(2, x, y, v1, v2, -1, v4)
		end
	elseif flag == 2 then
			lib.DrawWarMap(3, x, y, 0, 0, -1, v4)
	elseif flag == 4 then
		lib.DrawWarMap(4, x, y, v1, v2, v3, v4,v5, ex, ey, px, py)
	--单人动画
	elseif flag == 6 then
		lib.DrawWarMap(6, x, y, v1, v2, v3, v4,v5, ex, ey, px, py)

	--防御动画
	elseif flag == 7 then
		lib.DrawWarMap(7, x, y, 0, 0, v3, v4,v5, ex, ey, px, py)

	end
  
	if WAR.ShowHead == 1 then
		WarShowHead()
	end
	
	if CONFIG.HPDisplay == 1 then
		if WAR.ShowHP == 1 then
			HP_Display_When_Idle()	--常态显血
		end
	end
end

--敌方战斗数据
function WarSelectEnemy()


	if PNLBD[WAR.ZDDH] ~= nil then
		PNLBD[WAR.ZDDH]()
	end

  
  --日本战数据  
  for i = 1, 20 do
    if WAR.Data["敌人" .. i] > 0 then
    	
    	if WAR.ZDDH == 226 and GetS(86, 1, 9, 5) == 1 then		--把练功点改成挑战四神组合
    		if GetS(86, 2, 1, 5) == 3 then				--张三丰和乔峰
    			WAR.Data["敌人1"] = 5;
    			WAR.Data["敌人2"] = 50;
    		elseif GetS(86, 2, 2, 5) == 3 then		--张三丰和东方不败
    			WAR.Data["敌人1"] = 5;
    			WAR.Data["敌人2"] = 27;
    		elseif GetS(86, 2, 3, 5) == 3 then		--张三丰和扫地神僧
    			WAR.Data["敌人1"] = 5;
    			WAR.Data["敌人2"] = 114;
    		elseif GetS(86, 2, 4, 5) == 3 then		--乔峰和东方不败
    			WAR.Data["敌人1"] = 50;
    			WAR.Data["敌人2"] = 27;
    		elseif GetS(86, 2, 5, 5) == 3 then		--乔峰和扫地神僧
    			WAR.Data["敌人1"] = 50;
    			WAR.Data["敌人2"] = 114;
    		elseif GetS(86, 2, 6, 5) == 3 then		--东方不败和扫地神僧
    			WAR.Data["敌人1"] = 27;
    			WAR.Data["敌人2"] = 114;
    		elseif GetS(86, 2, 7, 5) == 3 then		--张三丰、东方不败和扫地神僧
    			WAR.Data["敌人1"] = 5;
    			WAR.Data["敌人2"] = 27;
    			WAR.Data["敌人3"] = 114;
    		elseif GetS(86, 2, 8, 5) == 3 then		--张三丰、乔峰和扫地神僧
    			WAR.Data["敌人1"] = 5;
    			WAR.Data["敌人2"] = 50;
    			WAR.Data["敌人3"] = 114;
    		elseif GetS(86, 2, 9, 5) == 3 then		--张三丰、乔峰和东方不败
    			WAR.Data["敌人1"] = 5;
    			WAR.Data["敌人2"] = 50;
    			WAR.Data["敌人3"] = 27;
    		elseif GetS(86, 2, 10, 5) == 3 then		--乔峰、东方不败和扫地神僧
    			WAR.Data["敌人1"] = 50;
    			WAR.Data["敌人2"] = 27;
    			WAR.Data["敌人3"] = 114;
    		end
    		
    		WAR.Data["敌方X1"] = 45;
				WAR.Data["敌方Y1"] = 36;
				WAR.Data["敌方X2"] = 45;
				WAR.Data["敌方Y2"] = 28;
				WAR.Data["敌方X3"] = 52;
				WAR.Data["敌方Y3"] = 28;
				WAR.Data["敌方X4"] = 52;
				WAR.Data["敌方Y4"] = 36;
    	end
    	
		if WAR.ZDDH == 226 and GetS(86,20,20,5) == 3 then		--brolycjw：战欧阳锋鸠摩智		
				WAR.Data["敌人1"] = 60;
				WAR.Data["敌人2"] = 103;
				SetS(86,20,20,5,0);	--临时存放
		end
		
		if WAR.ZDDH == 79 then
    		if GetS(86, 11, 12, 5) == 1 then			--brolycjw：杀金轮
    			WAR.Data["敌人1"] = 62;
					WAR.Data["敌方X1"] = 21
					WAR.Data["敌方Y1"] = 30
				elseif GetS(86,15,2,5) > 0 then
	    		if GetS(86,15,2,5) == 1 then			--队友初级挑战
						local enemy = {3,184,67,98,118,164}
						local pick = math.random(6)
						WAR.Data["敌人1"] = enemy[pick]
					elseif GetS(86,15,2,5) == 2 then			--队友中级挑战
						local enemy = {62,65,71,103,69,6}
						local pick = math.random(6)
						WAR.Data["敌人1"] = enemy[pick]
					elseif GetS(86,15,2,5) == 3 then			--队友高级挑战
						local enemy = {129,64,26,60,57}
						local pick = math.random(5)
						WAR.Data["敌人1"] = enemy[pick]
					elseif GetS(86,15,2,5) == 4 then			--队友神级挑战
						local enemy = {5,27,50,114}
						local pick = math.random(4)
						WAR.Data["敌人1"] = enemy[pick]			
					end
					
					WAR.Data["敌方X1"] = 45;
					WAR.Data["敌方Y1"] = 15;
				end
    	end
    	
    	if WAR.ZDDH == 92 and GetS(87,31,33,5) == 1 then		--冰糖恋：单挑陈达海
     		for i=2,5 do	
	 			WAR.Data["敌人" .. i] = -1;
     		end
		end
			
			--冰糖恋：单挑瓦尔拉齐
			if WAR.ZDDH == 91 and GetS(87,31,34,5) == 1 then
				WAR.Data["敌人1"] = 138
		    for i=2,12 do
			 		WAR.Data["敌人" .. i] = -1;
		    end
			end

		if WAR.ZDDH == 20 and GetS(87,31,35,5) == 1 then
   		 	WAR.Data["敌人1"] = 9999;--临时人物数据代替心魔 
		end
   		
		if WAR.ZDDH == 20 and GetS(87,31,35,5) == 2 then
			WAR.Data["敌人1"] = 92
		end

		if WAR.ZDDH == 292 then --大地图挑战
				WAR.Data["敌人1"] = GetS(106, 63, 2, 0)
		end	
			
			--蓝烟清：重新摆十八铜人的位置，单挑时的位置
			--[[
			if WAR.ZDDH == 217 and GetS(86,1,2,5) == 1 then
				--把三个铜人放在门口位置
				WAR.Data["敌方X16"] = 40
				WAR.Data["敌方Y16"] = 40
				
				WAR.Data["敌方X17"] = 40
				WAR.Data["敌方Y17"] = 38
				
				WAR.Data["敌方X18"] = 40
				WAR.Data["敌方Y18"] = 42
			end
			
			--蓝烟清：重新摆十八铜人的位置，群战时的位置
			if WAR.ZDDH == 217 and GetS(86,1,2,5) == 2 then
				for i=1,9 do
					WAR.Data["敌方X" .. i] = 22
					WAR.Data["敌方Y" .. i] = 32 + i;
				end
				
				for i=10, 18 do
					WAR.Data["敌方X" .. i] = 27
					WAR.Data["敌方Y" .. i] = 32 + (i-9);
				end
			end]]
			
		--无酒不欢：新论剑敌人
		if WAR.ZDDH == 266 then
			WAR.Data["敌人1"] = GetS(85, 40, 38, 4)
		end
			
    	WAR.Person[WAR.PersonNum]["人物编号"] = WAR.Data["敌人" .. i]
		WAR.Person[WAR.PersonNum]["我方"] = false
		WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["敌方X" .. i]
		WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["敌方Y" .. i]
		WAR.Person[WAR.PersonNum]["死亡"] = false
		WAR.Person[WAR.PersonNum]["人方向"] = 1
		--无酒不欢：调整战斗初始面向
		--战海大富
	  	if WAR.ZDDH == 259 then
			WAR.Person[WAR.PersonNum]["人方向"] = 2
		end
		--双挑公孙止
		if WAR.ZDDH == 273 then
			WAR.Person[WAR.PersonNum]["人方向"] = 3
		end
		--杨过单金轮
		if WAR.ZDDH == 275 then
			WAR.Person[WAR.PersonNum]["人方向"] = 3
		end
		--战杨龙
		if WAR.ZDDH == 75 then
			WAR.Person[WAR.PersonNum]["人方向"] = 3
		end
		--蒙哥
		if WAR.ZDDH == 278 then
			WAR.Person[WAR.PersonNum]["人方向"] = 3
		end
		--芷若夺掌门
		if WAR.ZDDH == 279 then
			WAR.Person[WAR.PersonNum]["人方向"] = 3
		end
		WAR.PersonNum = WAR.PersonNum + 1
		end
	end
end

--无酒不欢：弃用
--战斗人物选择
--[[
function WarSelectTeam()
  WAR.PersonNum = 0
  
  --brolycjw：自定义自动选择参战人
  --设置了之后，会直接战斗，而不可以选择队友
  if WAR.ZDDH == 79 then				--战斗编号
	if GetS(86, 11, 12, 5) == 1 then			--brolycjw：杀金轮
		WAR.Data["自动选择参战人1"] = 0;
		WAR.Data["我方X1"] = 22
		WAR.Data["我方Y1"] = 38
		
		WAR.Data["自动选择参战人2"] = 59;
		WAR.Data["我方X2"] = 23
		WAR.Data["我方Y2"] = 38

	elseif GetS(86,15,2,5) > 0 then
		WAR.Data["自动选择参战人1"] = GetS(86,15,1,5);
	end
  end
  
  --冰糖恋：单挑陈达海
	if WAR.ZDDH == 92 and GetS(87,31,33,5) == 1 then
	  	WAR.Data["自动选择参战人1"] = 0;
	  	WAR.Data["我方X1"] = 43
	  	WAR.Data["我方Y1"] = 25
	end
	
	--冰糖恋：单挑瓦尔拉齐
	if WAR.ZDDH == 91 and GetS(87,31,34,5) == 1 then
  	WAR.Data["自动选择参战人1"] = 0;
  	WAR.Data["我方X1"] = 21
  	WAR.Data["我方Y1"] = 28
	end
	
	--挑战四神，我方位置
	if WAR.ZDDH == 226 and GetS(86, 1, 9, 5) == 1 then
		for i=1, 6 do
			WAR.Data["我方X" .. i] = 48;
			if i < 4 then
				WAR.Data["我方Y" .. i] = 34 - i;
			else
				WAR.Data["我方Y" .. i] = 34 + (i-4)
			end
		end
	end
	
	for i = 1, 6 do
		local id = WAR.Data["自动选择参战人" .. i]
		if id >= 0 then
			--畅想的情况，畅想主角会取代强制出战的队友
			if id == JY.Base["畅想"] then
				WAR.Person[WAR.PersonNum]["人物编号"] = 0
			else
				WAR.Person[WAR.PersonNum]["人物编号"] = id
			end
			WAR.Person[WAR.PersonNum]["我方"] = true
			WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
			WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
			WAR.Person[WAR.PersonNum]["死亡"] = false
			WAR.Person[WAR.PersonNum]["人方向"] = 2
			--无酒不欢：调整战斗初始面向
			--战海大富
			if WAR.ZDDH == 259 then
				WAR.Person[WAR.PersonNum]["人方向"] = 1
			end
			WAR.PersonNum = WAR.PersonNum + 1
		end
	end
  
  if WAR.PersonNum > 0 and WAR.ZDDH ~= 235 then
    return 
  end
  
	for i = 1, CC.TeamNum do
		WAR.SelectPerson[i] = 0
		local id = JY.Base["队伍" .. i]
		if id >= 0 then
			for j = 1, 6 do
				if WAR.Data["手动选择参战人" .. j] == id then
					WAR.SelectPerson[i] = 1
					WAR.MCRS = WAR.MCRS + 1
				end
			end
		end
	end
  
  
  local menu = {}
  for i = 1, CC.TeamNum do
    menu[i] = {"", WarSelectMenu, 0}
    local id = JY.Base["队伍" .. i]
    if id >= 0 then
      menu[i][3] = 1
      local s = JY.Person[id]["姓名"]
      if WAR.SelectPerson[i] == 1 then
			menu[i][1] = "*" .. s
      else
     		menu[i][1] = " " .. s
      end
    end
  end
  
  menu[CC.TeamNum + 1] = {" 结束", nil, 1}
  
	while true do
		Cls()
		local x = (CC.ScreenW - 7 * CC.DefaultFont - 2 * CC.MenuBorderPixel) / 2
		DrawStrBox(x, 10, "请选择参战人物", C_WHITE, CC.DefaultFont)
		local r = ShowMenu(menu, CC.TeamNum + 1, 0, x, 10 + CC.SingleLineHeight, 0, 0, 1, 0, CC.DefaultFont, C_ORANGE, C_WHITE)
		Cls()
		local a = 1
		for i = 1, CC.TeamNum do
			if WAR.SelectPerson[i] > 0 then
				WAR.Person[WAR.PersonNum]["人物编号"] = JY.Base["队伍" .. i]
				WAR.Person[WAR.PersonNum]["我方"] = true
				WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. a]
				WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. a]
				WAR.Person[WAR.PersonNum]["死亡"] = false
				WAR.Person[WAR.PersonNum]["人方向"] = 2
				WAR.PersonNum = WAR.PersonNum + 1
				a = a + 1                                  --无酒不欢：修正战场排位
			end
		end
		if WAR.PersonNum > 0 then
			break;
		end
	end
end]]


function WarCalPersonPic(id)
	
	--local n = 5106
	--n = n + JY.Person[WAR.Person[id]["人物编号"]]["头像代号"] * 8 + WAR.Person[id]["人方向"] * 2
	

	local pid = WAR.Person[id]['人物编号']
	local t = 0
	local n = 5106
	for i = 1,5 do 
		if JY.Person[pid]['出招动画帧数'..i] > 0 then 
			t = JY.Person[pid]['出招动画帧数'..i]
			break
		end
	end

	n = n + WAR.Person[id]["人方向"]*2+ JY.Person[pid]["头像代号"] * 8
	return n
end

--计算标准主角特殊行走贴图
function WarCalPersonPic2(id, gender)
	local n = 5058
	if gender == 1 then
		n = 5010
	end
	n = n + WAR.Person[id]["人方向"] * 12
	return n
end

--已方战斗时选择人物的菜单
function WarSelectMenu(newmenu, newid)
	local id = newmenu[newid][4]
	if WAR.SelectPerson[id] == 0 and WAR.MCRS < 6 then --无酒不欢：限定战斗选人只能选6人
		WAR.SelectPerson[id] = 2
		WAR.MCRS = WAR.MCRS + 1
	else
		if WAR.SelectPerson[id] == 2 then
		  WAR.SelectPerson[id] = 0
		  WAR.MCRS = WAR.MCRS - 1
		end
	end
	if WAR.SelectPerson[id] > 0 then
		newmenu[newid][1] = "*" .. string.sub(newmenu[newid][1], 2)
	else
		newmenu[newid][1] = " " .. string.sub(newmenu[newid][1], 2)
	end
	return 0
end

--战斗是否结束
function War_isEnd()
	for i = 0, WAR.PersonNum - 1 do
		if JY.Person[WAR.Person[i]["人物编号"]]["生命"] <= 0 then
			WAR.Person[i]["死亡"] = true
		end
	end
	WarSetPerson()
	Cls()
	ShowScreen()
	lib.Delay(CC.BattleDelay)
	local myNum = 0
	local EmenyNum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i]["我方"] == true then
				myNum = 1
			else
				EmenyNum = 1
			end
		end
	end

	if EmenyNum == 0 then
		return 1;
	end
	if myNum == 0 then
		return 2;
	end
	return 0
end

--无酒不欢：战斗是否结束2
function War_isEnd2()
	local myNum = 0
	local EmenyNum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i]["我方"] == true then
				myNum = 1
			else
				EmenyNum = 1
			end
		end
	end

	if EmenyNum == 0 then
		return 1;
	end
	if myNum == 0 then
		return 2;
	end
	return 0
end

--设置战斗全局变量
function WarSetGlobal()
  WAR = {}
  WAR.Data = {}
  WAR.SelectPerson = {}
  WAR.Person = {}
  WAR.MCRS = 0 --无酒不欢：每场战斗选的人数
  for i = 0, 30 do
    WAR.Person[i] = {}
    WAR.Person[i]["人物编号"] = -1
    WAR.Person[i]["我方"] = true
    WAR.Person[i]["坐标X"] = -1
    WAR.Person[i]["坐标Y"] = -1
    WAR.Person[i]["死亡"] = true
    WAR.Person[i]["人方向"] = -1
    WAR.Person[i]["贴图"] = -1
    WAR.Person[i]["贴图类型"] = 0
    WAR.Person[i]["轻功"] = 0
    WAR.Person[i]["移动步数"] = 0
    WAR.Person[i]["经验"] = 0
    WAR.Person[i]["自动选择对手"] = -1
    WAR.Person[i].Move = {}
    WAR.Person[i].Action = {}
    WAR.Person[i].Time = 0
    WAR.Person[i].TimeAdd = 0
    WAR.Person[i].SpdAdd = 0
    WAR.Person[i].Point = 0
    WAR.Person[i]["特效动画"] = -1
    WAR.Person[i]["反击武功"] = -1
    WAR.Person[i]["追击武功"] = -1
	WAR.Person[i]["降龙追击"] = -1
	WAR.Person[i]["反击武功2"] = -1
	WAR.Person[i]["协同反击武功"] = -1
	WAR.Person[i]["补刀武功"] = -1
	WAR.Person[i]["追击剑气"] = 0
	WAR.Person[i]["特效文字0"] = nil
    WAR.Person[i]["特效文字1"] = nil
    WAR.Person[i]["特效文字2"] = nil
    WAR.Person[i]["特效文字3"] = nil
	WAR.Person[i]["特效文字4"] = nil	--无酒不欢：加到这里 8-11
	WAR.Person[i]["特效文字5"] = nil
	WAR.Person[i]["先手反击"] = -1
	WAR.Person[i]["反击"] = -1
	WAR.Person[i]["护盾"] = -1
	WAR.Person[i]["斗气"] = -1
	WAR.Person[i]["护盾贴图"] = -1
	WAR.Person[i]["护盾延迟"] = nil
	WAR.Person[i]["斗气贴图"] = -1
	WAR.Person[i]["斗气延迟"] = nil
	WAR.Person[i]["神游太虚"] = nil
	WAR.Person[i]["金刚斗气"] = nil
	WAR.Person[i]["伤害爆裂"] = 0
	WAR.Person[i]["伤害爆裂2"] = 0
	WAR.Person[i]["伤害爆裂_溅射"] = 0
	WAR.Person[i]["雷霆"] = 0
	WAR.Person[i]["幽兰冥种"] = 0
	WAR.Person[i]["精神崩溃"] = 0
  end
  WAR.PersonNum = 0
  WAR.AutoFight = 0
  WAR.CurID = -1
  WAR.SXTJ = 0	--时序
  WAR.SSX_Counter = 0	--三时序计数器
  WAR.WSX_Counter = 0	--五时序计数器
  WAR.LSX_Counter = 0	--六时序计数器
  WAR.JSX_Counter = 0	--九时序计数器
  WAR.YY_Counter = 0
  WAR.LSD_Counter = 0
  WAR.ZSHY = {}	--转瞬红颜计数器
  WAR.ZMKZ = {}
  WAR.WGWL = 0
  WAR.EVENT1 = 0
  WAR.ZYHB = 0
  WAR.GBGJ = 0
  WAR.TJFY = 0
  WAR.LMBJ4 = 0
  WAR.LMBJ5 = 0
  WAR.KHSL = 0
  WAR.ZYHBP = -1
  WAR.ZHB = 0	--周伯通的追加左右判定
  WAR.AQBS = 0	--暗器倍数
  WAR.AQLX = 0
  WAR.BJ = 0
  WAR.BJ2 = 0 --精神暴击
  WAR.XK = 0
  WAR.XK2 = nil
  WAR.YJDD = 1  ---援军
  WAR.TD = -1
  WAR.TDnum = 0
  WAR.HTSS = 0
  WAR.YT1 = 0
  WAR.YT2 = 0
  WAR.ZSF = 0
  WAR.XZZ = 0
  WAR.KFKJ = 0		--封不平狂风快剑
  WAR.KFKJ2 = 0
  WAR.WCY = {}		--一灯复活
  WAR.CYZX = {} 	--王重阳复活
  WAR.BDQS = 0		--王重阳北斗真打状态层数
  WAR.LMZL = 0      --一灯六脉转龙状态层数
  WAR.XLD  = {}		--修罗阿鼻刀状态层数
  WAR.JLL = {}      --八部迦楼罗
  WAR.LSQL = {}
  WAR.XLEB = 0		--修罗阿鼻刀状态层数
  WAR.BDKY = {}     --修罗波动刻印
  WAR.GYZ = {}
  WAR.NQHR = {}
  WAR.YSLS = {}
  WAR.YSDF = 0
  WAR.XLDF = 0		--修罗刀法
  WAR.XLBD = 0
  WAR.LSDF = 0
  WAR.WJDF = 0
  
  
  WAR.CHD = 0       --迦楼罗残火刀
  WAR.QCF = 0		--戚长发复活
  WAR.HTS = 0		--何铁手五毒随机2-5倍威力
  WAR.WXXY1=0
  WAR.AZ=0
  WAR.FS = 0
  WAR.FS2 = 0
  WAR.FS3 = 0
  WAR.XLAY = 0
  WAR.XLAY_BL = 0
  WAR.XLAY_DZ = 0
  WAR.XLAY_LH = 0
  WAR.XLZS = 0
  WAR.XLZS_QH = 0
  WAR.XLZS_QL = 0
  WAR.TSCL = {}
  
  WAR.DYSZ = 0
  WAR.TFH = 0
  WAR.ZBT = 1
  WAR.ZBT1 = {}
  WAR.DHZ_HB = {}
  WAR.ZBT2 = 1
  WAR.ZBT3 = 0
  WAR.KMSH = {}
  if JY.Base["斗神"] == 64 then
  WAR.KMSH[645] = 3
  end
  WAR.DFMQ = 0
  WAR.FMZF = 0
  WAR.WQQ = 0
  WAR.WQQ1 = {}
  WAR.HQT = 0
  WAR.CY = 0
  WAR.FHJ= 0
  WAR.HDWZ = 0
  WAR.ZJZ = 0
  WAR.YJ = 0
  WAR.XMH = 0
  WAR.PYZ = 0
  WAR.PYZ1 = 0
  WAR.YZB = 0
  WAR.YZB2 = 0
  WAR.YZB3 = 0
  WAR.GBWZ = 0
  WAR.GBWZ2 = 0
  WAR.GBWZ3 = 0
  WAR.SSQX = 0
  WAR.BSMT = 0
  WAR.DJGZ = 0
  
  WAR.TONY = 0
  WAR.TONY1 =  0
  WAR.TONY2 =  0
  WAR.TONY3 = 0
  WAR.BZSC = {} 
  
  WAR.WJJS = 0
  WAR.LZPX = 0
  WAR.LXZL = 0
  WAR.WMSF = 0
  WAR.TPHS = 0
  WAR.ZDZY = 1
  WAR.TZNQ = 100
  WAR.TZNQ2 = {}
  WAR.TZWY = 0
  WAR.XYTZ = 0
  WAR.SPT = 0
  WAR.SPT1 = 0
  WAR.DJZS = 0
  WAR.DZDJ = 0
  WAR.JYBG = 0
  
  WAR.TJYQ = 0
  WAR.TJYQ1 = 0
  WAR.TJYQ2 = 0
  
  WAR.MRF = 0
  WAR.MRF1 = 0
  WAR.YANGKANG = 0
  WAR.DZDJ1 = 0
  WAR.DZDJ2 = 0
  WAR.DJGZ3 = 0
  WAR.DJGZ2 = 0
  WAR.QSLX = 0
  WAR.QSLX_SY = 0
  WAR.XMJY = 0
  WAR.KUIHUADZ = 0
  WAR.KUIHUAHJ = 0
  WAR.BFTX = 0
  WAR.BLQJ = 0
  
  
  WAR.DRZT = {}
  WAR.DRFJ = {}
  WAR.DRFJ1 ={}
  WAR.HSDF = 0
  WAR.HSDF_STNJ = 0
  WAR.HSDF_DF = 0
  WAR.HSDF_DF1 = 0
  
  WAR.SW_MTL = 0
  WAR.BBSK = {}
  WAR.WSZJ = 0
  
  WAR.SXJZ = 0
  WAR.YTMX = 0
  
  WAR.PLGF = 0
  WAR.GPQG = 0

  WAR.WYSQ = 0
  WAR.WSDL = 0
  WAR.HDMC = 0
  WAR.HDMC2 = 0
  WAR.BDRS = {}
  WAR.BDR = {}
  WAR.WCLJ=0 --连击判定
  WAR.YXMQ = 0
  WAR.LYBF = 0
  WAR.XLMH = 0
  WAR.DGXF = 0 --打狗心法
  WAR.DGXF_KQ = 0
  WAR.DSXF = 0
  
  
  WAR.XDDF2 = 0
  WAR.RMDY = 0---燃木刀意
  WAR.RMDY2 = 0---燃木刀意
  WAR.HBMZ = 0
  WAR.XYYZ = 0
  WAR.ZBXZ = 0
  WAR.ZBXY = 0
  
  WAR.JGHJ = 0
  WAR.LHHX = 0
  WAR.BRGZ = 0
  WAR.BRGZ2 = 0
  WAR.RWZ = 0
  WAR.BLC = 0
  WAR.SZH = 0
  WAR.SZH2 = 0
 
  WAR.WDZ = 0
  WAR.DJDAO=0 --田归农胡刀
  WAR.DJDAO2 =0
  WAR.WSMC = 0
  WAR.YYDAO=0 --骆冰鸳鸯连环刀
  WAR.YYDAO_PK = 0
  WAR.YYDAO_HB = 0
  WAR.YYDAO_HX = 0

  WAR.JZTX = 0
  WAR.WDLH = 0 --无定连环刀
  WAR.WDLH1 = 0 --无定连环腿
  WAR.WDLH2 = 0
  WAR.DJJIAN=0 --田归农苗剑
   WAR.DJJIAN2=0 --田归农苗剑
  WAR.DJSX = 0
  WAR.DJSX2 = 0
  WAR.HUANJIAN = 0 --幻剑
  WAR.YY=0
  WAR.YY2=0
  WAR.YY3=0
  WAR.HYTZ = 0
  WAR.HYTZ1 = 0
  WAR.XDDF = 0
  WAR.XDXX = 0
  WAR.WS = 0
  WAR.ACT = 1
  WAR.ZDDH = -1
  WAR.NO1 = -1
  WAR.TJAY = 0
  WAR.LYSH = 0 	--两仪守护
  WAR.TKXJ = 0	--太空卸劲
  WAR.WDKTJ = 0	
  WAR.DZXY = 0
  WAR.YTTL = 0
  WAR.FQBD = 0
  WAR.TJXY = {}
  WAR.SQGJ = 0
  WAR.XTCJ = 0
  WAR.POISON={}
  WAR.POISON2={}
  WAR.LXBZ = {}
  
  WAR.DZXYLV = {}
  WAR.DZXYSX = {}
  WAR.DZXY3P = {}
  WAR.MRDZ = {}--无间斗转
  WAR.MJYF = {}
  
  WAR.YTTLLV = {}
  WAR.FQDF1 = {}
  WAR.FQDF2 = {}
  
  WAR.DJHB1={}
  WAR.DJHB2={}
  WAR.DJHB3={}
  WAR.DJHB4={}
  WAR.DJHB5={}
 WAR.DJHB6={}
  WAR.DJHB7={}
  WAR.DJHB8={}
  
  WAR.GSWS1={} --洪七丐世无双
  WAR.GSWS2={} --洪七丐世无双
  WAR.GSWS3= {} -- 郭靖标注
  WAR.GSWS4 = {}
  
  WAR.HZD1={}
  WAR.HZD2={}
  WAR.HZD3={}
  WAR.SZH1 = {}
  
  WAR.HZD={} --鸳鸯刀连环
  WAR.JHFJ={} --剑主大招的剑痕附加
  
  WAR.JSBD = {} --金蛇
  WAR.HQGS=0
  WAR.HQGSTS=0
  WAR.HQGS2=0
  WAR.HQGSTS2=0
 
  WAR.DUIZHAO = 0 --对招17-1-2
  WAR.HEJI = 0 --合体技

  WAR.DOUCE=0 --武骧金星：乾坤皆阵斗策指令
  WAR.AXL=-1 --武骧金星：阿修罗指令
 
  WAR.fthurt = 0
  WAR.NYSH = {}
  WAR.KHYX = {}--17-2-19幻光步
  WAR.LXZQ = 0
  WAR.TWBL = 0
  WAR.JSYX = 0
  WAR.JSYX1 = 0
  WAR.LXYZ = 0
  WAR.ASKD = 0
  WAR.ASKD1 = 0
  WAR.ASKD2 = 0
  WAR.YZHYZ = 0		--刀主大招增加怒气计数
  WAR.GCTJ = 0
  WAR.JSTG = 0		--天罡大招
  WAR.JSTG2 = 0
  WAR.YTML = 0 		--毒王大招
  WAR.YTML1 = 0
  WAR.HFYD = 0
  WAR.HFYD2 = 0
  WAR.BHCQ = 0
  WAR.FMY = 0
  WAR.DLY = 0   --游坦之大招
    WAR.LLH = 0
  WAR.LX_SSF=0  --虚竹大招
  WAR.LMJQ = 0
   WAR.MR_XLWC = 0
  
  WAR.NGXS = 0		--内功攻击的系数
  WAR.TXZZ = 0		--太玄之重
  WAR.WDKTJ = 0	
  WAR.TFBW = 0		--听风辨位的文字记录
  WAR.TLDWX = 0		--天罗地网的文字记录
  WAR.JSAY = 0		--金蛇奥义
  WAR.QJJQ = 0		--七诀剑气
  WAR.JSKW = 0		--金蛇狂舞
  WAR.TLDW = {}	--天罗地网
  WAR.OYFXL = 0 	--欧阳锋根据蛤蟆蓄力增加伤害
  WAR.XDLeech = 0	--血刀吸血量
  WAR.WYXLeech = 0	--韦一笑吸血量
  WAR.JWLeech = 0	--大日吸血量
  WAR.TMGLeech = 0	--天魔功吸血量
  WAR.LKXZLeech = 0	--六库仙贼吸血量
  WAR.XHSJ = 0		--血河神鉴回血量
  WAR.WDRX = 0		--宋远桥使用太极拳或太极剑攻击后自动进入防御状态
  WAR.KMZWD = 0 	--周伯通空明之武道
  WAR.ARJY = 0		--黯然极意
  WAR.ARJY_LZ = 0
  WAR.LFHX = 0 		--林朝英流风回雪
  WAR.XXYY=0--莫大潇湘夜雨
  WAR.YYBJ = 0 		--郭靖：有余不尽
  WAR.YNXJ = 0		--玉女心经：夭矫空碧
  WAR.QQSH1 = 0		--琴棋书画之持瑶琴
  WAR.QQSH2 = 0		--琴棋书画之妙笔丹青
  WAR.QQSH3 = 0		--琴棋书画之倚天屠龙功
  	WAR.SXB = 0 --神仙笔
	WAR.SXB2 = 0
	WAR.XXTT = {}
  
  WAR.YZQS = 0		--一震七伤
  WAR.YZQS1 = 0		--一震七伤
  WAR.LFHM = 0		--夫妻刀三阶鸾凤刀魂
  WAR.LFHM2 = 0
  WAR.JGZB = 0
  WAR.JGZB1 = 0
  WAR.QMHX = 0
  WAR.YZHF = 0
  WAR.TYJQ = 0		--阿青天元剑气
	WAR.OYK = 0 		--欧阳克灵蛇拳
	WAR.OYF = 0
	

	
	WAR.XSBTQ = 0
	WAR.XSBTQ2 = 0
	WAR.XSBTQ3 = 0
	
	WAR.LSZF = 0
	WAR.LSZF1 = 0

	WAR.TMXZ = 0
	WAR.LHT = 0
	WAR.LXFM = 0
  WAR.CMDF = 0		--沧溟刀法
  WAR.NZQK = 0		--逆转乾坤
  WAR.NZQK1 = 0		--逆转乾坤
  WAR.TXXS = {} 	--特效点数显示
  WAR.LHBT = {}
  WAR.BXCF = 0 		--袁承志碧血长风
  WAR.XYYX = 0
  
  WAR.KFCF = 0
  WAR.MDSH = 0
  WAR.HFLY = 0 		--苗人凤火凤燎原
  WAR.FLHS1 = 0
  WAR.FLHS2 = 0
  WAR.FLHS3 = 0
  WAR.FLHS4 = 0
  WAR.FLHS4_2 = 0
  WAR.FLHS5 = 0
  WAR.FLHS6 = 0		--如雷判定
  
  WAR.BDRS1 = 0
  
  WAR.BRZH1 = {}
  WAR.BRZH2 = {}
  WAR.BRZH3 = {}
  WAR.BRZH4 = {}
  WAR.BRZH5 = {}
  WAR.BRZH6 = {}
  
  WAR.RY = {}
  
  WAR.DSTG = {}
  
  WAR.TGDQ1 = 0
  WAR.TGDQ2 = 0
  WAR.TGDQ3 = 0
  WAR.TGDQ4 = 0
  WAR.TGDQ5 = 0
  WAR.TGDQ6 = 0		
  WAR.TGDQ7 = 0
  WAR.TGDQ8 = 0		--如雷判定
  WAR.MSTX = 0
  WAR.MSTX2 = 0
  WAR.WDMZ1 = 0
  WAR.WDMZ2 = 0
  WAR.WDMZ3 = 0
  WAR.WDMZ4 = 0
  WAR.WDMZ5 = 0
  WAR.WDMZ6 = 0		--如雷判定
  WAR.NGJL = 0
  WAR.NGHT = 0
  WAR.QMZT = 0     --黄药师奇门阵图
  WAR.QMDJ ={}
  WAR.TZQJ = 0
  WAR.BMXH = 0
  WAR.ZJZC = 0
  WAR.ZYYD = 0
  WAR.SSFwav = 0
  WAR.LMSJwav = 0
  WAR.DJSwav = 0
  
  WAR.JGZ_DMZ = 0
  WAR.LHQ_BNZ = 0
  WAR.LHQ_FM = 0
  WAR.LHQ_FM2 = 0
  WAR.RMD_FM = 0
  WAR.FMZ_FM = 0
  WAR.XLZ_FM = 0
  WAR.JW_FM = 0
  WAR.LHQ_WX = 0
  WAR.LHQ_WX1 = 0
  
  WAR.LH_DZ = 0
  WAR.SHAOLIN2 = 0
  
  WAR.WD_CLSZ = 0	--赤练神掌
  WAR.BXJY = 0
  WAR.JYS = 3
  WAR.BHHJ = {}
  WAR.XKZ = 0
  WAR.YSSH = 0
  WAR.NLXH =0
  WAR.JQSD = {}
  WAR.ShowHead = 0
  WAR.Effect = 0
  WAR.EffectColor = {}
  WAR.EffectColor[2] = RGB(236, 200, 40)
  WAR.EffectColor[3] = RGB(112, 12, 112)
  WAR.EffectColor[4] = RGB(236, 200, 40)
  WAR.EffectColor[5] = RGB(96, 176, 64)
  WAR.EffectColor[6] = RGB(104, 192, 232)
	WAR.Delay = 0
	WAR.LifeNum = 0
	WAR.EffectXY = nil
	WAR.EffectXYNum = 0
	WAR.tmp = {}
	WAR.HMJT = {} --蛤蟆吞天17-2-23
	WAR.Actup = {}
	WAR.Actup2 = {}
	WAR.Defup = {}
	WAR.Defup2 = {}
	WAR.Wait = {}		--等待指令
	WAR.HMGXL = {}		--蛤蟆蓄力增加300集气
	WAR.Weakspot = {}	--破绽计数
	WAR.KHBX = 0
	WAR.XXPG = 0
	WAR.KHCM = {}
	WAR.KHCM2 = {}
	WAR.LQZ = {}
	WAR.FXDS = {}
	WAR.MLZS = {}
	WAR.FXXS = {}
	WAR.LXZT = {}
  
  
  WAR.SPIRIT = {}
  WAR.SPIRITMAX = {}
  WAR.SPIRITMIN = {}
  WAR.MYCHAIN = 0
  WAR.URCHAIN = 0
  WAR.MYCHAINADD = 0
  WAR.URCHAINADD = 0

	
	WAR.MKDS = {}
	WAR.SDFX = {}
	
	WAR.KHCM3 = {}
    WAR.TJXL = {}
	WAR.TJYL = {}--1-27
    WAR.JTQF = {}
    WAR.WXQQ = {}
    WAR.XLDL = {}
    WAR.DPLX ={}
	
	WAR.CHZ ={}
	WAR.MBZ = {}
	WAR.ICE = {}
	WAR.ICE2 = {}
	WAR.ZLLY = {}
	WAR.FZLY = {}
	WAR.HOT = {}
	WAR.HOT2 = {}
	WAR.HOT2_JH = {}
	WAR.HG = {}
	WAR.BIN = {}
	WAR.BCB = {}
	WAR.YDXT = {} -- 妖蝶形态 
	WAR.YHDF = {} --摄魂偏转
	WAR.BYCX = {} --八音穿心
	WAR.ZXJQ = {} --紫霞混沌剑气
	WAR.QYC = {}
	WAR.DSW = {}
	WAR.KQB = {}
	
	WAR.PEACE = {}
	
	WAR.YHLP = 0
	
	WAR.LCJY1 = {} --水剑意
	WAR.LCJY2 = {} --风剑意
	WAR.LCJY3 = {} -- 雷剑意
	WAR.LCJY4 = {} -- 火剑意
	WAR.LCJY5 = {} -- 天地剑意
	
	WAR.LHXT = {}
	WAR.SPXT = {}
	
	
    WAR.JYHT1 = 0
    WAR.JYHT2 = 0
	WAR.BSCD = 0
	WAR.NYHT = 0
	WAR.XTHT = 0
	WAR.ZXJY = 0
	WAR.LM_JQZZ = 0
	WAR.BHJS = {}
	WAR.BHJS2 = {}
	WAR.TJYM = {}
	
	WAR.MZLL ={}
	WAR.MZLL2 ={}
	WAR.WXZQ = {}
	WAR.QKDS = {}
	
	WAR.SJSD = {}
	WAR.JD_SJSD = {}
	WAR.RXSD = {}
	WAR.WGSD = {}
	WAR.NWSS = {}
	WAR.NWHD = {}
	WAR.NWCX = {}
	WAR.NYHD = {}
	WAR.TLHQ = {}
	WAR.TLXS = {}
    WAR.BZ = {}	
    WAR.WSZ = {}	
	WAR.XXQG = {}
	WAR.XXQF = {}
	WAR.BFXS = {}		--冰封显示
	WAR.ZSXS = {}		--灼烧显示
	WAR.LXXS = {}
	WAR.CHXS = {}
	WAR.MBXS = {}
	WAR.QSLZ = {}       --七死爆毒
	WAR.BPYZ ={}        -- 冰魄银针
	WAR.WJDZ ={}        
	WAR.XLWC = 0
	WAR.WJFJ = 0
	WAR.HDQM = {}
	WAR.SZJPYX = {}
	WAR.TXY=0
	WAR.LMC=0
	WAR.SDYG = 0
	WAR.WSAY=0
	WAR.HD = 0
	WAR.ZBS={}
	WAR.TZ_MRF = 0		--慕容复指令
	WAR.TZ_DY = 0       --段誉指令
	WAR.TZ_XZ = 0       --虚竹指令
	WAR.TZ_XZ_SSH = {} ---生死符
	WAR.LMJQ1 = {}
	WAR.LMJQ2 = {}
	WAR.TLQJ = {}
	WAR.TLQJ2 = {}
	
	WAR.HSZ = {}
	WAR.BFX = 0
	WAR.BSQ = 0
	WAR.BLX = 0
	WAR.BBF = 0 		--必冰封
	WAR.BZS = 0			--必灼烧
	WAR.BCH = 0
	WAR.BMB = 0
	WAR.TXZQ = {}		--太玄之轻
	WAR.GSWS = 0 		--盖世无双
	WAR.JQSDXS = {} 	--无酒不欢：集气速度显示
	WAR.TWLJ = 0 		--天外连击
	WAR.hit_DGQB = 0	--无酒不欢：独孤求败反击的特效显示
	WAR.WXFS = nil		--李秋水无相分身的编号记录
	WAR.JJPZ = {} 		--无酒不欢：九剑破招
	WAR.TKJQ = {}		--太空卸劲减少集气
	WAR.MJZS = {}		--明镜止水反弹杀气
	WAR.JJZC = 0		--九剑真传的4种主动攻击特效
	WAR.JJDJ = 0 		--九剑荡剑式回气
	WAR.Dodge = 0		--判定是否闪避
	WAR.WTL=0           --文泰来否极泰来
	WAR.CXLC = 0		--狄云赤心连城
	WAR.CXLC2 = 0
	WAR.CXLC3 = 0
	WAR.FM_XLD = 0
	WAR.CXLC_Count = 0	--狄云赤心连城计数
	WAR.CXLC_Count2 = 0
	WAR.DGXF_Count = 0
	WAR.XLD_Count = 0
	WAR.TJZX = {}		--太极之形记录
	WAR.CYZY = {}		--纯阳之意记录
	WAR.TJZX_LJ = 0		--太极之形连击
	WAR.TJZX_LJ2 = 0    --太极之形连击效果
	WAR.TJHJ = {}
	WAR.GSSL = {}
	
	WAR.GBGF_LJ = 0
	WAR.NSTJ = {}       --沼跃鱼：张召重火手太极
    WAR.NSTJ1 = 0       --沼跃鱼：张召重火手太极
    WAR.NSTJ2 = 0       --沼跃鱼：张召重火手太极
	
	WAR.MYJY = 0
	WAR.MYZT = {}
	
    WAR.XTDJ = 0
	WAR.FQY = 0			--风清扬无招胜有招
	WAR.WZSYZ = {}		--被无招胜有招击中的人
	WAR.ZXXS = {}		--紫霞蓄力
	WAR.ZXXS2 ={}
	WAR.GMYS = {}		--范遥挨打加减伤
	WAR.GMZS = {}
	WAR.GMZS1 = {}
	WAR.GMYS1 = {}
  
	WAR.JYFX = {}		--brolycjw: 九阳封穴
	WAR.L_TLD = 0;		--装备屠龙刀特效，1流血
	WAR.L_TLD1 = 0
	WAR.L_LWX = 0;		--李文秀特色指令，一次战斗仅限一次
	
	WAR.L_LWX1 = 0
    WAR.L_LWX2 = 0
 	
	  WAR.L_WYJFA1 = 0;
  WAR.L_WYJFA2 = 0;
  WAR.L_WYJFA3 = 0;
  WAR.L_WYJFA4 = 0;
  WAR.L_WYJFA5 = 0;

  WAR.L_NSDF = {};		--南山刀法，有机率使被攻击的单位下回合受到的杀集气和伤害加倍
  WAR.L_NSDFCC = 0;		--南山刀法是否触发特效
  
  WAR.L_TJQ = 0
	
  WAR.L_ZXSG = 0;	 --是否修炼有紫霞神功
  WAR.L_CZJT = 0;	--是否发动蟾震九天
  WAR.L_CZJT1 = 0         --蛤蟆九天17-2-23
	
	WAR.PJTX = 0 		--玄铁剑配玄铁剑法，破尽天下
	WAR.QYBY = {}		--林朝英轻云蔽月，每50时序可触发一次，免疫伤害10时序
	WAR.XZ_YB = {}		--小昭影步记录
	WAR.BDGB = 0
	
	WAR.LSQ = {}		--被灵蛇拳击中的人记录
	WAR.LSQ2 = {}
	WAR.LSZD = {}
	WAR.LSZD1 = {}
	WAR.LSZD2 = {}
	
	
	WAR.LHFM = {}       --罗汉伏魔三阶领悟特效
	WAR.MENG = {}
	WAR.AXFJ = 0			--暗香月影
	WAR.XZYB = 0			--小昭影步
	
	WAR.HP_Bonus_Count = {}	--记录血量翻倍的编号
 
    WAR.BCB1 = 0
	WAR.B_BMJQ = 0;		--北冥真气发动
	WAR.LGQJ = 0
  
  WAR.L_EffectColor = {}		--自定义的战斗颜色显示
  WAR.L_EffectColor[1] = M_Silver;		--显示减少生命
  WAR.L_EffectColor[2] = M_Pink;		--显示增加生命
  WAR.L_EffectColor[4] = M_DeepSkyBlue;		--显示内力减少和增加
  WAR.L_EffectColor[5] = M_PaleGreen;		--显示体力减少和增加
  WAR.L_EffectColor[6] = C_GOLD;		--显示封穴
  WAR.L_EffectColor[7] = M_Red;		--显示流血
  WAR.L_EffectColor[8] = M_DarkGreen;		--显示中毒
  WAR.L_EffectColor[3] = M_LightBlue;		--显示解毒
  WAR.L_EffectColor[9] = RGB(255, 102, 102);		--显示内伤减少和增加
  WAR.L_EffectColor[10] = LightSkyBlue;		--显示冰封
  WAR.L_EffectColor[11] = C_ORANGE;		--显示灼烧
  WAR.L_EffectColor[12] = M_YellowGreen;		--显示迟缓
  WAR.L_EffectColor[13] = M_SandyBrown;		--显示麻痹
  
  WAR.L_DGQB_X = 1;		--独孤求败被攻击的X
  WAR.L_DGQB_DEF = 0;		--初始没有，1被拳攻击，2被指攻击，3被剑攻击，4被刀攻击，5被特攻击，6被内功攻击
  WAR.L_DGQB_ZS = {"独孤一式", "独孤二式", "独孤三式", "独孤四式", "独孤五式", "独孤六式","独孤七式", "独孤八式", "独孤九式", "独孤极意·无招胜有招"};
  WAR.L_DGQB_DEF_STR = {"独孤真传.破掌式", "独孤真传.破指式","独孤真传.破剑式", "独孤真传.破刀式", "独孤真传.破特式", "独孤真传.破气式"}
  
  WAR.L_WNGZL = {};		--王难姑指令，持续中毒减血
  WAR.L_HQNZL = {};		--胡青牛指令，持续回血回内伤
  WAR.L_HQNZL2 = {};		--持续回内回内伤
  WAR.L_WNGZL2 = {};
  WAR.L_WNGZL3 = {};       --凝血气劲
  WAR.L_HBJD = {}
  
  WAR.AN = {}
  WAR.SUZUPID = -1
  
  WAR.L_QKDNY = {};		--设定攻击多个人时，乾坤只能被反一次
  
  WAR.L_NOT_MOVE = {};	--记录不可移动的人
  WAR.XDLZ = {};		--记录被血刀老祖杀掉的人
  WAR.XDLZ2 = {}
  WAR.ZZRZY = 0			--周芷若领悟左右的剧情
  WAR.XTTX = 0			--先天调息
  WAR.QXPZ = 0			--先天调息
  
  WAR.XTJG = 0          --先天剑罡
  
  WAR.DFWM=0 --东方未明特效1
  WAR.DFWM2=0 --东方未明特效2
  WAR.DFWM2P=0 --东方未明特效2
  WAR.DFWMJIQI=0 --东方未明集气恢复
  WAR.DFWMXX=0 --东方未明吸血
  WAR.DFWM3P=0
  
  WAR.LHXX = 0
WAR.LHXX2 = 0
  
  WAR.GTJIQI=0 --强制恢复集气数值
  WAR.GTPID=-1 --强制集气数值对象
  WAR.GTSHAQI=0 --强制杀气
  WAR.GTPID2=-1 --强制杀气使用者
  WAR.GTNUQI=0 --强制减怒气值 
  WAR.GTPID3=-1 --强制减怒使用者
  WAR.GTEID = -1 --强制减伤使用者
  WAR.GTPID4=-1 --强制恢复
  WAR.PZPID = -1 --攻击偏转使用者
  
	WAR.THSB = 0        --桃花三宝
    WAR.THSB1 = 0       --真·桃花三宝
    WAR.THSB2 = 0       --真·桃花三宝
    WAR.THSB3 = 0       --真·桃花三宝
    WAR.THSB4 = 0       --真·桃花三宝
  
  WAR.JX_QLJJ = 0 --青莲剑诀
  WAR.JX_QLJJ2 = 0	--青莲剑诀
  WAR.JX_QLJJ3 = 0	--青莲剑诀
  
  WAR.TSSX1 = 0
  
  WAR.ShowHP = 1		--血条显示
  WAR.YTJS={}


  WAR.SHJG = {}--蛇鹤架构
  WAR.YJQS ={}--杨家枪势
  
  WAR.MQJG = {}--猛禽架构
  WAR.LYLZ = {}
  WAR.LYLZ2 = {}
  
  WAR.DGPZ1 = {}
  WAR.DGPZ2 = {}
  
  WAR.YANGFU = {}
  WAR.YINFU = {}
  WAR.SHAH = {}
  WAR.SHAH2 = {}
  WAR.TSSX = {}

 --判定数据，统一书写
	WAR.PD = {
			['乾'] = {},			--八卦·乾特效
			['坤'] = {},			--八卦·坤特效
			['震'] = {},			--八卦·震特效
			['巽'] = {},			--八卦·巽特效
			['坎'] = {},			--八卦·坎特效
			['离'] = {},			--八卦·离特效
			['艮'] = {},			--八卦·艮特效
			['兑'] = {},			--八卦·兑特效
			['刀剑绝技'] = {},     --刀剑绝技
			['临'] = {},			--八卦·兑特效
			['兵'] = {},			--八卦·兑特效
			['斗'] = {},			--八卦·兑特效
			['者'] = {},			--八卦·兑特效
			['列'] = {},			--八卦·兑特效
			['阵'] = {},			--八卦·兑特效
			['皆'] = {},			--八卦·兑特效
			['在'] = {},			--八卦·兑特效
			['前'] = {},			--八卦·兑特效
			['神游太虚'] = {},		
			['蛇行狸翻'] = {},
			['氤氲紫气'] = {},
			['如来神掌'] = {},
            ['金刚般若']	= {},	
			['疾如风'] = {},
			['侵如火'] = {},
			['守如山'] = {},
			['徐如林'] = {},
			['绣花针'] = {},
			['无量禅震'] = {},
			['诸法无我'] = {},
			['偷天换日'] = {},
			['梅长苏'] = {},
			['先天护盾CD'] = {},
			['先天护盾'] = {},
			['蛤蟆蓄力'] = {},
			['鲸息蓄力'] = {},
			['太极蓄力'] = {},
			['复活状态'] = {},
			['走火状态'] = {},
			['先天罡气'] = {},
			['独孤求败'] = {},
			['金刚斗气'] = {},
	} 
	WAR.FZ ={
--	['金刚符'] = {}
--	['力士符'] = {}
--	['戴院长符'] = {}
--	['阴阳符'] = {}
--	['元气神符'] = {}	
--	['幸运符'] = {}	
	}
	WAR.FZ2 ={
--	['压制符'] = {}
--	['狂怒符'] = {}
--	['虚力符'] = {}
--	['封经符'] = {}
--	['丧魂符'] = {}
--	['劳情符'] = {}	
	
	
	}
	WAR.XFZ = 0
	WAR.XFZ2 = 0

	WAR.STGZ ={
--	['麒麟臂'] = {}
--	['金刚躯'] = {}
--	['菩提心'] = {}
--	['写轮眼'] = {}	
	
	
	}
	
	WAR.COMBO = {}
  
	WAR.TSSB = {}			--进阶泰山，使用后20时序内闪避
	WAR.JDYJ = {}			--剑胆琴心增加御剑能力
	WAR.WMYH = {}			--无明业火状态，耗损使用的内力一半的生命
	WAR.FMZZ = {}
	WAR.FMYL = {}
	
	WAR.RMZT = {}
	WAR.JHLY = {}			--沼跃鱼：引燃
	WAR.JHLY2 = {}			--沼跃鱼：燃灯
	WAR.JHLY3 = {}          --沼跃鱼：内火焚心
	WAR.QBLY = {}           --沼跃鱼：千本落英
	WAR.LRHF = {}			--沼跃鱼：冻结
	WAR.HIDE = {}
    WAR.HIDE2 = {}	
	WAR.HIDE3 = {}
    WAR.SFXW = {}	
	WAR.ATKDOWN = {}
	WAR.SPDDOWN = {}
	WAR.DEFDOWN = {}
	WAR.ATKUP = {}
	WAR.SPDUP = {}
	WAR.DEFUP = {}
	WAR.JSCL = {}	
	WAR.JSCL2 = {}	
	WAR.SKWJ = {}
	
	WAR.MZSM = {}
	WAR.MZQL = {}
	WAR.MZ_LH = {}
	WAR.LSDZ = {}
	WAR.LSGY = {}
	WAR.LSGY_S = {}
	WAR.LSGY_SS = {}
	
	WAR.SILENCE = {}
	WAR.SXBB = {}
	WAR.SLSX = {}			--金轮，十龙十象
	WAR.HMZT = {}			--昏迷状态
	WAR.SATA = {}           --飒踏加速
	WAR.PMWZ = {}           --缥缈
	
	WAR.DR= {}           --叠刃加攻
	WAR.XUEFU= {}           --血气符咒
	WAR.XQZZ = {}        --血气诅咒
	WAR.PJFY = {}           --破甲
	WAR.MLZS = {}
	WAR.KBGJ = {}           --穿甲
	WAR.KBGJ2 = {}           --坚甲
	WAR.KBGJ3 = {}           --碎兵
    WAR.PBFY = {}          --破兵
	WAR.WFHT = {}
	
	WAR.JYZT = {}			--阿紫，禁药状态
	WAR.MZSH = 0			--阿紫曼珠沙华，每杀一个人+200气攻气防
	WAR.AZ = 0--阿紫苦痛汲取
	
	WAR.SZSD = -1			--被死战锁定的目标
	
	WAR.LXJY = 0
	WAR.MCF = 0
	WAR.HYS = 0
	
	WAR.CSZT = {}			--沉睡状态
	WAR.CSSX = {}
	
	WAR.JYHT = {}           --九阳真气
	WAR.JYHT_JX = {}           --九阳伤害积蓄
	WAR.JYHT_FK = {}           --九阳反馈
	
	WAR.JYWR_CF = 0
	WAR.JYWR = {}
	WAR.JYWR_JH = {}
	WAR.JYWR_JH2 = {}
	WAR.JYWR_XF = {}
	
	WAR.JYZQ = {}           --九阴真气
	WAR.XTGQ = {}           --先天罡气
	WAR.NYZQ = {}           --逆运真气
	WAR.HBZQ = {}           --寒冰真气
	
	WAR.HBYJ = {}
	WAR.BSFW = {}
	WAR.BSYJ = {}
	WAR.BS_ZT = {}
	
	WAR.LHYJ = {}
	WAR.BDYJ = {}
	
	WAR.NZWF = {}          --逆转五方
	WAR.NZSH = {}
	
	WAR.RJZT = {}
	WAR.NKZT = {}
	
	WAR.PJZT = {}			--破军状态
	WAR.PJJL = {}			--被破军前的内功记录
	WAR.TXZS = 0 			--太玄招式
	
	WAR.LQZS = 0 
	WAR.LQS = 0
	WAR.LQZS_HQ = 0
	
	WAR.YJZS = 0
	
	WAR.LQAY = 0
	WAR.CYJG = 0
	WAR.YKX = 0
	WAR.YKX1 = 0
	WAR.YKX2 = 0
	
	WAR.YSJF = {}			--玉石俱焚
	
	WAR.HLZT = {}			--混乱状态
	
	WAR.QYZT = {}			--琴音状态
	WAR.JGDQ = {}
	
	
	WAR.XRZT = {}			--虚弱状态
	WAR.LUCK = {}           --幸运状态
	WAR.UNLUCK = {}           --幸运状态
	WAR.SZJS = {}
	WAR.XHDZ = {}  --  猩红毒针
	WAR.JCGD = {}  --  蛊毒
	WAR.JJGD = {}  --  所中五毒
	
	WAR.YIN ={}        --葵花阴阳
	WAR.YANG = {}
	WAR.XING = {}
	WAR.KUIJUE = {}
	WAR.KONGQUE = {}
	WAR.YYJ = {}
	
	WAR.QGZT = {}			--倾国状态
	
	WAR.BXZS = 0				--辟邪招式
	WAR.BXLQ = {}				--辟邪冷却记录
	WAR.BXCD = {0,1,0,1,2,3}	--辟邪冷却时间
	
	WAR.ARZS = 0				--黯然招式
	WAR.ARLQ = {}				--黯然冷却记录
	WAR.ARCD = {0,1,0,1,2,3}	--黯然冷却时间
	
	WAR.LMZS = 0				--六脉招式
	WAR.LMLQ = {}				--六脉冷却记录
	WAR.LMCD = {0,1,0,1,2,3}	--六脉冷却时间	
	WAR.LM_JQ = 0
	WAR.LM_JQ1 = 0
	WAR.LM_JQ2 = 0
	WAR.QJ_JQ = 0
	WAR.QXJQ = {}
	WAR.ZXJQ2 = {}
	WAR.YINLV = {}
	WAR.LMZJ = {}
	WAR.QXJQZT = {}
	

	
		WAR.Miss = {}			--闪避的miss显示
	WAR.PIC = {}			--闪避的贴图记录
	
	WAR.KHSZ = 0			--葵花神针 

    WAR.HTZD = {}
    WAR.HTZD2 = {}	
	WAR.MJZBZD = {}
	
	WAR.XLZB = {}
	--五脏损
	WAR.YZSG={}
	WAR.YZSX={}
	WAR.YZSP={}
	WAR.YZSF={}
	WAR.YZSS={}
	--阴阳损
	WAR.YZSY = {}
	WAR.YZSY2 = {}
	
	WAR.CYJY = {}
	WAR.JCYY = {}
	WAR.JCYY1 = {}
	WAR.JCYY2 = {}

  WAR.YJQS1 = {}  --一劲七伤
  WAR.YMD = {}   --阳脉断
  WAR.YMH = {}   --阴脉毁
	
	--秘孔debuff
	WAR.MK_XXC={}
	WAR.MK_YQ={}
	WAR.MK_XR={}
	WAR.MK_CP={}
	WAR.MK_CH={}
	--秘孔buff
	WAR.MK_DS={}
	WAR.MK_SH={}
	WAR.MK_XLT={}
	WAR.MK_JM={}
	WAR.MK_BH={}
    WAR.HSMY={}
	
	WAR.DJDQ = {}--帝江斗气反击
	WAR.DJFJ = 0
	WAR.DJDQ1 = {}--帝江斗气反击
	WAR.DJFJ1 = 0  
  
	--场景效果
	WAR.WLHS = 0
	WAR.TJLY = 0
    
	WAR.KMXK = {}
	WAR.DYFS = {}
	WAR.DYFQ = {}
  
  --门派相关
    WAR.SXXYS = {} --三笑逍遥散
	WAR.SYWGZ = 0 --三阴蜈蚣爪
	WAR.SH = {} --锁喉
	WAR.SH1 = {}
	WAR.ZBX = {} --醉八仙
	WAR.ZBX2 = {}
	WAR.HJ = {}
	WAR.YFZ = {} --玉蜂针
	WAR.YFZ2 = {} --玉蜂针
	WAR.YFZ3 = {} --霹雳雷火反击

    WAR.ZLBH = {}
    WAR.XSBL = {}
    WAR.BAHK = {}
	
    
	WAR.TM = {} --唐门反击
	WAR.JG = {} --金刚不坏
	WAR.BG = {} --武当八卦
	WAR.JD = {} --武骧金星：白驼山集毒
    WAR.JH = {} --武骧金星：桃花岛九花玉露
	WAR.WJ = {} --武当无极
	
	WAR.TYZH = {}
	
	WAR.YRKG = {} --以柔克刚
	WAR.YJZD = {} --以静制动
	WAR.YJZD2 = {}
	WAR.YJZDPD = {}
	WAR.XJ = {} --血祭
	WAR.QX = 0 --潜行
	WAR.PB = {} --豸苗：谢云流破敌
	WAR.LW = {} --豸苗：谢云流乱流
	WAR.HUANXUE = {} --换血
	WAR.XUEMO = {} --血魔
    WAR.XUEFU={}	
	WAR.CLXL = {}
	WAR.BH = {}
	WAR.LB = {}
	WAR.LBPD = {}
	WAR.BZ = {}
	WAR.MJTC = {}
	WAR.MJZB = {}
	WAR.MJZB2 ={}
	WAR.MJZBDS = {}
	WAR.MJCJ = 3
	WAR.MJBCJ = {}
	WAR.OWN = 1
	WAR.BHMJ=0----沼跃鱼：碧海幻境
	WAR.XMPM = 0----沼跃鱼：罗汉堂嗔恶退散
	WAR.GBLJ = {} --丐帮连击点数 
	WAR.ATNum = 1
  
  CleanWarMap(7, 0)
end


--显示人物的战斗信息，包括头像，生命，内力等
function WarShowHead(id)
	if not id then
		id = WAR.CurID
	end
	if id < 0 then
		return 
	end
	local pid = WAR.Person[id]["人物编号"]
	local p = JY.Person[pid]
	local h = CC.FontSMALL
	local width = CC.FontSMALL*11 - 6
	local height = (CC.FontSMALL+CC.RowPixel)*9 - 12
	local x1, y1 = nil, nil
	local i = 1
	local size = CC.FontSmall3
	if p["主运内功"] > 0 then
		height = height + CC.FontSMALL + 2
	end
    if p["主运轻功"] > 0 then
		height = height + CC.FontSMALL + 2
	end
	if WAR.Person[id]["我方"] == true then
		x1 = CC.ScreenW - width - 6
		y1 = CC.ScreenH - height - CC.ScreenH/6 -6
		DrawBox(x1, y1, x1 + width, y1 + height + CC.ScreenH/6, C_GOLD)
	else
		x1 = 10
		y1 = 10
		DrawBox(x1, y1, x1 + width, y1 + height + CC.ScreenH/6, C_GOLD)
	end
----------------------------------------状态显示----------------------------------------- 
	local zt_num = 0

	--神照重生显示
	if WAR.tmp[2000 + pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 1 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1, "已神照复活", C_WHITE, size)
		else
			lib.LoadPNG(98, 1 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3, "已神照复活", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	if WAR.SZJS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 1 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1, "神降", C_WHITE, size)
		else
			lib.LoadPNG(98, 1 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3, "神降", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

   if WAR.Person[id]["精神崩溃"] > 0 then
 		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 11 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1, "失智值："..WAR.Person[id]["精神崩溃"], C_WHITE, size)
		else
			lib.LoadPNG(98, 11 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3, "失智值："..WAR.Person[id]["精神崩溃"], C_WHITE, size)
		end
		zt_num = zt_num + 1  
   end
	
	--波动刻印显示
	if WAR.BDKY[pid]~=nil then
		local tjzx = WAR.BDKY[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "波动刻印:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "波动刻印:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.NQHR[pid]~=nil then
		local tjzx = WAR.NQHR[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "念气珠:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "念气珠:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if wglw(pid,78)>=1 then
		local tjzx = WAR.SHAH[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "聚沙:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "聚沙:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.SHAH2[pid]~=nil then
		local tjzx = WAR.SHAH2[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "流沙:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "流沙:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--龙魂显示
	if WAR.LHXT[pid]~=nil then
		local tjzx = WAR.LHXT[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 74 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "龙魂:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 74 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "龙魂:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end



	--蛇魄显示
	if WAR.SPXT[pid]~=nil then
		local tjzx = WAR.SPXT[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 75 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "蛇魄:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 75 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "蛇魄:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--龙气值
	if WAR.LMJQ1[pid]~=nil then
		local tjzx = WAR.LMJQ1[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 74 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "龙气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 74 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "龙气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--剑气值
	if WAR.LMJQ2[pid]~=nil then
		local tjzx = WAR.LMJQ2[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 55 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "剑气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 55 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "剑气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--秘孔显示
	if WAR.MKDS[pid]~=nil then
		local tjzx = WAR.MKDS[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 8 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "秘孔:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 8 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "秘孔:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.MJBCJ[pid]~=nil then
		local tjzx = WAR.MJBCJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "审判标记:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "审判标记:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if Curr_NG(pid, 171) then
		local tjzx = WAR.TJZX[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "太极之形:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "太极之形:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.DRZT[pid]~=nil then
		local tjzx = WAR.DRZT[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 9 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "钓饵:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 9 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "钓饵:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.ZBX[pid]~=nil then
		local tjzx = WAR.ZBX[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 4 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "醉八仙:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 4 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "醉八仙:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.ZLBH[pid]~=nil then
		local tjzx = WAR.ZLBH[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "冰华:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "冰华:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.XSBL[pid]~=nil then
		local tjzx = WAR.XSBL[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 6 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "血兰:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 6 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "血兰:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.BAHK[pid]~=nil then
		local tjzx = WAR.BAHK[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 7 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "紫薇:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 7 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "紫薇:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.GMZS1[pid]~=nil then
		local tjzx = WAR.GMZS1[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 6 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "左使印记:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 6 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "左使印记:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.GMYS1[pid]~=nil then
		local tjzx = WAR.GMYS1[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 7 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "右使印记:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 7 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "右使印记:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.QMDJ[pid]~= nil then--
			local tjzx = WAR.QMDJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "八门金锁:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "八门金锁:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	
	end


	if WAR.JCGD[pid]~= nil then--
			local tjzx = WAR.JCGD[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 81 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "蛊毒.爆裂:"..tjzx.."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 81 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "蛊毒.爆裂:"..tjzx.."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	
	end

	if WAR.JJGD[pid]~= nil then--
			local tjzx = WAR.JJGD[pid]
			local aa = 8+tjzx
			local str ={"瘴雾黑蜈","寒潭冰蝰","赤沙之蝎","彩雪花蛛","箭毒血蛙","天傀金蚕"}
			local say = str[tjzx]
			if tjzx == 1 then
			aa = 76
			elseif tjzx == 2 then
			aa = 75
			elseif tjzx == 3 then
			aa = 79
			elseif tjzx == 4 then
			aa = 77
			elseif tjzx == 5 then
			aa = 78
			elseif tjzx == 5 then
			aa = 80
			end
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "潜伏蛊毒:"..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "潜伏蛊毒:"..say, C_WHITE, size)
		end
		zt_num = zt_num + 1	
	end



	if WAR.tmp[3000+pid]~=nil then
		local tjzx = WAR.tmp[3000+pid]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "太极蓄力:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "太极蓄力:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.KMXK[pid]~=nil then
		local tjzx = WAR.KMXK[pid]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 6 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "虚空值:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 6 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "虚空值:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.BG[pid]~=nil then
		local tjzx = WAR.BG[pid]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "八卦:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "八卦:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.TZ_XZ_SSH[pid]~=nil then
		local tjzx = WAR.TZ_XZ_SSH[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "生死符:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "生死符:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	

    if pid == 0 and JY.Base["标准"] == 6 and WAR.JSTG2> 0 then--
		local tjzx = WAR.JSTG2
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 2 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天罡斗气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 2 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "天罡斗气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--纯阳之意显示
	if WAR.CYZY[pid]~=nil then
		local tjzx = WAR.CYZY[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 3 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "纯阳之意:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 3 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "纯阳之意:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--纯阳剑伤显示
	if WAR.CYJY[pid]~=nil then
		local tjzx = WAR.CYJY[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 8 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "纯阳剑伤:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 8 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "纯阳剑伤:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.FLHS2>0 and pid == 0 then
		local tjzx = WAR.FLHS2
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 4 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "如林:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 4 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "如林:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.ZXXS2[pid]~= nil then
		local tjzx = WAR.ZXXS2[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "紫霞聚气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "紫霞聚气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.L_WNGZL2[pid]~= nil then
		local tjzx = WAR.L_WNGZL2[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 12* 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "化血剧毒:"..tjzx.."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 12 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "化血剧毒:"..tjzx.."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.L_WNGZL3[pid]~= nil then
		local tjzx = WAR.L_WNGZL3[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 15* 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "凝血气劲:"..tjzx.."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 15 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "凝血气劲:"..tjzx.."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.L_HBJD[pid]~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 83* 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "SCP-09:红冰", C_WHITE, size)
		else
			lib.LoadPNG(98, 83* 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "SCP-09:红冰", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.BPYZ[pid]~= nil then
		local tjzx = WAR.BPYZ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "冰魄剧毒:"..tjzx.."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "冰魄剧毒:"..tjzx.."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.BZSC[pid]~= nil then
		local tjzx = WAR.BZSC[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "败者食尘:"..tjzx.."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "败者食尘:"..tjzx.."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if nglw(pid, 95)>1 then
		local tjzx = WAR.HMJT[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 5 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "蛤蟆蓄气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 5 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "蛤蟆蓄气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if PersonKF(pid,180) then
		local tjzx = WAR.TSSX[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 13 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "玄蛇蓄息:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 13 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "玄蛇蓄息:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--飒踏加速显示
	if WAR.SATA[pid]~=nil then
		local tjzx = WAR.SATA[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 44 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "飒踏加速:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 44 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "飒踏加速:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.PMWZ[pid]~=nil then
		local tjzx = WAR.PMWZ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 44 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "缥缈:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 44 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "缥缈:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.SXBB[pid]~=nil then
		local tjzx = WAR.SXBB[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 44 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "神行值:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 44 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "神行值:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--叠刃显示
	if WAR.DR[pid]~=nil then
		local tjzx = WAR.DR[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 51 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "叠刃层数:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 51 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "叠刃层数:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--血气诅咒显示
	if WAR.XQZZ[pid]~=nil then
		local tjzx = WAR.XQZZ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 52 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "血气诅咒层数:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 52 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "血气诅咒层数:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--血气符文显示
	if WAR.XUEFU[pid]~=nil then
		local tjzx = WAR.XUEFU[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 52 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "血气符文数量:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 52 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "血气符文数量:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		
	
	--弹指蓄势
	if wglw(pid,18)>2 then
		local tjzx = WAR.TZNQ
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 33 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "弹指蓄势:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 33 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "弹指蓄势:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	--翔龙箭
	if match_ID_awakened(id,55,1) then
		local tjzx = WAR.TZNQ2[id] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 33 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "翔龙箭蓄势:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 33 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "翔龙箭蓄势:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--九阳护体罡气显示
	if WAR.JYHT[pid]~=nil then
		local tjzx = WAR.JYHT[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 54 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九阳护体罡气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 54 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九阳护体罡气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.JYWR[pid]~=nil then
		local tjzx = WAR.JYWR[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 57 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九阳污染:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 57 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九阳污染:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.JYHT_JX[pid]~=nil then
		local tjzx = WAR.JYHT_JX[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 54 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九阳蓄伤:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 54 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九阳蓄伤:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--九阴破体真气显示
	if WAR.JYZQ[pid]~=nil then
		local tjzx = WAR.JYZQ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九阴破体真气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九阴破体真气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--逆运愈体真气显示
	if WAR.NYZQ[pid]~=nil then
		local tjzx = WAR.NYZQ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 15 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "逆运愈体真气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 15 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "逆运愈体真气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--先天罡气显示
	if WAR.XTGQ[pid]~=nil then
		local tjzx = WAR.XTGQ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "先天罡气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "先天罡气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--寒冰真气显示
	if WAR.HBZQ[pid]~=nil then
		local tjzx = WAR.HBZQ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "寒冰真气:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "寒冰真气:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--冰霜符文显示
	if WAR.BSFW[pid]~=nil then
		local tjzx = WAR.BSFW[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 21 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "冰霜符文:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 21 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "冰霜符文:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	--冰霜印记显示
	if WAR.BSYJ[pid]~=nil then
		local tjzx = WAR.BSYJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 22 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "霜冻形态:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 22 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "霜冻形态:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.BS_ZT[pid]~=nil then
		local tjzx = WAR.BS_ZT[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 22 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "白霜:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 22 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "白霜:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.LHYJ[pid]~=nil then
		local tjzx = WAR.LHYJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 23 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "烈火印记:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 23 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "烈火印记:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.BDYJ[pid]~=nil then
		local tjzx = WAR.BDYJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 25 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "爆弹:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 25 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "爆弹:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.HBYJ[pid]~=nil then
		local tjzx = WAR.HBYJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 26 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "霜冻印记:"..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 26 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "霜冻印记:"..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--摄魂状态显示
	if WAR.YHDF[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 50 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "失魂落魄", C_WHITE, size)
		else
			lib.LoadPNG(98, 50 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "失魂落魄", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--阳符显示
	if WAR.YANGFU[pid]~=nil then
	    local tjzx = WAR.YANGFU[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 50 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阳符："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 50 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "阳符："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if MPPB_MJBL(pid)>1  then
	    local tjzx = WAR.QKDS[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 50 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "乾坤点数："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 50 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "乾坤点数："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--符咒显示
	if WAR.FZ[pid]~=nil then
	    local tjzx1 = WAR.FZ[pid][1] or 0
		local tjzx2 = WAR.FZ[pid][2] or 0
		local tjzx3 = WAR.FZ[pid][3] or 0
		local tjzx4 = WAR.FZ[pid][4] or 0
		local tjzx5 = WAR.FZ[pid][5] or 0
		local tjzx6 = WAR.FZ[pid][6] or 0
		if tjzx1>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "金刚符："..tjzx1, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "金刚符："..tjzx1, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
		if tjzx2>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 21 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "力士符："..tjzx2, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 21 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "力士符："..tjzx2, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
			if tjzx3>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 22 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "戴院长符："..tjzx3, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 22 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "戴院长符："..tjzx3, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
			if tjzx4>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 23 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阴阳符："..tjzx4, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 23 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "阴阳符："..tjzx4, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
			if tjzx5>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 24 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "元气神符："..tjzx5, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 24 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "元气神符："..tjzx5, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
				if tjzx6>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 25 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "幸运符："..tjzx6, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 25 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "幸运符："..tjzx6, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
	end		

--	['压制符'] = {}
--	['狂怒符'] = {}
--	['虚力符'] = {}
--	['封经符'] = {}
--	['丧魂符'] = {}
--	['劳情符'] = {}
	--符咒显示
	if WAR.FZ2[pid]~=nil then
	    local tjzx1 = WAR.FZ2[pid][1] or 0
		local tjzx2 = WAR.FZ2[pid][2] or 0
		local tjzx3 = WAR.FZ2[pid][3] or 0
		local tjzx4 = WAR.FZ2[pid][4] or 0
		local tjzx5 = WAR.FZ2[pid][5] or 0
		local tjzx6 = WAR.FZ2[pid][6] or 0
		if tjzx1>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 13 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "压制符："..tjzx1, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 13 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "压制符："..tjzx1, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
		if tjzx2>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 41 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "狂怒符："..tjzx2, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 41 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "狂怒符："..tjzx2, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
			if tjzx3>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "虚灵符："..tjzx3, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "虚灵符："..tjzx3, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
			if tjzx4>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 43 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "封经符："..tjzx4, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 43 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "封经符："..tjzx4, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
			if tjzx5>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 44 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "丧魂符："..tjzx5, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 44 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "丧魂符："..tjzx5, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
				if tjzx6>0 then
		   if WAR.Person[id]["我方"] == true then
			  lib.LoadPNG(98, 45 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "劳情符："..tjzx6, C_WHITE, size)
		   else
			  lib.LoadPNG(98, 45 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			  DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "劳情符："..tjzx6, C_WHITE, size)
		   end
		   zt_num = zt_num + 1
		end
	end	
	
	--阴符显示
	if WAR.YINFU[pid]~=nil then
	local tjzx = WAR.YINFU[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 50 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阴符："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 50 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "阴符："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.MZ_LH[pid]~=nil then
	local tjzx = WAR.MZ_LH[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 50 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "密释.轮回："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 50 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "密释.轮回："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--八音穿心状态显示
	if WAR.BYCX[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 59 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "八音穿心", C_WHITE, size)
		else
			lib.LoadPNG(98, 59 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "八音穿心", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--千本落英状态显示
	if WAR.QBLY[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 59 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "千本落英", C_WHITE, size)
		else
			lib.LoadPNG(98, 59 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "千本落英", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--七死爆毒状态显示
	if WAR.QSLZ[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 46 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "七死爆毒", M_DarkGreen, size)
		else
			lib.LoadPNG(98, 46 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "七死爆毒", M_DarkGreen, size)
		end
		zt_num = zt_num + 1
	end		

	--寒毒侵袭状态显示
	if WAR.HDQM[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 66 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "寒毒侵袭", M_DarkGreen, size)
		else
			lib.LoadPNG(98, 66 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "寒毒侵袭", M_DarkGreen, size)
		end
		zt_num = zt_num + 1
	end		

	
	--破甲状态显示
	if WAR.PJFY[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 56 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "破甲", C_WHITE, size)
		else
			lib.LoadPNG(98, 56 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "破甲", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.PBFY[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 51 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "破兵", C_WHITE, size)
		else
			lib.LoadPNG(98, 51 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "破兵", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--破气状态显示
	if WAR.MLZS[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 56 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "破气", C_WHITE, size)
		else
			lib.LoadPNG(98, 56 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "破气", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
		--不坏金身状态显示
	if WAR.BHJS[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 57 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "不坏金身", C_WHITE, size)
		else
			lib.LoadPNG(98, 57 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "不坏金身", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.TJYM[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 41 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天降御免", C_WHITE, size)
		else
			lib.LoadPNG(98, 41 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "天降御免", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
		--立地天心状态显示
	if WAR.BHJS2[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 58 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "立地天心", C_WHITE, size)
		else
			lib.LoadPNG(98, 58 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "立地天心", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
		--立地天心状态显示
	if WAR.MZLL[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 60 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "明尊琉璃", C_WHITE, size)
		else
			lib.LoadPNG(98, 60 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "明尊琉璃", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.PEACE[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "冰心", C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "冰心", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.MZLL2[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 60 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "乾坤更迭", C_WHITE, size)
		else
			lib.LoadPNG(98, 60 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "乾坤更迭", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
		--神经蛇毒状态显示
	if WAR.SJSD[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 71 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "概率封印", C_GOLD, size)
		else
			lib.LoadPNG(98, 71 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "概率封印", C_GOLD, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.JD_SJSD[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 71 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "神经蛇毒", C_GOLD, size)
		else
			lib.LoadPNG(98, 71 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "神经蛇毒", C_GOLD, size)
		end
		zt_num = zt_num + 1
	end		

		--溶血蛇毒状态显示
	if WAR.RXSD[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 69 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "溶血蛇毒", C_WHITE, size)
		else
			lib.LoadPNG(98, 69 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "溶血蛇毒", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

		--散功蛇毒状态显示
	if WAR.WGSD[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "武功尽失", C_GOLD, size)
		else
			lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "武功尽失", C_GOLD, size)
		end
		zt_num = zt_num + 1
	end	
	--护盾
	if WAR.Person[id]["护盾"]>0 then
	   local aa = WAR.Person[id]["护盾"]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 12 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "护盾值："..aa, C_GOLD, size)
		else
			lib.LoadPNG(98, 12 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num,  "护盾值："..aa, C_GOLD, size)
		end
		zt_num = zt_num + 1	
	end
	--斗气
	if WAR.Person[id]["斗气"]>0 then
	   local aa = WAR.Person[id]["斗气"]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 13 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "斗气值："..aa, C_GOLD, size)
		else
			lib.LoadPNG(98, 13 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num,  "斗气值："..aa, C_GOLD, size)
		end
		zt_num = zt_num + 1	
	end
		--天内消失显示
	if WAR.TLXS[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天内封印", C_GOLD, size)
		else
			lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "天内封印", C_GOLD, size)
		end
		zt_num = zt_num + 1
	end	

	--破甲状态显示
	if WAR.WFHT[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 56 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "无法护体", C_WHITE, size)
		else
			lib.LoadPNG(98, 56 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "无法护体", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.TLHQ[pid]~=nil then
	    local aa = WAR.TLHQ[pid][1] or 0
		local str = JY.Wugong[aa]["名称"]
		if aa == 0 then
		str = "无"
		end
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天内获取："..str, C_GOLD, size)
		else
			lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "天内获取", C_GOLD, size)
		end
		zt_num = zt_num + 1
	end	
	
	--穿甲状态显示
	if WAR.KBGJ[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 53 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "穿甲状态显示", C_WHITE, size)
		else
			lib.LoadPNG(98, 53 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "穿甲状态显示", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	--坚甲状态显示
	if WAR.KBGJ2[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 53 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "坚甲状态显示", C_WHITE, size)
		else
			lib.LoadPNG(98, 53 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "坚甲状态显示", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--碎兵状态显示
	if WAR.KBGJ3[pid]~=nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 53 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "碎兵状态显示", C_WHITE, size)
		else
			lib.LoadPNG(98, 53 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "碎兵状态显示", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	--无酒不欢：阿紫曼珠沙华
	if match_ID(pid, 47) then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 13 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "曼珠沙华:" .. WAR.MZSH, C_WHITE, size)
		else
			lib.LoadPNG(98, 13 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "曼珠沙华:" .. WAR.MZSH, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--无酒不欢：阿紫禁药状态
	if WAR.JYZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 14 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "禁药状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 14 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "禁药状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--迷踪步显示
	if pid == 0 and JY.Person[615]["论剑奖励"] == 1 then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 3 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "迷踪步开启", C_WHITE, size)
		else
			lib.LoadPNG(98, 3 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "迷踪步开启", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--无明业火显示	
	if WAR.WMYH[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 6 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "无明业火", C_WHITE, size)
		else
			lib.LoadPNG(98, 6 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "无明业火", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--天衣无缝显示
	if TianYiWF(pid) then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 7 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "天衣无缝", C_WHITE, size)
		else
			lib.LoadPNG(98, 7 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "天衣无缝", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

		--无酒不欢：琴音状态
	if WAR.QYZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 19 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "琴音" .. WAR.QYZT[pid].."层", C_WHITE, size)
		else
			lib.LoadPNG(98, 19 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "琴音" .. WAR.QYZT[pid].."层", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	
	--沼跃鱼：十龙十象状态
	if WAR.SLSX[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 11 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "十龙十象", C_WHITE, size)
		else
			lib.LoadPNG(98, 11 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "十龙十象", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--沼跃鱼：紫宵剑气显示	
	if WAR.ZXJQ[pid] ~= nil then
	    local zxjq =WAR.ZXJQ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 41 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "紫宵剑气:"..zxjq, C_WHITE, size)
		else
			lib.LoadPNG(98, 41 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "紫宵剑气:"..zxjq, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	
	--无酒不欢：昏迷状态
	if WAR.HMZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 12 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "昏迷状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 12 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "昏迷状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--无酒不欢：沉默状态
	if WAR.SILENCE[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 13 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "沉默", C_WHITE, size)
		else
			lib.LoadPNG(98, 13 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "沉默", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

		--无酒不欢：隐蔽状态
	if WAR.HIDE[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 46 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "隐蔽", C_WHITE, size)
		else
			lib.LoadPNG(98, 46 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "隐蔽", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.SKWJ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 46 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "受苦无间", C_WHITE, size)
		else
			lib.LoadPNG(98, 46 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "受苦无间", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

		--无酒不欢：森罗灭形状态
	if WAR.HIDE2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 46 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "森罗灭形", C_WHITE, size)
		else
			lib.LoadPNG(98, 46 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "森罗灭形", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.HIDE3[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 24 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "易容", C_WHITE, size)
		else
			lib.LoadPNG(98, 24 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "易容", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		
	
		--无酒不欢：精神错乱状态
	if WAR.JSCL[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 46 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "精神错乱", C_WHITE, size)
		else
			lib.LoadPNG(98, 46 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "精神错乱", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

		--无酒不欢：丧心病狂状态
	if WAR.JSCL2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 46 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "丧心病狂", C_WHITE, size)
		else
			lib.LoadPNG(98, 46 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "丧心病狂", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--无酒不欢：沉睡状态
	if WAR.CSZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 15 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "沉睡状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 15 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "沉睡状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	--沼跃鱼：烈阳状态
	if WAR.HOT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "烈阳状态："..WAR.HOT[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "烈阳状态："..WAR.HOT[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.KQB[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 21 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "狂犬疫病", C_WHITE, size)
		else
			lib.LoadPNG(98, 21 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "狂犬疫病", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.JYWR_XF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "血沸", C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "血沸", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.HOT2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 41 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "烈阳内核", C_WHITE, size)
		else
			lib.LoadPNG(98, 41 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "烈阳内核", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.QYC[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 23 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "形态：犬夜叉", C_WHITE, size)
		else
			lib.LoadPNG(98, 23 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "形态：犬夜叉", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.DSW[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 23 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "形态：馘大蛇", C_WHITE, size)
		else
			lib.LoadPNG(98, 23 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "形态：馘大蛇", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.HOT2_JH[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 41 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "烈阳内核：激活", C_WHITE, size)
		else
			lib.LoadPNG(98, 41 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "烈阳内核：激活", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.JYWR_JH[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 42 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九阳污染：活化", C_WHITE, size)
		else
			lib.LoadPNG(98, 42 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九阳污染：活化", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.JYWR_JH2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 43 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九阳污染：散发", C_WHITE, size)
		else
			lib.LoadPNG(98, 43 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九阳污染：散发", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--沼跃鱼：玄阴状态
	if WAR.ICE[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 43 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "玄阴状态："..WAR.ICE[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 43 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "玄阴状态："..WAR.ICE[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.ICE2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 44 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "玄阴内核", C_WHITE, size)
		else
			lib.LoadPNG(98, 44 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "玄阴内核", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.ZLLY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 31 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "超重影响", M_Blue, size)
		else
			lib.LoadPNG(98, 31 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "超重影响", M_Blue, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.FZLY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 32 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "反重影响", C_WHITE, size)
		else
			lib.LoadPNG(98, 32 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "反重影响", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	--无酒不欢：引燃效果
	if WAR.JHLY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 8 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "引燃状态:"..WAR.JHLY[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 8 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "引燃状态:"..WAR.JHLY[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	--无酒不欢：燃木效果
	if WAR.JHLY2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 48 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "燃木状态:"..WAR.JHLY2[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 48 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "燃木状态:"..WAR.JHLY2[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.RMZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 47 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "燃灭层数:"..WAR.RMZT[pid], C_WHITE, size)
		else
			lib.LoadPNG(98, 47 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "燃灭层数:"..WAR.RMZT[pid], C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--无酒不欢：内火焚心效果
	if WAR.JHLY3[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 49 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "内火焚心状态:"..WAR.JHLY3[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 49 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "内火焚心状态:"..WAR.JHLY3[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--无酒不欢：冻结效果
	if WAR.LRHF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 9 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "冻结状态:"..WAR.LRHF[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 9 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "冻结状态:"..WAR.LRHF[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.FMYL[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "业力:"..WAR.FMYL[pid].."层数", C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "业力:"..WAR.FMYL[pid].."层数", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.FMZZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 11 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "业障缠身", C_WHITE, size)
		else
			lib.LoadPNG(98, 11 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "业障缠身", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	--封印攻击显示
	if WAR.BZ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "封印", C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "封印", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.WSZ[pid] ~= nil then
	local aa=WAR.WSZ[pid]/40*100
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 20 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num,"威慑可能性："..WAR.WSZ[pid].."%", C_WHITE, size)
		else
			lib.LoadPNG(98, 20 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "威慑可能性："..WAR.WSZ[pid].."%", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.XRZT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "虚弱状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "虚弱状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.JGDQ[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 10 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "金刚斗气", C_WHITE, size)
		else
			lib.LoadPNG(98, 10 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "金刚斗气", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		
	
	if WAR.MENG[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 45 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "气息紊乱", C_WHITE, size)
		else
			lib.LoadPNG(98, 45 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "气息紊乱", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.LUCK[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 47 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "幸运状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 47 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "幸运状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.UNLUCK[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 38 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "厄运状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 38 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "厄运状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.YZSX[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 61 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "心损状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 61 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "心损状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.YZSG[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 62 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "肝损状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 62 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "肝损状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.YZSP[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 63 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "脾损状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 63 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "脾损状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.YZSF[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 64 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "肺损状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 64 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "肺损状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.YZSS[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 65 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "肾损状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 65 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "肾损状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.YZSY[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 60 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阴虚状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 60 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "阴虚状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.YZSY2[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 60 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阳亢状态", C_WHITE, size)
		else
			lib.LoadPNG(98, 60 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "阳亢状态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	


	--沼跃鱼：蝶蛹状态
	if WAR.BCB[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 40 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "妖蝶变.蛹化："..WAR.BCB[pid].."时序", C_WHITE, size)
		else
			lib.LoadPNG(98, 40 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "妖蝶变.蛹化："..WAR.BCB[pid].."时序", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--沼跃鱼：妖蝶状态
	if WAR.YDXT[pid] ~= nil then
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 39 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "妖蝶形态", C_WHITE, size)
		else
			lib.LoadPNG(98, 39 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "妖蝶形态", C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--沼跃鱼：阴葵
	if WAR.YIN[pid] ~= nil then
	    local tjzx = WAR.YIN[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 67 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "月光阴葵："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 67 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "月光阴葵："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.XING[pid] ~= nil then
	    local tjzx = WAR.XING[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 67 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "夜空星葵："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 67 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "夜空星葵："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--沼跃鱼：阳葵
	if WAR.YANG[pid] ~= nil then
	    local tjzx = WAR.YANG[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 67 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "大日阳葵："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 67 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "大日阳葵："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	--沼跃鱼：丐帮连击点数
	if WAR.GBLJ[pid] ~= nil then
	    local tjzx = WAR.GBLJ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 30 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "丐帮连击点数："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 30 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "丐帮连击点数："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

		--沼跃鱼：猩红毒针
	if WAR.XHDZ[pid] ~= nil then
	    local tjzx = WAR.XHDZ[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 73 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "猩红毒针："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 73 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "猩红毒针："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end
	
	if WAR.SHJG[pid] ~= nil then
	    local tjzx = WAR.SHJG[pid]
		local aa = 12+tjzx
		local str ={"蛇形","鹤形","龙形","龟形","鹰形"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "形意架势："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "形意架势："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.YSLS[pid] ~= nil then
	    local tjzx = WAR.YSLS[pid]
		local aa = 32+tjzx
		local str ={"貂跃","蛇突","枭舞","猿击"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "灵兽御："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "灵兽御："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.YYJ[pid] ~= nil then
	    local tjzx = WAR.YYJ[pid]
		local aa = 15+tjzx
		local str = {"阴手","阳手"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "太极气劲："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "太极气劲："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.MZSM[pid] ~= nil then
	    local tjzx = WAR.MZSM[pid]
		local aa = 37+tjzx
		local str ={"阴脉","阳脉","中脉"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "瑜伽三脉："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "瑜伽三脉："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.MZQL[pid] ~= nil then
	    local tjzx = WAR.MZQL[pid]
		local aa = 21+tjzx
		local str ={"土元海底轮","水服密释轮","炎脐化身轮","风念智慧轮","真空受用轮","真视慧眼轮","至高意识轮"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "瑜伽七轮："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "瑜伽七轮："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.LSDZ[pid] ~= nil then
	    local tjzx = WAR.LSDZ[pid]
		local aa = 31+tjzx
		local str ={"凶魂阵","疯魂阵","魔魂阵","阴魂阵","幽魂阵","煞魂阵"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "罗刹凭依："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "罗刹凭依："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.GSSL[pid]~= nil then--
			local tjzx = WAR.GSSL[pid]
			local aa = 8+tjzx
			local str ={"七杀瞬狱修罗","神隐幻杀明王","无量神刀天尊","三川苦寒菩萨","三尸慈姑娘娘","圣威怒雷金刚"}
			local say = str[tjzx]
			if tjzx == 1 then
			aa = 31
			elseif tjzx == 2 then
			aa = 35
			elseif tjzx == 3 then
			aa = 38
			elseif tjzx == 4 then
			aa = 43
			elseif tjzx == 5 then
			aa = 78
			elseif tjzx == 5 then
			aa = 13
			end
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "敕令："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "敕令："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1	
	end

	if WAR.BBSK[pid] ~= nil then
	    local tjzx = WAR.BBSK[pid]
		local aa = 15+tjzx
		local str ={"雄狮【修罗王】","猛虎【天王】","炎龙【龙王】","丹凤【迦楼罗王】","水牛【闼婆王】","巨犀【比姿王】","麒麟【那罗王】","魔狼【夜叉王】"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "神甲胄："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "神甲胄："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.LSGY_S[pid] ~= nil then
	    local tjzx = WAR.LSGY_S[pid] or 0
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 73 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "鬼影重重："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 73 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "鬼影重重："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end

	if WAR.YJQS[pid] ~= nil then
	    local tjzx = WAR.YJQS[pid]
		local aa = 19+tjzx
		local str ={"梨花","穿云","骤雨","狂岚"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "杨家枪势："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "杨家枪势："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.MQJG[pid] ~= nil then
	    local tjzx = WAR.MQJG[pid]
		local aa = 18+tjzx
		local str ={"飞燕势","孤鹫势","水鸟势","红鹤势","白鹭势","凤凰势"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "南斗架势："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "南斗架势："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.WXZQ[pid] ~= nil then
	    local tjzx = WAR.WXZQ[pid]
		local aa = 10+tjzx
		local str ={"巨木", "锐金", "洪水", "烈火", "厚土"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "五行旗："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "五行旗使："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.LCJY1[pid] ~= nil then
	    local tjzx = WAR.LCJY1[pid] or 0
		local aa = 27
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "连城剑意.水："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "连城剑意.水："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.LCJY2[pid] ~= nil then
	    local tjzx = WAR.LCJY2[pid] or 0
		local aa = 28
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "连城剑意.风："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "连城剑意.风："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.LCJY3[pid] ~= nil then
	    local tjzx = WAR.LCJY3[pid] or 0
		local aa = 29
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "连城剑意.雷："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "连城剑意.雷："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.LCJY4[pid] ~= nil then
	    local tjzx = WAR.LCJY4[pid] or 0
		local aa = 30
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "连城剑意.火："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "连城剑意.火："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.LCJY5[pid] ~= nil then
	    local tjzx = WAR.LCJY5[pid] or 0
		local aa = 31
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "连城剑意.天地："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "连城剑意.天地："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.LYLZ[pid] ~= nil then
	    local tjzx = WAR.LYLZ[pid]
		local aa = 18+tjzx
		local str ={"少阳","阳明","太阳","少阴","阴维","太阴"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "六阳流转："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "六阳流转："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
	if WAR.DGPZ1[pid] ~= nil then
	    local tjzx = WAR.DGPZ1[pid]
		local aa = 7+tjzx
		local str ={"拳掌","指腿","剑","刀","奇门","内功"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "九剑御免："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "九剑御免："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.DGPZ2[pid] ~= nil then
	    local tjzx = WAR.DGPZ2[pid]
		local aa = 7+tjzx
		local str ={"拳掌","指腿","剑","刀","奇门","内功"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "废招："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "废招："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.LYLZ2[pid] ~= nil then
	    local tjzx = WAR.LYLZ2[pid]
		local aa = 18+tjzx
		local str ={"至阳","纯阳","残阳","寒阴","元阴","清阴"}
		local say = str[tjzx]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, aa * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "阴阳进阶："..say, C_WHITE, size)
		else
			lib.LoadPNG(98, aa * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "阴阳进阶："..say, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.QXJQ[pid] ~= nil then
	    local tjzx = WAR.QXJQ[pid]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 33 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "轻剑气："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 33 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "轻剑气："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end		

	if WAR.ZXJQ2[pid] ~= nil then
	    local tjzx = WAR.ZXJQ2[pid]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 35 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "重剑气："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 35 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "重剑气："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	

	if WAR.YINLV[pid] ~= nil then
	    local tjzx = WAR.YINLV[pid]
		if WAR.Person[id]["我方"] == true then
			lib.LoadPNG(98, 35 * 2 , x1 - size*9- CC.RowPixel-580, CC.ScreenH - size*2 - CC.RowPixel*2 - (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 - size*6- CC.RowPixel-580, CC.ScreenH - size - CC.RowPixel*3 + 1 - (size*2+CC.RowPixel*2)*zt_num, "音律："..tjzx, C_WHITE, size)
		else
			lib.LoadPNG(98, 35 * 2 , x1 + width + CC.RowPixel, CC.RowPixel + 3 + (size*2+CC.RowPixel*2)*zt_num, 1)
			DrawString(x1 + width + size*2 + CC.RowPixel*3, size + 3 + (size*2+CC.RowPixel*2)*zt_num, "音律："..tjzx, C_WHITE, size)
		end
		zt_num = zt_num + 1
	end	
	
-------------------------------------------------------------------------------------------------- 
  --local headw, headh = lib.PicGetXY(1, p["头像代号"] * 2)
	local headw, headh = lib.GetPNGXY(1, p["头像代号"])
	local headx = (width - headw) / 2
	local heady = (CC.ScreenH/4 - headh) / 2
	local chain = 0
	--头像信息
	local headid = WAR.tmp[5000+id];
	if headid == nil then
		headid = JY.Person[id]["头像代号"]
	end
			if match_ID(id,646) then
			   headid = 584
			end
	lib.LoadPNG(1, headid*2, x1 + 1 + headx, y1 - 14 + heady, 1)
	x1 = x1 + CC.RowPixel
	y1 = y1 + CC.RowPixel + CC.ScreenH/6 - 12
	 if WAR.Person[WAR.CurID]["我方"] then
	    chain = WAR.MYCHAIN
     else
	    chain = WAR.URCHAIN
     end
	DrawString(x1 + CC.RowPixel*9+CC.DefaultFont, y1 - CC.RowPixel*8-CC.DefaultFont*1.5, "连锁:"..chain, TG_Red_Bright, size/5*4)
	DrawString(x1 + CC.RowPixel*9+CC.DefaultFont, y1 - CC.RowPixel*8-CC.DefaultFont*1.5+(CC.FontSMALL + 2), "战意:"..WAR.SPIRIT[pid], RGB(236, 200, 40), size/5*4)
	local color = nil
	if p["受伤程度"] < p["中毒程度"] then
		if p["中毒程度"] == 0 then
			color = RGB(252, 148, 16)
		elseif p["中毒程度"] < 50 then
			color = RGB(120, 208, 88)
		else
			color = RGB(56, 136, 36)
		end
	elseif p["受伤程度"] < 33 then
		color = RGB(236, 200, 40)
	elseif p["受伤程度"] < 66 then
		color = RGB(244, 128, 32)
	else
		color = RGB(232, 32, 44)
	end
	MyDrawString(x1 -4 , x1 + width -4, y1 + CC.RowPixel + 2, p["姓名"], color, CC.DefaultFont)

	--有运功时的显示
	if p["主运内功"] > 0 then
		DrawString(x1 + 8, y1 + CC.RowPixel + CC.DefaultFont, "运功", MilkWhite, size)
		DrawString(x1 + size*3, y1 + CC.RowPixel+ CC.DefaultFont, JY.Wugong[p["主运内功"]]["名称"], TG_Red_Bright, size)
		y1 = y1 + CC.FontSMALL + 2
	end
	--有轻功时的显示
	if p["主运轻功"] > 0 then
		DrawString(x1 + 8, y1 + CC.RowPixel + CC.DefaultFont, "轻功", MilkWhite, size)
		DrawString(x1 + size*3, y1 + CC.RowPixel+ CC.DefaultFont, JY.Wugong[p["主运轻功"]]["名称"], M_DeepSkyBlue, size)
		y1 = y1 + CC.FontSMALL + 2
	end
	y1 = y1 + size + CC.RowPixel + 3
  
  --颜色条
  local pcx = x1 + 3 - CC.RowPixel + 2;
  local pcy = y1 + CC.RowPixel +1
  
  --生命条
  lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
  local pcw, pch = lib.GetPNGXY(1, 274 * 2);
  local lqz = WAR.LQZ[pid] or 0;
   --DrawString(x1 + 3, y1 + CC.RowPixel-size*2, pcx.."|"..pcy, C_ORANGE, size)
   --DrawString(x1 + 3, y1 + CC.RowPixel-size*1, pcw.."|"..pch, C_ORANGE, size)
   
  lib.SetClip(pcx, pcy, pcx + (p["生命"]/p["生命最大值"])*pcw, pcy + pch)
  lib.LoadPNG(1, 274 * 2 , pcx  , pcy, 1)
  pcy = pcy + CC.RowPixel + size -2
  lib.SetClip(0,0,0,0)
  
  lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
  local pcw, pch = lib.GetPNGXY(1, 274 * 2);
  
   --DrawString(x1 + 3, y1 + CC.RowPixel-size*2, pcx.."|"..pcy, C_ORANGE, size)
   --DrawString(x1 + 3, y1 + CC.RowPixel-size*1, pcw.."|"..pch, C_ORANGE, size)
   
  lib.SetClip(pcx, pcy, pcx + (lqz/100)*pcw, pcy + pch)
  lib.LoadPNG(1, 274 * 2 , pcx  , pcy, 1)
  pcy = pcy + CC.RowPixel + size -2
  lib.SetClip(0,0,0,0)
  
  --内力条
  lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
  local pcw, pch = lib.GetPNGXY(1, 273 * 2);
  lib.SetClip(pcx, pcy, pcx + (p["内力"]/p["内力最大值"])*pcw, pcy + pch)
  lib.LoadPNG(1, 273 * 2 , pcx  , pcy, 1)
  pcy = pcy + CC.RowPixel + size -2
  lib.SetClip(0,0,0,0)
  
  --体力条
  lib.LoadPNG(1, 275 * 2 , pcx  , pcy, 1)
  local pcw, pch = lib.GetPNGXY(1, 276 * 2);
  lib.SetClip(pcx, pcy, pcx + (p["体力"]/100)*pcw, pcy + pch)
  lib.LoadPNG(1, 276 * 2 , pcx  , pcy, 1)
  pcy = pcy + CC.RowPixel + size -2
  lib.SetClip(0,0,0,0)
  
  local lifexs = "命 "..p["生命"]
  local nlxs = "内 "..p["内力"]
  local tlxs = "体 "..p["体力"]
  local lqzxs = "怒 "..lqz;	--怒气
  local zdxs = p["中毒程度"]
  
  local nsxs = p["受伤程度"];		--内伤
  local bfxs = p["冰封程度"];		--冰封
  local zsxs = p["灼烧程度"];		--灼烧
  local fxxs = WAR.FXDS[pid] or 0;		--封穴
  local lxxs = WAR.LXZT[pid] or 0;		--流血
  local chxs = WAR.CHZ[pid] or 0;		--迟缓
  local mbxs = WAR.MBZ[pid] or 0;		--麻痹
  
  DrawString(x1 + 9, y1 + CC.RowPixel + 6, lifexs, M_White, CC.FontSMALL)
  DrawString(x1 + 9, y1 + CC.RowPixel + size + 11, lqzxs, M_White, CC.FontSMALL)
  DrawString(x1 + 9, y1 + CC.RowPixel + 2*size + 16, nlxs, M_White, CC.FontSMALL)
  DrawString(x1 + 9, y1 + CC.RowPixel + 3*size + 21, tlxs, M_White, CC.FontSMALL)
  
  y1 = y1 + 4*(CC.RowPixel + size) + 4
  --if WAR.Person[id]["我方"] then
  	
  	local myx1 = 3;
  	local myy1 = 0;
	--麻痹
	DrawString(x1 + myx1, y1 + myy1, "麻痹", M_Plum, size/5*4)
	if mbxs == 100 then
		mbxs = "极"
	end
	DrawString(x1 + myx1 + size*2 + 10, y1 + myy1,mbxs, M_Plum, size/5*4)
	--迟缓
	myx1 = myx1 + size * 4;
	DrawString(x1 + myx1, y1 + myy1, "迟缓", M_YellowGreen, size/5*4)
	if chxs == 100 then
		chxs = "极"
	end
    DrawString(x1 + size*5/2 + myx1, y1 + myy1, chxs, M_YellowGreen, size/5*4)
	--冰封
	myx1 = 3;
	myy1 = myy1 + size/4*3 + 1.5;
	DrawString(x1 + myx1, y1 + myy1, "冰封", M_LightBlue, size/5*4)
	DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, bfxs, M_LightBlue, size/5*4)
	--灼烧
	myx1 = myx1 + size * 4;
	DrawString(x1 + myx1, y1 + myy1, "灼烧", C_ORANGE, size/5*4)
  	DrawString(x1 + size*5/2 + myx1, y1 + myy1, zsxs, C_ORANGE, size/5*4)
	--封穴
	myx1 = 3;
	myy1 = myy1 + size/4*3 + 1.5;
	DrawString(x1 + myx1, y1 + myy1, "封穴", C_GOLD, size/5*4)
	if fxxs == 50 then
		fxxs = "极"
	end
	DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, fxxs, C_GOLD, size/5*4)
	--流血
	myx1 = myx1 + size * 4;
	DrawString(x1 + myx1, y1 + myy1, "流血", M_DarkRed, size/5*4)
	if lxxs == 100 then
		lxxs = "极"
	end
  	DrawString(x1 + size*5/2 + myx1, y1 + myy1, lxxs, M_DarkRed, size/5*4)
	--内伤
	myx1 = 3;
	myy1 = myy1 +  size/4*3 + 1.5;
	DrawString(x1 + myx1, y1 + myy1, "内伤", PinkRed, size/5*4)
	if nsxs == 100 then
		nsxs = "极"
	end
	DrawString(x1 + myx1 + size*2 + 10, y1 + myy1, nsxs, PinkRed, size/5*4)
	--中毒
	myx1 = myx1 + size * 4;
	DrawString(x1 + myx1, y1 + myy1, "中毒", LimeGreen, size/5*4)
	if zdxs == 100 then
		zdxs = "极"
	end
  	DrawString(x1 + size*5/2 + myx1, y1 + myy1, zdxs, LimeGreen, size/5*4)	
	
  --end
  
  
  if WAR.Person[id]["我方"] == false then
	y1 = y1 + 3*(CC.RowPixel + size) +12
    DrawBox(x1-7, y1, x1 + width-7 , y1 + size*6, C_GOLD)
    local hl = 1
    for i = 1, 4 do
      local wp = p["携带物品" .. i]
      local wps = p["携带物品数量" .. i]
      if wp >= 0 then
        local wpm = JY.Thing[wp]["名称"]
        DrawString(x1+2, y1 + hl * (size+CC.RowPixel) - 18, wpm .. wps, C_WHITE, size)
        hl = hl + 1
      end
    end
  end
end

--自动选择合适的武功
function War_AutoSelectWugong()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local probability = {}
	local wugongnum = CC.Kungfunum
	for i = 1, CC.Kungfunum do
		local wugongid = JY.Person[pid]["武功" .. i]
		if wugongid > 0 then
			if JY.Wugong[wugongid]["伤害类型"] == 0 then
		  
				--选择杀生命的武功，必须消耗内力比现有内力小，起码可以发出一级的武功。
				if JY.Wugong[wugongid]["消耗内力点数"] <= JY.Person[pid]["内力"] then
					local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
					probability[i] = get_skill_power(pid, wugongid, level)	--无酒不欢：采用新公式
				else
					probability[i] = 0
				end
				
				--轻功不可攻击
				if JY.Wugong[wugongid]["武功类型"] == 7 then
					probability[i] = 0
				end
					
				--内功攻击
				if JY.Wugong[wugongid]["武功类型"] == 6 then
				
					if inteam(pid) == false and i == 1 then --NPC会用第一格内功
					
					elseif pid == 0 and JY.Base["畅想"] > 0 and i == 1 then --畅想会用第一格内功
			  
					elseif wugongid == 105 and (match_ID(pid, 36) or match_ID(pid, 27))then		--林平之 东方 使用葵花神功
					
					elseif wugongid == 102 and match_ID(pid, 38) then		--石破天 使用太玄神功
					
					elseif wugongid == 106 and match_ID(pid, 9) then		--张无忌 使用九阳神功
					
					elseif wugongid == 94 and match_ID(pid, 37) then		--狄云 使用神经照
					
					elseif wugongid == 108 and match_ID(pid, 114) then		--扫地 使用易筋经
					
					elseif wugongid == 104 and match_ID(pid, 60) then		--欧阳锋 使用逆运
					
					elseif wugongid == 103 and (match_ID(pid, 39) or match_ID(pid, 40))then		---侠客岛主 使用龙象
						
					elseif (pid == 0 and GetS(4, 5, 5, 5) == 5) or match_ID(pid, 48) then			--天罡 游坦之 使用内功
						
					else
						probability[i] = 0
					end
				end

				--斗转星移
				if wugongid == 43 and match_ID(pid, 51) == false then
					probability[i] = 0
				end
				
				--七夕赵敏不用太极拳
				if wugongid == 16 and pid == 609 then
					probability[i] = 0
				end
				
				--七夕任盈盈不用棋书画
				if (wugongid == 72 or wugongid == 84 or wugongid == 142) and pid == 611 then
					probability[i] = 0
				end
				
				--七夕郭靖不用打狗
				if wugongid == 80 and pid == 612 then
					probability[i] = 0
				end
				
				--七夕黄蓉不用降龙
				if wugongid == 26 and pid == 613 then
					probability[i] = 0
				end
				
				--七夕杨过暴怒不用玄铁
				if wugongid == 45 and pid == 614 and WAR.LQZ[pid] == 100 then
					probability[i] = 0
				end
				
				--襄阳金轮不用龙象
				if wugongid == 103 and pid == 62 and WAR.ZDDH == 275 then
					probability[i] = 0
				end
			else
				probability[i] = 0		 --自动不会杀内力
			end
		else
			wugongnum = i - 1
			break;
		end
	end
  
	if wugongnum ==  0 then			--如果没有武功，直接返回-1
		return -1;
	end

	local maxoffense = 0		--计算最大攻击力
	for i = 1, wugongnum do
		if maxoffense < probability[i] then
			maxoffense = probability[i]
		end
	end
	
	local mynum = 0			--计算我方和敌人个数
	local enemynum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				mynum = mynum + 1
			else
				enemynum = enemynum + 1
			end
		end
	end
	
	
	local factor = 0		--敌人人数影响因子，敌人多则对线面等攻击多人武功的选择概率增加
	if mynum < enemynum then
		factor = 2
	else
		factor = 1
	end
	
	for i = 1, wugongnum do		--考虑其他概率效果
		local wugongid = JY.Person[pid]["武功" .. i]
		if probability[i] > 0 then
			if probability[i] < maxoffense*3/4 then		--去掉攻击力小的武功
				probability[i] = 0
			else
				local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
				probability[i] = probability[i] + JY.Wugong[wugongid]["移动范围".. level]  * factor*10
				if JY.Wugong[wugongid]["杀伤范围" .. level] > 0 then
					probability[i] = probability[i] + JY.Wugong[wugongid]["杀伤范围" .. level]* factor*10
				end
			end
		end
	end
	
	local s = {}		--按照概率依次累加
	local maxnum = 0
	for i = 1, wugongnum do
	  s[i] = maxnum
	  maxnum = maxnum + probability[i]
	end
	s[wugongnum + 1] = maxnum
	if maxnum == 0 then		--没有可以选择的武功
	  return -1
	end
	
	local v = Rnd(maxnum)		 --产生随机数
	local selectid = 0
	for i = 1, wugongnum do		--根据产生的随机数，寻找落在哪个武功区间
	  if s[i] <= v and v < s[i + 1] then
	    selectid = i
  	end
	end
	return selectid
end


--战斗武功选择菜单
--sb star为无意义参数，仅为防止代码语法错误跳出
--战斗武功选择菜单
--sb star为无意义参数，仅为防止代码语法错误跳出
function War_FightMenu(sb, star, wgnum)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local numwugong = 0
	local menu = {}
	local canuse = {}
	local c = 0;
	for i = 1, CC.Kungfunum do
		local tmp = JY.Person[pid]["武功" .. i]
		if tmp > 0 then
			menu[i] = {JY.Wugong[tmp]["名称"], nil, 1}
			
			if skill_usable(pid, tmp) then
				menu[i][3] = 1
			else
				menu[i][3] = 0
			end
		  
			--内力少不显示
			if JY.Person[pid]["内力"] < JY.Wugong[tmp]["消耗内力点数"] then
				menu[i][3] = 0
			end
		  
			--体力低于10不显示
			if JY.Person[pid]["体力"] < 10 then
				menu[i][3] = 0
			end
			  
			numwugong = numwugong + 1
		  
			if menu[i][3] == 1 then
				c = c + 1
				canuse[c] = i
			end
		end
	end
	if c == 0 then
		return 0
	end
	if wgnum == nil then
		local r = nil
		r = ShowMenu(menu, numwugong, 0, CC.MainSubMenuX + 15, CC.MainSubMenuY, 0, 0, 1, 1, CC.DefaultFont, C_ORANGE, C_WHITE)
		if r == 0 then
			return 0
		end
		WAR.ShowHead = 0
		local r2 = War_Fight_Sub(WAR.CurID, r)
		WAR.ShowHead = 1
		Cls()
		return r2
	--无酒不欢：数字快捷键直接使用武功
	else
		if wgnum <= c then
			WAR.ShowHead = 0
			local r2 = War_Fight_Sub(WAR.CurID, canuse[wgnum])
			WAR.ShowHead = 1
			Cls()
			return r2
		else
			return 0
		end
	end
end

--自动战斗时 做思考
--吃药的flag：2 生命；3内力；4体力；6 解毒
function War_Think()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local r = -1
	local minNeili = War_GetMinNeiLi(pid)
	local can_eat_drug = 0
	--非我方，会考虑吃药
	if WAR.Person[WAR.CurID]["我方"] == false then
		can_eat_drug = 1
	--如果是我方，只有在队且允许才会吃药
	else
		if inteam(pid) and JY.Person[pid]["是否吃药"] == 1 then
			can_eat_drug = 1
		end
	end
	if can_eat_drug == 1 then 
		--吃体力药
		local eat_eng_drug = 0
		if inteam(pid) then
			local fz = {50, 30, 10}
			if JY.Person[pid]["体力"] < fz[JY.Person[pid]["体力阈值"]] then
				eat_eng_drug = 1
			end
		else
			if JY.Person[pid]["体力"] < 10 then
				eat_eng_drug = 1
			end
		end
		if eat_eng_drug == 1 then
			r = War_ThinkDrug(4)
			if r >= 0 then
			  return r
			end
			return 0
		end
		
		--吃血药
		local eat_hp_drug = 0
		if inteam(pid) then
			local fz = {0.7, 0.5, 0.3}
			if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"]*fz[JY.Person[pid]["生命阈值"]] then
				eat_hp_drug = 1
			end
		else
			--根据生命确定吃血药几率
			local rate = -1
			if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
				rate = 90
			elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
				rate = 70
			elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
				rate = 50
			elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
				rate = 25
			end
			
			--内伤也增加吃血药几率
			if JY.Person[pid]["受伤程度"] > 50 then
				rate = rate + 50
			end
			
			--暴气时，不吃药
			if Rnd(100) < rate and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] ~= 100 then
				eat_hp_drug = 1
			end
		end
		if eat_hp_drug == 1 then
			r = War_ThinkDrug(2)
			if r >= 0 then				--如果有药吃药
				return r
			else
				r = War_ThinkDoctor()		--如果没有药，考虑医疗
				if r >= 0 then
					return r
				end
			end
		end
		
		--吃内力药
		local eat_mp_drug = 0
		if inteam(pid) then
			local fz = {0.7, 0.5, 0.3}
			if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"]*fz[JY.Person[pid]["内力阈值"]] then
				eat_mp_drug = 1
			end
		else
			--考虑内力
			local rate = -1
			if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
				rate = 100
			elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
				rate = 75
			elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
				rate = 50
			end

			if Rnd(100) < rate or minNeili > JY.Person[pid]["内力"] then
				eat_mp_drug = 1
			end
		end
		if eat_mp_drug == 1 then
			r = War_ThinkDrug(3)
			if r >= 0 then
				return r
			end
		end
	  
		local jdrate = -1
		if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
			jdrate = 60
		else
			if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
				jdrate = 30
			end
		end
	  
		--半血以下吃解毒药
		--暴怒不吃解毒药
		if Rnd(100) < jdrate and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] ~= 100 then
			r = War_ThinkDrug(6)
			if r >= 0 then
				return r
			end
		end
	end
	
	if inteam(pid) then 
		if JY.Person[pid]["行为模式"] == 4 then
			r = 0
		elseif JY.Person[pid]["行为模式"] == 3 then
			r = 7
		elseif JY.Person[pid]["行为模式"] == 2 then
			r = 8
		elseif JY.Person[pid]["行为模式"] == 1 then
			if minNeili <= JY.Person[pid]["内力"] and JY.Person[pid]["体力"] > 10 then
				r = 1
			else
				r = 0
			end
		end
	else
		if minNeili <= JY.Person[pid]["内力"] and JY.Person[pid]["体力"] > 10 then
			r = 1
		else
			r = 0
		end
	end
	return r
end

--自动攻击
function War_AutoFight()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local wugongnum;
	if inteam(pid) and JY.Person[pid]["优先使用"] ~= 0 then
		for i = 1, CC.Kungfunum do
			if JY.Person[pid]["武功"..i] == JY.Person[pid]["优先使用"] then
				wugongnum = i
				break
			end
		end
		--加一条防止被洗掉等意外
		if wugongnum == nil then
			wugongnum = War_AutoSelectWugong()
		end
	else
		wugongnum = War_AutoSelectWugong()
	end
	if wugongnum <= 0 then
		War_AutoEscape()
		War_RestMenu()
		return 
	end
	unnamed(wugongnum)
end

--自动战斗
function War_Auto()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	WAR.ShowHead = 1
	WarDrawMap(0)
	ShowScreen()
	lib.Delay(CC.WarAutoDelay)
	WAR.ShowHead = 0
	if CC.AutoWarShowHead == 1 then
		WAR.ShowHead = 1
	end
	if WAR.BZ[pid] ~= nil then
    WAR.Person[WAR.CurID]["移动步数"] = 0 
	end
	if WAR.BCB[pid] ~= nil then
    WAR.Person[WAR.CurID]["移动步数"] = 0 
	end
	local autotype = War_Think()
	--侠客正岛主战不吃药
	if WAR.Person[WAR.CurID]["我方"] == false and WAR.ZDDH == 257 then
		if JY.Person[pid]["内力"] > 50 and JY.Person[pid]["体力"] > 10 then
			autotype = 1
		else
			autotype = 0
		end
	end
 
 if autotype == 1 and WAR.BZ[pid] ~= nil then
	autotype = 0
  end
 
  if autotype == 1 and WAR.BCB[pid] ~= nil then
	autotype = 0
  end
 
    if autotype == 1 and WAR.WSZ[pid] ~= nil then
      local aa= WAR.WSZ[pid]
	  if math.random(40)< aa then
	  	autotype = 0	
	  end
  end
 
    if WAR.LXZT[pid]~=nil and WAR.LXZT[pid]>=25 and JY.Person[pid]["生命"] < math.modf(0.2*JY.Person[pid]["生命最大值"])  then
autotype = 0
  end
 
	if autotype == 0 then
		War_AutoEscape()
		War_RestMenu()
	elseif autotype == 1 then
		War_AutoFight()
	elseif autotype == 2 then
		War_AutoEscape()
		War_AutoEatDrug(2)
	elseif autotype == 3 then
		War_AutoEscape()
		War_AutoEatDrug(3)
	elseif autotype == 4 then
		War_AutoEscape()
		War_AutoEatDrug(4)
	elseif autotype == 5 then
		War_AutoEscape()
		War_AutoDoctor()
	elseif autotype == 6 then
		War_AutoEscape()
		War_AutoEatDrug(6)
	elseif autotype == 7 then
		War_RestMenu()
	elseif autotype == 8 then
		War_DefupMenu()
	end
local chain 
  if WAR.Person[WAR.CurID]["我方"] then
	chain = WAR.MYCHAIN
  else
	chain = WAR.URCHAIN
  end  
  if autotype == 0 or autotype == 7 then --自动战斗战意增长
	zhanyi(pid, (0.25 * (1 + chain / 30)))
		if Curr_NG(pid,184) then
	zhanyi(pid, (1 * (1 + chain / 30)))
	end
  elseif autotype == 1 then
	WAR.HIDE[pid] = nil
	zhanyi(pid, (1.5 * (1 + chain / 30)))
		if Curr_NG(pid,184) then
	zhanyi(pid, (1 * (1 + chain / 30)))
	end
  elseif autotype == 5 then
	zhanyi(pid, (0.5 * (1 + chain / 30)))
		if Curr_NG(pid,184) then
	zhanyi(pid, (1 * (1 + chain / 30)))
	end
  else
	zhanyi(pid, (0.4 * (1 + chain / 30)))
		if Curr_NG(pid,184) then
	zhanyi(pid, (1 * (1 + chain / 30)))
	end
  end
	return 0
end

--人物升级
function War_AddPersonLVUP(pid)
	local tmplevel = JY.Person[pid]["等级"]
	if CC.Level <= tmplevel then
		return false
	end
	if JY.Person[pid]["经验"] < CC.Exp[tmplevel] then
		return false
	end
	while CC.Exp[tmplevel] <= JY.Person[pid]["经验"] do
		tmplevel = tmplevel + 1
		if CC.Level <= tmplevel then
			break;
		end
	end
  
	DrawStrBoxWaitKey(string.format("%s 升级了", JY.Person[pid]["姓名"]), C_WHITE, CC.DefaultFont)
	--计算提升的等级
	local leveladd = tmplevel - JY.Person[pid]["等级"]
	
	JY.Person[pid]["等级"] = JY.Person[pid]["等级"] + leveladd
	
	--提高生命增长
	AddPersonAttrib(pid, "生命最大值", (JY.Person[pid]["生命增长"] + 4) * leveladd * 4)
	
	if nglw(pid,90)>0 or match_ID(pid,89) then--
	   AddPersonAttrib(pid, "生命最大值", 4 * leveladd * 4)
	end
	
	JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
	JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
	JY.Person[pid]["受伤程度"] = 0
	JY.Person[pid]["中毒程度"] = 0

	local theadd = JY.Person[pid]["资质"] / 4
	--聪明人内力加少。。。
	--增加内力的成长
	AddPersonAttrib(pid, "内力最大值", math.modf(leveladd * ((16 - JY.Person[pid]["生命增长"]) * 7 + 210 / (theadd + 1))))
	
	--天罡内力每级额外加50
	if pid == 0 and JY.Base["标准"] == 6 then
	  AddPersonAttrib(pid, "内力最大值", 50 * leveladd)
	end
	JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
	
	--循环提升等级，累加属性
	for i = 1, leveladd do
		local ups;
		local p_zz = JY.Person[pid]["资质"];
		if p_zz <= 15 then
			ups = 2
		elseif p_zz >= 16 and p_zz <= 30 then
			ups = 3
		elseif p_zz >= 31 and p_zz <= 45 then
			ups = 4
		elseif p_zz >= 46 and p_zz <= 60 then
			ups = 5
		elseif p_zz >= 61 and p_zz <= 75 then
			ups = 6
		elseif p_zz >= 76 and p_zz <= 90 then
			ups = 7
		elseif p_zz >= 91 then
			ups = 8
		end
		
		--令狐冲 内伤回复前，每级3点
		--[[
		if pid == 35 and GetD(82, 1, 0) == 1 then
			ups = 3
		end]]
		  
		--队友郭靖 20级之后，每级6点
		if pid == 55 and JY.Person[pid]["等级"] > 20 then
			ups = 6
		end
	  
		AddPersonAttrib(pid, "攻击力", ups)
		AddPersonAttrib(pid, "防御力", ups)
		AddPersonAttrib(pid, "轻功", ups)
		
		--修复医疗、用毒、解毒能力不与等级挂钩的问题
		if JY.Person[pid]["医疗能力"] >= 20 then
			AddPersonAttrib(pid, "医疗能力", 2)
		end
		if JY.Person[pid]["用毒能力"] >= 20 then
			AddPersonAttrib(pid, "用毒能力", 2)
		end
		if JY.Person[pid]["解毒能力"] >= 20 then
			AddPersonAttrib(pid, "解毒能力", 2)
		end
		
		--队友陈家洛 升级加五围
		if pid == 75 then
			if JY.Person[pid]["拳掌功夫"] >= 0 then
				AddPersonAttrib(pid, "拳掌功夫", (4 + math.random(0,1)))
			end
			if JY.Person[pid]["指法技巧"] >= 0 then
				AddPersonAttrib(pid, "指法技巧", (7 + math.random(0,1)))
			end
			if JY.Person[pid]["御剑能力"] >= 0 then
				AddPersonAttrib(pid, "御剑能力", (7 + math.random(0,1)))
			end
			if JY.Person[pid]["耍刀技巧"] >= 0 then
				AddPersonAttrib(pid, "耍刀技巧", (7 + math.random(0,1)))
			end
			if JY.Person[pid]["特殊兵器"] >= 0 then
				AddPersonAttrib(pid, "特殊兵器", (7 + math.random(0,1)))
			end
		end
		
		--暗器每级提高
		if JY.Person[pid]["暗器技巧"] >= 20 then
			AddPersonAttrib(pid, "暗器技巧", 2)
		end
	end

	local ey;  --每级的自由点数
	--难1，难2
	if JY.Base["难度"] < 3 then
		ey = 2;
	--难3，难4
	elseif JY.Base["难度"] > 2 and JY.Base["难度"] < 5 then
		ey = 3;
	--难5
	elseif JY.Base["难度"] == 5 then
		ey = 4;
	--难6
	else
		ey = 5;
	end
	
	local n = ey*leveladd;		--计算随机额外点数
 
	--加点
	local gj = JY.Person[pid]["攻击力"];
	local fy = JY.Person[pid]["防御力"];
	local qg = JY.Person[pid]["轻功"];
	local tmpN = n;
	
	--天赋ID
	local tfid;
	--主角
	if pid == 0 then
		--标主
		if JY.Base["标准"] > 0 then
			tfid = 280 + JY.Base["标准"]
		--特殊
		elseif JY.Base["特殊"] > 0 then
			tfid = 290
		--畅想
		else
			tfid = JY.Base["畅想"]
			if tfid == 447 then
			tfid = 389
			end
		   if tfid == 507 then
			   tfid = 206
		   end
		end
	--队友
	else
		tfid = pid
			if tfid == 447 then
			tfid = 389
			end
		   if tfid == 507 then
			   tfid = 206
		   end
	end
	
	--升级加点界面
	local current = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls();
		--ShowPersonStatus_sub(pid, 1, 1, tfid, -17, 1)
		
		--local gjl = JY.Person[pid]["攻击力"]
		--local fyl = JY.Person[pid]["防御力"]
		--local qgl = JY.Person[pid]["轻功"]
		local n = 0
		local sw = ""
    local headid = pid;
	if pid == 0 then
		if JY.Base["标准"] > 0 then
			if JY.Person[0]["性别"] == 0 then
				headid = 280 + JY.Base["标准"]
			else
				headid = 500 + JY.Base["标准"]
			end
		--特殊
		elseif JY.Base["特殊"] > 0 then
			if JY.Person[0]["性别"] == 0 then
				headid = 290
			else
				headid = 368
			end
		else
			headid = JY.Person[pid]["头像代号"]
			if headid == 217 then
			headid = 389
			end
			if headid == 93 then
			   if JY.Base["畅想"] == 507 then
			   headid = 206
			   end
			end
		end
    else
	    if headid == 217 then
		headid = 389
		end
		if headid == 93 then
		   if pid == 507 then
			   headid = 206
		   end
		end
			   if (pid == 0 and JY.Base["畅想"] == 646) or pid == 646 then
			   headid = 584
			   end
	end		
		lib.LoadPNG(1, 996 * 2 , CC.ScreenW/4-CC.Fontsmall*7-30,CC.ScreenH/2+100+20-25, 1)
		lib.LoadPNG(1, headid * 2 , CC.ScreenW/4-CC.Fontsmall*3+110,CC.ScreenH/2+100+20-10, 1)
		DrawString(CC.ScreenW/4-CC.Fontsmall*6-2+28-10,CC.ScreenH/2+100+20-15,string.format("可分配点数：%d 点",tmpN) ,C_ORANGE, CC.Fontsmall*0.8);
		for i = 1, 3 do
			local shade_color = C_GOLD
			if i ==  current then
				shade_color = PinkRed
			end
			if i == 1 then 
				n = JY.Person[pid]["攻击力"]
				sw = " 攻击力 "
			elseif i == 2 then
				n = JY.Person[pid]["防御力"]
				sw = " 防御力 "
			elseif i == 3 then 
				n = JY.Person[pid]["轻功"]
				sw = " 轻功 "
			end
			DrawString(CC.ScreenW/4-CC.Fontsmall*7-30, CC.ScreenH/2+100+30+i*(CC.FontSmall4*1.5+CC.PersonStateRowPixel)-30, "→  "..sw..n,shade_color, CC.Fontsmall*0.8);
		end
		--PersonStatusA(pid)
		ShowScreen()
		local keypress, ktype, mx, my = WaitKey()
		--lib.Delay(CC.Frame)
		if ktype == 1 then
			if keypress == VK_UP then
				current = current - 1
				if current < 1 then
					current = 3
				end
			elseif keypress == VK_DOWN then
				current = current + 1
				if current > 3 then
					current = 1
				end
			elseif keypress == VK_LEFT and tmpN < n then
				if current == 1 and JY.Person[pid]["攻击力"] > gj then
					JY.Person[pid]["攻击力"] = JY.Person[pid]["攻击力"]-1
					tmpN = tmpN+1
				elseif current == 2 and JY.Person[pid]["防御力"] > fy then
					JY.Person[pid]["防御力"] = JY.Person[pid]["防御力"]-1
					tmpN = tmpN+1
				elseif current == 3 and JY.Person[pid]["轻功"] > qg then
					JY.Person[pid]["轻功"] = JY.Person[pid]["轻功"]-1
					tmpN = tmpN+1
				end
			elseif keypress == VK_RIGHT and tmpN > 0 then
				if current == 1 and JY.Person[pid]["攻击力"] < 9999 then
					JY.Person[pid]["攻击力"] = JY.Person[pid]["攻击力"]+1
					tmpN = tmpN-1
				elseif current == 2 and JY.Person[pid]["防御力"] < 9999 then
					JY.Person[pid]["防御力"] = JY.Person[pid]["防御力"]+1
					tmpN = tmpN-1
				elseif current == 3 and JY.Person[pid]["轻功"] < 9999 then
					JY.Person[pid]["轻功"] = JY.Person[pid]["轻功"]+1
					tmpN = tmpN-1
				end
			elseif keypress==VK_SPACE or keypress==VK_RETURN then
				if tmpN == 0 or (JY.Person[pid]["攻击力"] == 9999 and JY.Person[pid]["防御力"] == 9999 and JY.Person[pid]["轻功"] == 9999) then
					Cls();
					break
				else
					DrawStrBoxWaitKey("对不起，"..JY.Person[pid]["姓名"].."还有剩余的点数没加!", C_WHITE, CC.DefaultFont)
				end
			end
		end
	end
	return true
end

--战斗结束处理函数
--isexp 经验值
--warStatus 战斗状态
function War_EndPersonData(isexp, warStatus)
	--无酒不欢：血量还原函数
	Health_in_Battle_Reset()
	--无酒不欢：战后状态恢复
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		--敌方回复满状态
		if not instruct_16(pid) then
			JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
			JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
			JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
			JY.Person[pid]["受伤程度"] = 0
			JY.Person[pid]["中毒程度"] = 0
			JY.Person[pid]["冰封程度"] = 0
			JY.Person[pid]["灼烧程度"] = 0
		--我方恢复状态
		else	
			JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
			JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
			JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
			JY.Person[pid]["受伤程度"] = 0
			JY.Person[pid]["中毒程度"] = 0
			JY.Person[pid]["冰封程度"] = 0
			JY.Person[pid]["灼烧程度"] = 0
			--如果有运功，则停止
			--[[
			if JY.Person[pid]["主运内功"] ~= 0 then
				JY.Person[pid]["主运内功"] = 0
			end
			if JY.Person[pid]["主运轻功"] ~= 0 then
				JY.Person[pid]["主运轻功"] = 0
			end]]
			--出战统计
			JY.Person[pid]["出战"] = JY.Person[pid]["出战"] + 1
		end
	end

	--乔峰武功回复
	JY.Person[50]["武功1"] = 26
	JY.Wugong[13]["名称"] = "铁掌"
  
	--破丐帮打狗阵
	if WAR.ZDDH == 82 then
		SetS(10, 0, 18, 0, 1)
	end
  
	--梅庄 秃笔翁战斗后
	if WAR.ZDDH == 44 then
		instruct_3(55, 6, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
		instruct_3(55, 7, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
	--梅庄 黑白子战斗
	if WAR.ZDDH == 45 then
		instruct_3(55, 9, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
	--梅庄 黄钟公战斗
	if WAR.ZDDH == 46 then
		instruct_3(55, 13, 0, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
  	--葵花尊者战斗胜利
	--用东方的品德记录
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and warStatus == 1 then
		JY.Person[27]["品德"] = 10
	end
  
	--战斗失败，并且无经验
	if warStatus == 2 and isexp == 0 then
		return 
	end
  
  --统计活的人数
  local liveNum = 0
  for i = 0, WAR.PersonNum - 1 do
    if WAR.Person[i]["我方"] == true and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 then
      liveNum = liveNum + 1
    end
  end
  
	--分配经验
	local canyu = false
	if warStatus == 1 then
		if WAR.Data["经验"] < 1000 then
			WAR.Data["经验"] = 1000
		end
		--超级木桩和木桩的经验
		if WAR.ZDDH == 226 then
			if JY.Person[591]["内力性质"] == 1 then
				WAR.Data["经验"] = 120000
			elseif JY.Person[591]["内力性质"] == 2 then
				WAR.Data["经验"] = 45000
			end
		end
		for i = 0, WAR.PersonNum - 1 do
			local pid = WAR.Person[i]["人物编号"]
			if WAR.Person[i]["我方"] == true and inteam(pid) and JY.Person[pid]["生命"] > 0 then
				if pid == 0 then
					canyu = true
				end
				WAR.Person[i]["经验"] = WAR.Person[i]["经验"] + math.modf(WAR.Data["经验"] / (liveNum))
				--小无经验翻倍
				if PersonKF(pid, 98) then
					WAR.Person[i]["经验"] = WAR.Person[i]["经验"] + math.modf(WAR.Data["经验"] / (liveNum))
				end
			end
		end
	end
  
	--把等级放在修炼秘籍的后面
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["我方"] == true and inteam(pid) then
			--无酒不欢：小于30级，或者身上有物品才显示对话框提示
			if (JY.Person[pid]["等级"] < 30 or JY.Person[pid]["修炼物品"] >= 0) and WAR.Person[i]["经验"]>0 then
				DrawStrBoxWaitKey(JY.Person[pid]["姓名"].."获得经验点数"..WAR.Person[i]["经验"], C_WHITE, CC.DefaultFont)
			end
			--修炼物品
			AddPersonAttrib(pid, "物品修炼点数", math.modf(WAR.Person[i]["经验"] * 8 / 10))
			AddPersonAttrib(pid, "修炼点数", math.modf(WAR.Person[i]["经验"] * 8 / 10))
			if JY.Person[pid]["修炼点数"] < 0 then
				JY.Person[pid]["修炼点数"] = 0
			end
			War_PersonTrainBook(pid)     --修炼秘籍
			War_PersonTrainDrug(pid)		 --修炼药品
			--把等级放在修炼秘籍的后面
			AddPersonAttrib(pid, "经验", math.modf(WAR.Person[i]["经验"] / 2))
			War_AddPersonLVUP(pid)
		else
			AddPersonAttrib(pid, "经验", WAR.Person[i]["经验"])
		end
	end
  
	--青城四秀
	if WAR.ZDDH == 48 then
		SetS(57, 52, 29, 1, 0)
		SetS(57, 52, 30, 1, 0)
		
	-- 一灯居，欧阳锋，裘千刃
	elseif WAR.ZDDH == 175 then
		  instruct_3(32, 12, 1, 0, 0, 0, 0, 0, 0, 0, -2, -2, -2)
		  
	--
	elseif WAR.ZDDH == 82 then
		  SetS(10, 0, 18, 0, 1)
		  
	--破打狗阵
	elseif WAR.ZDDH == 214 then
		  SetS(10, 0, 19, 0, 1)
	end
  
	if JY.Restart == 1 then
		return
	end
end



--执行战斗，自动和手动战斗都调用
--id战斗人物编号
--wugongnum 使用的武功在位置
--x,y为战斗场景坐标
function War_Fight_Sub(id, wugongnum, x, y)
	
	local pid = WAR.Person[id]["人物编号"]
	local x0, y0 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	local wugong = 0
	if wugongnum < 100 then
		wugong = JY.Person[pid]["武功" .. wugongnum]
	elseif wugongnum >= 1000 then
		wugong = wugongnum - 1000
		wugongnum = 1
	else
		wugong = wugongnum - 100
		wugongnum = 1
		for i = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. i] == 43 then   --如果学习有斗转星移
				wugongnum = i     --记录斗转武功位置
				break;
			end
		end
		
	local function douzhuantest()
		if inteam(pid) and WAR.AutoFight == 0 and ((WAR.DZXYLV[pid] == 110 or douzhuankekong(pid) ) or zhuijikekong(pid)) then
			return true
		else
			return false
		end
	end

		
	if  douzhuantest()  then --慕容和主角可控
		WAR.WGWL = JY.Wugong[wugong]["攻击力10"]
	    local fightscope = JY.Wugong[wugong]["攻击范围"]
	    local kfkind = JY.Wugong[wugong]["武功类型"]
	    local level = JY.Person[pid]["武功等级" .. wugongnum]   --判断武功是否为极
    
	if level == 999 then
		level = 11
	else
		level = math.modf(level / 100) + 1
	end
	WAR.ShowHead = 0
	local m1, m2, a1, a2, a3, a4, a5 = refw(wugong, level)  --获取武功的范围
		
	local movefanwei = {m1, m2}   --可移动的范围
	local atkfanwei = {a1, a2, a3, a4, a5}   --攻击范围
         x, y = War_KfMove(movefanwei, atkfanwei,wugong)
    else	
	    if x ~= nil and y ~= nil then	--武骧金星：兵器指数高了以后斗转会在这里出现问题
			x = WAR.Person[WAR.CurID]["坐标X"] - x
			y = WAR.Person[WAR.CurID]["坐标Y"] - y
			WarDrawMap(0)
        end	
	end	
	
		local fj = "错误"
		local fj2 = "错误"
		local color = C_ORANGE
		--斗转星移提示的文字

		if match_ID(pid,517) and WAR.DZXYLV[pid] ~= nil then
		    local str = "%s发动秘剑.燕返"
			if match_ID_awakened(pid,517,1) and WAR.MJYF[pid]~=nil then
			local fj = {"秘剑.麒麟落","秘剑.凤返","秘剑.白龙","秘剑.蜉蝣笼罩","秘剑.毗沙门","秘剑.星花火"}
			local cc = {M_Indigo,M_Olive,M_Silver,M_DarkOrchid,M_SandyBrown,TG_Red}
			color =  cc[WAR.MJYF[pid]]
            str = "%s发动"..fj[WAR.MJYF[pid]]		
			end
		    fj = string.format(str, JY.Person[pid]["姓名"])
		elseif wglw(pid,74)>=1  and WAR.SHJG[pid] ~=nil and WAR.SHJG[pid] == 2 and  WAR.DZXYLV[pid] ~= nil then
			fj = string.format("%s发动咏春白鹤反击", JY.Person[pid]["姓名"])
			color = M_DeepSkyBlue
		elseif match_ID_awakened(pid,55,1) and WAR.DZXYLV[pid] == 120 and JY.Person[55]["品德"] == 70 and WAR.GBGJ == -2 then
		    fj = string.format("%s发动北斗罡步.返", JY.Person[pid]["姓名"])
			color = M_RoyalBlue
			JY.Person[55]["品德"] = 99
			WAR.GBGJ = 0
		elseif WAR.LSGY_SS[pid] ~=nil then
		    if WAR.LSGY_SS[pid] > 1 then
			fj = string.format("%s发动【神隐明王.幻杀一闪】", JY.Person[pid]["姓名"])
			else
			fj = string.format("%s发动【罗刹凭依.鬼影闪】", JY.Person[pid]["姓名"])
			end
		elseif WAR.DZXYLV[pid] == 130 then
			fj = string.format("%s发动幻梦星辰反击", JY.Person[pid]["姓名"])
		elseif WAR.DZXYLV[pid] == 110 then
			fj = string.format("%s发动离合参商反击", JY.Person[pid]["姓名"])
		elseif WAR.DZXYLV[pid] == 85 then
			fj = string.format("%s发动斗转星移反击", JY.Person[pid]["姓名"])
		elseif WAR.DZXYLV[pid] == 60 then
			fj = string.format("%s发动北斗移辰反击", JY.Person[pid]["姓名"])
		end


	    if WAR.YTTLLV[pid] ~=nil  then
		fj = string.format("%s发动同调瞬击", JY.Person[pid]["姓名"])
		color = M_Indigo		
		end

	    if WAR.FQDF2[pid] ~=nil  then
		fj = string.format("%s发动扰乱刀", JY.Person[pid]["姓名"])
		color = M_DarkGreen	
		end
        if WAR.FQDF1[pid] ~=nil  then
		fj2 = string.format("%s发动支援刀", JY.Person[pid]["姓名"])
		color = M_Blue			
		end

        if WAR.DRFJ[pid] ~=nil  then
		fj2 = string.format("%s发动海钓反击", JY.Person[pid]["姓名"])
		color = M_Blue			
		end

		if D1ZSF(pid) and WAR.TJFY == -2 then
			WAR.TJFY = 0
			fj2 = string.format("%s发动续.撇身捶", JY.Person[pid]["姓名"])
			color = M_DeepSkyBlue
	    end
		
		if fj ~= "错误" then
		NEWTXWZ(fj,color)
		end
		if fj2 ~= "错误"  then
		NEWTXWZ(fj2,color)
		end
		
	end
	

	WAR.WGWL = JY.Wugong[wugong]["攻击力10"]
	local fightscope = JY.Wugong[wugong]["攻击范围"]
	local kfkind = JY.Wugong[wugong]["武功类型"]
	local level = JY.Person[pid]["武功等级" .. wugongnum]   --判断武功是否为极
    
	if match_ID_awakened(pid, 38,1) and wugong == 102 then----
       kfkind = math.random(1,5)
	end

	if match_ID_awakened(pid, 38,2) and wugong == 105 then----
       kfkind = math.random(1,5)
	end
	
	if match_ID_awakened(pid, 27,1) and wugong == 105 then----
       kfkind = math.random(1,5)
	end	
	
	if level == 999 then
		level = 11
	else
		level = math.modf(level / 100) + 1
	end
	WAR.ShowHead = 0
	local m1, m2, a1, a2, a3, a4, a5 = refw(wugong, level)  --获取武功的范围
		
	local movefanwei = {m1, m2}   --可移动的范围
	local atkfanwei = {a1, a2, a3, a4, a5}   --攻击范围
  
	x, y = War_FightSelectType(movefanwei, atkfanwei, x, y,wugong)

	if x == nil then
		--WAR.L_ZXSG = 0;		--防止出现选择武功后取消的情况
		return 0
	end
  
  	if WAR.Person[WAR.CurID]["贴图"] ~= WarCalPersonPic(WAR.CurID) then
		WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
		SetWarMap(x0,y0, 5, WAR.Person[WAR.CurID]["贴图"])
		WarDrawMap(0)
		ShowScreen()
		lib.Delay(CC.BattleDelay)
	end
  
	--使用了辟邪，该招式进入冷却
	--林平之无冷却
	if wugong == 48 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 then
		if not match_ID(pid, 36) then
			WAR.BXLQ[pid][WAR.BXZS] = WAR.BXCD[WAR.BXZS] + 1
		end
	end  
  
  	if wugong == 25 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and wglw(pid,25)>1 then
		if not match_ID(pid, 58) then
			WAR.ARLQ[pid][WAR.ARZS] = WAR.ARCD[WAR.ARZS] + 1
		end
	end 
  
    --判断合击，判断是否有合击者

	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	
	local ZHEN_ID = -1;
	for i = 0, WAR.PersonNum - 1 do
	    local tid = WAR.Person[i]["人物编号"]

		
		if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and i ~= WAR.CurID and WAR.Person[i]["死亡"] == false and WAR.JSCL[WAR.Person[WAR.CurID]["人物编号"]] == nil and WAR.JSCL[WAR.Person[i]["人物编号"]] == nil then
			local nx = WAR.Person[i]["坐标X"]
			local ny = WAR.Person[i]["坐标Y"]
			local fid = WAR.Person[i]["人物编号"]
			local heji = 0
			if wglw(fid,62) > 1  and JLSD(10,35+wglw(fid,62)*10,fid) then--
			heji = 1
			end
	        if ((match_ID_awakened(WAR.Person[WAR.CurID]["人物编号"], 103,1) and fid == 47) or (match_ID_awakened(WAR.Person[WAR.CurID]["人物编号"], 47,1) and fid == 103))	and math.random(10)<7 then
		    heji = 2
	        end			
			
			for j = 1, CC.Kungfunum do
				if JY.Person[fid]["武功" .. j] == wugong  or heji > 0 then
				   if heji>0 and WAR.Person[WAR.CurID]["我方"] then --萧笑竹特殊判定
				      ZHEN_ID = i
					  WAR.HEJI = heji
				      break
			       end
					if math.abs(nx-x0)+math.abs(ny-y0)<9 then
						local flagx, flagy = 0, 0
						if math.abs(nx - x0) <= 1 then
							flagx = 1
						end
						if math.abs(ny - y0) <= 1 then
							flagy = 1
						end
						if x0 == nx then
							flagy = 1
						end
						if y0 == ny then
							flagx = 1
						end
						if between(x, x0, nx, flagx) and between(y, y0, ny, flagy) then
							--合击人的战场编号
							ZHEN_ID = i
							
							--绘画合击的范围
							local tmp_id = WAR.CurID
							WAR.CurID = ZHEN_ID
							WarDrawAtt(WAR.Person[ZHEN_ID]["坐标X"] + x0 - x, WAR.Person[ZHEN_ID]["坐标Y"] + y0 - y, atkfanwei, 4)
							SetWarMap(nx,ny,7,3)
							WAR.CurID = tmp_id
																
							break;
						end
					end
				end
			end
			if ZHEN_ID >= 0 then
				break;
			end
		end
	    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"]  and i ~= WAR.CurID and WAR.Person[i]["死亡"] == false  and (nglw(tid,171)>1  and JLSD(10,35+nglw(tid,171)*10,tid)) then
		ZHEN_ID = i
		WAR.DUIZHAO = 1
		   if nglw(tid,171)>2 and JLSD(0,70,tid) then
		    WAR.DUIZHAO = 2
		   end
		break
		end

	    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"]  and i ~= WAR.CurID and WAR.Person[i]["死亡"] == false  and (D1ZSF(tid)  and JLSD(10,60,WAR.Person[i]["人物编号"])) then
				WAR.Person[i]["反击武功"] = 16
				ZHEN_ID = i
				WAR.DUIZHAO = 1
				WAR.tmp[3000+WAR.Person[i]["人物编号"]] = (WAR.tmp[3000+WAR.Person[i]["人物编号"]] or 0) + 200
				WAR.BG[WAR.Person[i]["人物编号"]] = (WAR.BG[WAR.Person[i]["人物编号"]] or 0) + 200
				WAR.TJZX[WAR.Person[i]["人物编号"]] = (WAR.TJZX[WAR.Person[i]["人物编号"]] or 0) + 2
		break
		end

	end
    
	WarDrawMap(1, x, y)
    WarShowHead(GetWarMap(x, y, 2))
	
	--合击人标识
	if ZHEN_ID ~= -1  then
		local nx = WAR.Person[ZHEN_ID]["坐标X"]
		local ny = WAR.Person[ZHEN_ID]["坐标Y"]
		local dx = nx - x0
		local dy = ny - y0
		local size = CC.FontSmall;
		local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
		local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
									
		local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
		local str = "合击者"
        if WAR.HEJI > 0  then
        str = "合体技"
        end			
		DrawString(rx - size*1.5, ry-hb-size/2, "合击者", M_DeepSkyBlue, size);
	end
  
	--攻击次数
	WAR.ATNum = 1
  
	--判定左右
	local tshb=0
	if match_ID(pid, 154) and wugong == 54 then----
	tshb=1
	end
	if wglw(pid,25)>1 and WAR.ARZS==3 and wugong== 25 then----
	tshb=1
	end
	if match_ID(pid, 628) and wugong == 45 then----
	tshb=1
	end
	if wglw(pid, 77)>=1 and kfkind == 5 then----
	tshb=1
	end
	if YCRW(pid) == 4 and kfkind == 1 then----
	tshb=1
	end	
	if (JY.Person[pid]["左右互搏"] == 1 or tshb==1 )and WAR.ZYHB == 0 then
		--判断左右，80-资质
		local zyjl = 80 - JY.Person[pid]["资质"]
		if zyjl < 0 then
			zyjl = 0
		end
		--论剑打赢周伯通奖励+20%
		if pid == 0 and JY.Person[64]["论剑奖励"] == 1 then
			zyjl = zyjl + 20
		end
		--周伯通100%
		if match_ID(pid, 64) then
			zyjl = 100
		end
	if YCRW(pid) == 4 and kfkind == 1 then----
	zyjl = 50
	end			
		--郭靖80%
		if match_ID(pid, 55) then
			zyjl = 80
		end
		if wglw(pid,25)>1 and WAR.ARZS==3 and wugong== 25 then----
	       zyjl = 50
	    end
        if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 6 then
		   zyjl = 50
		end
		--小龙女70%
		if match_ID(pid, 59) then
			zyjl = 70
		end
		--周芷若70%
		if match_ID(pid, 631) then
			zyjl = 70
		end
		
		if wglw(pid, 77)>=1 and kfkind == 5 then----
	       zyjl=50+(wglw(pid, 77)-1)*15
	    end
		
		if match_ID(pid, 628) and wugong == 45 then----
	       zyjl = 50
	    end
		
		if match_ID(pid, 154) and wugong == 54 then
			zyjl = 50
		end
		
	  if match_ID(pid, 72) and match_ID_awakened(pid, 72, 1) then --田归农刀剑十杀领悟左右初始几率25%
	        zyjl = 50
      end
		--七夕郭靖100%
		--七夕龙女100%
		if match_ID(pid, 612) or match_ID(pid, 615) then
			zyjl = 100
		end
		--暴怒必左右
		if WAR.LQZ[pid] == 100 then
			zyjl = 100
		end
		  
		--斗转星移不触发左右
		if JLSD(0, zyjl, pid) and WAR.DZXY == 0 then
			WAR.ZYHB = 1
		
			--改到特效文字4显示
			if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
				WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."·左右互搏";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "左右互搏";
			end
			
		end
	end
	
	--周伯通触发一次左右后，有几率根据资质追加第二次左右，畅想专属
	if match_ID(pid, 64) and pid == 0 and WAR.ZYHB == 2 and WAR.ZHB == 0 then
		local zyjl = 80 - JY.Person[pid]["资质"]
		if zyjl < 0 then
			zyjl = 0
		end
		--斗转星移不触发左右
		if JLSD(0, zyjl, pid) and WAR.DZXY == 0 then
			WAR.ZYHB = 1
			WAR.ZHB = 1
		
			--改到特效文字4显示
			if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
				WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."·左右互搏";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "左右互搏";
			end
		end
	end

	if D2ZBT(pid) and WAR.ZYHB == 2 and WAR.ZHB == 0 then
		local zyjl = 50
		--斗转星移不触发左右
		if JLSD(10, zyjl+10, pid) and WAR.DZXY == 0 then
			WAR.ZYHB = 1
			WAR.ZHB = 1
		
			--改到特效文字4显示
			if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
				WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."·左右互搏";
			else
				WAR.Person[WAR.CurID]["特效文字4"] = "左右互搏";
			end
		end
	end
	
	--无酒不欢：连击率用函数计算
	local LJ;
	
	LJ = Person_LJ(pid)
	
	--敌人连击+20%
	if WAR.Person[id]["我方"] == false then
		LJ = LJ + 20
	end

	if match_ID_awakened(id,151,1) and WAR.XKZ>0 then
		LJ = LJ + WAR.XKZ*5
	end

	if PersonKF(pid,172) then
		LJ = LJ + 15
		if Curr_NG(pid,172)then
		LJ = LJ + 5
		end
	end

	if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 2 then
	LJ = LJ + 15
	end
	
	if wglw(pid, 49)>=1 and WAR.LMZS == 5 then
	LJ = LJ + 15
	end
	
	--连击率上限100
	if LJ > 100 then
		LJ = 100 
	end
	
	if math.random(100) <= LJ then
		WAR.ATNum = 2
		if wglw(pid,29)>=1 then--
		WAR.ATNum = 3
		end
		if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 2 then
	    WAR.ATNum = 3
	    end
		if wglw(pid, 49)>=1 and WAR.LMZS == 5 and JLSD(10,70,pid) then
		WAR.ATNum = WAR.ATNum + 1
		end
	end
	
	--高连击武功
	local glj = {7, 2, 34, 37, 55, 57, 70, 77}
	for i = 1, 8 do
		if JY.Person[pid]["武功" .. wugongnum] == glj[i] and JLSD(20, 75, pid) then
			WAR.ATNum = 2
			break;
		end
	end
	

	
	--五岳剑法组合额外连击
	if wugong >= 30 and wugong <= 34 and WuyueJF(pid) and JLSD(30, 60, pid) then
		WAR.ATNum = 2
	end
	
		--天衣无缝组合，刀法连击率+30%
	if kfkind == 4 and TianYiWF(pid) and JLSD(30, 60, pid) then
		WAR.ATNum = 2
	end
	
	--萧中慧夫妻必连
	if match_ID(pid, 77) and wugong == 62 then
		WAR.ATNum = 2
	end
	
	--装备鸳鸯刀，夫妻必连
	if (JY.Person[pid]["武器"] == 217 or JY.Person[pid]["武器"] == 218) and wugong == 62 then
		WAR.ATNum = 2
	end
	
	--狄云，水笙连城高连
	if (match_ID(pid, 37) or match_ID(pid, 589)) and wugong == 114 and JLSD(20, 75, pid) then
		WAR.ATNum = 2
	end

	if match_ID_awakened(pid, 589,1) and wugong == 114  then
		WAR.ATNum = 3
	end
	
	--阿青，暴怒越女剑法必连
	if match_ID(pid, 604) and wugong == 156 and WAR.LQZ[pid] == 100 then
		WAR.ATNum = 2
	end
	

	
	--枯荣一阳指高连
	if match_ID(pid, 102) and wugong == 17 and JLSD(20, 75, pid) then
		WAR.ATNum = 2
	end
	
	--小龙女玉女素心剑高连
	if match_ID(pid, 59) and wugong == 139 and JLSD(20, 75, pid) then
		WAR.ATNum = 2
	end
	
	--张三丰，太极拳蓄力超过600，必连
	if wugong == 16 and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 600 and match_ID(pid, 5) then
		WAR.ATNum = 2
	end
	 
	 
	--倚天密道，成昆必定单击
	--天外也不会连击
	if WAR.ZDDH == 237 and pid == 18 then
		WAR.ATNum = 1
		WAR.TWLJ = 2
	end
  
	--无酒不欢：黯然极意和三叠浪
	--杨过和拳系主角才能触发
	if (match_ID(pid, 58) or (pid == 0 and JY.Base["标准"] == 1)) and wugong == 25 and level == 11 then
		local jl = 0;
		WAR.ARJY_LZ = 0
		--内伤大于30时，每点内伤增加1%几率
		if JY.Person[pid]["受伤程度"] > 30 then
			jl = jl + (JY.Person[pid]["受伤程度"]-30);	
		end    
		--生命少于70%时，每少一百生命，机率增加10%
		if JY.Person[pid]["生命"]/JY.Person[pid]["血量翻倍"] < (JY.Person[pid]["生命最大值"]/JY.Person[pid]["血量翻倍"]*0.7) then
			jl = jl + math.ceil(((JY.Person[pid]["生命最大值"]/JY.Person[pid]["血量翻倍"]*0.7) - JY.Person[pid]["生命"]/JY.Person[pid]["血量翻倍"])/10);	  		
		end
		if wglw(pid,25)>1 and WAR.ARZS==2 and wugong== 25 then----第二招必触发极意
		   jl = 101
		end
		if wglw(pid,25)>2 and WAR.LQZ[pid] == 100 then
		   jl = 101
		end
		--几率大于0才触发
		if jl > 0 then
			--暴怒必触发
			if WAR.LQZ[pid] == 100 or jl > Rnd(100) then
				WAR.ARJY = 1
				if wglw(pid,25)>2 and WAR.LQZ[pid] == 100 then
				WAR.ARJY_LZ = WAR.ARZS
				local qljj = {"六情·眼看喜·欣然销魂掌",
			   "六情·耳听怒·愤然销魂掌",
			   "六情·身本忧·黯然销魂掌",
               "六情·舌尝思·豁然销魂掌",
			   "六情·鼻嗅爱·诚然销魂掌",
			   "六情·意见欲·酣然销魂掌"}
			    local color = {M_DeepSkyBlue,M_Red,M_PaleGreen,M_LemonChiffon,M_Pink,M_SandyBrown}
		        NEWTXWZ(qljj[WAR.ARJY_LZ],color[WAR.ARJY_LZ])
				end
				if wglw(pid,25)>1 and WAR.ARZS ==2 and wugong== 25 and (JLSD(20,70+10*wglw(pid,25),pid) or (WAR.LQZ[pid]~=nil and WAR.LQZ[pid] == 100)) then--黯然招式第二招
                    WAR.ATNum = 3
					local CXLC2 = 3
					for i = 1, CXLC2  do
					   WAR.ATNum = WAR.ATNum +1   
		               if WAR.ARJY_LZ == 2 and math.random(1,10)>=5 then
		               CXLC2 = CXLC2 + 1
		               end
					end
				   	for i = 1, 30 do
						DrawStrBox(-1, 24, "黯然奥义.无中生有.无处不销魂", M_DeepSkyBlue, 10 + i)
						ShowScreen()
						lib.Delay(10)
					end
				elseif JY.Person[pid]["资质"] >= 50 then--资质大于等于50才能触发三叠浪
					WAR.ATNum = 3;
					for i = 1, 30 do
						DrawStrBox(-1, 24, "黯然销魂.物我两忘.黯然三叠浪", M_DeepSkyBlue, 10 + i)
						ShowScreen()
						lib.Delay(10)
					end
				else
					WAR.ATNum = 2;
				end
			end
		end
	end
	
	--乔峰
	if match_ID(pid, 50) then
		if WAR.ZDDH == 83 and WAR.FS == 0 then   --打四帮主时的乔峰
			say("１（唉，这些年轻人闯荡江湖也不容易，也罢，此战就以Ｒ太祖长拳Ｗ来陪你们玩玩吧！）", 50)
			WAR.FS = 1
		end
		JY.Wugong[13]["名称"] = "太祖长拳"

		--如果乔峰用的是降龙，那么有40%的机率三连击，怒气暴发时必三连
		if wugong == 26 and (JLSD(35, 75, pid) or WAR.LQZ[pid] == 100) then
			WAR.ATNum = 3
			WAR.FS = 1
			for i = 1, 30 do
				DrawStrBox(-1, 24, "六军辟易.奋英雄怒.降龙三叠浪", M_Red, 10 + i)   -- 降龙三叠浪在这里
				ShowScreen()
				lib.Delay(10)
			end
			if match_ID_awakened(pid, 50,1) then--
			WAR.ATNum = 4
			end
		end

		--NPC乔峰回内
		if inteam(pid) == false or match_ID_awakened(pid, 50,1) then
			if JY.Person[pid]["内力"] < 1000 then
				JY.Person[pid]["内力"] = 1200 + math.random(100)
			end
		end
	end


	
	--拳主角有30%几率触发降龙三叠浪，暴怒必触发
	if (pid == 0 and JY.Base["标准"] == 1) and wugong == 26 and level == 11 then
		if JLSD(30, 60, pid) or WAR.LQZ[pid] == 100 then
			WAR.ATNum = 3
			for i = 1, 30 do
				DrawStrBox(-1, 24, "降龙真传.登峰造极.降龙三叠浪", M_Red, 10 + i)
				ShowScreen()
				lib.Delay(10)
			end
		end
	end
	
	--桃花绝技，有40%几率三连击，暴怒必触发
	if (wugong == 12 or wugong == 18 or wugong == 38) and TaohuaJJ(pid) and (WAR.LQZ[pid] == 100 or JLSD(35, 75, pid)) then
		WAR.ATNum = 3
		for i = 1, 30 do
			DrawStrBox(-1, 24, "桃花绝技·奇门五转", PinkRed, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
	
	--令狐冲二次觉醒后，40%几率动如雷震，暴怒必触发
	if match_ID_awakened(pid, 35, 2) and (WAR.LQZ[pid] == 100 or JLSD(35, 75, pid)) and WAR.DZXY ~= 1 then
		WAR.ATNum = 3
		for i = 1, 30 do
			DrawStrBox(-1, 24, "剑魔再临·动如雷震", M_Red, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end

  if match_ID_awakened(pid,152,1) and kfkind==3 and WAR.DZXY ~= 1 then --无尘觉醒后用剑必连击，50%几率3-5连击
	WAR.ATNum = 2
	if JLSD(10, 60, pid) then
		WAR.WCLJ = 1
		WAR.ATNum = math.random(3, 5)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "追魂夺命·雷霆追击", OliveDrab, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
  end

    if match_ID_awakened(pid,161,1) and kfkind==1 and WAR.DZXY ~= 1 then 
	   WAR.ATNum = 2
	   if JLSD(10, 60, pid) then
		  WAR.ATNum = 3
		  for i = 1, 30 do
			DrawStrBox(-1, 24, "五毒秘传·三无三不手", OliveDrab, 10 + i)
			ShowScreen()
			lib.Delay(10)
		   end
	end
    end
  
   if match_ID_awakened(pid,69,1)  then --李逍遥醉仙
	if WAR.HQGS2 > 0 then
		WAR.ATNum =  math.random(3, 5)
		if WAR.LQZ[pid]~= nil and WAR.LQZ[pid] == 100 then
		WAR.ATNum =5
		end	
	end
  end	
	
	--七夕赵敏必三连
	--七夕龙女必三连
	if match_ID(pid, 609) or match_ID(pid, 615) then
		WAR.ATNum = 3
	end
	
	--七夕杨过，必三叠浪
	if match_ID(pid, 614) and wugong == 25 then
		WAR.ATNum = 3
		WAR.ARJY = 1
		for i = 1, 30 do
			DrawStrBox(-1, 24, "黯然销魂.物我两忘.黯然三叠浪", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	end
  
   	if kfkind == 3 and Curr_NG(pid, 90) and nglw(pid,90)>1  then
	    WAR.ATNum = 3
	    if JLSD(20,90,pid) or (MPPB_WYJZ(pid) == 1 and JLSD(20,90,pid))then
	    WAR.JGHJ = 333
        end
		for i = 1, 30 do
			DrawStrBox(-1, 24, "气剑冲霄.奥义.夺命连环三仙剑", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end	   
    end	 
  
  	if wglw(pid, 22)>2 and wugong == 22 and WAR.Actup[pid]~=nil then
		WAR.ATNum = 3
		WAR.ARJY = 1
		for i = 1, 30 do
			DrawStrBox(-1, 24, "金刚奥义.斗气.刚掌真空波", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		WAR.JGDQ[pid] = 30
	end

	if match_ID_awakened(pid, 27,1) and wugong == 105 then--东方不败葵花三连
	   WAR.ATNum = 2
	   if JLSD(20,70,pid) then
	      WAR.ATNum = 3
	      for i = 1, 30 do
			DrawStrBox(-1, 24, "风云际会.葵影三重.尘世如潮人如水", M_LightBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		  end 
        end 
	end


	
	--蓝烟清：装备真武剑时使用太极剑法必连击
	if JY.Person[pid]["武器"] == 236 and wugong == 46 then
		WAR.ATNum = 2;
	end
	
	--尼摩星必定单击
	if match_ID(pid, 159) then
		WAR.ATNum = 1
	end
  
  	--进阶太岳，连击时为三连击
	if wugong == 34 and nglw(pid, 89)>=1 and WAR.ATNum == 2 then
		WAR.ATNum = 3
	end

	if wglw(pid, 74)>=1 and WAR.SHJG[pid] ~=nil and WAR.SHJG[pid]==1 and WAR.ATNum == 2 then
		WAR.ATNum = 3
	end

	if pid == WAR.AXL and WAR.ACT == 1 then --武骧金星：阿修罗指令必连击
		WAR.ATNum = WAR.ATNum + 1
	end	
 
    if force_ID(pid) and WAR.ATNum >= 2 and WAR.ACT == 1 then
	   WAR.ATNum = WAR.ATNum + 1
	end
 
	WAR.ACT = 1
	WAR.FLHS6 = 0

	
	
	--斗转
	if WAR.DZXY == 1 then
		--慕容博两次，其他人一次
		if match_ID(pid, 517) then
		    WAR.ATNum = 3
		elseif wglw(pid,43)>1 and yongquan(wugong) then
		    WAR.ATNum = 3
		elseif match_ID(pid, 113) then
			WAR.ATNum = 2
		elseif WAR.TJXY[pid] ~= nil then
		
		else
			WAR.ATNum = 1
		end
		if WAR.YCHX == 1 and wglw(pid,74)>1  then
		   WAR.CXLC = 1
		end
	end 

    if WAR.YTTL == 1 then
	   if wglw(pid,64)>2 then
	   
	   else
	   WAR.ATNum = 1
	   end
	end

	if WAR.XTCJ == 1 then
       WAR.ATNum = 1
	end	
 
    if WAR.HSDF_DF == 1 then
	   WAR.ATNum = 1
	end
 
  while WAR.ACT <= WAR.ATNum do
	if JY.Restart == 1 then
		break
	end
	lib.GetKey()
    if WAR.WS == 1 then
      WAR.WS = 0
    end
    if WAR.BJ == 1 then
      WAR.BJ = 0
    end
    if WAR.BJ2 == 1 then
      WAR.BJ2 = 0
    end
    if WAR.DJGZ >= 1 then
      WAR.DJGZ = 0
    end

   if WAR.HSDF > 0 then
   WAR.HSDF=0
   end
  if  WAR.HSDF_STNJ > 0 then
  WAR.HSDF_STNJ=0
  end
  
  if  WAR.HSDF_DF1 >0  then
  WAR.HSDF_DF1=0
  end

  if  WAR.LM_JQ1 >0  then
  WAR.LM_JQ1=0
  end
  
   if  WAR.LM_JQ2 >0  then
  WAR.LM_JQ2=0
  end 

	if WAR.WSZJ>= 1 then
	WAR.WSZJ = 0
	end
	
    if WAR.TJYQ >= 1 then
      WAR.TJYQ = 0
    end
    if WAR.TJYQ1 >= 1 then
      WAR.TJYQ1 = 0
    end
    if WAR.WJJS >= 1 then
      WAR.WJJS = 0
    end
    if WAR.LZPX >= 1 then
      WAR.LZPX = 0
    end	
    if WAR.LXZL >= 1 then
      WAR.LXZL = 0
    end	
    if WAR.XMJY >= 1 then
      WAR.XMJY = 0
    end
    if WAR.SXJZ >= 1 then
      WAR.SXJZ = 0
    end

    if WAR.YTMX >= 1 then
      WAR.YTMX = 0
    end
	
    if WAR.DJGZ3 >= 1 then
      WAR.DJGZ3 = 0
    end
    if WAR.WMSF >= 1 then
      WAR.WMSF = 0
    end
    if WAR.TPHS >= 1 then
      WAR.TPHS = 0
    end
	if WAR.KFKJ2 >= 1 then----
	  WAR.KFKJ2 = 0
	end
	
	if WAR.NSTJ1>=1 then
	WAR.NSTJ1 = 0
	end

    if WAR.MYJY >0 then
	WAR.MYJY = 0
	end

	if WAR.NSTJ2>=1 then
	WAR.NSTJ2 = 0
	end
	
	if WAR.XTDJ>=1 then
	WAR.XTDJ = 0
	end

	if WAR.MRF>=1 then
	WAR.MRF = 0
	end

	if WAR.MRF1>=1 then
	WAR.MRF1 = 0
	end
	
    if WAR.SPT >= 1 then
      WAR.SPT = 0
    end	
	if WAR.SPT1 >= 1 then
      WAR.SPT1 = 0
    end	
	if WAR.LQS >=1 then
	  WAR.LQS = 0
	end
	if WAR.JGHJ >= 1 then
      WAR.JGHJ = 0
    end
	if WAR.RWZ >= 1 then
      WAR.RWZ = 0
    end
	if WAR.BLC >= 1 then
      WAR.BLC = 0
    end
	if WAR.SZH >= 1 then
      WAR.SZH = 0
    end

	if WAR.WDZ >= 1 then
      WAR.WDZ = 0
    end
    if WAR.XXPG >= 1 then
      WAR.XXPG = 0
    end
	if WAR.DJGZ2 >=  1 then
      WAR.DJGZ2 = 0
    end
	if WAR.QSLX >=  1 then
      WAR.QSLX = 0
    end
	if WAR.QSLX_SY >=  1 then
      WAR.QSLX_SY = 0
    end
	if WAR.BLQJ >=  1 then
      WAR.BLQJ = 0
    end
	if WAR.JYBG >=  1 then
      WAR.JYBG = 0
    end	
	if WAR.MCF >=  1 then
      WAR.MCF = 0
    end	
	if WAR.HYS >=  1 then
      WAR.HYS = 0
    end		
    if WAR.JYWR_CF > 0 then
	WAR.JYWR_CF = 0
	end
	if WAR.LXJY >=  1 then
      WAR.LXJY = 0
    end	
	if WAR.YANGKANG >=  1 then
      WAR.YANGKANG = 0
    end	
	if WAR.PLGF >=  1 then
      WAR.PLGF = 0
    end
	
	if WAR.GPQG >0 then
      WAR.GPQG = 0
    end	
	
	if WAR.XLDF >=  1 then
      WAR.XLDF = 0
    end

	if WAR.XLBD >=  1 then
      WAR.XLBD = 0
    end	
	
	if WAR.WJDF >=  1 then
      WAR.WJDF = 0
    end
	if WAR.LSDF >=  1 then
      WAR.LSDF = 0
    end	
	
	if WAR.YSDF >= 1 then
	WAR.YSDF = 0
	end
	
	if WAR.WYSQ >=  1 then
	WAR.WYSQ = 0
	end
	
	if WAR.WSDL >=  1 then
      WAR.WSDL = 0
    end

	 if WAR.HDMC >= 1 then
	   WAR.HDMC = 0
	 end
	 if WAR.HDMC2 >= 1 then
	   WAR.HDMC2 = 0
	 end
	if WAR.ZBT3 >0 then
      WAR.ZBT3 = 0
    end
	if WAR.DFMQ >0 then
      WAR.DFMQ = 0
    end
	if WAR.FMZF >0 then
      WAR.FMZF = 0
    end
	if WAR.DZDJ>=1 then
	 WAR.DZDJ = 0
	end
	if WAR.DZDJ1>=1 then
	 WAR.DZDJ1 = 0
	end
	if WAR.DZDJ2>=1 then
	 WAR.DZDJ2 = 0
	end
	if WAR.ZJZC >=  1 then
      WAR.ZJZC = 0
    end
	if WAR.YXMQ >=  1 then
      WAR.YXMQ  = 0
    end
	if WAR.LYBF >= 1 then
      WAR.LYBF = 0
    end
	if WAR.XLMH >= 1 then
      WAR.XLMH = 0
    end
	if WAR.DGXF>= 1 then
	  WAR.DGXF = 0
	end
	if WAR.DSXF>= 1 then
	  WAR.DSXF = 0
	end
	if WAR.DGXF_KQ>= 1 then
	  WAR.DGXF_KQ = 0
	end
	
	if WAR.RMDY >=  1 then
      WAR.RMDY = 0
    end
	if WAR.RMDY2 >=  1 then
      WAR.RMDY2 = 0
    end
	if WAR.HBMZ >=  1 then
      WAR.HBMZ = 0
    end
	if WAR.XYYZ >=  1 then
      WAR.XYYZ = 0
    end
	if WAR.ZBXZ >=  1 then
      WAR.ZBXZ = 0
    end	
	if WAR.XDDF2>= 1 then
	WAR.XDDF2 = 0
	end
	if  WAR.DJDAO==1 then----
	WAR.DJDAO=0 --田归农胡刀
	end
    if WAR.DJJIAN==1 then
	  WAR.DJJIAN=0 --田归农苗剑
	end
	if WAR.DJSX==1 then----
	WAR.DJSX=0
	end
	if WAR.JGZB>= 1 then
	WAR.JGZB =0
	end
	if  WAR.LQAY>= 1 then
	WAR.LQAY = 0
	end
	if  WAR.CYJG>= 1 then
	WAR.CYJG = 0
	end
	if  WAR.DJDAO2==1 then----
	WAR.DJDAO2=0 --田归农胡刀
	end
    if WAR.DJJIAN2==1 then
	  WAR.DJJIAN2=0 --田归农苗剑
	end
	if WAR.YYDAO==1 then
	WAR.YYDAO = 0
	end
	if WAR.YYDAO_PK>=1 then
	WAR.YYDAO_PK = 0
	end
	if WAR.YYDAO_HB>=1 then
	WAR.YYDAO_HB = 0
	end
	if WAR.YYDAO_HX>=1 then
	WAR.YYDAO_HX = 0
	end
	if WAR.JZTX >=1 then
	WAR.JZTX = 0
	end
	if WAR.DJSX2==1 then----
	WAR.DJSX2=0
	end
	if WAR.HUANJIAN==1 then----
	WAR.HUANJIAN=0
	end
	if WAR.BADAO==1 then----
	WAR.BADAO=0
	end
	if WAR.YY>0 then----
	WAR.YY=0
	end
	if WAR.YY2>0 then----
	WAR.YY2=0
	end
	if WAR.YY3>0 then----
	WAR.YY3=0
	end
	if WAR.HYTZ >0 then
      WAR.HYTZ = 0
    end
	if WAR.LMBJ4 >0 then
      WAR.LMBJ4 = 0
    end
	if WAR.KHSL >0 then
      WAR.KHSL = 0
    end
    if WAR.KUIHUADZ > 0 then
	 WAR.KUIHUADZ = 0
	end	
    if WAR.KUIHUAHJ > 0 then
	 WAR.KUIHUAHJ = 0
	end	

	
	if WAR.FLHS3>0 then
	WAR.FLHS3=0
	end
    if WAR.HQT == 1 then
      WAR.HQT = 0
    end
    if WAR.CY == 1 then
      WAR.CY = 0
    end
    if WAR.WQQ == 1 then
      WAR.WQQ = 0
    end	
    if WAR.YKX >= 1 then
      WAR.YKX = 0
    end
   if WAR.YKX1 >= 1 then
      WAR.YKX1 = 0
    end
   if WAR.YKX2 >= 1 then
      WAR.YKX2 = 0
    end
    if WAR.FHJ== 1 then
      WAR.FHJ= 0
    end
    if WAR.TFH == 1 then
      WAR.TFH = 0
    end
    if WAR.HDWZ == 1 then
      WAR.HDWZ = 0
    end

    if WAR.XYTZ >= 1 then
      WAR.XYTZ = 0
    end

    if WAR.ASKD2 >= 1 then
      WAR.ASKD2 = 0
    end

    if WAR.XLAY > 0 then
	WAR.XLAY = 0
	end
    if WAR.XLAY_BL > 0 then
	WAR.XLAY_BL = 0
	end
    if WAR.XLZS > 0 then
	WAR.XLZS = 0
	end
	if WAR.XLZS_QH>0 then
	WAR.XLZS_QH = 0
	end
    WAR.XDDF = 0
    WAR.NGJL = 0
	WAR.TZQJ = 0
	WAR.TZWY = 0
	
    WAR.TONY = 0
    WAR.TONY1 =  0
	WAR.TONY2 =  0
	WAR.TONY3 = 0


    WAR.KHBX = 0
    WAR.GBWZ = 0
	WAR.GBWZ3 = 0
    WAR.BSMT = 0
    WAR.LXZQ = 0

	WAR.LXYZ = 0
    WAR.GCTJ = 0
    WAR.ASKD = 0
  WAR.ASKD1 = 0
    WAR.JSYX = 0
    WAR.BMXH = 0
    WAR.HFYD = 0 
	WAR.BHCQ = 0
	   WAR.FMY = 0
  WAR.DLY = 0   --游坦之大招

  	WAR.DFWM=0 --东方未明特效1
	WAR.DFWM2=0 --东方未明特效2
	WAR.DFWM2P=0 --东方未明特效2
	WAR.DFWMXX=0 --东方未明吸血
	WAR.DFWM3P=0

WAR.LHXX = 0
WAR.LHXX2 = 0

  
  WAR.LX_SSF=0  --虚竹大招
  WAR.LMJQ = 0 
  WAR.MR_XLWC = 0
    WAR.TD = -1
	WAR.TDnum = 0
    WAR.TZ_XZ = 0
    WAR.JGZ_DMZ = 0
    WAR.LHQ_BNZ = 0
	WAR.LHQ_FM = 0
	WAR.LHQ_FM2 = 0
	WAR.RMD_FM = 0
	WAR.LHQ_WX = 0
	WAR.LHQ_WX1 = 0
	
	WAR.LH_DZ = 0
	WAR.SHAOLIN2 = 0
	
	WAR.JW_FM = 0
	WAR.FMZ_FM = 0
	WAR.XLZ_FM = 0
	
	WAR.GTSHAQI=0 --主功体杀气
	WAR.GTPID2=-1 --主功体杀气使用者	
	WAR.GTNUQI=0 --主功体减怒气值
	WAR.GTPID3=-1 --强制减怒使用者
	
	
	WAR.WD_CLSZ = 0		--赤练神掌
	WAR.BXJY = 0
	WAR.TXZQ = {}		--太玄之轻清除记录

    CleanWarMap(4, 0)
    WAR.L_NSDFCC = 0;	--南山刀法是否触发
	
	WAR.L_TJQ = 0
	
	WAR.L_WYJFA1 = 0;
	WAR.L_WYJFA2 = 0;
	WAR.L_WYJFA3 = 0;
	WAR.L_WYJFA4 = 0;
	WAR.L_WYJFA5 = 0;	
    WAR.L_TLD = 0		--装备屠龙刀特效，流血
	WAR.L_TLD1 =0
	WAR.L_CZJT = 0;			--蟾震九天 默认为0
	WAR.L_CZJT1 = 0         --蛤蟆九天17-2-23
	WAR.PJTX = 0 		--玄铁剑配玄铁剑法，破尽天下

	WAR.CXLC = 0		--狄云赤心连城
	WAR.CXLC2 = 0
	WAR.CXLC3 = 0
	WAR.FM_XLD = 0
	


	WAR.FQY = 0			--风清扬无招胜有招
	WAR.FS2 = 0
    
	WAR.TWBL = 0
	WAR.YTML = 0 		--毒王大招
	WAR.YTML1 = 0
	WAR.JSTG = 0		--天罡大招
	WAR.TXZZ = 0		--太玄之重
	WAR.JSAY = 0		--金蛇奥义
	WAR.QJJQ = 0
	WAR.JSKW = 0		--金蛇狂舞
	WAR.OYFXL = 0 		--欧阳锋根据蛤蟆蓄力增加伤害
	WAR.XDLeech = 0		--血刀吸血量
	WAR.WYXLeech = 0	--韦一笑吸血量
	WAR.JWLeech = 0    --大日回血
	WAR.TMGLeech = 0	--天魔功吸血量
	WAR.LKXZLeech = 0   --六库仙贼回血
	WAR.XHSJ = 0		--血河神鉴回血量
	WAR.KMZWD = 0 	--周伯通空明之武道
	WAR.KMZWD2 = 0 	--周伯通空明之武道
	WAR.XXYY=0--莫大潇湘夜雨
	WAR.LFHX = 0 	--林朝英流风回雪
	WAR.YNXJ = 0	--夭矫空碧
	WAR.YYBJ = 0 	--郭靖：有余不尽
	WAR.OYK = 0 		--欧阳克灵蛇拳
	WAR.OYF = 0

		WAR.THSB = 0        --桃花三宝
		WAR.THSB1 = 0       --真·桃花三宝
		WAR.THSB2 = 0       --真·桃花三宝
		WAR.THSB3 = 0       --真·桃花三宝
		WAR.THSB4 = 0       --真·桃花三宝
	
	WAR.YCHX = 0
	WAR.LSFJ = 0
	
	WAR.XSBTQ = 0
	WAR.XSBTQ2 = 0
	WAR.XSBTQ3 = 0
--罗汉系列	
	WAR.TMXZ = 0
	WAR.LHT = 0
	WAR.LXFM = 0
	WAR.NGXS = 0	--内功攻击的系数
	WAR.TYJQ = 0	--阿青天元剑气
	
	WAR.QQSH1 = 0	--琴棋书画之持瑶琴
	WAR.QQSH2 = 0	--琴棋书画之妙笔丹青
	WAR.QQSH3 = 0	--琴棋书画之倚天屠龙功
	WAR.SXB = 0 --神仙笔
	WAR.SXB2 = 0
	WAR.XXTT = {}
	
	WAR.CMDF = 0	--沧溟刀法
	
	WAR.HTS = 0	--何铁手五毒随机2-5倍威力
	WAR.YZQS = 0	--一震七伤
	WAR.YZQS1 = 0		--一震七伤
	WAR.LFHM = 0
	WAR.LFHM2 = 0
	WAR.JJZC = 0		--九剑真传的4种主动攻击特效，攻击后会清0
	WAR.TGDQ7 = 0
	WAR.TGDQ3 = 0

    
    WAR.L_QKDNY = {}	--重新计算乾坤大挪移是否被反弹过
	WAR.TXXS = {} 	--特效点数显示

	WAR.AXYY = {}			--暗香月影
 	WAR.YJZD2[pid] = nil
	if WAR.YJZDPD[pid] == 1 then
		WAR.YJZDPD[pid] = nil
		WAR.YJZD2[pid] = {
						JY.Person[pid]["受伤程度"], 
						JY.Person[pid]["中毒程度"], 
						WAR.FXDS[pid],
						WAR.LXZT[pid],
						JY.Person[pid]["冰封程度"],
						JY.Person[pid]["灼烧程度"],
						WAR.CHZ[pid],
						WAR.MBZ[pid],
						}	
		JY.Person[pid]["受伤程度"] = 0
		JY.Person[pid]["中毒程度"] = 0
		WAR.FXDS[pid] = nil
		WAR.LXZT[pid] = nil
		WAR.CHZ[pid]= nil
		WAR.MBZ[pid]= nil
		JY.Person[pid]["冰封程度"] = 0
		JY.Person[pid]["灼烧程度"] = 0
		DIYdisplay(CC.ASKILL[2][2])
	end   
    WarDrawAtt(x, y, atkfanwei, 3)
    if ZHEN_ID >= 0 then
		local tmp_id = WAR.CurID
		WAR.CurID = ZHEN_ID
		local tid = WAR.Person[ZHEN_ID]["人物编号"]
		local did = WAR.Person[tmp_id]["人物编号"]
		if WAR.DUIZHAO == 1 and (nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>1 or D1ZSF(WAR.Person[ZHEN_ID]["人物编号"])) then --17-1-3
	       WAR.TJXL[did] = 1
		   if WAR.YYJ[tid]~=nil and WAR.YYJ[tid] == 1 and nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>2 then
		   WAR.TJYQ2 = math.random(1,2)
		   local str1 ={"太极衍化.少阴青龙","太极衍化.太阴玄武"}
		   DIYdisplay("【太极.四象衍化】")
		   DIYdisplay(str1[WAR.TJYQ2])
		   end
		   if WAR.TJYQ2 == 2  then
           WAR.LRHF[did] = (WAR.LRHF[did] or 0) + 10
              if WAR.LRHF[did]>=35 then
              WAR.ICE2[did] = 1
              end			  
		   elseif WAR.TJYQ2 == 1 then
		   JY.Person[tid]["生命"] = JY.Person[tid]["生命"] + 100
		   WAR.L_HQNZL[tid] = 10		   
		   end
		   WAR.YYJ[tid] = (WAR.YYJ[tid] or 0) + 1
		   if WAR.YYJ[tid]>2 then
		   WAR.YYJ[tid] = 1
		   end
		   if PersonKF(WAR.Person[ZHEN_ID]["人物编号"],43) then
		   WAR.TJXY[WAR.Person[ZHEN_ID]["人物编号"]] = 1
		    WAR.TJZX[WAR.Person[ZHEN_ID]["人物编号"]] = (WAR.TJZX[WAR.Person[ZHEN_ID]["人物编号"]] or 0) + nglw(WAR.Person[ZHEN_ID]["人物编号"], 171)*2+1
		    if WAR.TJZX[WAR.Person[ZHEN_ID]["人物编号"]] > 10+nglw(WAR.Person[ZHEN_ID]["人物编号"],171) then
			   WAR.TJZX[WAR.Person[ZHEN_ID]["人物编号"]] = 10+nglw(WAR.Person[ZHEN_ID]["人物编号"],171)
		    end
		   end
		   if D1ZSF(WAR.Person[ZHEN_ID]["人物编号"]) or nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>2 then
		   WAR.TJXL[WAR.Person[tmp_id]["人物编号"]] = 2
		   end
		elseif WAR.DUIZHAO == 2 and nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>2 then
		    WAR.YHLP = 1
			WAR.PZPID = pid
		   if WAR.YYJ[tid]~=nil and WAR.YYJ[tid] == 1 and nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>2 then
		       WAR.TJYQ2 = math.random(1,2)
		       local str1 ={"太极衍化.少阴青龙","太极衍化.太阴玄武"}
			   DIYdisplay("【太极.四象衍化】")
		       DIYdisplay(str1[WAR.TJYQ2])
		   end			
		   WAR.YYJ[tid] = (WAR.YYJ[tid] or 0) + 1
		   if WAR.YYJ[tid]>2 then
		   WAR.YYJ[tid] = 1
		   end			
	    elseif WAR.Person[WAR.CurID]["我方"] and WAR.HEJI > 0 then 
		    if WAR.HEJI == 1 and wglw(WAR.Person[ZHEN_ID]["人物编号"],62)>1 then
			  WAR.LFHM = math.random(1,2)
		       local str1 ={"丹凤鸣.火舞九霄","青鸾鸣.端坐霜天"}
			   DIYdisplay("【合击.鸾凤和鸣】")
		       DIYdisplay(str1[WAR.LFHM])			  
            end	
		   	  CleanWarMap(4, 0)
              for i = 0, WAR.PersonNum - 1 do
                   if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                      SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                   end
              end				
		else
	       WarDrawAtt(WAR.Person[ZHEN_ID]["坐标X"] + x0 - x, WAR.Person[ZHEN_ID]["坐标Y"] + y0 - y, atkfanwei, 3)
	    end 
	
        
		WAR.CurID = tmp_id
    end
	
    --判断攻击次数大于1
    if WAR.ACT > 1 then   
		local A = "连击"    --显示连击
		if WAR.TWLJ == 1 then
			A = "天赋外功.炉火纯青"
		end
		if WAR.TJZX_LJ == 1 then
			A = "太极之形.圆转不断"
			WAR.TJZX_LJ = 0
		end
		if WAR.GBGF_LJ>= 1 and (MPPB_GB(pid) == 1 or MPPB_GB(pid) == 3) and kfkind == 5 then
			A = "净衣侠丐.连环棍舞"
			WAR.GBGF_LJ  = WAR.GBGF_LJ - 1
			if match_ID(pid,458) then
			A = "无极醉棍.风行"
			   if JLSD(10,40,pid) then
			   WAR.GBGF_LJ  = WAR.GBGF_LJ + 1
			   WAR.ATNum = WAR.ATNum + 1
			   end
			end
			if WAR.GBGF_LJ <= 0 then
			WAR.GBGF_LJ = 0
			end

		end
		if WAR.GBGF_LJ>= 1 and match_ID(pid,58) and kfkind == 3 then
			A = "翩翩君子.连剑舞天"
			WAR.GBGF_LJ  = WAR.GBGF_LJ - 1
			if WAR.GBGF_LJ <= 0 then
			WAR.GBGF_LJ = 0
			end
		end
		if WAR.GBGF_LJ>= 1 and match_ID(pid,360) and YCDJ(pid)>0 and kfkind == 4 then
			A = "逍遥.无极刀光"
			WAR.GBGF_LJ  = WAR.GBGF_LJ - 1
			if WAR.GBGF_LJ <= 0 then
			WAR.GBGF_LJ = 0
			end
		end
		--夫妻刀法
		if wugong == 62 then
			--萧中慧
			if match_ID(pid, 77) then
				A = "碧箫声里双鸣凤"
			--主角男性
			elseif pid == 0 and JY.Person[0]["性别"] == 0 then
				A = "英雄无双风流婿"
			--主角女性
			elseif pid == 0 and JY.Person[0]["性别"] ~= 0 then
				A = "刀光掩映孔雀屏"
			end
		--阿青，暴怒越女剑法
		elseif wugong == 156 and match_ID(pid, 604) and WAR.LQZ[pid] == 100 then
			A = "闪电惊鸿"
		end
		--东方不败
		if match_ID(pid, 27) then
			A = "风云再起"
		end
		if ((KUIHUA(pid) == 0 and nglw(pid,105)>1)  ) and (wugong == 105 or kfkind == 2 )then
			A = A.."·神月葵影"
	        if WAR.ACT == 2 then	
		    A = A..".豺华"
			WAR.KHSL=2 
			WAR.JZTX = 164
		    elseif WAR.ACT >= 3 then	
		    A = A..".焰瓯"
			WAR.KHSL=3 
			WAR.JZTX = 159
	        end 
		end
		
		if (nglw(pid,105)>1 and KUIHUA(pid) == 1) and (wugong == 105 or kfkind == 1 ) then
			A = "·圣日葵形"
            if WAR.ACT == 2 then	
		    A = A..".九伤"
			WAR.KHSL=5 
			WAR.JZTX = 118
		    elseif WAR.ACT >= 3 then	
		    A = A..".八锖"
			WAR.KHSL=6 
			WAR.JZTX = 143
	        end 
		end


		if ((KUIHUA(pid) == 2 and nglw(pid,105)>1)  ) and (wugong == 105 or kfkind == 5 )then
			A = A.."·仙星葵影"
	        if WAR.ACT == 2 then	
		    A = A..".天瑞"
			WAR.KHSL=8 
			WAR.JZTX = 52
		    elseif WAR.ACT >= 3 then	
		    A = A..".玉响"
			WAR.KHSL=9 
			WAR.JZTX = 159
	        end 
		end
		
		--七夕赵敏
		if match_ID(pid, 609) then
			A = "搏命三招"
		end
		if match_ID_awakened(pid,151,1) then
			A = "奔雷散手.流星拳"
		end
	  if pid == 0 and JY.Base["标准"] > 0 and JY.Base["天书数量"]>=6 then 
		 local pz=math.modf((101-JY.Person[pid]["资质"])/5) 
		 if WAR.ACT == 2 and JLSD(10,90+pz,pid) then 
		    A = "隼旋初式"
			WAR.LMBJ4=1
		 elseif WAR.ACT == 3 and JLSD(10,60+pz,pid)then	
		    A = "隼旋次式"
			WAR.LMBJ4=2 
		elseif WAR.ACT >= 4 and JLSD(10,40+pz,pid)then	
		    A = "隼旋终式"
			WAR.LMBJ4=3 
	  end 
	  end
	  if MPPB_GB(pid) >=2 then --乌衣丐帮
	     if WAR.ACT == 2 and JLSD(10,90,pid) then 
		    A = "污衣丐帮.傲血战意"
			WAR.LMBJ5=1
		 elseif WAR.ACT == 3 and JLSD(10,60,pid)then	
		    A = "污衣丐帮.傲骨战意"
			WAR.LMBJ5=2 
		elseif WAR.ACT >= 4 and JLSD(10,40,pid)then	
		    A = "污衣丐帮.傲魂战意"
			WAR.LMBJ5=3 
	  end 
	  end
		--改到特效文字4显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."·".. A
		else
			WAR.Person[WAR.CurID]["特效文字4"] = A;
		end
    end
	
	--玉女心经：进趋如风，第一击有几率发动，追加一次连击
	if Curr_NG(pid, 154) and WAR.ACT == 1 then
		local ynjl = 0;
		if pid == 0 then
			ynjl = 5
		end
		--七夕龙女必发动
		if match_ID(pid, 615) or WAR.LQZ[pid] == 100 or JLSD(30, 30 + JY.Base["天书数量"] + ynjl, pid) then
			WAR.ATNum = WAR.ATNum + 1
			Set_Eff_Text(id,"特效文字1","进趋如风");
		end
	end

	
	
	if nglw(pid,105)>1 and WAR.ACT == 1 then
	    local A = ""    
        if KUIHUA(pid) == 0 and (wugong == 105 or kfkind == 2 ) then--
           A="阴葵起势.梦弹"
		   WAR.KHSL = 1
		   if WAR.KUIJUE[pid]~= nil and WAR.KUIJUE[pid] == 0 then
		    A="里百八式.八酒杯"
		   WAR.KUIHUADZ = 1
		   WAR.KUIJUE[pid] = nil
		   WAR.JZTX = 180
		   end
		end
        if (wugong == 105 or kfkind == 1 ) and KUIHUA(pid) == 1 then--
		   A="阳葵起势.荒咬"
		   WAR.KHSL = 4
		   WAR.JZTX = 158
		   if WAR.KUIJUE[pid]~= nil and WAR.KUIJUE[pid] == 1 then
		    A="里百八式.大蛇薙"
		   WAR.KUIHUADZ = 2
		   WAR.KUIJUE[pid] = nil
		   WAR.JZTX = 181
		   end
		end	
        if (wugong == 105 or kfkind == 5 ) and KUIHUA(pid) == 2 then--
		   A="星葵起势.息吹"
		   WAR.KHSL = 7
		   WAR.JZTX = 100
		   if WAR.KUIJUE[pid]~= nil and WAR.KUIJUE[pid] == 2 then
		    A="里百八活.零技础"
		   WAR.KUIHUADZ = 3
		   WAR.KUIJUE[pid] = nil
		   WAR.JZTX = 182
		   end
		end	
        --改到特效文字4显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."·".. A
		else
			WAR.Person[WAR.CurID]["特效文字4"] = A;
		end		
	end

	
	--天外，有33%几率多连击一次
	if Given_WG(pid, wugong) and JLSD(33, 66, pid) and WAR.TWLJ == 0 and WAR.ATNum < 2 then
		WAR.ATNum = WAR.ATNum + 1
		if match_ID(pid,400) then----
		WAR.ATNum = WAR.ATNum + 1
		end
		WAR.TWLJ = 1
	end


	
	--无酒不欢：暴击率用函数计算
	local BJ;
	
	BJ = Person_BJ(pid)
	
	--敌人暴击+20%
    if WAR.Person[id]["我方"] == false then
    	BJ = BJ + 20
    end
 
 		if WAR.BSYJ[pid]~=nil then
		   BJ = BJ + 20
		end
 
 	if MPPB_SL(pid) == 1 and JY.Person[pid]["品德"] > 80 then
	   BJ = BJ + 20 
	   if MPZJ(pid,3)>=1 then
	   BJ = BJ + 10*MPDJ(pid)
	   end
	end
 
 	if MPPD(pid) == 4 and MPPB_MZ(pid)== 3 then
		BJ = BJ + 30
	end

 	if PersonKF(pid,175) then
		BJ = BJ + 10
	    if Curr_NG(pid,175) then
		BJ = BJ + 10
	    end
	end
 
    if nglw(pid,96)>1 and JY.Person[pid]["资质"]<=50 then
	   BJ = BJ + math.modf((50-JY.Person[pid]["资质"])/2)
	end
 
    if WAR.ZJZC >=1 then
	BJ = BJ + 20
	end
	
	if WAR.LSDZ[pid]~=nil and WAR.LSDZ[pid] == 1 then
	BJ = BJ + 20
	end
 
	if WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 4 then
	BJ = BJ + 20
	end 
 
     if BJ < 0 then
		BJ = 0
    end
 
	--暴击率上限100
    if BJ > 100 then
		BJ = 100
    end
 
	if math.random(100) <= BJ then
		WAR.BJ = 1
    end
	
    --高暴击武功
    local gbj = {11, 13, 28, 33, 58, 59, 72, 75, 114}
    for i = 1, 9 do
		if JY.Person[pid]["武功" .. wugongnum] == gbj[i] and JLSD(20, 75, pid) then
			WAR.BJ = 1
			break;
		end
    end
    
    --装备玄铁剑，配合玄铁剑法
	--1级50%暴击率，6级100%
	--6级解锁破尽天下，必暴击，无视绝对气防
    if JY.Person[pid]["武器"] == 36 and wugong == 45 then
		if JLSD(0, 40 + JY.Thing[36]["装备等级"] * 10, pid) then
			WAR.BJ = 1
		end
		if JY.Thing[36]["装备等级"] == 6 then
			WAR.PJTX = 1
			if wglw(pid,45)>1 then
			WAR.PJTX = 2
			end
			Set_Eff_Text(id,"特效文字0","重剑无锋·破尽天下");
		end
    end
	
	--弹指神通，配合桃花绝技，必暴击
	if wugong == 18 and TaohuaJJ(pid) then
		WAR.BJ = 1
	end
	
	--天魔功，必暴击
	if Curr_NG(pid, 160) then
		WAR.BJ = 1
		if  nglw(pid,160)>=1 then
		   if JLSD(10,50,pid)  then
		      WAR.BJ2 = 1
			  Set_Eff_Text(id,"特效文字1","天魔乱神")
		   end
		end
	end
    
	if pid == WAR.AXL then --阿修罗指令必暴击
		WAR.BJ = 1
	end
	
    --装备屠龙刀，使用等级为极的刀法，有几率触发两种特效
	if JY.Person[pid]["武器"] == 43 then
	  	if kfkind == 4 and level == 11 then
    		--必流血，并追加等同于武功威力的杀气，50%几率优先判定
    		if JLSD(25, 75, pid) or (wglw(pid,67)>2 and JLSD(25, 75, pid)) then
    			WAR.L_TLD = 1;
				Set_Eff_Text(id,"特效文字1","武林至尊.宝刀屠龙");
			--如果没有触发，则还有40%几率触发必定暴击
    		elseif JLSD(35, 75, pid) then	
    			WAR.BJ = 1
				Set_Eff_Text(id,"特效文字1","号令天下.莫敢不从");
    		end
    	end
	end
	
	  
	local ng = 0
	
	--如果暴击
    if WAR.BJ == 1 then
		WAR.Person[id]["特效动画"] = 89   --暴击特效动画
		if match_ID(pid, 50) then    --乔峰特效文字
			local r = nil
			r = math.random(3)
			if r == 1 then
				Set_Eff_Text(id,"特效文字1","教单于折箭 六军辟易 奋英雄怒");
			elseif r == 2 then
				Set_Eff_Text(id,"特效文字1","虽万千人吾往矣");
			elseif r == 3 then
				Set_Eff_Text(id,"特效文字1","胡汉恩仇 须倾英雄泪");
			end
		end
		
	if MPPD(pid)==4 and MPDJ(pid)>1 then
      WAR.L_TLD1 = 1
	  Set_Eff_Text(id,"特效文字1","密教苦修.释迦掷象");
	 end
		
		--改成特效文字4显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			WAR.Person[WAR.CurID]["特效文字4"] = WAR.Person[WAR.CurID]["特效文字4"] .."·".. "暴击"
		else
			WAR.Person[WAR.CurID]["特效文字4"] = "暴击";
		end
		--主运血河神鉴，暴击后回血
		--主运50，被动30
		if Curr_NG(pid, 163) then
			WAR.XHSJ = WAR.XHSJ + 50
		elseif PersonKF(pid, 163) then
			WAR.XHSJ = WAR.XHSJ + 30
		end
    end
  

  	if wugong == 38 and wglw(pid,38)>1 then
		WAR.YXMQ = math.random(3)
		local str = ""
		if  WAR.YXMQ == 1 then
			str = "魔曲·八音穿心"
		elseif WAR.YXMQ == 2 then
		    str = "次曲·次声震脉"
		elseif WAR.YXMQ == 3 then
		    str = "终曲·阎魔蟋蟀"
		end 
		if QXHM(pid) and wglw(pid,38)>2 and math.random(4) == 1 then
		   str = "秘曲·魔境狂乱"
		   WAR.YXMQ =  4
		end
		if TaohuaJJ(pid) and wglw(pid,38)>2 and math.random(4) == 1 then
		   str = "禁曲·狂伽蟋蟀"
		   WAR.YXMQ =  5
		end

        if WAR.YXMQ >=1 then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					local tmppid = WAR.Person[j]["人物编号"]
					local aa = math.random(2,8)
					local bb=  math.modf(JY.Person[tmppid]["内力"]/500)
					WAR.Person[j]["体力点数"] = (WAR.Person[j]["体力点数"] or 0) + AddPersonAttrib(tmppid, "体力", -aa)
					if WAR.YXMQ == 1 then	
						WAR.BYCX[tmppid]=(WAR.BYCX[tmppid] or 0) + 30
					end
					if WAR.YXMQ == 2 then	
						WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) +AddPersonAttrib(tmppid, "受伤程度", bb)
						WAR.LXXS[tmppid]=1
						WAR.LXZT[tmppid]=(WAR.LXZT[tmppid] or 0) + bb
								if WAR.LXZT[tmppid]>=100 then
		                           WAR.LXZT[tmppid]=100
		                        end
						WAR.LSQ[tmppid]=(WAR.LSQ[tmppid] or 0) + bb
					end
					if WAR.YXMQ ==3 then
					WAR.YHDF[tmppid]=1
					end
					if WAR.YXMQ ==4 then
					WAR.JSCL[tmppid]=(WAR.JSCL[tmppid] or 0) + 20
					end
					if WAR.YXMQ ==5 then
					WAR.JSCL2[tmppid]=(WAR.JSCL2[tmppid] or 0) + 20
					end
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end		
		end	    
        Set_Eff_Text(id,"特效文字0",str);
	end	
  
  	if  wugong == 12 and wglw(pid,12)>1 then
		WAR.LYBF = math.random(3)
		local str = ""
		if  WAR.LYBF == 1 then
			str = "景严·落英散华"
		elseif WAR.LYBF == 2 then
		    str = "亢景·落英汇聚"
		elseif WAR.LYBF == 3 then
		    str = "终景·黄帝剑掌"
		end 

        if WAR.LYBF == 2 then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
						local tmppid = WAR.Person[j]["人物编号"]
						WAR.LXXS[tmppid]=1
						WAR.LXZT[tmppid]=(WAR.LXZT[tmppid] or 0) + math.random(1, 10)
						if WAR.LXZT[tmppid]>=100 then
		                   WAR.LXZT[tmppid]=100
		                end
						local bb=WAR.LXZT[tmppid]
						WAR.Person[j]["内伤点数"] = AddPersonAttrib(tmppid, "受伤程度", bb)
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end		
		end	    
       Set_Eff_Text(id,"特效文字0",str)
	end	
 
    if MPPB_THBH(pid)>=1 then
        local str = ""
	   
	   if wugong == 12 then
	   WAR.THSB = 1
	   elseif wugong == 18 then
	   WAR.THSB = 2
	   elseif wugong == 38 then
	   WAR.THSB = 3
       elseif MPPB_THBH(pid)>=2 and wugong == 129 then
       WAR.THSB = 4
       elseif MPPB_THBH(pid)>=2 and wugong == 126 then
       WAR.THSB = 5
	   end
		if  WAR.THSB == 1 then
			str = "桃花绝学·桃花影落飞神剑"
		elseif WAR.THSB == 2 then
		    str = "桃花绝学·弹指易老情空若"
		elseif WAR.THSB == 3 then
		    str = "桃花绝学·碧海潮生弄玉箫"
		elseif WAR.THSB == 4 then
		    str = "桃花绝学·风起桃源落木下"
		elseif WAR.THSB == 5 then
		    str = "桃花绝学·兰香拂面暗疏影"
		end 
        if MPPB_THBH(pid)>=2 and WAR.THSB>0 then
           str = "【真】"..str
        end	
        Set_Eff_Text(id,"特效文字0",str)		
	end
 
 
  	if  wugong == 76 and wglw(pid,76)>=1 then
		WAR.HSDF = 1
		 for j = 0, WAR.PersonNum - 1 do
			  local df = WAR.Person[j]["人物编号"]		  
			    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.DRZT[df] ~=nil and RealJL(id, j, 1+nglw(pid,76)*2) then
				WAR.HSDF = WAR.HSDF + 0.25*WAR.DRZT[df]*wglw(pid,76)
			    end	
		 end
        if wglw(pid,76)>1 then
           WAR.HSDF_STNJ = math.random(1,3)
		   local str = ""
		   if  WAR.HSDF_STNJ == 1 then
			str = "水天逆戟·断瀑"
		   elseif WAR.HSDF_STNJ == 2 then
		    str = "水天逆戟.灼海流"
		   elseif WAR.HSDF_STNJ == 3 then
		    str = "水天逆戟.苍雾"
		   end    
           Set_Eff_Text(id,"特效文字0",str)
        end		
	end	
 
  	if  wugong == 126 and wglw(pid,126)>2 then
		WAR.XLMH = math.random(3)
		local str = ""
		if  WAR.XLMH == 1 then
			str = "魔宫幽兰·湛蓝冰华"
		elseif WAR.XLMH == 2 then
		    str = "魔宫幽兰·血色白兰"
		elseif WAR.XLMH == 3 then
		    str = "魔宫幽兰·彼岸紫薇"
		end    
       Set_Eff_Text(id,"特效文字0",str)
	end		
 
	--罗汉堂雷霆一击
		if MPPB_SL(pid) == 1 and WAR.BJ == 1 then--
		   if kfkind == 4 then
		   	  for j = 0, WAR.PersonNum - 1 do
			  local df = WAR.Person[j]["人物编号"]
              local fhurt2 = math.modf(JY.Person[WAR.Person[j]["人物编号"]]["生命"]*0.1)			  
			    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - fhurt2
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - fhurt2
				    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			    end	
		      end
          Set_Eff_Text(id,"特效文字0","佛戒断罪")			  
		  end
		   if kfkind == 5 then    			  
			  for j = 0, WAR.PersonNum - 1 do
			  local df = WAR.Person[j]["人物编号"]
			  local fhurt2 = math.modf(JY.Person[WAR.Person[j]["人物编号"]]["内力"]*0.05)
				  if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - fhurt2
                    JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] = JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] + math.random(5, 9)
				  end
			  end
			Set_Eff_Text(id,"特效文字0","怒目罗汉")	
		   end
	    end
 
    if wugong == 63 and wglw(pid,63)>1 then
		if WAR.ATNum <= 2 then
		WAR.ATNum=WAR.ATNum+math.random(1,2)
        end	
		local str = ""
        WAR.XDDF2 = math.random(0,2)
		if wglw(pid,63)>2 then
		WAR.XDDF2=WAR.XDDF2+1
		end
		if  WAR.XDDF2 == 1 then
			str = "血煞刀法·气血逆转"
		elseif WAR.XDDF2 == 2 then
		    str = "血煞刀法·血溅十步"
		elseif WAR.XDDF2 == 3 then
		    str = "血煞刀法·血色弥漫"
		end
		
        if WAR.XDDF2 == 3 then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then				
						local tmppid = WAR.Person[j]["人物编号"]
						local aa= WAR.LXZT[tmppid] or 0
						WAR.MENG[tmppid]=(WAR.MENG[tmppid] or 0) +math.modf(JY.Person[pid]["实战"] / 10)
						addeffect2(WAR.XQZZ,tmppid,1)
						WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end		
		end	  
        if WAR.Person[id]["特效文字2"] ~= nil then
	         WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .."·"..str
		else
		     WAR.Person[id]["特效文字2"] = str
		end
	
	end	 
    --无酒不欢：计算内功加力
	if JY.Person[pid]["主运内功"] > 0 and WAR.YZSP[pid] == nil then
		local cur_NG = JY.Person[pid]["主运内功"]
		--吸功，金刚不坏，风林六如不加力
		if cur_NG ~= 85 and cur_NG ~= 87 and cur_NG ~= 88  and cur_NG ~= 143 and cur_NG ~= 91 then
			local cur_NGL = 0;
			for i = 1, CC.Kungfunum do
				if JY.Person[pid]["武功"..i] ==  cur_NG then
					cur_NGL = JY.Person[pid]["武功等级" .. i];
					if cur_NGL == 999 then
						cur_NGL = 11
					else
						cur_NGL = math.modf(cur_NGL / 100) + 1
					end
					break;
				end
			end
			--主运内功有35%的高优先级判定,二层天内后增加独立几率
			if cur_NGL ~= 0 and (JLSD(30, 65-(5*WAR.ACT), pid) or ((nglw(pid,cur_NG)> 1 or wglw(pid,18)> 1) and math.random(0,10)<8-WAR.ACT) )  then
				ng = get_skill_power(pid, cur_NG, cur_NGL);
				if Curr_NG(pid,172)  then
				   ng = ng + math.modf(JY.Person[pid]["内力"] *0.1)
				end
				WAR.Person[id]["特效文字2"] = JY.Wugong[JY.Person[pid]["主运内功"]]["名称"] .. "加力"
				WAR.Person[id]["特效动画"] = 93
				WAR.NGJL = JY.Person[pid]["主运内功"];
			end
		end
	end
	
	--如果没有触发主运内功加力，再判定一般加力
	if WAR.NGJL == 0 then
		local N_JL = {};		
		local num = 0;	--当前学了多少个内功
		for i = 1, CC.Kungfunum do
			local kfid = JY.Person[pid]["武功" .. i]
			local kflvl = JY.Person[pid]["武功等级" .. i]
			if kflvl == 999 then
				kflvl = 11
			else
				kflvl = math.modf(kflvl / 100) + 1
			end
			--先把内功都存入表格，吸功，金刚不坏，风林六如不加力
			if JY.Wugong[kfid]["武功类型"] == 6 and kfid ~= 85 and kfid ~= 87 and kfid ~= 88 and kfid ~= 143 and kfid ~= 91 and kfid~= 181 then
				num = num + 1;
				N_JL[num] = {kfid,i,get_skill_power(pid, kfid, kflvl)};
			end
		end
				
		--如果学有内功
		if num > 0 then	
			--按照威力从大到小排序，威力一样的话按照面板的先后顺序
			for i = 1, num - 1 do
				for j = i + 1, num do
					if N_JL[i][3] < N_JL[j][3] or (N_JL[i][3] == N_JL[j][3] and N_JL[i][2] > N_JL[j][2])then
						N_JL[i], N_JL[j] = N_JL[j], N_JL[i]
					end
				end
			end
			--按顺序判定触发
			for i = 1, num do
				--王重阳北斗七闪状态必定加力
				if (match_ID(pid, 129) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0) or myrandom(10, pid) then
					ng = N_JL[i][3];
					WAR.Person[id]["特效文字2"] = JY.Wugong[N_JL[i][1]]["名称"] .. "加力"
					WAR.Person[id]["特效动画"] = 87 + math.random(6)
					WAR.NGJL = N_JL[i][1];
					break;
				end
				if (match_ID_awakened(pid,65,1) and WAR.WCY[pid] ~= nil and WAR.LMZL > 0) or myrandom(10, pid) then
					ng = N_JL[i][3];
					WAR.Person[id]["特效文字2"] = JY.Wugong[N_JL[i][1]]["名称"] .. "加力"
					WAR.Person[id]["特效动画"] = 87 + math.random(6)
					WAR.NGJL = N_JL[i][1];
					break;
				end
			end
		end
	end
	
	--张无忌补偿加力
    if match_ID(pid, 9) and WAR.Person[id]["特效文字2"] == nil and PersonKF(pid, 106) then
		local z = math.random(2)
		if z == 1 then
			WAR.Person[id]["特效动画"] = math.fmod(97, 10) + 85
			WAR.Person[id]["特效文字2"] = "乾坤大挪移加力"   --乾坤大挪移加力
			ng = ng + 850
			WAR.NGJL = 97
		else
			WAR.Person[id]["特效动画"] = math.fmod(106, 10) + 85
			WAR.Person[id]["特效文字2"] = "九阳神功加力"  --九阳神功加力
			ng = ng + 1200
			WAR.NGJL = 106
		end
    end	
	
		if WAR.NGJL == 0 and PersonKF(pid, 180) then
			ng = ng + 900;
			WAR.Person[id]["特效文字2"] = "灵蛇玄功补偿加力"
			WAR.Person[id]["特效动画"] = 87 + math.random(6)
			WAR.NGJL = 180
		end
	
			if WAR.NGJL>0 and nglw(pid, 90)>2 then  --混元三层
           		WAR.Person[id]["特效文字4"] = "混元霹雳.天地正气"
				WAR.Person[id]["特效动画"] = 78
                WAR.HYTZ=JY.Person[pid]["体力"]				
            end 

		if WAR.YMH[pid] ~= nil and WAR.YMH[pid] > 0 then
			if WAR.NGJL>0  then 
			WAR.NGJL = 0 
			end
		end	

				if JY.Person[pid]["受伤程度"] >0 then
				   ng = ng - JY.Person[pid]["受伤程度"] * 10
				end
	
	if WAR.NGJL>0 or (match_ID(pid, 57) and JLSD(10,70,pid) ) then
	   if wglw(pid, 18)>1 and wugong == 18 then
	   local aa=WAR.NGJL-88
	   if WAR.NGJL==152 then
	   aa=21
	   elseif WAR.NGJL==154 then
	   aa=22
	   elseif WAR.NGJL==160 then
	   aa=23	   
	   elseif WAR.NGJL==163 then
	   aa=24
	   elseif WAR.NGJL==166 then
	   aa=25
	   elseif WAR.NGJL==169  then
	   aa=26
	   elseif WAR.NGJL==171  then
	   aa=27
	   elseif WAR.NGJL==172  then
	   aa=28
	   elseif WAR.NGJL==175  then
	   aa=29
	   elseif WAR.NGJL==179  then
	   aa=35
	   elseif WAR.NGJL==178  then
	   aa=34
	   elseif WAR.NGJL==144  then
	   aa=25
	   elseif WAR.NGJL>=180 then
	   aa=7
	   elseif match_ID(pid, 57) then
	   aa=math.random(28,33)
	   else
	   end
	   WAR.TZQJ=aa
	   local QJLX = {"紫霄剑", "归元气", "狂龙怒吼", "咆哮弹", "圣光焰", "无影拳", "剧毒散", "伏魔印", "琉璃体","无相法", "元阳身", "剑罡道", "生死符", "皇极命", "真言咒", "奔流气", "化生刺", "烈阳息", "摄魂神", "宝相轮", "杀剑意", "元阴体","魔神噬","冥河血","不坏体","密脉轮","混沌鱼","怒涛斩","血光劈空","惊涛魔音","掠影飞石","狂风怒卷","幽兰拂面","杀意波动","寒冰气"}
	   	if WAR.Person[id]["特效文字4"] ~= nil then
			WAR.Person[id]["特效文字4"] = WAR.Person[id]["特效文字4"] .."+".. "弹指气劲."..QJLX[WAR.TZQJ]
		else
			WAR.Person[id]["特效文字4"] = "弹指气劲."..QJLX[WAR.TZQJ]
		end
		WAR.Person[id]["特效动画"] = 13+aa
		if WAR.TZQJ == 17 then----
		        for k = 0, WAR.PersonNum - 1 do
				if WAR.Person[k]["死亡"] == false and WAR.Person[k]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then				
						local tmppid = WAR.Person[k]["人物编号"]
						WAR.KHCM[tmppid]=2 
						WAR.TXXS[tmppid] = 1
				end		
	    end	
		end
		if WAR.TZQJ == 32 then----
		        for k = 0, WAR.PersonNum - 1 do
				if WAR.Person[k]["死亡"] == false and WAR.Person[k]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then				
						local tmppid = WAR.Person[k]["人物编号"]
						WAR.Person[k].TimeAdd = WAR.Person[k].TimeAdd - 500
						WAR.TXXS[tmppid] = 1
				end		
	    end	
		end
		elseif pid== 0 and zylw(6)>=1 and yongnei(wugong) then
		local aa=JY.Person[0]["天赋内功"]-88
	   if JY.Person[0]["天赋内功"]==152 then
	   aa=21
	   elseif JY.Person[0]["天赋内功"]==154 then
	   aa=22
	   elseif JY.Person[0]["天赋内功"]==160 then
	   aa=23	   
	   elseif JY.Person[0]["天赋内功"]==163 then
	   aa=24
	   elseif JY.Person[0]["天赋内功"]==166 then
	   aa=25
	   elseif JY.Person[0]["天赋内功"]==169  then
	   aa=26
	   elseif JY.Person[0]["天赋内功"]==171  then
	   aa=27
	   elseif JY.Person[0]["天赋内功"]==172  then
	   aa=28
	   elseif JY.Person[0]["天赋内功"]==175  then
	   aa=29
	   elseif JY.Person[0]["天赋内功"]==179  then
	   aa=35
	   elseif JY.Person[0]["天赋内功"]==178  then
	   aa=34
	   elseif JY.Person[0]["天赋内功"]==144  then
	   aa=25
	   elseif JY.Person[0]["天赋内功"]==180 then
	   aa=7
	   elseif JY.Person[0]["天赋内功"]==85 then
	   aa=30
	   elseif JY.Person[0]["天赋内功"]==87 then
	   aa=31
	   elseif JY.Person[0]["天赋内功"]==88 then
	   aa=32
	   elseif JY.Person[0]["天赋内功"]>=181 then
	   aa=33
	   else
	   end
	   WAR.TZQJ=aa
	   local QJLX = {"紫霄神剑意", "三分归元气", "狂龙的咆哮", "闪电光速波", "圣光气焰弹", "神降气劲", "虿虫剧毒散", "伏魔大手印", "明尊琉璃体","无相转身术", "元阳纯体", "气罡剑道", "六合生死", "皇极惊世录", "真言脉轮咒", "奔流内息", "日月光华", "烈阳护体", "摄魂心神", "法相宝轮", "杀道剑意", "玄阴玉体","魔神噬天","冥河血手","不坏刚体","无上密乘","混沌两仪","魔音灌耳","血光劈空","北冥真气波","虫毒攻心","星辰爆流破","惑心迷踪","杀意波动","极寒突袭","意乱情迷"}
	   	if WAR.Person[id]["特效文字4"] ~= nil then
			WAR.Person[id]["特效文字4"] = WAR.Person[id]["特效文字4"] .."+".. "天罡斗气."..QJLX[WAR.TZQJ]
		else
			WAR.Person[id]["特效文字4"] = "天罡斗气."..QJLX[WAR.TZQJ]
		end
		WAR.Person[id]["特效动画"] = 13+aa
		if WAR.TZQJ == 17 then----
		        for k = 0, WAR.PersonNum - 1 do
				if WAR.Person[k]["死亡"] == false and WAR.Person[k]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then				
						local tmppid = WAR.Person[k]["人物编号"]
						WAR.KHCM[tmppid]=2 
						WAR.TXXS[tmppid] = 1
				end		
	    end	
		end
	   end
	end
	
	
	

	
 		--NPC内功补完系统
	if ((not inteam(pid) and JLSD(10,80,pid)) or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) ) and WAR.NGJL == 0 then
		local jlName, jlPower = G["NPC内功补完系统"](pid)
		if jlName then
			WAR.Person[id]["特效动画"] = 87 + math.random(6)
			WAR.Person[id]["特效文字2"] = jlName.."加力"
			ng = ng + jlPower
			if not inteam(pid) then--
			ng = ng + jlPower
			end
			WAR.NGJL = 0.5
		end
	end

		if WAR.YMH[pid] ~= nil and WAR.YMH[pid] > 0 then
			if WAR.NGJL>0  then 
			WAR.NGJL = 0 
			end
		end	


	if WAR.NGJL>0 then----
	   if WAR.MK_CP[pid]~= nil then----
	   CurIDTXDH(WAR.CurID, 101,1, "秘孔.喘破", C_RED)
	   ng = 0
	   end
	   if WAR.RJZT[pid]~= nil then----
	   CurIDTXDH(WAR.CurID, 100,1, "软筋", C_RED)
	   ng = 0
	   end
	   if WAR.MK_JM[pid]~= nil then----
	   CurIDTXDH(WAR.CurID, 143,1, "秘孔.健明", C_GOLD)
	   ng = math.modf(ng*2)
	   end
	   if Curr_NG(pid,178)  then
	   ng = math.modf(ng*1.5)
	   end
	end	
	
	if  WAR.NGJL>0 then
	 if WAR.ICE2[pid]~=nil then
	    CurIDTXDH(WAR.CurID, 116,1, "寒毒激发", C_ORANGE)
	    WAR.ICE[pid] = limitX((WAR.ICE[pid] or 0) + 10 ,0,50)
		local nlDam = math.modf(JY.Person[pid]["内力"]*0.15)
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -nlDam)
	 end
	if WAR.FMZZ[pid]~=nil then	    
		local nlDam = math.modf(JY.Person[pid]["内力"]*0.01)
		WAR.MENG[pid]=nlDam
		CurIDTXDH(WAR.CurID, 98,1, "业障缠身", C_ORANGE)
		WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", nlDam)
	 end
	 if WAR.HOT2[pid]~=nil then
	    CurIDTXDH(WAR.CurID, 116,1, "火毒攻心", C_ORANGE)
	    WAR.HOT[pid] = limitX((WAR.HOT[pid] or 0) + 10 ,0,50)
		local nlDam = math.modf(JY.Person[pid]["生命"]*0.1)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
	 end
	 if WAR.JHLY3[pid]~=nil and WAR.JHLY3[pid]>0  then
	   	CurIDTXDH(WAR.CurID, 127,1, "内火焚心", C_ORANGE)
		local nlDam = JY.Person[pid]["灼烧程度"]
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
	end
     if WAR.QBLY[pid]~=nil and WAR.QBLY[pid]>0  then----
		CurIDTXDH(WAR.CurID, 114,1, "千本落英", C_ORANGE)
		local nlDam = WAR.LXZT[pid] or 0
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
	end
	 if WAR.L_HBJD[pid]~=nil then
        CurIDTXDH(WAR.CurID, 116,1, "红冰激发：寒毒", C_ORANGE)
	    local nlDam = math.modf(JY.Person[pid]["内力"]*0.1)
		JY.Person[pid]["冰封程度"] = JY.Person[pid]["冰封程度"] + math.modf(nlDam/20)
		if JY.Person[pid]["冰封程度"]> 100 then
		JY.Person[pid]["冰封程度"] = 100
		end		
	 end
     if WAR.QSLZ[pid]~=nil and WAR.QSLZ[pid]>0  then----
		CurIDTXDH(WAR.CurID, 64,1, "七死爆毒", M_DarkGreen)
		local nlDam = math.modf(JY.Person[pid]["中毒程度"]*1.15)
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
	end
     if WAR.HDQM[pid]~=nil and WAR.HDQM[pid]>0 then----
		CurIDTXDH(WAR.CurID, 116,1, "寒毒侵袭", M_DeepSkyBlue)
		local nlDam = math.modf(JY.Person[pid]["内力"]*0.15)
		WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -nlDam)
		JY.Person[pid]["冰封程度"] = JY.Person[pid]["冰封程度"] + math.modf(nlDam/20)
		if JY.Person[pid]["冰封程度"]> 100 then
		local aa = JY.Person[pid]["冰封程度"] - 100
		WAR.LRHF[pid] = (WAR.LRHF[pid] or 0) + aa
		JY.Person[pid]["冰封程度"] = 100
		if WAR.LRHF[pid]>= 50 then
		WAR.LRHF[pid] = 50
		end
		end
	   end
    if KUIHUA(pid)==0 then--
       addeffect2(WAR.YIN, pid, nglw(pid,105))
    end	
	
	if WAR.JYWR[pid]~= nil and WAR.JYWR[pid]>=3 then----
		CurIDTXDH(WAR.CurID, 103,1, "阳气污染.过热", C_RED)
		local bb =  - WAR.JYWR[pid]
	   WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid,"体力", bb)
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid,"生命", bb*50)
	end
end	   
			
	--蟾震九天，斗转不触发
	if PersonKF(pid, 95) and WAR.DZXY == 0 then
		if WAR.tmp[200 + pid] == nil then
			WAR.tmp[200 + pid] = 0
		elseif WAR.tmp[200 + pid] > 100 then
			ng = ng + WAR.tmp[200 + pid] * 10 + 1500
		  
			if nglw(pid,95)>=1 and Curr_NG(pid,95) then				
				ng = ng + 500				
				Set_Eff_Text(id,"特效文字3","蛤蟆功·神蟾震九天")			
				--欧阳锋提高伤害
			    if match_ID(pid, 60) then
				WAR.OYFXL = WAR.tmp[200 + pid]
			    end
				WAR.L_CZJT = 1
			else
				Set_Eff_Text(id,"特效文字3","蛤蟆功·蟾震九天")
				--欧阳锋提高伤害
			    if match_ID(pid, 60) then
				   WAR.OYFXL = WAR.tmp[200 + pid]
			    end
			    WAR.Person[id]["特效动画"] = math.fmod(95, 10) + 85
				WAR.tmp[200 + pid] = 0
			end

			
			--蓄力清0
			
		end
	end

	if nglw(pid,95)>1 and PersonKF(pid,95) then --蛤蟆九天17-2-23
	            if WAR.HMJT[pid] == nil then
	               WAR.HMJT[pid] = 0
			    elseif WAR.HMJT[pid] >= 3000 then
			    ng = ng + WAR.HMJT[pid]
				Set_Eff_Text(id,"特效文字2","气吞山河·崩")
                for j = 0, WAR.PersonNum - 1 do
                   if WAR.Person[j]["死亡"] == false and 
		              WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and not nokillspeed(WAR.Person[j]["人物编号"]) then
                      WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - math.modf(WAR.HMJT[pid]/5)
                   end
                end
				WAR.Person[id]["特效动画"] = 112
				WAR.L_CZJT1 = 1		--发动蟾震九天，无视上毒
				else
				WAR.HMJT[pid] = WAR.HMJT[pid] + math.modf(ng / 100)
				end
	 end
	
	--天赋外功提高100点气攻
	if Given_WG(pid, wugong) then
		ng = ng + 100
	end
 
 
	


 
    --无酒不欢：狮子吼
    if PersonKF(pid, 92) then
    	if WAR.Person[id]["特效动画"] == -1 then
    		WAR.Person[id]["特效动画"] = math.fmod(92, 10) + 85
    	end
    	
    	local nl = JY.Person[pid]["内力"];
    	local f = 0;
		local chance = 51
		local force = 100
		--主运提高效果
		if Curr_NG(pid, 92) then
			chance = 71 + nglw(pid,92) * 10
			force = 200
		end
		--一般人需要内力差大于2000，而谢逊只要内力差大于1即可
		local neilicha = 2000
		if match_ID(pid, 13) or nglw(pid,92)>=1 then
			neilicha = 1
		end
		if  nglw(pid,92)>=2 then
			neilicha = -1000*nglw(pid,92)
		end
		if math.random(100) < chance or wugong == 92 then
		  	if match_ID(pid, 13)  then
			WAR.SPDUP[pid] = 30
			WAR.ATKUP[pid] = 30
			WAR.DEFUP[pid] = 30
		    end  
			for j = 0, WAR.PersonNum - 1 do
			local tmppid = WAR.Person[j]["人物编号"]
			local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and (nl - JY.Person[WAR.Person[j]["人物编号"]]["内力"]) > neilicha then
					f = 1;					
					local aa = (nl - JY.Person[WAR.Person[j]["人物编号"]]["内力"])
					if nglw(pid,92)>=2 then
					f = nglw(pid,92)
					aa = aa - neilicha
					   if aa<= 0 then
					      aa = 0
					   end
					force = force + math.modf(aa/200)
					   if offset<=5 then
					   force = math.modf(force * (1+(5-offset)*0.15))
					   end
					local nlDam = math.modf(force*(1+JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"]/100))
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -nlDam)
					   if JY.Person[WAR.Person[j]["人物编号"]]["生命"]<1 then
					   JY.Person[tmppid]["生命"] = 1
					   WAR.HMZT[tmppid] = 1
					   end
					end
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - force 
					if Curr_NG(pid, 92) then
					    local ns = math.random(5, 9) + math.modf(force*(f-1) * 0.055)
						WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(tmppid, "受伤程度", math.random(5, 9))
						if match_ID(pid, 13) and JLSD(10,40,pid) then
						WAR.HMZT[tmppid] = 1
						end
						if nglw(pid,92)>=1 and JLSD(10,40+math.max((5-offset)*10,0),pid) then
						WAR.MENG[tmppid] = 20
						end
					end
				end
			end
		end
		
		if f >= 1 then
		    local str = "狮子吼"
			if f >= 2 then
			str = "雷霆狮吼"
			end
			if WAR.Person[id]["特效文字2"] == nil then
				WAR.Person[id]["特效文字2"] = str
			else
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+".. str;
			end
		end
    end

    if match_ID(pid, 149) and WAR.NGJL>0 then
    	if WAR.Person[id]["特效动画"] == -1 then
    		WAR.Person[id]["特效动画"] = math.fmod(92, 10) + 85
    	end
    	
    	local nl = JY.Person[pid]["内力"];
    	local f = 0;
		local force = 100
		--主运提高效果
for j = 0, WAR.PersonNum - 1 do
			local tmppid = WAR.Person[j]["人物编号"]
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then				
                    local nlDam = math.modf(force*(1+JY.Person[tmppid]["受伤程度"]/100))
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tmppid, "生命", -nlDam)
					WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(tmppid, "受伤程度", math.modf(nlDam/10))
					   if JY.Person[WAR.Person[j]["人物编号"]]["生命"]<1 then
					   JY.Person[tmppid]["生命"] = 1
					   WAR.HMZT[tmppid] = 1
					   end 
				end
			end
		
			if WAR.Person[id]["特效文字2"] == nil then
				WAR.Person[id]["特效文字2"] = "【佛门狮子吼】"
			else
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+".. "【佛门狮子吼】";
			end
    end

    
    --六如的风火雷
	if (pid==0 or (inteam(pid) and nglw(0,91)>1)) and JY.Person[pid]["六如觉醒"] > 0  then
    	local rate = limitX(math.modf(20 + (101-JY.Person[pid]["资质"])/10 + JY.Person[pid]["实战"]/50 + JY.Person[pid]["攻击力"]/40 + JY.Person[pid]["武学常识"]/10),0,100);
    	local low = 25;
    	
    	--天书数量增加几率
		low = low - JY.Base["天书数量"]
    	
		local rf = 0
		local rh = 0
		local rl = 0
		local times = 1
		--仁者二次判定+循环两次，即一次可以触发两种六如特效
		if JY.Base["标准"] == 7 then
			times = 2
		end
		if nglw(pid,102)>1 then
		    times = times + 1
		end
		if nglw(pid,184)>1 then
		    addeffect(WAR.LHXT, pid, nglw(pid,184)-1)
		end
		for i = 1, times do
			if JLSD(low, rate, pid) or (JY.Base["标准"] == 7 and JLSD(low, rate, pid)) or nglw(pid,102)>1  then
				local lr = math.random(3)
				if lr == 1 then
					rf = 1
				elseif lr == 2 then
					rh = 1
				elseif lr == 3 then
					rl = 1
				end
			end
		end
		
		if WAR.LXZQ ==1 and zylw(1) > 2 then--
		   rl = 1
		end
	
		if wglw(pid,28)>1 and JLSD(low, rate, pid) then--
		   rl = 1
		end
	
		--其疾如风
    	if rf == 1 and JY.Base["天书数量"] >= 9 then
			WAR.Person[id]["特效动画"] = 177
            Set_Eff_Text(id,"特效文字2","其疾如风");
			if JY.Base["标准"] == 2 then
			Set_Eff_Text(id,"特效文字2",".大风指"); 
			end
			WAR.FLHS1 = 1
			for j = 0, WAR.PersonNum - 1 do
			  local jid= WAR.Person[j]["人物编号"]
			  if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			    local  aa =zylw(2) - 1
				if aa>0 then
				aa=0
				end
				WAR.Person[j].Time = WAR.Person[j].Time + 100+300*aa
				if zylw(2) > 1 then
				addeffect2(WAR.SATA, jid, 1)
				end
			  end
			  if WAR.Person[j].Time > 980 then
				WAR.Person[j].Time = 980
			  end
			end
			if JY.Base["标准"] == 2 then
			  for j = 0, WAR.PersonNum - 1 do
			  if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].Time = WAR.Person[j].Time - 150
			  end
			  if WAR.Person[j].Time < -500 then
				WAR.Person[j].Time = -500
			  end
			end
			end
		end
		--侵略如火
		if rh == 1 then
			WAR.Person[id]["特效动画"] = 177
			Set_Eff_Text(id,"特效文字2","侵略如火");
			if JY.Base["标准"] == 4 then
			Set_Eff_Text(id,"特效文字2",".烈火刀意");
			end
			ng = ng + 3000
			if JY.Base["标准"] == 4 then
		    WAR.FLHS3 = 1
			end
		end
		--动如雷震
		local cishu=3
			if JY.Base["标准"] == 1 then
			cishu=6
			end
		if rl == 1 and JY.Person[pid]["六如觉醒"] == 2 and WAR.FLHS6 < cishu then
			WAR.Person[id]["特效动画"] = 177
			Set_Eff_Text(id,"特效文字2","动如雷震");
			if JY.Base["标准"] == 1 then
			Set_Eff_Text(id,"特效文字2",".奔雷铁手");
			end
			WAR.ATNum = WAR.ATNum + 1
			WAR.FLHS6 = WAR.FLHS6 + 1
    	end
    end


	if nglw(pid,103)>2  then
    	local rate = limitX(math.modf(25 + JY.Person[pid]["实战"]/50 + JY.Person[pid]["攻击力"]/20 + JY.Person[pid]["武学常识"]/10 +JY.Person[pid]["资质"]/10),0,100);
    	local low = 25;
    	
    	--天书数量增加几率
		low = low - JY.Base["天书数量"]
    	
		local rf = 0
		local rh = 0
		local rl = 0
		local times = 1+math.modf(JY.Person[pid]["资质"]/50)
		for i = 1, times do
			if JLSD(low, rate, pid) then
				 rl = math.random(3)
				if rl == 1 then
					rf = 1
					WAR.ASKD1 = 1
			        WAR.BJ = 1
				elseif rl == 2 then
					WAR.TGDQ3 = 1
				elseif rl == 3 then
					WAR.TGDQ7 = 1
				end
			end
		end
		

	
		--其疾如风
    	if rl== 1 then
			WAR.Person[id]["特效动画"] = 82
            Set_Eff_Text(id,"特效文字1","文字般若");
			WAR.BRZH1[id] = 1
		end
		--侵略如火
		if rl == 2 then
			WAR.Person[id]["特效动画"] = 83
			Set_Eff_Text(id,"特效文字1","方便般若");
			WAR.BRZH1[id] = 2
		end
		--动如雷震
		if rl == 3  then
			WAR.Person[id]["特效动画"] = 84
			Set_Eff_Text(id,"特效文字1","境界般若");
			WAR.BRZH1[id] = 3
    	end
    end


	--太古斗气
	if force_ID(pid) or (pid == 645 and JY.Person[pid]["品德"]>0 and JY.Base["特殊"]>0) then
		local rate = limitX(math.modf(40 + JY.Person[pid]["实战"]/25 + JY.Person[pid]["武学常识"]/10),0,100);
		local low = 20;
		
		--天书数量增加几率
		low = low - JY.Base["天书数量"]

		local r1 = 0
		local r2 = 0
		local r3 = 0
		local r4 = 0
		local times = 1
		--斗神二次判定+循环两次，即一次可以触发两种太古斗气特效
		if pid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0 then
			times = 2
		end
		for i = 1, times do
			if JLSD(low, rate, pid) or ((pid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0) and (JLSD(low, rate, pid) or WAR.DSTG[pid]~=nil)) or (nglw(pid,102)>1 ) then
				local lr = math.random(2)
				if pid == 645 and JY.Base["斗神"]>0 and JY.Base["特殊"]>0 then--
				lr = math.random(4)
				end
				if lr == 1 then
					r1 = 1
				elseif lr == 2 then
					r2 = 1
				elseif lr == 3 then
					r3 = 1
				elseif lr == 4 then
					r4 = 1
				end
			end
		end
		
		--其徐如林
		if r1 == 1 and JY.Base["天书数量"] >= 0 then
			WAR.Person[id]["特效动画"] = 177
            Set_Eff_Text(id, "特效文字2", "太古.天昊斗气")
            WAR.TGDQ1 = pid
		end
		--不动如山
		if r2 == 1 and JY.Base["天书数量"] >= 1 then
			WAR.Person[id]["特效动画"] = 177
            Set_Eff_Text(id, "特效文字2", "太古.蓐收斗气")
			WAR.TGDQ3 = 1
		end
		if r3 == 1 and JY.Base["天书数量"] >= 6 and WAR.TGDQ5<=4 then
			WAR.Person[id]["特效动画"] = 177
            Set_Eff_Text(id, "特效文字2", "真武.强良斗气")
			WAR.ATNum = WAR.ATNum + 1
			WAR.TGDQ5 = WAR.TGDQ5 + 1
		end
		--难知如阴
		if r4 == 1 and JY.Person[0]["六如觉醒"] == 1 then
			WAR.Person[id]["特效动画"] = 177
            Set_Eff_Text(id, "特效文字2", "真武.祝融斗气")
			WAR.TGDQ7 = 1
		end
	end	
    
    --如果学会北冥神功
    if (PersonKF(pid, 85) and JLSD(45, 75, pid)) or (Curr_NG(pid, 85) and JLSD(20, 70, pid)) then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(85, 10) + 85
		end
		if WAR.Person[id]["特效文字2"] == nil then
			WAR.Person[id]["特效文字2"] = "北冥神功"
		else
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .. "北冥神功"
		end
		WAR.BMXH = 1
		  
		--北冥神功升级
		for w = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. w] < 0 then
				break;
			end
			if JY.Person[pid]["武功" .. w] == 85 then
				JY.Person[pid]["武功等级" .. w] = JY.Person[pid]["武功等级" .. w] + 10
				if JY.Person[pid]["武功等级" .. w] > 999 then
					JY.Person[pid]["武功等级" .. w] = 999
				end
				break;
			end
		end
    end
      
    --吸星大法，与北冥不可同时触发
    if ((PersonKF(pid, 88) and JLSD(45, 75, pid)) or (Curr_NG(pid, 88) and JLSD(20, 70, pid))) and WAR.BMXH == 0 then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(88, 10) + 85
		end
		if WAR.Person[id]["特效文字2"] == nil then
			WAR.Person[id]["特效文字2"] = "吸星大法"
		else
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .. "吸星大法"
		end
		WAR.BMXH = 2
		  
		--吸星大法升级
		for w = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. w] < 0 then
				break;
			end
			if JY.Person[pid]["武功" .. w] == 88 then
				JY.Person[pid]["武功等级" .. w] = JY.Person[pid]["武功等级" .. w] + 10
				if JY.Person[pid]["武功等级" .. w] > 999 then
					JY.Person[pid]["武功等级" .. w] = 999
				end
				break;
			end
		end
    end
    
    --化功大法
    if ((PersonKF(pid, 87) and JLSD(45, 75, pid)) or (Curr_NG(pid, 87) and JLSD(20, 70, pid))) and WAR.BMXH == 0 then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(87, 10) + 85
		end
		if WAR.Person[id]["特效文字2"] == nil then
			WAR.Person[id]["特效文字2"] = "化功大法"
		else
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .. "化功大法"
		end
		WAR.BMXH = 3
		  
		--化功大法升级
		for w = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. w] < 0 then
				break;
			end
			if JY.Person[pid]["武功" .. w] == 87 then
				JY.Person[pid]["武功等级" .. w] = JY.Person[pid]["武功等级" .. w] + 10
				if JY.Person[pid]["武功等级" .. w] > 999 then
					JY.Person[pid]["武功等级" .. w] = 999
				end
				break;
			end
		end
    end

    --天池心法吸功
    if (Curr_NG(pid, 166) and nglw(pid,166)>=1) and WAR.BMXH == 0 and WAR.BHJS[pid]~=nil then
		if WAR.Person[id]["特效动画"] == -1 then
			WAR.Person[id]["特效动画"] = math.fmod(87, 10) + 85
		end
		if WAR.Person[id]["特效文字2"] == nil then
			WAR.Person[id]["特效文字2"] = "天池.吸功大法"
		else
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .. "天池.吸功大法"
		end
		WAR.BMXH = 4
    end
      
    --乔峰
    if match_ID(pid, 50) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 1000
		if not inteam(pid) then
			ng = ng + 1000
		end
		WAR.Person[id]["特效动画"] = 111
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+擒龙功"
		else
			WAR.Person[id]["特效文字2"] = "擒龙功加力"
		end
    end
	
	--brolycjw: 洪七公
    if match_ID(pid, 69) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		addeffect2(WAR.LHXT,pid,1)
		WAR.Person[id]["特效动画"] = 67
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+丐王真气"
		else
			WAR.Person[id]["特效文字2"] = "丐王真气"
		end
    end
	
	--成昆
    if match_ID(pid, 18) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字2"] == nil then
			WAR.Person[id]["特效文字2"] = "混元霹雳功加力"
		else
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+混元霹雳功"
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "魔相·幻阴".."·"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "魔相·幻阴"
		end
    end
	
 	--殷天正
    if match_ID(pid, 12) and WAR.NGJL>0 then
        addeffect2(WAR.SATA, pid, 2)
		WAR.Person[id]["特效动画"] = 67
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+白鹰天翔"
		else
			WAR.Person[id]["特效文字2"] = "白鹰天翔"
		end
    end
	
	--左冷禅
    if match_ID(pid, 22) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		WAR.Person[id]["特效动画"] = 1
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+寒冰真气"
		else
			WAR.Person[id]["特效文字2"] = "寒冰真气"
		end
    end

	--白万剑
    if match_ID_awakened(pid, 43,1) and WAR.NGJL>0 then
		WAR.Person[id]["特效动画"] = 45
			ng = ng + level*200
			WAR.JGHJ = 35
			WAR.WS = 1
			for i = 1, (level) / 2 + 1 do
				for j = 1, (level) / 2 + 1 do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+自在极意功.极意飘雪"
		else
			WAR.Person[id]["特效文字2"] = "自在极意功.极意飘雪"
		end
    end


	





	--brolycjw: 黄药师
    if match_ID(pid, 57) and WAR.NGJL>0 then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		local str = "奇门奥义"
		WAR.Person[id]["特效动画"] = 95
		if  match_ID_awakened(pid, 57,1) then
		local QMDJ = {"开门", "生门", "景门", "伤门","杜门","惊门","休门","死门"}
		local qm = {"朝凤.天翔烈凤波","辰龙.九天游龙掌","昼虎.啸林风虎爪","午犀.踏浪灵犀指","暮狼.北辰天狼牙","夕象.漠原巨象杵","子蛟.渊祭毒蛟棍","夜凰.幻胧魔凰拳"}
		WAR.HYS = math.random(1,8)
		CurIDTXDH(WAR.CurID, 33+WAR.HYS,1, "遁甲.人盘八门".."【"..QMDJ[WAR.HYS].."】")
		str = "八门遁甲术".."【"..qm[WAR.HYS].."】"
		end
		Set_Eff_Text(id,"特效文字2",str)
        
    end

 --陈家洛
if match_ID(pid,75) and (instruct_16(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
local cwl=get_skill_power(pid,wugong,11)
ng=ng+cwl/2
if not instruct_16(pid) then
ng=ng+cwl/2
end
WAR.Person[id]["特效动画"]=math.fmod(106,10)+85
Set_Eff_Text(id,"特效文字2","庖丁解牛")
end



 --陆天枢
if match_ID(pid,94) and (instruct_16(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
local cwl=JY.Person[pid]["品德"]*12
ng=ng+cwl
if not instruct_16(pid) then
ng=ng+cwl
end
WAR.Person[id]["特效动画"]=math.fmod(106,10)+85
Set_Eff_Text(id,"特效文字2","仁义刀")
end

 --刘乘风
if match_ID(pid,95) and (instruct_16(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
local cwl=JY.Person[pid]["品德"]*12
ng=ng+cwl
if not instruct_16(pid) then
ng=ng+cwl
end
WAR.Person[id]["特效动画"]=math.fmod(106,10)+85
Set_Eff_Text(id,"特效文字2","柔云剑")
end

 --水岱
if match_ID(pid,96) and (instruct_16(pid)==false or JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid)) then
local cwl=JY.Person[pid]["品德"]*12
ng=ng+cwl
if not instruct_16(pid) then
ng=ng+cwl
end
WAR.Person[id]["特效动画"]=math.fmod(106,10)+85
Set_Eff_Text(id,"特效文字2","水月剑")
end
	
	--brolycjw: 谢烟客
    if match_ID(pid, 164) and WAR.NGJL>0 then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		WAR.Person[id]["特效动画"] = 23
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+碧针清掌"
		else
			WAR.Person[id]["特效文字2"] = "碧针清掌"
		end
    end
	
	--戚长发
    if match_ID(pid, 594) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 93
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+铁锁横江"
		else
			WAR.Person[id]["特效文字2"] = "铁锁横江"
		end
    end
	
	--慕容博
    if match_ID(pid, 113) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 93
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+参合真气"
		else
			WAR.Person[id]["特效文字2"] = "参合真气"
		end
    end

	--阿紫曼珠沙华，每杀一个人+200气防
	if match_ID(pid, 47) then
		ng = ng + 200*WAR.MZSH
	end	
	
    --任我行 
    if match_ID(pid, 26) and WAR.NGJL>0 then
		ng = ng + 600
		if not inteam(pid) then
			ng = ng + 600
		end
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+魔帝·吸星"
		else
			WAR.Person[id]["特效文字2"] = "魔帝·吸星"
		end
    end
	
	--何铁手
    if match_ID(pid, 83) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 500
		if not inteam(pid) then
			ng = ng + 500
		end
		WAR.Person[id]["特效动画"] =  92
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"].."+红袖拂风"
		else
			WAR.Person[id]["特效文字2"] = "红袖拂风"
		end
    end
	
    --枯荣
    if match_ID(pid, 102) and JLSD(20,70+JY.Base["天书数量"]+math.modf(JY.Person[pid]["实战"]/50),pid) then
		ng = ng + 800
		if not inteam(pid) then
			ng = ng + 800
		end
		WAR.Person[id]["特效动画"] = 23
		if math.random(2) == 1 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = "有常无常·双树枯荣·"..WAR.Person[id]["特效文字3"]
			else
				WAR.Person[id]["特效文字3"] = "有常无常·双树枯荣"
			end
		else
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = "南北西东·非假非空·"..WAR.Person[id]["特效文字3"]
			else
				WAR.Person[id]["特效文字3"] = "南北西东·非假非空"
			end
		end
    end

	--阿紫曼珠沙华，每杀一个人+200气攻
	if match_ID(pid, 47) then
		ng = ng + 200*WAR.MZSH
	end	
    
    --天罡内功为极，发动天罡真气·
    if pid == 0 and JY.Base["标准"] == 6 and kfkind == 6 then
		if level == 11 and JLSD(25, 75, pid) then
			WAR.Person[id]["特效文字3"] = "天罡真气·" .. JY.Wugong[wugong]["名称"]
			ng = ng + JY.Wugong[wugong]["攻击力10"]
		end
		if level == 11 then
     	 	WAR.WS = 1
    	end
    end
	
	--斗转幻梦星辰特效动画
	if WAR.DZXYLV[id] == 130 then
		WAR.Person[id]["特效动画"] = 107
    end
	
    --使用降龙十八掌
    if wugong == 26 then  
       local aa = 0	
	   local dd = 0
	   if match_ID(pid, 50)  then --乔峰必出极意
	   dd = 1
	   end
	   local aa = 70
	   local cc = 0
	   if PersonKF(pid,184) then
	   cc = 1+ wglw(pid,184)
	   end
	   
	   if PersonKF(pid,184) then
	   aa = aa + 10 + wglw(pid,184)*5
	   end
	   if  ((match_ID(pid, 69) or match_ID(pid, 55) or (pid == 0 and JY.Base["标准"] == 1)) and JLSD(30, aa, pid)) then --洪七公，郭靖，拳主角40%
	   dd = 1
	   end
			if match_ID_awakened(pid,459,1) and JLSD(30, aa, pid) then
			dd = 1
			end
	   if wglw(pid,26)>2 and JLSD(30, aa, pid) then
	   dd = 1
	   end
		if dd == 1 then
		    local zssj = math.random(8)
			if match_ID(pid,459) then
            zssj = math.random(4)
			WAR.BZS = 1
			end
			WAR.Person[id]["特效文字3"] = XL18JY[zssj]
			if wglw(pid,26)>=1 then
			WAR.XLZS = zssj
			addeffect2(WAR.LHXT, pid, 2)
			if WAR.LHXT[pid]>=5*wglw(pid,26)  then
			WAR.LHXT[pid] = 5*wglw(pid,26)
			end
			   if zssj <= 6 then
			   WAR.XLZS_QH = 1
			   end
			end			
			ng = ng + 2300
			WAR.WS = 1
			aa = 1
			if wglw(pid,26)>1 then
			aa = 2
			end
			  if Curr_NG(pid,184) then--擒龙功
	            ng = ng + 1000
				WAR.Person[id]["特效文字2"] = "【龙战于野.其血玄黄】"
	          end
			for i = 1, (level) / 2 + wglw(pid,26) + (WAR.LHXT[pid] or 0) +cc do
				for j = 1, (level) / 2 + wglw(pid,26) + (WAR.LHXT[pid] or 0) +cc do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		elseif myrandom(15 + (level), pid) or (wglw(pid,26)>=1 and JLSD(30-wglw(pid,26)*5, 70+wglw(pid,26)*5, pid) ) then	
		    local zssj = math.random(6)
			if match_ID(pid,459) then
            zssj = math.random(4)
			WAR.BZS = 1
			end
			WAR.Person[id]["特效文字3"] = XL18[zssj]
			if wglw(pid,26)>=1 then
			addeffect2(WAR.LHXT, pid, 1)
			if WAR.LHXT[pid]>=5*wglw(pid,26)  then
			WAR.LHXT[pid] = 5*wglw(pid,26)
			end
			WAR.XLZS = zssj
			end	
			ng = ng + 1500
			  if Curr_NG(pid,184) then
	            ng = ng + 1000
				WAR.Person[id]["特效文字2"] = "【龙战于野.其血玄黄】"
	          end
			aa = 1
			for i = 1, (1 + (level)) / 2 + ((WAR.LHXT[pid] or 0)+1)/2 +cc do
				for j = 1, (1 + (level)) / 2 + ((WAR.LHXT[pid] or 0)+1)/2 +cc do
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1, WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1, WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1, WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1, WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
				end
			end
		end
		
		if WAR.XLZS == 2 then
	       WAR.SPDUP[pid] = 20
	       if WAR.XLZS_QH == 1 then
	          addeffect2(WAR.SATA, pid, 2)
	       end
	    end
		
		if WAR.XLZS == 3 then
		   WAR.XLZS_QL = 1 + WAR.XLZS_QH
		   WAR.GTPID4 = pid
		end

		if WAR.XLZS == 5 then
		   	  WAR.ATKUP[pid] = 20
			  WAR.DEFUP[pid] = 20
	       if WAR.XLZS_QH == 1 then
			  WAR.LUCK[pid] = 20
	       end
			addeffect2(WAR.LHXT, pid, 1)
			if WAR.LHXT[pid]>=5*wglw(pid,26)  then
			WAR.LHXT[pid] = 5*wglw(pid,26)
			end		   
		end
	
		if WAR.XLZS == 6 then
		   addeffect2(WAR.ZBX, pid, 5)
	       if WAR.XLZS_QH == 1 then
	          WAR.ZYHB = 1
	       end		   
		end

		if WAR.XLZS == 7 then
           WAR.CXLC3 = 1   	   
		end
		

		
		if aa>=1 and wglw(pid,26)>1 then
		    WAR.XLAY = math.random(1,4)
			if match_ID(pid,459) then
			WAR.LZPX = 1
			Set_Eff_Text(id, "特效文字1", "火龙咆哮")
			end
			
		    local xlzs = {"庐山.亢龙霸","庐山.龙飞翔","庐山.升龙霸","庐山.百龙霸"}
		    Set_Eff_Text(id, "特效文字4", xlzs[WAR.XLAY])
		    if aa>=2 and wglw(pid,26)>2 and WAR.LHXT[pid]~=nil and WAR.XLAY_DZ == 0 then
               WAR.Person[id]["降龙追击"] = 1
		    end		  
		  end
		
		if WAR.XLAY == 3 then
		   WAR.GTJIQI = WAR.GTJIQI + 300
		   WAR.GTPID = pid
		end

		local num = 0
		    for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                num = num + 1
				end		
		end 

		if WAR.XLAY == 4 then

		WAR.XLAY_BL = num
		end
		if WAR.XLAY_DZ == 3  then
	       	for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
				local aa = WAR.XLAY_LH * 10
				if WAR.XLAY_LH>= 10 then
				aa = WAR.XLAY_LH * (10 + num)
				end
                JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - aa*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end		
		    end 	
		end
     end

    if wugong == 83 then  	
		--天竺子
		if match_ID(pid, 455) and JLSD(30, 70, pid) then
			WAR.Person[id]["特效文字4"] = "密宗真言.龙影神杵"
			WAR.Person[id]["特效动画"]=183
			ng = ng + 2300
			WAR.WS = 1
			WAR.JZTX = 179
			for i = 1, 5 do
				for j = 1, 5 do
					SetWarMap(x + i - 1, y + j - 1, 4, 1)
					SetWarMap(x - i + 1, y + j - 1, 4, 1)
					SetWarMap(x + i - 1, y - j + 1, 4, 1)
					SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1, WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1, WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1, WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1, WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
				end
			end
		end
    end

	
	--玄冥极意，毒王有40%几率触发，暴怒必出
	if wugong == 21 and level == 11 and ((pid == 0 and JY.Base["标准"] == 9) or match_ID(pid,643) or match_ID(pid,644)) and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		Set_Eff_Text(id, "特效文字1", "玄冥极意")
		ng = ng + 1500
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
	end

	if wugong == 21 and level == 11 and (match_ID_awakened(pid,2,1) and JY.Person[2]["论剑奖励"] == 2) and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		Set_Eff_Text(id, "特效文字1", "神木玄冥.凄煌蚀心")
		local aa = math.modf(JY.Person[pid]["用毒能力"]/150)
		ng = ng + 1500
		WAR.WS = 1
		for i = 1, 5+aa do
			for j = 1, 5+aa do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
		WAR.XMJY = 1
	end

	if wugong == 22 and Curr_NG(pid, 144) and nglw(pid,144)>2  then
	    if JLSD(20,50,pid) then
	    WAR.JGHJ = 22
		Set_Eff_Text(id, "特效文字0", "仁王.金刚般若掌")
       end	
  end

	if yongjian(wugong) and Curr_NG(pid, 100) and nglw(pid,100)>1  then
	    if WAR.NGJL>0 then
	    WAR.JGHJ = 100
		Set_Eff_Text(id, "特效文字0", "剑罡.先天剑意")
       end	
  end

  if nglw(pid,178)>= 2 and wugong == 15 and WAR.NGJL>0 then --灵光波动拳
	  WAR.JGHJ = 15
   end
   
   if nglw(pid,178)>= 2 and wugong == 115 and WAR.NGJL>0 then --灵光波动拳
	  WAR.JGHJ = 115
   end  
  

  
   if MPPB_WD(pid)>=2 and WAR.NGJL>0 and kfkind ==1 and WAR.ACT>1 and JLSD(10,60,pid) then --沼跃鱼：武当太奥拳法
    WAR.RWZ = 41
    Set_Eff_Text(id,"特效文字2","绵意.冲虚连拳")
	WAR.Person[id]["特效动画"] = 41
	end
 
   if match_ID_awakened(pid,72,1) and JY.Person[72]["论剑奖励"] == 1 and kfkind ==3 and WAR.ACT>1 and JLSD(10,60,pid) then --沼跃鱼：武当太奥拳法
    WAR.RWZ = 43
    Set_Eff_Text(id,"特效文字2","血龙剑.化血")
	WAR.Person[id]["特效动画"] = 43
	end
 
    if match_ID_awakened(pid,72,1) and JY.Person[72]["论剑奖励"] == 2 and kfkind ==4 and WAR.BJ == 1 and JLSD(10,60,pid) then --沼跃鱼：武当太奥拳法
    WAR.RWZ = 44
    Set_Eff_Text(id,"特效文字2","皇龙刀.爆气")
	WAR.Person[id]["特效动画"] = 43
	end
 
      if (MPPB_WD(pid)>=2) and WAR.NGJL>0 and kfkind ==1  and WAR.ACT==1 and (JLSD(10,60,pid) or MPZJ(pid,2)>0) then --沼跃鱼：武当太奥拳法
    WAR.RWZ = 42
    Set_Eff_Text(id,"特效文字2","太极.搬拦捶")
	WAR.Person[id]["特效动画"] = 42
	     if WAR.BG[pid]~=nil and WAR.BG[pid]>200 and MPZJ(pid,2)>2 then
		 WAR.BLC = math.random(1,6)
		 local BGCX = {"【乾坤借力.雷霆震】","【乾坤借力.迅疾巽】","【乾坤借力.螺旋离】","【乾坤借力.奔流坎】","【乾坤借力.崩山艮】","【乾坤借力.陷空兑】"}
		 Set_Eff_Text(id, "特效文字0", BGCX[WAR.BLC])
		    if WAR.BLC == 1 then
			WAR.BJ = 1
			end
		 end
	end
	
	if WAR.YYJ[pid]~=nil and WAR.YYJ[pid]==2 and nglw(pid,171)>1 and WAR.ACT == 1 then --太极阳劲
	Set_Eff_Text(id,"特效文字2","太极真解.阳手")
	WAR.TJYQ = WAR.TJZX[pid] or 0
       if nglw(pid,171)>2 then
       WAR.TJYQ1 = math.random(1,2)
	   local BGCX = {"【太极演化.少阳白虎】","【太极演化.太阳朱雀】"}
	   DIYdisplay("【太极.四象衍化】")
	   Set_Eff_Text(id,"特效文字1",BGCX[WAR.TJYQ1])
       end	   
	end
  
  	if wugong==22 and wglw(pid,22)>1  then----金刚掌刚掌波
	   if WAR.ACT==1 and JLSD(10,80,pid)then----
	   WAR.JGZB = 1
	   Set_Eff_Text(id, "特效文字0", "刚掌波")
	   end
	   if WAR.JGZB1 >0 and WAR.ACT>1 then
	   WAR.JGZB = 2
	   Set_Eff_Text(id, "特效文字0", "刚掌烈波")
	   end 
	end
  
  	if wugong == 135 and Curr_NG(pid, 144) and nglw(pid,144)>2  then
	    if JLSD(20,50,pid) then
	    WAR.JGHJ = 135
		Set_Eff_Text(id, "特效文字0", "揭谛.大力金刚指")
       end	
  end	
	
	if kfkind == 1 and Curr_NG(pid, 90) and nglw(pid,90)>1 then----
	    if JLSD(20,50,pid) then
	    WAR.JGHJ = 90
		Set_Eff_Text(id, "特效文字0", "混元无极.破玉拳")
       end
	end

  	if wugong == 121 and Curr_NG(pid, 90) and nglw(pid,90)>1  then
	    if JLSD(20,90,pid) then
	    WAR.JGHJ = 121
		Set_Eff_Text(id, "特效文字0", "混元无极.铁指寸劲")
       end	
    end		


  	if wugong == 19 and Curr_NG(pid, 90) and nglw(pid,90)>1  then
	    if JLSD(20,90,pid) then
	    WAR.JGHJ = 19
		Set_Eff_Text(id, "特效文字0", "混元无极.寒阴侵袭")
       end	
    end	
	
	if match_ID_awakened(pid, 64,1)  and WAR.ACT==1 then
	   if WAR.ZBT1[pid] ~=nil and WAR.ZBT1[pid]>0 then
	     local aa = WAR.ZBT1[pid]
	   if aa>7 then
	   aa=7
	   end
	   ng = ng+200*aa
	   local WZTS = {"天璇","天权","天玑","天枢","玉衡","开阳","瑶光"}
	   local str=WZTS[aa]
	   CurIDTXDH(WAR.CurID, 45,1, "空明螺旋拳意")
	   CurIDTXDH(WAR.CurID, 68,1, aa.."重"..str)
	   Set_Eff_Text(id, "特效文字0", "七星.空明螺旋拳")
		WAR.ZBT3=(aa+1)*(aa+1)
		reseteffect2(WAR.ZBT1,pid,aa)
	   end
	end

	if D2ZBT(pid) and WAR.ACT==1 then
	   if WAR.ZBT1[pid] ~=nil and WAR.ZBT1[pid]>0 then
	     local aa = WAR.ZBT1[pid]
	   if aa>7 then
	   aa=7
	   end
	   ng = ng+200*aa
	   local WZTS = {"天璇","天权","天玑","天枢","玉衡","开阳","瑶光"}
	   local str=WZTS[aa]
	   CurIDTXDH(WAR.CurID, 45,1, "空明螺旋拳意")
	   CurIDTXDH(WAR.CurID, 68,1, aa.."重"..str)
	   Set_Eff_Text(id, "特效文字0", "七星.空明螺旋拳")
		WAR.ZBT3=(aa+1)*(aa+1)
		reseteffect2(WAR.ZBT1,pid,aa)
	   end
	end

	if D2ZBT(pid) and kfkind == 1 then
	   if JLSD(20,50+JY.Base["天书数量"],pid) or (WAR.ZYHB == 2 and JLSD(10,60+JY.Base["天书数量"],pid))then
	   ng = ng+1000+JY.Base["天书数量"]*50
	   WAR.DFMQ = math.modf(JY.Base["天书数量"]/2)
	   CurIDTXDH(WAR.CurID, 45,1, "斗神技.大伏魔拳")
	   Set_Eff_Text(id, "特效文字1", "斗神技.大伏魔拳")
	   end
	end

	if YCRW(pid) == 4 and kfkind == 1 and YCDJ(pid) >= 1 then----
	  if WAR.ZYHB == 2 then
	   ng = ng+1000+JY.Base["天书数量"]*50
	   WAR.DFMQ = math.modf(JY.Base["天书数量"]/2)
	   CurIDTXDH(WAR.CurID, 45,1, "泰拳技.铁肘")
	   Set_Eff_Text(id, "特效文字1", "泰拳技.铁肘")
	   end
	end	

	if YCRW(pid) == 4 and kfkind == 1  then----
	   local str = "爆拳"
	   WAR.TONY = 1
       if YCDJ(pid) >= 1 then
	   WAR.TONY = 2
	   WAR.GTSHAQI = WAR.GTSHAQI + 100
	   WAR.GTPID2 = pid
	   str = "爆拳.炮劲"
	   end
       Set_Eff_Text(id, "特效文字1", str)
	end	

	if YCRW(pid) == 4 and kfkind == 1  then----
	   if YCDJ(pid) >2 then
	       WAR.TONY2 = 1
       end
	   if YCDJ(pid) >= 2 and WAR.ACT == 1 then
	   local str = "火拳.祝融焚天掌"
	   WAR.TONY1 = 1	   
       Set_Eff_Text(id, "特效文字2", str)
	   end
	end	

	if wglw(pid,17)>2 and kfkind == 2  then----
	   local str = "锭光.圆觉指"
	   WAR.TONY3 = 1	   
       Set_Eff_Text(id, "特效文字2", str)
	end		
	
	if nglw(pid,107)>1 and kfkind == 1 then
	   if JLSD(20,70,pid) or WAR.NGJL>0 then
	   ng = ng+1000
	   WAR.DFMQ = math.modf(sixi(pid,1)/40)
	   CurIDTXDH(WAR.CurID, 45,1, "九阴奥义.大伏魔拳")
	   Set_Eff_Text(id, "特效文字1", "九阴奥义.大伏魔拳")
	   end
	end

	if nglw(pid,106)>1 and kfkind == 2 then
	   if JLSD(20,70,pid) or WAR.NGJL>0 then
	   ng = ng+1000
	   WAR.DFMQ = math.modf(sixi(pid,2)/40)
	   CurIDTXDH(WAR.CurID, 47,1, "九阳奥义.罡气剑指")
	   Set_Eff_Text(id, "特效文字1", "九阳奥义.罡气剑指")
	   end
	end

	if nglw(pid,104)>1 and kfkind == 5 then
	   if JLSD(20,70,pid) or WAR.NGJL>0 then
	   ng = ng+1000
	   WAR.FMZF = math.modf(sixi(pid,5)/40)
	   CurIDTXDH(WAR.CurID, 34,1, "逆运走火.疯魔杖")
	   Set_Eff_Text(id, "特效文字1", "逆运走火.疯魔杖")
	   end
	end
	
	if kfkind == 1 and wglw(pid, 61) >1  then----
	    if JLSD(20,50,pid) then
	    WAR.RWZ = 61
		Set_Eff_Text(id, "特效文字0", "日纹掌.戾炎")
		WAR.Person[id]["特效动画"]=35
       end
	end

	if kfkind == 4 and wglw(pid, 61) >1  then----
	    if JLSD(20,50,pid) then
	    WAR.WDZ = 62
		Set_Eff_Text(id, "特效文字0", "午刀.一斩")
       end
	   WAR.Person[id]["特效动画"]=98
	end
	
	if wugong == 21 and level == 11 and wglw(pid,21)>1 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		Set_Eff_Text(id, "特效文字1", "玄冥真传.寒阴无限")
		ng = ng + 1500
		WAR.WS = 1
        WAR.YY = 1
		WAR.Person[id]["特效动画"]=57
	end

	if wugong == 86 and level == 11 and match_ID(pid,644) and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		Set_Eff_Text(id, "特效文字1", "玄冥白鹿.寒阴杖击")
		ng = ng + 1500
		WAR.WS = 1
        WAR.YY = 1
		WAR.Person[id]["特效动画"]=57
	end	
	
	if wugong == 21 and level == 11 and wglw(pid,21)>2 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
	local str = "玄冥吐息.相柳冻牙"
	local str1 = "玄冥.相柳"
	local aa = 93
	local bb = 53
	      if JLSD(20,80,pid) or WAR.LQZ[pid] == 100 then
		  WAR.YY3 = 1
		  str = "相柳秘传.凄惶冥牙破"
		  str1 = "相柳.冥牙"
		  aa = 117
		  bb = 113
		  end
	CurIDTXDH(WAR.CurID, aa, 1, str, LightSkyBlue)
		Set_Eff_Text(id, "特效文字2", str1)
		WAR.WS = 1
        WAR.YY2 = 1
		WAR.Person[id]["特效动画"]=bb
	end

	if wugong == 120 and level == 11 and wglw(pid,120)>1 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
	local str="极度深寒.冰蚕丝雨"
	local str1 = "玄冰.冰蚕"
	local aa= 3
    local bb= 72
	   if WAR.YDXT[pid]~=nil then
	      str1 = "迷影.幻蝶"
		  bb = 178
	      aa = math.random(4,5)
		  if aa== 4 then
		  str="幻蝶迷花.黯灭之吻"
		  else
		  str="幻蝶翩影.迷乱之伤"
		  end
	   end
	    CurIDTXDH(WAR.CurID, bb, 1, str, LightSkyBlue)
		Set_Eff_Text(id, "特效文字2", str1)
		WAR.WS = 1
        WAR.YY2 = aa
		WAR.Person[id]["特效动画"]=61
	end
	
	if wugong == 66 and level == 11 and wglw(pid,66)>1 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		Set_Eff_Text(id, "特效文字1", "火焰刀意.烈阳无极")
		ng = ng + 1500
		WAR.WS = 1
        WAR.YY2 = 2
		WAR.Person[id]["特效动画"]=63
	end

	if wugong == 66 and level == 11 and wglw(pid,66)>2 and (WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
		local str = "赤阳金翅.毕方翔空"
	    local str1 = "赤阳.毕方"
	    local aa = 87
	    local bb = 67
	      if JLSD(20,80,pid) or WAR.LQZ[pid] == 100 then
		  WAR.YY3 = 2
		  str = "毕方秘传.烈霄炽羽闪"
		  str1 = "毕方.炽羽"
		  aa = 175
		  bb = 154
		  end	
	CurIDTXDH(WAR.CurID, aa, 1, str, C_GOLD)
	Set_Eff_Text(id, str1, str1)
		WAR.WS = 1
        WAR.YY2 = 2
		WAR.Person[id]["特效动画"]=bb
	end	
	
	--黯然极意
	if WAR.ARJY == 1 then 
		ng = ng + 1200
		WAR.WS = 1
		  if WAR.ARJY_LZ == 2 then
		  ng = ng + WAR.ACT * 200
		  end
		if wglw(pid,25)>1 and WAR.ARZS==1 and wugong== 25 then----
		
		elseif wglw(pid,22)>2 and wugong == 22 then
		for i = 1, 7 do
			for j = 1, 7 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
		elseif wglw(pid,4)>2 and wugong == 4  then
		for i = 1, 7 do
			for j = 1, 7 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
		else	
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
		end
	end
      
	--使用六脉神剑
    if wugong == 49 then
		local jl = 0
    	--学会一阳指
     	if PersonKF(pid, 17) then
			jl = jl + 30
		end
		if myrandom(level+jl, pid) or (match_ID(pid, 53) and myrandom(level+jl, pid)) then
			WAR.Person[id]["特效文字3"] = LMSJ[math.random(6)]
			ng = ng + 2000
			if match_ID(pid, 53) then
				WAR.LMSJwav = 1
				WAR.WS = 1
			end
		end
    end
 

    local ywjl = 0
	local ywjl1 = 0
	ywjl = MPDJ(pid)*10
	if MPZJ(pid,2)>2 then
	ywjl = ywjl + (WAR.CYZY[pid] or 0) *10
	ywjl1 = (WAR.CYZY[pid] or 0) * 2
	end
    if (MPPB_WD(pid)==1 or MPPB_WD(pid)==3) and WAR.NGJL>0 and kfkind ==3  and JLSD(20-ywjl1,50+ywjl,pid) then --沼跃鱼：武当太极剑法
	local SN=math.modf(JY.Person[pid]["内力"]/500)
	local SN2=MPDJ(pid)
	local str = "真武纯阳.圆舞剑"
	if JY.Person[pid]["武器"] == 236 then----
	SN2=SN2+5
	end
		if MPZJ(pid,2)>=1  then
        str = "无极剑势"
		WAR.WJJS = 1
		end
		if MPZJ(pid,2)>=2  then
		WAR.WJJS = 1 + math.random(1,1 + MPZJ(pid,2))
		local wjzs = {"【三环套月】","【八荒归元】","【万剑归宗】","【无我无剑】"}
        str = str..wjzs[WAR.WJJS-1]
		end
	WAR.GTJIQI=WAR.GTJIQI+ SN*(SN2+WAR.ACT)
	WAR.GTPID=pid
	WAR.BG[pid]=(WAR.BG[pid] or 0) + SN*(SN2+WAR.ACT)
    WAR.WJ[pid]= (WAR.WJ[pid] or 0) + SN*(SN2+WAR.ACT)*5
    Set_Eff_Text(id,"特效文字2",str)
	WAR.Person[id]["特效动画"] = 38
	end	 

	if MPPD(pid) == 2 and MPDJ(pid) >= 2 and WAR.WJ[pid] ~= nil then --武当无极
		WAR.GTSHAQI = WAR.GTSHAQI + WAR.WJ[pid]
		WAR.GTPID2 = pid
		if MPZJ(pid,2)>=1 and MPPB_WD(pid)==1 then
		
		else
        WAR.WJ[pid] = nil
		end
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = "无极"
		else
			WAR.Person[id]["特效文字3"] = "无极·"..WAR.Person[id]["特效文字3"]
		end		
	end 
	
    --罗汉拳，易筋经变身，般若掌
    if wugong == 1 and PersonKF(pid, 108) then
    	--易筋经加力
    	if inteam(pid) and JLSD(20, 80, pid) then
     	 	WAR.LHQ_BNZ = 1
    	elseif not inteam(pid) then	--敌方100%
    		WAR.LHQ_BNZ = 1
    	end
    end

    --罗汉拳，罗汉伏魔变身，伏虎拳
    if wugong == 1 and ((PersonKF(pid, 96) and nglw(pid,96)>1) or match_ID(pid,400) ) then
    	--易筋经加力
    	if inteam(pid) and (JLSD(20, 80, pid) or match_ID(pid,400) ) then
     	 	WAR.LHQ_FM = 1
    	elseif not inteam(pid) then	--敌方100%
    		WAR.LHQ_FM = 1
    	end
    end	
	
    if wugong == 1 and wglw(pid,1)>=1 then
       if wglw(pid,1)>1 then
	   WAR.LHQ_WX = math.random(1,5)
	   end
	   if WAR.NQHR[pid]~=nil and  wglw(pid,1)>2 then
	   local aa = WAR.NQHR[pid] or 0
	   if aa>5 then
	   aa = 5
	   elseif aa<3 then
	   aa = 0
	   end
	   reseteffect2(WAR.NQHR, pid, aa)
	   WAR.LHQ_WX1 = aa
	   end	   
	   if WAR.BJ == 1 then
	   WAR.CXLC = 1
	   end	 
    end		

    if (yongzhi(wugong) or yongjian(wugong)) and Kaiyan_ID(pid,655) then
        WAR.LHQ_WX = math.random(1,5)
    end	
	
     if wugong == 65 and PersonKF(pid, 96) and nglw(pid,96)>2 then
    	--易筋经加力
    	if inteam(pid) and JLSD(20, 80, pid) then
     	 	WAR.RMD_FM = 1
    	elseif not inteam(pid) then	--敌方100%
    		WAR.RMD_FM = 1
    	end
    end	
 
    if kfkind ==4 and MPZJ(pid,3)>=1 and MPPB_SL(pid) == 1 then
    	--易筋经加力
    	if  JLSD(20, 80, pid) or WAR.BJ == 1 then
     	 	WAR.LH_DZ = 1
			local str = "佛戒断罪.嗔恶"
			if MPZJ(pid,3)>=2 and JLSD(10,50,pid) then
			local aa = math.random(1,2)
			   if aa == 1 then
			   WAR.LH_DZ = 2
			   str = "佛戒断罪.退怒"
			   else
			   WAR.LH_DZ = 3
			   str = "佛戒断罪.破魔"
			   end
			end
			CurIDTXDH(WAR.CurID, 37+WAR.LH_DZ, 1,str, PinkRed)
    	end
    end	
 
      if wugong == 61 and PersonKF(pid, 96) and nglw(pid,96)>1 then
    	--易筋经加力
    	if inteam(pid) and JLSD(20, 80, pid) then
     	 	WAR.JW_FM = 1
    	elseif not inteam(pid) then	--敌方100%
    		WAR.JW_FM = 1
    	end
    end	
    
	if wugong == 86 and PersonKF(pid, 96) and nglw(pid,96)>2 then
    	--易筋经加力
    	if inteam(pid) and JLSD(20, 80, pid) then
     	 	WAR.FMZ_FM = 1
    	elseif not inteam(pid) then	--敌方100%
    		WAR.FMZ_FM = 1
    	end
    end
 
     --罗汉拳，罗汉伏魔变身，摩诃掌
    if wugong == 26 and PersonKF(pid, 96) and nglw(pid,96)>1 then
    	--易筋经加力
    	if inteam(pid) and JLSD(20, 80, pid) then
     	 	WAR.XLZ_FM = 1
    	elseif not inteam(pid) then	--敌方100%
    		WAR.XLZ_FM = 1
    	end
    end	
 
    --大力金刚掌，易筋经变身，达摩掌
    if wugong == 22 and PersonKF(pid, 108)  then
    	--易筋经加力 
    	if inteam(pid) and JLSD(40, 80, pid) then
			WAR.JGZ_DMZ = 1
    	elseif not inteam(pid) then   --敌方100%
    		WAR.JGZ_DMZ = 1
    	end
    end
	
	--五毒神掌，李莫愁用有70%几率变赤练神掌
    if wugong == 3 and match_ID(pid, 161) and JLSD(10, 80, pid) then
		WAR.WD_CLSZ = 1
    end
	
    if match_ID_awakened(pid,54,1) and JY.Person[54]["论剑奖励"] == 1 and JLSD(10, 60, pid) and yongjian(wugong) then
	   WAR.WD_CLSZ = 2
	end
 
    if JY.Person[pid]["生命"]>= math.modf(JY.Person[pid]["生命最大值"]*0.5) and match_ID_awakened(pid,54,1) and JY.Person[54]["论剑奖励"] == 1 and JLSD(10, 60, pid) and yongjian(wugong) then
	   WAR.BXJY = 1
	   local nlDam = math.modf(JY.Person[pid]["生命"] * 0.1) 
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
	end
	

 
    --铜人阵，9个强力铜人
    if pid > 480 and pid < 490 then
		WAR.Person[id]["特效文字2"] = "易经筋加力"
		ng = ng + 1200
		WAR.JGZ_DMZ = 1   --直接触发达摩掌
    end
    
    --石破天，太玄神功，50%追加气攻
    if match_ID(pid, 38) and wugong == 102 and level == 11 and match_ID_awakened(pid, 38,1) then
		WAR.SPT = WAR.TXZS
		   if WAR.SPT == 2 then
              addeffect2(WAR.SATA, pid, 5)
		   end
		   if WAR.SPT == 3 then
		   			  addeffect2(WAR.KBGJ, pid, 20)
					  addeffect2(WAR.KBGJ2, pid, 20)
		   end
		   if WAR.SPT == 4 then
		      addeffect2(WAR.HIDE, pid, 20)
		   end
		   if WAR.SPT == 5 then
		      WAR.LUCK[pid] = (WAR.LUCK[pid] or 0) + 20
		   end
    end

    if wglw(pid, 4)>1 and wugong == 4 and level == 11  then
	    WAR.LQS = WAR.LQZS
		   if WAR.LQS == 1 then
              addeffect2(WAR.SATA, pid, 2)
			  addeffect2(WAR.HIDE, pid, 20)
			  if wglw(pid,4)>2 and (JLSD(10,70,pid) or (WAR.LQZ[pid]~=nil and WAR.LQZ[pid] == 100))  then
              CurIDTXDH(WAR.CurID, 37, 1, "猛禽飞燕势奥义.烈孔空牙", PinkRed)
			  WAR.LQZS_HQ = 1
			     if JLSD(10,70,pid) then
			     WAR.LQAY = 1
			     addeffect2(WAR.SATA, pid, 3)
			     end
			  end
		   end
		   if WAR.LQS == 2 then
		      addeffect2(WAR.DR, pid, 2)
			  WAR.LQZS_HQ = 2
			  WAR.BJ = 1
			  if wglw(pid,4)>2 and (WAR.SATA[pid] or 0 ) >=1 then
              CurIDTXDH(WAR.CurID, 67, 1, "猛禽孤鹫势奥义.翔鹫屠脚", LightPurple)
			  WAR.LQAY = 2
			  reseteffect2(WAR.SATA, pid, 1)
			  addeffect2(WAR.DR, pid, 3)
			  end
		   end
		   if WAR.LQS == 3 then
		      reseteffect2(WAR.SATA, pid, 1)
			  WAR.BFX = 1
			  if wglw(pid,4)>2 and (WAR.DR[pid] or 0) >=1 then
              CurIDTXDH(WAR.CurID, 139, 1, "猛禽水鸟势奥义.飞翔白丽", LightPurple)
			  WAR.LQAY = 3
			  reseteffect2(WAR.DR, pid, 1)
			  end
		   end
		   if WAR.LQS == 4 then
		      reseteffect2(WAR.DR, pid, 1)
			  WAR.BLX = 1
			  if wglw(pid,4)>2 and (WAR.SATA[pid] or 0) >=1 then
              CurIDTXDH(WAR.CurID, 120, 1, "猛禽红鹤势奥义", M_DarkRed)
			  lib.Delay(300)
			  CurIDTXDH(WAR.CurID, 115, 1, "血妆嘴", M_DarkRed)
			  WAR.LQAY = 4
			  reseteffect2(WAR.SATA, pid, 1)
			  end
		   end
		   if WAR.LQS == 5 then
		      reseteffect2(WAR.SATA, pid, 2)
			  WAR.BBF = 1
			  if wglw(pid,4)>2 and (WAR.DR[pid] or 0) >=2 then
              CurIDTXDH(WAR.CurID, 144, 1, "猛禽白鹭势奥义", M_DeepSkyBlue)
			  lib.Delay(300)
			  CurIDTXDH(WAR.CurID, 136, 1, "烈舞空脚", M_DeepSkyBlue)
			  WAR.LQAY = 5
			  reseteffect2(WAR.DR, pid, 2)
			  end
		   end
		   if WAR.LQS == 6 then
		      reseteffect2(WAR.DR, pid, 2)
			  WAR.BZS = 1
			  if wglw(pid,4)>2 and (WAR.SATA[pid] or 0) >=2 then
			  CurIDTXDH(WAR.CurID, 143, 1, "猛禽凤凰势奥义", C_GOLD)
			  lib.Delay(300)
              CurIDTXDH(WAR.CurID, 154, 1, "天翔十字凤", C_GOLD)
			  WAR.LQAY = 6
			  for i = 1, 30 do
		        	DrawStrBox(-1, 24, "猛禽奥义.凤凰.十字翙羽", M_Red, 10 + i)
			        ShowScreen()
			        lib.Delay(10)
		      end
		      for i = 1, 11, 2 do
			      for j = 1, 11, 2 do
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1, WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1, WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1, WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
					SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1, WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
				  end
			  end
			  reseteffect2(WAR.SATA, pid, 2)
			  end
		   end
    end


	if wugong == 68 and wglw(pid,68)>=1 and WAR.YJZS ==1  and WAR.YJQS[pid]~= nil and WAR.YJQS[pid] == 1 then
	local aa = 	math.abs(WAR.Person[WAR.CurID].Time - WAR.Person[enemyid].Time)			    
	end
	
    if wglw(pid, 25)>1 and wugong == 25 and level == 11 then
		   if wglw(pid,25)>2 and WAR.ARZS==6 and wugong== 25 then
		      WAR.MZLL[pid] = (WAR.MZLL[pid] or 0) + 20
		   end
		   if wglw(pid,25)>1 and WAR.ARZS==3 and wugong== 25 and WAR.ZYHB ~= 2 then
		      WAR.BJ =1
			  addeffect2(WAR.SATA, pid, 5)
			  Set_Eff_Text(id, "特效文字1", "拖泥带水.葵水之轻")
		   end
    end	
    
    --狄云，神经照，50%追加气攻
    if match_ID(pid, 37) and wugong == 94 and level == 11 and JLSD(25, 75, pid) then
		WAR.Person[id]["特效文字3"] = "神照经·无影神拳"
		ng = ng + 1000
		if match_ID_awakened(pid,37,1) then--
			local qljj = {"无影壹式·无坚不摧",
			"无影贰式·无迹可寻",
			"无影终式·缥缈无踪"}
			local color = {M_DeepSkyBlue,M_Red,M_SandyBrown}
		WAR.WYSQ = math.random(1,3)
		NEWTXWZ(qljj[WAR.WYSQ],color[WAR.WYSQ])
		    if WAR.WYSQ == 3  then
			WAR.HIDE2[pid] = limitX((WAR.HIDE2[pid] or 0) + 20 , 0 ,50)
			end
		end
    end
 
   if match_ID_awakened(pid, 37,1) and kfkind == 4 and JY.Person[37]["论剑奖励"] == 2 and JLSD(25, 75, pid) then
		WAR.Person[id]["特效文字3"] = "影流·无影裁决"
		ng = ng + 1000
		if match_ID_awakened(pid,37,1) then--
			local qljj = {"无影壹式·无坚不摧",
			"无影贰式·无迹可寻",
			"无影终式·缥缈无踪"}
			local color = {M_DeepSkyBlue,M_Red,M_SandyBrown}
		WAR.WYSQ = math.random(1,3)
		NEWTXWZ(qljj[WAR.WYSQ],color[WAR.WYSQ])
		    if WAR.WYSQ == 3  then
			WAR.HIDE2[pid] = limitX((WAR.HIDE2[pid] or 0) + 20 , 0 ,50)
			end
		end
    end 
 
	if wglw(pid, 40)>1 and JLSD(10, 70, pid)  and PersonKFJ(pid,40) and wugong == 40 and WAR.JSBD[pid]== nil and War_isEnd() == 0  then --金蛇飞锥
    WAR.LMC = 1
	local x1=WAR.Person[WAR.CurID]["坐标X"]
	local y1=WAR.Person[WAR.CurID]["坐标Y"]
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false and RealJL2(x1,y1, i, 8) then
				WAR.JSBD[pid]= {WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]}
				break
			end
		end
	end

	if match_ID_awakened(pid,11,1) and JLSD(10, 70, pid) and wugong == 18 and WAR.JSBD[pid]== nil and War_isEnd() == 0  then --金蛇飞锥
    WAR.LMC = 1
	local x1=WAR.Person[WAR.CurID]["坐标X"]
	local y1=WAR.Person[WAR.CurID]["坐标Y"]
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false and RealJL2(x1,y1, i, 8) then
				WAR.JSBD[pid]= {WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]}
				break
			end
		end
	end

	if match_ID_awakened(pid,55,1) and wugong == 26 and War_isEnd() == 0  then --翔龙箭
	   local aa = WAR.TZNQ2[pid] or 0
	   if JLSD(10,10+aa,pid) or (WAR.LQZ[pid]~=nil and WAR.LQZ[pid] == 100) or aa >= 50 then
       WAR.LMC = 1
	   WAR.SDYG = aa
	   WAR.TZNQ2[pid] = 0
	    local x1=WAR.Person[WAR.CurID]["坐标X"]
	    local y1=WAR.Person[WAR.CurID]["坐标Y"]
		   for i = 0, WAR.PersonNum - 1 do
			   if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false and RealJL2(x1,y1, i, 5+math.modf(aa/10)) then
				  WAR.GSWS3[pid] = {WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]}
				  break
			   end
		   end
		end
	end

	if PersonKFJ(pid, 26) and PersonKFJ(pid, 80) and match_ID_awakened(pid,69,1) and (JLSD(0,60,pid) or (WAR.LQZ[pid]~=nil and WAR.LQZ[pid]==100 ) )  and War_isEnd() == 0 then
       if wugong ==26 and WAR.GSWS2[1] == nil then
	      WAR.GSWS1 = {x, y}
	   elseif wugong ==80 and WAR.GSWS1[1] == nil then
	      WAR.GSWS2 = {x, y}
	   end	
	end	

    if wglw(pid,114)>1 and WAR.NGJL>0 and wugong == 114 and WAR.JX_QLJJ2 == 0  then
			local qljj = {"连城剑·壹式·波澜壮阔淹九泉",
			"连城剑·贰式·狂风杀煞诛九难",
			"连城剑·叄式·轰雷破殛震九洲",
			"连城剑·肆式·浴火重生惊九霄",
			"烽火连城·剑荡天下·天崩地裂鬼神惊"}
			local color = {M_DeepSkyBlue,M_YellowGreen,M_Yellow,M_Red,M_SandyBrown}
		    local txdh = {5,166,167,154,155}
		local ql = 1
		if JY.Base["天书数量"]>= 4 then
			ql = ql + 1
		end
		if JY.Base["天书数量"]>= 7 then
			ql = ql + 1
		end
		if JY.Base["天书数量"]>= 10  then
			ql = ql + 1
		end
		if WAR.ACT>1 then
			ql = ql + WAR.ACT
		end
		WAR.JX_QLJJ = math.random(1,5)
		if match_ID_awakened(pid,37,1) and JY.Person[37]["论剑奖励"] == 1 and WAR.SZJS[pid] ~= nil then
		WAR.JX_QLJJ =  3
		end
		if match_ID_awakened(pid,589,1) and JY.Person[589]["论剑奖励"] == 2  then
		WAR.JX_QLJJ =  1
		end
		Cls()
		NEWTXWZ(qljj[WAR.JX_QLJJ],color[WAR.JX_QLJJ])
		if not match_ID(pid,589) then--
		WAR.WS = 1
		end
		ng = ng + 300*ql
		for i = 1, 4+ql do
			for j = 1, 4+ql do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
        WAR.Person[id]["特效动画"] = 67+ WAR.JX_QLJJ
		WAR.JZTX = txdh[WAR.JX_QLJJ]
        if  wglw(pid,114)>2  then
		WAR.HZD2 = {x, y}
		end
		if match_ID_awakened(pid,589,1) and JY.Person[589]["论剑奖励"] == 2 then
		WAR.HZD2 = {x, y}
		end
    end

	if wglw(pid,54)>1 and wugong == 54 and WAR.ACT == 1 then --何足道多次攻击
		local jl = 60 + math.modf(JY.Person[pid]["实战"] / 20)
		if (JLSD(10, 10 + jl, pid) or WAR.ZYHB == 2)  then
			WAR.HZD = {x, y}
		end
	end	

    --ivansz:温青青，使用雷震剑法，伤害随机提高，最高为3倍
    if (match_ID(pid,91) or wglw(pid,28)>1) and wugong == 28 then
	  local jl = 60 + math.modf(JY.Person[pid]["实战"] / 20)
      WAR.WQQ = 1
	  if JLSD(10,jl,pid)  then
	  WAR.WQQ1[pid] = 1
	  end
    end  

	if wglw(pid,129)>1  and WAR.ACT == 1  then --旋风扫叶腿
		local jl = 60 + math.modf(JY.Person[pid]["实战"] / 20)
		if (JLSD(10, 10 + jl, pid) or WAR.KFCF == 1) and War_isEnd() ==  0 then
			WAR.HZD1 = {x, y}
			WAR.KFCF = 0
		end
	end	

    --佐佐木，秘剑细雪
    if match_ID_awakened(pid,517,1) and WAR.ACT == 1 then
		local jl = 60 + math.modf(JY.Person[pid]["实战"] / 20)
		if JLSD(10, 10 + jl, pid)   then
			WAR.HZD3 = {x, y}
		end
    end

    if PersonKFJ(pid,84) and JLSD(10,100-(math.abs(JY.Person[pid]["资质"]-50)),pid) and WAR.Person[id]["追击武功"] == -1   then
	WAR.Person[id]["追击武功"] = wugong	
	WAR.YTTLLV[pid] = 0
	   if sixi(pid,5)>300 then
	   WAR.YTTLLV[pid] = 3
	   elseif sixi(pid,5)>100 then
	   WAR.YTTLLV[pid] = 2
	   else
	   WAR.YTTLLV[pid] = 1
	   end
	   if wglw(pid,84)>2  then
	   WAR.YTTLLV[pid] = WAR.YTTLLV[pid] + 1
	   end
	end

   for j = 0, WAR.PersonNum-1 do
			    local df = WAR.Person[j]["人物编号"] 
			    local offset1 = math.abs(WAR.Person[id]["坐标X"] - WAR.Person[j]["坐标X"]) 
                local offset2 = math.abs(WAR.Person[id]["坐标Y"] - WAR.Person[j]["坐标Y"])
			    local offset=offset1+offset2
                local mpdj = 8			
			    if WAR.Person[j]["我方"] ~= WAR.Person[id]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) and wglw(df,62) >=1 and WAR.Person[j]["反击武功"] == -1 then
                    if JLSD(10,40+wglw(df,62)*10,df) then
				    local z = WAR.CurID
					WAR.CurID  = j
                   	WarDrawMap(0); --不加这条则动画位置无法正常显示
					WAR.Person[j]["反击武功"] = 62
					CurIDTXDH(WAR.CurID, 32,1,"感应·扰乱刀",C_GOLD)	
	                WAR.FQDF2[df] = 0
	                if sixi(df,4)>300 then
	                   WAR.FQDF2[df] = 3
	                elseif sixi(df,4)>100 then
	                   WAR.FQDF2[df] = 2
	                else
	                   WAR.FQDF2[df] = 1
	                end
	                if wglw(df,62)>2  then
	                   WAR.FQDF2[df] = WAR.FQDF2[df] + 1
	                end
                    WAR.CurID = z					
					end
			    end	  			
   end

   for j = 0, WAR.PersonNum-1 do
			    local df = WAR.Person[j]["人物编号"] 
			    local offset1 = math.abs(WAR.Person[id]["坐标X"] - WAR.Person[j]["坐标X"]) 
                local offset2 = math.abs(WAR.Person[id]["坐标Y"] - WAR.Person[j]["坐标Y"])
			    local offset=offset1+offset2
                local mpdj = 8			
			    if WAR.Person[j]["我方"] == WAR.Person[id]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) and wglw(df,62) >=1 and WAR.Person[j]["补刀武功"] == -1 and id~=j then
                    if JLSD(10,40+wglw(df,62)*10,df) then
				    local z = WAR.CurID
					WAR.CurID  = j
                   	WarDrawMap(0); --不加这条则动画位置无法正常显示
					WAR.Person[j]["补刀武功"] = 62
					CurIDTXDH(WAR.CurID, 33,1,"感应·续补刀",C_GOLD)	
	                WAR.FQDF1[df] = 0
	                if sixi(df,4)>300 then
	                   WAR.FQDF1[df] = 3
	                elseif sixi(df,4)>100 then
	                   WAR.FQDF1[df] = 2
	                else
	                   WAR.FQDF1[df] = 1
	                end
	                if wglw(df,62)>2  then
	                   WAR.FQDF1[df] = WAR.FQDF1[df] + 1
	                end
                    WAR.CurID = z					
					end
			    end	  			
   end

    if nglw(pid,92)>= 2 and Curr_NG(pid,92) and kfkind ==1 and WAR.NGJL>0 and JLSD(10,60,pid) and WAR.SZH1[1] == nil then --沼跃鱼：闪电光速拳
    WAR.SZH = 1
    Set_Eff_Text(id,"特效文字2","狮心.闪电光速拳")
	WAR.Person[id]["特效动画"] = 43
	   if nglw(pid,92)>2 and JLSD(10,40,pid) then
	   WAR.SZH1= {x,y,wugongnum}
	   end
	end 
	
    --苗家剑法，为极，配合胡家刀法。 60%刀剑合壁
    if wugong == 44 and level == 11 and math.random(10) < 7 and not match_ID(pid, 72) then
		 if wglw(pid,44)>1 then
	  	  local SN2=math.modf(JY.Person[pid]["御剑能力"]/50)+3
		  CurIDTXDH(WAR.CurID, 175, 1, "苗家天剑.凤舞剑气", M_Red)
		  ng = ng + math.modf(SN2*200)
	      if WAR.Person[id]["特效文字1"] ~= nil then
        		WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."凤舞剑气"
        	else
          	WAR.Person[id]["特效文字1"] = "苗家天剑.凤舞剑气"
          end
          WAR.Person[id]["特效动画"] = 73
          WAR.DJGZ2 = 2
		else
		for i = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. i] == 67 and JY.Person[pid]["武功等级" .. i] == 999 then
				if WAR.Person[id]["特效文字1"] ~= nil then
					WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."胡刀苗剑 归真合一"
				else
					WAR.Person[id]["特效文字1"] = "胡刀苗剑 归真合一"
				end
				WAR.Person[id]["特效动画"] = 6
				WAR.DJGZ = 1
				ng = ng + 2000
				break
			end
		end
		end
    end
 
	if  WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 1  and yongdao(wugong) and math.random(100) < 16 then --万劫刀法冷血
		WAR.QSLX = 1
		WAR.Actup[pid] = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
        		WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."冷血斩"
        	else
          	WAR.Person[id]["特效文字1"] = "七杀.冷血斩"
        end
        WAR.Person[id]["特效动画"] = 73
	end		
 
 	   if yongdao(wugong)  and WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 5  then
          WAR.QSLX = 2
		  if WAR.Person[id]["特效文字1"] ~= nil then
        	WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."黄泉斩"
          else
          	WAR.Person[id]["特效文字1"] = "慈姑.黄泉斩"
          end
         WAR.Person[id]["特效动画"] = 73
	   end
 
 	if WAR.GSSL[pid]~=nil and WAR.GSSL[pid] ==  3 and yongdao(wugong) then
			WAR.QSLX = 1
		if math.random(100) < 30 then
		local SN2=math.modf((JY.Person[pid]["耍刀技巧"])/100)+3
		local str = "【无量神刀.无相.贯日刀】"
		CurIDTXDH(WAR.CurID, 117, 1,str, C_CYGOLD)
		WAR.QSLX_SY = 1
			 for i = 1, SN2 do
				for j = 1, SN2 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		if WAR.Person[id]["特效文字1"] ~= nil then
        	WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."无相.贯日刀气"
        else
          	WAR.Person[id]["特效文字1"] = "无相.贯日刀气"
        end
        WAR.Person[id]["特效动画"] = 67
		end
	end
 
    --胡家刀法，为极，配合苗家剑法。 60%刀剑合壁
    if wugong == 67 and level == 11 and math.random(10) < 7 and not match_ID(pid, 72) then
	   if match_ID_awakened(pid,4,1) then
	  local SN2=math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5))/100)+3
	  local str = "千毒胡刀.暗刃无影"
	  	  if JY.Person[4]["论剑奖励"] == 2 then
		  WAR.JZTX = 134
		  WAR.HDMC2 = 5
		  str = "【胡家毒刀.黑刃.玄冥毒蛟噬】"
		  end
	  CurIDTXDH(WAR.CurID, 117, 1,str, LightGreen)
		  for i = 1, SN2 do
				for j = 1, SN2 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end

          ng = ng + math.modf(SN2*400)
	      if WAR.Person[id]["特效文字1"] ~= nil then
        		WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" ..str
        	else
          	WAR.Person[id]["特效文字1"] = str
          end
          WAR.Person[id]["特效动画"] = 71
          WAR.DJGZ2 = 1

      elseif wglw(pid,67)>1 then
	  	  local SN2=math.modf(JY.Person[pid]["耍刀技巧"]/50)+3
		  CurIDTXDH(WAR.CurID, 111, 1, "胡家绝刀.升龙刀意", LightSkyBlue)
		  ng = ng + math.modf(SN2*200)
	      if WAR.Person[id]["特效文字1"] ~= nil then
        		WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."升龙刀意"
        	else
          	WAR.Person[id]["特效文字1"] = "胡家绝刀.升龙刀意"
          end
          WAR.Person[id]["特效动画"] = 69
          WAR.DJGZ2 = 3
	  else--17-1-1
		for i = 1, CC.Kungfunum do
			if JY.Person[pid]["武功" .. i] == 44 and JY.Person[pid]["武功等级" .. i] == 999 then
				if WAR.Person[id]["特效文字1"] ~= nil then
					WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."胡刀苗剑 归真合一"
				else
					WAR.Person[id]["特效文字1"] = "胡刀苗剑 归真合一"
				end
				WAR.Person[id]["特效动画"] = 6
				WAR.DJGZ = 1
				ng = ng + 2000
				break
			end
		end
		end
    end
	
	if wugong == 67 and level == 11 and wglw(pid,67)>2 then
	   	if JY.Person[pid]["武器"] >0 and (WAR.DJGZ2>0 or WAR.DJDAO>0 ) then
			local aa = JY.Person[pid]["武器"]
			local str = ""
			local bb = 0
			local cc = 111
			local dd = 0
			local color = M_Red
			local BDQS = {"天霸皇狮哮", "首斩鬼龙舞", "冥河血鲛浪", "天霜冰螭盘", "玄冥毒蛟噬", "亢金白虎牙", "丹鹤鸣九臯","鸾凤比翼翔"}
			if aa == 202 then---- 闯王刀，血龙吟
			bb= 1
			cc=118
			WAR.JZTX = 126
			color = C_ORANGE
			elseif aa == 43 then-- 屠龙刀 皇龙盘
			bb = 2
			cc = 123
		    WAR.JZTX = 13
			color =C_WHITE
			elseif aa == 44 then-- 血刀 冥龙牙
			bb = 3
			WAR.JZTX = 146
			color = C_RED
			elseif aa == 45 then-- 冷月刀 冰龙息
			bb = 4
			cc = 113
			WAR.JZTX = 8
			color = M_DeepSkyBlue
			elseif aa == 46 then-- 绿波刀 毒龙钻
			bb = 5
			color = Violet
			cc = 117
			WAR.JZTX = 134
			elseif aa == 47 then-- 金刀 亢龙角
			bb = 6
			cc = 176
			WAR.JZTX = 132
			color =C_GOLD
			elseif aa == 48 then-- 雁翎刀 飞龙舞
			bb = 7
			cc = 120
			WAR.JZTX = 139
			WAR.LLH = 500 
			elseif aa == 217 then-- 鸳刀 双龙会
			bb = 8
			cc = 156
			WAR.JZTX = 115
			end
			WAR.HDMC = bb
			if bb>0 then
			str = BDQS[WAR.HDMC]
			CurIDTXDH(WAR.CurID, cc, 1, "刀意化魂."..str,color )
			Set_Eff_Text(id, "特效文字0", str)
			end
		end	  
    end	
	
	if wglw(pid,44)>1 and wglw(pid,67)>1 and wglw(pid,44)+wglw(pid,67)>4 and math.random(10) < 5 and (wugong == 67 or wugong == 44) then----
				WAR.DJGZ = 2
				ng = ng + 2000
				if WAR.Person[id]["特效文字2"] ~= nil then
					WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."刀剑合一"
				else
					WAR.Person[id]["特效文字2"] = "天剑绝刀 本源合一"
				end
	end
	
		if  match_ID(pid, 72) and match_ID_awakened(pid,72,1) and WAR.DZXYLV[pid]==nil then --田归农刀剑十杀
		if wugong == 44 then --剑法特效
			if WAR.ACT==1 then
            WAR.DJHB1[pid]=1
			end
			local jilv=30
			jilv=jilv+math.modf(JY.Person[pid]["御剑能力"]/10)
			jilv=jilv+math.modf(JY.Person[pid]["受伤程度"]/10)
			if JY.Person[pid]["生命"]<math.modf(JY.Person[pid]["生命最大值"]/3) then
				jilv=jilv+math.modf(JY.Person[pid]["生命"]/50)
			end
			if WAR.COMBO[pid]~=nil then
			   jilv=jilv+ 10
			end
			if jilv>=math.random(100) then				
				local word="刀剑双绝.不动一剑痕"
                if JY.Person[72]["论剑奖励"] == 1 then
				word="【灭剑血龙.冥河血鲛浪】"
				WAR.HDMC2 = 3
			    WAR.JZTX = 146
				end
				if WAR.Person[id]["特效文字1"]==nil then
					WAR.Person[id]["特效文字1"]=word
				else
					WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
				end
				WAR.Person[id]["特效动画"]=98			  
				WAR.DJJIAN=1 
				
			end
		end
		
		if wugong == 67 then --刀法特效
			local jilv=30
			if WAR.ACT==1 then	
            WAR.DJHB2[pid]=1
			end
			jilv=jilv+math.modf(JY.Person[pid]["耍刀技巧"]/10) --最大加24
			jilv=jilv+math.modf(JY.Person[pid]["受伤程度"]/10) --最大加10
			if JY.Person[pid]["生命"]<math.modf(JY.Person[pid]["生命最大值"]/3) then
				jilv=jilv+math.modf(JY.Person[pid]["生命"]/50) --最大加10
			end
			if WAR.COMBO[pid]~=nil then
			   jilv=jilv+ 10
			end
			if jilv>=math.random(100) then
				local word="刀剑双绝.狂龙裂斩"
				 if JY.Person[72]["论剑奖励"] == 2 then
				word="【绝刀哀号.皇龙霸气斩】"
				WAR.HDMC2 = 9
			    WAR.JZTX = 131
				end
				ng=ng+1700
				if WAR.Person[id]["特效文字1"]==nil then
					WAR.Person[id]["特效文字1"]=word
				else
					WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
				end	
				WAR.Person[id]["特效动画"]=95
				WAR.DJDAO=1 	
			end
		end	

		
		if ((WAR.DJHB1[pid]~=nil and WAR.DJHB2[pid]~=nil) or WAR.AutoFight == 1) and WAR.ZYHB == 2 then --刀+剑
			local word=""
			 CurIDTXDH(WAR.CurID, 103, 1, "刀剑十杀.古月照今尘", PinkRed)
			if WAR.ATNum<3  then
			WAR.ATNum=3
			end
			WAR.DJSX=1
			word="刀剑十杀.古月照今尘" 
			ng = ng + 500
			WAR.DJHB1[pid]=nil
		     WAR.DJHB2[pid]=nil --重置			
			if WAR.Person[id]["特效文字1"]==nil then
				WAR.Person[id]["特效文字1"]=word
			else
				WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=99
		end
		
				
		if WAR.ATNum >= 3  then
			WAR.WS = 1
			ng = ng + 1000
			for i = 1, 6 do
				for j = 1, 6 do
				  SetWarMap(x + i - 1, y + j - 1, 4, 1)
				  SetWarMap(x - i + 1, y + j - 1, 4, 1)
				  SetWarMap(x + i - 1, y - j + 1, 4, 1)
				  SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		end
	else
		WAR.DJHB1[pid]=nil
		WAR.DJHB2[pid]=nil --重置
		

	end
	
	if  wglw(pid,77)>1 and WAR.DZXYLV[pid]==nil then --倒错刀剑
		if wugong == 77  then --倒错刃特效
			if WAR.ACT==1 then
            WAR.DJHB3[pid]=1
			end
			
		    local word=""
			local num=0
			
            if WAR.ZYHB==2 then
			num=78
			     if WAR.DJZS==3 then
			     word="刀剑顺行.黑剑伪剑"
				 WAR.DZDJ = 3
                 WAR.ASKD=1	
			     elseif WAR.DJZS==4 then
				 WAR.DZDJ = 4
			     word="刀剑顺行.黑剑真剑"
			     end
            else
			num=79
			     if WAR.DJZS==1 then
			     word="刀剑顺行.金刀为刀"
				 WAR.DZDJ = 1		     
			     elseif WAR.DJZS==2 then
			     word="刀剑逆转.金刀非刀"
				 WAR.DZDJ = 2
				 CleanWarMap(4, 0)
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                           SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                        end
                    end	
	                WAR.WS = 1 
			     end
            end			
				if WAR.Person[id]["特效文字1"]==nil then
					WAR.Person[id]["特效文字1"]=word
				else
					WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
				end
				WAR.Person[id]["特效动画"]=num
                WAR.DJZS = 0
            if wglw(pid,77)>2 and (sixi(pid,5)>=100 or match_ID(pid, 616)) and WAR.ZYHB==2  then
               local tmp=math.random(1,2) 
			   if tmp == 1  then
			   WAR.DJHB6[pid] =1
			   else
			   WAR.DJHB7[pid] =1
			   end
            end			
	    end
		
		
		if kfkind==3 then --剑法特效
			if WAR.ACT==1 then				
				WAR.DJHB6[pid] =1 --剑法判定
			end
			WAR.DJGZ2 =2
		end
		
		if kfkind==4 then --刀法特效
			if WAR.ACT==1 then	
				WAR.DJHB7[pid] =1 --刀法判定
			end
			WAR.DJGZ2 =3
		end	

		
		if WAR.DJHB3[pid]~=nil and WAR.DJHB6[pid]~=nil and WAR.ZYHB == 2 and  wglw(pid,77)>2  then --假刀
			local word=""
			local tmp=math.random(1,2) 
				if tmp == 1  then
					WAR.DZDJ1=1
					word="舞雷刀·千鸟" --生命越低增加伤害越高 最高300 杀气1000
					ng = ng + 500
					WAR.DJHB3[pid]=nil
				    WAR.DJHB6[pid]=nil --重置	
				else
					WAR.DZDJ1=2
					word="舞雷刀·雷火" 
					local ns=20
	            for j = 0, WAR.PersonNum - 1 do
                   if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                      JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] = JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] + ns
                   end
                   if 100 < JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] then
                      JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] = 100
                   end
                end
	           ng = ng + 50*ns
					WAR.DJHB3[pid]=nil
				    WAR.DJHB6[pid]=nil --重置						
				end			
			if WAR.Person[id]["特效文字1"]==nil then
				WAR.Person[id]["特效文字1"]=word
			else
				WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=111
		end
		
		if WAR.DJHB3[pid]~=nil and WAR.DJHB7[pid]~=nil and WAR.ZYHB == 2 and  wglw(pid,77)>2 then --假剑
			local word=""
			local tmp=math.random(2) 
            if tmp == 1  then
					WAR.DZDJ2=1
					word="清风剑·螺旋" --生命越低增加伤害越高 最高300 杀气1000
					ng = ng + 500
					WAR.DJHB3[pid]=nil
				    WAR.DJHB7[pid]=nil --重置	
				else
					WAR.DZDJ2=2
					word="清风剑·化煞" --破防 杀气2000
					ng = ng + 2500
					WAR.DJHB3[pid]=nil
				    WAR.DJHB7[pid]=nil --重置						
				end				
			if WAR.Person[id]["特效文字1"]==nil then
				WAR.Person[id]["特效文字1"]=word
			else
				WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=113
		end
					
	
	else
		WAR.DJHB6[pid]=nil
		WAR.DJHB7[pid]=nil --重置
		WAR.DJHB3[pid]=nil
		

	end	
	
		if wglw(pid,44)>1 and wglw(pid,67)>1 and wglw(pid,44)+wglw(pid,67)>4 and math.random(10) < 5 and (wugong == 67 or wugong == 44) then----
				WAR.DJGZ = 2
				ng = ng + 2000
				if WAR.Person[id]["特效文字2"] ~= nil then
					WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."刀剑合一"
				else
					WAR.Person[id]["特效文字2"] = "天剑绝刀 本源合一"
				end
	end

		if wglw(pid,28)>2 and (wugong == 28) then----
				WAR.DZDJ1 = 1
				ng = ng + 2000
				if WAR.Person[id]["特效文字2"] ~= nil then
					WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."雷光笼罩"
				else
					WAR.Person[id]["特效文字2"] = "雷剑 雷光笼罩"
				end
	   end
	
		if  (wglw(pid,35)>2 or wglw(pid,61)>2) and PersonKFJ(pid,35) and PersonKFJ(pid,61) and WAR.DZXYLV[pid]==nil then --坎离水火剑
		if wugong == 35 then --剑法特效
		    local jilv=30
			if WAR.ACT==1 then
            WAR.DJHB4[pid]=1
			end
			jilv=jilv+math.modf(TrueYJ(pid)/10) --最大加24
			jilv=jilv+math.modf(JY.Person[pid]["受伤程度"]/10) --最大加10
			if JY.Person[pid]["生命"]<math.modf(JY.Person[pid]["生命最大值"]/3) then
				jilv=jilv+math.modf(JY.Person[pid]["生命"]/50) --最大加10
			end
			if jilv>=math.random(100) then
				local word="离火.残阳沥血剑"
				ng=ng+1700
				if WAR.Person[id]["特效文字1"]==nil then
					WAR.Person[id]["特效文字1"]=word
				else
					WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
				end	
				WAR.Person[id]["特效动画"]=16
				WAR.DJJIAN2=1 	
			end
		end
		
		if wugong == 61 then --刀法特效
			local jilv=30
			if WAR.ACT==1 then	
            WAR.DJHB5[pid]=1
			end
			jilv=jilv+math.modf(JY.Person[pid]["耍刀技巧"]/10) --最大加24
			jilv=jilv+math.modf(JY.Person[pid]["受伤程度"]/10) --最大加10
			if JY.Person[pid]["生命"]<math.modf(JY.Person[pid]["生命最大值"]/3) then
				jilv=jilv+math.modf(JY.Person[pid]["生命"]/50) --最大加10
			end
			if jilv>=math.random(100) then
				local word="坎水.冷月凝霜刀"
				ng=ng+1700
				if WAR.Person[id]["特效文字1"]==nil then
					WAR.Person[id]["特效文字1"]=word
				else
					WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
				end	
				WAR.Person[id]["特效动画"]=17
				WAR.DJDAO2=1 	
			end
		end	

		
		if WAR.DJHB4[pid]~=nil and WAR.DJHB5[pid]~=nil and WAR.ZYHB == 2 then --刀+剑
			local word=""
			if WAR.ATNum<3  then
			WAR.ATNum=3
			end
			WAR.DJSX2=1
			word="金乌映雪.坎离水火剑" 
			WAR.DJHB4[pid]=nil
		     WAR.DJHB5[pid]=nil --重置			
			if WAR.Person[id]["特效文字1"]==nil then
				WAR.Person[id]["特效文字1"]=word
			else
				WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=154
		end
		
				
		if WAR.ATNum >= 3  then
			WAR.WS = 1
			ng = ng + 1000
			for i = 1, 6 do
				for j = 1, 6 do
				  SetWarMap(x + i - 1, y + j - 1, 4, 1)
				  SetWarMap(x - i + 1, y + j - 1, 4, 1)
				  SetWarMap(x + i - 1, y - j + 1, 4, 1)
				  SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		end
	else
		WAR.DJHB4[pid]=nil
		WAR.DJHB5[pid]=nil --重置
		

	end
	
 	if (MPPB_GB(pid)==1 or MPPB_GB(pid)== 3) and WAR.GBLJ[pid] ~= nil  and WAR.ACT == 1 and kfkind == 5 and WAR.DZXY ~= 1 then
	   if WAR.GBLJ[pid] >= 1  then
	      local aa = 0
	      local bb = WAR.GBLJ[pid]
	      for i = 1, bb do
	          if JLSD(10,60,pid) then
	              aa = aa+1
	              reseteffect2(WAR.GBLJ, pid, 1)
	          end
	      end
	   	  WAR.ATNum = WAR.ATNum + aa
		  WAR.GBGF_LJ = aa
	   end
	end	

	if match_ID(pid,58) and WAR.GBLJ[pid] ~= nil  and WAR.ACT == 1 and kfkind == 3  and WAR.DZXY ~= 1 then
	   if WAR.GBLJ[pid] >= 1  then
	      local aa = 0
	      local bb = WAR.GBLJ[pid]
	      for i = 1, bb do
	          if JLSD(10,60,pid) then
	              aa = aa+1
	              reseteffect2(WAR.GBLJ, pid, 1)
	          end
	      end
	   	  WAR.ATNum = WAR.ATNum + aa
		  WAR.GBGF_LJ = aa
	   end
	end


    if  match_ID(pid,360) and YCDJ(pid)>0 and kfkind == 4 and WAR.DZXY~= 1 and WAR.GBLJ[pid] ~= nil then
		   if WAR.GBLJ[pid] >= 1  then
	      local aa = 0
	      local bb = WAR.GBLJ[pid]
	      for i = 1, bb do
	          if JLSD(10,60,pid) then
	              aa = aa+1
	              reseteffect2(WAR.GBLJ, pid, 1)
	          end
	      end
	   	  WAR.ATNum = WAR.ATNum + aa
		  WAR.GBGF_LJ = aa
	   end
	end
	
    if  wglw(pid,2)>=1 and wugong == 2 and WAR.DZXY~= 1 then
        local  aa = math.random(1,2)
		local xxzf = {"扶摇直上","鹏飞千里"}
		WAR.XYYZ = aa
		local str = "逍遥掌法."..xxzf[aa]
		if WAR.XYYZ == 1 then
		WAR.GTJIQI = WAR.GTJIQI + 200
		WAR.ZYHB = 1
		WAR.GTPID = pid
		end
		        if WAR.Person[id]["特效文字2"] ~= nil then
					WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" ..str
				else
					WAR.Person[id]["特效文字2"] = str
				end			
	end	



    if  ((wglw(pid,2)>2 and kfkind == 1) or (YCRW(pid) == 2 and YCDJ(pid)>2 and kfkind == 4 and JLSD(10,70,pid)) ) and WAR.DZXY~= 1 and WAR.ZBX[pid]~=nil then
        local  aa = math.random(1,8)
		local color = {C_GOLD,PinkRed,LightPurple,LightSkyBlue,OliveDrab,M_DeepSkyBlue,M_Red,M_DarkSlateBlue}
		local xxzf = {"吕洞宾.醉酒提壶力千钧","曹国舅.仙人敬酒锁喉扣","汉钟离.跌步抱提窝心顶","张果老.醉酒抛杯踢连环","韩湘子.擒腕擎胸醉吹箫","蓝采和.单提敬酒拦腰破","铁拐李.旋争膝撞醉还真","何仙姑.弹腰献酒醉荡步"}
		WAR.ZBXZ = aa
		local str = "醉八仙."..xxzf[aa]
		NEWTXWZ(str,color[aa])
        if WAR.ZBXZ ==7 then
        WAR.ZBXY = 1
         end
       if WAR.ZBXZ == 4 then
        WAR.BJ = 1
		WAR.CXLC3 = 1
         end	
       if WAR.ZBXZ == 8 then
          addeffect2(WAR.ZBX,pid,2)
       end	
       if JY.Person[pid]["饰品"] == 194 then

       end	   
	end	
	
	
    if WAR.NGJL>0 and MPZJ(pid,3)>=1 and math.random(10)<6 and kfkind == 3 and MPPB_SL(pid) == 1 then --沼跃鱼：罗汉堂杖法
	local SN=math.modf(JY.Person[pid]["内力"]/10)
	local SN2=MPDJ(pid)+4
	if JY.Person[pid]["武器"] == 50 then----沼跃鱼：伏魔杵
	SN2=SN2+2
	end
	if WAR.Person[id]["特效文字1"] ~= nil then
					WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."韦陀镇魂·怒目荡魔"
				else
					WAR.Person[id]["特效文字1"] = "韦陀镇魂·怒目荡魔"
				end		
			  WAR.Person[id]["特效动画"]=63
			  WAR.SHAOLIN2=1
			  ng = ng + SN
			  WAR.WS = 1
			  for i = 1, SN2 do
				for j = 1, SN2 do
				  SetWarMap(x + i - 1, y + j - 1, 4, 1)
				  SetWarMap(x - i + 1, y + j - 1, 4, 1)
				  SetWarMap(x + i - 1, y - j + 1, 4, 1)
				  SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		if MPZJ(pid,3)>=2 and math.random(10)<6 then
        WAR.CXLC2 = 1
		        if WAR.Person[id]["特效文字2"] ~= nil then
					WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."般若揭谛·心棍"
				else
					WAR.Person[id]["特效文字2"] = "般若揭谛·心棍"
				end	
				if WAR.BJ == 1 then
				AddPersonAttrib(pid, "生命", math.modf(SN*0.25));
				AddPersonAttrib(pid, "内力", SN);
				end
        end		
	end	
	
	if match_ID_awakened(pid, 154,1) and wugong == 54 and WAR.ZYHB == 2 then---骆冰鸳鸯连环刀
		local word=""
			 CurIDTXDH(WAR.CurID, 103, 1, "鸳鸯连环.运刀如风", PinkRed)
            WAR.ATNum = 2
			WAR.YYDAO = 1
			word="鸳鸯连环.运刀如风" 
			ng = ng + 500		
			if WAR.Person[id]["特效文字1"]==nil then
				WAR.Person[id]["特效文字1"]=word
			else
				WAR.Person[id]["特效文字1"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=87
		if WAR.ATNum>1 and wugong == 54 and WAR.ZYHB == 2 and WAR.ACT >= 2  then
			WAR.WS = 1
			ng = ng + 1000
			for i = 1, 6 do
				for j = 1, 6 do
				  SetWarMap(x + i - 1, y + j - 1, 4, 1)
				  SetWarMap(x - i + 1, y + j - 1, 4, 1)
				  SetWarMap(x + i - 1, y - j + 1, 4, 1)
				  SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		end
	end



	if wglw(pid,54)>1 and wugong == 54 and WAR.ZYHB < 2 then---鸳鸯连环刀
		local word=""
		local tt = {"花天.不精","花天.春水","花天.浮舟"}
			WAR.YYDAO_PK = math.random(1,3)
			word=tt[WAR.YYDAO_PK] 		
			if WAR.Person[id]["特效文字3"]==nil then
				WAR.Person[id]["特效文字3"]=word
			else
				WAR.Person[id]["特效文字3"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=87			
	end	
	
	if wglw(pid,54)>1 and wugong == 54 and WAR.ZYHB  == 2 then---鸳鸯连环刀
		local word=""
		local tt = {"狂骨.独乐","狂骨.岩流","狂骨.风竹"}
			WAR.YYDAO_HB = math.random(1,3)
			word=tt[WAR.YYDAO_HB] 		
			if WAR.Person[id]["特效文字3"]==nil then
				WAR.Person[id]["特效文字3"]=word
			else
				WAR.Person[id]["特效文字3"]=WAR.Person[id]["特效文字1"].."+"..word
			end	
			WAR.Person[id]["特效动画"]=87			
	end		
	
	--无酒不欢：紫霞剑气，气攻+1000
	if PersonKF(pid, 89) and kfkind == 3 then
	    local str="紫霞剑气"
		local times = 1
		if WAR.NGJL == 89 then
			times = 2
		end
		for i = 1, times do
			if JLSD(40, 65, pid) then
				if nglw(pid,89)>2 and WAR.ZXJQ[pid]~=nil and WAR.ZXJQ[pid]>=0 then --紫宵剑气
                   CurIDTXDH(WAR.CurID, 39, 1, "紫霞神功.紫宵剑气", LightPurple)
                WAR.ZXJY=math.random(5,15)
				if WAR.ZXJQ[pid]>WAR.ZXJY then
				WAR.ZXJQ[pid]=WAR.ZXJQ[pid]-WAR.ZXJY
				else 
				WAR.ZXJY=WAR.ZXJQ[pid]
				WAR.ZXJQ[pid]=0
				end
                WAR.ZXJY=WAR.ZXJY*((WAR.ZXXS[pid] or 0) + 1)
				ng=ng+100*WAR.ZXJY
				str="紫宵剑气"
	        end
				ng = ng + 1000
				if WAR.Person[id]["特效文字3"] ~= nil then
					WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" ..str
				else
					WAR.Person[id]["特效文字3"] = str
				end
				break;
			end
		end

	end
	
	--破尽天下，增加1000点气攻
	if WAR.PJTX >= 1 then
		ng = ng + 1000
	end

    if (WAR.TZQJ == 1 or WAR.TZQJ == 2) and wugong == 18 then----
	    ng = ng + 1000
	end

    if (WAR.TZQJ == 1 or WAR.TZQJ == 2) and yongnei(wugong) then----
	    ng = ng + 1000
		if WAR.Actup[pid] ~=nil then
		ng = ng * 2
		end
	end
	
	--装备鸳鸯刀，5级开始，夫妻追加500气攻
	if JY.Person[pid]["武器"] == 217 and wugong == 62 and JY.Thing[217]["装备等级"] >=5 then
		ng = ng + 500
	end
	if JY.Person[pid]["武器"] == 218 and wugong == 62 and JY.Thing[218]["装备等级"] >=5 then
		ng = ng + 500
	end
	
	--五岳剑法组合，50%几率额外气攻+1000，暴怒必发动
	if wugong >= 30 and wugong <= 34 and WuyueJF(pid) and (WAR.LQZ[pid] == 100 or JLSD(20, 70, pid))then
		ng = ng + 1000
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "气贯五岳·"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = "气贯五岳"
		end
	end
	
	--琴棋书画：棋盘招式，额外杀气
	if wugong == 72 and QinqiSH(pid) then
		ng = ng + 1200
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·棋高一着"
		else
			WAR.Person[id]["特效文字3"] = "棋高一着"
		end
		--50%几率触发再次追加杀气
		if JLSD(20, 70, pid) then
			ng = ng + 1000
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·星罗棋布"
			else
				WAR.Person[id]["特效文字1"] = "星罗棋布"
			end
		end
    end
	
	--沧溟刀法，30%几率，额外杀气，必定流血
	--刀主二次判定
	if wugong == 153 and (JLSD(30, 60, pid) or (pid == 0 and JY.Base["标准"] == 4 and JLSD(30,60,pid))) then
		WAR.CMDF = 1
		ng = ng + 1000
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·颠动沧溟"
		else
			WAR.Person[id]["特效文字1"] = "颠动沧溟"
		end
	end
		
	--龙象加力，气攻+1000
	if WAR.NGJL == 103  or (nglw(pid,103)>=1 and WAR.NGJL>0 and JLSD(10,40,pid) )then
		ng = ng + 1000
		local str = "龙象之力"
		if nglw(pid,103)>= 1 then
		local juzl = {"一","二","三","四","五","六","七","八","九","十","十一","十二"}
		WAR.LXZL = math.random(1,9+nglw(pid,103))
		if match_ID(pid, 39) then
		WAR.LXZL = math.random(5,9+nglw(pid,103))
	    end	
		str = juzl[WAR.LXZL].."龙之力"
		ng = ng + 100*WAR.LXZL

		   if WAR.BRZH2[pid] == 2 then
		   WAR.LXZL = 13
		   str ="智龙般若【实相】"
		   end
		    if WAR.LXZL>=8 or WAR.BRZH2[pid] == 3 then
		    WAR.GTSHAQI = WAR.GTSHAQI + 100
			WAR.GTPID2 = pid
			   if WAR.BRZH2[pid] == 3 then
			   WAR.GTJIQI = WAR.GTJIQI + math.modf(ng/10)
			   WAR.GTPID = pid
			   end
		    end
		end		
		if nglw(pid,103)> 1 then
		local lzpx = {".赤蟠咆哮",".碧螭咆哮",".金蛟咆哮",".苍龙咆哮"}
		WAR.LZPX = math.random(1,1+nglw(pid,103))
        local str1 = lzpx[WAR.LZPX]
		   if WAR.BRZH2[pid] == 1 then
		   WAR.LZPX = 5
		   str1 =".智龙般若【观照】"
		   end
		str = str..str1
		end
		
		if WAR.BRZH2[pid]~=nil then
		WAR.BRZH2[pid] = nil
		end
		
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" ..str
		else
			WAR.Person[id]["特效文字1"] = str
		end
	end
	
	--王重阳北斗七闪追加气攻1000点
	if match_ID(pid, 129) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0 then
		ng = ng + 1000
		local BDQS = {"天枢", "天璇", "天玑", "天权", "玉衡", "开阳", "摇光"}
		if WAR.BDQS==1 and match_ID_awakened(pid, 129,1) then----
		     WAR.WS = 1
        Cls()		  
		ShowScreen()
		zssdz(pid)
		lib.Delay(40)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "北斗终闪.重阳遗剑", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		end
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."北斗七闪·"..BDQS[WAR.BDQS]
		else
			WAR.Person[id]["特效文字2"] = "北斗七闪·"..BDQS[WAR.BDQS]
		end
	end

	if match_ID(pid,65,1) and  WAR.LMZL > 0 then
		ng = ng + 1000
		local BDQS = {"气剑六指.少泽","气剑六指.少冲","气剑六指.关冲","气剑六指.中冲","气剑六指.商阳","气剑六指.少商"}
		if WAR.LMZL==1 and match_ID_awakened(pid,65,1) then----
		     WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "六脉转龙.燃灯一阳", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		end
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" ..BDQS[WAR.LMZL]
		else
			WAR.Person[id]["特效文字2"] = BDQS[WAR.LMZL]
		end
	end	
	
	if wglw(pid,58)>1 and WAR.XLD[pid] ~= nil and WAR.XLEB > 0 and wugong == 58 then
		ng = ng + 1000
		WAR.XLDF = math.random(1,3)
		local BDQS = {".邪光斩", ".鬼印珠", ".魔破闪"}
		if WAR.XLDF == 1 then
		addeffect2(WAR.BDKY, pid, 2)
		WAR.JZTX = 179
		end
		if WAR.XLDF == 2 then
		WAR.XLBD = WAR.BDKY[pid] or 0
		WAR.BDKY[pid] = nil
		WAR.JZTX = 184
		end
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."修罗"..BDQS[WAR.XLDF]
		else
			WAR.Person[id]["特效文字2"] = "修罗"..BDQS[WAR.XLDF]
		end
		
	end	

	if wglw(pid,51)>=1 and WAR.LSDZ[pid] ~= nil and wugong == 51 then
		WAR.LSDF = WAR.LSDZ[pid]
		local BDQS = {"凶", "疯", "魔", "阴","幽", "煞"}
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."噬灵鬼斩·"..BDQS[WAR.LSDF]
		else
			WAR.Person[id]["特效文字2"] = "噬灵鬼斩·"..BDQS[WAR.LSDF]
		end
		WAR.Person[id]["特效动画"] = 74 + WAR.LSDF
		WAR.JZTX = 116+WAR.LSDF
	end	


	if match_ID_awakened(pid,90,1) and WAR.YSLS[pid] ~= nil and wugong == 51 then
		WAR.YSDF = WAR.YSLS[pid]
		if WAR.YSDF == 3 then
		WAR.GTSHAQI = WAR.GTSHAQI +100
		WAR.GTPID2 = pid
		end
		local BDQS = {"貂", "蛇", "枭", "猿"}
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."灵兽刀势·"..BDQS[WAR.YSDF]
		else
			WAR.Person[id]["特效文字1"] = "灵兽刀势·"..BDQS[WAR.YSDF]
		end
	end	
	
	if match_ID_awakened(pid,103,1) and WAR.JLL[pid] ~= nil and WAR.CHD > 0 and wugong == 66 then
		local aa=5-WAR.CHD
		ng = ng + 500*aa
		local BDQS = {"残火刀初式.一刀火葬", "残火刀次式.炎魔心障", "残火刀三式.极焱返寒", "残火刀终式.天地灰烬"}
		if WAR.CHD==1 then----
		     WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "残火刀终式.天地灰烬", M_DarkRed, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		end
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" ..BDQS[aa]
		else
			WAR.Person[id]["特效文字2"] = BDQS[aa]
		end
		WAR.Person[id]["特效动画"] = 154
		WAR.JZTX = 94+aa
	end	
	
	--七伤拳，机率造成内伤17点
	--谢逊必出
	if wugong == 23 and (match_ID(pid, 13) or JLSD(30-wglw(pid,23)*10, 60+wglw(pid,23)*10, pid)) then
		WAR.YZQS = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+一震七伤"
		else
			WAR.Person[id]["特效文字1"] = "一震七伤"
		end
	end
  
	if yongquan(wugong) and (match_ID_awakened(pid, 9,1) and JLSD(20, 70, pid)) then
		WAR.YZQS = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+明尊.七伤"
		else
			WAR.Person[id]["特效文字1"] = "明尊.七伤"
		end
	end
  
	if wglw(pid,25)>1 and WAR.ARZS==3 and WAR.ZYHB == 2 and wugong == 25 then
		WAR.YZQS1 = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+拖泥带水.戊土之重"
		else
			WAR.Person[id]["特效文字1"] = "拖泥带水.戊土之重"
		end
	end

	if wglw(pid,67)>2 and JY.Person[pid]["武器"] == 217 and WAR.ZYHB == 2  then
		WAR.WQQ = 1
	end

   if WAR.ZYHB ==  0  and (WAR.HDMC == 8  or WAR.HDMC2 == 8) then --胡刀双龙
      WAR.ZYHB = 1
	  WAR.JGHJ = 102
   end	
	
	
	
    --钟灵 使用闪电貂，可偷窃，朱聪妙手空空也可
    if (match_ID(pid, 90) and wugong == 113) or (match_ID(pid, 131) and wugong == 116) or (MPPD(pid) == 1 and JLSD(10,80,pid)) then
		WAR.TD = -2
		--蓝烟清：挑战战斗不可偷东西
		if WAR.ZDDH == 226 or WAR.ZDDH == 79 then
			WAR.TD = -1;
		end
    end
	
	--宋远桥使用太极拳或太极剑攻击后自动进入防御状态
	if match_ID(pid, 171) and (wugong == 16 or wugong == 46) then
		WAR.WDRX = 1
	end

	if PersonKF(pid, 180)  then
	    if (WAR.TSSX[pid] or 0) >= 100 then
		WAR.TSSX[pid] = nil
		   for j = 0, WAR.PersonNum - 1 do
		    	if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and RealJL(WAR.CurID, j, 5+nglw(pid,180)) then
				WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "中毒程度", 20)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			    end
		   end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."灵蛇玄奥·天蛇射息"
		else
			WAR.Person[id]["特效文字1"] = "灵蛇玄奥·天蛇射息"
		end
		end
		WAR.TSSX1 = WAR.TSSX1 + 1
	end

	    --沼跃鱼：张召重柔云剑法
  if wugong == 36 and WAR.NSTJ[pid]~=nil and WAR.NSTJ[pid]>0 and match_ID_awakened(pid,80,1) then
  	WAR.NSTJ1 = WAR.NSTJ[pid];
    if WAR.Person[id]["特效文字1"] ~= nil then
        WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+火手·太极奥义"
    else
        WAR.Person[id]["特效文字1"] = "火手·太极奥义"
    end
	WAR.Person[id]["特效动画"] = 116
	WAR.NSTJ[pid]=limitX((WAR.NSTJ[pid] or 0) + 5,0,100)
  end

  if wugong == 36 and wglw(pid,36)>=1 and WAR.DZXY ~= 1 then
  	WAR.MYJY = WAR.ACT;
	local str = "柔剑.云起"
	if math.random(1,10)<4+wglw(pid,36) then
	WAR.CXLC3 = 1
	end
	if WAR.ACT>=5 then
	str = "柔剑.云涌"
	elseif WAR.ACT>=3 then
	str = "柔剑.云幕"
	end
	if wglw(pid,36)>1 then
	WAR.MYZT[pid] = (WAR.MYZT[pid] or 0) +  wglw(pid,36)
	end
    if WAR.Person[id]["特效文字1"] ~= nil then
        WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+"..str
    else
        WAR.Person[id]["特效文字1"] = str
    end
	WAR.Person[id]["特效动画"] = 102
  end
	
    --桃花岛百花宫，第一次攻击，伤内力500，内力不足500追加伤害
    if (MPPB_THBH(pid)>=1 or match_ID(pid,57)) and (WAR.ACT == 1 or JLSD(10,50+MPDJ(pid)*10,pid) ) then
	    local dd = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				if JY.Person[WAR.Person[j]["人物编号"]]["内力"] > 500 then
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - 500
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - 500;
				else
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - JY.Person[WAR.Person[j]["人物编号"]]["内力"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = 0
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 100*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 100*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
				end
				if WAR.QMDJ[WAR.Person[j]["人物编号"]]~=nil and WAR.QMDJ[WAR.Person[j]["人物编号"]]> 0 then--
				local cc= WAR.QMDJ[WAR.Person[j]["人物编号"]]
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 100*cc*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
				WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 100*cc*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
				dd = dd + 1
				WAR.QMDJ[WAR.Person[j]["人物编号"]] = nil
				end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
		if match_ID_awakened(pid,57,1) then
		    for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					local kid = WAR.Person[j]["人物编号"];
					local tt =math.max(JY.Person[pid]["医疗能力"],500)
					local add = math.modf(tt/8*(1+dd)+ math.random(200));
					if add > tt/2*(1+dd) then	--最大为医疗值的一半
						add = tt/2*(1+dd) ;
					end				
					add = math.modf(add);		
					WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end		
			end  
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."魔音·碧海潮生曲"
		else
			WAR.Person[id]["特效文字1"] = "魔音·碧海潮生曲"
		end
		WAR.Person[id]["特效动画"] = 39
    end

				if nglw(pid,93)>=2 and WAR.ACT == 1 then
				        
						for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					           local kid = WAR.Person[j]["人物编号"];
                               local zzs = math.max(JY.Person[kid]["灼烧程度"] , 10)							   
					           local add = math.modf(zzs*1.25);		
					           WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", math.modf((add) / 5));
					           WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", -add);
				             WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				           end	
		                end
							if WAR.Person[id]["特效文字1"] ~= nil then
			                   WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."圣光气·普照"
		                   else
			                   WAR.Person[id]["特效文字1"] = "圣光气·普照"
		                   end
		                 WAR.Person[id]["特效动画"] = 39
				end	

				if WAR.GMYS1[pid]~=nil then
				        local aa = WAR.GMYS1[pid]
						for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and RealJL(WAR.CurID, j, 5) then
					           local kid = WAR.Person[j]["人物编号"];
                               local zzs = math.max(JY.Person[kid]["灼烧程度"] , 10)							   
					           local add = math.modf(zzs*(1+aa*0.2));		
					           AddPersonAttrib(kid, "灼烧程度", math.modf(zzs));
					           WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", -add);
				             WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				           end	
		                end
							if WAR.Person[id]["特效文字1"] ~= nil then
			                   WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."圣火印记·爆发"
		                   else
			                   WAR.Person[id]["特效文字1"] = "圣火印记·爆发"
		                   end
		                 WAR.Person[id]["特效动画"] = 39
				end	

				if nglw(pid,163)>2 and WAR.ACT == 1 then
						for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					           local kid = WAR.Person[j]["人物编号"];
                               local zzs = math.max((WAR.LXZT[kid] or 0) , 10)							   
					           local add = math.modf(zzs*1.25);		
					           WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", math.modf((add) / 5));
					           WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", -add);
							   WAR.Person[pid]["生命点数"] = (WAR.Person[id]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", add);
				             WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				           end	
		                end
							if WAR.Person[id]["特效文字1"] ~= nil then
			                   WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."血气·生命虹吸"
		                   else
			                   WAR.Person[id]["特效文字1"] = "血气·生命虹吸"
		                   end
		                 WAR.Person[id]["特效动画"] = 43
				end		
	
    if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid] == 3 and WAR.ACT == 1 then
	   local cxzy = JY.Person[pid]["灼烧程度"]
       if cxzy > 0 then
						for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					           local kid = WAR.Person[j]["人物编号"];
                               local zsz = JY.Person[kid]["灼烧程度"]							   
					           local add = math.modf((cxzy+zsz)*0.85);		
					           WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", math.modf((add) / 5));
					           WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", -add);
				             WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				           end	
		                end
						
						for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					           local kid = WAR.Person[j]["人物编号"];
                               local zsz = JY.Person[kid]["灼烧程度"]							   
					           local add = math.modf((cxzy+zsz)*1.25);		
					           WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", math.modf((add) / 5));
					           WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				             WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				           end	
		                end
						
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字1"] .. "+" .."残阳.如血化生"
		else
			WAR.Person[id]["特效文字0"] = "残阳.如血化生"
		end
		WAR.Person[id]["特效动画"] = 15
	   end
    end	

    if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid] == 2 and WAR.ACT == 1 then
	   local cxzy = JY.Person[pid]["中毒程度"]  
       if cxzy > 0 then
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +AddPersonAttrib(pid, "生命", cxzy *3);
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+" .."纯阳.滋毒养生"
		else
			WAR.Person[id]["特效文字0"] = "纯阳.滋毒养生"
		end
		WAR.Person[id]["特效动画"] = 39
	   end
    end


  if WAR.SXBB[pid]~= nil and WAR.SXBB[pid] >= 9 and WAR.ACT == 1 then
     WAR.SXBB[pid] = nil
	 WAR.SXJZ = 1
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+" .."秘步.神行九转"
		else
			WAR.Person[id]["特效文字0"] = "秘步.神行九转"
		end
		WAR.Person[id]["特效动画"] = 42
  end

  if qglw(pid,150)>=2 and Curr_QG(pid,150) and WAR.ACT == 1 then
     WAR.YTMX = WAR.XKZ
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."秘步.牙突猛袭"
		else
			WAR.Person[id]["特效文字1"] = "秘步.牙突猛袭"
		end
		WAR.Person[id]["特效动画"] = 52
  end

    if WAR.LYLZ2[pid]~=nil and WAR.LYLZ2[pid] == 5 and WAR.ACT == 1 then
	   local cxzy = JY.Person[pid]["受伤程度"]  
       if cxzy > 0 then
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +AddPersonAttrib(pid, "内力", cxzy *15);
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+" .."元阴.化瘀养魂"
		else
			WAR.Person[id]["特效文字0"] = "元阴.化瘀养魂"
		end
		WAR.Person[id]["特效动画"] = 53
	   end
    end
	
    if (MPPB_WD(pid) == 1 or MPPB_WD(pid) == 3) and WAR.ACT == 1 then
	   local cxzy = WAR.CYZY[pid] or 0
       if cxzy > 0 then
	   WAR.GTJIQI = cxzy *100
	   WAR.GTPID = pid
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +AddPersonAttrib(pid, "生命", cxzy *50);
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +AddPersonAttrib(pid, "内力", cxzy *150);
	   if  MPZJ(pid,2)>1  then
	       if cxzy >1 then
		   WAR.CYZY[pid] = math.modf(cxzy*0.5) 
		      if math.random(1,10)<=3 and MPZJ(pid,2)>2 then
			  WAR.CYZY[pid] = WAR.CYZY[pid] * 2
			  end
		   else
		    WAR.CYZY[pid] = nil
		   end
	   else
	   WAR.CYZY[pid] = nil
	   end
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+" .."纯阳.万物相长"
		else
			WAR.Person[id]["特效文字0"] = "纯阳.万物相长"
		end
		WAR.Person[id]["特效动画"] = 39
	   end
    end		
	
	 if nglw(pid, 100)>1 and WAR.ACT == 1 and PersonKF(pid,100) and JLSD(0,50,pid)then
			   local XK = nil
				local NK = nil
				local NS = nil
				local mpdj=0.15
				if Curr_NG(pid, 100) then
				mpdj=0.25
				end
	            XK = 1000 * mpdj
				NK = XK*3
				NS = 5 + math.modf(JY.Person[pid]["受伤程度"]/10)
				AddPersonAttrib(pid, "生命", XK);
				AddPersonAttrib(pid, "内力", NK);
				AddPersonAttrib(pid, "受伤程度", -NS);
							if match_ID_awakened(pid,65,1) and math.random(10) < 9 and WAR.LMZL == 0 then--
			CurIDTXDH(WAR.CurID, 35,1,"龙脉代谢.六气合一",M_Yellow)
			WAR.LMZL = 1
			end
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+" .."先天真气调息"
		else
			WAR.Person[id]["特效文字0"] = "先天真气调息"
		end
		WAR.Person[id]["特效动画"] = 143
    end
	
    --玉箫二阶：天魔曲
    if PersonKFJ(pid, 38) and wglw(pid,38)>2  then
	    local mpdj2 = math.modf(TrueYJ(pid)/40)
		local jl = 20 + mpdj2* 10
	   if (WAR.ACT==1) or (WAR.ACT>1 and JLSD(10,jl,pid)) then
       for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
		   local tid = WAR.Person[j]["人物编号"]
		   local tl= math.modf(JY.Person[tid]["内力"]/2)
		   if JY.Person[pid]["内力"]-tl>0 then
		   tl=JY.Person[pid]["内力"]-tl
		   else
		   tl=0
		   end
		   local kl = mpdj2*100+math.modf (tl/5)
		   if TaohuaJJ(pid) then
		     kl=kl+200
		   end  
		   kl=math.modf(kl/30)
		   AddPersonAttrib(tid, "受伤程度", kl)
		  WAR.MENG[tid] = limitX((WAR.MENG[tid] or 0) + kl, 0, 50)
		  if math.random(10)<4 then
		  WAR.CSZT[tid]=1
		  end
		  WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
        end
      end
            for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] == true and WAR.Person[j]["死亡"] == false then
					local kid = WAR.Person[j]["人物编号"];
					local add = JY.Person[pid]["医疗能力"]/4 + JY.Person[pid]["医疗能力"]*jl/160 + math.random(30);
					if add > JY.Person[pid]["医疗能力"]/2 then	--最大为医疗值的一半
						add = JY.Person[pid]["医疗能力"]/2 ;
					end				
					add = math.modf(add);		
					WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end		
			end  
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."天魔曲·无间轮回"
		else
			WAR.Person[id]["特效文字1"] = "天魔曲·无间轮回"
		end
		WAR.Person[id]["特效动画"] = 39
		end
    end	
	
     if match_ID_awakened(pid, 47,1) then--阿紫全屏苦痛
	  local jl = 20
	   jl = jl + math.modf(JY.Person[pid]["用毒能力"]/10)
	  if WAR.ACT==1 or JLSD(10,jl,pid) then
      for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
		   local tid = WAR.Person[j]["人物编号"]
		   local tl= math.modf(JY.Person[tid]["受伤程度"]+JY.Person[tid]["中毒程度"]+JY.Person[tid]["灼烧程度"]+JY.Person[tid]["冰封程度"])
		   if tl>200 then--
		   tl = 200
		   end
		   WAR.AZ=WAR.AZ+tl
		   if WAR.AZ>=300 then
		   WAR.AZ = 300
		   end
		   local kl = -(100+math.modf ((JY.Person[pid]["用毒能力"]/800)*tl))
		   JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] +kl*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
		   WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + kl*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
		   WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
        end
      end
	  	if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."紧那罗.苦痛颂歌"
		else
			WAR.Person[id]["特效文字1"] = "紧那罗.苦痛颂歌"
		end
		WAR.Person[id]["特效动画"] = 43
	  end
	  end	
	
if  match_ID(pid,4) and WAR.ACT==1 and (JLSD(10,50+math.modf(JY.Person[pid]["用毒能力"]/10),pid) or JY.Person[4]["论剑奖励"] == 1) then
    local str=""
    local aa=math.modf(JY.Person[pid]["用毒能力"]/100)
	if JY.Person[4]["论剑奖励"] == 1 then
	aa=aa+math.modf(JY.Person[pid]["医疗能力"]/100)
	end
     for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["人物编号"]~= pid then
					local tmppid = WAR.Person[j]["人物编号"]
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] +30*(aa+1)*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + 30*(aa+1)*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"];
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] +100*(aa+1)
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) +100*(aa+1);
					AddPersonAttrib(tmppid, "受伤程度", -math.random(10-aa, 10+aa))
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
	 end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."千金毒方·化毒疗伤"
		else
			WAR.Person[id]["特效文字1"] = "千金毒方·化毒疗伤"
		end
		WAR.Person[id]["特效动画"] = 43 
  end	

 	if MPPB_SL(pid) == 3 and  JY.Wugong[wugong]["武功类型"] == 1 and (WAR.NGJL>0 or JLSD(10,40+MPDJ(pid)*10,pid)) then--
	   WAR.KBGJ2[pid] = (WAR.KBGJ2[pid] or 0) + 5*MPDJ(pid)
	end

	if nglw(pid,166)>1 and Curr_NG(pid,166) and WAR.NGJL>0 then--
	   WAR.BHJS[pid] = (WAR.BHJS[pid] or 0) + 10*nglw(pid,166)
	end

    if nglw(pid,106)>2 and WAR.JYHT[pid] == nil  then
       WAR.JYWR_CF = 1
	   WAR.JYHT[pid] = (WAR.JYHT[pid] or 0) + 2
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."九阳奥义·阳罡外放"
		else
			WAR.Person[id]["特效文字1"] = "九阳奥义·阳罡外放"
		end
		WAR.Person[id]["特效动画"] = 34 
    end	
	
	if WAR.JYWR_CF == 1  then
	local aa = math.random(1,6)
	   if aa == 1 or kfkind == 3 then
	   WAR.JYWR_CF = 2
	   WAR.Person[id]["特效文字4"] = "残阳.血色轩辕"
	   elseif aa == 2 or kfkind == 2 then
	   WAR.JYWR_CF = 3
	   WAR.Person[id]["特效文字4"] = "中阳.气脉蓬勃"
	   elseif aa == 3 or kfkind == 6  then
	   WAR.JYWR_CF = 4	   
	   WAR.Person[id]["特效文字4"] = "阳明.万物天生"
	   end	
	end


-----天罡气劲的正面buff
	if WAR.TZQJ == 10 and  JY.Wugong[wugong]["武功类型"] == 6  then----无相弹指气劲
        WAR.HIDE2[pid] = 30
	end


-----弹指气劲的正面buff
    if WAR.TZQJ == 9 and wugong == 18 then----乾坤弹指气劲
        WAR.MZLL[pid] = 50
	end
	
	if WAR.TZQJ == 10 and wugong == 18  then----无相弹指气劲
        WAR.HIDE[pid] = 30
	end
	
	if WAR.TZQJ == 11 and (wugong == 18 or yongnei(wugong) ) then----纯阳弹指气劲
        WAR.LLH = WAR.LLH+math.random(3,6)*50
		 if WAR.LLH>=300 then
		 WAR.LLH=300
		 end
	end

	
	if WAR.TZQJ == 14 and (wugong == 18 or yongnei(wugong) ) then--太玄弹指气劲
      WAR.LUCK[pid] =  20
	end

	if WAR.TZQJ == 18 and (wugong == 18 or yongnei(wugong) )  then----九阳弹指气劲
		WAR.JYHT[pid] = limitX((WAR.JYHT[pid] or 0) + 2,0,5*(1+nglw(pid,106)))
	end
	

	
	if WAR.TZQJ == 21 and (wugong == 18 or yongnei(wugong) ) then----逆运弹指气劲
        addeffect2(WAR.DR, pid, 1)
        addeffect2(WAR.SATA, pid, 5)
	end
	
	if WAR.TZQJ == 23 and (wugong == 18 or yongnei(wugong) ) then----逆运弹指气劲
       WAR.KBGJ[pid] = 30
	end
	


	if WAR.TZQJ == 26 and (wugong == 18 or yongnei(wugong) )  then----逆运弹指气劲
       WAR.KBGJ2[pid] = 30
	end

  if nglw(pid,108)>2 and Curr_NG(pid, 108) then --沼跃鱼：达摩院全屏
	local jl = 50
	jl = jl + JY.Base["天书数量"] + math.modf(JY.Person[pid]["实战"]/50)

	if WAR.ACT==1 or (WAR.ACT>1 and JLSD(10,jl,pid)) then
	 		for i = 1, 30 do
			DrawStrBox(-1, 24, "天舞宝轮.六道轮回", LightGreen, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
        if nglw(pid,108)>3 then
		    for i = 1, 30 do
			    DrawStrBox(-1, 25, "天舞宝轮.普度众生", LightGreen, 10 + i)
			    ShowScreen()
			    lib.Delay(10)
		    end
		for i = 0, WAR.PersonNum - 1 do
               if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false then
					local kid = WAR.Person[i]["人物编号"];
					local add = JY.Person[pid]["医疗能力"]/4 + JY.Person[pid]["医疗能力"]*jl/160 + math.random(30);
					if add > JY.Person[pid]["医疗能力"]/2 then	--最大为医疗值的一半
						add = JY.Person[pid]["医疗能力"]/2 ;
					end				
					add = math.modf(add);		
					WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
				end	
		end
        end  		
	if PersonKF(pid, 96) then----
	    WAR.FMY=1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."伏魔印"
		else
			WAR.Person[id]["特效文字1"] = "伏魔印"
		end
		WAR.Person[id]["特效动画"] = 48 
	elseif PersonKF(pid, 92) then
	
		local aa=JY.Base["天书数量"] + math.modf(JY.Person[pid]["实战"]/50)
		local cc=math.modf(aa*10)
		for j = 0, WAR.PersonNum -1 do
		  if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
			local tid = WAR.Person[j]["人物编号"]
			WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + cc
		  end
		end		
		WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", cc);
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."外狮子印"
		else
			WAR.Person[id]["特效文字1"] = "外狮子印"
		end
		WAR.Person[id]["特效动画"] = 47 
		WAR.WS = 1
    end
	end
	
	end
  
  if wglw(pid,40)>2 and JLSD(10,50,pid) and PersonKFJ(pid,40) and wugong ==  40 then
    local aa=math.modf(JY.Person[pid]["用毒能力"]/100)
 		for i = 1, 30 do
			DrawStrBox(-1, 24, "金蛇戏画.狂蛇噬天", LightGreen, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	WAR.JSKW = 1
    ng = ng + 1000
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."金蛇戏画.狂蛇噬天"
		else
			WAR.Person[id]["特效文字1"] = "金蛇戏画.狂蛇噬天"
		end	
	    WAR.Person[id]["特效动画"] = 112
  end

   	if nglw(pid,88)>2 and WAR.XXQG[pid]~=nil and WAR.XXQG[pid]>=0 then --日月捧月派气攻加成
       CurIDTXDH(WAR.CurID, 35, 1, "群星捧月·星河倒泄", M_Red)
	   local aa=10
	   if Curr_NG(pid, 88) then
	   aa=aa+10
	   end
	   ng=ng+WAR.XXQG[pid]*aa
	   WAR.XXPG=aa
	   if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."星河倒泄"
		else
			WAR.Person[id]["特效文字1"] = "星河倒泄"
	   end	
       WAR.Person[id]["特效动画"] = 75	  
	end
  
	--何铁手五毒随机2-5倍威力
	if match_ID(pid, 83) and wugong == 3 then
		WAR.HTS = math.random(2, 5)
    end
	
    --飞飞 无误伤
    if match_ID(pid, 92) then
		WAR.WS = 1
    end
	
    --欧阳锋 无误伤
    if match_ID(pid, 60) then
		WAR.WS = 1
    end
    
    --东方不败 无误伤
    if match_ID(pid, 27) then
		WAR.WS = 1
    end
	
	--扫地 无误伤
    if match_ID(pid, 114) then
		WAR.WS = 1
    end
    
    --乔峰，郭靖，洪七公，使用降龙十八掌 无误伤
    if (match_ID(pid, 50) or match_ID(pid, 55) or match_ID(pid, 69)) and wugong == 26 then
		WAR.WS = 1
    end
    
    --令狐冲 二觉之后，使用独孤九剑 无误伤
    if match_ID_awakened(pid, 35, 2) and wugong == 47 then
		WAR.WS = 1
    end
	
	--玉女素心剑 无误伤
	if wugong == 139 then
		WAR.WS = 1
	end
    
    --金轮法王 气攻+2000
    if match_ID(pid, 62) then
		ng = ng + 2000
    end
    
    --霍都 气攻+1000
    if match_ID(pid, 84) then
		ng = ng + 1000
    end
    
    --花铁干，使用中平枪法，杀集气+1000
    if match_ID(pid, 52) and wugong == 70 then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."中平神枪"
		else
			WAR.Person[id]["特效文字3"] = "中平神枪"
		end
		ng = ng + 1500
    end
    
    --蓝凤凰，攻击伤害提高10%
    if match_ID(pid, 25) then
		WAR.TFH = 1
    end
  
    if WAR.SHAH[pid]~=nil and wglw(pid,78)>=1 and wugong == 78 then
	   local str = "聚沙术.沙之榨取"
	   if WAR.SHAH[pid] >= 500 then
	   WAR.YKX = 1
	   end
	   if WAR.YKX>0 then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" ..str
		else
			WAR.Person[id]["特效文字1"] = str
		end
	   end	
	end

   if WAR.SHAH[pid]~=nil and wglw(pid,78)>=2 and wugong == 78 then
	   local str = "【聚沙成兵】"
	   if WAR.SHAH[pid] >= 2000 then
	   WAR.YKX1 = math.random(1,4)
	   local WZTS = {"巨剑","石锤","沙矛","毒刃"}
	   str = str..WZTS[WAR.YKX1]
	   local xh = math.modf((WAR.SHAH[pid] or 0)/2)
	   WAR.SHAH[pid]= WAR.SHAH[pid] - xh
	   ng = ng + xh
	   end
	   if WAR.YKX1>0 then
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" ..str
		else
			WAR.Person[id]["特效文字2"] = str
		end
		if WAR.YKX1 == 1 then
		WAR.WS = 1
		for i = 1, 5+wglw(pid,78)*2 do
			for j = 1, 5+wglw(pid,78)*2 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
        WAR.ZJZC = 1
		
		end
	   end	
	end

    --霍青桐，使用三分剑法，伤体力
    if match_ID(pid, 74) and wugong == 29 then
		WAR.HQT = 1
    end
    
    --程英，使用玉箫剑法，杀内力300
    if match_ID(pid, 63) and wugong == 38 then
		WAR.CY = 1
		if match_ID(pid, 63,1)then
		if WAR.Person[id]["特效动画"] == nil then
			WAR.Person[id]["特效动画"] = 49
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."百花魔音.断魂"
		else
			WAR.Person[id]["特效文字1"] = "百花魔音.断魂"
		end
		end
    end



	if wglw(pid, 44)>=1 and wugong == 44 then
		WAR.FHJ= 1
    end
	
    --杨过 攻击，非吼 全体集气减100
    if match_ID(pid, 58) and WAR.XK ~= 2 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
			end
		end
		if WAR.Person[id]["特效动画"] == nil then
			WAR.Person[id]["特效动画"] = 89
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."西狂之怒啸"
		else
			WAR.Person[id]["特效文字1"] = "西狂之怒啸"
		end
    end
      
    --杨过吼
    if WAR.XK == 2 and match_ID(pid, 58) and WAR.Person[WAR.CurID]["我方"] == WAR.XK2 then
		for e = 0, WAR.PersonNum - 1 do
			if WAR.Person[e]["死亡"] == false and WAR.Person[e]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[e].TimeAdd = WAR.Person[e].TimeAdd - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
				if WAR.Person[e].Time < -450 then
					WAR.Person[e].Time = -450
				end
				JY.Person[WAR.Person[e]["人物编号"]]["内力"] = JY.Person[WAR.Person[e]["人物编号"]]["内力"] - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
				if JY.Person[WAR.Person[e]["人物编号"]]["内力"] < 0 then
					JY.Person[WAR.Person[e]["人物编号"]]["内力"] = 0
				end
				JY.Person[WAR.Person[e]["人物编号"]]["生命"] = JY.Person[WAR.Person[e]["人物编号"]]["生命"] - math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 25)
			end
			if JY.Person[WAR.Person[e]["人物编号"]]["生命"] < 0 then
				JY.Person[WAR.Person[e]["人物编号"]]["生命"] = 0
			end
		end
			
		--吼过之后，内力为0，内力最大值-1000，并且用声望控制上限
		if inteam(pid) then
			JY.Person[pid]["内力"] = 0
			JY.Person[pid]["内力最大值"] = JY.Person[pid]["内力最大值"] - 1000
			JY.Person[300]["声望"] = JY.Person[300]["声望"] + 1
		else
			AddPersonAttrib(pid, "内力", -1000)  --做敌方内力只减1000
		end
		  
		if JY.Person[pid]["内力最大值"] < 500 then
			JY.Person[pid]["内力最大值"] = 500
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."西狂之震怒·雷霆狂啸"   --西狂之震怒·雷霆狂啸
		else
			WAR.Person[id]["特效文字1"] = "西狂之震怒·雷霆狂啸"   --西狂之震怒·雷霆狂啸
		end
		WAR.Person[id]["特效动画"] = 6
		WAR.XK = 3
	end    
      
    --任盈盈，使用持瑶琴
    if match_ID(pid, 73) and wugong == 73 then
		if math.random(10) < 7 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."七弦无琴剑气"
			else
				WAR.Person[id]["特效文字3"] = "七弦无琴剑气"
			end
			WAR.Person[id]["特效动画"] = 89
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 50*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end
		else
			--唱歌时，与令狐冲回复体力100，并回复内伤
			if math.random(10) < 7 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 35 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
						JY.Person[WAR.Person[j]["人物编号"]]["体力"] = 100
						JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["体力"] = 100
						JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] = 0
						JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["受伤程度"] = 0
						if WAR.Person[id]["特效文字3"] ~= nil then
							WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."剑胆琴心 笑傲江湖"
						else
							WAR.Person[id]["特效文字3"] = "剑胆琴心 笑傲江湖"
						end
						WAR.Person[id]["特效动画"] = 89
					end
				end
			end
		end
	end
	
	--七夕任盈盈加强版效果
    if match_ID(pid, 611) and wugong == 73 then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."魔音搜魂"
		else
			WAR.Person[id]["特效文字3"] = "魔音搜魂"
		end
		WAR.Person[id]["特效动画"] = 89
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 100*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
	end

	
	
    if match_ID(pid, 449) then
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."漫天花雨.洒金钱"
		else
			WAR.Person[id]["特效文字2"] = "漫天花雨洒金钱"
		end
		WAR.Person[id]["特效动画"] = 77
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 100*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
	end
	
    --张三丰 万法自然，集气从500开始
    if match_ID(pid, 5) and math.random(10) < 8 then
		WAR.ZSF = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+" .."万法自然"
		else
			WAR.Person[id]["特效文字1"] ="万法自然"
		end
    end
	
    --虚竹  福泽加护，集气从200开始
    if match_ID(pid, 49) and math.random(10) < 7 then
		WAR.XZZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."福泽加护"
		else
			WAR.Person[id]["特效文字1"] = "福泽加护"
		end
    end


	
	--狂风快剑
    if wglw(pid, 162)>=1 and kfkind == 3 then
	    local str="狂风快剑"
		WAR.KFKJ = 1
		if wglw(pid,162)>1  then
		WAR.KFKJ2 = math.random(1,4)
		local KFKJ = {".疾风", ".烈风", ".暴风", ".飓风"}
		str= str..KFKJ[WAR.KFKJ2]
		end
		if WAR.KFKJ2 == 1 then----
		WAR.KFKJ = 2
		addeffect2(WAR.SATA, pid, 3)
		   if PersonKFJ(pid,31) then
		   str= str.."卷劲草"
		   WAR.L_HQNZL[pid]=30
		   addeffect2(WAR.SATA, pid, 3)
		   end
		end
		if WAR.KFKJ2 == 2 then----
		ng=ng+1500
		   if PersonKFJ(pid,32) then
		   str= str.."点松明"
		   WAR.KFKJ2 = 22
		   end
		end
		if WAR.KFKJ2 == 3 then----
		WAR.CXLC = 1
		WAR.BJ = 1
		   if PersonKFJ(pid,34) then
		   str= str.."镂鎏金"
		   WAR.KFKJ2 = 33
		   end
		end
		if WAR.KFKJ2 == 4 then----
				for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8+wglw(pid,162) and offset2 <= 8+wglw(pid,162) then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		   end
		   if PersonKFJ(pid,30) then
		   str= str.."吹暮雪"
		   WAR.KFKJ2 = 44
		   end
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .."+"..str
		else
			WAR.Person[id]["特效文字3"] = str
		end
    end

	--狂风快剑
    if D3FQY(pid) and kfkind == 3 then
	    local str="清风剑诀"
		WAR.KFKJ2 = math.random(1,4)
		local KFKJ = {".疾风卷劲草", ".烈风点松明", ".暴风镂鎏金", ".飓风吹暮雪"}
		str= str..KFKJ[WAR.KFKJ2]
		if WAR.KFKJ2 == 1 then----
		addeffect2(WAR.SATA, pid, 3)
		WAR.L_HQNZL[pid]=30
		WAR.GTJIQI = WAR.GTJIQI + 200
		WAR.GTPID = pid
		end
		if WAR.KFKJ2 == 2 then----
		ng=ng+1500
        WAR.KFKJ2 = 22
		end
		if WAR.KFKJ2 == 3 then----
		WAR.CXLC = 1
		WAR.BJ = 1
        WAR.KFKJ2 = 33
		end
		if WAR.KFKJ2 == 4 then----
				for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8+wglw(pid,162) and offset2 <= 8+wglw(pid,162) then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		   end
        WAR.KFKJ2 = 44
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .."+"..str
		else
			WAR.Person[id]["特效文字3"] = str
		end
    end
	
	--九剑真传，荡剑式，攻击后回气+200
	if WAR.JJZC == 4 and (pid == 0 or D3FQY(pid)) then
		WAR.JJDJ = 1
	end
    
    --东方不败  葵花点穴手，气攻+1000
    if match_ID(pid, 27) and math.random(10) < 7 then
		ng = ng + 1000
		WAR.BFX = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."葵花点穴手"
		else
			WAR.Person[id]["特效文字3"] = "葵花点穴手"
		end
    end
    
	
    --程灵素 攻击全屏中毒+20
    if match_ID(pid, 2) then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "中毒程度", 20)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."七心海棠"
		else
			WAR.Person[id]["特效文字1"] = "七心海棠"
		end
		WAR.Person[id]["特效动画"] = 64
    end
      
    --鸠摩智  使用火焰刀法，加内伤30，加杀集气1000
    --普通角色使用有30%的机率
	--刀主二次判定
    if wugong == 66 and level == 11 and (match_ID(pid, 103) or JLSD(30,60+wglw(pid,66)*20,pid) or (pid == 0 and JY.Base["标准"] == 4 and JLSD(30,60,pid)) or (wglw(pid,66)>=1 and JuHuoLY(pid)) )  then
	    local ns=0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", 30)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				ns=ns+30
			end
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."大轮密宗·火焰刀"
		else
			WAR.Person[id]["特效文字1"] = "大轮密宗·火焰刀"
		end
		WAR.Person[id]["特效动画"] = 58
		ng = ng + 1000
		if match_ID_awakened(pid, 103,1) then
		WAR.LLH=WAR.LLH+ns
		end
    end
	
    --游坦之暴风雪
   if (match_ID_awakened(pid, 48,1)  and JLSD(10, 60, pid) ) and wugong == 120 then
      local ns=20
	  local str="摩呼罗迦.冰蚕天罗"
	  for j = 0, WAR.PersonNum - 1 do
        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
          local tmppid = WAR.Person[j]["人物编号"]
		  JY.Person[tmppid]["冰封程度"]=(JY.Person[tmppid]["冰封程度"] or 0) + ns
		  WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
		  WAR.BFXS[WAR.Person[j]["人物编号"]] = 1
		  if JY.Person[tmppid]["冰封程度"]>= 50 then
		  JY.Person[tmppid]["冰封程度"] = 50
		  end
        end
      end
	  ng = ng + 50*ns
      if WAR.Person[id]["特效文字1"] ~= nil then
      	WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+".."摩呼罗迦.冰蚕天罗"  
      else
      	WAR.Person[id]["特效文字1"] = "摩呼罗迦.冰蚕天罗"  
      end
      WAR.Person[id]["特效动画"] = 48
    end
	
	--罗汉伏魔加力文字特效
	if WAR.NGJL == 96 then
	local str1="罗汉伏魔"
	local str=""
	if nglw(pid,96)>2 and JLSD(10,50,pid) then
	WAR.TMXZ = 1
	str="奥义.天魔下坠"
	end
	if nglw(pid,96)>1 then
	if JY.Person[pid]["资质"] < 50 then
	   WAR.LHT= math.random(6, 10)
	   elseif JY.Person[pid]["资质"] >= 50 then
	   WAR.LHT= math.random(1, 5)
	end
	str1="卍魔降伏"
	end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+"..str1..str;
		else
			WAR.Person[id]["特效文字1"] = str1..str
		end
	end
 
 	if WAR.NGJL == 96 then
	   if nglw(pid,96)>2  then
	      WAR.FM_XLD = 1
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字1"] .. "+".."伏魔.星落打";
		else
			WAR.Person[id]["特效文字0"] = "伏魔.星落打"
		end
	   end
	end
 
    --血刀吸血10%
	if JY.Person[pid]["武器"] == 44 or wglw(pid,63)>=1 or MPPB_MZ(pid) == 3 then
		WAR.XDDF = 1
    end
    
    --太极拳，借力打力
    if wugong == 16 then
		if WAR.tmp[3000 + pid] == nil then
			WAR.tmp[3000 + pid] = 0
		elseif 0 < WAR.tmp[3000 + pid] then
		    local str = "借力打力"
		    if wglw(pid,16)>1 then
			local tjj = {"崩劲【搬拦捶】","震劲【撇身捶】","巽劲【单鞭】"}
			WAR.L_TJQ = math.random(1,wglw(pid,16))
			str = str.. tjj[WAR.L_TJQ]
			end
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."·".. str
			else
				WAR.Person[id]["特效文字3"] = str
			end
			ng = ng + WAR.tmp[3000 + pid]
		end
    end


    --南山刀法单刀破枪，天外下增加机率
    if wugong == 53 and (JLSD(20, 50+wglw(pid,53)*15,pid) ) then
    	WAR.L_NSDFCC = 1;
		local str= "单刀.破枪式"
		if wglw(pid,53)>=2 then
		WAR.L_NSDFCC = 2
		str= "【真】单刀.直入"
		end
    	if WAR.Person[id]["特效文字3"] ~= nil then
  			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·"..str
  		else
    		WAR.Person[id]["特效文字3"] = str
    	end
    end


	  	  --蓝烟清：五岳剑派
		if MPPD(pid) == 6 then		--必出
		local aa= 0
		   if  wugong == 30 or wugong == 31 or wugong == 32 or wugong == 33 or wugong == 34   then
		   aa = 1
		   end
		   if MPPB_WYJZ(pid) == 1  and kfkind  == 3 then
		   aa = 1
		   end
		   if YCRW(id) == 2 and kfkind  == 4 then
		   aa = 1
		   end
		   
		if aa == 1 then
		  local mpdj = MPDJ(pid)
		  if math.random(10) <= (2+mpdj) then
		    WAR.L_WYJFA1=1
			if MPPB_WYJZ(pid) == 1 then
			WAR.L_WYJFA1=2
			end
		  end
		  if math.random(10) <= (2+mpdj) then
		    WAR.L_WYJFA2=1
			if MPPB_WYJZ(pid) >= 1 then
			WAR.L_WYJFA2=2
			end
		  end
		  if math.random(10) <= (2+mpdj) then
		    WAR.L_WYJFA3=1
			if MPPB_WYJZ(pid) >= 1 then
			WAR.L_WYJFA3=2
			end
		  end
		  if math.random(10) <= (2+mpdj) then
		    WAR.L_WYJFA4=1
		    if MPPB_WYJZ(pid) >= 1 then
			WAR.L_WYJFA4=2
			end
		  end
		  if math.random(10) <= (2+mpdj) then
		    WAR.L_WYJFA5=1
			if MPPB_WYJZ(pid) >= 1 then
			WAR.L_WYJFA5=2
			end
		  end
		 end
		end

if MPPD(pid) == 6 and ((wugong == 30 or wugong == 31 or wugong == 32 or wugong == 33 or wugong == 34 or (MPPB_WYJZ(pid) == 1  and kfkind  == 3)) or (YCRW(id) == 2 and kfkind  == 4) ) and MPDJ(pid) > 1 then   	
    	local n = 6;
    	local tn = 1500;
		local mpdj = MPDJ(pid)
    	if WAR.NGJL == 89 then		--紫霞加力剑法增加范围
    		n = 8;
    		tn = tn + 500;
    	end
		if (math.random(10) <= (2+mpdj) and (MPPB_WYQZ(pid) == 1 or (YCRW(id) == 2 and kfkind  == 4))) or WAR.L_WYJFA5 == 2 then --五岳剑派
			CleanWarMap(4, 0);
			WAR.WS=1
			for i = 1, n do
				for j = 1, n do
				  SetWarMap(x + i - 1, y + j - 1, 4, 1)
				  SetWarMap(x - i + 1, y + j - 1, 4, 1)
				  SetWarMap(x + i - 1, y - j + 1, 4, 1)
				  SetWarMap(x - i + 1, y - j + 1, 4, 1)
				end
			end
		end
      ng = ng + tn;
	  local wuyuedp1=""
	  local wuyuedp2=""
	  local wuyuedp3=""
	  local wuyuedp4=""
	  local wuyuedp5=""
	  if WAR.L_WYJFA1>=1 then --五岳剑法，1-封穴 2-流血 3-内伤 4-迟缓 5-连击
		wuyuedp1="东岳如座·封"
		if WAR.Person[id]["特效文字3"] ~= nil then
      	WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+"..wuyuedp1
      else
      	WAR.Person[id]["特效文字3"] = wuyuedp1
      end
	  end
	  if WAR.L_WYJFA2>=1 then
		wuyuedp2="南岳如飞·刺"
		if WAR.Person[id]["特效文字3"] ~= nil then
      	WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+"..wuyuedp2
      else
      	WAR.Person[id]["特效文字3"] = wuyuedp2
      end
	  end
	  if WAR.L_WYJFA3>=1 then
		wuyuedp3="中岳如卧·镇"
		if WAR.Person[id]["特效文字3"] ~= nil then
      	WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+"..wuyuedp3
      else
      	WAR.Person[id]["特效文字3"] = wuyuedp3
      end
	  end
	  if WAR.L_WYJFA4>=1 then
		wuyuedp4="北岳如行·徐"
		if WAR.Person[id]["特效文字3"] ~= nil then
      	WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+"..wuyuedp4
      else
      	WAR.Person[id]["特效文字3"] = wuyuedp4
      end
	  end
	  if WAR.L_WYJFA5>=1 then
		if WAR.ATNum >= 2 then	
			WAR.BJ = 1
		else
			WAR.CXLC =1 ;
		end
		wuyuedp5="西岳如立·连"
		if WAR.Person[id]["特效文字3"] ~= nil then
      	WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+"..wuyuedp5
      else
      	WAR.Person[id]["特效文字3"] = wuyuedp5
      end
	  end
      --WAR.WS = 1
    end
		
	--天山折梅手，杀气提高
	if wugong == 14 then
		local exng = 0
		local CN_num = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一","十二"}
		for i = 1, CC.Kungfunum do
			if JY.Person[pid]["武功"..i] ~= 14 and JY.Person[pid]["武功等级"..i] == 999 then
				ng = ng + 100
				exng = exng + 1
			end
		end
		if exng > 0 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+天山折梅"..CN_num[exng]
			else
				WAR.Person[id]["特效文字3"] = "天山折梅"..CN_num[exng]
			end
		end
	end
    
    --虚竹使用天山六阳掌或折梅手，出生死符，杀集气+1700
    if (wugong == 8 or wugong == 14) and match_ID(pid, 49) and PersonKF(pid, 101) and (JLSD(20, 80, pid) or WAR.NGJL == 98) then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+灵鹫宫绝学·生死符"
		else
			WAR.Person[id]["特效文字3"] = "灵鹫宫绝学·生死符"
		end
		ng = ng + 1700
		WAR.SSFwav = 1   --音效
		WAR.TZ_XZ = 1
	end	
		
   if wugong == 8 and (wglw(pid,8)>=1 and not match_ID(pid, 49)) and JLSD(20, 80, pid) then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+六阳绝技·生死符"
		else
			WAR.Person[id]["特效文字3"] = "六阳绝技·生死符"
		end
		ng = ng + 1700
		WAR.TZ_XZ = 1
    end		
    
    --蓝烟清：李文秀使用特系攻击60%的机率大幅度杀集气
    if match_ID(pid, 590) and kfkind == 5 and JLSD(20, 80, pid) then
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+".."心秀天铃·星月争辉"
		else
			WAR.Person[id]["特效文字3"] = "心秀天铃·星月争辉"
		end
    	ng = ng + 1200
		WAR.SSFwav = 1   --音效	
    end
	
	--王语嫣御法绝尘
	local YufaJC = 0
	for i = 0, WAR.PersonNum - 1 do
		local yfid = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] and match_ID(yfid, 76) and Xishu_sum(yfid) >= 500 and inteam(pid) == false then
			YufaJC = 1
			break
		end
	end
	
	--武功招式加杀集气
	if YufaJC == 0 then
			--风清扬，暴怒九剑触发无招胜有招
		if match_ID(pid, 140) and wugong == 47 and WAR.LQZ[pid] == 100 then
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."·".."无招胜有招"
			else
				WAR.Person[id]["特效文字3"] = "无招胜有招"
			end
			ng = ng + 2000
			WAR.FQY = 1
		--看有没有招式
		--首先看有没有招式
		elseif CC.KFMove[wugong] ~= nil then
			--npc必出招，小无相功加力必出招式，暴怒必出招式
                if inteam(pid) == false or myrandom(level, pid) or WAR.NGJL == 98 or WAR.LQZ[pid] == 100 or (wugong == 48 and level == 11 and WAR.DZXY == 0) or (wugong == 102 and WAR.DZXY == 0) then
				local num
				if wugong == 48 and inteam(pid) and WAR.DZXY ~= 1 and WAR.AutoFight == 0 then		--辟邪招式固定
					num = WAR.BXZS
				elseif wugong == 49 and inteam(pid) and wglw(pid,49)>1 and WAR.DZXY ~= 1 and WAR.AutoFight == 0 and WAR.LM_JQ == 0 then		--六脉固定
					num = WAR.LMZS
				elseif wugong == 102 and inteam(pid) and match_ID_awakened(pid,38,1) and WAR.DZXY ~= 1 and WAR.AutoFight == 0 then	--太玄招式固定
					num = WAR.TXZS
				elseif wugong == 25 and inteam(pid) and wglw(pid,25)>1 and WAR.DZXY ~= 1 and WAR.AutoFight == 0 then		--辟邪招式固定
					num = WAR.ARZS
				elseif wugong == 4 and inteam(pid) and wglw(pid,4)>1 and WAR.DZXY ~= 1 and WAR.AutoFight == 0 then		--猛禽招式固定
					num = WAR.LQZS
				else
					local choice = math.random(#CC.KFMove[wugong])											--从数组从随机抽取一个
					num = choice
					if wugong == 102 and match_ID_awakened(pid,38,1) then
						WAR.TXZS = choice
					end
					if wugong == 25  and wglw(pid,25)>1 then
						WAR.ARZS = choice
					end
					if wugong == 4  and wglw(pid,4)>1 then
						WAR.LQZS = choice
					end
					if wugong == 68 and wglw(pid,68)>=1 then
					    WAR.YJZS = choice
					end
					if wugong == 49 and wglw(pid,49)>=1 then
					    WAR.LMZS = choice
						if wglw(pid,49)>=2  then
						addeffect2(WAR.QXJQ, pid, math.random(1,3),2+wglw(pid,49)*2)
						end
					end
				end
				if WAR.Person[id]["特效文字3"] ~= nil then
					WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."·"..CC.KFMove[wugong][num][1]
				else
					WAR.Person[id]["特效文字3"] = CC.KFMove[wugong][num][1]
				end
				ng = ng + CC.KFMove[wugong][num][2]
			end
		end
	end
	
	
	if (nglw(pid,100)>2  or match_ID_awakened(pid, 129,1)) and Curr_NG(pid,100) then
	local a = 0
	
	   if JY.Person[pid]["内力"] > 1000 then
	   a = limitX(math.modf((JY.Person[pid]["内力"]-1000)/10),0,50)  
	   end
	
	   if JLSD(0,a,pid) and WAR.CXLC == 0 then 
       WAR.CXLC=1
	   			if WAR.Person[id]["特效文字0"] ~= nil then
					WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"].."·".."紫阳剑罡.气化三清"
				else
					WAR.Person[id]["特效文字0"] = "紫阳剑罡.气化三清"
				end
	   end
	end
	
	--张三丰，40%机率增加1000气攻
    if match_ID(pid, 5) and WAR.Person[id]["特效文字3"] ~= nil and JLSD(30, 70, pid) then
		WAR.Person[id]["特效文字3"] = "化朽为奇" .. "·" .. WAR.Person[id]["特效文字3"]
		ng = ng + 1000
    end
	
	--王重阳，全真剑法，60%几率重阳剑气777气攻
	if wugong == 39 and match_ID(pid, 129) and JLSD(20, 80, pid) then
	    local str="重阳剑气·"
		ng = ng + 777
		if match_ID_awakened(pid,129,1) and JLSD(10,60,pid) then
		  WAR.CYJG = 1
          WAR.BSQ = 1
          str="紫阳剑罡·"		  
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = str..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = str
		end
	end

		if wglw(pid,74)>2 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 2 and wugong == 74 and JLSD(20, 70, pid) then
		    WAR.BSQ = 1
	        if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = "寸劲·"..WAR.Person[id]["特效文字3"]
		    else
			WAR.Person[id]["特效文字3"] = "咏春奥义.寸劲"
		    end 
	    end

		if wglw(pid,74)>1 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 3 and wugong == 74 and (JLSD(20, 70, pid) or (WAR.LQZ[pid] or 0) == 100 ) then
		    WAR.PLGF = 1
			local dhtx = {53,111,113,117}
			local str = "咏春龙形·蟠龙棍法"
			if wglw(pid,74)>2 then
			local aa = math.random(1,3)
			local plgy = {".升龙",".亢龙",".群龙"}		
			WAR.PLGF = WAR.PLGF + aa
			str = str..plgy[aa]
			if WAR.PLGF == 2 then
			WAR.GTJIQI = WAR.GTJIQI + 250
			WAR.GTPID = pid
			end
			
			if WAR.PLGF == 4 then
			for j = 0, WAR.PersonNum - 1 do	
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                 SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 1)
				 WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", 30)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			    end	
            end				
			end
			
			addeffect2(WAR.LHXT,pid,1)
			end
			WAR.JZTX = dhtx[WAR.PLGF]
            Set_Eff_Text(id,"特效文字1",str)
	    end

		if wglw(pid,74)>2 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 4 and wugong == 74 and (WAR.LQZ[pid] or 0) == 100 then
		    WAR.GPQG = 1
			WAR.JZTX = 150
			NEWTXWZ("龟派气功波",C_RED)
			local str = "咏春奥义·龟派气功"			
            Set_Eff_Text(id,"特效文字1",str)
	    end

	
	--弹指神通，配合桃花绝技，气攻+1500
	if wugong == 18 and TaohuaJJ(pid) then
	    local str="无影神石"

		ng = ng + 1500
		if wglw(pid,18)>2 then
		   ng = ng + WAR.TZNQ*10
		   WAR.TZNQ=math.modf(WAR.TZNQ*0.5)
		   WAR.TZWY=1
		   str="无影劲气"
		  if PersonKFJ(pid,126) then
		   for j = 0, WAR.PersonNum - 1 do			
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
				local tmppid= WAR.Person[j]["人物编号"]					
					local bb=math.random(5,15)
					WAR.FXXS[WAR.Person[j]["人物编号"]]=1
					WAR.FXDS[WAR.Person[j]["人物编号"]]=WAR.FXDS[WAR.Person[j]["人物编号"]] or 0 + bb
				if WAR.FXDS[WAR.Person[j]["人物编号"]] > 50 then
					WAR.FXDS[WAR.Person[j]["人物编号"]] = 50
				end					
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
					end
				end
			end
		if PersonKFJ(pid,129) then
            for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end			
		end	
		end
		if match_ID(pid,11) then
		str = "逍遥."..str
		WAR.XYTZ = 1
		   if match_ID_awakened(pid,11,1) then
		   str = "乾坤"..str
		   WAR.XYTZ = 2
		   end
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .."·".. str
		else
			WAR.Person[id]["特效文字3"] = str
		end
	end
	
	--谢无悠，九种文字
    if match_ID(pid, 596) then
		local WZTS = {"一念无量","现世执妄","悟入幻想","草木成佛","天人五衰","六根清净","众生无情","生死有命","半身大悟"}
		local JTYL = math.random(9)
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+九天一流·"..WZTS[JTYL]
		else
			WAR.Person[id]["特效文字3"] =  "九天一流·"..WZTS[JTYL]
		end
    end
    
    --打狗棒法 极意
    if wugong == 80 and level == 11 and (WAR.LQZ[pid] == 100 or JLSD(30, 70+wglw(pid,80)*10, pid) or (JY.Base["标准"] == 5 and JLSD(30, 75, pid))) then
		WAR.Person[id]["特效文字3"] = "打狗棒法绝学--天下无狗"
		WAR.Person[id]["特效动画"] = 89
		if ng < 2400 then
			ng = 2400
		end
		WAR.WS = 1

		if wglw(pid,80)>1 then
		local HDJY = {"心法·挑字诀","心法·绊字诀","心法·缠字诀","心法·戳字诀","心法·劈字诀","心法·转字诀"};
		WAR.DGXF = math.random(1,4)
		    if wglw(pid,80)>2 and math.random(1,6)>4 then
			WAR.DGXF = math.random(5,6)
			end
		WAR.Person[id]["特效文字2"] = "打狗棒法"..HDJY[WAR.DGXF]
		end
		if WAR.QYC[pid]~=nil then
		   WAR.BJ = 1
		   WAR.DGXF_KQ = 1
		   WAR.Person[id]["特效文字3"] = "打狗棒法绝学--天下无狗【风之伤】"
		end
		
		if WAR.DGXF == 2 then
		ng = ng + 200*WAR.ACT
		end
		if WAR.DGXF == 4 then
		WAR.ASKD1 = 1
		end
		for i = 1, 6+wglw(pid,80)+WAR.DGXF_Count do
			for j = 1, 6+wglw(pid,80)+WAR.DGXF_Count do
			  SetWarMap(x + i - 1, y + j - 1, 4, 1)
			  SetWarMap(x - i + 1, y + j - 1, 4, 1)
			  SetWarMap(x + i - 1, y - j + 1, 4, 1)
			  SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
		if WAR.DGXF == 6 then
			for j = 0, WAR.PersonNum - 1 do
			  local df = WAR.Person[j]["人物编号"]
              local fhurt2 = math.modf(JY.Person[WAR.Person[j]["人物编号"]]["生命"]*0.1)			  
			    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - fhurt2
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - fhurt2
				    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			    end	
		    end
		end
    end
     
    --蓝烟清：胡家刀法，极意
    --刀系主角40%，胡斐50%，暴怒必出
    if wugong == 67 and level == 11 and ((pid == 0 and JY.Base["标准"] == 4 and (WAR.LQZ[pid] == 100 or JLSD(30,70,pid))) or (match_ID(pid, 1) and (WAR.LQZ[pid] == 100 or JLSD(20,70,pid)) or WAR.HFYD==1 )) then
		local HDJY = {"极意·伏虎式","极意·拜佛听经","极意·穿手藏刀","极意·沙鸥掠波","极意·参拜北斗","极意·闭门铁扇刀","极意·缠身摘心刀","极意·进步连环刀","极意·八方藏刀式"};
		WAR.Person[id]["特效文字3"] = HDJY[math.random(9)];
		WAR.Person[id]["特效动画"] = 6
		if JY.Person[1]["论剑奖励"] == 2 then
		WAR.Person[id]["特效文字3"] = "胡刀真传.冷月.天霜冰螭盘"
		WAR.HDMC2 = 4
		WAR.JZTX = 8
		WAR.Person[id]["特效动画"] = 113
		end	
		ng = ng + 1500
		WAR.WS = 1
		for i = 1, 5 do
			for j = 1, 5 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
    end
    
    --玄铁天外 玄铁极意
	--无招式时必触发，暴怒时必出
    if wugong == 45 and level == 11 and wglw(pid,45)>=1 and (WAR.LQZ[pid] == 100 or WAR.Person[id]["特效文字3"] == nil) then
		WAR.Person[id]["特效文字3"] = "重剑真传·浪如山涌剑如虹"
		WAR.Person[id]["特效动画"] = 84
		ng = ng + 1800
		if match_ID(id, 58) then----
		ng = ng + math.modf(JY.Person[600]["内力"]/10)
		end
		WAR.WS = 1
		for i = 1, 5+wglw(pid,45) do
			for j = 1, 5+wglw(pid,45) do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
        WAR.ZJZC = 1
     if  wglw(pid,45)>1 then
	    local aa = math.random(1,4)
		WAR.ZJZC = WAR.ZJZC + aa
		local zjzs = {"重剑.横斩式","重剑.提撩式","重剑.直刺式","重剑.竖劈式"}
	    if WAR.Person[id]["特效文字2"] == nil then
        WAR.Person[id]["特效文字2"] = zjzs[aa]
        else
        WAR.Person[id]["特效文字2"] = zjzs[aa].. "·" .. WAR.Person[id]["特效文字2"]
        end
		if WAR.ZJZC == 2 then
		local aa = math.modf(JY.Person[pid]["内力"]/100)
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
						local tmppid = WAR.Person[j]["人物编号"]
						WAR.MENG[tmppid]=(WAR.MENG[tmppid] or 0) + aa
						if WAR.MENG[tmppid]>=50 then
		                   WAR.MENG[tmppid]=50
		                end
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end		
		end	
	 end
    end
 
    if match_ID(pid,655) and (yongjian(wugong) or (yongzhi(wugong) and match_ID_awakened(pid,655,1))) and JY.Person[pid]["武器"]>0  and (WAR.LQZ[pid] == 100 or JLSD(10,60,pid)) then
		WAR.Person[id]["特效文字0"] = "巨阙剑意.橫扫"
		WAR.Person[id]["特效动画"] = 84
		ng = ng + 1800
		WAR.WS = 1
		for i = 1, 7 do
			for j = 1, 7 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
        WAR.ZJZC = 1
        if  match_ID_awakened(pid,655,1) then
	    local aa = math.random(1,4)
		WAR.ZJZC = WAR.ZJZC + aa
		local zjzs = {"巨阙.横斩式","巨阙.提撩式","巨阙.直刺式","巨阙.竖劈式"}
	    if WAR.Person[id]["特效文字2"] == nil then
        WAR.Person[id]["特效文字2"] = zjzs[aa]
        else
        WAR.Person[id]["特效文字2"] = zjzs[aa].. "·" .. WAR.Person[id]["特效文字2"]
        end
		WAR.PJTX = 2
		if WAR.ZJZC == 2 then
		local aa = math.modf(JY.Person[pid]["内力"]/100)
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
						local tmppid = WAR.Person[j]["人物编号"]
						WAR.MENG[tmppid]=(WAR.MENG[tmppid] or 0) + aa
						if WAR.MENG[tmppid]>=50 then
		                   WAR.MENG[tmppid]=50
		                end
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end		
		end	
	 end
    end
 
    --霍都攻击，中毒+13~16
    if match_ID(pid, 84) and math.random(10) < 7 then
		WAR.HDWZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+".."暗箭·扇中钉"
		else
			WAR.Person[id]["特效文字1"] = "暗箭·扇中钉"
		end
		WAR.Person[id]["特效动画"] = 89
    end
 
 	if  MPPB_MZ(pid) == 1 and JLSD(30, 80, pid)  then
    if WAR.Person[id]["特效文字1"] ~= nil then
		WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+龙象伏魔"
	else
		WAR.Person[id]["特效文字1"] = "大力龙象·神威伏魔"
	end
	WAR.LXFM = 1
    end
 
 	if match_ID_awakened(pid, 152,1)  and WAR.WCLJ == 1  then --无尘连击
		Cls()
        NewDrawString(-1, -1, "追魂夺命·"..tostring(WAR.ATNum).."连剑", C_ORANGE, 50)
        ShowScreen()
        lib.Delay(700)
		WAR.WCLJ = 2
	end
 
 	if match_ID_awakened(pid,69,1) and WAR.HQGSTS == 1 then --沼跃鱼：李逍遥酒神咒（取代原先的剑神）
       Cls()
      for i = 12, 30 do
        NewDrawString(-1, -1, "龙纹至尊.丐世打狗", C_GOLD, 25 + i)
        ShowScreen()
        if i == 30 then
          Cls()
          NewDrawString(-1, -1, "龙纹至尊.丐世打狗", C_GOLD, 25 + i)
          ShowScreen()
          lib.Delay(500)
        else
          lib.Delay(1)
        end
      end
			--WAR.LXYJSTS = 0	
	end	
	
	if match_ID_awakened(pid,69,1) and WAR.HQGSTS2 == 1 then --沼跃鱼：李逍遥酒神咒（取代原先的剑神）
		Cls()
      for i = 12, 30 do
        NewDrawString(-1, -1, "贪狼降世.苍龙天舞", C_GOLD, 25 + i)
        ShowScreen()
        if i == 30 then
          Cls()
          NewDrawString(-1, -1, "贪狼降世.苍龙天舞", C_GOLD, 25 + i)
          ShowScreen()
          lib.Delay(500)
        else
          lib.Delay(1)
        end
      end
			--WAR.LXYJSTS = 0	
	end	
 
    if match_ID(pid, 449) and math.random(10) < 7 then
		WAR.HDWZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"].."+".."暗器无双"
		else
			WAR.Person[id]["特效文字1"] = "暗器无双"
		end
		WAR.Person[id]["特效动画"] = 78
    end
 
    if WAR.HFLY == 1 and War_isEnd() == 0 and  match_ID_awakened(pid, 3, 1) and WAR.SQGJ==1 and WAR.DZXY ~= 1 then
      Cls()
	  WAR.ZYHB=0
	  WAR.ACT=10
      WAR.WS = 1
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
    end  
 
   if wglw(pid,44)>2 and WAR.SQGJ ==1 and WAR.DZXY ~= 1 and WAR.HFLY ~= 1 and War_isEnd() == 0 then
      Cls()
	  WAR.ZYHB=0
	  WAR.ACT=10
      WAR.WS = 1
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 6 and offset2 <= 6 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
    end 
 
 if WAR.DJFJ == 1 then
    QF(3+math.modf(JY.Base["天书数量"]/5),1,0)
	ng = ng + 200 + JY.Base["天书数量"] * 150
	  WAR.ZYHB=0
	  WAR.ACT=10
 end
 
 if WAR.DJFJ1 == 1 then
    QF(5,1,0)
	ng = ng + 1000
	  WAR.ZYHB=0
	  WAR.ACT=10	
 end 
 
    --真田幸村
    if pid == 553 and 0 < WAR.YZB2 then
		if 2 < WAR.YZB2 then
			WAR.Person[id]["特效文字3"] = "炎枪素浅鸣·无双乱舞皆传"   --炎枪素浅鸣·无双乱舞皆传
		elseif 1 < WAR.YZB2 then
			WAR.Person[id]["特效文字3"] = "炎枪素浅鸣·真无双乱舞"   --炎枪素浅鸣·真无双乱舞
		elseif 0 < WAR.YZB2 then
			WAR.Person[id]["特效文字3"] = "炎枪素浅鸣·无双乱舞"   --炎枪素浅鸣·无双乱舞
		end
		WAR.Person[id]["特效动画"] = 6
		ng = ng + 200 + WAR.YZB2 * 600
		WAR.WS = 1
		for i = 1, 4 + WAR.YZB2 * 2 do
			for j = 1, 4 + WAR.YZB2 * 2 do
				SetWarMap(x + i - 1, y + j - 1, 4, 1)
				SetWarMap(x - i + 1, y + j - 1, 4, 1)
				SetWarMap(x + i - 1, y - j + 1, 4, 1)
				SetWarMap(x - i + 1, y - j + 1, 4, 1)
			end
		end
    end
 
	 if wglw(pid,12)>1 and WAR.LYBF==1 then
	  Cls()
      WAR.Person[id]["特效文字4"] = "景严.千本落英"  
      WAR.Person[id]["特效动画"] = 121
      WAR.WS = 1
	  ng=ng+1000
      for i = 1, 7 do
        for j = 1, 7 do
          SetWarMap(x + i - 1, y + j - 1, 4, 1)
          SetWarMap(x - i + 1, y + j - 1, 4, 1)
          SetWarMap(x + i - 1, y - j + 1, 4, 1)
          SetWarMap(x - i + 1, y - j + 1, 4, 1)
        end
      end
	 end

	if  wglw(pid,63)>1 and WAR.XDDF2 ==2 then
	  Cls()
      WAR.Person[id]["特效文字4"] = "血煞刀法·血溅十步"  
      WAR.Person[id]["特效动画"] = 146    
      WAR.WS = 1
	  ng=ng+1000
      for i = 1, 8+wglw(pid,63) do
        for j = 1, 8+wglw(pid,63) do
          SetWarMap(x + i - 1, y + j - 1, 4, 1)
          SetWarMap(x - i + 1, y + j - 1, 4, 1)
          SetWarMap(x + i - 1, y - j + 1, 4, 1)
          SetWarMap(x - i + 1, y - j + 1, 4, 1)
        end
      end
	 end	 
	 
	if match_ID_awakened(pid,616,1) and wugong == 77 and JLSD(15,55,pid) then
	  Cls()
      WAR.Person[id]["特效文字4"] = "公孙家法.渔网大阵"  
      WAR.Person[id]["特效动画"] = 117
      WAR.WS = 1
	  ng=ng+1000
      for i = 1, 7 do
        for j = 1, 7 do
          SetWarMap(x + i - 1, y + j - 1, 4, 1)
          SetWarMap(x - i + 1, y + j - 1, 4, 1)
          SetWarMap(x + i - 1, y - j + 1, 4, 1)
          SetWarMap(x - i + 1, y - j + 1, 4, 1)
        end
      end
	 end
 
    --宫本武藏，秒杀
    if match_ID(pid,516) and WAR.KHCM[pid] ~= 1 then
		WAR.Person[id]["特效文字3"] = "二天一流秘奥义·万物一空"  --二天一流秘奥义·万物一空
		WAR.Person[id]["特效动画"] = 6
		WAR.GBWZ = 1
		WAR.WS = 1
		ng = ng + 1500
    end
 

 
    if wglw(pid,52)>2 and WAR.KHCM[pid] ~= 1 and wugong == 52 then
		WAR.GBWZ3 = 1
		WAR.WS = 1
		ng = ng + 1500
		WAR.Person[id]["特效文字0"] = "千人斩.一刀两断"  --二天一流秘奥义·万物一空
		WAR.Person[id]["特效动画"] = 74
    end
	
    --日本NPC
    if WAR.Data["代号"] == 130 then
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["人物编号"] == 541 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
				WAR.BSMT = 1
				WAR.WS = 1
				ng = ng + 1500
				WAR.Person[id]["特效文字1"] = "毗沙门天之加护"  --毗沙门天之加护
				WAR.Person[id]["特效动画"] = 6
			end
		end
    end
   
    --葵花神功加力，60%几率刺目
    if WAR.NGJL == 105 and wugong == 48 then
		local times = 1
		--林平之二次判定
		if match_ID(pid, 36) then
			times = 2
		end
		for i = 1, times do
			if math.random(10) < 7 then
				WAR.KHBX = 2
				WAR.Person[id]["特效文字3"] = "真辟邪剑法·葵花刺目";
				WAR.Person[id]["特效动画"] = 6
				break
			end
		end
    end

    if KUIHUA(pid) == 1 and wugong == 140 and nglw(pid,105)>2 then
   		local times = 1
		--林平之二次判定
		if match_ID(pid, 36) then
			times = 2
		end
		for i = 1, times do
			if math.random(10) < 7 then
				WAR.KUIHUAHJ = 2
				Set_Eff_Text(id,"特效文字1","阳葵神技.焰剑.天丛云")
				WAR.Person[id]["特效动画"] = 14
				break
			end
		end    
    end

    if KUIHUA(pid) == 0 and wugong == 130 and nglw(pid,105)>2 then
			if math.random(10) < 7 then
				WAR.KUIHUAHJ = 1
				Set_Eff_Text(id,"特效文字1","阴葵神技.勾玉.梦月")
				WAR.Person[id]["特效动画"] = 15
			end   
    end

    if KUIHUA(pid) == 2 and wugong == 55 and nglw(pid,105)>2 then
			if math.random(10) < 7 then
				WAR.KUIHUAHJ = 3
				Set_Eff_Text(id,"特效文字1","星葵神技.神镜.三籁")
				WAR.Person[id]["特效动画"] = 16
			end   
    end
	
	--葵花尊者有几率刺目
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and pid == 27 then
		if math.random(10) < 7 then
			WAR.KHBX = 2
			WAR.Person[id]["特效文字3"] = "葵花诀·葵花刺目";
			WAR.Person[id]["特效动画"] = 6
		end
	end
    
    --盲目状态·攻击无效
    if WAR.KHCM[pid] == 2 then
		WAR.Person[id]["特效动画"] = 89
		WAR.Person[id]["特效文字2"] = "状态·盲目攻击"  --状态·攻击无效
    end

    -- 开太极 WAR.tmp[3000 + pid] > 600
    if D1ZSF(pid) and (wugong == 16 or  wugong == 46) and WAR.LQZ[pid] == 100 and ((WAR.tmp[3000 + pid]~= nil and 
        WAR.tmp[3000 + pid]>=600) or  (WAR.TJZX[pid] ~= nil and WAR.TJZX[pid] >= 8) or  (WAR.BG[pid] ~= nil and WAR.BG[pid] >= 100)) then
	    local qg = JY.Person[pid]["内力"]/JY.Person[pid]["内力最大值"]*1000
	    WAR.WDKTJ = 1
	    ng = ng+ qg
		local size = 60
		local x = CC.ScreenW/2;
        local y = CC.ScreenH/2;
        local offx = (#"【太极真解.进步搬拦捶】")*size/4
        local offy = size/2
		for k = 1,10 do
			
			Cls()
			lib.Background(0,y-50,CC.ScreenW,y+50,98)
			DrawString(x-offx,y-offy,"【太极真解.进步搬拦捶】",C_GOLD,size);  
			ShowScreen();
			lib.Delay(CC.BattleDelay)
		end
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end	
        end		
	end

    if wglw(pid,16)>2 and wugong == 16 and WAR.LQZ[pid] == 100 and ((WAR.tmp[3000 + pid]~= nil and WAR.tmp[3000 + pid]>=600) or  
	(WAR.TJZX[pid] ~= nil and WAR.TJZX[pid] >= 8) or  (WAR.BG[pid] ~= nil and WAR.BG[pid] >= 100)) then
	    local qg = JY.Person[pid]["内力"]/JY.Person[pid]["内力最大值"]*1000
	    WAR.WDKTJ = 1
	    ng = ng+ qg
		local size = 60
		local x = CC.ScreenW/2;
        local y = CC.ScreenH/2;
        local offx = (#"【太极真解.进步搬拦捶】")*size/4
        local offy = size/2
		for k = 1,10 do
			
			Cls()
			lib.Background(0,y-50,CC.ScreenW,y+50,98)
			DrawString(x-offx,y-offy,"【太极真解.进步搬拦捶】",C_GOLD,size);  
			ShowScreen();
			lib.Delay(CC.BattleDelay)
		end
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end	
        end		
	end	
	
	--袁承志觉醒后，生命低于30%，50%几率出金蛇奥义
	if match_ID_awakened(pid, 54, 1) and wugong == 40 and ((JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid)) or (JY.Person[54]["品德"] == 90 and JLSD(10,90,pid) )) then
		WAR.JSAY = 1
		ng = ng + 2000
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
		if WAR.LMC == 0 and JY.Person[54]["品德"] == 90 then
		WAR.LMC = 1
		end
	end

		if wugong == 26 and match_ID_awakened(pid, 50,1) and (WAR.ACT >= 4 or WAR.FS3 == 1) then
			zssdz(pid)
			for i = 1, 30 do
			DrawStrBox(-1, 24, "诸天归一.龙牙天引", C_RED, 10 + i)
			ShowScreen()
			lib.Delay(15)
		    end
			WAR.FS2 = 1
			for i = 0, WAR.PersonNum - 1 do
			  if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 10 and offset2 <= 10 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			  end
		   end
		end	
	
	if match_ID_awakened(pid, 65, 1) and wugong == 17 and JLSD(20,70,pid) then
	WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz2(pid)
		for i = 1, 10 do
			NewDrawString(-1, -1, "南诏秘传奥义·七诀剑气", C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, "南诏秘传奥义·七诀剑气", C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
	    
		WAR.QJJQ = 1
		ng = ng + 2000
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				if offset1 <= 8 and offset2 <= 8 then
					SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
				end
			end
		end
	end	
	
	if WAR.YHDF[pid] == 1 then --17-2-10
	   CleanWarMap(4, 0)
	   local a = math.random(0,CC.WarWidth)
	   local b = math.random(0,CC.WarHeight)
	   WarDrawAtt(a,b, atkfanwei, 3)
	   WAR.WS = 0
	end

	if WAR.Person[id]["精神崩溃"]>=75 and math.random(1,100)<50 then --17-2-10
	   CleanWarMap(4, 0)
	   local a = math.random(0,CC.WarWidth)
	   local b = math.random(0,CC.WarHeight)
	   WarDrawAtt(a,b, atkfanwei, 3)
	   WAR.WS = 0
	end

	if WAR.YHLP == 1 and WAR.PZPID == pid then --17-2-10
	   CleanWarMap(4, 0)
	   local a = math.random(0,CC.WarWidth)
	   local b = math.random(0,CC.WarHeight)
	   WarDrawAtt(a,b, atkfanwei, 3)
	   WAR.WS = 0
	end	
	
	--无酒不欢：斗转第四层，幻梦星辰，反击全屏
    if WAR.DZXYLV[pid] == 130 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
    end
	
    if WAR.HSDF_DF >0 and wglw(pid,76)>=1 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
		    local tmppid = WAR.Person[i]["人物编号"]
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 1+wglw(pid,76)*2) and WAR.DRZT[tmppid]~=nil then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
		if WAR.HSDF_DF>=1 then
		WAR.HSDF_DF1 = WAR.HSDF_DF
		end
    end	

   if WAR.LM_JQ >0 and wglw(pid,49)>1 then
		CleanWarMap(4, 0)
			local nydx = {}
			local nynum = 1

			for i = 0, WAR.PersonNum - 1 do
			    local df = WAR.Person[i]["人物编号"]
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					nydx[nynum] = i
					nynum = nynum + 1
				end
			end
			local nyft = nydx[math.random(nynum - 1)]
			SetWarMap(WAR.Person[nyft]["坐标X"], WAR.Person[nyft]["坐标Y"], 4, 1);	--反弹者标识为被命中
        if wglw(pid,49)>2 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
		end
		if WAR.LM_JQ >=1 then
		WAR.LM_JQ1 = WAR.LM_JQ		
		end
		if WAR.QJ_JQ>0 then
		WAR.LM_JQ2 = 1
		WAR.JZTX = 111
		end
    end	

	if WAR.DZXYLV[pid] ~= nil and WAR.YCHX == 1 then --亮翅
        for j = 0, WAR.PersonNum - 1 do
        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
          local tmppid = WAR.Person[j]["人物编号"]
		  WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100 
		  WAR.MENG[tmppid] = (WAR.MENG[tmppid] or 0) + 10
		  WAR.TXXS[tmppid] = 1
        end
        end		
	end
    
	if  math.random(10)<6 then --万兽山庄		
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and D1ZSF(WAR.Person[j]["人物编号"]) then
			    CleanWarMap(4, 0)
				SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 1)
				WAR.TJFY = -1
				WAR.Person[j]["反击武功"] = 16
				ZHEN_ID = j
				WAR.DUIZHAO = 1
				WAR.tmp[3000+WAR.Person[j]["人物编号"]] = (WAR.tmp[3000+WAR.Person[j]["人物编号"]] or 0) + 200
				WAR.BG[WAR.Person[j]["人物编号"]] = (WAR.BG[WAR.Person[j]["人物编号"]] or 0) + 200
				WAR.TJZX[WAR.Person[j]["人物编号"]] = (WAR.TJZX[WAR.Person[j]["人物编号"]] or 0) + 2
				break
			end
		end	
		WAR.WS = 1	
	end
	
	if  math.random(10)<6 then --万兽山庄		
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and nglw(WAR.Person[j]["人物编号"],171)>1 and Curr_NG(WAR.Person[j]["人物编号"],171) then
			    CleanWarMap(4, 0)
				SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 1)
				ZHEN_ID = j
				WAR.DUIZHAO = 1
				WAR.TJZX[WAR.Person[j]["人物编号"]] = (WAR.TJZX[WAR.Person[j]["人物编号"]] or 0) + 2
				if MPPB_WD(WAR.Person[j]["人物编号"]) == 2 then
				WAR.BG[WAR.Person[j]["人物编号"]] = (WAR.BG[WAR.Person[j]["人物编号"]] or 0) + 200
				end
				if wglw(WAR.Person[ZHEN_ID]["人物编号"],16)>=1 then
				WAR.tmp[3000+WAR.Person[j]["人物编号"]] = (WAR.tmp[3000+WAR.Person[j]["人物编号"]] or 0) + 200
				end
				break
			end
		end	
		WAR.WS = 1	
	end

	
	
	if WAR.BFTX >= 1 then --冰封天下
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end	
		WAR.WS = 1
        for j = 0, WAR.PersonNum - 1 do
        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
          local tmppid = WAR.Person[j]["人物编号"]
		  WAR.BFXS[tmppid] = 1
		  AddPersonAttrib(tmppid,"冰封程度",30)
        end
        end		
	end


	
    --local xb = JY.Wugong[wugong]["武功类型"]
    local pz = math.modf(JY.Person[0]["资质"] / 10)
    
    --主角剑神大招，全屏攻击
    if pid == 0 and JY.Base["标准"] == 3 and 120 <= TrueYJ(pid) and 0 < JY.Person[pid]["武功9"] and kfkind == 3 and wugong ~= 43 and JLSD(25, 60 + pz, pid) and JY.Person[pid]["六如觉醒"] > 0 then
		CleanWarMap(4, 0)
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
			end
		end
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[3]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[3] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1500
		WAR.WS = 1
		Cls()
		  --[[
		  if JY.HEADXZ == 1 then    --大贴图
			lib.PicLoadCache(91, 2, 100, -1, 1)
		  else
			lib.PicLoadCache(91, 2, -1, 1, 1)
		  end
		  ]]
		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[3] .. TFSSJ[3], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, ZJTF[3] .. TFSSJ[3], C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
		WAR.JSYX = 1

    end
      
    --主角拳系大招
    if pid == 0 and JY.Base["标准"] == 1 and 0 < JY.Person[pid]["武功9"] and 120 <= JY.Person[pid]["拳掌功夫"] and JLSD(25, 60 + pz, pid) and kfkind == 1 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[1]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[1] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1200
		WAR.WS = 1
		Cls()
		  --[[
		  if JY.HEADXZ == 1 then
			lib.PicLoadCache(91, 0, -1, -1, 1)
		  else
			lib.PicLoadCache(91, 0, 25, 1, 1)
		  end
		  ]]
      
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[1] .. TFSSJ[1], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[1] .. TFSSJ[1], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.LXZQ = 1
    end
	
    --主角指法大招
    if pid == 0 and JY.Base["标准"] == 2 and 0 < JY.Person[pid]["武功9"] and 120 <= JY.Person[pid]["指法技巧"] and JLSD(25, 60 + pz, pid) and kfkind == 2 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[2]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[2] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1100
		WAR.WS = 1
		Cls()
		  --[[
		  if JY.HEADXZ == 1 then
			lib.PicLoadCache(91, 0, -1, -1, 1)
		  else
			lib.PicLoadCache(91, 0, 25, 1, 1)
		  end
		  ]]
      
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[2] .. TFSSJ[2], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[2] .. TFSSJ[2], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.LXYZ = 1
    end
    
    --主角特系大招
    if pid == 0 and JY.Base["标准"] == 5 and 0 < JY.Person[pid]["武功9"] and 120 <= JY.Person[pid]["特殊兵器"] and JLSD(25, 65 + pz, pid) and kfkind == 5 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[5]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[5] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1000
		WAR.WS = 1
		Cls()
		  --[[
		  if JY.HEADXZ == 1 then
			lib.PicLoadCache(91, 6, -100, -1, 1)
		  else
			lib.PicLoadCache(91, 6, 130, 1, 1)
		  end
		  ]]
		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[5] .. TFSSJ[5], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[5] .. TFSSJ[5], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.GCTJ = 1
		if zylw(5)>2 then--
		    WAR.BJ = 1
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300 
                    JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] = JY.Person[WAR.Person[j]["人物编号"]]["受伤程度"] + math.random(5, 9)
				end
			end
			if WAR.Person[id]["特效文字2"] == nil then
				WAR.Person[id]["特效文字2"] = "棍藏天机.棍势如山"
			else
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+棍藏天机.棍势如山";
			end
		end
    end
    
    --主角刀系大招
    if pid == 0 and JY.Base["标准"] == 4 and 0 < JY.Person[pid]["武功9"] and 120 <= JY.Person[pid]["耍刀技巧"] and JLSD(25, 65 + pz, pid) and kfkind == 4 and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[4]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[4] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1500
		WAR.WS = 1
		Cls()
		  --[[
		  if JY.HEADXZ == 1 then
			lib.PicLoadCache(91, 4, -1, -1, 1)
		  else
			lib.PicLoadCache(91, 4, 55, 1, 1)
		  end
		  ]]
		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[4] .. TFSSJ[4], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
			  Cls()
			  NewDrawString(-1, -1, ZJTF[4] .. TFSSJ[4], C_GOLD, CC.DefaultFont + i*2)
			  ShowScreen()
			  lib.Delay(500)
			else
			  lib.Delay(1)
			end
		end
		WAR.ASKD = 1
		--触发后给自己加怒气25
		WAR.YZHYZ = WAR.YZHYZ + 25
    end
 
    if match_ID_awakened(pid,1,1)  and  (JLSD(15, 85, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and wugong == 67 then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "胡家刀法最高奥义.一刀"
		else
			WAR.Person[id]["特效文字1"] = "魂系一刀" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		ng = ng + JY.Person[pid]["耍刀技巧"]*10
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "胡家刀法最高奥义.一刀", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		WAR.HFYD = 1
		WAR.HFYD2 = ng
		--触发后给自己加怒气25
    end
 
 
     if match_ID(pid,114) then
	    local aa= (WAR.KONGQUE[pid] or 0)*2
		if aa >= 10 then
		aa = 11
		end
		if math.random(10)<aa  then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "五色神光.天舞宝轮"
		else
			WAR.Person[id]["特效文字1"] = "五色神光" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		ng = ng + math.max(JY.Person[pid]["内力"]*0.75,2000)
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "五色神光.天舞宝轮", M_Yellow, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		WAR.TWBL = (WAR.KONGQUE[pid] or 0)
		WAR.KONGQUE[pid] = nil
		WAR.LHQ_FM = 1 
        WAR.LHQ_FM2 = 1
				for j = 0, WAR.PersonNum - 1 do
               if WAR.Person[j]["我方"] == true and WAR.Person[j]["死亡"] == false then
					local kid = WAR.Person[j]["人物编号"];
					local add = JY.Person[pid]["内力"]/50 + 30;		
					add = math.modf(add);		
					WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end	
		end
		end
    end
 
     if match_ID_awakened(pid,75,1)  and  (JLSD(15, 85, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and wugong == 10 then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "错拳.百花缭乱"
		else
			WAR.Person[id]["特效文字1"] = "错拳.百花缭乱" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		ng = ng + math.modf(Xishu_sum(id)*1.5)
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "错拳.百花缭乱", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		WAR.BHCQ = 1
		if  WAR.BJ == 1 then
		WAR.CXLC2 = 1
		end
    end
 
 if match_ID_awakened(pid,75,1) then --陈家洛满天流星群伤80
	   local xihe= Xishu_sum(pid)
		if xihe >= 400 and JLSD(10, 70, pid) then
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .."漫天流星"
		else
			WAR.Person[id]["特效文字2"] = "漫天流星"
		end
			WAR.Person[id]["特效动画"] = 89
			for j = 0, WAR.PersonNum - 1 do
			  if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 80*JY.Person[WAR.Person[j]["人物编号"]]["血量翻倍"]
				if JY.Person[WAR.Person[j]["人物编号"]]["生命"] <= 0 then
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = 1
				end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			  end
			end			
		end	
	end	

   if T7DFWM(pid) and match_ID_awakened(pid,75,1) then --东方未明攻击特技
	
	
	
	if JY.Person[0]["攻击力"] >= 350 and JY.Person[0]["生命"] <= math.modf(JY.Person[0]["生命最大值"] * 0.5)
		and JLSD(30, 65, pid) then --东方未明觉醒后生命50%以下，35%几率攻击加倍
		WAR.DFWM = 1
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = "会心一击"
		else
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" .."会心一击"
		end				
		WAR.Person[id]["特效动画"] = 110
	end	
	
		
	
	local str = nil
	--东方未明觉醒后四系特技
	if sixi(pid, 1) >= 130 and yongquan(wugong) and JLSD(30, 50 + wgnumber(0, 1), pid) then 
        str = "铁拳奔袭"
		WAR.DFWM2 = 1	
	elseif sixi(pid, 2) >= 130 and yongzhi(wugong) and JLSD(30, 60 + wgnumber(0, 2), pid) then
		str = "寸劲破罡"	
		WAR.DFWM2 = 2		
		
	elseif sixi(pid, 3) >= 130 and yongjian(wugong) and JLSD(30, 55 + wgnumber(0, 3), pid) then
        str ="醉里挑灯"
 		WAR.DFWM2 = 3
        WAR.DFWMJIQI = 1		
	elseif sixi(pid, 4) >= 130 and yongdao(wugong) and JLSD(30, 55 + wgnumber(0, 4), pid) then
        str ="吞云刀意"
		WAR.DFWM2 = 4
	elseif sixi(pid, 5) >= 130 and yongte(wugong) and JLSD(30, 55 + wgnumber(0, 6), pid) then
        str ="横扫千军"
		WAR.DFWM2 = 5		
	end
	if wugong == 10 then--
	local aa = {"铁拳奔袭","寸劲破罡","醉里挑灯","吞云刀意","横扫千军"}
	local aa1 = {"【横练劲】","【炮捶劲】","【钻心劲】","【劈空劲】","【崩山劲】"}
	local bb = math.random(1,5)
	local bb1 = math.random(1,5)
	if sixi(pid,bb)>=130 or WAR.BHCQ == 1 then
	   str = "百花."..aa[bb]..aa1[bb1]
	   WAR.DFWM2 = bb
	   WAR.DFWM2P = bb1
	end
	end
	  if  str ~= nil then
	    if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = str
		else
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "+" ..str
		end	
	 end
  end	
 
     if match_ID(pid,447)  and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and kfkind == 3 and (JY.Person[0]["六如觉醒"] > 0 or match_ID_awakened(pid,447,1)) then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "眠狂.幻剑"
		else
			WAR.Person[id]["特效文字1"] = "眠狂.幻剑" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		WAR.Person[id]["特效动画"] = 43
		ng = ng + JY.Person[pid]["御剑能力"]*10
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "眠狂.幻剑", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		WAR.HUANJIAN = 1
		--触发后给自己加怒气25
    end
 
      if match_ID(pid,448)  and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and kfkind == 4 and (JY.Person[0]["六如觉醒"] > 0 or match_ID_awakened(pid,448,1)) then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "霸刀.绝情斩"
		else
			WAR.Person[id]["特效文字1"] = "霸刀.绝情斩" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		WAR.Person[id]["特效动画"] = 45
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "天地之下.唯我一刀", M_DarkOrange, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
		WAR.BADAO = 1
		WAR.ASKD1 = 1
		WAR.JZTX = 181
    end
 
     if match_ID_awakened(pid, 38,2) and kfkind == 1 then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "石破天惊拳"
		else
			WAR.Person[id]["特效文字1"] = "石破天惊拳" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		WAR.Person[id]["特效动画"] = 37
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "流派.东方不败", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
        WAR.JGHJ=102 
    end
 
      if match_ID_awakened(pid, 27,1) and kfkind == 1 then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "极.皇影破天弹"
		else
			WAR.Person[id]["特效文字1"] = "极.皇影破天弹" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		WAR.Person[id]["特效动画"] = 37
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "流派.东方不败", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
        WAR.JGHJ=105 
    end
 
     if match_ID_awakened(pid, 38,2) and kfkind == 2 then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "闪光指"
		else
			WAR.Person[id]["特效文字1"] = "闪光指" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		WAR.Person[id]["特效动画"] = 39
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "流派.东方不败", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
        for k = 0, WAR.PersonNum - 1 do
				if WAR.Person[k]["死亡"] == false and WAR.Person[k]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then				
						local tmppid = WAR.Person[k]["人物编号"]
						WAR.KHCM[tmppid]=2 
						WAR.HOT[tmppid] = WAR.HOT[tmppid] or 0 + 20
						WAR.TXXS[tmppid] = 1
				end
				
	    end		
	end	  
 
      if match_ID_awakened(pid, 27,1) and kfkind == 2 then
		if WAR.Person[id]["特效文字1"] == nil then
			WAR.Person[id]["特效文字1"] = "暗黑指"
		else
			WAR.Person[id]["特效文字1"] = "暗黑指" .. "·" .. WAR.Person[id]["特效文字1"]
		end
		WAR.Person[id]["特效动画"] = 37
		WAR.WS = 1
		Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "流派.东方不败", C_GOLD, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
        for k = 0, WAR.PersonNum - 1 do
				if WAR.Person[k]["死亡"] == false and WAR.Person[k]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then				
						local tmppid = WAR.Person[k]["人物编号"]
						WAR.XRZT[tmppid]= WAR.XRZT[tmppid] or 0 + 20
						WAR.ICE[tmppid] = WAR.ICE[tmppid] or 0 + 20
						WAR.TXXS[tmppid] = 1
				end
				
	    end	
    end 
 
 	 if match_ID_awakened(pid,48,1)  and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and wugong == 120 then--沼跃鱼：鸠摩智残火刀终式大招
	  WAR.Person[id]["特效动画"] = 36
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = "摩呼罗迦.地龙玄冰玉"
      else
        WAR.Person[id]["特效文字1"] = "地龙.玄冰玉".. "·" .. WAR.Person[id]["特效文字1"]
      end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "摩呼罗迦.霜冻翡翠", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.DLY=1--沼跃鱼：游坦之地龙玉
    end
 
  	 if wglw(pid,55)>1  and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.5) and JLSD(10,70,pid))) and wugong == 55 then--狂风刀法二阶
	  local str="无明神风流"
	  local str1={".蜃",".凤",".麒麟",".玄武"}
	  WAR.WMSF = math.random(1,4)
	  WAR.Person[id]["特效动画"] = 165
	  local str2 = str1[WAR.WMSF]
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = str..str2
      else
        WAR.Person[id]["特效文字1"] = str..str2.. "·" .. WAR.Person[id]["特效文字1"]
      end
	  if WAR.WMSF == 1 then
	  addeffect2(WAR.HIDE2,pid,20)
	  end
	  if WAR.WMSF == 4 then
	  addeffect2(WAR.SFXW,pid,20)
	  end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 30 do
			DrawStrBox(-1, 24, str..str2, M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end

    end
 
 
 if match_ID_awakened(pid,80,1) and  ((JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) or (WAR.NSTJ[pid]~=nil and WAR.NSTJ[pid]>= 50)) and wugong == 46 then --沼跃鱼：张召重技能
      CleanWarMap(4, 0)
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
          SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
        end
      end
	  WAR.Person[id]["特效动画"] = 116
      if WAR.Person[id]["特效文字3"] == nil then
        WAR.Person[id]["特效文字3"] = "火云剑意"
      else
        WAR.Person[id]["特效文字3"] = "火云剑意".. "·" .. WAR.Person[id]["特效文字3"]
      end
	  local aa = (WAR.NSTJ[pid] or 0)
	  local DQ=TrueYJ(pid)*(5+aa)
	  DQ=DQ+math.modf(JY.Person[pid]["内力"]/10)
      ng = ng + DQ
      WAR.WS = 1
      Cls()
      		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
	   for i = 1, 30 do
			DrawStrBox(-1, 24, "火手太极.火云剑意", M_Red, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.NSTJ2= DQ
	  WAR.NSTJ[pid]=math.modf(aa/2)
    end
 
 
 if match_ID_awakened(pid,58,1) and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid)) or WAR.XTCJ == 1) and wugong == 45 then --沼跃鱼：张召重技能
      CleanWarMap(4, 0)
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
          SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
        end
      end
	  WAR.Person[id]["特效动画"] = 116
      if WAR.Person[id]["特效文字3"] == nil then
        WAR.Person[id]["特效文字3"] = "独孤真传.玄铁荡剑式"
      else
        WAR.Person[id]["特效文字3"] = "独孤真传.玄铁荡剑式".. "·" .. WAR.Person[id]["特效文字3"]
      end
	  local DQ=math.modf(JY.Person[pid]["内力"]/10)
      ng = ng + DQ
      WAR.WS = 1
      Cls()
      		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
	   for i = 1, 30 do
			DrawStrBox(-1, 24, "独孤真传.玄铁荡剑式", M_Red, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.XTDJ= DQ
	  WAR.PJTX = 2
	  WAR.DJSwav = 1
	  WAR.ZJZC = 1
    end
 
     if WAR.ZJZC == 1 and wglw(pid,45)>1 then
	    local aa = math.random(1,4)
		WAR.ZJZC = WAR.ZJZC + aa
		local zjzs = {"重剑.横斩式","重剑.提撩式","重剑.直刺式","重剑.竖劈式"}
	    if WAR.Person[id]["特效文字2"] == nil then
        WAR.Person[id]["特效文字2"] = zjzs[aa]
        else
        WAR.Person[id]["特效文字2"] = zjzs[aa].. "·" .. WAR.Person[id]["特效文字2"]
        end
		if WAR.ZJZC == 2 then
		local aa = math.modf(JY.Person[pid]["内力"]/100)
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
						local tmppid = WAR.Person[j]["人物编号"]
						WAR.MENG[tmppid]=(WAR.MENG[tmppid] or 0) + aa
						if WAR.MENG[tmppid]>=50 then
		                   WAR.MENG[tmppid]=50
		                end
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				end
			end		
		end	
	 end
 
  	 if match_ID_awakened(pid,49,1)  and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and (wugong == 8 or wugong == 14) then--沼跃鱼：夜叉
	  WAR.Person[id]["特效动画"] = 47
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = "幽冥夜叉.轮回掌"
      else
        WAR.Person[id]["特效文字1"] = "幽冥夜叉.轮回掌".. "·" .. WAR.Person[id]["特效文字1"]
      end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "幽冥夜叉.轮回掌", M_LightBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.LX_SSF=1--沼跃鱼：游坦之地龙玉
    end
 
  	 if match_ID_awakened(pid,51,1)  and (WAR.MRDZ[pid]~=nil and WAR.MRDZ[pid] >= 5) and (JLSD(15, 75, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and (wugong == 43 or wugong == 138)and WAR.DZXY ~= 1 then--沼跃鱼：夜叉
	  WAR.Person[id]["特效动画"] = 39
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = "修罗地狱.无惨剑"
      else
        WAR.Person[id]["特效文字1"] = "修罗地狱.无惨剑".. "·" .. WAR.Person[id]["特效文字1"]
      end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "修罗地狱.无惨剑", M_LightBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.MR_XLWC=1--沼跃鱼：游坦之地龙玉
    end 
 
   if match_ID_awakened(pid,53,1) and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and wugong==49 then
	  WAR.Person[id]["特效动画"] = 65
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = "龙脉剑气.龙剑交泰"
      else
        WAR.Person[id]["特效文字1"] = "龙脉剑气.龙剑交泰".. "·" .. WAR.Person[id]["特效文字1"]
      end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "龙脉剑气.龙剑交泰", M_LightBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.LMJQ=1--沼跃鱼：龙剑
  end
 
    if match_ID_awakened(pid,78,1) and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and wugong==11 then
	  local str = "邪王.炎杀炼狱爪"
	  WAR.MCF=1--沼跃鱼：梅超风
	  if JY.Person[78]["论剑奖励"] == 2 then
	  str = "洞察.柔步拘魂爪"
	  WAR.MCF=2--沼跃鱼：梅超风
	  end
	  WAR.Person[id]["特效动画"] = 73
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = str
      else
        WAR.Person[id]["特效文字1"] = str.. "·" .. WAR.Person[id]["特效文字1"]
      end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		zssdz(pid)
		for i = 1, 30 do
			DrawStrBox(-1, 24, str, M_LightBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
  end
 
  	 if match_ID(pid,450)  and  (JLSD(15, 65, pid) or (JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid))) and WAR.BHJS[pid]==nil and (JY.Person[0]["六如觉醒"] > 0 or match_ID_awakened(pid,450,1)) then--沼跃鱼：鸠摩智残火刀终式大招
	  WAR.Person[id]["特效动画"] = 31
      if WAR.Person[id]["特效文字1"] == nil then
        WAR.Person[id]["特效文字1"] = "金刚.不坏金身"
      else
        WAR.Person[id]["特效文字1"] = "金刚.不坏金身".. "·" .. WAR.Person[id]["特效文字1"]
      end
      WAR.WS = 1
        Cls()		  
		ShowScreen()
		lib.Delay(40)
		for i = 1, 30 do
			DrawStrBox(-1, 24, "金刚.不坏金身", M_DeepSkyBlue, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
      WAR.BHJS[pid]=30
    end
 
    --主角天罡大招，内功可触发
    if pid == 0 and JY.Base["标准"] == 6 and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid) and kfkind == 6 and JY.Person[pid]["六如觉醒"] > 0 and WAR.JSTG == 0  then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[6]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[6] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		ng = ng + 1300
		WAR.WS = 1
		Cls()
			  --[[
			  if JY.HEADXZ == 1 then
				lib.PicLoadCache(91, 8, 100, -1, 1)
			  else
				lib.PicLoadCache(91, 8, 49, 1, 1)
			  end
			  ]]
		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[6] .. TFSSJ[6], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, ZJTF[6] .. TFSSJ[6], C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
		WAR.JSTG = 1
		WAR.JSTG2 = WAR.JSTG2 + 150
	end

--主角毒王大招，自身中毒100可触发
    if pid == 0 and JY.Base["标准"] == 9 and 0 < JY.Person[pid]["武功9"] and (JLSD(25, 60 + pz, pid) or JY.Person[pid]["中毒程度"] == 100) and JY.Person[pid]["六如觉醒"] > 0 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字3"] == nil then
			WAR.Person[id]["特效文字3"] = ZJTF[9]
		else
			WAR.Person[id]["特效文字3"] = ZJTF[9] .. "·" .. WAR.Person[id]["特效文字3"]
		end
		WAR.WS = 1
		WAR.YTML1 = JY.Person[pid]["中毒程度"]
		JY.Person[pid]["中毒程度"] = 0
		Cls()

		ShowScreen()
		lib.Delay(40)
		for i = 1, 10 do
			NewDrawString(-1, -1, ZJTF[9] .. TFSSJ[9], C_GOLD, CC.DefaultFont + i*2)
			ShowScreen()
			if i == 10 then
				Cls()
				NewDrawString(-1, -1, ZJTF[9] .. TFSSJ[9], C_GOLD, CC.DefaultFont + i*2)
				ShowScreen()
				lib.Delay(500)
			else
				lib.Delay(1)
			end
		end
		WAR.YTML = 1
	end	
	
	--欧阳克，暴怒使用雪山白驼掌，变为灵蛇拳
	if match_ID(pid,61) and wugong == 9 and WAR.LQZ[pid] == 100 then
		WAR.OYK = 1
		local str="灵蛇拳"
		local num=64
		if match_ID_awakened(pid,61,1) then
		WAR.OYK = 2
		str="灵蛇.寒影毒手"
		num=113
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·"..str
		else
			WAR.Person[id]["特效文字1"] = str
		end
		WAR.Person[id]["特效动画"] = num
	end	

	if MPPB_BTNY(pid) >=1 and (yongquan(wugong) or yongte(wugong)) and JLSD(10,60,pid) then
		WAR.OYK = 1
		local str="奇脉神功.逆行"
		local num=36
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·"..str
		else
			WAR.Person[id]["特效文字1"] = str
		end
		WAR.Person[id]["特效动画"] = num
	end	


	if wglw(pid,9)>1 and wugong == 9 and JLSD(10,40+wglw(pid,9)*10,pid) then
		WAR.XSBTQ = 1
		local str="雪山寒蛇.悲霜冰毒"
		local color = M_Blue

		if JLSD(10,40+wglw(pid,9)*10,pid) or (match_ID(pid,61) and WAR.LQZ[pid] == 100) then
        WAR.XSBTQ = 2
		str="雪山寒蛇.万蝰之灾"
		color = M_SeaGreen
		end
		if wglw(pid,9)>2 then--
		WAR.XSBTQ2 = WAR.XSBTQ
		str="真"..str
		end
        NEWTXWZ(str,color)
	end	

	if wglw(pid,81)>=1 and wugong == 81 and WAR.BJ == 1 then
       addeffect2(WAR.SPXT,pid,1)
	end


	if wglw(pid,81)>1 and wugong == 81 and (JLSD(10,40+wglw(pid,81)*10,pid) or WAR.BJ == 1 ) then
		WAR.XSBTQ3 = 1
		local str="灵蛇.八岐天灾"
		local color = M_DarkGreen
		if wglw(pid,81)>2  then
		WAR.XSBTQ3 = 2
		str="凶蛇.相柳降世"
		end
        NEWTXWZ(str,color)
		if WAR.DSW[pid]~=nil then
		WAR.DSXF = math.random(1,4)
		local tt = {"息吹之岚","干枯大地","荒狂雷光","炎之命运"}
		local txdh ={165,163,131,58}
		WAR.JZTX = txdh[WAR.DSXF]
		local str = "大蛇奥义".."——"..tt[WAR.DSXF]
		local cl = {M_Yellow,M_SandyBrown,LightPurple,TG_Red_Bright}
		color = cl[WAR.DSXF]
		Cls()
		NEWTXWZ(str,color)
		if WAR.DSXF == 1 then
		WAR.BCH = 1
		WAR.BLX = 1
		WAR.GTSHAQI = WAR.GTSHAQI + 50
		WAR.GTPID2 = pid
		elseif WAR.DSXF == 2 then
		WAR.BJ = 1
		elseif WAR.DSXF == 3 then
		WAR.BMB = 1
		else
		WAR.BZS = 1
		end
		local aa = math.modf((WAR.SPXT[pid] or 0)/2)
		  		for i = 1, 6+aa do
			        for j = 1, 6+aa do
			         SetWarMap(x + i - 1, y + j - 1, 4, 1)
			         SetWarMap(x - i + 1, y + j - 1, 4, 1)
			         SetWarMap(x + i - 1, y - j + 1, 4, 1)
			         SetWarMap(x - i + 1, y - j + 1, 4, 1)
			        end
		        end
		
		
		end
	end	
	
	if wglw(pid,3)>2 and wugong == 3  and JLSD(10,60,pid) then
		WAR.WDMZ2 = math.random(1,3)
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·".."五毒奥义.蛇咬"
		else
			WAR.Person[id]["特效文字1"] = "五毒奥义.蛇咬"
		end
		WAR.Person[id]["特效动画"] = 64
	end		

	if wglw(pid,3)>2 and wugong == 3 and JLSD(10,30+JY.Base["天书数量"]*5,pid) then
		WAR.WDMZ4 = math.random(1,3)
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·".."五毒奥义.猩红毒针"
		else
			WAR.Person[id]["特效文字1"] = "五毒奥义.猩红毒针"
		end
		WAR.Person[id]["特效动画"] = 67
	end	
	
	if match_ID(pid,60) and (wugong == 81 or  kfkind == 6 ) and JLSD(10,60,pid) then
		WAR.OYF = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·潜影灵蛇"
		else
			WAR.Person[id]["特效文字1"] = "潜影灵蛇"
		end
	end	
	
	--郭靖，降龙连击时随机后劲，有余不尽
	if match_ID(pid, 55) and wugong == 26 and WAR.ACT > 1 then
		local txwz = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一","十二","十三"}
		if inteam(pid) then
			WAR.YYBJ = math.random(0, JY.Base["天书数量"])
			if WAR.YYBJ > 13 then
				WAR.YYBJ = 13
			end
			--保底天书数量-7
			if JY.Base["天书数量"] > 7 then
				if WAR.YYBJ < JY.Base["天书数量"] - 7 then
					WAR.YYBJ = JY.Base["天书数量"] - 7
				end
			end
		else
			WAR.YYBJ = math.random(1, 10)
		end
		if WAR.YYBJ > 0 then
			ng = ng + WAR.YYBJ*150
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "降龙·有余不尽·"..txwz[WAR.YYBJ].."重后劲".."+"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "降龙·有余不尽·"..txwz[WAR.YYBJ].."重后劲"
			end
		end
	end

	if nglw(pid, 104)>1 and WAR.NGJL>0 and JLSD(20,60,pid) then
		local txwz = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一","十二","十三"}
        WAR.BLQJ = math.random(1,13)
		if WAR.BLQJ > 0 then
			ng = ng + WAR.BLQJ*150
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = "逆运·奔流气劲·"..txwz[WAR.BLQJ].."重后劲".."+"..WAR.Person[id]["特效文字1"]
			else
				WAR.Person[id]["特效文字1"] = "逆运·奔流气劲·"..txwz[WAR.BLQJ].."重后劲"
			end
		end
	end
	
--阿青，天元剑气
if match_ID(pid,604) and kfkind==3 then
WAR.TYJQ=1
Set_Eff_Text(id,"特效文字1","天元剑气")
 end



 
--林朝英，流风回雪
if match_ID(pid,605) and JLSD(20,80,pid) then
WAR.LFHX=1
Set_Eff_Text(id,"特效文字3","流风回雪")
end

--莫大，潇湘夜雨
if match_ID(pid,20) and JLSD(20,80,pid) then
WAR.XXYY=1
Set_Eff_Text(id,"特效文字1","潇湘夜雨")
end
	
	
	--七夕黄蓉，打狗缠字诀
	if wugong == 80 and match_ID(pid, 613) then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+打狗棒法·缠字诀"
		else
			WAR.Person[id]["特效文字1"] = "打狗棒法·缠字诀"
		end
	end

	--进阶泰山，使用后20时序内闪避
	if (wugong == 31 and nglw(pid, 89)>=1) or WAR.L_WYJFA1 == 2 then
		WAR.TSSB[pid] = 20
	end

	if  WAR.L_WYJFA1 == 2 then
		WAR.L_HQNZL[pid] = limitX((WAR.L_HQNZL[pid] or 0) + 10 , 0, 30)
	end	
	
	--主运天罗地网，减少敌方移动
	if Curr_QG(pid,148) then
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+柔网势"
		else
			WAR.Person[id]["特效文字1"] = "柔网势"
		end
	end

	--主运太玄：太玄之重，不加怒
	if (Curr_NG(pid, 102) or match_ID(pid,39)) and JLSD(20, 70 + JY.Base["天书数量"] + math.modf(JY.Person[pid]["实战"]/50), pid) then
		WAR.TXZZ = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·太玄之重"
		else
			WAR.Person[id]["特效文字1"] = "太玄之重"
		end
    end
	
	--周伯通空明之武道使敌方不会护体，初始几率25%，每20点实战+1%几率
	if match_ID(pid, 64) and JLSD(20, 45 + math.modf(JY.Person[pid]["实战"]/20), pid) then
	    local str = ""
		WAR.KMZWD = 1
		if  match_ID_awakened(pid, 64,1) and JLSD(20, 45 + math.modf(JY.Person[pid]["实战"]/20), pid) then
		WAR.KMZWD = 2
		str = "极限."
		end
		if  D2ZBT(pid) and JLSD(20, 45 + math.modf(JY.Person[pid]["实战"]/20), pid) then
		WAR.KMZWD = 2
		str = "真武."
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = str.."空明之武道·"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = str.."空明之武道"
		end
    end
	
	--九剑真传，剑法主动攻击70%几率触发4种特效之一
	--七夕令狐冲自带
	if ((pid == 0 and JY.Person[592]["论剑奖励"] == 1 and JLSD(15, 85,pid))
		or match_ID(pid, 610) or D3FQY(pid) or match_ID_awakened(pid,592,1))
		and kfkind == 3 then
		local t = math.random(4)
		local wz = {"离剑式","倒剑式","撩剑式","荡剑式"}
		if D3FQY(pid) or wglw(pid,47)>2 then
		   t = math.random(5)
		   wz = {"真离剑式","真倒剑式","真撩剑式","真荡剑式","四剑合一"}
		   	if WAR.L_DGQB_X >= 10 then
	  		WAR.L_DGQB_X = 10;
	  	    else
	  		WAR.L_DGQB_X = WAR.L_DGQB_X + 1;
	  	    end
		end
		WAR.JJZC = t
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+九剑真传·"..wz[t]
		else
			WAR.Person[id]["特效文字1"] = "九剑真传·"..wz[t]
		end
	end


	 if D3FQY(pid) or match_ID_awakened(pid,592,1) then

    	local num = WAR.L_DGQB_X;
    	local n = 0;
    	local person = {};
    	--清掉之前的范围
  		--CleanWarMap(4, 0)
  		
  		
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
          n = n + 1
					person[n] = i;
          
        end
      end
      
      --根据不同的X攻击不同的敌人
      if n <= num or WAR.L_DGQB_X >= 10 then
      	for i=1, n do
      		SetWarMap(WAR.Person[person[i]]["坐标X"], WAR.Person[person[i]]["坐标Y"], 4, 1)
      	end
      else
      	while num > 0 do
      		local t = math.random(n);
      		if person[t] ~= nil then
      			SetWarMap(WAR.Person[person[t]]["坐标X"], WAR.Person[person[t]]["坐标Y"], 4, 1)
      			person[t] = nil;
      			num = num - 1;
      		end
      	end
      end
      
      
	  local str = WAR.L_DGQB_ZS[limitX(WAR.L_DGQB_X,1, 10)]
	  		if WAR.Person[id]["特效文字2"] ~= nil then
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "·"..str
			else
				WAR.Person[id]["特效文字2"] = str
			end
      Cls()
      ShowScreen()
      if WAR.L_DGQB_X >= 10 then		--独孤求败发动极意后，恢复５００命，２０００内力，内伤和中毒减半
	      WAR.Person[id]["生命点数"] = (WAR.Person[id]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", 500);
	      WAR.Person[id]["内力点数"] = (WAR.Person[id]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", 2000);
	      WAR.Person[id]["中毒点数"] = (WAR.Person[id]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", -50);
		  WAR.Person[id]["内伤点数"] = (WAR.Person[id]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", -50);
				WAR.Person[id]["特效动画"] = 6
	      for i = 12, 24 do
	        NewDrawString(-1, -1, str, C_GOLD, CC.DefaultFont + i)
	        ShowScreen()
	        if i == 24 then
	          Cls()
	          NewDrawString(-1, -1, str, C_GOLD, CC.DefaultFont + i)
	          ShowScreen()
	          lib.Delay(500)
	        else
	          lib.Delay(1)
	        end
	      end
		  WAR.L_DGQB_X = 0
	    end
  	end
	
	--琴棋书画：持瑶琴，不加怒
	if wugong == 73 and QinqiSH(pid) then
		WAR.QQSH1 = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·琴音悦耳"
		else
			WAR.Person[id]["特效文字1"] = "琴音悦耳"
		end
		--50%几率触发清怒
		if JLSD(20, 70, pid) then
			WAR.QQSH1 = 2
			if WAR.Person[id]["特效文字1"] ~= nil then
				WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "·菩提清心"
			else
				WAR.Person[id]["特效文字1"] = "菩提清心"
			end
		end
    end
	
	--琴棋书画：妙笔丹青，冰封
	if wugong == 142 and QinqiSH(pid) then
		--60%几率冰封
		if JLSD(20, 80, pid) then
			WAR.QQSH2 = 1
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·画地为牢"
			else
				WAR.Person[id]["特效文字3"] = "画地为牢"
			end
		end
		
		--30%几率大冰封
		if JLSD(30, 60, pid) then
			WAR.QQSH2 = 2
			if WAR.Person[id]["特效文字3"] ~= nil then
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·江山如画"
			else
				WAR.Person[id]["特效文字3"] = "江山如画"
			end
		end
	end
	
	--琴棋书画：一阳指书，50%几率出特效，伤害提高20%，必封穴
	if wugong == 182 and QinqiSH(pid) and JLSD(20, 70, pid) then
		WAR.QQSH3 = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·秉笔直书"
		else
			WAR.Person[id]["特效文字3"] = "秉笔直书"
		end
	end

	--鹤笔翁，玄冥50%几率出特效，伤害提高20%，必封穴
	if wugong == 21 and match_ID(pid, 643) and JLSD(20, 70, pid) then
		WAR.QQSH3 = 1
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·鹤发直笔"
		else
			WAR.Person[id]["特效文字3"] = "鹤发直笔"
		end
	end
	
	if WAR.QQSH3 ==1 and wglw(pid,182)>1  then
	    local str = "神仙笔"
		WAR.SXB = math.random(1,4)
		local tt = {"【石】","【蝎】","【冰】","【炎】"}
		str = str..tt[WAR.SXB]
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .."+"..str
		else
			WAR.Person[id]["特效文字0"] = str
		end			
	end

	if WAR.YTTL == 1 and wglw(pid,84)>1 and WAR.NGJL>0  then
	    local str = "写意同调"
		WAR.SXB2 = math.random(1,2*wglw(pid,84)-2)
		local tt = {"【屠龙刀.武林至尊】","【倚天剑.谁与争锋】","【开山斧.披荆斩棘】","【憾地锤.地动山摇】","【身随书意.无限剑制】"}
		if WAR.LQZ[pid]~=nil and WAR.LQZ[pid] == 100 and wglw(pid,84)>2 then
		WAR.SXB2 = 5 
		end
		if WAR.SXB2 == 5 then
		WAR.L_TLD = 1
		WAR.BJ = 1
		WAR.BLX = 1
		WAR.HDMC = 3		
		elseif WAR.SXB2 == 1 then
		WAR.L_TLD = 1
		WAR.BJ = 1
		WAR.HDMC = 2
		elseif WAR.SXB2 == 2 then
		WAR.BLX = 1
		WAR.HDMC = 3
		end
        str = str..tt[WAR.SXB2]
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .."+"..str
		else
			WAR.Person[id]["特效文字1"] = str
		end			
	end

	--鹿杖客，玄冥暴击则额外气攻
	if wugong == 21 and match_ID(pid, 644) and WAR.BJ == 1 then
		ng = ng + 1200
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "·白鹿角杖"
		else
			WAR.Person[id]["特效文字3"] = "白鹿角杖"
		end
	end
	
	--主运玉女：夭矫空碧，连击伤害杀气不减
	if Curr_NG(pid, 154) and WAR.ACT > 1 and JLSD(30, 60 + JY.Base["天书数量"]*2, pid) then
		WAR.YNXJ = 1
		if WAR.Person[id]["特效文字0"] ~= nil then
			WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "+夭矫空碧"
		else
			WAR.Person[id]["特效文字0"] = "夭矫空碧"
		end
    end


	
    --怒气暴发，气攻+1200
    if WAR.LQZ[pid] == 100 and WAR.DZXY ~= 1 then
		WAR.Person[id]["特效动画"] = 6
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+会心之一击"
		else
			WAR.Person[id]["特效文字1"] = "会心之一击"   --会心之一击
		end
		ng = ng + 1200
		if  WAR.ARJY_LZ == 2 and wugong == 25 and wglw(pid,25)>2  then
        ng = ng + 1200 
	    end
		if WAR.GSSL[pid]~=nil and WAR.GSSL[pid] == 1 and yongdao(wugong) then
		WAR.QSLX_SY = 1
			if WAR.Person[id]["特效文字0"] ~= nil then
				WAR.Person[id]["特效文字0"] = WAR.Person[id]["特效文字0"] .. "血煞.瞬狱斩"
			else
				WAR.Person[id]["特效文字0"] = "血煞.瞬狱斩"
			end
		end
		WAR.Person[id]["特效动画"] = 78
		if D1ZSF(pid) and WAR.LSQL[pid]~= nil and WAR.LSQL[pid] == 1 then
		WAR.Person[id]["特效动画"] = 93
		WAR.LSQL[pid] = nil
		WAR.GTJIQI = 1005
		WAR.GTPID = pid
		WAR.TJZX[pid] = 5
		WAR.BG[pid] = 500
			if WAR.Person[id]["特效文字2"] ~= nil then
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+纯阳真解.龙蛇起陆"
			else
				WAR.Person[id]["特效文字2"] = "纯阳真解.龙蛇起陆"
			end
		end

    end
	
	--全真七子，天罡北斗阵，文字显示
	if WAR.ZDDH == 73 then
		if (pid >= 123 and pid <= 128) or pid == 68 then
			WAR.Person[id]["特效动画"] = 93
			if WAR.Person[id]["特效文字2"] ~= nil then
				WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+天罡北斗阵加力"
			else
				WAR.Person[id]["特效文字2"] = "天罡北斗阵加力"
			end
		end
	end
	
    --蓄力攻击
    if WAR.Actup[pid] ~= nil then
    	--主运龙象或蛤蟆，追加杀气
		if Curr_NG(pid, 103) or Curr_NG(pid, 95) then
			ng = ng + 1200
		else
			ng = ng + 600
		end
		local str = "蓄力攻击"
		if WAR.SLSX[pid] ~= nil then
			str = str .. "·十龙十象"
		end
		if MPPD(pid) == 4 and MPPB_MZ(pid) == 1 then
		    local mpdj = MPDJ(pid)
		    ng = ng + mpdj*200
	    end
		if nglw(pid,102)>1 and JLSD(0,40,pid) then----
			str = str .. "·玄妙境界"
			WAR.LUCK[pid] = (WAR.LUCK[pid] or 0) + 30
		end
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+"..str
		else
			WAR.Person[id]["特效文字1"] = str
		end
    end  
  
    --九阴神功加力时，使用九阴白骨爪出九阴神爪
	if wugong == 11 and (WAR.NGJL == 107 or (JLSD(10,60,pid) and wglw(pid,11)>=1)) then
		WAR.WS = 1
		ng = ng + 2000
		local str = "九阴神爪"
		if wglw(pid,11)>=1 then
		   if wglw(pid,11)>2 and math.random(1,2) == 1 then
		      WAR.JYBG = 2
		      ng = ng + 1000
			  str = "九阴魔爪"
		   elseif JY.Person[id]["品德"] < 50 then
			  str = "九阴魔爪"
		      WAR.JYBG = 2
		   end
		   if WAR.JYBG == 1 then
		   ng = ng + 2000
		   end
		end
		if WAR.Person[id]["特效文字3"] ~= nil then
			WAR.Person[id]["特效文字3"] = str.."·"..WAR.Person[id]["特效文字3"]
		else
			WAR.Person[id]["特效文字3"] = str
		end
	end
 
	if match_ID_awakened(pid,152,1)  then --萧秋水几率3-5连击，出招式，随机杀气
		if WAR.WCLJ > 0  then 
			local ARSSJY = {"夺魄","噬灵","灭魂","追命"}
			if WAR.Person[id]["特效文字3"] == nil then
				WAR.Person[id]["特效文字3"] = ARSSJY[math.random(4)]	
			else
				WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"].."+"..ARSSJY[math.random(4)]	
			end
			ng = ng + math.random(1000, 2000)
		end
	end
 
    --屠龙刀特效一，追加等同于武功威力的杀气
  	if WAR.L_TLD == 1 then
		ng = ng + get_skill_power(pid, wugong, 11)
  	end
 
   	if WAR.L_TLD1 == 1 then
		ng = ng + get_skill_power(pid, wugong, 11)
  	end
 
  	if wglw(pid,65)>1  and  wugong == 65 and  JLSD(20, 80, pid) then
		ng = ng + get_skill_power(pid, wugong, 11)
		WAR.RMDY=math.random(1,3)
		local BDQS = {".野火燎原", ".薪火不灭", ".烈焰焚城"}
		WAR.Person[id]["特效动画"] = 126
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+".."燃木刀意"..BDQS[WAR.RMDY]
		else
			WAR.Person[id]["特效文字1"] = "燃木刀意"..BDQS[WAR.RMDY]
		end
		if WAR.RMDY==1 then----
           for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
			    WAR.ZSXS[WAR.Person[j]["人物编号"]] = 1
          local tmppid = WAR.Person[j]["人物编号"]
		  JY.Person[tmppid]["灼烧程度"]=limitX((JY.Person[tmppid]["灼烧程度"] or 0) + 30,0,50)
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		   end
		end
  	end

  	if wglw(pid,5)>=1  and  wugong == 5 then
		WAR.HBMZ=1
		local str = "冻气.千羽冰翔"		
        if wglw(pid,5)>=2 and WAR.ACT>1 and WAR.BSFW[pid] ~=nil  then
        reseteffect2(WAR.BSFW, pid, 1)
		WAR.BSYJ[pid] = (WAR.BSYJ[pid] or 0) + 10*wglw(pid,5)
        end	
		if wglw(pid,5)>2 and  JLSD(20, 80, pid) then
		WAR.HBMZ=2
		str = "寒霜.魔镜冰晶"
           if WAR.BSYJ[pid]~=nil then
		      WAR.HBMZ=3
		      str = "奥义.青霄悯霜掌"
		      local color = M_DeepSkyBlue
              NEWTXWZ(str,color)
           end		   
		end
        addeffect(WAR.BSFW, pid, 1)			
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = WAR.Person[id]["特效文字1"] .. "+".. str
		else
			WAR.Person[id]["特效文字1"] = str
		end
		WAR.Person[id]["特效动画"] = 115 + WAR.HBMZ
  	end

 
   	if wglw(pid,65)>2  and  wugong == 65 and  JLSD(20, 80, pid) then
		WAR.RMDY2=1
		WAR.Person[id]["特效动画"] = 117
		if WAR.Person[id]["特效文字2"] ~= nil then
			WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+".."燃木真髓.荒燎"
		else
			WAR.Person[id]["特效文字2"] = "燃木真髓.荒燎"
		end
  	end
 
    --特效文字1，动画为红色圈
    if WAR.Person[id]["特效文字1"] ~= nil and WAR.Person[id]["特效动画"] == -1 then
		WAR.Person[id]["特效动画"] = 88
    end
	
	--北斗七闪的特效动画
	if match_ID(pid, 129) and WAR.CYZX[pid] ~= nil and WAR.BDQS > 0 then
		WAR.Person[id]["特效动画"] = 126
	end

	if wglw(pid,58)>1 and WAR.XLD[pid] ~= nil and WAR.XLEB > 0 then
        WAR.Person[id]["特效动画"] = 131
	end	

	--苗人凤破军的动画和文字
	if match_ID_awakened(pid, 3,1) and JLSD(10,40,pid) then
	WAR.MRF = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "凰舞·"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "凰舞"
		end
		WAR.Person[id]["特效动画"] = 120
	end

	if match_ID_awakened(pid, 3,1) and JLSD(10,70,pid) and JY.Person[3]["论剑奖励"] == 2 then
	    WAR.MRF1 = 1
		if WAR.Person[id]["特效文字1"] ~= nil then
			WAR.Person[id]["特效文字1"] = "幻胧魔凰剑·"..WAR.Person[id]["特效文字1"]
		else
			WAR.Person[id]["特效文字1"] = "幻胧魔凰剑"
		end
		WAR.Person[id]["特效动画"] = 120
	end
	
	--无酒不欢的特效动画
	if pid == 0 and JY.Base["特殊"] == 1 then
		WAR.Person[id]["特效动画"] = 132
	end
	
    --无酒不欢：独孤求败的先手反击
	if WAR.ACT == 1 then
		local hit_DGQB;
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 592) then
							hit_DGQB = emeny
							break;
						end
					end
				end
			end
			if hit_DGQB ~= nil then
				break;
			end
		end
		
		if hit_DGQB ~= nil then
			local pre_target_list = {}
			local pre_target_num = 0
			local tx_1 = WAR.Person[id]["特效文字0"] or nil
			local tx_2 = WAR.Person[id]["特效文字1"] or nil
			local tx_3 = WAR.Person[id]["特效文字2"] or nil
			local tx_4 = WAR.Person[id]["特效文字3"] or nil
			local tx_5 = WAR.Person[id]["特效文字4"] or nil
			local tx_6 = WAR.Person[id]["特效动画"]
			WAR.Person[id]["特效文字0"] = nil
			WAR.Person[id]["特效文字1"] = nil
			WAR.Person[id]["特效文字2"] = nil
			WAR.Person[id]["特效文字3"] = nil
			WAR.Person[id]["特效文字4"] = nil
			WAR.Person[id]["特效动画"] = -1
			WAR.hit_DGQB = 1
			WAR.Person[hit_DGQB]["特效动画"] = 83
			for i = 0, CC.WarWidth - 1 do
				for j = 0, CC.WarHeight - 1 do
					local pre_effect = GetWarMap(i, j, 4)
					if pre_effect > 0 then
						local pre_target = GetWarMap(i, j, 2)
						pre_target_num = pre_target_num + 1
						pre_target_list[pre_target_num] = {i, j, pre_target, pre_effect}
					end
				end
			end
			CleanWarMap(4, 0)
			local s1 = WAR.CurID
			WAR.CurID = hit_DGQB
			WAR.Effect = 2
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local pid = WAR.Person[WAR.CurID]["人物编号"]
					local eid = WAR.Person[i]["人物编号"]
					local dam;
					dam = First_strike_dam_DG(pid, eid)
					if dam > 0 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - dam
						SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
					end
				end
			end
			WAR.ShowHP = 0
			War_ShowFight(WAR.Person[hit_DGQB]["人物编号"], 0, 0, 0, 0, 0, 60, -1)
			WAR.ShowHP = 1
			WAR.hit_DGQB = 0
			WAR.Person[hit_DGQB]["特效动画"] = -1
			
			--如果被上一步反击死亡，那么该人物的攻击就结束了
			if JY.Person[WAR.Person[s1]["人物编号"]]["生命"] <= 0 then
				return 1
			else		
				WAR.CurID = s1
				CleanWarMap(4, 0)
				WAR.Effect = 0
				for i = 1, pre_target_num do
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 2, pre_target_list[i][3])
					SetWarMap(pre_target_list[i][1], pre_target_list[i][2], 4, pre_target_list[i][4])
				end
				WAR.Person[id]["特效文字0"] = tx_1
				WAR.Person[id]["特效文字1"] = tx_2
				WAR.Person[id]["特效文字2"] = tx_3
				WAR.Person[id]["特效文字3"] = tx_4
				WAR.Person[id]["特效文字4"] = tx_5
				WAR.Person[id]["特效动画"] =  tx_6
			end
		end
	end



	--幻光步
	if WAR.ACT < 10 then 
		local hit_DGQB;
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 447) and math.random(10)<4 then
							hit_DGQB = emeny
							break;
						end
					end
				end
			end
			if hit_DGQB ~= nil then
				break;
			end
		end
		    			if hit_DGQB ~= nil then
						lib.Delay(50)
						local tmppid = WAR.CurID	
						      WAR.CurID = hit_DGQB	
						CurIDTXDH(WAR.CurID, 93,1,"忍法.空蝉")
						local ax, ay = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
						if inteam(WAR.Person[WAR.CurID]["人物编号"]) then
                           War_CalMoveStep(WAR.CurID, 12, 1) --武功移动步数
                           local nx, ny = nil, nil
                           while true do
	                       nx, ny = War_SelectMove() --显示+选择步数
	                           if nx ~= nil then
		      if lib.GetWarMap(nx, ny, 2) > 0 or lib.GetWarMap(nx, ny, 5) > 0 then
		        QZXS("此处有人！请重新选择")			--此处有人！请重新选择
	      	elseif CC.SceneWater[lib.GetWarMap(nx, ny, 0)] ~= nil then
	        	QZXS("水面，不可进入！请重新选择")		--水面，不可进入！请重新选择
	else   
	break;
	end
	end
	end
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
	    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 93,1)
						else
						WAR.KHYX[WAR.Person[WAR.CurID]["人物编号"]] = {ax,ay}
		                War_AutoKHYX()
						end
						WAR.CurID = tmppid
						lib.Delay(200)			
	    			--end
					end	
		
	end
	
	--李秋水无相转身，没有触发过，或者分身已死，才可触发，有30%几率触发
	if (WAR.WXFS == nil or (WAR.WXFS ~= nil and WAR.Person[WAR.WXFS]["死亡"] == true)) and math.random(10) < 4 then
		local lqs_WXZS;
		for i = 0, CC.WarWidth - 1 do
			for j = 0, CC.WarHeight - 1 do
				local effect = GetWarMap(i, j, 4)
				if 0 < effect then
					local emeny = GetWarMap(i, j, 2)
					if emeny >= 0 and emeny ~= WAR.CurID then
						--仅限畅想主角触发
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 118) and WAR.Person[emeny]["人物编号"] == 0 then
							lqs_WXZS = emeny
							SetWarMap(i, j, 4, 0)
							break;
						end
					end
				end
			end
		end
		
		if lqs_WXZS ~= nil then
			
			--ID临时交给李秋水
			local s = WAR.CurID
			WAR.CurID = lqs_WXZS
			local wxlox, wxloy;
			War_CalMoveStep(WAR.CurID, 10, 0)
			local function SelfXY(x, y)
				local yes = 0
				if x == WAR.Person[WAR.CurID]["坐标X"] then
					yes = yes +1
				end
				if y == WAR.Person[WAR.CurID]["坐标Y"] then
					yes = yes +1
				end
				if yes == 2 then
					return true
				end
				return false
			end
	        local x, y = nil, nil
	        while true do
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					wxlox, wxloy = x, y
					break;
				--ESC退出
				else
					WAR.ShowHead = 0
					x, y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					--wxlox, wxloy = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					break;
				end
			end
			--不在自身位置才能触发幻象
			if SelfXY(x, y) == false then
				SetWarMap(wxlox, wxloy, 4, 0)
				--本场还没触发过无相转身，则加入新人物
				if WAR.WXFS == nil then
					WAR.Person[WAR.PersonNum]["人物编号"] = 600
					WAR.Person[WAR.PersonNum]["我方"] = WAR.Person[WAR.CurID]["我方"]
					WAR.Person[WAR.PersonNum]["坐标X"] = wxlox
					WAR.Person[WAR.PersonNum]["坐标Y"] = wxloy
					WAR.Person[WAR.PersonNum]["死亡"] = false
					WAR.Person[WAR.PersonNum]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
					WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)
					lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[600]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[600]["头像代号"]), 4 + WAR.PersonNum)
					WAR.tmp[5000+WAR.PersonNum] = JY.Person[600]["头像代号"]
					WAR.JQSDXS[600] = 0	--直接指定集气，以免召唤出来马上被斗转跳出
					WAR.WXFS = WAR.PersonNum
					WAR.PersonNum = WAR.PersonNum + 1
				--已经触发过，则让分身复活
				else
					WAR.Person[WAR.WXFS]["死亡"] = false
					WAR.Person[WAR.WXFS]["我方"] = WAR.Person[WAR.CurID]["我方"]
					WAR.Person[WAR.WXFS]["坐标X"] = wxlox
					WAR.Person[WAR.WXFS]["坐标Y"] = wxloy
					WAR.Person[WAR.WXFS]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
					WAR.Person[WAR.WXFS]["贴图"] = WarCalPersonPic(WAR.WXFS)
					JY.Person[600]["生命"] = JY.Person[600]["生命最大值"]
					JY.Person[600]["内力"] = JY.Person[600]["内力最大值"]
					JY.Person[600]["体力"] = 100
					JY.Person[600]["受伤程度"] = 0
					JY.Person[600]["中毒程度"] = 0
					JY.Person[600]["冰封程度"] = 0
					JY.Person[600]["灼烧程度"] = 0
					WAR.Person[WAR.WXFS].Time = 0
					--流血
					if WAR.LXZT[600] ~= nil then
						WAR.LXZT[600] = nil
					end
					--封穴
					if WAR.FXDS[600] ~= nil then
						WAR.FXDS[600] = nil
					end
				end
		  
				--清除自身位置贴图
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)

				--修改自身与幻象坐标
				WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"] = WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"],WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
					
				--增加幻象贴图
				SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 5, WAR.Person[WAR.WXFS]["贴图"])
				SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 2, WAR.WXFS)

				--增加自身贴图
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			end
			WarDrawMap(0)
			CurIDTXDH(WAR.CurID, 90,1,"无相转身")
				
			--还原ID并打断连击
			WAR.CurID = s
			WAR.ACT = 10
		end
	end
	
    --计算伤害的敌人
    for i = 0, CC.WarWidth - 1 do
		for j = 0, CC.WarHeight - 1 do
			lib.GetKey()
			local effect = GetWarMap(i, j, 4)
			if 0 < effect then
				local emeny = GetWarMap(i, j, 2)
				if 0 <= emeny and emeny ~= WAR.CurID then		--如果有人，并且不是当前控制人
				local eid = WAR.Person[emeny]["人物编号"]
				local enemyid = emeny
					--触发逆转乾坤的情况下，无误伤特效和合击依然会打到自己人
					if (WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] ) or (ZHEN_ID < 0 and WAR.WS == 0) or WAR.NZQK > 0 or WAR.WXXY1>0  or WAR.NZQK1 > 0 then
						if  WAR.HIDE2[eid] ~= nil then
						
						elseif JY.Wugong[wugong]["伤害类型"] == 1 and (fightscope == 0 or fightscope == 3) then
							if level == 11 then
								level = 10
							end
							--无酒不欢：这里需要完善修改
							--WAR.Person[emeny]["内力点数"] = (WAR.Person[emeny]["内力点数"] or 0) - War_WugongHurtNeili(emeny, wugong, level)
							SetWarMap(i, j, 4, 3)
							WAR.Effect = 3
						else
	
		--无酒不欢：葵花移行
	if Curr_NG(eid, 105) then
		--葵花尊者必定移形
		if JLSD(70, 80, eid) or (WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 and eid == 27 and JLSD(30, 80, eid)) or (KUIHUA(eid) == 2 and JLSD(30, 80, eid) ) then
			WAR.Dodge = 1
			WAR.Person[enemyid]["特效文字2"] = "真.葵花移形"
			WAR.Person[enemyid]["特效动画"] = 89
		end
	end
		--被刺目，伤害为0
	if WAR.KHCM[pid] == 2 then
		WAR.Dodge = 1
	end

	if WAR.KHCM3[pid] ~= nil then
		WAR.Dodge = 1
	end
	
	if match_ID_awakened(eid,75,1) then--
	   if JY.Person[eid]["轻功"] >= 350 and JLSD(30, 55, eid) then 

		WAR.Dodge = 1
		
	end
	end
	
	--无酒不欢：神行百变，12%几率闪避
	if Curr_QG(eid, 146) then
		local c_up = 0
		--袁承志觉醒后，闪避率+5%
		if match_ID_awakened(eid, 54, 1) then
			c_up = 5
			if JY.Person[54]["品德"] == 80 then
			c_up = 15
			end
		end
		if qglw(eid,146)> 0 then
			c_up = c_up  + qglw(eid,146) * 5
		end
		if JLSD(50, 62+c_up, eid) then
			WAR.Dodge = 1
			WAR.Person[enemyid]["特效文字2"] = "神行百变"
			WAR.Person[enemyid]["特效动画"] = 88
		end
	end

	
	--无酒不欢：凌波微步，15%几率闪避
	if Curr_QG(eid, 147) then
		if JLSD(50, 65+qglw(eid,147)*5, eid) then
			WAR.Dodge = 1
			WAR.Person[enemyid]["特效文字2"] = "凌波微步"
			WAR.Person[enemyid]["特效动画"] = 90
			if qglw(eid,147)>= 1  then
			WAR.ACT = 10
			   if JY.Person[eid]["性别"] == 1 then
			   WAR.L_HQNZL[eid] = 30
			   elseif JY.Person[eid]["性别"] == 2 then
			   WAR.SJSD[pid] = 10
			   else
			   WAR.FXDS[pid] = (WAR.FXDS[pid] or 0) + 10
			   if WAR.FXDS[pid]>= 50 then
			   WAR.FXDS[pid] = 50
			   end
			   WAR.FXXS[pid] = 1
			   WAR.PJFY[pid] = 10
			   end
			   if qglw(eid,147)>= 2  then
			   WAR.DJDQ1[eid] = 1			   
			   end
			end
		end
	end
  
	--祖千秋
	if match_ID(eid, 88) and JLSD(35, 65, eid) then
		WAR.Dodge = 1
		WAR.Person[enemyid]["特效文字2"] = "酒神秘踪步"	
		WAR.Person[enemyid]["特效动画"] = 89
	end

	if WAR.PMWZ[eid]~=nil then
		local tjzx = WAR.PMWZ[eid] or 0
		if JLSD(10, 10+tjzx-10, eid) then
		WAR.Dodge = 1
		WAR.Person[enemyid]["特效文字2"] = "身形缥缈"	
		WAR.Person[enemyid]["特效动画"] = 89
		end
	end

		--祖千秋
	if match_ID(eid, 643) and JLSD(35, 65, eid) then
		WAR.Dodge = 1
		WAR.Person[enemyid]["特效文字2"] = "鹤笔.无酒不欢"	
		WAR.Person[enemyid]["特效动画"] = 89
	end
		
	--段誉 指令
	if match_ID(eid, 53) then
		if WAR.TZ_DY == 1 and JLSD(20, 70, eid) then
			WAR.Dodge = 1
			WAR.Person[enemyid]["特效文字2"] = "凌波微步"
			WAR.Person[enemyid]["特效动画"] = 90
		end
	end
	
	--黄蓉奇门遁甲，紫色闪避
	if WAR.Person[enemyid]["我方"] == true and GetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"],6) == 4 and JLSD(30, 60, eid) then
		WAR.Dodge = 1
	end
 
 	--进阶泰山，使用后20时序内闪避
	if WAR.TSSB[eid] ~= nil and JLSD(40, 60, eid) then
		WAR.Dodge = 1
		WAR.Person[enemyid]["特效文字2"] = "峻岭横空"
		WAR.Person[enemyid]["特效动画"] = 89
	end
 
	--主角 特系，初始15%闪避，每个奇门练到极，增加5%闪避
	if JY.Base["标准"] == 5 and eid == 0 then
		local gctj = 15
		for i = 1, CC.Kungfunum do
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 5 and JY.Person[0]["武功等级" .. i] == 999 then
				gctj = gctj + 5
			end
		end
		if gctj > 50 then
			gctj = 50
		end
		if JLSD(30, 30 + gctj, eid) then
			WAR.Dodge = 1
			WAR.Person[enemyid]["特效文字1"] = "天机身法"		--天机身法
			WAR.Person[enemyid]["特效动画"] = 88
		end
	end

   if eid == 0 and JY.Base["标准"]>0  and (JLSD(10,15+math.modf(JY.Person[eid]["资质"]/3),eid) or WAR.JYS>0) and JY.Base["天书数量"]>=0 then 
	WAR.Dodge= 1
    WAR.Person[enemyid]["特效文字1"] = "风天流.绝影闪"	--标主绝影闪
    WAR.Person[enemyid]["特效动画"] = 69
	if WAR.JYS>0 then
	WAR.JYS=WAR.JYS-1
	end
	if JY.Base["标准"] == 5 and JLSD(10,30,eid) then
	WAR.JYS=WAR.JYS+1
	end
	end--12.27改	

  if WAR.BHHJ[eid]~=nil then 
	WAR.Dodge= 1
    WAR.Person[enemyid]["特效文字1"] = "魔音.碧海幻影"	--标主绝影闪
    WAR.Person[enemyid]["特效动画"] = 54
    reseteffect(WAR.BHHJ,eid)  
end--12.27改	

   if match_ID(eid,152) then
    local jl = JY.Person[eid]["轻功"]-JY.Person[pid]["轻功"]
	if jl<0 then
	jl=0
	end
	if jl>300 then
	jl=300
	end
    local jl2 = 15 + math.modf(jl/20)
    if JLSD(0,15+jl2,eid) then 
    WAR.Dodge= 1
	end
  end
	
	if WAR.HIDE[eid]~= nil and WAR.HIDE[eid]>0 then
	WAR.Dodge= 1
	end
	if WAR.KHCM2[eid]~= nil and WAR.KHCM2[eid]>0 then
	WAR.Dodge= 1
	end	

    if WAR.LSGY[eid]~=nil and JLSD(10,35,eid) then
	WAR.Dodge= 1 	
	end
	
    if WAR.GSSL[eid]~=nil and WAR.GSSL[eid] == 1 then
	local aa = WAR.SATA[eid] or 0
        if JLSD(10,25+aa*2,eid) then
	    WAR.Dodge= 1 	
	    end	
	end	

	if (MPPB_GB(eid)==1 or MPPB_GB(eid) == 3) and JLSD(10,30+MPDJ(eid)*5,eid) then
	WAR.Dodge= 1
	end

	if math.random(0,10)<6 then	
		for j = 0, WAR.PersonNum - 1 do
				--沙漠效果
				if wglw(WAR.Person[j]["人物编号"], 78)>1 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                   WAR.Dodge = 1
				end
				break
		end
	end	

	    if (WAR.CHZ[pid] or 0)>=75 and JLSD(10,10+(WAR.CHZ[pid] or 0),pid) then
		WAR.Dodge = 1
		end
	
	
	if WAR.Dodge == 1 then
		--阿青听风辨位
		if match_ID(pid, 604) then
			if WAR.TFBW == 0 then
				WAR.TFBW = 1
				if WAR.Person[WAR.CurID]["特效文字0"] ~= nil then
					WAR.Person[WAR.CurID]["特效文字0"] = WAR.Person[WAR.CurID]["特效文字0"].."+听风辨位"
				else
					WAR.Person[WAR.CurID]["特效文字0"] = "听风辨位"
				end
			WAR.Dodge = 0
			end
		--天罗地网
		elseif PersonKF(pid,148) then
			if WAR.TLDWX == 0 then
				WAR.TLDWX = 1
				if WAR.Person[WAR.CurID]["特效文字0"] ~= nil then
					WAR.Person[WAR.CurID]["特效文字0"] = WAR.Person[WAR.CurID]["特效文字0"].."+天罗地网"
				else
					WAR.Person[WAR.CurID]["特效文字0"] = "天罗地网"
				end
			end
		WAR.Dodge = 0
		elseif nomiss(pid) then----
		    WAR.BJ=1
				if WAR.Person[WAR.CurID]["特效文字0"] ~= nil then
					WAR.Person[WAR.CurID]["特效文字0"] = WAR.Person[WAR.CurID]["特效文字0"].."+心眼剑"
				else
					WAR.Person[WAR.CurID]["特效文字0"] = "心眼剑"
				end
		WAR.Dodge = 0
		end
		
		if match_ID_awakened(eid,75,1) then--
	       WAR.Dodge = 1
	    end
		
		 if KUIHUA(eid) == 2 then--
       addeffect2(WAR.XING, eid, nglw(eid,105))
	   WAR.Dodge = 1
        end
		

			if Curr_QG(eid,147) then
			   if WAR.Dodge == 0  then
			   addeffect2(WAR.SATA, eid, 5)
			   if WAR.SATA[eid]>20 + qglw(eid,147)*5 then
			   WAR.SATA[eid] = 20 + qglw(eid,147)*5
			   end
			   if qglw(eid,147)>1 then
			   local aa = (WAR.SATA[eid] or 0)*10
			   WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa)
			   end
			   end
			end	
	    if (WAR.CHZ[eid] or 0)>=75 then
		WAR.Dodge = 0
		end
	end

	
	if WAR.Dodge == 1 then
       for    i = 0, 4 do
				WAR.Person[emeny]["特效文字"..i] = nil
	   end
				WAR.Person[emeny]["特效动画"] = -1
				WAR.Miss[eid] = 1
				WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0)
								--登萍渡水打不中追加连击
	         if wglw(eid,120)>1 and WAR.YDXT[eid]~=nil then
                WAR.CSZT[pid] = 1 
                WAR.Person[emeny]["特效文字2"]="梦蝶.庄生迷情"				
             end
			 if eid==0  and zylw(5)>0  then
			    local aa = zylw(5)*50
                WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa) 
                WAR.Person[emeny].TimeAdd = WAR.Person[emeny].TimeAdd + aa
                if WAR.Person[emeny].TimeAdd >= 1005 then
                WAR.Person[emeny].TimeAdd = 1005
                end				
                WAR.Person[emeny]["特效文字2"]="天机身法.魅影幻灭"				
             end
			 
			 if MPPB_GB(eid)==1 or MPPB_GB(eid) == 3  then--
			 addeffect2(WAR.GBLJ,eid,1)
			 	if WAR.GBLJ[eid]>=5 then
		           WAR.GBLJ[eid] = 5
		        end
			 WAR.Person[emeny]["特效文字2"]="净衣.逍遥身形"
			 end
		  if eid == 0 and JY.Base["标准"]>0 then 
             WAR.Person[emeny]["特效文字1"] = "风天流.绝影闪"
	      end--12.27改
		  
    if match_ID(eid,152)  then
       WAR.Person[emeny]["特效文字2"] = "鬼影迷踪步"	--鬼影迷踪步
    end

			if qglw(eid,146)> 1 then
			addeffect2(WAR.SXBB,eid,1)
			end

			if wglw(eid,2)>= 1 then
			addeffect2(WAR.ZBX,eid,1)
			end

       if WAR.LSGY[eid]~=nil then
	      addeffect2(WAR.LSGY_S,eid,1) 
	      if WAR.LSGY_S[eid]>= 3 then
		  WAR.Person[emeny]["反击武功"] = 51
		  WAR.LSGY_S[eid] = nil
		  end
	   end
	   
	   if WAR.GSSL[eid]~=nil and WAR.GSSL[eid] == 2 then
	      addeffect2(WAR.SATA,eid,1)
		  if WAR.LSGY_S[eid] ~= nil then
		  WAR.Person[emeny]["反击武功"] = 51
		  WAR.LSGY_S[eid] = nil
		  end
	   end

	   if WAR.GSSL[eid]~=nil and WAR.GSSL[eid] == 6 then
	      addeffect2(WAR.SATA,eid,1)
		  if WAR.Person[emeny]["反击武功"] >0 then
		  WAR.Person[emeny]["反击武功"] = 0
		  end
		  WAR.YFZ3[eid] = {eid, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
		  WAR.Person[WAR.CurID]["雷霆"] = WAR.Person[WAR.CurID]["雷霆"] + 200
		  WAR.Person[emeny]["特效文字2"] = "怒雷.返"
	   end
       
	   if wglw(eid, 78)>1 then
         WAR.SHAH[eid] = (WAR.SHAH[eid] or 0) + 200
					if WAR.LQZ[eid] == 100 then
					WAR.SHAH[eid] = (WAR.SHAH[eid] or 0) + 500
					end
					if WAR.SHAH[eid] >= 10000 then
						WAR.SHAH[eid] = 10000
					end
	   end
	   
       if wglw(eid, 78)>2 then
	      if WAR.SHAH[eid]~=nil and WAR.SHAH[eid]>= 2000  then
           WAR.SHAH2[pid] = (WAR.SHAH2[pid] or 0) + 500 + math.modf(WAR.SHAH[eid]/5)
		   WAR.Person[emeny]["特效文字2"] = "守鹤.流沙陷"
		  end
	   end	   
	   
	   WAR.Dodge = 2
		
	elseif match_ID(WAR.Person[emeny]["人物编号"], 605) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then --林朝英轻云蔽月，每50时序可触发一次，免疫伤害10时序，误伤不触发
								if WAR.QYBY[WAR.Person[emeny]["人物编号"]] == nil then
									WAR.QYBY[WAR.Person[emeny]["人物编号"]] = 50
								end
								if WAR.QYBY[WAR.Person[emeny]["人物编号"]] > 40 then
									WAR.Person[emeny]["特效文字3"] = "轻云蔽月"
									WAR.Person[emeny]["特效动画"] = 102
								else
									WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
									WAR.Effect = 2
									SetWarMap(i, j, 4, 2)
								end
							else
								WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) - War_WugongHurtLife(emeny, wugong, level, ng, x, y)
								WAR.Effect = 2
								SetWarMap(i, j, 4, 2)
	end
							
							
							
							
							--沉睡状态的敌人会醒来
							if WAR.CSZT[WAR.Person[emeny]["人物编号"]] ~= nil then
								WAR.CSZT[WAR.Person[emeny]["人物编号"]] = nil
								if WAR.CSSX[WAR.Person[emeny]["人物编号"]] == nil  then
		                           local aa = math.max(math.modf(JY.Person[WAR.Person[emeny]["人物编号"]]["生命"]*0.1),1)
		                           WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[emeny]["人物编号"], "生命", -math.modf(aa))
		                           WAR.CSSX[WAR.Person[emeny]["人物编号"]] = nil
		                        end
							end
						end
					end
				end
			end
		end
    end
	    
	--无酒不欢：标主的大招音效
    local dhxg = JY.Wugong[wugong]["武功动画&音效"]
    if WAR.LXZQ == 1 then
		dhxg = 71
    elseif WAR.HSDF_DF1>0  then
		local txdh = {146,143,144,13}
		dhxg = txdh[WAR.HSDF_DF1]		
    elseif WAR.DJGZ3 >= 1 then
        dhxg = 45
    elseif WAR.JSYX == 1 then
        dhxg = 84
    elseif WAR.ASKD == 1 then
        dhxg = 65
    elseif WAR.GCTJ == 1 then
        dhxg = 108
    elseif WAR.JSTG == 1 then
        dhxg = 119
    elseif WAR.DJJIAN == 1 or WAR.DJGZ2== 2 then
        dhxg = 122
    elseif WAR.LYBF ==1 then
        dhxg = 128
   elseif WAR.LYBF ==2 then
        dhxg = 129
   elseif WAR.LYBF ==3 then
        dhxg = 135
   elseif  WAR.DZDJ1>0     then
        dhxg = 120
   elseif  WAR.DZDJ2>0     then
        dhxg = 137
   elseif  WAR.DZDJ==1 or WAR.DZDJ==2    then
        dhxg = 10
   elseif  WAR.DZDJ==3 or WAR.DZDJ==4      then
        dhxg = 16
    elseif WAR.DJDAO == 1 or WAR.DJGZ2== 3 then
        dhxg = 162
    elseif WAR.YYDAO == 1 then
        dhxg = 67
    elseif WAR.WDLH == 1 then
        dhxg = 89
    elseif WAR.WDLH1 >= 1 then
        dhxg = 95
	elseif WAR.DJGZ2== 1 then
        dhxg = 120
	elseif WAR.DJSX == 1 then
        dhxg = 122
	elseif WAR.DJSX2 == 1 then
        dhxg = 116
	elseif WAR.YY == 1 then
        dhxg = 71
	elseif WAR.YY == 2 then
        dhxg = 73
	elseif WAR.YY2 == 1 then
        dhxg = 93
	elseif WAR.YY2 == 2 then
        dhxg = 94
	elseif WAR.YY2 >= 3 then
        dhxg = 95
	elseif WAR.CHD == 1 then
        dhxg = 127
	elseif WAR.GBWZ3==1  then----
        dhxg = 139
	elseif WAR.WMSF>0 then
	    if WAR.WMSF == 1 then
		   dhxg = 139
		elseif WAR.WMSF == 2 then
		   dhxg = 133
		elseif WAR.WMSF == 3 then
           dhxg = 167
        else
		   dhxg = 163
		end
    end

	if WAR.JZTX>=1 then
	dhxg = WAR.JZTX
	end	
	
	if WAR.JX_QLJJ2>0 then
	local txdh = {61,67,54,75,116}
	WAR.JZTX= txdh[WAR.JX_QLJJ2]
	end
	
	if match_ID_awakened(pid,151,1) and WAR.XKZ>0 and math.random(10)<WAR.XKZ then
		WAR.CXLC = 1
	end	
	
		--狄云赤心连城追加连击
	local CXCS = 3
	if WAR.LUCK[pid]~=nil then
	CXCS = CXCS + 1
	end
	if wglw(pid,162)> 1 then
	CXCS = CXCS + wglw(pid,162)
	end
	if match_ID_awakened(pid,37,1)  then
	CXCS = CXCS + 2
	end
	if (nglw(pid,100)>2  or match_ID_awakened(pid, 129,1)) and Curr_NG(pid,100) and WAR.ACT == 1 then
	   local CXLC=1
	   local a = 0
	   local c = 0
	   if JY.Person[pid]["内力"] > 1000 then
	   a = limitX(math.modf((JY.Person[pid]["内力"]-1000)/10),0,50)  
	   end
	   if JY.Person[pid]["内力"] > 3000 then
	   c = limitX(math.modf((JY.Person[pid]["内力"]-3000)/10),0,50)  
	   end
	   if JLSD(0,a,pid) and WAR.CXLC == 0 then 
       CXLC = CXLC + 1
	   end
	   if JLSD(0,c,pid) and WAR.CXLC == 0 then 
       CXLC = CXLC + 1
	   end
	   if  match_ID_awakened(pid, 129,1) and WAR.BDQS>0 then----
	   CXLC = CXLC + 1
	   end
	   CXCS = CXCS + CXLC
	end
	if WAR.CXLC == 1 and (WAR.CXLC_Count< CXCS or (JY.Person[37]["论剑奖励"] == 2 and match_ID_awakened(pid,37,1) and WAR.ATNum>8 and JLSD(10,80,pid))) and WAR.DZXY~=1 then
		WAR.ATNum = WAR.ATNum + 1
		WAR.CXLC_Count = WAR.CXLC_Count + 1
	end

	
	local CXCS2 = 5
	local XLD_Count = 3
	if JY.Person[pid]["资质"]<=50 then
	   XLD_Count = 5
	   if JY.Person[pid]["资质"]<=31 then
	   XLD_Count = 7
	   end
	end
	
	if WAR.FM_XLD == 1 and WAR.XLD_Count< XLD_Count and WAR.DZXY~=1 then
	    WAR.ATNum = WAR.ATNum + 1
		WAR.XLD_Count = WAR.XLD_Count + 1
	end
	
	if WAR.CXLC2 == 1 and WAR.CXLC_Count2< CXCS2 and WAR.DZXY~=1 then
		WAR.ATNum = WAR.ATNum + 1
		WAR.CXLC_Count2 = WAR.CXLC_Count2 + 1

	end

    if WAR.DGXF == 2 and WAR.DGXF_Count <CXCS2 and WAR.DZXY~=1 then
		WAR.ATNum = WAR.ATNum + 1
		WAR.DGXF_Count = WAR.DGXF_Count + 1
	end

	if WAR.CXLC3 == 1  and WAR.DZXY~=1 then
		WAR.ATNum = WAR.ATNum + 1
	end
	
	--血刀吸血10%，上限100点
	if WAR.XDLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XDLeech);
	end
	
	--韦一笑吸血10%，上限100点
	if WAR.WYXLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.WYXLeech);
	end

	--大日根据灼烧吸血
	if WAR.JWLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.JWLeech);
	end
	
	--天魔功吸血20%
	if WAR.TMGLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.TMGLeech);
	end
	
	if WAR.LKXZLeech > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.LKXZLeech);
	end	
	
	if WAR.DFWMXX >0 then--
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.DFWMXX );  
	end

	if WAR.LHXX >0 then--
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.LHXX );  
	end
	if WAR.LHXX2 >0 then--
	   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", WAR.LHXX2 );  
	end
	
	--血河神鉴回血
	if WAR.XHSJ > 0 then
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XHSJ);
	end
	
	--无酒不欢：人物的攻击动画和点数显示
	War_ShowFight(pid, wugong, JY.Wugong[wugong]["武功类型"], level, x, y, dhxg, ZHEN_ID)
	
	WAR.Dodge = 0
		--活体炸弹，杀人引爆
	if WAR.MJZBZD[1] ~= nil then
		local dam = WAR.MJZBZD[1]
		local ybid = WAR.MJZBZD[2]
		local bpX = WAR.MJZBZD[3]
		local bpY = WAR.MJZBZD[4]
		
		for i = 1, 4 do
			WAR.MJZBZD[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 98
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] == WAR.Person[ybid]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 5 and offset2 <= 5 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						--一灯，避免被爆死
						if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
							JY.Person[65]["生命"] = 1
						end
						--王重阳
						if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
							JY.Person[129]["生命"] = 1
						end
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
							yes = 1
							ybid = i
							bpX = WAR.Person[i]["坐标X"]
							bpY = WAR.Person[i]["坐标Y"]
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end

	if WAR.HTZD[1] ~= nil then
		local dam = WAR.HTZD[1]
		local ybid = WAR.HTZD[2]
		local bpX = WAR.HTZD[3]
		local bpY = WAR.HTZD[4]
		
		for i = 1, 4 do
			WAR.HTZD[i] = nil
		end
		
		local ys_list = {}
		local ys_num = 0
		for i = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
				ys_num = ys_num + 1
				ys_list[ys_num] = {WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]}
			end
		end
		
		local yes = 1
		
		while (yes == 1) do
			yes = 0
			WAR.Person[ybid]["引爆"] = 1
			WAR.Person[ybid]["特效动画"] = 112
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
					local bdid = WAR.Person[i]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
					if offset1 <= 5 and offset2 <= 5 then
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
						JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
						--一灯，避免被爆死
						if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
							JY.Person[65]["生命"] = 1
						end
						--王重阳
						if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
							JY.Person[129]["生命"] = 1
						end
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
							yes = 1
							ybid = i
							bpX = WAR.Person[i]["坐标X"]
							bpY = WAR.Person[i]["坐标Y"]
						end
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
		end
		CleanWarMap(4, 0)
		for i = 1, ys_num do
			SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
		end
	end
	
		--无明业火状态，耗损使用的内力一半的生命
	if WAR.WMYH[pid] ~= nil then
		CurIDTXDH(WAR.CurID, 127,1, "无明业火", C_ORANGE)
		local aa = JY.Wugong[wugong]["消耗内力点数"]
		local nlDam = math.modf((math.modf((level + 3) / 2) * aa)/2)
		local nlDam2 = math.max(nlDam,WAR.NLXH)
		WAR.NLXH = 0
		if WAR.RMZT[pid]~=nil then--
		nlDam2 = math.modf(nlDam2 *(1+0.3*WAR.RMZT[pid]))
		end
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam2)
	end


---阳亢心损
	if WAR.YZSX[pid] ~= nil and WAR.YZSY2[pid] ~= nil then
		CurIDTXDH(WAR.CurID, 127,1, "阳亢心损", C_ORANGE)
		local bb = WAR.LQZ[pid] or 0
				local aa = JY.Wugong[wugong]["消耗内力点数"]
		local nlDam = math.modf((math.modf((level + 3) / 2) * aa)/2)
		local nlDam2 = math.max(nlDam,WAR.NLXH)
		WAR.NLXH = 0
		nlDam = nlDam2 + bb
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam2)
	end
	
	War_Show_Count(WAR.CurID);		--显示当前控制人的点数
	
	WAR.TFBW = 0		--听风辨位的文字记录恢复
	WAR.TLDWX = 0		--天罗地网的文字记录恢复
    
    WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 2
	
    --武功增加经验和升级
    if inteam(pid) then
		if JY.Person[pid]["武功等级" .. wugongnum] < 900 then
			JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + 10
		elseif JY.Person[pid]["武功等级" .. wugongnum] < 999 then
			--JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + math.modf(JY.Person[pid]["资质"] / 20 + math.random(2)) + rz
			--无酒不欢：空挥一次到极
			JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + 99;
			--武功提升为极
			if 999 <= JY.Person[pid]["武功等级" .. wugongnum] then
				JY.Person[pid]["武功等级" .. wugongnum] = 999
				PlayWavAtk(42)
				DrawStrBoxWaitKey(string.format("%s修炼%s到登峰造极", JY.Person[pid]["姓名"], JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"]), C_ORANGE, CC.DefaultFont)

				--虚竹 天山折梅手为极，资质变回50
				if match_ID(pid, 49) and wugong == 14 then
					say("逍遥派的武学果然博大精深，让小僧有醍醐灌顶之感。", 49, 0);
					DrawStrBoxWaitKey("虚竹资质改变！", C_ORANGE, CC.DefaultFont)
					set_potential(49, 50)
				end

				--石破天 太玄神功为极，增加轻功50，实现第一次觉醒
				if match_ID(pid, 38) and wugong == 102 then
					say("１控制这蝌蚪一样的气流在体内游走越发随心所欲了！真有趣！", 38, 0);
					DrawStrBoxWaitKey("石破天轻功上升50点", C_ORANGE, CC.DefaultFont)
					AddPersonAttrib(pid, "轻功", 50)
					if JY.Person[pid]["个人觉醒"] == 0 then
					say("我似乎想起了什么事情，但...好混乱啊。", 38, 0);
					DrawStrBoxWaitKey("石破天觉醒了部分记忆",C_GOLD, CC.DefaultFont)
					awakening(pid, 1)
					say("我的名字，好像不是石破天，但究竟是什么呢？我到底..是谁？", 38, 0);
					DrawStrBoxWaitKey("请帮助石破天找到失去的记忆，以及他的名字",C_GOLD, CC.DefaultFont)
					end
				end
				
				--狄云 神照功为极，增加轻功20点，实现第一次觉醒
				if match_ID(pid, 37) and wugong == 94 and JY.Person[pid]["个人觉醒"] == 0 then
					say("神照经当真奇妙，四肢百骸感觉劲力充盈。丁大哥，我一定不会让你失望的～～～", 37, 0);
					DrawStrBoxWaitKey("狄云领悟神照经的真髓，轻功加二十", C_ORANGE, CC.DefaultFont)
					AddPersonAttrib(pid, "轻功", 20)
					DrawStrBoxWaitKey("狄云觉醒", C_ORANGE, CC.DefaultFont)
					awakening(pid,1)
				end
				
				--胡斐，胡家刀法到极，增加10点耍刀技巧
				if match_ID(pid, 1) and wugong == 67 then
					say("刀法真是越练越精妙。", 1, 0);
					DrawStrBoxWaitKey("胡斐攻、防、轻、耍刀技巧各增加10点", C_ORANGE, CC.DefaultFont)
					AddPersonAttrib(pid, "攻击力", 10)
					AddPersonAttrib(pid, "防御力", 10)
					AddPersonAttrib(pid, "轻功", 10)
					AddPersonAttrib(pid, "耍刀技巧", 10)
					if JY.Person[pid]["耍刀技巧"]>=100 and JY.Person[pid]["个人觉醒"] == 0 then
					say("我似乎悟到了刀法的精髓。", 1, 0);
					DrawStrBoxWaitKey("胡斐领悟了觉醒技：胡刀真传.一刀",C_GOLD, CC.DefaultFont)
					awakening(pid, 1)
					end
				end
	
				if wglw(pid,77)>0 and wugong == 77 then
					say("我对刀剑的理解越来越透彻了。", pid, 0);
					DrawStrBoxWaitKey("耍刀技巧与御剑能力各增加50点", C_ORANGE, CC.DefaultFont)
					AddPersonAttrib(pid, "耍刀技巧", 50)
					AddPersonAttrib(pid, "御剑能力", 50)					
				end
	
				if JY.Person[27]["品德"] == 15 and nglw(pid,105) >0 and wugong == 105 and PersonKF(pid,108) and pid == 0 and GetS(111,0,0,0) == 0 and JY.Person[0]["性别"] ~= 2 then--
				   	say("终于完成内外循环了，哈哈，感觉大不一样啊。", 0, 1);
					DrawStrBoxWaitKey(JY.Person[0]["姓名"].."最大内力值提升到极限", C_ORANGE, CC.DefaultFont)
                    JY.Person[pid]["内力最大值"] = 9999
					say("啊..感觉力量都涌出来了。", 0, 1);
					DrawStrBoxWaitKey(JY.Person[0]["姓名"].."领悟了天人化生",C_GOLD, CC.DefaultFont)
					setNG(105)
				end
				
			end
		end
			
		--武功提升普通等级
		if level < math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1 then
			level = math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1
			DrawStrBox(-1, -1, string.format("%s 升为 %d 级", JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"], level), C_ORANGE, CC.DefaultFont)
			ShowScreen()
			lib.Delay(500)
			Cls()
			ShowScreen()
		end
    end
      
    --我方，消耗的内力
    if WAR.Person[WAR.CurID]["我方"] then
		local nl = nil
	
		nl = math.modf((level + 3) / 2) * JY.Wugong[wugong]["消耗内力点数"]
		local n2  = nl
		--纯阳减少内力消耗
		--主运
		if Curr_NG(pid, 99) then
			nl = math.modf(nl*0.4);
		--被动
		elseif PersonKF(pid, 99) then
			nl = math.modf(nl*0.5);
		end

        
		
		--阳内主运九阳，减少70%耗内
		if Curr_NG(pid, 106) and (JY.Person[pid]["内力性质"] == 1 or (pid == 0 and JY.Base["标准"] == 6)) then
			nl = math.modf(nl*0.3);
		end

		if WAR.MZSM[pid] ~=nil and WAR.MZSM[pid] == 1 then
			nl = math.modf(nl*0.1);
		end
		
		if WAR.BSYJ[pid]~=nil then
		   nl = math.modf(nl*0.2)
		end
		
		--乔峰降龙消耗减半
		if match_ID(pid, 50) and wugong == 26 then
			nl = math.modf(nl/2);
		end
		
		if wglw(pid, 25)>1 and wugong == 25 then
			nl = math.modf(nl/(wglw(pid, 25)+1));
		end
		
		--段誉六脉消耗减半
		if match_ID(pid, 53) and wugong == 49 then
			nl = math.modf(nl/2);
		end
		
		--指法主角六脉消耗减半
		if pid == 0 and JY.Base["标准"] == 2 and wugong == 49 then
			nl = math.modf(nl/2);
		end
		  
		--天外攻击，只消耗一半内力
		if Given_WG(pid, wugong) then
			nl = math.modf(nl/2);
		end
        if WAR.YZSX[pid]~= nil then----心损耗内
		    nl = nl * 2
			if WAR.YZSY[pid] ~= nil then
			nl = nl * 2
			end
		end
	
	if wglw(pid,114) >=1 and WAR.ACT > 1 then
	   AddPersonAttrib(pid, "内力", (nl))
	   nl = 0
	end

    if WAR.ZJZC >=1 and WAR.BJ >0 then
	   nl = 0
	end
	
	if WAR.ZBX[pid] ~= nil then --醉八仙内力*2
		nl = math.modf(nl * 2)
	end
	
		if WAR.ZLLY[pid] ~=nil then
		nl = math.modf(nl * 2)
		end
		if WAR.FZLY[pid] ~=nil then
		nl = math.modf(nl / 2)
		end	
		if WAR.HBYJ[pid] ~=nil and JY.Person[pid]["冰封程度"] > 0 then
		nl = math.modf(nl * WAR.HBYJ[pid])
		end
		AddPersonAttrib(pid, "内力", -(nl))
		WAR.NLXH =  nl
		 	if nglw(pid,99)>1 then
	           n2=n2-nl
			   if n2<0 then
			   n2 = 0
			   end
	           AddPersonAttrib(pid, "生命", math.modf(n2/2))
	        end   
	--NPC的耗内
	else
	    local nl = nil
		nl = math.modf((level + 3) / 2) * JY.Wugong[wugong]["消耗内力点数"]/7*2
		local n2  = nl
		if WAR.ZBX[pid] ~= nil then --醉八仙内力*2
		nl = math.modf(nl * 2)
	    end
		if WAR.ZLLY[pid] ~=nil then
		nl = math.modf(nl * 2)
		end
		if WAR.FZLY[pid] ~=nil then
		nl = math.modf(nl / 2)
		end
		if WAR.HBYJ[pid] ~=nil and JY.Person[pid]["冰封程度"] > 0 then
		nl = math.modf(nl * WAR.HBYJ[pid])
		end
        if WAR.SHAH2[pid]~=nil then
           nl = math.modf(nl * 2)
        end
		AddPersonAttrib(pid, "内力", -nl)
		WAR.NLXH =  nl
			if nglw(pid,99)>1 then
	           n2=n2-nl
			    if n2<0 then
			   n2 = 0
			   end
	           AddPersonAttrib(pid, "生命", math.modf(n2/2))
	        end
    end
    

	
    if JY.Person[pid]["内力"] < 0 then
		JY.Person[pid]["内力"] = 0
    end
    
    if JY.Person[pid]["生命"] <= 0 then
		break;
    end
    
	
	--无酒不欢：被杀气的动态显示
  	DrawTimeBar2()
	
	--太极拳，借力打力，蓄力清除
	--张三丰不清除
	if wugong == 16 and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 0 and wglw(pid,16) <1 then
		WAR.tmp[3000 + pid] = 0
	end
	
	WAR.JX_QLJJ = 0	--青莲剑诀
--	WAR.JX_QLJJ2 = 0	--青莲剑诀
--	WAR.JX_QLJJ3 = 0	--青莲剑诀
	
	WAR.ACT = WAR.ACT + 1   --统计攻击次数累加1
 		
  	--蓝烟清：攻击范围内的敌人全部死亡时取消连击
  	local flag = 0;
  	local n = 0;
	local js = 0
    for i = 0, CC.WarWidth - 1 do
		for j = 0, CC.WarHeight - 1 do
			lib.GetKey()
			local effect = GetWarMap(i, j, 4)
			if 0 < effect then
				local emeny = GetWarMap(i, j, 2)
				if 0 <= emeny and WAR.Person[id]["我方"] ~= WAR.Person[emeny]["我方"] then
					n = n + 1;
					if JY.Person[WAR.Person[emeny]["人物编号"]]["生命"] > 0 then
						flag = 1;
						WAR.BDR[WAR.Person[emeny]["人物编号"]] = 1
					end
				end
    		end
    	end
    end
    WAR.BDRS[pid] = n
	--无酒不欢：程灵素不会中断连击
    if flag == 0 and n > 0 and match_ID(pid, 2) == false then
    	break;
    end
	--主运太极神功，太极之形增加连击,三丰消耗更少
	if Curr_NG(pid, 171) and WAR.TJZX[pid] ~= nil  then
	   if match_ID(pid, 5) and WAR.TJZX[pid] >= 2  then
	   	  WAR.ATNum = WAR.ATNum + 1
		  WAR.TJZX[pid] = WAR.TJZX[pid] - 2
		  WAR.TJZX_LJ = 1
	   elseif  WAR.TJZX[pid] >= (5-nglw(pid,171)) then
		  WAR.ATNum = WAR.ATNum + 1
		  WAR.TJZX[pid] = WAR.TJZX[pid] - (5-nglw(pid,171))
		  WAR.TJZX_LJ = 1
	   end
	end	
 
	if wglw(pid,49)>1 and WAR.QXJQ[pid] ~= nil and WAR.LM_JQ == 0 then
       if WAR.QXJQ[pid] >= 2 then	   
	   WAR.Person[id]["追击剑气"] = WAR.Person[id]["追击剑气"] + math.modf(WAR.QXJQ[pid]/2)
       WAR.QXJQ[pid] = WAR.QXJQ[pid]-math.modf(WAR.QXJQ[pid]/2)*2
       if WAR.QXJQ[pid]<1  then
       WAR.QXJQ[pid] = nil
       end
   
	   end
	end	
 
end
 
  if WAR.ATNum > 1 then
	WAR.TXY = WAR.ATNum
  else
	WAR.TXY = 1
  end 
	--连击结束
	if JY.Restart == 1 then
		return 1
	end
	
	--天外连击判定取消
	WAR.TWLJ = 0
	
	--黯然极意范围恢复
	WAR.ARJY = 0
	
	WAR.ARZS = 0
	
	WAR.LMZS = 0
	
	WAR.TXZS = 0
	
	WAR.LQZS = 0
	
	WAR.BXZS = 0
	
	
	--狄云赤心连城计数恢复
	WAR.CXLC_Count = 0
	--百花连拳计数恢复
	WAR.CXLC_Count2 = 0
	WAR.DGXF_Count = 0
	WAR.XLD_Count = 0
	
	--太极拳，借力打力，蓄力清除
	--张三丰在这里清除
	if wugong == 16 and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 0 and wglw(pid,16)>=1 then
		WAR.tmp[3000 + pid] = 0
	end
	
	--如果触发了逆转乾坤的强化反弹效果，在这里恢复
	if WAR.NZQK > 0 then
		WAR.NZQK = 0
	end
 
 	if WAR.NZQK1 > 0 then
		WAR.NZQK1 = 0
	end
 
	if WAR.WXXY1 > 0 then
	WAR.WXXY1=0
	end
	
	--计算消耗的体力
	local jtl = 0
	local jtl_1= 0
	if 1100 <= WAR.WGWL then
		jtl = 7
	elseif 900 <= WAR.WGWL then
		jtl = 5
	elseif 600 <= WAR.WGWL then
		jtl = 3
	else
		jtl = 1
	end

	if WAR.SQGJ == 1 then----
	   jtl = 0
	end
	
	if WAR.YZSS[pid]~= nil then
	   jtl = jtl * 2
	end

	if WAR.ZLLY[pid]~= nil then
	   jtl = jtl * 2
	end  

	if WAR.FZLY[pid]~= nil then
	   jtl = math.modf(jtl * 0.5)
	end  
  
	if wglw(pid,29)>=1 then--
	   jtl = 0
	end
	
   if WAR.JYWR[pid]~=nil  then
      jtl_1 = 2*WAR.JYWR[pid]
	  jtl = jtl+ jtl_1
   end   
  
	--人厨子攻击不消耗体力
	--NPC只消耗1点
	local tlxh = 0
	if match_ID(pid, 89) then
	tlxh =1	
	end
	if nglw(pid,90)>0 and PersonKF(pid,90) then
	tlxh =1	
	end	
	if WAR.MZSM[pid] ~=nil and WAR.MZSM[pid] == 1 then
		tlxh =1	
	end
	if WAR.YZSS[pid]~=nil  then
	tlxh = 0
	end
   if WAR.JYWR[pid]~=nil  then
    tlxh = 0
   end 
   if WAR.SHAH2[pid]~=nil then
    tlxh = 0
   end
	if tlxh == 0 then
		if WAR.Person[WAR.CurID]["我方"] then
			AddPersonAttrib(pid, "体力", -(jtl))
		else
			AddPersonAttrib(pid, "体力", -1+wglw(pid,29));
		end
        if WAR.SHAH2[pid]~=nil then
           AddPersonAttrib(pid, "体力", -jtl*2)
        end
		if WAR.YZSS[pid]~=nil and WAR.YZSY2[pid]~=nil then
		AddPersonAttrib(pid, "生命", -(jtl*50))
		end
		if WAR.JYWR[pid]~=nil then
		AddPersonAttrib(pid, "生命", -(jtl_1*50))
		end
	end
 



	
 
 	local bl2 = {}
	local blnum2 = 0

	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["伤害爆裂_溅射"] ~= 0 then
			blnum2 = blnum2 + 1
			bl2[blnum2] = {i, WAR.Person[i]["伤害爆裂_溅射"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["伤害爆裂_溅射"] = 0
		end
	end


	for i = 1, blnum2 do
					local tmp = WAR.CurID
		            WAR.CurID = bl2[i][1]
					local dam = bl2[i][2]
					local bpX = bl2[i][3]
					local bpY = bl2[i][4]
					local ydid = WAR.Person[bl2[i][1]]["人物编号"]
					WarDrawMap(0)
					CurIDTXDH(WAR.CurID, 120,1,"血溅四野",M_RED)
			        WAR.Person[bl2[i][1]]["特效动画"] = 98
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
					local bdid = WAR.Person[j]["人物编号"]
					local offset1 = math.abs(bpX - WAR.Person[j]["坐标X"])
					local offset2 = math.abs(bpY - WAR.Person[j]["坐标Y"])
					if offset1 <= 7 and offset2 <= 7 then
 						WAR.Person[j]["伤害爆裂"] = (WAR.Person[j]["伤害爆裂"] or 0) + dam
						WAR.Person[j]["特效动画"] = 48
						WAR.TXXS[bdid] = 1
					end
				end
			end
			War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
						WAR.TXXS[ydid] = 1
						WAR.CurID = tmp				
	end

 	local bl = {}
	local blnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["伤害爆裂"] ~= 0 then
			blnum = blnum + 1
			bl[blnum] = {i, WAR.Person[i]["伤害爆裂"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["伤害爆裂"] = 0
		end
	end

	
	
	for i = 1, blnum do
		local ys_list1 = {}
		local ys_num1 = 0
		for k = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[k]["坐标X"], WAR.Person[k]["坐标Y"], 4) == 1 then
				ys_num1 = ys_num1 + 1
				ys_list1[ys_num1] = {WAR.Person[k]["坐标X"],WAR.Person[k]["坐标Y"]}
			end
		end
					local tmp = WAR.CurID
		            WAR.CurID = bl[i][1]
					local dam = bl[i][2]
					local bdid = WAR.Person[bl[i][1]]["人物编号"]
					WarDrawMap(0)
					CurIDTXDH(WAR.CurID, 107,1,"剑气破体",M_RED)
					CurIDTXDH(WAR.CurID, 120,1,"伤害爆裂",M_RED)
					JY.Person[WAR.Person[bl[i][1]]["人物编号"]]["生命"] = JY.Person[WAR.Person[bl[i][1]]["人物编号"]]["生命"] - dam
					WAR.Person[bl[i][1]]["生命点数"] = (WAR.Person[bl[i][1]]["生命点数"] or 0) -dam
						--一灯，避免被爆死
						if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
							JY.Person[65]["生命"] = 1
						end
						--王重阳
						if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
							JY.Person[129]["生命"] = 1
						end
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
						end
						WAR.TXXS[bdid] = 1
						War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
						WAR.CurID = tmp
		CleanWarMap(4, 0)
		for j = 1, ys_num1 do
			SetWarMap(ys_list1[j][1], ys_list1[j][2], 4, 1)
		end	
	end
 
  	local lt = {}
	local ltnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["雷霆"] ~= 0 then
			ltnum = ltnum + 1
			lt[ltnum] = {i, WAR.Person[i]["雷霆"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["雷霆"] = 0
		end
	end

	
	
	for i = 1, ltnum do
		local ys_list2 = {}
		local ys_num2 = 0
		for k = 0, WAR.PersonNum - 1 do
			if GetWarMap(WAR.Person[k]["坐标X"], WAR.Person[k]["坐标Y"], 4) == 1 then
				ys_num2 = ys_num2 + 1
				ys_list2[ys_num2] = {WAR.Person[k]["坐标X"],WAR.Person[k]["坐标Y"]}
			end
		end
					local tmp = WAR.CurID
		            WAR.CurID = lt[i][1]
					local dam = lt[i][2]
					local bdid = WAR.Person[lt[i][1]]["人物编号"]
					WarDrawMap(0)
					CurIDTXDH(WAR.CurID, 131,1,"天降怒雷",M_RED)
					CurIDTXDH(WAR.CurID, 71,1,"雷击爆裂",M_RED)
					JY.Person[WAR.Person[lt[i][1]]["人物编号"]]["生命"] = JY.Person[WAR.Person[lt[i][1]]["人物编号"]]["生命"] - dam
					WAR.Person[lt[i][1]]["生命点数"] = (WAR.Person[lt[i][1]]["生命点数"] or 0) -dam
						--一灯，避免被爆死
						if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
							JY.Person[65]["生命"] = 1
						end
						--王重阳
						if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
							JY.Person[129]["生命"] = 1
						end
						if JY.Person[bdid]["生命"] < 0 then
							JY.Person[bdid]["生命"] = 0
						end
						WAR.TXXS[bdid] = 1
						War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
						WAR.CurID = tmp
		CleanWarMap(4, 0)
		for j = 1, ys_num2 do
			SetWarMap(ys_list2[j][1], ys_list2[j][2], 4, 1)
		end	
	end
 
	--斗转星移计算
	local dz = {}
	local dznum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["反击武功"] ~= -1 and WAR.Person[i]["反击武功"] ~= 9999 then
			dznum = dznum + 1
			dz[dznum] = {i, WAR.Person[i]["反击武功"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["反击武功"] = 9999
		end
	end
	for i = 1, dznum do
		local tmp = WAR.CurID
		WAR.CurID = dz[i][1]
		WAR.DZXY = 1
		if match_ID_awakened(WAR.Person[WAR.CurID]["人物编号"],55,1) and WAR.GBGJ == -1 then----
		   WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 120
		   WAR.GBGJ = -2
		end
		if D1ZSF(WAR.Person[WAR.CurID]["人物编号"]) and  WAR.TJFY == -1 then----
		   WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 130
		   WAR.TJFY= -2
		end
		if WAR.MJYF[WAR.Person[WAR.CurID]["人物编号"]]~=nil then
		   WAR.LCFJ = WAR.MJYF[WAR.Person[WAR.CurID]["人物编号"]]
		end
		if wglw(WAR.Person[WAR.CurID]["人物编号"],74)>=1  and WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] ~=nil and WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] == 2 then----
           WAR.YCHX = math.random(1,2)
		   local hyfj={"亮翅","喙刺"}
		   if  wglw(WAR.Person[WAR.CurID]["人物编号"],74)>=2  then
		   hyfj={"鹤翼三连","血妆嘴"}
		   end
		   	WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 77,1,"鹤翼反击·"..hyfj[WAR.YCHX],M_SeaGreen);
		end
		if wglw(WAR.Person[WAR.CurID]["人物编号"],51)>=1  then----
            WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 130
		   	WarDrawMap(0)
			WAR.LSGY_SS[WAR.Person[WAR.CurID]["人物编号"]]  = 1
			if WAR.GSSL[WAR.Person[WAR.CurID]["人物编号"]]~=nil and WAR.GSSL[WAR.Person[WAR.CurID]["人物编号"]] == 2 then
			WAR.LSGY_SS[WAR.Person[WAR.CurID]["人物编号"]] = 2
			end
            CurIDTXDH(WAR.CurID, 45,1,"罗刹.鬼影闪",M_SeaGreen);
		end
		if WAR.FQDF2[WAR.Person[WAR.CurID]["人物编号"]] ~=nil then
		WAR.BCH = 1
		end
		if WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 1 then
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 60
		elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 2 then
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 85
		elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 3 then
		    WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 110
		    if wglw(WAR.Person[WAR.CurID]["人物编号"],74)>=1  and WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] ~=nil and WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] == 2 then
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = sixi(WAR.Person[WAR.CurID]["人物编号"],5)
			end
		elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 4 then	--无酒不欢：增加斗转第四层
			WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 130
		end
		War_Fight_Sub(dz[i][1], dz[i][2] + 100, dz[i][3], dz[1][4])
		WAR.Person[WAR.CurID]["反击武功"] = -1
		WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = nil
		if WAR.FQDF2[WAR.Person[WAR.CurID]["人物编号"]] ~=nil then
		WAR.FQDF2[WAR.Person[WAR.CurID]["人物编号"]] = nil
		WAR.BCH = 0
		end
		if WAR.LSGY_SS[WAR.Person[WAR.CurID]["人物编号"]] ~=nil then
		WAR.LSGY_SS[WAR.Person[WAR.CurID]["人物编号"]] = nil
		end
		if WAR.YCHX>0 then
		WAR.YCHX = 0
		end
		if WAR.LSFJ>0 then
		WAR.LSFJ = 0
		end
		if WAR.DZXYSX[WAR.Person[WAR.CurID]["人物编号"]] ~= nil then
        WAR.DZXYSX[WAR.Person[WAR.CurID]["人物编号"]] = nil
	    end
		if WAR.DZXY3P[WAR.Person[WAR.CurID]["人物编号"]] ~= nil then
        WAR.DZXY3P[WAR.Person[WAR.CurID]["人物编号"]] = nil
	    end
		if WAR.MJYF[WAR.Person[WAR.CurID]["人物编号"]]~= nil then
		   WAR.LCFJ = 0
		   WAR.MJYF[WAR.Person[WAR.CurID]["人物编号"]] = nil
		end
		if wglw(WAR.Person[WAR.CurID]["人物编号"],74)>2 and WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] ~=nil and WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] == 2 and math.random(10)<= 5 then
		   WAR.SHJG[WAR.Person[WAR.CurID]["人物编号"]] = 4
		   WarDrawMap(0)
		   CurIDTXDH(WAR.CurID, 37,1,"咏春鹤形·".."龟身",M_SeaGreen);
		end
		WAR.CurID = tmp
		if WAR.TJXY[WAR.Person[WAR.CurID]["人物编号"]] ~= nil then
		WAR.TJXY[WAR.Person[WAR.CurID]["人物编号"]] = nil
		end
		WAR.DZXY = 0

	end


	--倚天屠龙追击计算
	local zj = {}
	local zjnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["追击武功"] ~= -1 and WAR.Person[i]["追击武功"] ~= 9999 then
			zjnum = zjnum + 1
			zj[zjnum] = {i, WAR.Person[i]["追击武功"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["追击武功"] = 9999
		end
	end


	for i = 1, zjnum do
		local tmp = WAR.CurID
		WAR.CurID = zj[i][1]
		if WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] == 1 then
			WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] = 60
		elseif WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] == 2 then
			WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] = 85
		elseif WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] == 3 then
		    WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] = 110
		elseif WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] == 4 then	--倚天屠龙追击层次
			WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] = 130
		end
		WAR.YTTL= 1		
		War_Fight_Sub(zj[i][1], zj[i][2] + 100, zj[i][3], zj[1][4])
		WAR.Person[WAR.CurID]["追击武功"] = -1
		WAR.YTTLLV[WAR.Person[WAR.CurID]["人物编号"]] = nil		
		WAR.CurID = tmp
		WAR.YTTL = 0		
	end


---降龙追击	
	local xl = {}
	local xlnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["降龙追击"]>0 then
			xlnum = xlnum + 1
			xl[xlnum] = {i, 26, x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["降龙追击"] = 0
		end
	end


	for i = 1, xlnum do
        local tmp = WAR.CurID
		WAR.CurID = xl[i][1]
		local tmppid = WAR.Person[xl[i][1]]["人物编号"]
        WAR.XLAY_DZ = math.random(1,4)
		WAR.XLAY_LH = (WAR.LHXT[pid] or 0)		
        local xlzs1 = {"神龙天征","万龙天引","地龙天心","影龙天冲"}
		Set_Eff_Text(id, "特效文字0", xlzs1[WAR.XLAY_DZ])
  	    WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 177,1,"龙拳追击·"..xlzs1[WAR.XLAY_DZ],M_Blue); 	
		War_Fight_Sub(xl[i][1], xl[i][2] + 100, xl[i][3], xl[1][4])	
		WAR.CurID = tmp
		WAR.LHXT[pid] = nil
        if WAR.XLAY_DZ > 0 then
	       WAR.XLAY_DZ = 0
	    end
        if WAR.XLAY_LH > 0 then
	       WAR.XLAY_LH = 0
	    end
	end	
	
--反击武功2
	local zj2 = {}
	local zjnum2 = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["反击武功2"] ~= -1 and WAR.Person[i]["反击武功2"] ~= 9999 then
			zjnum2 = zjnum2 + 1
			zj2[zjnum2] = {i, WAR.Person[i]["反击武功2"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["反击武功2"] = 9999
		end
	end
	for i = 1, zjnum2 do
		local tmp = WAR.CurID
		WAR.CurID = zj2[i][1]
		WAR.HSDF_DF= 0.5
		WAR.DRFJ[WAR.Person[WAR.CurID]["人物编号"]] = 1
        if wglw(WAR.Person[WAR.CurID]["人物编号"],76)>2  then
		local hyfj = {"海兽战技【血鲨】","海兽战技【落鲸】","海兽战技【真蛸】","海兽战技【毒蛟】"}
		local txdh = {146,147,148,149}
        WAR.HSDF_DF= math.random(1,4) 
  	    WarDrawMap(0)
        CurIDTXDH(WAR.CurID, txdh[WAR.HSDF_DF],1,"钓反·"..hyfj[WAR.HSDF_DF],M_Blue);      
        end		
		War_Fight_Sub(zj2[i][1], zj2[i][2] + 100, zj2[i][3], zj2[1][4])
		WAR.Person[WAR.CurID]["反击武功2"] = -1		
		WAR.CurID = tmp
		WAR.DRFJ[WAR.Person[WAR.CurID]["人物编号"]] = nil
		WAR.HSDF_DF = 0		
	end

	--补刀武功计算
	local bd = {}
	local bdnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["补刀武功"] ~= -1 and WAR.Person[i]["补刀武功"] ~= 9999 then
			bdnum = bdnum + 1
			bd[bdnum] = {i, WAR.Person[i]["补刀武功"], x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
			WAR.Person[i]["补刀武功"] = 9999
		end
	end
    WAR.BMB = 1
	for i = 1, bdnum do
		local tmp = WAR.CurID
		WAR.CurID = bd[i][1]
		WAR.FQBD= 1		
		War_Fight_Sub(bd[i][1], bd[i][2] + 100, bd[i][3], bd[1][4])
		WAR.Person[WAR.CurID]["补刀武功"] = -1
		WAR.BMB = 0
		WAR.FQDF1[WAR.Person[WAR.CurID]["人物编号"]] = nil		
		WAR.CurID = tmp
		WAR.FQBD = 0		
	end
	
	local ax = {}
	local axnum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.AXYY[i] ~= nil then
			axnum = axnum + 1
			local fjwg = nil
			local wl = 0
			for j = 1, CC.Kungfunum do
				if JY.Person[WAR.AXYY[i]]["武功"..j] == 0 then
					break
				end
				if skill_usable(WAR.AXYY[i], JY.Person[WAR.AXYY[i]]["武功"..j]) then
					local kungfulv = JY.Person[WAR.AXYY[i]]["武功等级"..j]
					if kungfulv == 999 then
						kungfulv = 11
					else
						kungfulv = math.modf(kungfulv / 100) + 1
					end
					local nwl = get_skill_power(WAR.AXYY[i], JY.Person[WAR.AXYY[i]]["武功"..j], kungfulv)
					if wl < nwl then
						wl = nwl
						fjwg = j
					end
				end
			end
			if fjwg then
				ax[axnum] = {i, fjwg, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
			end
		end
	end
	if axnum > 0 then
		for i = 1, axnum do
			local tmp = WAR.CurID
			WAR.CurID = ax[i][1]
			WAR.AXFJ = 1
			War_Fight_Sub(ax[i][1], ax[i][2], ax[i][3], ax[i][4])
			WAR.CurID = tmp
			WAR.AXFJ = 0
			WAR.AXYY[ax[i][1]] = nil
		end
	end	

	local jq = {}
	local jqnum = 0

	for i = 0, WAR.PersonNum - 1 do
	    local tmppid = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["追击剑气"] >0 then
			jqnum = jqnum + 1
			jq[jqnum] = {i, 49, x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}	
		WAR.Person[i]["追击剑气"] = WAR.Person[i]["追击剑气"] - 1
		end
	end
	
	for i = 1, jqnum do

		local tmp = WAR.CurID
		WAR.CurID = jq[i][1]
		local tmppid = WAR.Person[jq[i][1]]["人物编号"]
		WAR.LM_JQ= 0.5
		local hyfj = {"归元","寒霜","落花","破魔","飞仙","少阳"}
		local txdh = {32,33,34,35,36,37}
        WAR.LM_JQ= math.random(1,6) 
  	    WarDrawMap(0)
        CurIDTXDH(WAR.CurID, txdh[WAR.LM_JQ],1,"剑气追魂·"..hyfj[WAR.LM_JQ],M_Blue); 
        if JY.Person[tmppid]["武器"] == 38 and JLSD(10,70,tmppid) then
        WAR.QJ_JQ = 1
		CurIDTXDH(WAR.CurID, 73,1,"七诀剑气最高奥义·".."斩龙诀",C_ORANGE); 
        end		
		War_Fight_Sub(jq[i][1], jq[i][2] + 100, jq[i][3], jq[1][4])
	
		WAR.CurID = tmp
		WAR.LM_JQ= 0 
        WAR.QJ_JQ = 0		
	end	
	
  for i = 0, WAR.PersonNum - 1 do
    local tmppid = WAR.Person[i]["人物编号"]
	
	if WAR.ZBS[tmppid] ~= nil then --唐门反击
		if JY.Person[tmppid]["生命"] > 0 then
			local tmp = WAR.CurID
			local aq = randomanqi()
			lib.Delay(50)
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 138,1,"千臂如来·"..JY.Thing[aq]["名称"],M_SeaGreen);			
			lib.Delay(150)
			if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.ZBS[tmppid][2], WAR.ZBS[tmppid][3], 4, aq)
			else
			    WAR.ZBS[tmppid] = nil
				War_ExecuteMenu(4, aq)
			end         
			WAR.ZBS[tmppid] = nil
			WAR.CurID = tmp
		else
			WAR.ZBS[tmppid] = nil
		end
    end	

	if WAR.YFZ[tmppid] ~= nil then --雁翎刀反击
		if JY.Person[tmppid]["生命"] > 0 then
			local tmp = WAR.CurID
			local aq = 29
			lib.Delay(50)
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 138,1,"刀魂反击·".."北雁"..JY.Thing[aq]["名称"],M_SeaGreen);			
			lib.Delay(150)
			if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.YFZ[tmppid][2], WAR.YFZ[tmppid][3], 4, aq)
			else
				War_ExecuteMenu(4, aq)
			end         
			WAR.YFZ[tmppid] = nil
			WAR.CurID = tmp
		else
			WAR.YFZ[tmppid] = nil
		end
    end	

	if WAR.YFZ2[tmppid] ~= nil then --唐门反击
		if JY.Person[tmppid]["生命"] > 0 then
			local tmp = WAR.CurID
			local aq = 30
			lib.Delay(50)
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 43,1,"金蛇反噬·".."锥刺",M_SeaGreen);			
			lib.Delay(150)
			if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.YFZ[tmppid][2], WAR.YFZ[tmppid][3], 4, aq)
			else
				War_ExecuteMenu(4, aq)
			end         
			WAR.YFZ2[tmppid] = nil
			WAR.CurID = tmp
		else
			WAR.YFZ2[tmppid] = nil
		end
    end

	if WAR.YFZ3[tmppid] ~= nil then --唐门反击
		if JY.Person[tmppid]["生命"] > 0 then
			local tmp = WAR.CurID
			local aq = 31
			lib.Delay(50)
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 43,1,"雷火反袭·".."爆裂",M_Yellow);			
			lib.Delay(150)
			if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.YFZ3[tmppid][2], WAR.YFZ3[tmppid][3], 4, aq)
			else
				War_ExecuteMenu(4, aq)
			end
            if WAR.YTJS[tmppid]~=nil  then
				local pid = WAR.Person[WAR.CurID]["人物编号"]
	            local x0 = WAR.Person[WAR.CurID]["坐标X"]
	            local y0 = WAR.Person[WAR.CurID]["坐标Y"]
				local x1 = WAR.YTJS[tmppid][1]
				local y1 = WAR.YTJS[tmppid][2]
	            CleanWarMap(4, 0)
	            WAR.ShowHP = 0
	            WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
	            SetWarMap(x1, y1, 4, 1)
	            local victim = GetWarMap(x1, y1, 2)
				if victim>0  then
				War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 145)
				WAR.Person[victim]["雷霆"] = WAR.Person[victim]["雷霆"] + 200
				end
            end  			
			WAR.YFZ3[tmppid] = nil
			WAR.CurID = tmp
		else
			WAR.YFZ3[tmppid] = nil
		end
    end
	
  end 

   for i = 0, WAR.PersonNum - 1 do
    local tmppid = WAR.Person[i]["人物编号"]
	if WAR.DJDQ[tmppid]~=nil then
	   if JY.Person[tmppid]["生命"] > 0 then
	   local tmp = WAR.CurID
	   local aa=math.modf(JY.Base["天书数量"]/4)
			lib.Delay(50)
			WAR.DJDQ[tmppid] = nil
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 89,1,"真武反击·帝江斗气",M_SeaGreen);			
			lib.Delay(150)
			WAR.DJFJ = 1
			War_Fight_Sub(WAR.CurID, 1000, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"])	
			WAR.DJGZ3 = 1			
			WAR.CurID = tmp
			WAR.DJFJ = 0
		else
			WAR.DJDQ[tmppid] = nil
		end
	
	end
	
	if WAR.DJDQ1[tmppid]~=nil and WAR.DZXY~= 1 then
	   if JY.Person[tmppid]["生命"] > 0 then
	   local tmp = WAR.CurID
	   local aa=math.modf(JY.Base["天书数量"]/4)
			lib.Delay(50)
			WAR.DJDQ1[tmppid] = nil
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 89,1,"凌波反击·波纹震荡",M_SeaGreen);			
			lib.Delay(150)
			WAR.DJFJ1 = 1
			WAR.DJGZ3 = 1
			War_Fight_Sub(WAR.CurID, 1000, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"])	
			WAR.DJGZ3 = 0			
			WAR.CurID = tmp
			WAR.DJFJ1 = 0
		else
			WAR.DJDQ1[tmppid] = nil
		end
	
	end


	if WAR.WQQ1[tmppid]~=nil  then
	   if JY.Person[tmppid]["生命"] > 0 then
	   local tmp = WAR.CurID
	   local aa=math.modf(JY.Base["天书数量"]/4)
	   WAR.WQQ1[tmppid] = nil
			lib.Delay(50)			
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 73,1,"轰雷剑势·劈空",M_SeaGreen);			
			lib.Delay(150)
			WAR.DJFJ1 = 1
			WAR.DJGZ3 = 1
		    local n = 1
		    for w = 1, 12 do
			    if  JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功" .. w] == 28 then
				n = w
				end
			end
			War_Fight_Sub(WAR.CurID, n, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"])	
			WAR.DJGZ3 = 0			
			WAR.CurID = tmp
			WAR.DJFJ1 = 0			
		else
			WAR.WQQ1[tmppid] = nil
		end
	
	end

	if WAR.TSCL[tmppid]~=nil and WAR.DZXY~= 1 then
	   if JY.Person[tmppid]["生命"] > 0 then
	   local tmp = WAR.CurID
	   local aa=math.modf(JY.Base["天书数量"]/4)
			lib.Delay(50)
			WAR.TSCL[tmppid] = nil
			WAR.CurID = i
			WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 89,1,"逆天咆哮·帝释天威",M_SandyBrown);			
			lib.Delay(150)
			WAR.FS3 = 1
			WAR.DJFJ1 = 1
			WAR.DFMQ = math.modf((WAR.SPIRIT[tmppid]-100)/5)
			War_Fight_Sub(WAR.CurID, 1, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"])	
			WAR.DFMQ = 0			
			WAR.CurID = tmp
			WAR.FS3 = 0	
            WAR.DJFJ1 = 0			
		else
			WAR.TSCL[tmppid] = nil
		end
	
	end

	if WAR.LHBT[tmppid]~=nil then
	   if JY.Person[tmppid]["生命"] > 0 then
	   local tmp = WAR.CurID
	   local aa=math.modf(JY.Base["天书数量"]/4)
			lib.Delay(50)
			WAR.LHBT[tmppid] = nil
			WAR.CurID = i
            CurIDTXDH(WAR.CurID, 78,1,"狂风落叶·连舞影腿",M_SeaGreen);			
			lib.Delay(150)
			WAR.DJFJ = 1
		    local n = 1
		    for w = 1, 12 do
			    if  JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["武功" .. w] == 129 then
				n = w
				end
			end
			War_Fight_Sub(WAR.CurID, n, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"])	
			WAR.DJGZ3 = 1			
			WAR.CurID = tmp
			WAR.DJFJ = 0
		else
			WAR.LHBT[tmppid] = nil
		end
	
	end
  end
  
	return 1;
end

--无酒不欢：选择移动
--增加7*7的显示flag
function War_SelectMove(flag)
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	local x = x0
	local y = y0
	if flag ~= nil then
		CleanWarMap(7, 0)
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		local x2 = x
		local y2 = y
		WarDrawMap(1, x, y)
		
		if flag ~= nil then
			for i = 1, 4 do
				for j = 1, 4 do
					SetWarMap(x + i - 1, y + j - 1, 7, 1)
					SetWarMap(x - i + 1, y + j - 1, 7, 1)
					SetWarMap(x + i - 1, y - j + 1, 7, 1)
					SetWarMap(x - i + 1, y - j + 1, 7, 1)
				end
			end
			WarDrawMap(1, x, y)
		end
		
		WarShowHead(GetWarMap(x, y, 2))
		ShowScreen()
		
		if flag ~= nil then
			CleanWarMap(7, 0)
		end
		
		local key, ktype, mx, my = WaitKey(1)
		if key == VK_UP then
			y2 = y - 1
		elseif key == VK_DOWN then
			y2 = y + 1
		elseif key == VK_LEFT then
			x2 = x - 1
		elseif key == VK_RIGHT then
			x2 = x + 1
		elseif key == VK_SPACE or key == VK_RETURN then
			return x, y
		elseif key == VK_ESCAPE or ktype == 4 then
			return nil
		elseif ktype == 2 or ktype == 3 then
			mx = mx - CC.ScreenW / 2
			my = my - CC.ScreenH / 2
			mx = (mx) / CC.XScale
			my = (my) / CC.YScale
			mx, my = (mx + my) / 2, (my - mx) / 2
			if mx > 0 then
				mx = mx + 0.99
			else
				mx = mx - 0.01
			end
			if my > 0 then
				my = my + 0.99
			else
				mx = mx - 0.01
			end
			mx = math.modf(mx)
			my = math.modf(my)
			for i = 0, 10 do
				if mx + i <= 63 then
					if my + i > 63 then
						break;
					end
				end
				local hb = GetS(JY.SubScene, x0 + mx + i, y0 + my + i, 4)

				if math.abs(hb - CC.YScale * i * 2) < 5 then
					mx = mx + i
					my = my + i
				end
			end
			x2, y2 = mx + x0, my + y0
			  
			if ktype == 3 then
				return x, y
			end
		end
    
		--无酒不欢：避免跳出
		if GetWarMap(x2, y2, 3) ~= nil and GetWarMap(x2, y2, 3) < 128 then
			x = x2
			y = y2
		end
	end
end

--获取武功最小内力
function War_GetMinNeiLi(pid)
	local minv = math.huge
	for i = 1, CC.Kungfunum do
		local tmpid = JY.Person[pid]["武功" .. i]
		if tmpid > 0 and JY.Wugong[tmpid]["消耗内力点数"] < minv then
			minv = JY.Wugong[tmpid]["消耗内力点数"]
		end
	end
	return minv
end

--无酒不欢：手动战斗菜单上级
function War_Manual()
	local r = nil
	local x, y, move, pic, face_dir = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.CurID]["移动步数"], WAR.Person[WAR.CurID]["贴图"], WAR.Person[WAR.CurID]["人方向"]
	while true do
		if JY.Restart == 1 then
			break
		end
		WAR.ShowHead = 1
		r = War_Manual_Sub()
		--移动，这里实际返回的应该是-1
		if r == 1 or r == -1 then
			--WAR.Person[WAR.CurID]["移动步数"] = 0 
		--ESC返回
		elseif r == 0 then
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
			WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.CurID]["移动步数"] = x, y, move
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, pic)
			--无酒不欢：人物面相也要还原
			WAR.Person[WAR.CurID]["人方向"] = face_dir
		elseif r == 20 then
	
		else
			break;
		end
	end
	WAR.ShowHead = 0
	WarDrawMap(0)
	return r	--无酒不欢：这里的返回值似乎没什么屌用
end
      
--手动战斗菜单
function War_Manual_Sub()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	--local isEsc = 0
	local warmenu = {
	{"移动", War_MoveMenu, 1},	--1
	{"攻击", War_FightMenu, 1},	--2
	{"运功", War_YunGongMenu, 1},	--3
	{"战术", War_TacticsMenu, 1},	--4
	{"用毒", War_PoisonMenu, 1},	--5
	{"解毒", War_DecPoisonMenu, 1},	--6
	{"医疗", War_DoctorMenu, 1},	--7
	{"物品", War_ThingMenu, 1},	--8
	{"状态", War_StatusMenu, 1},	--9
	{"休息", War_RestMenu, 1},	--10
	{"特色", War_TgrtsMenu, 1},	--11
	{"撤退", War_Retreat, 1},	--12
	{"自动", War_AutoMenu, 1},	--13
	{"门派", War_MPMenu, WAR.OWN}	--14
	}

	if MPPD(pid) == 0 then
		warmenu[14][3] = 0
	else
		local mptype = MPPD(pid)
		local mpdj = MPDJ(pid)
		if mpdj < 2 or JY.Person[pid]["体力"] <= 50 then
			warmenu[14][3] = 0
		end
	end	
	
	--特色指令
	if JY.Person[pid]["特色指令"] == 1 then
		--如果是畅想
		if pid == 0 then
		    if JY.Base["畅想"]> 0  then
			warmenu[11][1] = GRTS[JY.Base["畅想"]]
		    if match_ID_awakened(pid,90,1) and JY.Person[90]["论剑奖励"] == 2  then
		    warmenu[11][1] ="90-1"
		    end			
			elseif JY.Base["特殊"]> 0 then
			warmenu[11][1] ="0-1"
			end
		else
			warmenu[11][1] = GRTS[pid]
			if match_ID_awakened(pid,90,1) and JY.Person[90]["论剑奖励"] == 2  then
		    warmenu[11][1] ="90-1"
		    end	
		end
	else
		warmenu[11][3] = 0
	end

  	
	--虚竹
	if match_ID(pid, 49) then
		--如果没有中生死符的人物则不显示特色指令
		local t = 0
		for i = 0, WAR.PersonNum - 1 do
			local wid = WAR.Person[i]["人物编号"]
			if WAR.TZ_XZ_SSH[wid]~=nil and WAR.TZ_XZ_SSH[wid] >= 1 and WAR.Person[i]["死亡"] == false then
				t = 1
			end
		end
		if t == 0 then
			warmenu[11][3] = 0
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
		end
	end
 
  if WAR.BZ[pid] ~= nil then
	warmenu[2][3] = 0	
	warmenu[11][3] = 0
	warmenu[14][3] = 0
  end
 
   if WAR.BCB[pid] ~= nil then
	warmenu[2][3] = 0
	warmenu[11][3] = 0
	warmenu[14][3] = 0	
  end
 
   if WAR.WSZ[pid] ~= nil then
      local aa= WAR.WSZ[pid]
	  if math.random(40)< aa then
	  	warmenu[2][3] = 0
	warmenu[11][3] = 0
	warmenu[14][3] = 0		
	  end
  end
 
  if WAR.LXZT[pid]~=nil and WAR.LXZT[pid]>=25 and JY.Person[pid]["生命"] < math.modf(0.2*JY.Person[pid]["生命最大值"])  then
  warmenu[2][3] = 0	
 	warmenu[11][3] = 0
	warmenu[14][3] = 0
  end
 
	--祖千秋
	if match_ID(pid, 88) then
		--如果周围没有队友不显示特色指令
		local yes = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and i ~= WAR.CurID then
				yes = 1
			end
		end
		if yes == 0 then
			warmenu[11][3] = 0
		end
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[11][3] = 0
		end
	end

	--人厨子
	if match_ID(pid, 89) then
		--如果周围没有队友不显示特色指令
		local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
		local mxy = {
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1}, 
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1}, 
					{WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]}, 
					{WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}

		local yes = 0
		for i = 1, 4 do
			if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
			local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
			if inteam(WAR.Person[mid]["人物编号"]) then
				yes = 1
				end
			end  
		end
		if yes == 0 then
			warmenu[11][3] = 0
		end
		--体力小于25不显示特色指令
		if JY.Person[pid]["体力"] < 25 then
			warmenu[11][3] = 0
		end
	end

	--张无忌
	if match_ID(pid, 9) then
		--如果周围没有队友不显示特色指令
		local yes = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and i ~= WAR.CurID then
				yes = 1
			end
		end
		if yes == 0 then
			warmenu[11][3] = 0
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
		end
	end
 
	--蓝烟清：霍青桐统率指令
	if match_ID(pid, 74) then
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[11][3] = 0
		end
	end

	--慕容复指令 幻梦
	if match_ID(pid, 51) then
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
		end
	end
	
	--小昭指令 影步
	if match_ID(pid, 66) then
		--体力小于30，或内力小于2000不显示特色指令
		if JY.Person[pid]["体力"] < 30  then
			warmenu[11][3] = 0
		end
	end
 
 
	--钟灵指令 灵貂
	if match_ID(pid, 90) then
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[11][3] = 0
		end
	end
	
	--胡斐指令 飞狐
	if match_ID(pid, 1) then
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[11][3] = 0
		end
	end
	
	--鸠摩智指令 幻化
	if match_ID(pid, 103) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
		end
	end	
 
 	--黄蓉 遁甲
	if match_ID(pid, 56) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[11][3] = 0
		end
	end
	
	--出左右时，移动，解毒，医疗，物品，特色，自动不可见
	if WAR.ZYHB == 2 then
		warmenu[1][3] = 0
		warmenu[6][3] = 0
		warmenu[7][3] = 0
		warmenu[8][3] = 0
		warmenu[11][3] = 0
		warmenu[13][3] = 0
	end
  
	--体力小于5或者已经移动过时，移动不可见
	if JY.Person[pid]["体力"] <= 5 or WAR.Person[WAR.CurID]["移动步数"] <= 0 then
		warmenu[1][3] = 0
		--isEsc = 1
	end
  
	--判断最小内力，是否可显示攻击
	local minv = War_GetMinNeiLi(pid)
	if JY.Person[pid]["内力"] < minv or JY.Person[pid]["体力"] < 10 then
		warmenu[2][3] = 0
	end
  
	--用毒解毒医疗，567
	if JY.Person[pid]["体力"] < 10 or JY.Person[pid]["用毒能力"] < 20 then
		warmenu[5][3] = 0
	end
	if JY.Person[pid]["体力"] < 10 or JY.Person[pid]["解毒能力"] < 20 then
		warmenu[6][3] = 0
	end
	if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["医疗能力"] < 20 then
		warmenu[7][3] = 0
	end
  
	--新华山论剑，不可使用物品
	if WAR.ZDDH == 238 then
		warmenu[8][3] = 0
	end
  
	lib.GetKey()
	Cls()
	DrawTimeBar_sub()
	
	local test = ShowMenu(warmenu, #warmenu, 0, CC.MainMenuX, CC.MainMenuY, 0, 0, 1, 1, CC.DefaultFont, C_ORANGE, C_WHITE)
	local chain  --手动战斗战意增长
	if WAR.Person[WAR.CurID]["我方"] then
		chain = WAR.MYCHAIN
	else
		chain = WAR.URCHAIN
	end
	if test == -2 then
		zhanyi(pid, (1.5 * (1 + chain / 30)))
	elseif test == -5 or test == -6 or test == -7 then
		zhanyi(pid, (0.5 * (1 + chain / 30)))
	elseif test == -8 then
		zhanyi(pid, (0.4 * (1 + chain / 30)))
	elseif test == -4 then
		zhanyi(pid, (0.65 * (1 + chain / 30)))
	elseif test == -11 or test == -13 then
		zhanyi(pid, (1 * (1 + chain / 30)))
	end
	if Curr_NG(pid,184) then
	zhanyi(pid, (1 * (1 + chain / 30)))
	end
	return test
end

function War_MPMenu() --门派指令菜单
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local mptype = MPPD(pid)
	local mpdj = MPDJ(pid)
	local menu = {}
		for i = 1, #CC.ASKILL[mptype] do
			menu[i] = {CC.ASKILL[mptype][i], nil, 1}			
		end	
	local aaa = false
	for i = 1, #menu do
		if menu[i][3] == 1 then
			aaa = true
		end
	end
	if not aaa then
		Cls()
		QZXS("没有目前可用的技能")
		return 0
	end
	local r
	DrawStrBox(CC.MainSubMenuX, CC.MainSubMenuY,"门派技能", C_WHITE, CC.DefaultFont);
   if mptype == 1 then --丐帮指令
		for i = 1, #CC.ASKILL[mptype] do
			menu[i] = {CC.ASKILL[mptype][i], nil, 1}			
		end
		if JY.Person[pid]["体力"] < 15 then
			menu[1][3] = 0
		end
		if JY.Person[pid]["体力"] < 30 then
			menu[1][3] = 0
		end		
		if JY.Person[pid]["体力"] < 15 or mpdj < 3 or WAR.ZBX[pid] ~= nil then
			menu[3][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
		if r == 1 then	
			CleanWarMap(4, 0)
			DIYdisplay(menu[1][1])
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and 
					WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 1) then
					SetWarMap(WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"], 4, 2)				
					WAR.SH[WAR.Person[i]["人物编号"]] = 50
				end
			end		
			War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 56)	
			AddPersonAttrib(pid, "体力", -15)
            WAR.SH1[pid] = 50
		elseif r == 2 then
			CleanWarMap(4, 0)
			DIYdisplay(menu[2][1])
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] and 
					WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 1) then
					SetWarMap(WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"], 4, 4)	
					AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度", -100)	
				end
			end		
			War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 93)	
			AddPersonAttrib(pid, "体力", -30)				
		elseif r == 3 then
			local jiu = -1 
			for i = 22, 25 do
				if hasthing(i) then
					jiu = i
					break
				end
			end
			if jiu == -1 then
				Cls()
				QZXS("没有酒了！")
				return 0
			else
				addthing(jiu, -1, 1)
				CurIDTXDH(WAR.CurID, 91,1,CC.ASKILL[mptype][r],M_DarkOrange)
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 15
				addeffect(WAR.ZBX, pid, 9)
				if WAR.HJ[pid] == nil and MPPB_GB(pid) >= 2 then
				local aa = jiu-21
				local BDQS = "醉意."..JY.Thing[jiu]["名称"]
				DIYdisplay(BDQS)
				WAR.HJ[pid] = 50+JY.Base["天书数量"]
				if  aa == 1 then--
				WAR.MZLL[pid] = WAR.HJ[pid]
				elseif aa== 2 then
				WAR.L_HQNZL[pid] = WAR.HJ[pid]
				elseif  aa == 3 then
				WAR.KBGJ[pid] = WAR.HJ[pid]
				else
				addeffect(WAR.SATA, pid, 5)
				addeffect(WAR.DR, pid, 5)
				end
				end
				if  MPPB_GB(pid) == 1 or MPPB_GB(pid) == 3 then
				local BDQS = "醉舞.再现江湖"
				DIYdisplay(BDQS)
				WAR.HIDE[pid] = 50+JY.Base["天书数量"]
				end
			end
		end
		if r > 0 then
			return 1
		end
	elseif mptype == 2 then --武当指令
		if JY.Person[pid]["体力"] < 25 then
			menu[1][3] = 0
		end
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 500 then
			menu[2][3] = 0
		end
		if JY.Person[pid]["内力"] < 1000 then
			menu[3][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
		if r == 1 then
			CleanWarMap(4, 0)
			local nx, ny, victim, victimid = selectPerson(4, 1)
			if nx == -1 then
				return 0
			end
			SetWarMap(nx, ny, 4, 2)
			War_ShowFight(pid,0,0,0,nx,ny,21);	
			SetWarMap(nx, ny, 4, -1)			
			AddPersonAttrib(pid, "体力", -25)	
			if WAR.LQZ[victimid] ~= nil then
				WAR.LQZ[victimid] = math.modf(WAR.LQZ[victimid] * 0.5)
			end
			WAR.LQZ[pid] = nil
			if WAR.YRKG[victimid] == nil then
				WAR.YRKG[victimid] = 11 + JY.Base["天书数量"]
			else
				WAR.YRKG[victimid] = WAR.YRKG[victimid] + 11 + JY.Base["天书数量"]
			end
		elseif r == 2 then
			CleanWarMap(4, 0)
			CurIDTXDH(WAR.CurID, 90,1,CC.ASKILL[mptype][r],M_DarkOrange)
			AddPersonAttrib(pid, "体力", -20)
			AddPersonAttrib(pid, "内力", -500)
			WAR.YJZD[pid] = 25 - JY.Base["天书数量"]
			WAR.Defup[pid] = 1	
		elseif r == 3 then
			CleanWarMap(4, 0)
			CurIDTXDH(WAR.CurID, 81,1,CC.ASKILL[mptype][r],M_DarkOrange)
			addeffect(WAR.ZBX2, pid, 4)
			WAR.BG[pid]=(WAR.BG[pid] or 0) + 500
            WAR.WJ[pid]= (WAR.WJ[pid] or 0) + 500
			AddPersonAttrib(pid, "内力", -1000)
			WAR.Actup[pid] = 1				
		end
		if r > 0 then
			return 1
		end			
	elseif mptype == 3 then --少林指令
		if JY.Person[pid]["体力"] < 25 or JY.Person[pid]["品德"] < 50 or JY.Person[pid]["内力"] < math.modf(JY.Person[pid]["内力最大值"]*0.4) then
			menu[1][3] = 0
		end
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			menu[2][3] = 0
		end
		if JY.Person[pid]["体力"] < 30 or JY.Person[pid]["内力"] < 3000 then
			menu[3][3] = 0
		end		
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
		if r == 1 then
			CleanWarMap(4, 0)
			local tmpcount = 0
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == false then
					tmpcount = tmpcount + 1
				end
			end			
			if tmpcount < 2 then
				Cls()
				QZXS("只剩一个敌人的时候无法使用")	
				return 0
			end
			local nx, ny, victim, victimid = selectPerson(4, 1)
			if nx == -1 then
				return 0
			end
			if MPPD(victimid) == 3 or JY.Person[victimid]["生命"] > math.modf(JY.Person[victimid]["生命最大值"]/2) then
			Cls()
			QZXS("目标不可被点化") 
			   return 0
			else
			Cls()
			say("放下屠刀，立地成佛！",pid,0,JY.Person[pid]["姓名"]) 		
			SetWarMap(nx, ny, 4, 2)
			War_ShowFight(pid,0,0,0,nx,ny,104);	
			local jc = MPDJ(pid)*5
			if MPPB_SL(pid) == 2 then
			jc = jc * 2
		    end
			local jilv = math.modf(((JY.Person[pid]["品德"]) - 50) / 5) + JY.Base["天书数量"]
			if MPPB_SL(pid) == 2 then
				jilv = jilv + 5*MPDJ(pid)
			end
			if JLSD(10, 16 + jilv + jc, pid) then
			    if MPPB_SL(pid) == 2 and JLSD(10, 16 + jilv + jc, pid) then
				WAR.Person[victim]["我方"] = WAR.Person[WAR.CurID]["我方"]
		        JY.Person[victimid]["生命"] = JY.Person[victimid]["生命最大值"]
		        JY.Person[victimid]["内力"] = JY.Person[victimid]["内力最大值"]
		        JY.Person[victimid]["中毒程度"] = 0
		        JY.Person[victimid]["受伤程度"] = 0
		        JY.Person[victimid]["冰封程度"] = 0
		        JY.Person[victimid]["灼烧程度"] = 0
		        JY.Person[victimid]["体力"] = 100
		        WAR.FXDS[victimid] = nil
		        WAR.LXZT[victimid] = nil
				else
				QZXS(JY.Person[victimid]["姓名"].."退场！")
				WAR.Person[victim]["死亡"] = true
				lib.SetWarMap(nx, ny, 5, -1)
				lib.SetWarMap(nx, ny, 2, -1)	
                end				
			else
				QZXS(JY.Person[victimid]["姓名"].."点化失败！")		
			end
			SetWarMap(nx, ny, 4, -1)			
			AddPersonAttrib(pid, "体力", -25)
			AddPersonAttrib(pid, "内力", -math.modf(JY.Person[pid]["内力"]*0.5))
			end
		elseif r == 2 then
			CleanWarMap(4, 0)
			CurIDTXDH(WAR.CurID, 76,1,CC.ASKILL[mptype][r],M_DarkOrange)
			AddPersonAttrib(pid, "体力", -20)
			AddPersonAttrib(pid, "内力", -200)
			WAR.BHJS[pid] = 40 + math.modf(JY.Base["天书数量"] * 2)
			if MPPB_SL(pid) == 3 then
            WAR.BHJS2[pid] = 40 + math.modf(JY.Base["天书数量"] * 2)	
            end			
		elseif r == 3 then
			Cls()
			say("苦--海--无--边--回--头--是--岸-----",pid,0,JY.Person[pid]["姓名"]) 		
			local sq = math.modf(JY.Person[pid]["内力"] / 15)
			for e = 0, WAR.PersonNum - 1 do
				local tmppid = WAR.Person[e]["人物编号"]
				if WAR.Person[e]["死亡"] == false and WAR.Person[e]["我方"] ~= WAR.Person[WAR.CurID]["我方"]
					and JY.Person[pid]["内力"] > JY.Person[tmppid]["内力"] then
					WAR.Person[e].TimeAdd = WAR.Person[e].TimeAdd - sq
					if MPPB_SL(pid) == 1 then
					WAR.LHFM[tmppid] = 10*MPDJ(pid)
					end
				end
			end
            if MPPB_SL(pid) == 2 then --达摩院效果
			say("功德无量,开光",pid,0,JY.Person[pid]["姓名"])
			for e = 0, WAR.PersonNum - 1 do
				local tmppid = WAR.Person[e]["人物编号"]
				if WAR.Person[e]["死亡"] == false and WAR.Person[e]["我方"] == WAR.Person[WAR.CurID]["我方"] then
					WAR.Person[e].TimeAdd = WAR.Person[e].TimeAdd + sq
					WAR.LUCK[tmppid] = 10*MPDJ(pid)
				end
			end
            end			
			DrawTimeBar2()
			AddPersonAttrib(pid, "体力", -30)
			AddPersonAttrib(pid, "内力", -math.modf(JY.Person[pid]["内力"] / 2))
		end
		if r > 0 then
			return 1
		end		
	elseif mptype == 4 then --血刀门指令
		if JY.Person[pid]["体力"] < 15 or WAR.XUEMO[pid] ~= nil or
			JY.Person[pid]["生命"] < math.modf(JY.Person[pid]["生命最大值"] * 0.5) then
			menu[1][3] = 0
		end
		if JY.Person[pid]["体力"] < 25 or WAR.HUANXUE[pid] ~= nil or
			JY.Person[pid]["生命"] < math.modf(JY.Person[pid]["生命最大值"] * 0.5) then
			menu[2][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
		if r == 1 then
			CleanWarMap(4, 0)
			CurIDTXDH(WAR.CurID, 81,1,CC.ASKILL[mptype][r],M_DarkOrange)
			AddPersonAttrib(pid, "体力", -15)
			addeffect(WAR.XUEMO, pid, 1)
			addeffect(WAR.LQZ, pid, 100)
		elseif r == 2 then	
			CleanWarMap(4, 0)
			local nx, ny, victim, victimid = selectPerson(4, 1)
			if nx == -1 then
				return 0
			end
			Cls()
			SetWarMap(nx, ny, 4, 2)
			DIYdisplay(CC.ASKILL[4][2])
			War_ShowFight(pid,0,0,0,nx,ny,98);	
			QZXS(JY.Person[victimid]["姓名"].."与"..JY.Person[pid]["姓名"].."血量交换")		
			SetWarMap(nx, ny, 4, -1)			
			AddPersonAttrib(pid, "体力", -25)	
			local tmpratio1 = JY.Person[pid]["生命"] / JY.Person[pid]["生命最大值"]
			local tmpratio2 = JY.Person[victimid]["生命"] / JY.Person[victimid]["生命最大值"]
			JY.Person[pid]["生命"] = math.modf(tmpratio2 * JY.Person[pid]["生命最大值"])
			JY.Person[victimid]["生命"] = math.modf(tmpratio1 * JY.Person[victimid]["生命最大值"])
			if JY.Person[pid]["生命"] < 1 then JY.Person[pid]["生命"] = 1 end
			if JY.Person[victimid]["生命"] < 1 then JY.Person[victimid]["生命"] = 1 end			
			addeffect(WAR.HUANXUE, pid, 1)
		end
		if r > 0 then
			return 1
		end			
	
elseif mptype == 5 then --沼跃鱼：明教
		if JY.Person[pid]["体力"] < 50 then
			menu[1][3] = 0
		end 
		if JY.Person[pid]["体力"] < 25 or JY.Person[pid]["内力"] < 500 then
			menu[2][3] = 0
		end
		if JY.Person[pid]["体力"] < 25 or JY.Person[pid]["内力"] < 500 then
			menu[3][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
			if r == 1 then
			   if (WAR.LQZ[pid] == nil or WAR.LQZ[pid] < 100) and JY.Person[pid]["生命"]>=math.modf(JY.Person[pid]["生命最大值"]*0.25) then
							DrawStrBoxWaitKey("条件不符，不可使用", C_WHITE, 30)
							return 0
			   end
						WAR.LQZ[pid] = nil
						WAR.MJZBDS[pid] = JY.Person[pid]["内力"]
						WAR.MJZBDS[pid] = 150 + math.modf(WAR.MJZBDS[pid] / 10) 
						WAR.MJZBDS[pid] = math.modf(WAR.MJZBDS[pid]*(3-JY.Person[pid]["生命"]/JY.Person[pid]["生命最大值"]))
                        CurIDTXDH(WAR.CurID, 59,1,"喜乐悲愁，皆归尘土",M_DarkOrange)						
						WAR.MJZB[pid] = 1
						WAR.MJZB2[pid] = 1
						local nx, ny, victim, victimid = selectPerson(7, 1)
						if nx == -1 then
							return 0
						end
						CleanWarMap(4, 0)
						for i = 0, WAR.PersonNum - 1 do
							if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and 
								WAR.Person[i]["死亡"] == false and RealJL(victim, i, 3) then
								SetWarMap(WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"], 4, 2)
								JY.Person[WAR.Person[i]["人物编号"]]["生命"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]-WAR.MJZBDS[pid]
								WAR.HOT[WAR.Person[i]["人物编号"]] = limitX((WAR.HOT[WAR.Person[i]["人物编号"]] or 0) + math.modf(WAR.MJZBDS[pid]/100), 0, 100)
								AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度", math.modf(WAR.MJZBDS[pid]/100))
							end
						end		
						War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 111)	
                        CurIDTXDH(WAR.CurID, 64,1,"喜乐悲愁，皆归尘土",M_DarkOrange)						
						WAR.MJZB[pid] = 0
						WAR.MJZB2[pid] = 0	
                        JY.Person[pid]["内力"] = 0
						JY.Person[pid]["生命"] = 1
                        AddPersonAttrib(pid, "体力", -25)
                        AddPersonAttrib(pid, "受伤程度", 100)							
		    elseif r == 2 then
				    if JY.Person[pid]["体力"] > 25 and WAR.MJCJ>0 then
						local nx, ny, victim, victimid = selectPerson(7, 1)
						if nx == -1 then
							return 0
						end
						CleanWarMap(4, 0)
						SetWarMap(WAR.Person[victim]["坐标X"],WAR.Person[victim]["坐标Y"], 4, 2)
						QZXS("我指认面前的敌人是光明的死敌，邪恶的帮凶！")
						WAR.MJBCJ[victimid] = WAR.MJBCJ[victimid] or 0 + 1
						--WAR.LQZ[victimid] = 0
						War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 145)	
						AddPersonAttrib(pid, "体力", -20)
						WAR.MJCJ=WAR.MJCJ-1						
					else
						DrawStrBoxWaitKey("条件不符，不可使用", C_WHITE, 30)
						return 0
					end
						AddPersonAttrib(pid, "体力", -25)
		    elseif r == 3 then
				    if JY.Person[pid]["体力"] > 25 then
					local str = {"巨木", "锐金", "洪水", "烈火", "厚土"}
					local qishu = JYMsgBox("五行旗", "要选择哪一个指令？", str, 5, pid)
					local cd = 0
					local cd2 = 0
					local color = {M_PaleGreen,M_Yellow,M_Blue,C_GOLD,M_SandyBrown}
					local cl = color[qishu]
					local shanghai = 30* MPDJ(pid)
					local bonus = 0
						local nx, ny, victim, victimid = selectPerson(3+MPDJ(pid), 1)
						if nx == -1 then
							return 0
						end
						CleanWarMap(4, 0)					
						SetWarMap(WAR.Person[victim]["坐标X"],WAR.Person[victim]["坐标Y"], 4, 2)						
				if qishu == 1 then
                        AddPersonAttrib(victimid,"中毒程度", 10*MPDJ(pid))
                        if WAR.WXZQ[pid] ~= nil and WAR.WXZQ[pid] == 1 then						
						WAR.L_WNGZL[victimid] = 10*MPDJ(pid)	
						WAR.L_HQNZL[pid] = 10
						   if MPPB_MJBL(pid)>2 then
						   WAR.QSLZ[victimid] = 10*MPDJ(pid)
						   end
                        end	
                        cd = 64
                        cd2 = 121						
				elseif qishu == 2 then
				        WAR.LXXS[victimid]=1
						WAR.LXZT[victimid]=(WAR.LXZT[victimid] or 0) + math.random(1, 10)
						if WAR.LXZT[victimid]>=100 then
		                   WAR.LXZT[victimid]=100
		                end
                        if WAR.WXZQ[pid] ~= nil and WAR.WXZQ[pid] == 2 then						
						bonus = (WAR.LXZT[victimid] or 0) * 2
                        WAR.BZ[victimid] = 1
						   if MPPB_MJBL(pid)>2 then
						   WAR.QBLY[victimid] = 10*MPDJ(pid)
						   WAR.RXSD[victimid] = 10*MPDJ(pid)
						   end						
                        end	
                        cd = 38
                        cd2 = 137						
				elseif qishu == 4 then					
						AddPersonAttrib(victimid,"灼烧程度", 10*MPDJ(pid))
						if WAR.WXZQ[pid] ~= nil and WAR.WXZQ[pid] == 4 then						
                        WAR.HOT[victimid] = 10*MPDJ(pid)					
                        end	
						   if MPPB_MJAS(pid)>2 then
                           addeffect(WAR.HTZD2, victimid, 1)
						   WAR.JHLY2[victimid] = 10*MPDJ(pid)
						   end
						   if MPPB_MJBL(pid)>2 then
						   WAR.JHLY3[victimid] = 10*MPDJ(pid)
						   end
                        cd = 116
                        cd2 = 8	
				elseif qishu == 3 then
						AddPersonAttrib(victimid,"冰封程度", 10*MPDJ(pid))
						if WAR.WXZQ[pid] ~= nil and WAR.WXZQ[pid] == 3 then	
						WAR.ICE[victimid] = 10*MPDJ(pid)
						WAR.PEACE[victimid] = 10*MPDJ(pid) 
						end
						   if MPPB_MJBL(pid)>2 then
						   WAR.HDQM[victimid] = 10*MPDJ(pid)
						   end
                        cd = 53
                        cd2 = 124	
				elseif qishu == 5 then											
						AddPersonAttrib(victimid,"受伤程度", 10*MPDJ(pid))
						if WAR.WXZQ[pid] ~= nil and WAR.WXZQ[pid] == 5 then	
						WAR.POISON[victimid] = 10*MPDJ(pid)
                        end	
						   if MPPB_MJBL(pid)>2 then
						   WAR.NKZT[victimid] = 10*MPDJ(pid)
						   end						
                        cd = 155
                        cd2 = 163						
				end
						 if MPPB_MJBL(pid)>1  then
						   WAR.WXZQ[pid] = qishu
						 end					   
                        CurIDTXDH(WAR.CurID, cd,1,"五行掌旗."..str[qishu].."旗",cl)
						shanghai = shanghai + bonus
						WAR.Person[victim]["生命点数"] =  AddPersonAttrib(victimid, "生命", -shanghai)
						WAR.TXXS[victimid] = 1
						
						War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], cd2)

						AddPersonAttrib(pid, "体力", -25)
                        AddPersonAttrib(pid, "内力", -500)						
					else
						DrawStrBoxWaitKey("条件不符，不可使用", C_WHITE, 30)
						return 0
					end
					
			end	
		if r > 0 then
			return 1
		end	
elseif mptype == 6 then --沼跃鱼：五岳剑派
		if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["内力"] < 500 then
			menu[1][3] = 0
		end 
		if JY.Person[pid]["体力"] < 25 or JY.Person[pid]["内力"] < 500 then
			menu[2][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
			if r == 1 then

            CurIDTXDH(WAR.CurID, 58,1,"剑宗秘传.剑气纵横三万里",M_DarkOrange)
			WAR.SXJ  = 1
			War_FightMenu()
			AddPersonAttrib(pid, "体力", -30)
			AddPersonAttrib(pid, "内力", -1000)
            WAR.SXJ = 0			
		elseif r == 2 then
            for i = 97, 112 do
				CurIDTXDH(WAR.CurID, i, i, "寒冰秘法.冰封天下");		--动画显示	
				lib.Delay(10)
			end
			WAR.BFTX = 1
			War_FightMenu()
	        AddPersonAttrib(pid, "内力", -1500) 
		    AddPersonAttrib(pid, "体力", -25)
			WAR.BFTX = 0			
	   end	
		if r > 0 then
			return 1
		end	
 elseif mptype == 7 then --沼跃鱼：白驼山
		if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["内力"] < 500 then
			menu[1][3] = 0
		end 
		if JY.Person[pid]["体力"] < 25 or JY.Person[pid]["内力"] < 500 then
			menu[2][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
			if r == 1 then
			Cls()		
			for e = 0, WAR.PersonNum - 1 do
				local tmppid = WAR.Person[e]["人物编号"]
				WAR.JD[pid] = (WAR.JD[pid] or 0) + JY.Person[tmppid]["中毒程度"]
				if WAR.Person[e]["我方"] then				
					JY.Person[tmppid]["中毒程度"] = 0
				end
			end
             if MPPB_BTHM(pid) > 1 then
             JY.Person[pid]["生命"] = JY.Person[pid]["生命"] + WAR.JD[pid]
             end			 
             CurIDTXDH(WAR.CurID, 72,1,"白驼山秘技 万毒归元",M_Olive)			
			AddPersonAttrib(pid, "体力", -30)
			AddPersonAttrib(pid, "内力", -300)		
		elseif r == 2 then
		    CurIDTXDH(WAR.CurID, 72,1,"白驼山秘技 蟾息滔天",M_Olive)
			for i = 0, WAR.PersonNum - 1 do				
				if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and 
					WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 3) then
					SetWarMap(WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"], 4, 2)
					local aa = WAR.LQZ[WAR.Person[i]["人物编号"]] or 0
					WAR.LQZ[WAR.Person[i]["人物编号"]] = nil
					WAR.Person[i]["中毒点数"] = (WAR.Person[i]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "中毒程度", aa)
					if MPPB_BTNY(pid) >= 1 then
					WAR.JD_SJSD[WAR.Person[i]["人物编号"]] = aa
					end
					if MPPB_BTLS(pid) >= 1 then
					WAR.L_WNGZL2[WAR.Person[i]["人物编号"]] = aa
					WAR.RXSD[WAR.Person[i]["人物编号"]] = aa
					end
				end
			end			
			War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 80)
			AddPersonAttrib(pid, "体力", -20)			
	   end	
		if r > 0 then
			return 1
		end	    
 elseif mptype == 8 then --沼跃鱼：桃花岛
				if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["内力"] < 500 then
			menu[1][3] = 0
		end
		if JY.Person[pid]["体力"] < 20 or WAR.BHHJ[pid] ~= nil then
			menu[2][3] = 0
		end
		r = ShowMenu(menu,#menu,0,CC.MainSubMenuX,CC.MainSubMenuY+CC.SingleLineHeight,0,0,1,1,CC.DefaultFont,C_ORANGE,C_WHITE);
		if r == 1 then
			Cls()		
			for e = 0, WAR.PersonNum - 1 do
				local tmppid = WAR.Person[e]["人物编号"]
				if WAR.Person[e]["我方"] then
					if WAR.JH[pid] == nil then
						WAR.JH[pid] = JY.Person[tmppid]["受伤程度"]
					else
						WAR.JH[pid] = WAR.JH[pid] + JY.Person[tmppid]["受伤程度"]
					end					
					JY.Person[tmppid]["受伤程度"] = 0
				end
			end	
            CurIDTXDH(WAR.CurID, 72,1,"桃花岛秘药 九花玉露",M_Olive)			
			AddPersonAttrib(pid, "体力", -30)
			AddPersonAttrib(pid, "内力", -300)
		elseif r == 2 then	
			WAR.BHHJ[pid] = 3
			if MPPB_THBH(pid)>=2 then
			WAR.BHHJ[pid] = 1 + MPPB_THBH(pid)*2
			end
			CurIDTXDH(WAR.CurID, 69,1,"奇门遁甲.碧海秘境",M_Olive)
			AddPersonAttrib(pid, "体力", -20)
		end
		if r > 0 then
			return 1
		end	 	
	end
end


--无酒不欢：运功选择菜单
function War_YunGongMenu()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	local menu={};
	menu[1]={"运行内功",SelectNeiGongMenu,1};
	menu[2]={"停运内功",nil,1};
	menu[3]={"运行轻功",SelectQingGongMenu,1};
	menu[4]={"停运轻功",nil,1};
    local r = ShowMenu(menu,#menu,0,CC.MainSubMenuX+15,CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);	
	if r == 2 then
		JY.Person[id]["主运内功"] = 0
		DrawStrBoxWaitKey(JY.Person[id]["姓名"].."停止了运行主内功",C_RED,CC.DefaultFont,nil,LimeGreen)
		return 20;
	elseif r == 20 then
		return 20;
	elseif r == 4 then
		JY.Person[id]["主运轻功"] = 0
		DrawStrBoxWaitKey(JY.Person[id]["姓名"].."停止了运行主轻功",M_DeepSkyBlue,CC.DefaultFont,nil,LimeGreen)
		return 20;
	elseif r == 10 then
		return 10;
	end
end

--无酒不欢：选择内功菜单
function SelectNeiGongMenu()
	local id, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	local preneigong = JY.Person[id]["主运内功"]
	local menu={};
	for i=1,CC.Kungfunum do
        menu[i]={JY.Wugong[JY.Person[id]["武功" .. i]]["名称"],nil,0};
		if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 6 then
			menu[i][3]=1;
		end
		--天罡不能运天内
		if id == 0 and JY.Base["标准"] == 6 and (JY.Person[id]["武功" .. i] == JY.Person[id]["天赋内功"]) then
			menu[i][3]=0;	
		end
	end
    local main_neigong =  ShowMenu(menu,#menu,0,CC.MainSubMenuX+21+4*(CC.Fontsmall+CC.RowPixel),CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
	if main_neigong ~= nil and main_neigong > 0 then
		CleanWarMap(4, 0)
		SetWarMap(x1, y1, 4, 1)
		War_ShowFight(id, 0, 0, 0, 0, 0, 9)	
		AddPersonAttrib(id, "内力", -200);
		AddPersonAttrib(id, "体力", -5);
		JY.Person[id]["主运内功"] = JY.Person[id]["武功" .. main_neigong]
		if  JY.Person[id]["主运内功"]~= preneigong and wglw(id,18)>2 and  WAR.TZNQ== 100 then----
		    CurIDTXDH(WAR.CurID, 136, 1, "弹指气劲·罡气外放")			
		    for j = 0, WAR.PersonNum - 1 do			
				if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
				local tmppid= WAR.Person[j]["人物编号"]
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300 					
					local bb=math.random(5,15)
					WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) +AddPersonAttrib(tmppid, "受伤程度", bb)
					if PersonKFJ(id,12) then
					WAR.LXXS[WAR.Person[j]["人物编号"]]=1
					WAR.LXZT[WAR.Person[j]["人物编号"]]=WAR.LXZT[WAR.Person[j]["人物编号"]] or 0 + bb
										if WAR.LXZT[WAR.Person[j]["人物编号"]] > 50 then
					WAR.LXZT[WAR.Person[j]["人物编号"]] = 50
				    end	
					end					
					if PersonKFJ(id,38) then
					local cc=bb*50
                    JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - cc
				    WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - cc;			
					end
					if PersonKFJ(id,126) then
					WAR.FXXS[WAR.Person[j]["人物编号"]]=1
					WAR.FXDS[WAR.Person[j]["人物编号"]]=WAR.FXDS[WAR.Person[j]["人物编号"]] or 0 + bb
					if WAR.FXDS[WAR.Person[j]["人物编号"]] > 50 then
					WAR.FXDS[WAR.Person[j]["人物编号"]] = 50
				    end	
					end
					if PersonKFJ(id,129) then
                    WAR.SATA[id]=(WAR.SATA[id] or 0) +bb			
					end
					WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
					end
				end
			WAR.TZNQ=0
			end
		if  JY.Person[id]["主运内功"]== preneigong and nglw(id,105)>2 and  (preneigong == 105 or (preneigong == (106+GetS(112,0,0,0)) and TGPD(id)) )and JY.Person[id]["性别"]< 2 then----葵花内功性质调整，非太监性别才可
		    CurIDTXDH(WAR.CurID, 98, 1, "阴阳逆转.平衡调息")			
            if JY.Person[id]["内力性质"]== 0 then--
			   JY.Person[id]["内力性质"] = 1
			elseif JY.Person[id]["内力性质"]== 1 then
			   JY.Person[id]["内力性质"] = 2
			elseif JY.Person[id]["内力性质"]== 2 then
			   JY.Person[id]["内力性质"] = 0
			end
	    end
		return 20;    
		end
end

--无酒不欢：选择轻功菜单
function SelectQingGongMenu()
	local id, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
	local menu={};
	for i=1,CC.Kungfunum do
        menu[i]={JY.Wugong[JY.Person[id]["武功" .. i]]["名称"],nil,0};
		if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 7 then
			menu[i][3]=1;
		end
	end
    local main_qinggong =  ShowMenu(menu,#menu,0,CC.MainSubMenuX+21+4*(CC.Fontsmall+CC.RowPixel),CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
	if main_qinggong ~= nil and main_qinggong > 0 then
		CleanWarMap(4, 0)
		SetWarMap(x1, y1, 4, 1)
		War_ShowFight(id, 0, 0, 0, 0, 0, 9)	
		AddPersonAttrib(id, "体力", -10);
		WAR.YQG = 1
		JY.Person[id]["主运轻功"] = JY.Person[id]["武功" .. main_qinggong]
		return 10;
	end
end

--无酒不欢：战术菜单
function War_TacticsMenu()
	local menu={};
	menu[1]={"蓄力",nil,1};
	menu[2]={"防御",nil,1};
	menu[3]={"等待",nil,1};
    local r = ShowMenu(menu,#menu,0,CC.MainSubMenuX+15,CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
	--蓄力
	if r == 1 then
		return War_ActupMenu()
	--防御
	elseif r == 2 then
		return War_DefupMenu()
	--等待
	elseif r == 3 then
		return War_Wait()	
	--快捷键的额外判定
	elseif r == 4 then
		return 1
	end
end

--修炼武功
function War_PersonTrainBook(pid)
  local p = JY.Person[pid]
  local thingid = p["修炼物品"]
  if thingid < 0 then
    return 
  end
  JY.Thing[101]["加御剑能力"] = 1
  JY.Thing[123]["加拳掌功夫"] = 1
  local wugongid = JY.Thing[thingid]["练出武功"]
  local jlid = JY.Thing[thingid]["练出技能"]
  local wg = 0
  if JY.Person[pid]["武功12"] > 0 and wugongid >= 0 then
    for i = 1, CC.Kungfunum do
      if JY.Thing[thingid]["练出武功"] == JY.Person[pid]["武功" .. i] then
        wg = 1
      end
    end
  if wg == 0 then		--修复第一版本，不可修炼武功的BUG
  	return 
	end
  end
  if JY.Person[pid]["技能6"] > 0 and jlid >= 0 then
    for i = 1, CC.Skillnum do
      if JY.Thing[thingid]["练出技能"] == JY.Person[pid]["技能" .. i] then
        wg = 1
      end
    end
  if wg == 0 then		--修复第一版本，不可修炼技能的BUG
  	return 
	end
  end
  
  
	local yes1, yes2, kfnum = false, false, nil
	while true do 
		local needpoint = TrainNeedExp(pid)
		if needpoint <= p["修炼点数"] then
			yes1 = true
			AddPersonAttrib(pid, "生命最大值", JY.Thing[thingid]["加生命最大值"])
			--修炼血刀减少生命
			--狄云不减
			if thingid == 139 and match_ID(pid, 37) == false then
				AddPersonAttrib(pid, "生命最大值", -15)
				AddPersonAttrib(pid, "生命", -15)
				if JY.Person[pid]["生命最大值"] < 1 then
					JY.Person[pid]["生命最大值"] = 1
				end
			end
			if JY.Person[pid]["生命"] < 1 then
				JY.Person[pid]["生命"] = 1
			end
			--主角练小无不调和
			if JY.Thing[thingid]["改变内力性质"] == 2 then
				if thingid == 75 then
					if pid ~= 0 then
						p["内力性质"] = 2
					end
				else
					p["内力性质"] = 2
				end
			end
	    
			AddPersonAttrib(pid, "内力最大值", JY.Thing[thingid]["加内力最大值"])
			AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"])
			AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"])
			AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
			AddPersonAttrib(pid, "医疗能力", JY.Thing[thingid]["加医疗能力"])
			AddPersonAttrib(pid, "用毒能力", JY.Thing[thingid]["加用毒能力"])
			AddPersonAttrib(pid, "解毒能力", JY.Thing[thingid]["加解毒能力"])
			AddPersonAttrib(pid, "抗毒能力", JY.Thing[thingid]["加抗毒能力"])
			if MPPD(pid) == 8 then
			local gfqx = MPDJ(pid)
				AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"]*gfqx)
			    AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"]*gfqx)
			    AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"]*gfqx)
			end
			if match_ID(pid, 56) or match_ID(pid, 77) then		--黄蓉 萧中慧 双倍兵器值
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] * 2)
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] * 2)
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] * 2)
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] * 2)
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] * 2)
			else
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"])
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"])
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"])
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"])
			end
			if wglw(pid,77)>=1 and JY.Thing[thingid]["加特殊兵器"]>0 then
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加特殊兵器"])
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加特殊兵器"])
			end
			if wglw(pid,53)>=1  then
				AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
			end
			if match_ID_awakened(pid,72,1) then
			   if JY.Person[72]["论剑奖励"]==1 then
			   AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"])		   
			   end
			   if JY.Person[72]["论剑奖励"]==2 then
			   AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"])		   
			   end
			end

		if MPPD(pid) == 8 then		----沼跃鱼：桃花岛
		  local tssx = MPDJ(pid)
				AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] * tssx)
				AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] * tssx)
				AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] * tssx)
				AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] * tssx)
				AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] * tssx)
		end---
			
			AddPersonAttrib(pid, "暗器技巧", JY.Thing[thingid]["加暗器技巧"])
			AddPersonAttrib(pid, "武学常识", JY.Thing[thingid]["加武学常识"])
			AddPersonAttrib(pid, "品德", JY.Thing[thingid]["加品德"])
			AddPersonAttrib(pid, "攻击带毒", JY.Thing[thingid]["加攻击带毒"])
			if JY.Thing[thingid]["加攻击次数"] == 1 then
			  p["左右互搏"] = 1
			end
			if thingid > 186 then
			  p["修炼点数"] = p["修炼点数"] - needpoint
			end
			if JY.WGLVXS == 0 and thingid < 187 then
			  p["修炼点数"] = p["修炼点数"] - needpoint
			end
			
			if wugongid >= 0 then 
				yes2 = true
				local oldwugong = 0
				for i = 1, CC.Kungfunum do
					if p["武功" .. i] == wugongid then
						oldwugong = 1
						p["武功等级" .. i] = math.modf((p["武功等级" .. i] + 100) / 100) * 100
						kfnum = i
						break;
					end
				end
				if oldwugong == 0 then
					for i = 1, CC.Kungfunum do
						if p["武功" .. i] == 0 then
							p["武功" .. i] = wugongid
							p["武功等级" .. i] = 0;
							kfnum = i
							break;
						end
					end
				end
			end
			if jlid >= 0 then 
				
				local oldjl = 0
				for i = 1, CC.Skillnum do
					if p["技能" .. i] == jlid then
						oldjl = 1
						break;
					end
				end
				if oldjl == 0 then
					for i = 1, CC.Skillnum do
						if p["技能" .. i] == 0 then
							p["技能" .. i] = jlid
							yes2 = true
							break;
						end
					end
				end
			end
		else
			break;
		end
	end
	if yes1 then
		DrawStrBoxWaitKey(string.format("%s 修炼 %s 成功", p["姓名"], JY.Thing[thingid]["名称"]), C_WHITE, CC.DefaultFont)
	end
	if yes2  then
	   if wugongid >= 0 then
		--无酒不欢：自动到极的判定在这里
		if p["武功等级" .. kfnum] == 900 then
			--胡斐等人优先判定
			if (match_ID(pid, 1) and wugongid == 67) or (match_ID(pid, 37) and wugongid == 94) or (match_ID(pid, 38) and wugongid == 102) or (match_ID(pid, 49) and wugongid == 14) then
				DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"], math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
			--内功和轻功
			elseif JY.Wugong[wugongid]["武功类型"] == 6 or JY.Wugong[wugongid]["武功类型"] == 7 then
				--三大吸功直接到极
				if wugongid == 85 or wugongid == 87 or wugongid == 88 then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
				--天内天轻可以到极
				elseif (wugongid == p["天赋内功"] and wugongid ~= 105) or wugongid == p["天赋轻功"] then
					p["武功等级" .. kfnum] = 999
					DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
				else
					DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"], math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
				end
			--外功直接到极
			else
				p["武功等级" .. kfnum] = 999
				DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE, CC.DefaultFont)
			end
		else
			DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"], math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
		end
		elseif jlid >= 0 then
		DrawStrBoxWaitKey(string.format("%s 已习得技能 %s ", p["姓名"], CC.JL[jlid].name), C_WHITE, CC.DefaultFont)
		
	   end
	end
end

--特色指令
function War_TgrtsMenu()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	Cls()
	WAR.ShowHead = 0
	WarDrawMap(0)
	local grts_id;
	--如果是畅想
	if pid == 0 then
	    if JY.Base["畅想"]> 0 then
		grts_id = JY.Base["畅想"]
		if match_ID_awakened(pid,90,1) and JY.Person[90]["论剑奖励"] == 2  then
		grts_id ="90-1"
		end
		elseif JY.Base["特殊"]> 0 then
		grts_id ="0-1"
		end
	else
		grts_id = pid
		if match_ID_awakened(pid,90,1) and JY.Person[90]["论剑奖励"] == 2  then
		grts_id ="90-1"
		end
	end
	local yn = JYMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"确定", "取消"}, 2, WAR.tmp[5000+WAR.CurID])
	if yn == 2 then
		return 0
	end
 --郭襄的指令特殊
	if match_ID(pid, 626) then
		local wg = JYMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"弹指", "玉萧", "落英"}, 3, WAR.tmp[5000+WAR.CurID],1)
		if wg == 1 then
			JY.Person[pid]["武功1"] = 18
		elseif wg == 2 then
			JY.Person[pid]["武功1"] = 38
		elseif wg == 3 then
			JY.Person[pid]["武功1"] = 12
		end
		return 0
	else
		local yn = JYMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"确定", "取消"}, 2, WAR.tmp[5000+WAR.CurID])
		if yn == 2 then
			return 0
		end
	end 
	--段誉
	if match_ID(pid, 53) then
		if JY.Person[pid]["体力"] > 20 then
			WAR.TZ_DY = 1
			PlayWavE(16)
			CurIDTXDH(WAR.CurID, 72,1, "休迅飞凫 飘忽若神", M_DeepSkyBlue, 15);
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
  
	--虚竹
	if match_ID(pid, 49) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
		  JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
		  JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
		  local ssh = {}
		  local num = 1
		  for i = 0, WAR.PersonNum - 1 do
			local wid = WAR.Person[i]["人物编号"]
			if WAR.TZ_XZ_SSH[wid] ~= nil and WAR.TZ_XZ_SSH[wid] >= 1 and WAR.Person[i]["死亡"] == false then
			    local aa=math.modf(25*(1+0.1*WAR.TZ_XZ_SSH[wid]))
				local bb=20*aa
				local cc=2*aa
				--封穴25点
				if WAR.FXDS[wid] == nil then
					WAR.FXDS[wid] = aa
				else
					WAR.FXDS[wid] = WAR.FXDS[wid] + aa
				end
				if WAR.FXDS[wid] > 50 then
					WAR.FXDS[wid] = 50
				end
				if match_ID_awakened(pid, 49,1)  then----
				   if WAR.ICE[wid] == nil then
					  WAR.ICE[wid] = WAR.FXDS[wid]+aa
				   else
					WAR.ICE[wid] = WAR.ICE[wid] + WAR.FXDS[wid]+aa
				   end
				if WAR.ICE[wid] > 100 then
					WAR.ICE[wid] = 100
				end
				JY.Person[WAR.Person[i]["人物编号"]]["内力"] = JY.Person[WAR.Person[i]["人物编号"]]["内力"] - bb
				WAR.Person[i]["内力点数"] = (WAR.Person[i]["内力点数"] or 0) - bb;
				JY.Person[WAR.Person[i]["人物编号"]]["生命"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"] - cc
				WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - cc;
				end
				WAR.TZ_XZ_SSH[wid] = nil
				if WAR.Person[i].Time > 995 then
					WAR.Person[i].Time = 995
				end
				ssh[num] = {}
				ssh[num][1] = i
				ssh[num][2] = wid
				num = num + 1
			end
		  end
		  local name = {}
		  for i = 1, num - 1 do
			name[i] = {}
			name[i][1] = JY.Person[ssh[i][2]]["姓名"]
			name[i][2] = nil
			name[i][3] = 1
		  end
		  DrawStrBox(CC.MainMenuX, CC.MainMenuY, "催符：", C_GOLD, CC.DefaultFont)
		  ShowMenu(name, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
		  Cls()
		  PlayWavAtk(32)
		  if match_ID_awakened(pid, 49,1) then
		  CurIDTXDH(WAR.CurID, 72,1, "螺旋生死 夜叉轮回")
		  else
		  CurIDTXDH(WAR.CurID, 72,1, "符掌生死 德折群雄")
		  end
		  PlayWavE(8)
		  local sssid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
		  for DH = 114, 129 do
			for i = 1, num - 1 do
			  local x0 = WAR.Person[WAR.CurID]["坐标X"]
			  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
			  local dx = WAR.Person[ssh[i][1]]["坐标X"] - x0
			  local dy = WAR.Person[ssh[i][1]]["坐标Y"] - y0
			  local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			  local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
			  local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

			  ry = ry - hb
			  lib.PicLoadCache(3, DH * 2, rx, ry, 2, 192)
			  if DH > 124 then
				DrawString(rx - 10, ry - 15, "封穴", C_GOLD, CC.DefaultFont)
			  end
			end
			lib.ShowSurface(0)
			lib.LoadSur(sssid, 0, 0)
			lib.Delay(30)
		  end
		  lib.FreeSur(sssid)
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
  
  --人厨子
  if match_ID(pid, 89) then
    if JY.Person[pid]["体力"] > 25 and JY.Person[pid]["内力"] > 300 then
      local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
      local mxy = {
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1}, 
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1}, 
					{WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]}, 
					{WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}
      local zdp = {}
      local num = 1
      for i = 1, 4 do
        if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
          local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
          if inteam(WAR.Person[mid]["人物编号"]) then
          	zdp[num] = WAR.Person[mid]["人物编号"]
          	num = num + 1
        	end
        end
        
      end
      local zdp2 = {}
      for i = 1, num - 1 do
        zdp2[i] = {}
        zdp2[i][1] = JY.Person[zdp[i]]["姓名"] .. "·" .. JY.Person[zdp[i]]["体力"]
        zdp2[i][2] = nil
        zdp2[i][3] = 1
      end
      DrawStrBox(CC.MainMenuX, CC.MainMenuY, "气补：", C_GOLD, CC.DefaultFont)
      local r = ShowMenu(zdp2, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
      Cls()
      AddPersonAttrib(zdp[r], "体力", 50)
      AddPersonAttrib(pid, "体力", -25)
      AddPersonAttrib(pid, "内力", -300)
      PlayWavE(28)
      lib.Delay(10)
      CurIDTXDH(WAR.CurID, 86,1, "化气补元")
      local Ocur = WAR.CurID
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["人物编号"] == zdp[r] then
          WAR.CurID = i
        end
      end
      WarDrawMap(0)
      PlayWavE(36)
      lib.Delay(100)
      CurIDTXDH(WAR.CurID, 86, 1, "恢复体力50点")
      WAR.CurID = Ocur
      WarDrawMap(0)
    else
    	DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
    	return 0
    end
  end
  
  --张无忌
  if match_ID(pid, 9) then
    if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 500 then
      local nyp = {}
      local num = 1
      for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and i ~= WAR.CurID then
          nyp[num] = {}
          nyp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"]
          nyp[num][2] = nil
          nyp[num][3] = 1
          nyp[num][4] = i
          num = num + 1
        end
      end
      DrawStrBox(CC.MainMenuX, CC.MainMenuY, "挪移：", C_GOLD, CC.DefaultFont)
      local r = ShowMenu(nyp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
      Cls()
      local mid = WAR.Person[nyp[r][4]]["人物编号"]
      QZXS("请选择要将" .. JY.Person[mid]["姓名"] .. "挪移到什么位置？")
      War_CalMoveStep(WAR.CurID, 8, 1)
      local nx, ny = nil, nil
      while true do
	      nx, ny = War_SelectMove()
	      if nx ~= nil then
		      if lib.GetWarMap(nx, ny, 2) > 0 or lib.GetWarMap(nx, ny, 5) > 0 then
		        QZXS("此处有人！请重新选择")			--此处有人！请重新选择
	      	elseif CC.SceneWater[lib.GetWarMap(nx, ny, 0)] ~= nil then
	        	QZXS("水面，不可进入！请重新选择")		--水面，不可进入！请重新选择
	       	else
	       		break;
	        end
	      end
	    end
	    PlayWavE(5)
	    CurIDTXDH(WAR.CurID, 88,1, "九阳明尊 挪移乾坤")		--九阳明尊 挪移乾坤
	    local Ocur = WAR.CurID
	    WAR.CurID = nyp[r][4]
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
	    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
	    WarDrawMap(0)
	    CurIDTXDH(WAR.CurID, 88,1)
	    WAR.CurID = Ocur
	    AddPersonAttrib(pid, "体力", -10)
	    AddPersonAttrib(pid, "内力", -500)
	    
	  else
	  	DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
	  	return 0
	  end
	end
	
	--祖千秋
	if match_ID(pid, 88) then
	  if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 700 then
	    local dxp = {}
	    local num = 1
	    for i = 0, WAR.PersonNum - 1 do
	      if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and i ~= WAR.CurID then
	        dxp[num] = {}
	        dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"]
	        dxp[num][2] = nil
	        dxp[num][3] = 1
	        dxp[num][4] = i
	        num = num + 1
	      end
	    end
	    DrawStrBox(CC.MainMenuX, CC.MainMenuY, "传功：", C_GOLD, 30)
	    local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
	    Cls()
	    local mid = WAR.Person[dxp[r][4]]["人物编号"]
	    PlayWavE(28)
	    lib.Delay(10)
	    CurIDTXDH(WAR.CurID,87,1, "酒神戏红尘")
	    local Ocur = WAR.CurID
	    WAR.CurID = dxp[r][4]
	    WarDrawMap(0)
	    PlayWavE(36)
	    lib.Delay(100)
	    CurIDTXDH(WAR.CurID, 87, 1, "集气上升500")
	    WAR.CurID = Ocur
	    WarDrawMap(0)
	    WAR.Person[dxp[r][4]].Time = WAR.Person[dxp[r][4]].Time + 500
	    if WAR.Person[dxp[r][4]].Time > 999 then
	      WAR.Person[dxp[r][4]].Time = 999
	    end
	    AddPersonAttrib(pid, "体力", -10)
	    AddPersonAttrib(pid, "内力", -1000)
	  else
	  	DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
	  	return 0
		end
	end
	
	--蓝烟清：霍青桐统率指令，我方全体集气值加200点
	if match_ID(pid, 74) then
		if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 150 then
			CurIDTXDH(WAR.CurID, 92,1, "统率");		--动画显示
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
					WAR.Person[i].Time = WAR.Person[i].Time + 200;
					if WAR.Person[i].Time > 999 then
						WAR.Person[i].Time = 999;
					end
				end
			end
			AddPersonAttrib(pid, "体力", -10)
			AddPersonAttrib(pid, "内力", -150)
			lib.Delay(100)
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
	  	return 0
		end
	end
	
	--萧中慧，慧心
	if match_ID(pid, 77) then
		if JY.Person[pid]["生命"] > 500 and JY.Person[pid]["受伤程度"] < 50 then
			local zjwid = nil
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["人物编号"] == 0 and WAR.Person[i]["死亡"] == false then
					zjwid = i
					break
				end
			end
			if zjwid ~= nil then
				DrawStrBoxWaitKey("我心本慧·侠女柔情", C_RED, 36)
				say("２慧妹……！",0,1)
				if JY.Person[0]["性别"] == 0 then
					say("１ｎ哥哥，９请…………２加油！",77,0)
				else
					say("１ｎ姐姐，９请…………２加油！",77,0)
				end
				JY.Person[pid]["生命"] = 1
				JY.Person[pid]["受伤程度"] = 100
				WAR.Person[WAR.CurID].Time = -500
				JY.Person[0]["生命"] = JY.Person[0]["生命最大值"]
				JY.Person[0]["受伤程度"] = 0
				WAR.Person[zjwid].Time = 999
				WAR.FXDS[0] = nil
				WAR.LQZ[0] = 100
			else
				DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)		-- "未满足发动条件"
				return 0
			end

		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)		-- "未满足发动条件"
			return 0
		end
	end
	
	--蓝烟清：王难姑特色指令 - 施毒  周围五格范围内的敌人时序中毒并时序减血
	if match_ID(pid, 17) then
		if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 300 then
			CleanWarMap(4,0);
			AddPersonAttrib(pid, "体力", -15)
			AddPersonAttrib(pid, "内力", -300)
			local x1 = WAR.Person[WAR.CurID]["坐标X"];
			local y1 = WAR.Person[WAR.CurID]["坐标Y"];
			for ex = x1 - 5, x1 + 5 do
				for ey = y1 - 5, y1 + 5 do
					SetWarMap(ex, ey, 4, 1)
					if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
						local ep = GetWarMap(ex, ey, 2)
						if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
	          
							WAR.L_WNGZL[WAR.Person[ep]["人物编号"]] = 50;			--50时序内持续减中毒+减血
							SetWarMap(ex, ey, 4, 4)
						end
					end
				end
			end
			War_ShowFight(pid,0,0,0,x1,y1,30);
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	
	--brolycjw：胡青牛特色指令 - 群疗  周围五格范围内的队友时序回内伤并按比例回血
	if match_ID(pid, 16) then
		if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 300 then
			CleanWarMap(4,0);
			AddPersonAttrib(pid, "体力", -15)
			AddPersonAttrib(pid, "内力", -300)
			local x1 = WAR.Person[WAR.CurID]["坐标X"];
			local y1 = WAR.Person[WAR.CurID]["坐标Y"];
			
			for ex = x1 - 5, x1 + 5 do
				for ey = y1 - 5, y1 + 5 do
					SetWarMap(ex, ey, 4, 1)
					if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
						local ep = GetWarMap(ex, ey, 2)
						if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then
				  
							WAR.L_HQNZL[WAR.Person[ep]["人物编号"]] = 20;			--20时序内持续回血+回内伤
							SetWarMap(ex, ey, 4, 4)
					  
						end
					end
				end
			end
			War_ShowFight(pid,0,0,0,x1,y1,0);

		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
--慕容复 幻梦
	if match_ID(pid, 51) then
		if JY.Person[pid]["体力"] > 20 then
			WAR.TZ_MRF = 1
			CurIDTXDH(WAR.CurID, 127,1, "顾盼子孙贤 铭记复国志", C_GOLD);
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	
	--小昭 影步
	if match_ID(pid, 66) then
		if JY.Person[pid]["体力"] > 30 then
			War_CalMoveStep(WAR.CurID, 10, 0)
			WAR.XZ_YB[1],WAR.XZ_YB[2]=War_SelectMove()
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 20
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	
	--钟灵指令 灵貂
	if match_ID(pid, 90) then
		if JY.Person[pid]["体力"] > 10 then
		local qishu = 1
		if match_ID_awakened(pid,90,1) then
		WAR.SATA[pid] = limitX((WAR.SATA[pid] or 0)+5,0,50)
		end
        if JY.Person[90]["论剑奖励"] == 2 then
		qishu = LDZL(pid)
		WAR.YSLS[pid] = qishu
		end
		if  qishu == 1 then
			War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				for i = 1, 4 do
					if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] then
						WAR.TD = JY.Person[eid]["携带物品" .. i]
						WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
						JY.Person[eid]["携带物品数量" .. i] = 0
						JY.Person[eid]["携带物品" .. i] = -1
						break
					end
				end
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)
				if JY.Person[90]["论剑奖励"] == 1 then
				local aa = JY.Person[eid]["中毒程度"]
				WAR.Person[tdID]["生命点数"] = (WAR.Person[tdID]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -aa)
				WAR.Person[tdID]["内力点数"] = (WAR.Person[tdID]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -aa*5)
				WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", math.modf(aa*1.5))
				WAR.XRZT[eid] = 20
				CurIDTXDH(WAR.CurID, 87,1, "六库仙贼.盗灵", C_GOLD)
				end			
				if JY.Person[90]["论剑奖励"] == 2 and JY.Person[eid]["中毒程度"]>=100   then
				WAR.Person[tdID]["生命点数"] = (WAR.Person[tdID]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -100)
						if JY.Person[eid]["生命"] < 1 then
						JY.Person[eid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
					    end	
				CurIDTXDH(WAR.CurID, 91,1, "驱役兽灵.灵貂绝盗", C_GOLD)
				else
				WAR.Person[tdID]["中毒点数"] = (WAR.Person[tdID]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 50)
				end
				WAR.TXXS[eid] = 1
				War_ShowFight(0, 0, 0, 0, 0, 0, 12)
				if WAR.TD ~= -1 then
					if WAR.TD == 118 then
						say("１想要从我慕容复手中偷东西？哼哼，下辈子吧！", 51,0)
					else
						instruct_2(WAR.TD, WAR.TDnum)
					end
					WAR.TD = -1
					WAR.TDnum = 0
				end
				WAR.TXXS[eid] = nil
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
			else
				return 0
			end
		elseif  qishu == 2 then
            War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)					
				CurIDTXDH(WAR.CurID, 91,1, "驱役兽灵.玄蛇绝咬", C_GOLD)
                WAR.SJSD[eid] = 10
				WAR.JJGD[eid] = 2
	            WAR.JCGD[eid] = 1
				WAR.RXSD[eid] =  1
				WAR.TXXS[eid] = 1
				War_ShowFight(0, 0, 0, 0, 0, 0, 13)
				WAR.TXXS[eid] = nil
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			else
				return 0
			end
		elseif  qishu == 3 then	
            War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)					
				CurIDTXDH(WAR.CurID, 91,1, "驱役兽灵.风枭展翅", C_GOLD)
                WAR.LHFM[eid] = 20
				if WAR.Person[tdID].Time<0 then
				local aa = WAR.Person[tdID].Time
				WAR.Person[tdID]["生命点数"] = (WAR.Person[tdID]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa)
						if JY.Person[eid]["生命"] < 1 then
						JY.Person[eid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
					    end	
				end
				War_ShowFight(0, 0, 0, 0, 0, 0, 14)
				WAR.TXXS[eid] = nil
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 20
			else
				return 0
			end 
		elseif  qishu == 4 then	
            War_CalMoveStep(WAR.CurID, 8, 1)
			local x,y = War_SelectMove()
			if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
				local tdID = lib.GetWarMap(x, y, 2)
				local eid = WAR.Person[tdID]["人物编号"]
				local x0, y0 = WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]
				local x1, y1 = WAR.Person[tdID]["坐标X"],WAR.Person[tdID]["坐标Y"]
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
				CleanWarMap(4, 0)
				SetWarMap(x1, y1, 4, 1)					
				CurIDTXDH(WAR.CurID, 91,1, "驱役兽灵.心猿归正", C_GOLD)
                JY.Person[tdID]["灼烧程度"]=limitX((JY.Person[tdID]["灼烧程度"] or 0) + 30,0,50)
				if WAR.LQZ[eid]~= nil  then
				local aa = -WAR.LQZ[eid]*5
				WAR.LQZ[eid] = nil
					    WAR.Person[tdID]["生命点数"] = (WAR.Person[tdID]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", aa)
						if JY.Person[eid]["生命"] < 1 then
						JY.Person[eid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
					    end	
				end
				War_ShowFight(0, 0, 0, 0, 0, 0, 14)
				WAR.TXXS[eid] = nil
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 20
			else
				return 0
			end			
		end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	
	--胡斐 飞狐
	if match_ID(pid, 1) then
		if JY.Person[pid]["体力"] > 20 then
			War_CalMoveStep(WAR.CurID, 10, 2)
			local x,y = War_SelectMove()
			if not x then
				return 0
			end
			if GetWarMap(x, y, 1) > 0 or GetWarMap(x, y, 2) > 0 or GetWarMap(x, y, 5) > 0 or CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
				return 0
			else
				CurIDTXDH(WAR.CurID, 25,1, "雪山飞狐", Violet);
				WAR.Person[WAR.CurID]["移动步数"] = 10
				War_MovePerson(x, y, 1)
				WAR.Person[WAR.CurID]["移动步数"] = 0
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	
	--鸠摩智 幻化
	if match_ID(pid, 103) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			local thing = {}
			local thingnum = {}
			for i = 0, CC.MyThingNum - 1 do
				thing[i] = -1
				thingnum[i] = 0
			end
			local num = 0
			for i = 0, CC.MyThingNum - 1 do
				local id = JY.Base["物品" .. i + 1]
				if id >= 0 then
					if JY.Thing[id]["类型"] == 2 and JY.Thing[id]["练出武功"] > -1 then
						thing[num] = id
						thingnum[num] = JY.Base["物品数量" .. i + 1]
						num = num + 1
					end
				end 
			end
			local r = SelectThing(thing, thingnum)
			if r >= 0 then
				CurIDTXDH(WAR.CurID, 93,1, "无相幻化", C_GOLD)
				JY.Person[pid]["武功2"]= JY.Thing[r]["练出武功"]
				if match_ID_awakened(pid, 103,1) then--
				local aa = JY.Person[pid]["武功2"]
				SetTianWai(pid, 2, aa)
				  if GetS(113,0,0,0) ~= 0 then
				  setWG(aa)
				  end
				end
				JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
				JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
			else
				return 0
			end
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	

	--黄蓉 遁甲
	if match_ID(pid, 56) then
		if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
			local x,y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
			--1绿色，2红色，3蓝色，4紫色
			CleanWarMap(6,-1);
					
			local QMDJ = {"休","生","伤","杜","景","死","惊","开"}
						
			--在自身周围绘制奇阵
			SetWarMap(x,y, 6, math.random(4))
			
			for j=1, 2 do
				SetWarMap(x + math.random(6), y + math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
						
			for j=3, 4 do
				SetWarMap(x + math.random(6), y - math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
						
			for j=5, 6 do
				SetWarMap(x - math.random(6), y - math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
						
			for j=7, 8 do
				SetWarMap(x - math.random(6), y + math.random(6), 6, math.random(4));
				for i = 30, 40 do
					NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
					ShowScreen()
					if i == 40 then
						lib.Delay(300)
						Cls()
					else
						lib.Delay(1)
					end
				end
			end
			JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
			JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
		else
			DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
			return 0
		end
	end
	
		--阿紫，禁药
	if match_ID(pid, 47) then
		WAR.JYZT[pid] = 1
		CurIDTXDH(WAR.CurID, 128,1, "禁药", C_RED);
		return 20
	end
	
	if pid == 0 and JY.Base["特殊"] > 0 then --武骧金星：八部斗策开始
			if JY.Person[pid]["体力"] >= 8 then	
				local zhilingnum = 1 + JY.Base["天书数量"]
				zhilingnum = math.min(zhilingnum, 8)
				Cls()
				local qishu = JYMsgBox("斗策", "要选择哪一个指令？", {"乾", "修", "摩", "夜", "紧", "迦", "龙", "天"}, zhilingnum, pid)	
				if qishu <= 0 then
					return 0
				end
				if qishu == 1 then
					local zh = JYMsgBox("乾达婆", "恢复指定队友生命350 内伤35", {"确定", "取消"}, 2, pid)
					if zh == 1 then
						local dxp = {}
						local num = 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								dxp[num] = {}
								dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"] 
								dxp[num][2] = nil
								dxp[num][3] = 1
								dxp[num][4] = i
								num = num + 1
							end
						end
						if num <= 1 then
							DrawStrBoxWaitKey("场上没有可施展的目标", C_WHITE, 30)
							return 0							
						end
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "乾达婆", C_GOLD, 30)
						local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
						Cls()
						local mid = WAR.Person[dxp[r][4]]["人物编号"]
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1				
						AddPersonAttrib(mid, "生命", 350)
						AddPersonAttrib(mid, "受伤程度", -35)
						CurIDTXDH(WAR.CurID, 73,1, "八部斗策 香阴 乾闼婆")
					else
						return 0
					end
				elseif qishu == 2 then
					local zh = JYMsgBox("阿修罗", "指定队友下次攻击增加一次连击且首击必暴击", {"确定", "取消"}, 2, pid)
					if zh == 1 then
						local dxp = {}
						local num = 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								dxp[num] = {}
								dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"] 
								dxp[num][2] = nil
								dxp[num][3] = 1
								dxp[num][4] = i
								num = num + 1
							end
						end
						if num <= 1 then
							DrawStrBoxWaitKey("场上没有可施展的目标", C_WHITE, 30)
							return 0							
						end
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "阿修罗", C_GOLD, 30)
						local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
						Cls()
						local mid = WAR.Person[dxp[r][4]]["人物编号"]
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						WAR.AXL = mid
						CurIDTXDH(WAR.CurID, 73,1, "八部斗策 非天 阿修罗")
					else
						return 0					
					end
				elseif qishu == 3 then					
					local xy = JYMsgBox("摩呼罗迦", "敌全体集气下降200点 封穴4至6时序", {"确定", "取消"}, 2, pid)
					if xy == 1 then
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "摩呼罗迦", C_GOLD, 30)
						Cls()					
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] == false and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								WAR.Person[i].Time = math.max(WAR.Person[i].Time - 200, -500)
								WAR.FXXS[WAR.Person[i]["人物编号"]] = 1 --封穴判定
								if WAR.FXDS[WAR.Person[i]["人物编号"]] ~= nil then
									WAR.FXDS[WAR.Person[i]["人物编号"]] = WAR.FXDS[WAR.Person[i]["人物编号"]] + math.random(4,6) --封穴点数
								else
									WAR.FXDS[WAR.Person[i]["人物编号"]] = math.random(4,6)
								end
							end
						end
						CurIDTXDH(WAR.CurID, 73,1, "八部斗策 地龙 摩呼罗迦")
					else
						return 0					
					end
				elseif qishu == 4 then
					local zh = JYMsgBox("夜叉", "提升指定队友怒气值60点及恢复体力15点", {"确定", "取消"}, 2, pid)
					if zh == 1 then
						local dxp = {}
						local num = 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								dxp[num] = {}
								dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"] 
								dxp[num][2] = nil
								dxp[num][3] = 1
								dxp[num][4] = i
								num = num + 1
							end
						end
						if num <= 1 then
							DrawStrBoxWaitKey("场上没有可施展的目标", C_WHITE, 30)
							return 0							
						end
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "夜叉", C_GOLD, 30)
						local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
						Cls()
						local mid = WAR.Person[dxp[r][4]]["人物编号"]
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						WAR.LQZ[mid] = (WAR.LQZ[mid] or 0) + 60
						--怒气暴发
						if WAR.LQZ[mid] ~= nil and 100 < WAR.LQZ[mid] then
							WAR.LQZ[mid] = 100
							WAR.Person[dxp[r][4]]["特效动画"] = 6
							if WAR.Person[dxp[r][4]]["特效文字3"] ~= nil then
							WAR.Person[dxp[r][4]]["特效文字3"] = WAR.Person[dxp[r][4]]["特效文字3"] .. CC.WARS117
							else
								WAR.Person[dxp[r][4]]["特效文字3"] = CC.WARS118
							end
						end	
						AddPersonAttrib(mid, "体力", 15)
						CurIDTXDH(WAR.CurID, 69,1, "八部斗策 执金刚神 夜叉")
					else
						return 0					
					end
				elseif qishu == 5 then
					local xy = JYMsgBox("紧那罗", "降低指定敌方人物的怒气值60点", {"确定", "取消"}, 2, pid)
					if xy == 1 then
						local dxp = {}
						local num = 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] == false and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								dxp[num] = {}
								dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"] 
								dxp[num][2] = nil
								dxp[num][3] = 1
								dxp[num][4] = i
								num = num + 1
							end
						end
						if num <= 1 then
							DrawStrBoxWaitKey("场上没有可施展的目标", C_WHITE, 30)
							return 0							
						end
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "紧那罗", C_GOLD, 30)
						local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
						Cls()
						local mid = WAR.Person[dxp[r][4]]["人物编号"]
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						WAR.LQZ[mid] = limitX((WAR.LQZ[mid] or 0) - 60, 0, 100)
						CurIDTXDH(WAR.CurID, 70,1, "八部斗策 人非人 紧那罗")
					else
						return 0					
					end
				elseif qishu == 6 then
					local xy = JYMsgBox("迦楼罗", "提升指定队友当前集气值750点", {"确定", "取消"}, 2, pid)
					if xy == 1 then
						local dxp = {}
						local num = 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								dxp[num] = {}
								dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"] 
								dxp[num][2] = nil
								dxp[num][3] = 1
								dxp[num][4] = i
								num = num + 1
							end
						end
						if num <= 1 then
							DrawStrBoxWaitKey("场上没有可施展的目标", C_WHITE, 30)
							return 0							
						end
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "迦楼罗", C_GOLD, 30)
						local r = ShowMenu(dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
						Cls()
						local mid = WAR.Person[dxp[r][4]]["人物编号"]
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						WAR.Person[dxp[r][4]].Time = WAR.Person[dxp[r][4]].Time + 750
						if WAR.Person[dxp[r][4]].Time > 999 then
						WAR.Person[dxp[r][4]].Time = 999
						end
						CurIDTXDH(WAR.CurID, 71,1, "八部斗策 金翅鸟 迦楼罗")
					else
						return 0					
					end
				elseif qishu == 7 then					
					local xy = JYMsgBox("龙王", "提升全体队友生命值500点", {"确定", "取消"}, 2, pid)
					if xy == 1 then
						DrawStrBox(CC.MainMenuX, CC.MainMenuY, "龙王", C_GOLD, 30)
						Cls()					
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						for i = 0, WAR.PersonNum - 1 do 
							if WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false and i ~= WAR.CurID then
								AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", 500)
							end
						end
						CurIDTXDH(WAR.CurID, 72,1, "八部斗策 那伽 龙王")
					else
						return 0					
					end
				elseif qishu == 8 then
					local zl = JYMsgBox("天王", "斗神接下来30个时序内必然发动太古斗气", {"确定", "取消"}, 2, pid)
					if zl == 1 then				
                        WAR.DSTG[645] = 30
						AddPersonAttrib(pid, "体力", -8)
						WAR.DOUCE = WAR.DOUCE + 1
						CurIDTXDH(WAR.CurID, 73,1, "八部斗策 提婆 天王")
					else
						return 0
					end								
				end
					
			end --八部斗策结束
			end
	
	return 1
end

--战斗蓄力
function War_ActupMenu()
	local p = WAR.CurID
	local id = WAR.Person[p]["人物编号"]
	local x0, y0 = WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"]
	local str="" 
	--主运蛤蟆蓄力带防御效果
	if match_ID_awakened(id,64,1) then
	   WAR.Actup[id] = 2
	   local aa = 1
       addeffect2(WAR.ZBT1,id,aa)
       if WAR.ZBT1[id]>=7 then
          WAR.ZBT1[id]=7
       end
       local bb=WAR.ZBT1[id]
	   local acd={"一","二","三","四","五","六","七"}
       str=acd[bb].."重螺旋气劲"
	   	CurIDTXDH(WAR.CurID, 73,1);
		DrawStrBox(-1, -1, str, Violet, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
     elseif id == 645 and JY.Base["斗神"] == 64 then
	   WAR.Actup[id] = 2
	   local aa = math.random(3,5)
       addeffect2(WAR.ZBT1,id,aa)
       if WAR.ZBT1[id]>=7 then
          WAR.ZBT1[id]=7
       end
       local bb=WAR.ZBT1[id]
	   local acd={"一","二","三","四","五","六","七"}
       str=acd[bb].."重螺旋气劲"
	   	CurIDTXDH(WAR.CurID, 73,1);
		DrawStrBox(-1, -1, str, Violet, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)		
  	 elseif Curr_NG(id, 95) then
		WAR.Actup[id] = 2;
		WAR.Defup[id] = 1
		WAR.HMGXL[id] = 1
		CurIDTXDH(WAR.CurID, 85,1);
		DrawStrBox(-1, -1, "攻守兼备·蓄势待发", LightSlateBlue, CC.DefaultFont)
		if nglw(id,95)>1 then
		CurIDTXDH(WAR.CurID, 73,1)
		WAR.HMJT[id] = limitX((WAR.HMJT[id] or 0) + math.modf(JY.Person[id]["内力"]*nglw(id,95)*0.15),0,3000)
		end
		ShowScreen()
		lib.Delay(400)
	--被动紫霞蓄力强化
	elseif PersonKF(id, 89) then
		WAR.Actup[id] = 2
		if inteam(id) then
			WAR.ZXXS[id] = 1 + math.modf(JY.Base["天书数量"]/7)
			if MPPB_WYQZ(id) == 1 then--
			WAR.ZXXS2[id] = limitX((WAR.ZXXS2[id] or 0) + MPDJ(id)*2,0,10)
			end
		else
			WAR.ZXXS[id] = 3
			if MPPB_WYQZ(id) == 1 then--
			WAR.ZXXS2[id] = limitX((WAR.ZXXS2[id] or 0) + MPDJ(id)*2,0,10)
			end
		end
		CurIDTXDH(WAR.CurID, 85, 1);
		DrawStrBox(-1, -1, "紫霞蓄势·连绵不绝", Violet, CC.DefaultFont, M_DeepSkyBlue)
		ShowScreen()
		lib.Delay(400)		
	--被动龙象蓄力带防御效果
	elseif PersonKF(id, 103) then
	    local aa = "龙之蓄力·象之防御"
		local bb = 85
		WAR.Actup[id] = 2;
		WAR.Defup[id] = 1
		if nglw(id,103)>=1  then
		WAR.Actup2[id] = 2
        aa="龙象大力.无上秘法"	
        bb = 86		
		end
		CurIDTXDH(WAR.CurID, bb, 1);
		DrawStrBox(-1, -1, aa, LightGreen, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
    elseif  MPPD(id) == 4 then			--密宗蓄力必成功
        WAR.Actup[id] = 2		
	--被动龙象蓄力带防御效果	
	--标主蓄力必成功
	elseif id == 0 and JY.Base["标准"] > 0 then
		WAR.Actup[id] = 2
	--NPC蓄力必成功
	elseif not inteam(id) then
		WAR.Actup[id] = 2
	--常态70%几率成功
	elseif JLSD(15, 85, id) then
		WAR.Actup[id] = 2
	end
	if (WAR.Actup[id] or 0) <2 then
		Cls()
		DrawStrBox(-1, -1, "蓄力失败", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
	else
		CurIDTXDH(WAR.CurID, 85, 1);
		DrawStrBox(-1, -1, "蓄力成功", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
	end
	if WAR.Actup2[id]~=nil  then
		Cls()
		CurIDTXDH(WAR.CurID, 90, 1);
		DrawStrBox(-1, -1, "大蓄力", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)
    end		
	if wglw(id,74)>=1 and  (WAR.Actup[id] or 0) >= 2 then
		CurIDTXDH(WAR.CurID, 74, 1);
		DrawStrBox(-1, -1, "鹤蛇咏春.蛇之架构", C_GOLD, CC.DefaultFont)
		WAR.SHJG[id] = 1
		ShowScreen()
		lib.Delay(400)
	end
    if wglw(id,22)>2 and (WAR.Actup[id] or 0) >= 2 then
		WAR.Defup[id] = 1
		CurIDTXDH(WAR.CurID, 69, 1);
		DrawStrBox(-1, -1, "金刚奥义·刚掌斗气阵", C_GOLD, CC.DefaultFont)
		ShowScreen()
		lib.Delay(400)	
	end
	if nglw(id,107)>2 then
	   if WAR.JYZQ[id] ~=nil and WAR.JYZQ[id]>0 then
	     local aa = WAR.JYZQ[id]
		 if aa>=9 then
		 aa = 9
		 end
		 WAR.LXJY = math.random(0,aa)
		 if WAR.LXJY<= 1then
		 WAR.LXJY = 1
		 end
		 WAR.JYZQ[id] =WAR.JYZQ[id] - WAR.LXJY
		 if WAR.JYZQ[id]<0 then
		 WAR.JYZQ[id] = nil
		 end
		 local acd={"一","二","三","四","五","六","七","八","九"}
         str=acd[WAR.LXJY].."重气劲"
		 CurIDTXDH(WAR.CurID, 76, 1);
		DrawStrBox(-1, -1, "螺旋九影·"..str, Violet, CC.DefaultFont)
		 if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
	     War_Auto()
		 else
		 War_FightMenu()
		 end
		 WAR.LXJY = 0
	   end
	end
    if nglw(id,106)>2  then  
	   if WAR.JYHT[id]~=nil then
	   CurIDTXDH(WAR.CurID, 77, 1);
	   DrawStrBox(-1, -1, "九阳罡气·馈", M_DeepSkyBlue, CC.DefaultFont)
       WAR.JYHT_FK[id] = 1
	   end
	end
  
	 if wglw(id,51)>=1 then
	 local  k = 0
        if WAR.LSDZ[id] == nil then
		WAR.LSDZ[id] = 1
		k = 1
		elseif wglw(id,51)>1  then 
		WAR.LSDZ[id] = WAR.LSDZ[id] + 3
		  if WAR.LSDZ[id] >4 then
		  WAR.LSDZ[id] = 1
		  end
		k=1
		else
		
		end
		if k == 1  then
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 20, 1, "罗刹阵图.凶阴易位", M_Blue);
		  if wglw(id,51)>=2 then
		  WAR.GSSL[id] = WAR.LSDZ[id]
		  CurIDTXDH(WAR.CurID, 20, 1, "鬼神敕令.圣魔凭依", M_Blue);
		  end
		end
	end	
	
	return 1
end


--战斗防御
function War_DefupMenu()
	local p = WAR.CurID
	local id = WAR.Person[p]["人物编号"]
	local x0, y0 = WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"]
	WAR.Defup[id] = 1
	Cls()
	local hb = GetS(JY.SubScene, x0, y0, 4)

	CurIDTXDH(WAR.CurID, 86,1);
	DrawStrBox(-1, -1, "防御开始", LimeGreen, CC.DefaultFont, C_GOLD)
	ShowScreen()
	lib.Delay(400)
	  
	--太玄防御带蓄力
	if PersonKF(id, 102) then
		WAR.Actup[id] = 2;
		CurIDTXDH(WAR.CurID, 86,1);
		DrawStrBox(-1, -1, "守中带攻·太玄蓄力", C_RED, CC.DefaultFont, C_GOLD)
		ShowScreen()
		lib.Delay(400)
	end

	--秘孔蓄力
	if wglw(id,127)>2 and PersonKF(id, 39) then
		CurIDTXDH(WAR.CurID, 138,1);
		DrawStrBox(-1, -1, "暗杀秘孔奥义·天破架构", C_RED, CC.DefaultFont, C_GOLD)
		ShowScreen()
		lib.Delay(400)
	end
	

	
	if wglw(id,74)>=1  then
		CurIDTXDH(WAR.CurID, 68, 1);
		DrawStrBox(-1, -1, "鹤蛇咏春.鹤之架构", C_GOLD, CC.DefaultFont)
		WAR.SHJG[id] = 2
		ShowScreen()
		lib.Delay(400)
	end
	
	if nglw(id,104)>2 then
	   if WAR.NYZQ[id] ~=nil and WAR.NYZQ[id]>=1 then
	     local aa = WAR.NYZQ[id]
		 if aa>=6 then
		 aa = 6
		 end
		 local bb = math.random(0,aa)
		 if bb<= 1 then
		 bb = 1
		 end
		 WAR.NYZQ[id] =WAR.NYZQ[id] - bb
		 if WAR.NYZQ[id]<=0 then
		 WAR.NYZQ[id] = nil
		 end
		 local acd={"一","二","三","四","五","六"}
         local str=acd[bb].."重蓄势"
		 WAR.NZWF[id] = bb
		 CurIDTXDH(WAR.CurID, 76,1,"六段回声·"..str, Violet);
	   end
	end

	 if wglw(id,51)>=1 then
	 local  k = 0
        if WAR.LSDZ[id] == nil then
		WAR.LSDZ[id] = 2
		k = 1
		elseif wglw(id,51)>1  then 
		WAR.LSDZ[id] = WAR.LSDZ[id] + 3
		  if WAR.LSDZ[id] >5 then
		  WAR.LSDZ[id] = 2
		  end
		k=1
		else
		
		end
		if k == 1  then
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 29, 1, "罗刹阵图.幽疯交替", M_Blue);
		  if wglw(id,51)>=2 then
		  WAR.GSSL[id] = WAR.LSDZ[id]
		  CurIDTXDH(WAR.CurID, 20, 1, "鬼神敕令.圣魔凭依", M_Blue);
		  end
		end
	end
	
	return 1
end

--设置人物的集气值，返回一个综合值以便循环刷新集气条
function GetJiqi()
	local num, total = 0, 0
	--无酒不欢：轻功对于人物集气的影响函数
	local function getnewmove(x)
		if x > 160 then
			return 6 + (x - 160) / 60
		elseif x > 80 then
			return 4 + (x - 80) / 40
		elseif x > 30 then
			return 2 + (x - 30) / 25
		else
			return x / 15
		end
	end
	--无酒不欢：内力对于人物集气的影响函数
	local function getnewmove1(a, b)
		local x = (a * 2 + b) / 3
		if x > 5600 then
			return 8 + math.min((x - 5600) / 1200, 3)
		elseif x > 3600 then
			return 6 + (x - 3600) / 1000
		elseif x > 2000 then
			return 4 + (x - 2000) / 800
		elseif x > 800 then
			return 2 + (x - 800) / 600
		else
			return x / 400
		end
	end
	--无酒不欢：敌人集气随难度变化
	local function NPCjiqimod(nd)
		local x;
		if nd == 1 then
			return 0.8
		elseif nd == 2 then
			return 1.1
		elseif nd == 3 then
			return 1.5
		elseif nd == 4 then
			return 1.7
		elseif nd == 5 then
			return 1.9
		elseif nd == 6 then
			return 2.2
		end
	end
	for i = 0, WAR.PersonNum - 1 do
		if not WAR.Person[i]["死亡"] then
			local id = WAR.Person[i]["人物编号"]
			WAR.Person[i].TimeAdd = (getnewmove(WAR.Person[i]["轻功"]) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
			if WAR.ZLLY[id]~=nil then
			WAR.Person[i].TimeAdd = (getnewmove(math.modf(WAR.Person[i]["轻功"]*0.75)) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
			end

			if WAR.FZLY[id]~=nil then
			WAR.Person[i].TimeAdd = (getnewmove(math.modf(WAR.Person[i]["轻功"]*1.25)) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
			end	
			
			if match_ID(id,449)  then----
			WAR.Person[i].TimeAdd = math.modf(getnewmove(WAR.Person[i]["轻功"])*1.25) + WAR.Person[i].TimeAdd
			end
			
			

			if wglw(id,55)>=1  then ---狂风身法
				WAR.Person[i].TimeAdd = math.modf(getnewmove(WAR.Person[i]["轻功"])*(1+0.15*wglw(id,55))) + WAR.Person[i].TimeAdd
			end
			--敌人根据难度集气速度额外增加
			if not inteam(id) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * NPCjiqimod(JY.Base["难度"]))
			else	
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd)
			end
			
			     if WAR.FZ[id] ~=nil and WAR.FZ[id][3] ~=nil  then
				    local aa = WAR.FZ2[id][3]
	                local a = (getnewmove(math.modf(WAR.Person[i]["轻功"]*(1+0.05*aa))) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
					WAR.Person[i].TimeAdd = math.max(a,WAR.Person[i].TimeAdd)
	             end 
			     if WAR.FZ2[id] ~=nil and WAR.FZ2[id][1] ~=nil  then
				    local aa = WAR.FZ2[id][1]
	                local a = (getnewmove(math.modf(WAR.Person[i]["轻功"]*(1-0.05*aa))) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
					WAR.Person[i].TimeAdd = math.min(a,WAR.Person[i].TimeAdd)
	             end 			
			--5点集气集气
			WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			
			WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (0.7+WAR.SPIRIT[id] * 0.003))--1-28-
	if Curr_NG(id,184) then
	WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(WAR.Person[i].TimeAdd * (WAR.SPIRIT[id] * 0.005))
	   if nglw(id,184)>=1 then
	   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(WAR.Person[i].TimeAdd * (WAR.SPIRIT[id] * 0.01))
	   end
	end

	if Curr_NG(id,183) then
	WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
	end
			if PersonKF(id,183) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
			end		  
			--主运葵花，集气速度+15%
			if Curr_NG(id,105) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.15)
				if nglw(id,105)>=2 and KUIHUA(id) == 2 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(JY.Person[id]["内力"]/400)
				end
			end
						
			--葵花神功被动，集气+3
			if PersonKF(id,105) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
			end
		  
			--玉女心经被动，集气+1
			if PersonKF(id,154) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
			end

			if PersonKF(id,178) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
				if Curr_NG(id,178) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
			    end
			end
			
		    if Curr_QG(id,149)  then----
			WAR.Person[i].TimeAdd = math.modf(getnewmove(WAR.Person[i]["轻功"])*0.25) + WAR.Person[i].TimeAdd
			   if qglw(id,149)>=1 then
			      if WAR.TYZH[id] ~= nil then
				  WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(WAR.TYZH[id]/10)
				  end
			   end
			end
			
			--主运飞天，集气+3
			if Curr_QG(id,145) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3
				if qglw(id,145)>=1 and WAR.Person[i].Time<200+300*qglw(id,145) then
				local aa = math.modf((1000-WAR.Person[i].Time)/50)
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + aa * qglw(id,145)
				end
			end
			
			--运行天赋轻功
			if JY.Person[id]["主运轻功"] > 0 and JY.Person[id]["主运轻功"] == JY.Person[id]["天赋轻功"] then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
				if match_ID(id,449)  then----
			       WAR.Person[i].TimeAdd = 4 + WAR.Person[i].TimeAdd
			    end
				if Curr_QG(id,148) then
				   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3 * Tianluo(id)
				end
			end
			
			--胡斐，乔峰，集气+8
			if match_ID(id, 1) or match_ID(id, 50) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8
				if match_ID_awakened(id, 1,1) and JY.Person[1]["论剑奖励"] == 1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(getnewmove(WAR.Person[i]["轻功"])*1.25)
				end
			end
			
			--东方不败，集气+6
			if match_ID(id, 27) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 6
			end
			
			if nglw(id,100)>2 and Curr_NG(id,100) then --先天三阶金雁功
		       WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(JY.Person[id]["内力"]/400);
	        end

			if wglw(id,22)>2 and WAR.Actup[id]~=nil then --先天三阶金雁功
		       WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + math.modf(JY.Person[id]["拳掌功夫"]/20);
	        end	

			if WAR.XDLZ2[id]~=nil and JY.Person[id]["生命"]<=JY.Person[id]["生命最大值"] * 0.5 then
			   WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*(2-JY.Person[id]["生命"]/JY.Person[id]["生命最大值"]))
			end
			
			--韦一笑，成昆，黄药师，集气+10
			if match_ID(id, 14) or match_ID(id, 18) or match_ID(id, 57) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
				if match_ID_awakened(id, 14,1) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3*(WAR.BSFW(id) or 0)
				end
			end
			
			--一灯，重生后额外集气速度+5
			if match_ID(id, 65) and WAR.WCY[id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5 + (7-WAR.LMZL)*3
			end
			
			if match_ID_awakened(id, 65,1) and WAR.LMZL>0 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + (7-WAR.LMZL)*5
			end	

			--田伯光 万里独行 人越少集气越快
			if match_ID(id, 29) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20*math.max(wglw(id,29),1)
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 1
					end
				end
				if match_ID_awakened(id,29,1)then
			     	for j = 0, WAR.PersonNum - 1 do
					    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
					    end
				    end				
				end
				local s = 0
		        for j = 0, WAR.PersonNum - 1 do
			        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 1 then
				    s = s + 1
			        end
		         end
		        WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3*s
			end

			--鹿杖客，敌方有女的速度加成
	if match_ID(id, 644) then
		local s = 0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and JY.Person[WAR.Person[j]["人物编号"]]["性别"] == 1 then
				s = s + 1
			end
		end
		WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 3*s
	end
	
			--公孙止，我方每死亡一个人，集气速度+2
			if match_ID(id, 616) then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == true and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
					end
				end
			end

	  if MPPD(id) == 5 then --沼跃鱼：明教圣火阵
        local shz = 0
		local xg = MPDJ(id)
        for j = 0, WAR.PersonNum - 1 do
          if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and MPPD(WAR.Person[j]["人物编号"]) then
            shz = shz + 1
          end
        end
		if shz > 8 then
		  shz = 8
		end		
        if shz >= 2 then
        	WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + shz * xg
      	end

      end
		  
			--圣火三使，同时在场时，每人集气速度额外+20点
			if WAR.ZDDH == 14 and (id == 173 or id == 174 or id == 175) then
				local shz = 0
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						shz = shz + 1
					end
				end
				
				if shz == 3 then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
				end
			end
		  
			--蓝烟清：天罡北斗阵，集气+6
			if WAR.ZDDH == 73 and WAR.Person[i]["我方"] == false then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 6
			end
			  
			--山洞妹妹给主角+2集气
			if id == 0 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 92 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
						break
					end
				end
			end
		  
			--主角其徐如林
			if id == 0 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.FLHS2
			end

			if WAR.SATA[id]~= nil then
			   WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.SATA[id]
			end
	

	
			--主运太极神功，太极之形增加集气
			if Curr_NG(id, 171) and WAR.TJZX[id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.TJZX[id]*(nglw(id,171)+1)
			end			
			
			--主角论剑打赢东方奖励+5
			if id == 0 and JY.Person[27]["论剑奖励"] == 1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end

			--真田幸村，复活增加集气
			if id == 553 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.YZB2 * 4
			end
			  
			--平一指，集气速度额外加成5*杀人数
			if match_ID(id, 28) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PYZ * 5
			end
	
			if nglw(id,178)>=1 and Curr_NG(id,178) then
               WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + (WAR.BDKY[id] or 0) *5
			end	

			if wglw(id,26)>=1  then
               WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + (WAR.LHXT[id] or 0) *5
			end	
	
                 if T7DFWM(id) then
                    local jsyx = wgnumber(id,3)
                     WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1 + 0.05 * (jsyx)))
                 end
	  
			--蓝烟清：装备白马 1级加2集气，6级加4集气
			if JY.Person[id]["坐骑"] == 230 then
				local sd = 2
				if JY.Thing[230]["装备等级"] >= 5 then
					sd = 4
				elseif JY.Thing[230]["装备等级"] >= 3 then
					sd = 3
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + sd;
			end
			
			--装备毛驴 集气速度+10点
			if JY.Person[id]["坐骑"] == 279 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10;
			end

			--装备飞云 集气速度+12点
			if JY.Person[id]["坐骑"] == 264 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 12;
			end	
	
			--一灯，重生后额外集气速度+5
			if  WAR.GYZ[id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - WAR.GYZ[id]*3
			end

			if (nglw(id,106) >2) and (WAR.JYHT[id]~=nil and WAR.JYHT[id]>10) then --17-2-10
               WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + (WAR.JYHT[id]-5)*5
			end
			
			if  WAR.CYZY[id] ~= nil and MPZJ(id,2)>2 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.CYZY[id]*5
			end			
	
			--瘦黄马，血量越低集气越快，50%血+5，0血+10
			if JY.Person[id]["坐骑"] == 284 and JY.Thing[284]["装备等级"] == 6 and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]/2 then
				local spd_add = 5;
				spd_add = spd_add + math.floor((JY.Person[id]["生命最大值"]/2/JY.Person[id]["血量翻倍"] - JY.Person[id]["生命"]/JY.Person[id]["血量翻倍"])/100)
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + spd_add;
			end

			--阿紫曼珠沙华，血量越低集气越快，100%血无加成，0血100%加成
			if match_ID(id, 47) and WAR.JYZT[id]~=nil then
				local bonus_perctge = 0
				bonus_perctge = 2 - JY.Person[id]["生命"] / JY.Person[id]["生命最大值"]
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * bonus_perctge)
			end

			if  WAR.GSSL[id]~=nil and WAR.GSSL[id] == 1 then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.15)
			end				
			
			--周芷若，每个外功+2集气
			if match_ID(id, 631) then
				local zzr = 0
				for i = 1, CC.Kungfunum do
					if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] < 6 then
						zzr = zzr + 1
					end
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + zzr
			end
		  
			--日本忍者战
			if WAR.ZDDH == 128 and inteam(id) == false and id ~= 553 and JY.Base["难度"] > 1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
		  
		  if WAR.QMDJ[id]~=nil then--
		     local aa = WAR.QMDJ[id]
			 WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - aa
		  end
		  
			--集气下限10点
			if WAR.Person[i].TimeAdd < 10 then
				WAR.Person[i].TimeAdd = 10
			end
		  
			--木桩不集气
			if id == 591 and WAR.ZDDH == 226 then
				WAR.Person[i].TimeAdd = 0
			end
			
			--李秋水的无相分身不集气
			if id == 600 then
				WAR.Person[i].TimeAdd = 0
			end

		      if WAR.YRKG[id] ~= nil and WAR.YRKG[id] > 0 then --以柔克刚
      	WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 0.5)
      end 	
		
	    local id = WAR.Person[i]["人物编号"]----天佛降速
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 			
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
			if nglw(df,108)>1 and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and Curr_NG(df,108) then
		     local xn=math.modf((JY.Person[df]["内力"]-JY.Person[id]["内力"])/250)
			 if xn<=0 then
			 xn=0
			 end
			 if offset<=10 then
			 xn=math.modf(xn*(1+(10-offset)/10))
			 else
			 xn=math.modf(xn*(1-(offset-10)/10))
			 end
			 if xn<0 then
			 xn=0
			 end
	         WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*(1-0.01*xn))
			 if WAR.Person[i].TimeAdd <= 0 then
			 WAR.Person[i].TimeAdd=0
			 end
			 WAR.WSZ[id]=math.modf(xn/2*1.5)
			end
			if (nglw(df,108)>3 or match_ID_awakened(df,114,1)) and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and Curr_NG(df,108) then
		     local xn=math.modf((JY.Person[df]["内力"]+JY.Person[id]["内力"])/500)
			 if xn<=0 then
			 xn=0
			 end
			 if offset<=10 then
			 xn=math.modf(xn*(1+(10-offset)/10))
			 else
			 xn=math.modf(xn*(1-(offset-10)/10))
			 end
			 if id == df then
			 xn = math.modf(xn*0.75)
			 end
			 if xn<0 then
			 xn=0
			 end
             AddPersonAttrib(id, "生命", xn)
			 AddPersonAttrib(id, "内力", xn)
			end
			
         end			

	    local id = WAR.Person[i]["人物编号"]----花粉降速
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 			
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
			if match_ID_awakened(df,2,1) and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and JY.Person[2]["论剑奖励"] == 1 then
		     local xn=math.modf((JY.Person[df]["医疗能力"])/50)
			 if xn<=0 then
			 xn=0
			 end
			 if offset<=10 then
			 xn=math.modf(xn*(1+(10-offset)/10))
			 else
			 xn=math.modf(xn*(1-(offset-10)/10))
			 end
			 if xn<0 then
			 xn=0
			 end
			 if JY.Person[id]["中毒程度"] >0 then
			 xn = xn * (JY.Person[id]["中毒程度"]/100 + 1)
	         WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*(1-0.01*xn))
			 if WAR.Person[i].TimeAdd <= 5 then
			 WAR.Person[i].TimeAdd=5
			 end
			 end
			end			
         end

	    local id = WAR.Person[i]["人物编号"]----杀意波动场
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 			
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
			local aa = WAR.BDKY[id] or 0
			if nglw(df,178)>1 and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and Curr_NG(df,108) then
		     local xn=math.modf((JY.Person[df]["内力"]-JY.Person[id]["内力"])/200)
			 if xn<=0 then
			 xn=0
			 end
			 if offset<=aa then
			    if offset<=math.modf(aa/2)  then
				xn =xn*(math.modf(aa/2)-offset+1)
				end
			 else
			 xn=0
			 end
			 if xn<0 then
			 xn=0
			 end
	         WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - xn
			 if WAR.Person[i].TimeAdd <= 5 then
			 WAR.Person[i].TimeAdd=5
			 end
			end			
         end

	 for j = 0, WAR.PersonNum - 1 do --沼跃鱼：萧峰帝释天威效果--己方加速
	  if match_ID(WAR.Person[j]["人物编号"], 50) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
		 local aa=WAR.Person[j]["人物编号"]
		 local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1+cc))
		 end
	 end		 

	 for j = 0, WAR.PersonNum - 1 do --沼跃鱼：疯魂阵效果--己方加速
	     local aa=WAR.Person[j]["人物编号"]
	  if WAR.LSDZ[aa] ~= nil and WAR.LSDZ[aa] == 2 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and RealJL(j, i, 1+wglw(aa,51)*2) then 
		 local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1+cc))
		 end
	 end	
		 
	 for j = 0, WAR.PersonNum - 1 do --沼跃鱼：萧峰帝释天威效果--敌方减速
	  if match_ID(WAR.Person[j]["人物编号"], 50) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
		 local aa=WAR.Person[j]["人物编号"]
		 local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1-cc))
		 end
	 end

	 for j = 0, WAR.PersonNum - 1 do --沼跃鱼：魔魂阵效果--敌方减速
	     local aa=WAR.Person[j]["人物编号"]
	  if WAR.LSDZ[aa] ~= nil and WAR.LSDZ[aa] == 3 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and RealJL(j, i, 1+wglw(aa,51)*2) then 
		 local cc=math.modf(JY.Person[aa]["内力"]/JY.Person[aa]["内力最大值"])
		 cc= math.modf(cc *WAR.SPIRIT[aa]/100)
		 if cc>0.35 then
		 cc=0.35
		 end
		 if WAR.LQZ[WAR.Person[j]["人物编号"]]~=nil and WAR.LQZ[WAR.Person[j]["人物编号"]]==100 then
		 cc=cc*2
		 end
		 WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (1-cc))
		 end
	 end

			--剑神，每个剑法到极，+2集气
			if JY.Base["标准"] == 3 and id == 0 then
				local jsyx = 0
				local aa=2
				for i = 1, CC.Kungfunum do
					if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 3 and JY.Person[0]["武功等级" .. i] == 999 then
						jsyx = jsyx + 1
					end
				end
				if jsyx > 7 then
					jsyx = 7
				end
				 if JY.Person[id]["内力性质"] == 2 and zylw(3)> 0 then
				 local bb=math.modf(TrueYJ(id)/80)
				 jsyx=jsyx+bb
				 aa=aa+math.modf(TrueYJ(id)/120)
				 end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + jsyx*aa
			end

	if match_ID(id, 2) then ----程灵素七星海棠花粉传播领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[id]["医疗能力"])/100)+3		
			if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if df==2 then----
			 xx=math.modf(xx/2)
			 end
			 WAR.Person[j].TimeAdd = math.modf(WAR.Person[j].TimeAdd*(1+0.01*xx))
			end
            end		    		
	end

	if WAR.MZQL[id]~=nil and WAR.MZQL[id] == 1 then ----程灵素七星海棠花粉传播领域
	    local  mpdj = MPDJ(id)
		for j = 0, WAR.PersonNum-1 do 
	       if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then		     
			 WAR.Person[j].TimeAdd = math.modf(WAR.Person[j].TimeAdd*(1+0.1*mpdj))
		   end
        end		    		
	end
			
			if match_ID_awakened(id,64,1) and WAR.ZBT1[id]~=nil then --沼跃鱼：空明蓄力读条	
            WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.ZBT1[id]*5
			end			

			if id == 645 and JY.Base["斗神"] == 64 and WAR.ZBT1[id]~=nil then --沼跃鱼：空明蓄力读条	
            WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.ZBT1[id]*5
			end	

	  WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * (0.7+WAR.SPIRIT[id] * 0.003))--1-28-
	 
			--集气上限60点
			if zylw(3)> 0 and id == 0 then
			   if WAR.Person[i].TimeAdd > 80 then
				WAR.Person[i].TimeAdd = 80
			   end

			elseif WAR.Person[i].TimeAdd > 60 then
			    if qglw(id,145)>=1 then
				   if WAR.Person[i].TimeAdd > 60 + qglw(id,145)*20 then
			       WAR.Person[i].TimeAdd = 60 + qglw(id,145)*20
				   end
			   else
				WAR.Person[i].TimeAdd = 60
				end
			end


			
			

	
			if wglw(id, 52)>1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PYZ1 * 10
				if WAR.Person[i].TimeAdd > 80 then
				WAR.Person[i].TimeAdd = 80
			    end
			end
			
           if WAR.SZJS[id] == 1 then--
              WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*1.5)
           end	

           if WAR.QYC[id]~= nil then
           WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*2)
		      if JY.Person[id]["生命"]/JY.Person[id]["生命最大值"]<= 0.5  then
		      local cc=2-JY.Person[id]["生命"]/JY.Person[id]["生命最大值"]
			  WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*cc)
			  end
           end		   

		    WAR.JQSD[id] = WAR.Person[i].TimeAdd
			num = num + 1
			total = total + WAR.Person[i].TimeAdd
		end
	end
  
	--无酒不欢：这个返回值表达不明确，存疑
	WAR.LifeNum = num
	return math.modf(((total) / (num) + (num) - 2))
end


--武功范围选择
function War_KfMove(movefanwei, atkfanwei,wugong)
  local kind = movefanwei[1] or 0
  local len = movefanwei[2] or 0
  local x0 = WAR.Person[WAR.CurID]["坐标X"]
  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  local x = x0
  local y = y0
  if kind ~= nil then
    if kind == 0 then
      War_CalMoveStep(WAR.CurID, len, 1)
	  elseif kind == 1 then
	    War_CalMoveStep(WAR.CurID, len * 2, 1)
	    for r = 1, len * 2 do
	      for i = 0, r do
	        local j = r - i
	        if len < i or len < j then
	          SetWarMap(x0 + i, y0 + j, 3, 255)
	          SetWarMap(x0 + i, y0 - j, 3, 255)
	          SetWarMap(x0 - i, y0 + j, 3, 255)
	          SetWarMap(x0 - i, y0 - j, 3, 255)
	        end
	      end
	    end
	  elseif kind == 2 then
	    War_CalMoveStep(WAR.CurID, len, 1)
	    for i = 1, len - 1 do
	      for j = 1, len - 1 do
	        SetWarMap(x0 + i, y0 + j, 3, 255)
	        SetWarMap(x0 - i, y0 + j, 3, 255)
	        SetWarMap(x0 + i, y0 - j, 3, 255)
	        SetWarMap(x0 - i, y0 - j, 3, 255)
	      end
	    end
	  elseif kind == 3 then
	    War_CalMoveStep(WAR.CurID, 2, 1)
	    SetWarMap(x0 + 2, y0, 3, 255)
	    SetWarMap(x0 - 2, y0, 3, 255)
	    SetWarMap(x0, y0 + 2, 3, 255)
	    SetWarMap(x0, y0 - 2, 3, 255)
	  else
	    War_CalMoveStep(WAR.CurID, 0, 1)
	  end
  end
  
  CleanWarMap(7, 0)
  
  while true do
	if JY.Restart == 1 then
		break
	end
    local x2 = x
    local y2 = y

	WarDrawMap(1, x, y)
    if wugong == 26 then
		WarDrawAtt(x, y, atkfanwei, 4, nil, nil, nil, 1)
	elseif wglw(pid,9) >= 1 and wugong ==9 then		
	   if  WAR.SPXT[pid] ~=nil and WAR.SPXT[pid]>=10  then
        WarDrawAtt(x, y, atkfanwei, 4, nil, nil, nil, 1)
		else
		WarDrawAtt(x, y, atkfanwei, 4)
	   end	
	else
		WarDrawAtt(x, y, atkfanwei, 4)
	end
    
	WarDrawMap(1, x, y)
    WarShowHead(GetWarMap(x, y, 2))
	
	--显示可以覆盖的敌人信息
	for i = 0, CC.WarWidth - 1 do
		for j = 0, CC.WarHeight - 1 do
			local target = GetWarMap(i, j, 7)
			if target ~= nil and target == 2 then
				if GetWarMap(i, j, 2) ~= nil and WAR.Person[GetWarMap(i, j, 2)]["人物编号"] ~= nil then
					local x0 = WAR.Person[WAR.CurID]["坐标X"];
					local y0 = WAR.Person[WAR.CurID]["坐标Y"];
					local dx = i - x0
					local dy = j - y0
					local size = CC.FontSmall;
					local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
					local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
					
					local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

					ry = ry - hb - CC.ScreenH/6;
							
					if ry < 1 then			--加上这个，防止看不到血的情况
						ry = 1;
					end
					
					--显示选中人物的生命值
					local color = RGB(245, 251, 5);
					local hp = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["生命"] or 0;
					local maxhp = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["生命最大值"] or 0;
					
					local ns = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["受伤程度"] or 0;
					local zd = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["中毒程度"] or 0;
					local len = #(string.format("%d/%d",hp,maxhp));
					rx = rx - len*size/4;
					
					--颜色根据所受的内伤确定
					if ns < 33 then
						color = RGB(236, 200, 40)
					elseif ns < 66 then
						color = RGB(244, 128, 32)
					else
						color = RGB(232, 32, 44)
					end
					
					DrawString(rx, ry, string.format("%d",hp), color, size);
					DrawString(rx + #string.format("%d",hp)*size/2, ry, "/", C_GOLD, size);
					
					if zd == 0 then
						color = RGB(252, 148, 16)
					elseif zd < 50 then
						color = RGB(120, 208, 88)
					else
						color = RGB(56, 136, 36)
					end
					DrawString(rx + #string.format("%d",hp)*size/2 + size/2 , ry, string.format("%d", maxhp), color, size)
				end
			end
		end
	end

    ShowScreen()
	CleanWarMap(7, 0)

    local key, ktype, mx, my = WaitKey(1)

    if key == VK_UP then
      y2 = y - 1
    elseif key == VK_DOWN then
      y2 = y + 1
    elseif key == VK_LEFT then
      x2 = x - 1
    elseif key == VK_RIGHT then
      x2 = x + 1
    elseif (key == VK_SPACE or key == VK_RETURN) then
      return x, y

    elseif key == VK_ESCAPE or ktype == 4 then
      return nil
    elseif ktype == 2 or ktype == 3 then
      mx = mx - CC.ScreenW / 2
      my = my - CC.ScreenH / 2
      mx = (mx) / CC.XScale
      my = (my) / CC.YScale
      mx, my = (mx + my) / 2, (my - mx) / 2
      if mx > 0 then
        mx = mx + 0.99
      else
        mx = mx - 0.01
      end
      if my > 0 then
        my = my + 0.99
      else
        mx = mx - 0.01
      end
      mx = math.modf(mx)
      my = math.modf(my)
      for i = 1, 20 do
        if mx + i > 63 or my + i > 63 then
           return;
        end
        local hb = GetS(JY.SubScene, mx + i, my + i, 4)

        if math.abs(hb - CC.YScale * i * 2) < 8 then
          mx = mx + i
          my = my + i
        end
      end
      
      x2, y2 = mx + x0, my + y0
	    if ktype == 3 and (kind < 2 or x ~= x0 or y ~= y0) then
	      return x, y					
	    end
	    
    end
    if x2 >= 0 and x2 < CC.WarWidth and y2 >= 0 and y2 < CC.WarHeight then
			if GetWarMap(x2, y2, 3) ~= nil and GetWarMap(x2, y2, 3) < 128 then
	      x = x2
	      y = y2
		  end
		end
	end
end
--WarDrawAtt 
function WarDrawAtt(x, y, fanwei, flag, cx, cy, atk, xl)
  local x0, y0 = nil
  if cx == nil or cy == nil then
    x0 = WAR.Person[WAR.CurID]["坐标X"]
    y0 = WAR.Person[WAR.CurID]["坐标Y"]
  else
    x0, y0 = cx, cy
  end
  local kind = fanwei[1]			--攻击范围
  local len1 = fanwei[2]
  local len2 = fanwei[3]
  local len3 = fanwei[4]
  local len4 = fanwei[5]
  local xy = {}
  local num = 0
  if kind == 0 then
    num = 1
    xy[1] = {x, y}
  elseif kind == 1 then
    if not len1 then
      len1 = 0
    end
    if not len2 then
      len2 = 0
    end
    num = num + 1
    xy[num] = {x, y}
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      num = num + 4
    end
    for i = 1, len2 do
      xy[num + 1] = {x + i, y + i}
      xy[num + 2] = {x - i, y - i}
      xy[num + 3] = {x - i, y + i}
      xy[num + 4] = {x + i, y - i}
      num = num + 4
    end
  elseif kind == 2 then
    for tx = x - len1, x + len1 do
      for ty = y - len1, y + len1 do
        if len1 < math.abs(tx - x) + math.abs(ty - y) then
          
        else
        	num = num + 1
        	xy[num] = {tx, ty}
        end
        
      end
    end
  elseif kind == 3 then
    if not len2 then
      len2 = len1
    end
    local dx, dy = math.abs(x - x0), math.abs(y - y0)
    if dy < dx then
      len1, len2 = len2, len1
    end
    for tx = x - len1, x + len1 do
      for ty = y - len2, y + len2 do
        num = num + 1
        xy[num] = {tx, ty}
      end
    end
  elseif kind == 5 then
    if not len1 then
      len1 = 0
    end
    if not len2 then
      len2 = 0
    end
    num = num + 1
    xy[num] = {x, y}
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      num = num + 4
    end
    if len2 > 0 then
      xy[num + 1] = {x + 1, y + 1}
      xy[num + 2] = {x + 1, y - 1}
      xy[num + 3] = {x - 1, y + 1}
      xy[num + 4] = {x - 1, y - 1}
      num = num + 4
    end
    for i = 2, len2 do
      xy[num + 1] = {x + i, y + 1}
      xy[num + 2] = {x - i, y - 1}
      xy[num + 3] = {x - i, y + 1}
      xy[num + 4] = {x + i, y - 1}
      xy[num + 5] = {x + 1, y + i}
      xy[num + 6] = {x - 1, y - i}
      xy[num + 7] = {x - 1, y + i}
      xy[num + 8] = {x + 1, y - i}
      num = num + 8
    end
  elseif kind == 6 then
    if not len2 then
      len2 = len1
    end
    xy[1] = {x + 1, y}
    xy[2] = {x - 1, y}
    xy[3] = {x, y + 1}
    xy[4] = {x, y - 1}
    num = num + 4
    if len1 > 0 or len2 > 0 then
      xy[5] = {x + 1, y + 1}
      xy[6] = {x + 1, y - 1}
      xy[7] = {x - 1, y + 1}
      xy[8] = {x - 1, y - 1}
      num = num + 4
      for i = 2, len1 do
        xy[num + 1] = {x + i, y + 1}
        xy[num + 2] = {x - i, y + 1}
        xy[num + 3] = {x + i, y - 1}
        xy[num + 4] = {x - i, y - 1}
        num = num + 4
      end
      for i = 2, len2 do
        xy[num + 1] = {x + 1, y + i}
        xy[num + 2] = {x + 1, y - i}
        xy[num + 3] = {x - 1, y + i}
        xy[num + 4] = {x - 1, y - i}
        num = num + 4
      end
    end
  elseif kind == 7 then
    if not len2 then
      len2 = len1
    end
    if len1 == 0 then
      for i = y - len2, y + len2 do
        num = num + 1
        xy[num] = {x, i}
      end
    elseif len2 == 0 then
      for i = x - len1, x + len1 do
        num = num + 1
        xy[num] = {i, y}
      end
    else
      for i = x - len1, x + len1 do
        num = num + 1
        xy[num] = {i, y}
        num = num + 1
        xy[num] = {i, y + len2}
        num = num + 1
        xy[num] = {i, y - len2}
      end
      for i = 1, len2 - 1 do
        xy[num + 1] = {x, y + i}
        xy[num + 2] = {x, y - i}
        xy[num + 3] = {x - len1, y + i}
        xy[num + 4] = {x - len1, y - i}
        xy[num + 5] = {x + len1, y + i}
        xy[num + 6] = {x + len1, y - i}
        num = num + 6
      end
    end
  elseif kind == 8 then
    xy[1] = {x, y}
    num = 1
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      xy[num + 5] = {x + i, y + len1}
      xy[num + 6] = {x - i, y - len1}
      xy[num + 7] = {x + len1, y - i}
      xy[num + 8] = {x - len1, y + i}
      num = num + 8
    end
  elseif kind == 9 then
    xy[1] = {x, y}
    num = 1
    for i = 1, len1 do
      xy[num + 1] = {x + i, y}
      xy[num + 2] = {x - i, y}
      xy[num + 3] = {x, y + i}
      xy[num + 4] = {x, y - i}
      xy[num + 5] = {x - i, y + len1}
      xy[num + 6] = {x + i, y - len1}
      xy[num + 7] = {x + len1, y + i}
      xy[num + 8] = {x - len1, y - i}
      num = num + 8
    end
  elseif x == x0 and y == y0 then
    return 0
  elseif kind == 10 then
    if not len2 then
      len2 = 0
    end
    if not len3 then
      len3 = 0
    end
    if not len4 then
      len4 = 0
    end
    local fx, fy = x - x0, y - y0
    if fx > 0 then
      fx = 1
    elseif fx < 0 then
      fx = -1
    end
    if fy > 0 then
      fy = 1
    elseif fy < 0 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    dx1 = -(dx1 + fx) / 2
    dx2 = -(dx2 + fx) / 2
    dy1 = -(dy1 + fy) / 2
    dy2 = -(dy2 + fy) / 2
    if dx1 > 0 then
      dx1 = 1
    elseif dx1 < 0 then
      dx1 = -1
    end
    if dx2 > 0 then
      dx2 = 1
    elseif dx2 < 0 then
      dx2 = -1
    end
    if dy1 > 0 then
      dy1 = 1
    elseif dy1 < 0 then
      dy1 = -1
    end
    if dy2 > 0 then
      dy2 = 1
    elseif dy2 < 0 then
      dy2 = -1
    end
    for i = 0, len1 - 1 do
      num = num + 1
      xy[num] = {x + i * fx, y + i * fy}
    end
    for i = 0, len2 - 1 do
      num = num + 1
      xy[num] = {x + dx1 + i * fx, y + dy1 + i * fy}
      num = num + 1
      xy[num] = {x + dx2 + i * fx, y + dy2 + i * fy}
    end
    for i = 0, len3 - 1 do
      num = num + 1
      xy[num] = {x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy}
      num = num + 1
      xy[num] = {x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy}
    end
    for i = 0, len4 - 1 do
      num = num + 1
      xy[num] = {x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy}
      num = num + 1
      xy[num] = {x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy}
    end
  elseif kind == 11 then
    local fx, fy = x - x0, y - y0
    if fx > 1 then
      fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = -(dx1 + fx) / 2
      dx2 = -(dx2 + fx) / 2
      dy1 = -(dy1 + fy) / 2
      dy2 = -(dy2 + fy) / 2
      len1 = math.modf(len1 * 0.7071)
      for i = 0, len1 do
        num = num + 1
        xy[num] = {x + i * fx, y + i * fy}
        for j = 1, 2 * i + 1 do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    else
      for i = 0, len1 do
        num = num + 1
        xy[num] = {x + i * fx, y + i * fy}
        for j = 1, len1 - i do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    end
  elseif kind == 12 then
    local fx, fy = x - x0, y - y0
    if fx > 1 then
      fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
    if fx ~= 0 and fy ~= 0 then
      dx1 = (dx1 + fx) / 2
      dx2 = (dx2 + fx) / 2
      dy1 = (dy1 + fy) / 2
      dy2 = (dy2 + fy) / 2
      len1 = math.modf(len1 * 1.41421)
      for i = 0, len1 do
        if i <= len1 / 2 then
          num = num + 1
          xy[num] = {x + i * fx, y + i * fy}
        end
        for j = 1, len1 - i * 2 do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    else
      for i = 0, len1 do
        num = num + 1
        xy[num] = {x + i * fx, y + i * fy}
        for j = 1, i do
          num = num + 1
          xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
          num = num + 1
          xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
        end
      end
    end
  elseif kind == 13 then
    local fx, fy = x - x0, y - y0
    if fx > 1 then
      fx = 1
    elseif fx < -1 then
      fx = -1
    end
    if fy > 1 then
      fy = 1
    elseif fy < -1 then
      fy = -1
    end
    local xx = x + fx * len1
    local yy = y + fy * len1
    for tx = xx - len1, xx + len1 do
      for ty = yy - len1, yy + len1 do
        if len1 < math.abs(tx - xx) + math.abs(ty - yy) then
          break;
        end
        num = num + 1
        xy[num] = {tx, ty}
      end
    end
  else
    return 0
  end
  
	--降龙的范围
	if xl then
		local xl_x = WAR.Person[WAR.CurID]["坐标X"]
		local xl_y = WAR.Person[WAR.CurID]["坐标Y"]
		for i = 1, 11, 2 do
			for j = 1, 11, 2 do
				num = num + 1
				xy[num] = {xl_x - i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x - i, xl_y - j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y + j}
				num = num + 1
				xy[num] = {xl_x + i, xl_y - j}
			end
		end
	end
  
  if flag == 1 then
    local thexy = function(nx, ny, x, y)
	    local dx, dy = nx - x, ny - y
	    local hb = lib.GetS(JY.SubScene, nx, ny, 4)
	    return CC.ScreenW / 2 + CC.XScale * (dx - dy), CC.ScreenH / 2 + CC.YScale * (dx + dy) - hb
    end
    
    for i = 1, num do
    	if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
      	local tx, ty = thexy(xy[i][1], xy[i][2], x0, y0)

	      if GetWarMap(xy[i][1], xy[i][2], 2) ~= nil and GetWarMap(xy[i][1], xy[i][2], 2) >= 0 and GetWarMap(xy[i][1], xy[i][2], 2) ~= WAR.CurID then
				if not inteam(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]) and WAR.Person[WAR.CurID]["我方"] then
		      	local x0 = WAR.Person[WAR.CurID]["坐标X"];
		      	local y0 = WAR.Person[WAR.CurID]["坐标Y"];
		      	local dx = xy[i][1] - x0
		        local dy = xy[i][2] - y0
		        local size = CC.FontSmall;
		        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
		        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
		        
		        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

		        ry = ry - hb - CC.ScreenH/6;
						
		        if ry < 1 then			--加上这个，防止看不到血的情况
		        	ry = 1;
		        end
		      	
		      	--显示选中人物的生命值
		      	local color = RGB(245, 251, 5);
		      	local hp = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["生命"];
		      	local maxhp = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["生命最大值"];
		      	
		      	local ns = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["受伤程度"];
		      	local zd = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["中毒程度"];
		      	local len = #(string.format("%d/%d",hp,maxhp));
		      	rx = rx - len*size/4;
		      	
		      	--颜色根据所受的内伤确定
		      	if ns < 33 then
					color = RGB(236, 200, 40)
				elseif ns < 66 then
					color = RGB(244, 128, 32)
				else
					color = RGB(232, 32, 44)
				end
		      	
		      	DrawString(rx, ry, string.format("%d",hp), color, size);
		      	DrawString(rx + #string.format("%d",hp)*size/2, ry, "/", C_GOLD, size);
		      	
		      	if zd == 0 then
				      color = RGB(252, 148, 16)
				    elseif zd < 50 then
				      color = RGB(120, 208, 88)
				    else
				      color = RGB(56, 136, 36)
				    end
				    DrawString(rx + #string.format("%d",hp)*size/2 + size/2 , ry, string.format("%d", maxhp), color, size)
		      end
		      
	      	--lib.PicLoadCache(0, 0, tx, ty, 2, 200)
	      else
	      	--lib.PicLoadCache(0, 0, tx, ty, 2, 112)
	      end
	      
	    end
    end

  elseif flag == 2 then
    local diwo = WAR.Person[WAR.CurID]["我方"]
    local atknum = 0
    for i = 1, num do
      if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
        local id = GetWarMap(xy[i][1], xy[i][2], 2)
      
	      if id ~= -1 and id ~= WAR.CurID then
	        local xa, xb, xc = nil, nil, nil
			local e_diwo = WAR.Person[id]["我方"]
			--张家辉的隐身戒指
			if JY.Person[WAR.Person[id]["人物编号"]]["饰品"] == 304 and WAR.YSJZ == 0 then
				e_diwo = diwo
			end
	        if diwo ~= e_diwo then
				xa = 2
	        else
				xa = 0
	        end
	        local hp = JY.Person[WAR.Person[id]["人物编号"]]["生命"]
	        if hp < atk / 6 then
	          xb = 2
	        elseif hp < atk / 3 then
	          xb = 1
	        else
	          xb = 0
	        end
	        local danger = JY.Person[WAR.Person[id]["人物编号"]]["内力最大值"]
	        xc = danger / 500
	        atknum = atknum + xa * math.modf(xb * (xc) + 5)
	      end
      end
    end
    return atknum
  elseif flag == 3 then
    for i = 1, num do
    	if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
      	SetWarMap(xy[i][1], xy[i][2], 4, 1)
      end
    end
	--武功选择范围
  elseif flag == 4 then
    for i = 1, num do
    	if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
			if GetWarMap(xy[i][1], xy[i][2], 2) ~= nil and GetWarMap(xy[i][1], xy[i][2], 2) >= 0 then
				--七夕龙女的论剑奖励代表是否学有迷踪步
				--自动不触发
				if WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"] == 0 and JY.Person[615]["论剑奖励"] == 1 and math.random(10) < 4 and WAR.AutoFight == 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--用阿凡提的品德作为触发迷踪步的判定
					JY.Person[606]["品德"] = 90
				end
				--小昭影步
				if match_ID(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 66) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--用小昭的品德作为触发影步的判定
					JY.Person[66]["品德"] = 90
				end
				if match_ID_awakened(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"], 55,1) and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] and math.random(10) < 6 and WAR.AutoFight == 0 then
					--用郭靖的品德作为触发北斗罡步的判定
					JY.Person[55]["品德"] = 80
					WAR.BDGB = 1
				end
				--畅想张无忌逆转乾坤
				--自动不触发
				if WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"] == 0 and JY.Base["畅想"] == 9 and PersonKF(0, 97) and WAR.AutoFight == 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
					--基础35%几率
					local chance = 36
					--每本天书+1几率
					chance = chance + JY.Base["天书数量"]
					if WAR.LQZ[0] == 100 then
						chance = chance + 10
					end
					if math.random(100) < chance then
						JY.Person[614]["品德"] = 90
					end
				end
				--命中的敌方的点为2
				if not inteam(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]) and WAR.Person[WAR.CurID]["我方"] then
					SetWarMap(xy[i][1], xy[i][2], 7, 2)
				else
					SetWarMap(xy[i][1], xy[i][2], 7, 1)
				end
			else
				SetWarMap(xy[i][1], xy[i][2], 7, 1)
			end
		end
    end
  end
end

PNLBD = {}

--飞邪胡斐
PNLBD[0] = function()
  JY.Person[1]["生命"] = 800
  JY.Person[1]["生命最大值"] = 800
  JY.Person[1]["内力"] = 4000
  JY.Person[1]["内力最大值"] = 4000
  JY.Person[1]["攻击力"] = 130
  JY.Person[1]["防御力"] = 130
  JY.Person[1]["轻功"] = 160
  JY.Person[1]["受伤程度"] = 0
  JY.Person[1]["中毒程度"] = 0
  JY.Person[1]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--飞正阎基
PNLBD[1] = function()
  JY.Person[4]["生命"] = 330
  JY.Person[4]["生命最大值"] = 330
  JY.Person[4]["内力"] = 1200
  JY.Person[4]["内力最大值"] = 1200
  JY.Person[4]["武功等级1"] = 700
  JY.Person[4]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--杀林平之
PNLBD[34] = function()
  JY.Person[36]["生命"] = 650
  JY.Person[36]["生命最大值"] = 650
  JY.Person[36]["内力"] = 3000
  JY.Person[36]["内力最大值"] = 3000
  JY.Person[36]["攻击力"] = 180
  JY.Person[36]["防御力"] = 130
  JY.Person[36]["轻功"] = 220
  JY.Person[36]["受伤程度"] = 0
  JY.Person[36]["中毒程度"] = 0
  JY.Person[36]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--神邪战杨龙
PNLBD[75] = function()
  JY.Person[58]["生命"] = 850
  JY.Person[58]["生命最大值"] = 850
  JY.Person[58]["内力"] = 4000
  JY.Person[58]["内力最大值"] = 4000
  JY.Person[58]["攻击力"] = 210
  JY.Person[58]["防御力"] = 180
  JY.Person[58]["轻功"] = 160
  JY.Person[58]["受伤程度"] = 0
  JY.Person[58]["中毒程度"] = 0
  JY.Person[58]["武功1"] = 45		--玄铁
  JY.Person[58]["武功2"] = 104		--逆运
  JY.Person[58]["武功3"] = 107		--九阴
  JY.Person[58]["武功等级1"] = 999
  JY.Person[58]["武功等级2"] = 999
  JY.Person[58]["武功等级3"] = 400
  JY.Person[58]["血量翻倍"] = JY.Person[592]["血量翻倍"]
  JY.Person[58]["个人觉醒"] = 1
  JY.Person[59]["生命"] = 750
  JY.Person[59]["生命最大值"] = 750
  JY.Person[59]["内力"] = 3500
  JY.Person[59]["内力最大值"] = 3500
  JY.Person[59]["攻击力"] = 170
  JY.Person[59]["防御力"] = 150
  JY.Person[59]["轻功"] = 200
  JY.Person[59]["受伤程度"] = 0
  JY.Person[59]["中毒程度"] = 0
  JY.Person[59]["武功3"] = 107		--九阴
  JY.Person[59]["武功等级3"] = 400
  JY.Person[59]["血量翻倍"] = JY.Person[592]["血量翻倍"]
  JY.Person[59]["个人觉醒"] = 1
end

--招亲郭靖
PNLBD[76] = function()
	JY.Person[55]["武功1"] = 26
	JY.Person[55]["武功等级1"] = 600
    JY.Person[55]["武功2"] = 15
	JY.Person[55]["武功等级2"] = 500
    JY.Person[55]["武功3"] = 107
	JY.Person[55]["武功等级3"] = 50
	JY.Person[55]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--书邪陈家洛
PNLBD[138] = function()
  JY.Person[75]["生命"] = 650
  JY.Person[75]["生命最大值"] = 650
  JY.Person[75]["内力"] = 3000
  JY.Person[75]["内力最大值"] = 3000
  JY.Person[75]["攻击力"] = 140
  JY.Person[75]["防御力"] = 120
  JY.Person[75]["轻功"] = 130
  JY.Person[75]["受伤程度"] = 0
  JY.Person[75]["中毒程度"] = 0
  JY.Person[75]["武功等级1"] = 999
  JY.Person[75]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--碧邪
PNLBD[165] = function()
	--袁承志
	JY.Person[54]["生命"] = 750
	JY.Person[54]["生命最大值"] = 750
	JY.Person[54]["内力"] = 4000
	JY.Person[54]["内力最大值"] = 4000
	JY.Person[54]["攻击力"] = 140
	JY.Person[54]["防御力"] = 140
	JY.Person[54]["轻功"] = 90
	JY.Person[54]["受伤程度"] = 0
	JY.Person[54]["中毒程度"] = 0
	JY.Person[54]["个人觉醒"] = 1
	JY.Person[54]["携带物品1"] = -1
	JY.Person[54]["携带物品2"] = -1
	JY.Person[54]["携带物品数量1"] = 0
	JY.Person[54]["携带物品数量2"] = 0
	JY.Person[54]["血量翻倍"] = JY.Person[592]["血量翻倍"]
	--温青青
	JY.Person[91]["生命"] = 600
	JY.Person[91]["生命最大值"] = 600
	JY.Person[91]["内力"] = 2500
	JY.Person[91]["内力最大值"] = 2500
	JY.Person[91]["攻击力"] = 110
	JY.Person[91]["防御力"] = 110
	JY.Person[91]["轻功"] = 70
	JY.Person[91]["受伤程度"] = 0
	JY.Person[91]["中毒程度"] = 0
	JY.Person[91]["武功1"] = 40
	JY.Person[91]["武功等级1"] = 999
	JY.Person[91]["武功2"] = 90
	JY.Person[91]["武功等级2"] = 999
	JY.Person[91]["天赋内功"] = 90
	for i = 3 , 12 do
		JY.Person[91]["武功"..i] = 0
		JY.Person[91]["武功等级"..i] = 0
	end
	JY.Person[91]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--侠邪石破天
PNLBD[170] = function()
  JY.Person[38]["生命"] = 950
  JY.Person[38]["生命最大值"] = 950
  JY.Person[38]["内力"] = 5000
  JY.Person[38]["内力最大值"] = 5000
  JY.Person[38]["攻击力"] = 200
  JY.Person[38]["防御力"] = 200
  JY.Person[38]["轻功"] = 160
  JY.Person[38]["受伤程度"] = 0
  JY.Person[38]["中毒程度"] = 0
  JY.Person[38]["武功等级1"] = 999
  JY.Person[38]["武功2"] = 102
  JY.Person[38]["武功等级2"] = 999
  JY.Person[38]["天赋内功"] = 102
  JY.Person[38]["血量翻倍"] = JY.Person[592]["血量翻倍"]
  JY.Person[38]["个人觉醒"] = 1
end

--天正游坦之
PNLBD[197] = function()
  JY.Person[48]["生命"] = 850
  JY.Person[48]["生命最大值"] = 850
  JY.Person[48]["内力"] = 3000
  JY.Person[48]["内力最大值"] = 3000
  JY.Person[48]["攻击力"] = 150
  JY.Person[48]["防御力"] = 130
  JY.Person[48]["轻功"] = 100
  JY.Person[48]["受伤程度"] = 0
  JY.Person[48]["中毒程度"] = 0
  JY.Person[48]["武功等级1"] = 999
  JY.Person[48]["武功等级2"] = 999
  JY.Person[48]["武功2"] = 108
  JY.Person[48]["血量翻倍"] = JY.Person[592]["血量翻倍"]
  JY.Person[48]["个人觉醒"] = 1
end

--天正慕容复
PNLBD[198] = function()
  JY.Person[51]["生命"] = 750
  JY.Person[51]["生命最大值"] = 750
  JY.Person[51]["内力"] = 3000
  JY.Person[51]["内力最大值"] = 3000
  JY.Person[51]["攻击力"] = 180
  JY.Person[51]["防御力"] = 160
  JY.Person[51]["轻功"] = 120
  JY.Person[51]["受伤程度"] = 0
  JY.Person[51]["中毒程度"] = 0
  JY.Person[51]["武功等级1"] = 999
  JY.Person[51]["血量翻倍"] = JY.Person[592]["血量翻倍"]
  JY.Person[51]["个人觉醒"] = 1
	JY.Person[53]["生命"] = 750
	JY.Person[53]["生命最大值"] = 750
	JY.Person[53]["内力"] = 9999
	JY.Person[53]["内力最大值"] = 9999
	JY.Person[53]["攻击力"] = 160
	JY.Person[53]["防御力"] = 150
	JY.Person[53]["轻功"] = 120
	JY.Person[53]["武功1"] = 85
	JY.Person[53]["武功等级1"] = 999
	JY.Person[53]["武功2"] = 147
	JY.Person[53]["武功等级2"] = 999
	JY.Person[53]["武功3"] = 49
	JY.Person[53]["武功等级3"] = 999
	JY.Person[53]["血量翻倍"] = JY.Person[592]["血量翻倍"]
	JY.Person[53]["个人觉醒"] = 1
end

--天邪二
PNLBD[250] = function()
	--段誉
	JY.Person[53]["生命"] = 750
	JY.Person[53]["生命最大值"] = 750
	JY.Person[53]["内力"] = 9999
	JY.Person[53]["内力最大值"] = 9999
	JY.Person[53]["攻击力"] = 160
	JY.Person[53]["防御力"] = 150
	JY.Person[53]["轻功"] = 120
	JY.Person[53]["武功1"] = 85
	JY.Person[53]["武功等级1"] = 999
	JY.Person[53]["武功2"] = 147
	JY.Person[53]["武功等级2"] = 999
	JY.Person[53]["武功3"] = 49
	JY.Person[53]["武功等级3"] = 999
	JY.Person[53]["血量翻倍"] = JY.Person[592]["血量翻倍"]
	JY.Person[53]["个人觉醒"] = 1
  JY.Person[51]["生命"] = 750
  JY.Person[51]["生命最大值"] = 750
  JY.Person[51]["内力"] = 3000
  JY.Person[51]["内力最大值"] = 3000
  JY.Person[51]["攻击力"] = 180
  JY.Person[51]["防御力"] = 160
  JY.Person[51]["轻功"] = 120
  JY.Person[51]["受伤程度"] = 0
  JY.Person[51]["中毒程度"] = 0
  JY.Person[51]["武功等级1"] = 999
  JY.Person[51]["血量翻倍"] = JY.Person[592]["血量翻倍"]
  JY.Person[51]["个人觉醒"] = 1
end	

--天邪三
PNLBD[251] = function()
	--虚竹
	JY.Person[49]["生命"] = 800
	JY.Person[49]["生命最大值"] = 800
	JY.Person[49]["内力"] = 8500
	JY.Person[49]["内力最大值"] = 8500
	JY.Person[49]["攻击力"] = 150
	JY.Person[49]["防御力"] = 170
	JY.Person[49]["轻功"] = 80
	JY.Person[49]["受伤程度"] = 0
	JY.Person[49]["中毒程度"] = 0
	JY.Person[49]["武功1"] = 8
	JY.Person[49]["武功等级1"] = 999
	JY.Person[49]["武功2"] = 98
	JY.Person[49]["武功等级2"] = 999
	JY.Person[49]["武功3"] = 14
	JY.Person[49]["武功等级3"] = 999
	JY.Person[49]["武功4"] = 101
	JY.Person[49]["武功等级4"] = 999
	for i = 5 , 12 do
		JY.Person[49]["武功"..i] = 0
		JY.Person[49]["武功等级"..i] = 0
	end
	JY.Person[49]["个人觉醒"] = 1
	JY.Person[49]["左右互搏"] = 0
	JY.Person[49]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end	

--连邪水笙
PNLBD[42] = function()
	JY.Person[589]["血量翻倍"] = JY.Person[592]["血量翻倍"]
	JY.Person[589]["个人觉醒"] = 1
end

PNLBD[252] = function()
	JY.Person[589]["生命最大值"] = 650
	JY.Person[589]["生命"] = JY.Person[589]["生命最大值"]
	JY.Person[589]["内力最大值"] = 2500
	JY.Person[589]["内力"] = JY.Person[589]["内力最大值"]
	JY.Person[589]["防御力"] = 130
	JY.Person[589]["轻功"] = 120
	JY.Person[589]["武功等级1"] = 999
end	

--倚邪张无忌
PNLBD[255] = function()
	JY.Person[9]["生命最大值"] = 699
	JY.Person[9]["生命"] = JY.Person[9]["生命最大值"]
	JY.Person[9]["内力最大值"] = 6666
	JY.Person[9]["内力"] = JY.Person[9]["内力最大值"]
	JY.Person[9]["攻击力"] = 220
	JY.Person[9]["防御力"] = 250
	JY.Person[9]["轻功"] = 200
	JY.Person[9]["武功等级1"] = 999
	JY.Person[9]["武功等级2"] = 999
	JY.Person[9]["武功3"] = 97
	JY.Person[9]["武功等级3"] = 900
	JY.Person[9]["武功4"] = 16
	JY.Person[9]["武功等级4"] = 999
	JY.Person[9]["武功5"] = 46
	JY.Person[9]["武功等级5"] = 999
	JY.Person[9]["武功6"] = 93
	JY.Person[9]["武功等级6"] = 900
	JY.Person[9]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--何铁手
--正线
PNLBD[162] = function()
  JY.Person[83]["生命"] = 600
  JY.Person[83]["生命最大值"] = 600
  JY.Person[83]["内力"] = 3500
  JY.Person[83]["内力最大值"] = 3500
  JY.Person[83]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end
--邪线
PNLBD[164] = function()
  JY.Person[83]["生命"] = 600
  JY.Person[83]["生命最大值"] = 600
  JY.Person[83]["内力"] = 3500
  JY.Person[83]["内力最大值"] = 3500
  JY.Person[83]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--书正张召重
PNLBD[142] = function()
	JY.Person[80]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--书邪霍青桐
PNLBD[140] = function()
	JY.Person[74]["生命"] = 500
	JY.Person[74]["生命最大值"] = 500
	JY.Person[74]["内力"] = 1500
	JY.Person[74]["内力最大值"] = 1500
	JY.Person[74]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--鸳邪萧中慧
PNLBD[132] = function()
	JY.Person[77]["生命"] = 500
	JY.Person[77]["生命最大值"] = 500
	JY.Person[77]["内力"] = 1500
	JY.Person[77]["内力最大值"] = 1500
	JY.Person[77]["武功等级1"] = 999
	JY.Person[77]["血量翻倍"] = JY.Person[592]["血量翻倍"]
end

--迷之少女挑战刀剑双绝
PNLBD[132] = function()
	--苗人凤
	JY.Person[3]["武功2"] = 67
	JY.Person[3]["武功等级2"] = 999
	JY.Person[3]["携带物品1"] = -1
	JY.Person[3]["携带物品2"] = -1
	JY.Person[3]["携带物品3"] = -1
	JY.Person[3]["携带物品数量1"] = 0
	JY.Person[3]["携带物品数量2"] = 0
	JY.Person[3]["携带物品数量3"] = 0
	JY.Person[3]["个人觉醒"] = 1
end

PNLBD[226] = function()
	--苗人凤
    JY.Person[5]["个人觉醒"] = 1
	JY.Person[114]["个人觉醒"] = 1
	JY.Person[50]["个人觉醒"] = 2
	JY.Person[27]["个人觉醒"] = 1
end


--黄蓉：奇门遁甲
function WarNewLand(id, x, y)
	if WAR.ZDDH == 226 then
		return 
	end
	local r = JYMsgBox("奇门遁甲", "是否要开启奇门遁甲？", {"否","是"}, 2, WAR.tmp[5000+id])
	if r == 1 then
		return 
	end
	local s = WAR.CurID
	WAR.CurID =  id
	--1绿色，2红色，3蓝色，4紫色
	CleanWarMap(6,-1);
	    	
	local QMDJ = {"休","生","伤","杜","景","死","惊","开"}
				
	--在自身周围绘制奇阵
	SetWarMap(x, y, 6, math.random(4));
	    		
	for j=1, 2 do
	    SetWarMap(x + math.random(6), y + math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
				
	for j=3, 4 do
		SetWarMap(x + math.random(6), y - math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
				
	for j=5, 6 do
	    SetWarMap(x - math.random(6), y - math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
				
	for j=7, 8 do
		SetWarMap(x - math.random(6), y + math.random(6), 6, math.random(4));
		for i = 30, 40 do
			NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 40 then
				lib.Delay(300)
				Cls()
			else
				lib.Delay(1)
			end
		end
	end
	
	WAR.CurID =  s
end
		
--战斗主函数
function WarMain(warid, isexp)
	WarLoad(warid)			--初始化战斗数据
	--WarSelectTeam()			--选择我方
	WarSelectTeam_Enhance()	--选择我方（优化版）
	WarSelectEnemy()		--选择敌人


	
	Health_in_Battle()	--无酒不欢：血量翻倍
 

 
	if JY.Restart == 1 then
		return false
	end
	
	CleanMemory()
	lib.PicInit()
	lib.ShowSlow(20, 1)
	WarLoadMap(WAR.Data["地图"])	--加载战斗地图

	for i = 0, CC.WarWidth-1 do
		for j = 0, CC.WarHeight-1 do
			lib.SetWarMap(i, j, 0, lib.GetS(JY.SubScene, i, j, 0))
			lib.SetWarMap(i, j, 1, lib.GetS(JY.SubScene, i, j, 1))
		end
	end
  
  --雪山落花流水战役
  if WAR.ZDDH == 42 then
    SetS(2, 24, 31, 1, 0)
    SetS(2, 30, 34, 1, 0)
    SetS(2, 27, 27, 1, 0)
  end
  
  --新华山论剑
  if WAR.ZDDH == 238 then
    for x = 24, 34 do
      for y = 24, 34 do
        lib.SetWarMap(x, y, 0, 1030)
      end
    end
    for y = 23, 35 do
      lib.SetWarMap(23, y, 1, 1174)
      lib.SetWarMap(35, y, 1, 1174)
    end
    for x = 24, 35 do
      lib.SetWarMap(x, 35, 1, 1174)
      lib.SetWarMap(x, 23, 1, 1174)
    end
    lib.SetWarMap(23, 23, 0, 1174)
    lib.SetWarMap(35, 35, 0, 1174)
    lib.SetWarMap(23, 35, 0, 1174)
    lib.SetWarMap(35, 23, 0, 1174)
    lib.SetWarMap(23, 23, 1, 2960)
    lib.SetWarMap(35, 35, 1, 2960)
    lib.SetWarMap(23, 35, 1, 2960)
    lib.SetWarMap(35, 23, 1, 2960)
  end
  
  --杀东方不败
  if WAR.ZDDH == 54 then
    lib.SetWarMap(11, 36, 1, 2)
  end
  
	--改变游戏状态
	JY.Status = GAME_WMAP
	  
	--加载贴图文件
lib.PicLoadFile(CC.WMAPPicFile[1], CC.WMAPPicFile[2], 0)						--战场贴图，内存区域0
	
	lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.ScreenW/936*100,0,100))	--人物大头像，内存区域1
	
	lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)			--物品贴图，内存区域2
	
	lib.PicLoadFile(CC.EFTFile[1], CC.EFTFile[2], 3)								--特效贴图，内存区域3
	
	lib.LoadPNGPath(CC.PTPath, 95, CC.PTNum, limitX(CC.ScreenW/936*100,0,100))
	
	lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.ScreenW/936*100,0,100))
	
	lib.LoadPNGPath(CC.IconPath, 98, CC.IconNum, limitX(CC.ScreenW/936*100,0,100))	--状态图标，内存区域98
	
	lib.LoadPNGPath(CC.HeadPath, 99, CC.HeadNum, 26.923076923)						--人物小头像，用于集气条，内存区域99
   
    lib.LoadPNGPath(CC.BodyPath, 90, CC.BodyNum, limitX(CC.ScreenW/936*100,0,100))	--半身象
	lib.LoadPNGPath(CC.XTPath, 91, CC.XTNum, limitX(CC.ScreenW/936*100,0,100))	--UI		
	
	lib.LoadPNGPath(CC.DzPath, 97, CC.DzNum, 110)	--大招图标，内存区域97
	lib.LoadPNGPath(CC.BJPath, 98, CC.BJNum, limitX(CC.ScreenW/936*100,0,100))		--奇穴
	lib.PicLoadFile(CC.BJ[1], CC.BJ[2], 92) 


	--无酒不欢：随机战斗音乐
	local zdyy = math.random(10) + 99
	
	--15大固定
	if WAR.ZDDH == 133 or WAR.ZDDH == 134 then
		zdyy = 27
	end
	
	--VS少林诸僧战固定
	if WAR.ZDDH == 80 then
		zdyy = 22
	end
	
	--葵花尊者战固定
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 then
		zdyy = 112
	end
	
	--蒙哥战固定
	if WAR.ZDDH == 278 then
		zdyy = 110
	end
	
	PlayMIDI(zdyy)
	
	--PlayMIDI(WAR.Data["音乐"])  
	  
	local first = 0          --第一次显示战斗标记
	local warStatus = nil		 --战斗状态
  
 
	WarPersonSort()			--按轻功排序
	CleanWarMap(2, -1)
	CleanWarMap(6, -2)
	  

	for i = 0, WAR.PersonNum - 1 do
		
		if i == 0 then
		  WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"] = WE_xy(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"])
		else
		  WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"] = WE_xy(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], i)
		end
		
		SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 2, i)
		
		local pid = WAR.Person[i]["人物编号"]
		lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[pid]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[pid]["头像代号"]), 4 + i)	--人物战斗动作贴图，内存区域4-29（一场战斗上限26人）
		
		--Alungky 用5000数组来保存头像数据
		--主角的数据要特殊处理
		if pid == 0 and JY.Base["畅想"] == 0 then
			if JY.Base["标准"] > 0 then
				if JY.Person[0]["性别"] == 0 then
					WAR.tmp[5000+i] = 280 + JY.Base["标准"]
				else
					WAR.tmp[5000+i] = 500 + JY.Base["标准"]
				end
			--特殊
			else
				if JY.Person[0]["性别"] == 0 then
					WAR.tmp[5000+i] = 290
				else
					WAR.tmp[5000+i] = 510
				end
				if JY.Base["畅想"] == 447 then
			    WAR.tmp[5000+i] = 389
			    end
				if JY.Base["畅想"] == 507 then
			    WAR.tmp[5000+i] = 206
			    end
			end
		else
			WAR.tmp[5000+i] = JY.Person[pid]["头像代号"]
			if JY.Person[pid]["头像代号"] == 217 and pid == 447 then
			WAR.tmp[5000+i] = 389
			end
			if JY.Person[pid]["头像代号"] == 93 and pid == 507 then
			WAR.tmp[5000+i] = 206
			end
		end
	end

 
	--轻功对移动格子的计算
	--x为战场轻功，y为体力
	local function getnewmove(x, y)
		local mob = x + y
		if mob > 478 then
			return 7
			elseif mob > 328 then
			return 6
			elseif mob >198 then
			return 5
			elseif mob > 148 then
			return 4
		elseif mob > 126 then
			return 3
		elseif mob > 116 then
			return 2
		else
			return 1
		end
	end
	local function getdelay(x, y)
		return math.modf(1.5 * (x / y + y - 3))
	end
	
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i]["贴图"] = WarCalPersonPic(i)
	end
	WarSetPerson()
	WAR.CurID = 0
	WarDrawMap(0)
	lib.ShowSlow(20, 0)

  if WAR.ZDDH == 166  then
	say("想当年那旮旯庙里有我们四大高手，曾经如此踌躇满志。",455,0)
	say("大师兄喜欢权势，结果去蒙古那里当了国师，每天啃羊肉，日子过得很滋润。",455,0)
	say("二师兄武痴，整天说天下能和他打成平手的没几个",455,0)
	say("后来去少林寺交流了一下，结果不知道受了啥打击，回去当翻译官了。",455,0)
	say("小师弟，哎，太好色了，跑到雪山那边当神棍搞欢喜禅。",455,0)
	say("而我，搞搞瑜伽，到处逛逛，想要修仙了。",455,0)
	say("请问，这位大师？",0,1)
	say("叫谁大师咧？你才大师，你全家都大师，看清楚没，我是道士,信不信我削你",455,0)
	say("………………………………………………",0,1)
  end

	
	--无酒不欢：设置人物的初始集气位置
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i].Time = 800 - i * 1000 / WAR.PersonNum
				
		--岳灵珊 每个剑法到极+50点初始集气
		if match_ID(WAR.Person[i]["人物编号"], 79) then
			local JF = 0
			local bh = WAR.Person[i]["人物编号"]
			for i = 1, CC.Kungfunum do
				if JY.Person[bh]["武功" .. i] < 50 and JY.Person[bh]["武功" .. i] > 26 and JY.Person[bh]["武功等级" .. i] == 999 then
					JF = JF + 1
				end
			end
			WAR.Person[i].Time = WAR.Person[i].Time + (JF) * 50
		end
		
		if WAR.Person[i].Time > 990 then
			WAR.Person[i].Time = 990
		end
		
		--令狐冲，一觉之后，初始满集气
		if match_ID_awakened(WAR.Person[i]["人物编号"], 35, 1) or (match_ID(WAR.Person[i]["人物编号"], 35) and PersonKF(WAR.Person[i]["人物编号"],47)) then
			WAR.Person[i].Time = 998
		end
		
		--独孤求败，初始满集气
		if match_ID(WAR.Person[i]["人物编号"], 592) then
			WAR.Person[i].Time = 999
		end

		if match_ID(WAR.Person[i]["人物编号"], 455) then --天竺子初始集气900
			WAR.Person[i].Time = 900
		end
		
		--血刀老祖 初始集气900
		if match_ID(WAR.Person[i]["人物编号"], 97) then
			WAR.Person[i].Time = 900
		end

		
		--太监初始集气-200
		if JY.Person[WAR.Person[i]["人物编号"]]["性别"] == 2 and nglw(WAR.Person[i]["人物编号"], 105)<1 then
			WAR.Person[i].Time = -200
		end
		
		--林平之 初始集气700
		if match_ID(WAR.Person[i]["人物编号"], 36) then
			WAR.Person[i].Time = 700
		end
		
		--木桩的初始集气
		if WAR.Person[i]["人物编号"] == 591 and WAR.ZDDH == 226 then
			WAR.Person[i].Time = 0
		end


		
		--圣火神功 初始集气加200和100随机
		local id = WAR.Person[i]["人物编号"]
		if PersonKF(id, 93) then
			WAR.Person[i].Time = WAR.Person[i].Time + 200 + math.random(100)
		end
		
        if T7DFWM(id) then --东方未明暗系初始集气
		WAR.Person[i].Time = WAR.Person[i].Time + 50 * wgnumber(WAR.Person[i]["人物编号"], 2)
	    end	
		
		if WAR.Person[i].Time > 990 then
			WAR.Person[i].Time = 990
		end
		
		--移动步数在此
		WAR.Person[i]["移动步数"] = math.modf(getnewmove(WAR.Person[i]["轻功"], JY.Person[id]["体力"]) - JY.Person[id]["中毒程度"] / 50 - JY.Person[id]["受伤程度"] / 50)
		if WAR.Person[i]["移动步数"] < 1 then
			WAR.Person[i]["移动步数"] = 1
		end
	end
  
	--战场上显示物品，无酒不欢，这里需要留意，感觉没什么用
	for a = 0, WAR.PersonNum - 1 do
		for s = 1, 4 do
			if JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] == nil or JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] < 1 then
				JY.Person[WAR.Person[a]["人物编号"]]["携带物品" .. s] = -1
				JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] = 0;
			end
		end
	end
	
	--笑傲邪线，黑木崖如果单挑东方不败，则东方会以葵花尊者形态出战
	if WAR.ZDDH == 54 and JY.Person[27]["品德"] == 20 and WAR.MCRS == 1 then
		local dfid;
		for i = 0, WAR.PersonNum - 1 do
			local id = WAR.Person[i]["人物编号"]
			if id == 27 then
				dfid = i;
				break
			end
		end
		local orid = WAR.CurID
		WAR.CurID = dfid
		
		Cls()
		local KHZZ = {"面对本座","对方竟敢单独出战","伤自尊啊"}
		
		for i = 1, #KHZZ do
			lib.GetKey()
			DrawString(-1, -1, KHZZ[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end
		
		CurIDTXDH(WAR.CurID, 7, 1)
		
		lib.Background(0,200,CC.ScreenW,400,78)
		NewDrawString(CC.ScreenW, CC.ScreenH/2 + 160, "葵花诀尊者形态", C_GOLD, 80)
		NewDrawString(CC.ScreenW, CC.ScreenH/2 + 360, "看吧 东方在赤红的燃烧", C_RED, 70)
		
		ShowScreen()
		Cls()
		lib.Delay(2000)
		
		local KHZZ2 = {"不知死活的"..JY.Person[0]["外号2"],"好好体验一下死亡的恐怖吧"}
		
		for i = 1, #KHZZ2 do
			lib.GetKey()
			DrawString(-1, -1, KHZZ2[i], C_GOLD, CC.Fontsmall)
			ShowScreen()
			Cls()
			lib.Delay(1000)
		end
		
		WAR.CurID = orid
	end

for a = 0, WAR.PersonNum - 1 do --战意初始化
	local aa = WAR.Person[a]["人物编号"]
	--if aa == zj() then haszj = 1 end
    WAR.SPIRIT[aa] = 100
	WAR.SPIRITMAX[aa] = 140
	WAR.SPIRITMIN[aa] = 80
	
	if match_ID(aa, 112) then --萧远山战意增加
		WAR.SPIRIT[aa] = 120	
		WAR.SPIRITMIN[aa] = 100		
		WAR.SPIRITMAX[aa] = 170	
	end	
	
	if match_ID(aa, 50) then --萧远山战意增加
		WAR.SPIRIT[aa] = 120	
		WAR.SPIRITMIN[aa] = 120		
		WAR.SPIRITMAX[aa] = 200	
	end	
	
	if match_ID(aa, 70) then --玄慈战意增加
		WAR.SPIRITMAX[aa] = 170
	end
	
	if JY.Person[aa]["个人觉醒"] >= 1 then --觉醒人物战意增加
	    WAR.SPIRIT[aa] = WAR.SPIRIT[aa] + 10
		WAR.SPIRITMIN[aa] = WAR.SPIRITMIN[aa]+10
	end
	

	zhanyi(aa, jiazhanyi(aa), 1)
  end  
	
  	for i = 0, WAR.PersonNum - 1 do --小昭减敌人战意加自己战意
		local aa = WAR.Person[i]["人物编号"]
		if aa == 66 then
			for j = 0, WAR.PersonNum - 1 do
				local bb = WAR.Person[j]["人物编号"]
				if WAR.Person[i]["我方"] ~= WAR.Person[j]["我方"] then
					zhanyi(bb, -5)
				else
					zhanyi(bb, 5)
				end
			end
			break
		end
		if aa == 15 then
			for j = 0, WAR.PersonNum - 1 do
				local bb = WAR.Person[j]["人物编号"]
				if WAR.Person[i]["我方"] == WAR.Person[j]["我方"] then
					zhanyi(bb, 10)
				end
			end
			break		
		end
		   if YCRW(aa) == 1 then
           WAR.HIDE3[aa] = 50
           end		
	end	

  	for i = 0, WAR.PersonNum - 1 do --小昭减敌人战意加自己战意
		local aa = WAR.Person[i]["人物编号"]
		   if YCRW(aa) == 1 then
           WAR.HIDE3[aa] = 50
           end		
	end	
	
	--圣火三使战开局的文字特效
	if WAR.ZDDH == 14 then
		say("Ｇ１妙风使！", 173, 0)   --妙风使
		say("Ｇ１流云使！", 174, 1)   --流云使
		say("Ｇ１辉月使！Ｈ圣火三绝阵！", 175, 5)   --辉月使！Ｈ圣火三绝阵！
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "圣火三绝阵", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
  
  if WAR.ZDDH >= 0 then 
    for a = 0, WAR.PersonNum - 1 do
    if wglw(WAR.Person[a]["人物编号"],78)>1 then 
      for i = 40, 80 do
      NewDrawString(-1, -1, "万里黄沙 无边瀚海", C_GOLD, i)
      ShowScreen()
      if i == 80 then
        Cls()
        NewDrawString(-1, -1, "万里黄沙 无边瀚海", C_GOLD, i)
        ShowScreen()
        lib.Delay(400)
        --WaitKey()
      else
        lib.Delay(1)
      end
    end
	WAR.WLHS = 1
	end

	break
	end
 end   

    for a = 0, WAR.PersonNum - 1 do
    if D1ZSF(WAR.Person[a]["人物编号"]) then 
      for i = 40, 80 do
      NewDrawString(-1, -1, "两仪微尘 太极化生", C_GOLD, i)
      ShowScreen()
      if i == 80 then
        Cls()
        NewDrawString(-1, -1, "两仪微尘 太极化生", C_GOLD, i)
        ShowScreen()
        lib.Delay(400)
        --WaitKey()
      else
        lib.Delay(1)
      end
    end
	end
	break
	end
 
	--密道成昆战，我方集气全体为0
	if WAR.ZDDH == 237 then
		for a = 0, WAR.PersonNum - 1 do
			if WAR.Person[a]["我方"] == true then
				WAR.Person[a].Time = 0
			end
		end
	end
  
	--新华山论剑
	if WAR.ZDDH == 238 then
		for i = 1, 10 do
			lib.GetKey()
			NewDrawString(-1, -1, "华山论剑", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			if i == 10 then
				lib.Delay(300)
			else
				lib.Delay(1)
			end
		end
	end
  
	--全真七子，天罡北斗阵
	if WAR.ZDDH == 73 then
		for i = 15, 35 do
			lib.GetKey()
			NewDrawString(-1, -1, "天罡北斗阵", C_GOLD, CC.DefaultFont+i*2)
			ShowScreen()
			Cls()
			if i == 35 then
				lib.Delay(500)
			else
				lib.Delay(5)
			end
		end
	end
	
	--组合动画显示
	if CC.CoupleDisplay == 1 then
		local function fightcombo()
			local combo = {}
			for i = 1, #CC.COMBO do
				combo[i] = {CC.COMBO[i][1], CC.COMBO[i][2], CC.COMBO[i][3],0}
			end
			for i = 0, WAR.PersonNum - 1 do
				local t = WAR.Person[i]["人物编号"]
				for j = 1, #combo do
					lib.GetKey()
					if match_ID(t, combo[j][1]) then
						for z = 0, WAR.PersonNum - 1 do
							local t2 = WAR.Person[z]["人物编号"]
							if match_ID(t2, combo[j][2]) and WAR.Person[i]["我方"] == WAR.Person[z]["我方"] then
								combo[j][4] = 1
								break
							end
						end
					end
				end
			end
			for i = 1, #combo do
				if combo[i][4] == 1 then
					local t1 = combo[i][1]
					local t2 = combo[i][2]
					for j = 0, 10 do
						lib.GetKey()
						local str = JY.Person[t1]["姓名"].."＆"..JY.Person[t2]["姓名"]
						local str2 = combo[i][3]
						WAR.COMBO[t1] = (WAR.COMBO[t1] or 0) + 1
						WAR.COMBO[t2] = (WAR.COMBO[t2] or 0) + 1
						Cls()
						DrawBox(150, CC.ScreenH / 3 + 30, CC.ScreenW - 150, CC.ScreenH / 3 * 2 - 20, C_BLACK)
						lib.LoadPNG(1, JY.Person[t1]["头像代号"]*2, CC.ScreenW / 4 - 80, CC.ScreenH / 2 - 35, 1)
						lib.LoadPNG(1, JY.Person[t2]["头像代号"]*2, CC.ScreenW / 4 + 50, CC.ScreenH / 2 - 35, 1)
						NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, str, C_ORANGE, 25)	
						NewDrawString(CC.ScreenW / 2 * 3 - 170, -1, str2, C_GOLD, 50 + j)
						ShowScreen()							
						lib.Delay(30)	
					end		
					lib.Delay(400)	
				end
			end
		end
		
		fightcombo()
	end
	
	--四帮主之战，乔峰用铁掌
	if WAR.ZDDH == 83 then
		JY.Person[50]["武功1"] = 13
    end
  	
	warStatus = 0
	buzhen()
	--Pre_Yungong()	--无酒不欢：战前运功
	
	--黄蓉奇门遁甲，我方才触发
	for j = 0, WAR.PersonNum - 1 do
		if match_ID(WAR.Person[j]["人物编号"], 56) and WAR.Person[j]["我方"] == true then
			WarNewLand(j, WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"])
			break
		end
	end
	
	WAR.Delay = GetJiqi()
	local startt, endt = lib.GetTime()
  
  --初始化地形
  
  while true do
	if JY.Restart == 1 then
		return false
	end
    WarDrawMap(0)
    WAR.ShowHead = 0
    DrawTimeBar()
    
    lib.GetKey()
    ShowScreen()
    if WAR.ZYHB == 1 then
		WAR.ZYHB = 2
    end
    
    
    local reget = false 
    
    
    
    for p = 0, WAR.PersonNum - 1 do
		lib.GetKey()

		if WAR.Person[p]["死亡"] == false and WAR.Person[p].Time > 1000 then
      	
      	
        WarDrawMap(0)
        ShowScreen()
        local keypress = lib.GetKey()
        if WAR.AutoFight == 1 and (keypress == VK_SPACE or keypress == VK_RETURN) then
			WAR.AutoFight = 0
        end
        reget = true
        local id = WAR.Person[p]["人物编号"]
       
        
        --左右触发之后，不可移动
        if WAR.ZYHB == 2 then
			WAR.Person[p]["移动步数"] = 0
		--特效：不可移动
        elseif WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] ~= nil and WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] == 1 then
        	WAR.Person[p]["移动步数"] = 0
        	WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] = nil
        else
        	--计算移动步数
			WAR.Person[p]["移动步数"] = math.modf(getnewmove(WAR.Person[p]["轻功"], JY.Person[id]["体力"]) - JY.Person[id]["中毒程度"] / 50 - JY.Person[id]["受伤程度"] / 50)
			if WAR.YZSP[id] ~=nil then----
			WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - math.modf(JY.Person[id]["受伤程度"] / 50)
			end
			--毒王中毒移动能力补偿
			if id == 0 and JY.Base["标准"] == 9 then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + math.modf(JY.Person[id]["中毒程度"] / 50)
			end
			for j = 0, WAR.PersonNum - 1 do
				--小昭，敌人移步数少三格
				if match_ID(WAR.Person[j]["人物编号"], 66) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 3
				end
				if MPPB_THQM(WAR.Person[j]["人物编号"] )>=1  and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] then
					WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - (2+MPDJ(WAR.Person[j]["人物编号"]))
				end
			end

			if WAR.QMDJ[WAR.Person[p]["人物编号"]]~=nil then
			   local aa = math.modf(WAR.QMDJ[WAR.Person[p]["人物编号"]]/3)
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - aa
			end

			if WAR.CHZ[WAR.Person[p]["人物编号"]]~=nil then
			   local aa = math.modf(WAR.CHZ[WAR.Person[p]["人物编号"]]/20)
			   WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - aa
			end
			
			if wglw(id,74)>=1 and WAR.SHJG[id]~=nil and WAR.SHJG[id] ==2 then
               WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 5
		    end
			
			--天罗地网，柔网势，敌人移动减一格
			if WAR.TLDW[WAR.Person[p]["人物编号"]] ~= nil and WAR.TLDW[WAR.Person[p]["人物编号"]] == 1 then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
				WAR.TLDW[WAR.Person[p]["人物编号"]] = nil
			end
			if WAR.Person[p]["移动步数"] < 1 then
				WAR.Person[p]["移动步数"] = 1
			end
			--令狐冲，灭绝，血刀老祖，阿凡提，神雕移动+3格
			if match_ID(id, 35) or match_ID(id, 6) or match_ID(id, 97) or match_ID(id, 606) or match_ID(id, 628) then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
			end
			--张三丰，移动至少8格
			if match_ID(id, 5) and WAR.Person[p]["移动步数"] < 8 then
				WAR.Person[p]["移动步数"] = 8
			end	
			--主运飞天，凌波，天罗，移动+1
			if Curr_QG(id,145) or Curr_QG(id,147) or Curr_QG(id,148) then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
			end
			--主运神行，移动+2
			if Curr_QG(id,146) then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
			end
			--主运瞬息，移动+2，不低于8
			if Curr_QG(id,150) then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
				local  aa = (WAR.LXZT[id] or 0) + (WAR.CHZ[id] or 0) + JY.Person[id]["受伤程度"]+JY.Person[id]["灼烧程度"]+JY.Person[id]["中毒程度"]+JY.Person[id]["冰封程度"]+ (WAR.MBZ[id] or 0)
				aa = math.modf(aa/20)
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + aa
				if  WAR.Person[p]["移动步数"] < 8 then
				WAR.Person[p]["移动步数"] = 8
			   end	
			end
			--主角学会迷踪步后，移动+1
			if id == 0 and JY.Person[615]["论剑奖励"] == 1 then
				WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
			end
        end
        
        --最大移动步数10，瞬息打破限制
        if WAR.Person[p]["移动步数"] > 10 and not Curr_QG(id,150) then
			WAR.Person[p]["移动步数"] = 10
        end
		

		if wglw(id, 129)>=1  and WAR.Person[p]["移动步数"] < 20 then  ---狂风身法
			WAR.Person[p]["移动步数"] = 20
		end	
		
			for j = 0, WAR.PersonNum - 1 do
				--沙漠效果
				if wglw(WAR.Person[j]["人物编号"], 78)>1 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] then
					WAR.Person[p]["移动步数"] = math.modf(WAR.Person[p]["移动步数"]/2)
					if WAR.Person[p]["移动步数"] < 1 then
				       WAR.Person[p]["移动步数"] = 1
			        end
				end
				break
			end
		
        WAR.ShowHead = 0
        WarDrawMap(0)
        WAR.Effect = 0
        WAR.CurID = p
        WAR.Person[p].TimeAdd = 0
        local r = nil
        local pid = WAR.Person[WAR.CurID]["人物编号"]
		
		if wglw(pid,74)>=1 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] ==2 then
        
		else
		WAR.Defup[pid] = nil	
		end
		
		WAR.JCYY[pid] = nil
		WAR.JCYY1[pid] = nil
		
		--段誉的指令，行动前恢复
        if match_ID(pid, 53) then
			WAR.TZ_DY = 0
        end
		--慕容复的指令，行动前恢复
        if match_ID(pid, 51) then
			WAR.TZ_MRF = 0
        end	

		if match_ID(pid, 152) then --萧秋水连击重置
			WAR.WCLJ = 0
		end

		if WAR.HEJI ~= 0 then --合体技重置
		   WAR.HEJI = 0 
		end		
		
			if WAR.DUIZHAO > 0 then --对招重置
		   WAR.DUIZHAO = 0 
		end
		
		if match_ID_awakened(pid,69,1)  then --觉醒洪七重置
			WAR.HQGS = 0
			WAR.HQGSTS = 0
			WAR.HQGS2 = 0
            WAR.HQGSTS2 = 0			
		end
	
		--阿青，行动前内伤中毒清0
	    if match_ID(pid, 604) then
			JY.Person[pid]["受伤程度"] = 0
			JY.Person[pid]["中毒程度"] = 0
	    end
		
		--阿九，行动开始前，60%几率降低敌方集气100点
		if match_ID(pid, 629) and JLSD(20,80,pid) then
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
				end
			end
			DrawTimeBar2()
		end
		
		--先天调息，60%几率休息
		if Curr_NG(pid, 100) and math.random(10) < 7 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 19,1,"先天调息",C_ORANGE);
			WAR.XTTX = 1
			if match_ID_awakened(pid,65,1) and math.random(10) < 9 and WAR.LMZL == 0 then--
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 35,1,"龙脉代谢.六气合一",M_Yellow)
			WAR.LMZL = 1
			end
			War_RestMenu()
			WAR.XTTX = 0
		end
	
		--先天调息，60%几率休息
		if match_ID_awakened(pid,63,1) and math.random(10) < 7 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 23,1,"百花仙音.清心普咒",C_ORANGE);
			WAR.QXPZ = 1
			War_RestMenu()
			WAR.QXPZ = 0
		end
	
		--战三渡时，超过100时序，周芷若领悟左右
		if WAR.ZDDH == 253 and match_ID(pid, 631) and WAR.ZZRZY == 0 and 100 < WAR.SXTJ then
			say("１Ｌ＜这三人心意相通，如攻其一人，则其余两人立即回护，这样如何能够破阵？ｗ……若能分心二用，同时攻击两方，且他们如何应对＞Ｗ", 357, 0,"周芷若")  --对话
			if JY.Base["畅想"] == 631 then
				JY.Person[0]["左右互搏"] = 1
			else
				JY.Person[631]["左右互搏"] = 1
			end
			WAR.ZZRZY = 1
		end


		


	
		--行动时显示血条
		WAR.ShowHP = 1
        
		--无酒不欢：行动时，获取指令
        if WAR.HMZT[pid] ~= nil then			--昏迷状态
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			if WAR.HMZT[pid] == 1 then
			CurIDTXDH(WAR.CurID, 94,1,"昏迷中",C_ORANGE)
			end
			reseteffect2(WAR.HMZT, pid, 1)
	     elseif WAR.SILENCE[pid] ~= nil then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 87,1,"沉默跳过回合",C_ORANGE)
        elseif inteam(pid) and WAR.Person[p]["我方"] then
			if WAR.AutoFight == 0 then
				r = War_Manual()
			elseif JY.Person[pid]["禁用自动"] == 1 then
				r = War_Manual()
			else
				r = War_Auto()
			end
        else
			r = War_Auto()
        end
		
		if JY.Restart == 1 then
			return false
		end
        
		
        --如果发动左右互搏
        if WAR.ZYHB == 1 then
			for j = 0, WAR.PersonNum - 1 do
				WAR.Person[j].Time = WAR.Person[j].Time - 15
				if WAR.Person[j].Time > 990 then
					WAR.Person[j].Time = 990
				end
			end
			WAR.Person[p].Time = 1005
			WAR.ZYYD = WAR.Person[p]["移动步数"]
			WAR.ZYHBP = p
			
	        --一灯，避免被反死
	        if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
				JY.Person[65]["生命"] = 1
	        end
			
	        if JY.Base["畅想"] == 65 and JY.Person[0]["生命"] <= 0 and WAR.WCY[0] == nil then
				JY.Person[0]["生命"] = 1
	        end
			
			--王重阳
			if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
				JY.Person[129]["生命"] = 1
			end
			
	        if JY.Base["畅想"] == 129 and JY.Person[0]["生命"] <= 0 and WAR.CYZX[0] == nil then
				JY.Person[0]["生命"] = 1
	        end
			
			if WAR.ZDDH == 128 then
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["人物编号"] == 553 and JY.Person[553]["生命"] <= 0 then
						WAR.YZB = 1
						WAR.FXDS[553] = nil
						WAR.LXZT[553] = nil
					end
				end
				if WAR.YZB == 1 then
					if WAR.YZB2 < 3 then
						WAR.YZB = 0
						WAR.YZB2 = WAR.YZB2 + 1
						say("１Ｒ负けいくざ　だが　オレうちなるとうしが　それをこばむ　これはぶもんのいちか　真田幸村　いざ　まいる", 553,0)
						JY.Person[553]["生命最大值"] = JY.Person[553]["生命最大值"] + 100
						JY.Person[553]["内力最大值"] = JY.Person[553]["内力最大值"] + 1000
						JY.Person[553]["生命"] = JY.Person[553]["生命最大值"]
						JY.Person[553]["内力"] = JY.Person[553]["内力最大值"]
						JY.Person[553]["中毒程度"] = 0
						JY.Person[553]["受伤程度"] = 0
						JY.Person[553]["体力"] = 100
						JY.Person[553]["攻击力"] = JY.Person[553]["攻击力"] + 100
						JY.Person[553]["防御力"] = JY.Person[553]["防御力"] + 100
						JY.Person[553]["轻功"] = JY.Person[553]["轻功"] + 80
						JY.Person[553]["武功1"] = 66
						JY.Person[553]["武功等级1"] = 999
						for j = 0, WAR.PersonNum - 1 do
							if WAR.Person[j]["人物编号"] == 553 then
								WAR.Person[j].Time = 980
							end
						end
					else
						if WAR.YZB3 == 0 then
							say("６Ｒもはや　これまでか..........", 553,0)
							say("２（真田幸村－－－－，Ｈ真是让人钦佩的勇士啊！！！）",0,1)
							say("２（真田兄，一六一五年大阪城再会吧！Ｈ那时我的名字是......）",0,1)
							WAR.YZB3 = 1
						end
					end
				end
			end
          
			--阎基偷钱
			if WAR.YJ > 0 then
				instruct_2(174, WAR.YJ)
				WAR.YJ = 0
			end
        else
	        if WAR.ZYHB == 2 then
				WAR.ZYHB = 0
	        end
			--周伯通的追加互搏判定
			if WAR.ZHB == 1 then
				WAR.ZHB = 0
			end
	        
	        WAR.Person[p].Time = WAR.Person[p].Time - 1000
	        if WAR.Person[p].Time < -500 then
	          WAR.Person[p].Time = -500
	        end
        
			if pid == WAR.AXL then --武骧金星：清空阿修罗标志
				WAR.AXL = -1
			end
	
--天罗蜘蛛感应
	
 for j = 0, WAR.PersonNum-1 do
			    local df = WAR.Person[j]["人物编号"] 
			    local offset1 = math.abs(WAR.Person[p]["坐标X"] - WAR.Person[j]["坐标X"]) 
                local offset2 = math.abs(WAR.Person[p]["坐标Y"] - WAR.Person[j]["坐标Y"])
			    local offset=offset1+offset2
                local mpdj = 8			
			    if WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) and qglw(df,148) >=2 then
                WAR.Person[j].Time = WAR.Person[j].Time + 200
                   if  WAR.Person[j].Time >= 1005 then
                       WAR.Person[j].Time = 1005
				   else 
				       if math.random(1,10) < 3 then
					   WAR.Person[j].Time = 1005
					   end
                   end 
				    local z = WAR.CurID
					WAR.CurID  = j
                   	WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 61,1,"天罗感应·蛛步暗行",C_GOLD);
					WAR.CurID = z
			    end	  
			    if WAR.Person[j]["我方"] == WAR.Person[p]["我方"] and WAR.Person[j]["死亡"] == false and WAR.XDLZ2[df] == 1 and nglw(df,163) >=2 then
                WAR.Person[j].Time = WAR.Person[j].Time + 200
                   if  WAR.Person[j].Time >= 1005 then
                       WAR.Person[j].Time = 1005
				   else 
				       if math.random(1,10) < 3 then
					   WAR.Person[j].Time = 1005
					   end
                   end 
				    local z = WAR.CurID
					WAR.CurID  = j
                   	WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 61,1,"天罗感应·蛛步暗行",C_GOLD);
					WAR.CurID = z
			    end					
 end


 for j = 0, WAR.PersonNum-1 do
			    local df = WAR.Person[j]["人物编号"] 
			    local offset1 = math.abs(WAR.Person[p]["坐标X"] - WAR.Person[j]["坐标X"]) 
                local offset2 = math.abs(WAR.Person[p]["坐标Y"] - WAR.Person[j]["坐标Y"])
			    local offset=offset1+offset2
                local mpdj = 8			
			    if WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) and wglw(df,5) >2 then
				    local z = WAR.CurID
				    WAR.CurID  = j
                    WAR.HBYJ[id] = limitX((WAR.HBYJ[id] or 0)+1,0,3+wglw(df,5)*3)
			      if WAR.BSFW[df] == nil then 
			         WAR.BSFW[df] = 1 
			       else 	 
                     WAR.BSFW[df] = WAR.BSFW[df] + 1 
			      end
                     if WAR.BSFW[df] >= 5*wglw(df,5) then 
                        WAR.BSFW[df] = 5*wglw(df,5)
			         end
                   	WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 61,1,"霜天·冰结天地",C_GOLD);
					WAR.CurID = z
			    end	  			
 end

   for j = 0, WAR.PersonNum-1 do
			    local df = WAR.Person[j]["人物编号"] 
			    local offset1 = math.abs(WAR.Person[p]["坐标X"] - WAR.Person[j]["坐标X"]) 
                local offset2 = math.abs(WAR.Person[p]["坐标Y"] - WAR.Person[j]["坐标Y"])
			    local offset=offset1+offset2
                local mpdj = 8			
			    if WAR.Person[j]["我方"] ~= WAR.Person[p]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) and wglw(df,62) >=1 and WAR.Person[j]["补刀武功"] == -1 then
                    if JLSD(10,40+wglw(df,62)*10,df) then
				    local z = WAR.CurID
					WAR.CurID  = j
                   	WarDrawMap(0); --不加这条则动画位置无法正常显示
					WAR.Person[j]["补刀武功"] = 62
					CurIDTXDH(WAR.CurID, 32,1,"感应·蓄刀劲",C_GOLD)	
	                WAR.FQDF1[df] = 0
	                if sixi(df,4)>300 then
	                   WAR.FQDF1[df] = 3
	                elseif sixi(df,4)>100 then
	                   WAR.FQDF1[df] = 2
	                else
	                   WAR.FQDF1[df] = 1
	                end
	                if wglw(df,62)>2  then
	                   WAR.FQDF1[df] = WAR.FQDF1[df] + 1
	                end
                    WAR.CurID = z					
					end
			    end	  			
   end

--罗汉伏魔功 每回合回复生命(二层天内后可以回内)
			if PersonKF(id, 96) and JY.Person[id]["生命"] > 0 then
				local heal_amount;
				local HN;
				heal_amount = (JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/JY.Person[pid]["血量翻倍"]
				if Curr_NG(id, 96) then
					heal_amount = math.modf(heal_amount * 0.2)
				else
					heal_amount = math.modf(heal_amount * 0.1)
				end
				if nglw(id, 96)>0 then
					heal_amount = heal_amount+math.modf(heal_amount * 0.05*nglw(id, 96))
				end
				if WAR.LUCK[id]~=nil then
					heal_amount = JY.Person[id]["生命最大值"] - JY.Person[id]["生命"]
				end
				if WAR.UNLUCK[id]~=nil then
					heal_amount = 0
				end
				if nglw(id, 96)>1 then
				HN = math.modf(heal_amount*nglw(id, 96)*3)
				if nglw(id, 96)>2 then----天内第三层可将多余内力回馈生命
				   local HN2=JY.Person[id]["内力最大值"]- JY.Person[id]["内力"]
				   if HN>HN2 then----
				   HN=HN-HN2
				   heal_amount = heal_amount+math.modf(HN*0.2)
				   HN=HN2
				   end
				end
                WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				Cls();
				War_Show_Count(WAR.CurID, "罗汉伏魔功恢复内力");
				end
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
				Cls();
				War_Show_Count(WAR.CurID, "罗汉伏魔功恢复生命");
			end



			--苗人凤每回合回复生命与内力		
			if 	match_ID(id, 3)  and JY.Person[id]["生命"] > 0 then
				local heal_amount;
				local HN;
				heal_amount = (JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/JY.Person[pid]["血量翻倍"]
                heal_amount = math.modf(heal_amount * 0.1)
				HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.1)
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
				WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				Cls();
				War_Show_Count(WAR.CurID, "金面佛生息恢复");
			end	

            if WAR.Person[p]["精神崩溃"] >=100 and JY.Person[id]["生命"] > 0 then
				Cls();
	            WarDrawMap(0); --不加这条则动画位置无法正常显示
			    CurIDTXDH(WAR.CurID, 78,1,"精神审判",C_ORANGE)
				local aa = 50
				local bb = 25
				local cc = math.random(0,100)
                if cc<= aa then
			       if cc<= bb then
				       CurIDTXDH(WAR.CurID, 28,1,"不可名状:崩坏",M_DarkGreen)
					   QZXS("啊！啊！啊！啊！啊！啊！啊！啊！")
				       QZXS(JY.Person[id]["姓名"].."精神崩溃！")
				       WAR.Person[p]["死亡"] = true
					   WAR.Person[p]["精神崩溃"] = 0
				   else
				   CurIDTXDH(WAR.CurID, 28,1,"不可名状:癫狂",M_DarkGreen)
				   WAR.JSCL[id] = 50
				   WAR.Person[p]["精神崩溃"] = math.modf(WAR.Person[p]["精神崩溃"]/2)				   
				   end
			    else
			    CurIDTXDH(WAR.CurID, 65,1,"美德",C_ORANGE)
			    WAR.Person[p]["精神崩溃"] = 0
			    end
            end

			
			if 	wglw(id,2)>=1  and JY.Person[id]["生命"] > 0 then
				local heal_amount;
				local HN;
				heal_amount = (JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/JY.Person[pid]["血量翻倍"]
                heal_amount = math.modf(heal_amount * 0.1*wglw(id,2))
				HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.1*wglw(id,2))
				if wglw(id,2)>=2 then
				heal_amount = heal_amount + math.modf(HN*0.1*wglw(id,2))
				end
				if YCRW(id) ==2 and YCDJ(id) > 1  then
				heal_amount = heal_amount + math.modf(HN*0.1)
				end
				if WAR.ZBXY == 1 then
				WAR.ZBXY = 0
				heal_amount = heal_amount * 2
				HN= HN* 2
				end
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
				WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				Cls();
				War_Show_Count(WAR.CurID, "逍遥心法回复生命与内力");
			end	
		
	if wglw(id,51)>1  and JY.Person[id]["生命"] > 0 then
                WAR.LSGY[id] = 30
				Cls();
	            WarDrawMap(0); --不加这条则动画位置无法正常显示
			    CurIDTXDH(WAR.CurID, 94,1,"罗刹凭依：残影",C_ORANGE)
	end	

			if 	wglw(id,2)>=1  and JY.Person[id]["生命"] > 0 then
				local heal_amount;
				local HN;
				heal_amount = (JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/JY.Person[pid]["血量翻倍"]
                heal_amount = math.modf(heal_amount * 0.1)
				if YCDJ(id)>0 and YCRW(id) == 2 then
				heal_amount = math.modf(heal_amount * 0.2)
				end
				HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.1)
				if YCDJ(id)>0 and YCRW(id) == 2 then
				HN = HN*2
				end
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
				WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				Cls();
				War_Show_Count(WAR.CurID, "逍遥心法元气恢复");
			end	
		
	        --紫霞神功 每回合回复内力
			if PersonKF(id, 89) then
				local HN;
				local NS;
				NS=JY.Person[id]["受伤程度"]+JY.Person[id]["灼烧程度"]+JY.Person[id]["中毒程度"]+JY.Person[id]["冰封程度"]+(WAR.LXZT[id] or 0) + (WAR.CHZ[id] or 0)+ (WAR.MBZ[id] or 0)
				if Curr_NG(id, 89) then
					HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.2)
				else
					HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*0.1)
				end
				if WAR.LUCK[id]~=nil then
					HN = (JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])
				end
				if WAR.UNLUCK[id]~=nil then
					HN = 0
				end
				if nglw(id, 89)>0 then
					HN = HN+math.modf(HN * 0.05*nglw(id, 96))
					if nglw(id,89)>1 then
					HN = HN+NS*10
					JY.Person[id]["受伤程度"]=0
					JY.Person[id]["灼烧程度"]=0
					JY.Person[id]["中毒程度"]=0
					JY.Person[id]["冰封程度"]=0
					WAR.LXZT[id] = nil
					WAR.CHZ[id] = nil
					WAR.MBZ[id] = nil
				    end
				if nglw(id,89)>2 then
					local HN2=JY.Person[id]["内力最大值"]- JY.Person[id]["内力"]
				   if HN>HN2 then----
				   HN=HN-HN2
				   NS = NS+math.modf(HN*0.1)
				   HN=HN2
				   end
                    WAR.ZXJQ[id] = (WAR.ZXJQ[id] or 0) + math.modf(NS/10)
					if WAR.ZXJQ[id]>=100 then----
					WAR.ZXJQ[id] =100
					end
				War_Show_Count(WAR.CurID, "紫霄剑气回复");
				end
				end
				WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				Cls();
				War_Show_Count(WAR.CurID, "紫霞神功回复内力");
			end
  
			if MPPB_THBH(id)>=1 then
				local HN;
				local NS;
				NS=MPDJ(id)
                HN = math.modf((JY.Person[id]["内力最大值"])*0.05*NS)
				if WAR.LUCK[id]~=nil then
					HN = (JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])
				end
				if WAR.UNLUCK[id]~=nil then
					HN = 0
				end
				WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				Cls();
				War_Show_Count(WAR.CurID, "东临碣石功恢复内力");
				if MPPB_THBH(id)>=2 and JLSD(10,60,id) then
				War_RestMenu()
				end
			end
  
		if WAR.JYWR[id]~= nil and WAR.JYWR[id]>=5 then----
		   local bb =  - WAR.JYWR[pid]
	       WAR.Person[WAR.CurID]["体力点数"] =  AddPersonAttrib(pid,"体力", bb)
	       WAR.Person[WAR.CurID]["生命点数"] =  AddPersonAttrib(pid,"生命", bb*50)
	   		Cls();
		   War_Show_Count(WAR.CurID, "阳气侵袭体力与生命");
	    end
	
			if WAR.LYLZ[id]~=nil then
				local HN;
				local NS;
                if WAR.LYLZ[id]>=4 and WAR.LYLZ[id] <= 6 then
				    local aa= 0.1*((WAR.LYLZ[id]-4)*3+1)
					HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"])*aa)
					WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
				    Cls();
				    War_Show_Count(WAR.CurID, "三阴符回复内力");
					if wglw(id,8) > 2then
					WAR.LYLZ2[id] = math.random(4,6)
					WarDrawMap(0); --不加这条则动画位置无法正常显示
			        CurIDTXDH(WAR.CurID, 94,1,"三阴进阶",C_ORANGE)
					end
				elseif WAR.LYLZ[id]>=1 and WAR.LYLZ[id] <= 3  then
                    NS=(JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])/JY.Person[id]["血量翻倍"]
                     local aa= 0.1*((WAR.LYLZ[id]-1)*3+1)
					HN = math.modf(NS*aa)
					WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", HN);
				    Cls();
				    War_Show_Count(WAR.CurID, "三阳符回复生命");
                    if WAR.LYLZ[id] == 2 then
                    WAR.L_HQNZL[id] = (WAR.L_HQNZL[id] or 0)+30
                    end
					if wglw(id,8) > 2then
					WAR.LYLZ2[id] = math.random(1,3)
					WarDrawMap(0); --不加这条则动画位置无法正常显示
			        CurIDTXDH(WAR.CurID, 94,1,"三阳进阶",C_ORANGE)
					end					
				end
			end
	
	        --混元功每回合回复体力，减少内伤
			if PersonKF(id, 90) then
				local NS;
				NS = 5 + math.modf(JY.Person[id]["受伤程度"]/10)
				if JY.Person[id]["体力"]>=100 and nglw(id,90)>0 then
				local heal_amount;
				heal_amount = math.modf(20*NS)
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
				WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(id, "受伤程度", -NS)	
				--主运回内力
				if Curr_NG(id, 90) then
					WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", 300);
				end
				Cls();
				War_Show_Count(WAR.CurID, "混元一气功回复生命");				
				else
				if WAR.LUCK[id]~=nil then
					NS = JY.Person[id]["受伤程度"]
				end
				if WAR.UNLUCK[id]~=nil then
					NS = 0
				end
				WAR.Person[WAR.CurID]["体力点数"] = AddPersonAttrib(id, "体力", 6);
				WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(id, "受伤程度", -NS)
				--主运回内力
				if Curr_NG(id, 90) then
					WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", 300);
				end
				Cls();
				War_Show_Count(WAR.CurID, "混元功回复体力");
				end
			end

    if MPPB_WD(id) == 2 and WAR.BG[id] ~= nil then	
				local heal_amount = WAR.BG[id] ;
				local HN = 0
                local str = "八卦成型"				
	   if MPZJ(id,2)>=2 then
	      local aa = math.modf((WAR.BG[id] or 0)/20)
		  local bb = math.random(1,4)
		  if bb == 1 then
		     local cc = math.max(0,aa -JY.Person[id]["灼烧程度"]-JY.Person[id]["灼烧程度"])
		     JY.Person[id]["灼烧程度"]=0
			 JY.Person[id]["冰封程度"]=0
			 str = str..".坎离"
			 heal_amount = heal_amount + cc
			 HN = HN+ cc*10
		 elseif bb == 2 then
		     local cc = math.max(0,aa -JY.Person[id]["受伤程度"]-JY.Person[id]["中毒程度"])
		     JY.Person[id]["受伤程度"]=0
			 JY.Person[id]["中毒程度"]=0
			 str = str..".兑艮"
			 heal_amount = heal_amount + cc
			 HN = HN+ cc*10
		 elseif bb == 3 then
		     local cc = math.max(0,aa -(WAR.CHZ[id] or 0)-(WAR.MBZ[id]or 0))
		     WAR.CHZ[id]=nil
			 WAR.MBZ[id]=nil
			 str = str..".巽震"
			heal_amount = heal_amount + cc
			 HN = HN+ cc*10
		 elseif bb == 4 then
		     local cc = math.max(0,aa -(WAR.LXZT[id] or 0)*2)
		     WAR.LXZT[id]=nil
			 str = str..".乾坤"
			 heal_amount = heal_amount + cc
			 HN = HN+ cc*10				 
		  end
		    if MPZJ(id,2)>2 then
			   local HN2 = math.modf(HN/10)
	           WAR.YANGFU[pid] = (WAR.YANGFU[pid] or 0) + HN
		            if WAR.YANGFU[pid]>= 50 then
		               WAR.YANGFU[pid] = 50
		            end 
	           WAR.YINFU[pid] = (WAR.YINFU[pid] or 0) + HN
		            if WAR.YINFU[pid]>= 50 then
		               WAR.YINFU[pid] = 50
		            end 					
	        end
		  end
		 War_Show_Count(WAR.CurID, str)
	      WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
		  WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
	      WAR.BG[id] = nil
	end
	
--犬夜叉
        if wglw(id,80)>2 and WAR.SPIRIT[id]>=120 and JY.Person[id]["武器"]== 49 and WAR.QYC[id] == nil then
		WAR.QYC[id] = 1
		WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 43,1,"归刃.犬夜叉",C_ORANGE)		
		end

        if WAR.SHAH2[id]~=nil then
           WAR.SHAH2[id] = math.modf(WAR.SHAH2[id]*0.9)
        end

        if wglw(id,81)>2 and WAR.SPIRIT[id]>=120 and JY.Person[id]["武器"]== 244 and WAR.DSW[id] == nil then
		WAR.DSW[id] = 1
		WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 54,1,"归刃.馘大蛇",C_ORANGE)		
		end
	
	        --鳄皮护甲 每回合解毒
			if JY.Person[id]["防具"] == 61 and JY.Person[id]["中毒程度"] > 0 then
				local JD = 25 + 10 * (JY.Thing[61]["装备等级"]-1)
				if JY.Person[id]["中毒程度"] < JD then
					JD = JY.Person[id]["中毒程度"]
				end
				WAR.Person[WAR.CurID]["解毒点数"] = -AddPersonAttrib(id, "中毒程度", -JD)
				Cls();
				War_Show_Count(WAR.CurID, "鳄皮护甲生化解毒");
			end
			
			--无酒不欢：等待
			if WAR.Wait[id] == 1 then
				WAR.Wait[id] = 0
				WAR.Person[p].Time = WAR.Person[p].Time + 400
			end
			
			--蛤蟆蓄力
			if WAR.HMGXL[id] == 1 then
				WAR.HMGXL[id] = 0
				WAR.Person[p].Time = WAR.Person[p].Time + 300
			end
	        
			--虚竹福泽加护
	        if match_ID(id, 49) and WAR.XZZ == 1 then
				WAR.XZZ = 0
				WAR.Person[p].Time = WAR.Person[p].Time + 200
	        end
	        
			--张三丰万法自然
	        if match_ID(id, 5) and WAR.ZSF == 1 then
				WAR.Person[p].Time = WAR.Person[p].Time + 500
				WAR.ZSF = 0
	        end
			
			--封不平狂风快剑
			if match_ID(id, 142) and WAR.KFKJ >= 1 then
				WAR.Person[p].Time = WAR.Person[p].Time + 100*wglw(id,162)*WAR.KFKJ
				WAR.KFKJ = 0
			end

			if PersonKF(id,172) then --碧海潮生曲恢复集气
                WAR.Person[p].Time = WAR.Person[p].Time + 150
				if Curr_NG(id,172) then 
                WAR.Person[p].Time = WAR.Person[p].Time + 150
				   for j = 0, WAR.PersonNum - 1 do
		               if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
		               local tid = WAR.Person[j]["人物编号"]
					     WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(tid, "生命", 200);
					     WAR.TXXS[tid] = 1
					     WAR.Person[j]["特效动画"] = 120
		           end
		          end
			    end	
			end	
			
			--九剑真传，荡剑式，回气200
			if WAR.JJDJ == 1 and (id == 0 or D3FQY(id)) then
				WAR.JJDJ = 0
				WAR.Person[p].Time = WAR.Person[p].Time + 200
				if D3FQY(id) then
				WAR.Person[p].Time = WAR.Person[p].Time + 300
				end
			end
			
			--主运飞天回气200
			if Curr_QG(id,145) then
				WAR.Person[p].Time = WAR.Person[p].Time + 200+qglw(id,145)*150
			end
			
			--运轻功
			if WAR.YQG == 1 then
				WAR.Person[p].Time = WAR.Person[p].Time + 500
				WAR.YQG = 0
			end
	       
		   --飞狐王恢复轻功集气
				if match_ID_awakened(id, 1,1) and JY.Person[1]["论剑奖励"] == 1 then
				WAR.Person[p].Time = WAR.Person[p].Time + math.modf(JY.Person[id]["轻功"]*0.75)
				end
	
	        --朱九真，随机得到食材
	        if match_ID(id, 81)  and math.random(100)>60 then
				instruct_2(210, 10)
	        end
	        
			--食神秘籍物品一阶随机获得食材
	        if Curr_WP(id,220)>=1  and math.random(100)>60 then
				instruct_2(210, 10)
	        end			
			
	        --一灯，避免被反死
	        if JY.Person[65]["生命"] <= 0 and WAR.WCY[65] == nil then
				JY.Person[65]["生命"] = 1
	        end
			
	        if JY.Base["畅想"] == 65 and JY.Person[0]["生命"] <= 0 and WAR.WCY[0] == nil then
				JY.Person[0]["生命"] = 1
	        end
			
			--王重阳
			if JY.Person[129]["生命"] <= 0 and WAR.CYZX[129] == nil then
				JY.Person[129]["生命"] = 1
			end
			
	        if JY.Base["畅想"] == 129 and JY.Person[0]["生命"] <= 0 and WAR.CYZX[0] == nil then
				JY.Person[0]["生命"] = 1
	        end
	          
	        --小日本
	        if WAR.ZDDH == 128 then
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["人物编号"] == 553 and JY.Person[553]["生命"] <= 0 then
						WAR.YZB = 1
						WAR.FXDS[553] = nil
						WAR.LXZT[553] = nil
					end
				end
	        end
	          
	        --小日本，复活三次
	        if WAR.YZB == 1 then
				if WAR.YZB2 < 3 then
					WAR.YZB = 0
					WAR.YZB2 = WAR.YZB2 + 1
					say("１Ｒ负けいくざ　だが　オレうちなるとうしが　それをこばむ　これはぶもんのいちか　真田幸村　いざ　まいる", 553,0)
					JY.Person[553]["生命最大值"] = JY.Person[553]["生命最大值"] + 100
					JY.Person[553]["内力最大值"] = JY.Person[553]["内力最大值"] + 1000
					JY.Person[553]["生命"] = JY.Person[553]["生命最大值"]
					JY.Person[553]["内力"] = JY.Person[553]["内力最大值"]
					JY.Person[553]["中毒程度"] = 0
					JY.Person[553]["受伤程度"] = 0
					JY.Person[553]["体力"] = 100
					JY.Person[553]["攻击力"] = JY.Person[553]["攻击力"] + 100
					JY.Person[553]["防御力"] = JY.Person[553]["防御力"] + 100
					JY.Person[553]["轻功"] = JY.Person[553]["轻功"] + 80
					JY.Person[553]["武功1"] = 66
					JY.Person[553]["武功等级1"] = 999
					for j = 0, WAR.PersonNum - 1 do
						if WAR.Person[j]["人物编号"] == 553 then
							WAR.Person[j].Time = 990
						end
					end
				elseif WAR.YZB3 == 1 then
					say("６Ｒもはや　これまでか..........", 553,0)
					say("２（真田幸村－－－－，Ｈ真是让人钦佩的勇士啊！！！）",0,1)
					say("２（真田兄，一六一五年大阪城再会吧！Ｈ那时我的名字是......）",0,1)
					WAR.YZB3 = 1
				end
	        end
	          
	        --主角，其疾如风，集气500
	        if WAR.FLHS1 == 1 then
				if id == 0 then
					WAR.Person[p].Time = WAR.Person[p].Time + 500
				end
				WAR.FLHS1 = 0
	        end
	
		    if WAR.TGDQ1 >0 then
				if id == WAR.TGDQ1 then
					WAR.Person[p].Time = WAR.Person[p].Time + 300
				end
				WAR.TGDQ1 = 0
	        end
	
			if WAR.GTJIQI ~= 0 then --主功体恢复集气
				if id == WAR.GTPID then
					WAR.Person[p].Time = WAR.Person[p].Time + WAR.GTJIQI
					WAR.GTJIQI=0 --主功体恢复集气数值
					WAR.GTPID=-1 --恢复集气数值对象
				end
			end	
	
	        --杨过，行动后集气初始位置额外增加
	        --生命少过二分之一时每少100增加行动后集气位置加100
	        if match_ID(id, 58) and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]/2 then
	        	WAR.Person[p].Time = WAR.Person[p].Time + math.floor(JY.Person[id]["生命最大值"]/2/JY.Person[id]["血量翻倍"] - JY.Person[id]["生命"]/JY.Person[id]["血量翻倍"]);
	        end
	          
			--阎基偷钱
	        if WAR.YJ > 0 then
				instruct_2(174, WAR.YJ)
				WAR.YJ = 0
	        end
			

	        
	        --盲目状态恢复
	        if WAR.KHCM[pid] == 2 then
				WAR.KHCM[pid] = 0
				Cls()
				DrawStrBox(-1, -1, "盲目状态恢复", C_ORANGE, CC.DefaultFont)
				ShowScreen()
				lib.Delay(500)
	        end

			 if WAR.TJXL[pid] ~= nil and WAR.TJXL[pid] >= 1 then
	           WAR.TJXL[pid] = nil
	        end
			
			--宋远桥使用太极拳或太极剑攻击后自动进入防御状态
			if match_ID(id, 171) and WAR.WDRX == 1 then
				War_DefupMenu()
				WAR.WDRX = 0
			end

	        if PersonKF(id, 180) and WAR.TSSX1> 0 then
			   local aa = WAR.TSSX1*10*(nglw(id, 180)+1)
		       addeffect2(WAR.TSSX,id,aa)
			   if WAR.TSSX[id] >= 100 then
			   WAR.TSSX[id] = 100
			   end
			   WAR.TSSX1 = 0
			   	Cls()
				DrawStrBox(-1, -1, "灵蛇玄奥.玄蟒蓄势", C_ORANGE, CC.DefaultFont)
				ShowScreen()
				lib.Delay(500)
	        end
	        
	        if WAR.Actup[id] ~= nil then
				if WAR.ZXXS[id] ~= nil then				--紫霞蓄势状态，蓄力不减
					WAR.ZXXS[id] = WAR.ZXXS[id] - 1
					if WAR.ZXXS[id] == 0 then
						WAR.ZXXS[id] = nil
					end
				else
					WAR.Actup[id] = WAR.Actup[id] - 1	--蓄力，行动一次减1
				end
	        end

	        if WAR.Actup2[id] ~= nil then
               WAR.Actup2[id] = WAR.Actup2[id] - 1
			   if WAR.Actup2[id] == 0 then
					WAR.Actup2[id] = nil
				end
	        end
	        
	        if WAR.Actup[id] == 0 then
				WAR.Actup[id] = nil
	        end
			
			if WAR.SLSX[id] ~= nil then
				WAR.SLSX[id] = WAR.SLSX[id] - 1
				if WAR.SLSX[id] == 0 then
					WAR.SLSX[id] = nil
				end
			end

			if match_ID(pid, 38) then --石破天行动后加战意
				zhanyi(pid, 2, 1)
			end
			
			--行动后漏出破绽
			WAR.Weakspot[id] = 0

			--辟邪冷却时间恢复
			if WAR.BXLQ[id] then
				for i = 1, 6 do
					WAR.BXLQ[id][i] = WAR.BXLQ[id][i] - 1
					if WAR.BXLQ[id][i] < 0 then
						WAR.BXLQ[id][i] = 0
					end
				end
			end
		    
			if WAR.ARLQ[id] then
				for i = 1, 6 do
					WAR.ARLQ[id][i] = WAR.ARLQ[id][i] - 1
					if WAR.ARLQ[id][i] < 0 then
						WAR.ARLQ[id][i] = 0
					end
				end
			end
			
		    if WAR.YHDF[id] ~=nil then --17-2-10-
			WAR.YHDF[id] = nil
			end
			

			
			--乔峰的铁掌名字恢复
	        JY.Wugong[13]["名称"] = "铁掌"
	        
	        --周伯通，每行动一次，攻击时伤害一+10%
	        if match_ID(id, 64) then
				WAR.ZBT = WAR.ZBT + 1
	        end

			if match_ID(id, 450) then
				WAR.ZBT = WAR.ZBT + 1
	        end
			
			--王重阳北斗七闪状态减少
			if match_ID(id, 129) and WAR.CYZX[id] ~= nil and WAR.BDQS > 0 then
				WAR.BDQS = WAR.BDQS - 1
				if WAR.BDQS == 0 then
					CurIDTXDH(WAR.CurID, 126,1,"北斗七闪·收招",C_GOLD);
					addeffect2(WAR.SATA,pid,5)
				end
			end

			if match_ID_awakened(id,65,1) and WAR.WCY[id] ~= nil and WAR.LMZL > 0 then
				WAR.LMZL = WAR.LMZL - 1
				if WAR.LMZL == 0 then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 65,1,"六脉转龙·代谢",C_GOLD);
				end
			end			
	
			
			if match_ID_awakened(id, 103,1) and JY.Person[id]["生命"] > 0 then
			    if WAR.CHD>0  and WAR.JLL[id] ~= nil then
				WAR.CHD = WAR.CHD - 1
				if WAR.CHD == 0 then
					CurIDTXDH(WAR.CurID, 100,1,"琉璃残火·收招",C_GOLD);
					WAR.JLL[id] = nil
				end
				end
				if WAR.LLH>0 then----
				local XK=WAR.LLH
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 124, 1, "琉璃火虹吸固本回元", C_RED);
				War_Show_Count(WAR.CurID)
				WAR.Person[p].Time = WAR.Person[p].Time + WAR.LLH*3
				CurIDTXDH(WAR.CurID, 126, 1, "琉璃回火行动恢复", C_RED);
				WAR.LLH = 0 
				end
			end			

			if wglw(id,18)>1 and JY.Person[id]["生命"] > 0 then
				if WAR.LLH>0 then----
				local XK=WAR.LLH
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19, 1, "元阳调息", C_RED);
				War_Show_Count(WAR.CurID)
				WAR.Person[p].Time = WAR.Person[p].Time + WAR.LLH*3
				CurIDTXDH(WAR.CurID, 126, 1, "元阳回气", C_RED);
				WAR.LLH = 0 
				end
			end				

			if zylw(6)>= 1 and id == 0 and JY.Person[id]["生命"] > 0 then
				if WAR.LLH>0 then----
				local XK=WAR.LLH
				local XK=XK + JY.Person[id]["受伤程度"]+JY.Person[id]["灼烧程度"]+JY.Person[id]["中毒程度"]+JY.Person[id]["冰封程度"]
				JY.Person[id]["受伤程度"] = 0
				JY.Person[id]["灼烧程度"] = 0
				JY.Person[id]["中毒程度"] = 0
				JY.Person[id]["冰封程度"] = 0
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19, 1, "无极元阳", C_RED);
				War_Show_Count(WAR.CurID)
				WAR.Person[p].Time = WAR.Person[p].Time + XK
				if WAR.Person[p].Time >= 1005 then
				WAR.Person[p].Time = 1005
				end
				CurIDTXDH(WAR.CurID, 126, 1, "混沌回气", C_RED);
				WAR.LLH = 0 
				end
			end	

			if MPPB_GB(id) >= 1  and WAR.GBLJ[id]~=nil and JY.Person[id]["生命"] > 0 then
			    local aa = WAR.GBLJ[id]
				local XK = aa*50*(MPDJ(id))
				local XK2 = XK * 5
				if MPPB_GB(id) == 2 or MPPB_GB(id) == 3 then
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WAR.Person[WAR.CurID]["内力点数"]=AddPersonAttrib(id, "内力", XK2);				
				end
				if MPPB_GB(id) == 1 or MPPB_GB(id) == 3 then
				WAR.Person[p].Time = WAR.Person[p].Time + XK2
				end
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19, 1, "收招调息", C_RED);
				War_Show_Count(WAR.CurID)
				WAR.GBLJ[id] = nil
			end			

			if nglw(id,107)>2   then
			    local XK2 = math.modf(JY.Person[id]["内力最大值"]*0.15)
				local XK = math.modf(XK2/3)
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WAR.Person[WAR.CurID]["内力点数"]=AddPersonAttrib(id, "内力", XK2);	
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19, 1, "天之道.损有余而补不足", C_RED);
				War_Show_Count(WAR.CurID)
			  if WAR.JYZQ[id] == nil then 
			     WAR.JYZQ[id] = math.modf(JY.Person[id]["内力"]/1000) 
			  else 	 
                 WAR.JYZQ[id] = WAR.JYZQ[id] + math.modf(JY.Person[id]["内力"]/1000) 
			  end
              if WAR.JYZQ[id] >= 5*nglw(id,107) then 
                 WAR.JYZQ[id] = 5nglw(id,107)
			  end
			end	

			if nglw(id,104)>2   then
			   local XK2 = 0
			   for j = 0, WAR.PersonNum - 1 do
		           if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
		           local tid = WAR.Person[j]["人物编号"]
		           local aa=math.modf(JY.Person[tid]["内力"]/20)
					   WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) + AddPersonAttrib(tid, "内力", -aa);
					   XK2 = XK2 + aa
		           end
		       end	    
				local XK = math.modf(XK2/3)
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WAR.Person[WAR.CurID]["内力点数"]=AddPersonAttrib(id, "内力", XK2);	
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19, 1, "地之理.损不足而补有余", C_RED);
				War_Show_Count(WAR.CurID)
			  if WAR.NYZQ[id] == nil then 
			     WAR.NYZQ[id] = math.modf(JY.Person[id]["内力"]/1000) 
			  else 	 
                 WAR.NYZQ[id] = WAR.NYZQ[id] + math.modf(JY.Person[id]["内力"]/1000) 
			  end
              if WAR.NYZQ[id] >= 5*nglw(id,107) then 
                 WAR.NYZQ[id] = 5*nglw(id,107)
			  end
			end	

			if zylw(3)>2 and id == 0 and WAR.JSYX1 == 1 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			   CurIDTXDH(WAR.CurID, 10, 1, "【剑神一笑.回鞘剑意发】", M_SandyBrown);
                WAR.Person[p].Time = WAR.Person[p].Time + 300
			   War_ActupMenu()
               WAR.JSYX1 = 0			   
		    end
			
			if wglw(id,67)>2 then
				if WAR.LLH>0 then----
				local XK=WAR.LLH
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 19, 1, "丹羽养身", C_RED);
				War_Show_Count(WAR.CurID)
				WAR.Person[p].Time = WAR.Person[p].Time + WAR.LLH
				CurIDTXDH(WAR.CurID, 126, 1, "鹤鸣回气", C_RED);
				WAR.LLH = 0 
				end
			end	


			
			if wglw(id,22)>1 then
				if WAR.JGZB1>0 then----
				local XK=math.modf(WAR.JGZB1 * 0.5)
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 126, 1, "金刚奔烈.刚掌斗气", C_RED);
				War_Show_Count(WAR.CurID)
				WAR.Person[p].Time = WAR.Person[p].Time + WAR.JGZB1
				WAR.JGZB1 = 0 
				end
			end	

  	 if nglw(id,144)>2  and  (JLSD(15, 65, id) or (JY.Person[id]["生命"] <= (JY.Person[id]["生命最大值"]*0.3) and JLSD(20,70,id)))  and MPPB_SL(pid) == 3 then--沼跃鱼：鸠摩智残火刀终式大招
         WarDrawMap(0); --不加这条则动画位置无法正常显示
		 CurIDTXDH(WAR.CurID, 33, 1, "护持金刚.御", C_RED);
         WAR.BHJS[id]=30
     end

			if nglw(id,106) >1 and JLSD(0,30+nglw(id,106)*10,id) and	(nglw(id,106) >2 and WAR.Actup[id] == nil)		then --17-2-10
		      if WAR.JYHT[id] == nil then 
			     WAR.JYHT[id] = 1 
			  else 	 
                 WAR.JYHT[id] = WAR.JYHT[id] + 1 
			  end
              if WAR.JYHT[id] >= 5*nglw(id,106) then 
                 WAR.JYHT[id] = 5*nglw(id,106)
			  end
			  WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 120, 1, "九阳护体神罡", M_DarkGreen);
			end
  
			if (nglw(id,107) >1) and JLSD(0,30,id) then --17-2-10
		      if WAR.JYZQ[id] == nil then 
			     WAR.JYZQ[id] = 1 
			  else 	 
                 WAR.JYZQ[id] = WAR.JYZQ[id] + 1 
			  end
              if WAR.JYZQ[id] >= 5*nglw(id,107) then 
                 WAR.JYZQ[id] = 5nglw(id,107)
			  end
			end
			if (nglw(id,104) >1) and JLSD(0,30,id) then --17-2-10
		      if WAR.NYZQ[id] == nil then 
			     WAR.NYZQ[id] = 1 
			  else 	 
                 WAR.NYZQ[id] = WAR.NYZQ[id] + 1 
			  end
              if WAR.NYZQ[id] >= 5*nglw(id,104) then 
                 WAR.NYZQ[id] = 5*nglw(id,104)
			  end
			end
				if (nglw(id,100) >1) and JLSD(0,30,id) then --17-2-10
		      if WAR.XTGQ[id] == nil then 
			     WAR.XTGQ[id] = 1 
			  else 	 
                 WAR.XTGQ[id] = WAR.XTGQ[id] + 1 
			  end
              if WAR.XTGQ[id] >= 5*nglw(id,100) then 
                 WAR.XTGQ[id] = 5*nglw(id,100)
			  end
			end
			
			if (wglw(id,5) >1) and JLSD(0,10+10*wglw(id,5),id) then --17-2-10
		      if WAR.BSFW[id] == nil then 
			     WAR.BSFW[id] = 1 
			  else 	 
                 WAR.BSFW[id] = WAR.BSFW[id] + 1 
			  end
              if WAR.BSFW[id] >= 5*wglw(id,5) then 
                 WAR.BSFW[id] = 5*wglw(id,5)
			  end
			end
	
			if match_ID_awakened(id, 47,1) then
	            if WAR.AZ > 0 then
		        local XK = nil
				local NK = nil
				local NS = nil
	            XK = math.modf(WAR.AZ/10)
				NK = math.modf(WAR.AZ/1.5)
				NS = math.modf(WAR.AZ/40)
		        AddPersonAttrib(pid, "生命", XK);
		        AddPersonAttrib(pid, "内力", NK);
		        AddPersonAttrib(pid, "受伤程度", -NS);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 120, 1, "紧那罗苦痛汲取", M_DarkGreen);
				WAR.AZ=0
	            else
		        WAR.AZ=100 
	            end
			end

			if match_ID_awakened(id, 53,1) then
			  if WAR.LMJQ1[id] ~= nil then
              local lqz=WAR.LMJQ1[id]
	          local XK = 5 * lqz
			  local NS = 5 + math.modf(JY.Person[id]["受伤程度"]/10)
				AddPersonAttrib(id, "生命", XK);
				AddPersonAttrib(id, "受伤程度", -NS);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 53, 1, "龙气化生.调理", M_DarkRed);
			  end
			end

           if wglw(id,4)>1 and WAR.LQZS>0 then
		      local aa = 0
		      if WAR.LQZS> 4 and wglw(id,4)>2 then
			     aa=1
			  elseif WAR.LQZS< 3 then
			     aa=1		  
			  end
			  if aa==1 then
			  WAR.MQJG[pid] = WAR.LQZS
			  WarDrawMap(0); --不加这条则动画位置无法正常显示
			  CurIDTXDH(WAR.CurID, 36, 1, "南斗六圣.猛禽架构", M_DarkRed);
			  end		
              WAR.LQZS = 0			  
		   end


           	if WAR.LMJQ2[id] ~= nil then
              local lqz=WAR.LMJQ2[id]
	          local XK = 5 * lqz
				AddPersonAttrib(id, "生命", -XK);
				AddPersonAttrib(id, "内力", -XK*5);
				if lqz>=50 then
				WAR.XRZT[id] = 20
				end
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 60, 1, "剑气化形.破体", M_Blue);
				WAR.LMJQ2[id] = math.modf(WAR.LMJQ2[id]/2)
			  end

           	if WAR.BSYJ[id] ~= nil then
 		       for j = 0, WAR.PersonNum - 1 do
		           if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
		           local tid = WAR.Person[j]["人物编号"]
                    JY.Person[tid]["冰封程度"] = limitX((JY.Person[tid]["冰封程度"] or 0) + 20, 0, 100)
                    if JY.Person[tid]["冰封程度"]>= 50 then
                    WAR.LRHF[tid] = limitX((WAR.LRHF[tid] or 0) + 10, 0, 50)
                    end					
					   WAR.TXXS[tid] = 1
					   WAR.Person[j]["特效动画"] = 120
		           end
		       end
			  end

           	if WAR.TLQJ[id] ~= nil then
              local lqz=WAR.TLQJ[id]
	          local XK = lqz
				AddPersonAttrib(id, "生命", -XK);
				if lqz>=500 then
				WAR.XRZT[id] = 20
				end
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 60, 1, "天龙气劲.爆裂", M_Blue);
				WAR.TLQJ[id] = nil
			  end
			  
			if WAR.YZSG[id]~=nil and WAR.YZSY[id]~=nil  then
               local aa= JY.Person[id]["中毒程度"]*3
				AddPersonAttrib(id, "生命", -aa);
				if aa>=150 then
				WAR.JHLY2[id] = 20
				end
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 72, 1, "阳亢.爆肝", M_Blue);
            end			
			  
			  
			if nglw(id,178)>=1 and Curr_NG(id,178) then
               WAR.BDKY[id] = (WAR.BDKY[id] or 0) + nglw(id,178)
			   if  WAR.BDKY[id]>=5*nglw(id,178) then
			       WAR.BDKY[id] = 5*nglw(id,178)
			   end
			   	WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 60, 1, "波动刻印.生成", M_Blue);
			end	

			if wglw(id,1)>=1  then
               WAR.NQHR[id] = (WAR.NQHR[id] or 0) + wglw(id,1)
			   if  WAR.NQHR[id]>=5*wglw(id,1) then
			       WAR.NQHR[id] = 5*wglw(id,1)
			   end
			   	WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 68, 1, "念气珠.生成", M_Blue);
			end				
			  
          	if WAR.TLQJ2[id] ~= nil then
              local lqz=WAR.TLQJ2[id]
	          local XK = lqz
				AddPersonAttrib(id, "生命", -XK);
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 17, 1, "星爆气流.迸发", C_RED);
				WAR.TLQJ2[id] = nil
			  end
	
			if wglw(id,58)>1 and WAR.XLD[id] ~= nil and WAR.XLEB > 0 then
				WAR.XLEB= WAR.XLEB - 1
				if WAR.XLEB == 0 then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 179,1,"阿鼻.回刀",C_GOLD);
					WAR.XLD[id] = nil
				end
			end	

			if wglw(id,52)>1 and WAR.PYZ1 > 0 then
			local cc=math.modf(JY.Person[id]["实战"]/50)
                WAR.Person[p].Time = WAR.Person[p].Time + WAR.PYZ1*cc
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 116,1,"煞气恢复集气",C_GOLD);
			end				
            
			----太玄幸运
			if nglw(id,102)>1 and JLSD(10,50,id) then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
               CurIDTXDH(WAR.CurID, 96,1,"太玄天命.皇极经世",C_GOLD)
			   WAR.LUCK[id]=(WAR.LUCK[id] or 0) + 50
			end		

 		    if MPPB_MJAS(id) >= 1  then --沼跃鱼:明教焚影圣诀气息遮断
			   local aa=MPPB_MJAS(id)
                    if JLSD(10, 40+MPDJ(id)*(5+aa), id) then
					WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 126,1,"焚影秘传.气息遮断",C_GOLD)
					WAR.HIDE[id] = 10*(MPDJ(pid)+1)
				end
	        end
			
			--暴怒恢复
	        if WAR.LQZ[id] == 100 then
				--王重阳北斗七闪状态行动后暴怒不减
				if (match_ID(id, 129) and WAR.CYZX[id] ~= nil and WAR.BDQS > 0)  then
				
				elseif (match_ID_awakened(id, 65,1) and WAR.WCY[id] ~= nil and WAR.LMZL > 0)  then
				
				elseif wglw(id,58)>2 then
				
				elseif match_ID_awakened(id,50,1) then--乔峰
				
				elseif MPPD(id) == 4 and WAR.XUEMO[id] ~= nil then
				
				elseif nglw(id,180)>=1 and JLSD(10, 40+nglw(id,180)*5, id) then
				    WAR.LQZ[id] = 50
				else
					WAR.LQZ[id] = 0
				end
	        end

  	 
  
      	 if wglw(id,40)>1 and WAR.LMC == 1 and PersonKFJ(pid,40) and War_isEnd() ==  0 then --金蛇领悟后追加攻击一
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 123,1,"金蛇戏画.牙突",M_SeaGreen);
	local tmpanqi = JY.Person[id]["暗器技巧"]
	   if WAR.JSBD[id]~=nil then
	   		if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.JSBD[id][1], WAR.JSBD[id][2], 4, 30)
			else
			    WAR.JSBD[id] = nil
				War_ExecuteMenu(4, 30)
			end 
       WAR.JSBD[id] = nil
	   end
	local x1=nil
	local y1=nil
	if WAR.YTJS[pid]~=nil then
	x1=WAR.YTJS[pid][1]
	y1=WAR.YTJS[pid][2]
	end
	if x1==nil or y1==nil then
	x1=WAR.Person[WAR.CurID]["坐标X"]
	y1=WAR.Person[WAR.CurID]["坐标Y"]
	end
	    for i = 1, 30 do
			DrawStrBox(-1, 24, "散魄毒牙", OliveDrab, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
						CleanWarMap(4, 0)
						for i = 0, WAR.PersonNum - 1 do
							if WAR.Person[i]["人物编号"] ~= WAR.Person[WAR.CurID]["人物编号"] and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and 
								WAR.Person[i]["死亡"] == false and RealJL2(x1,y1, i, 5) then
								SetWarMap(WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"], 4, 2)
								JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"]=(JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"] or 0)+ math.modf(JY.Person[pid]["实战"] / 10) + math.modf(tmpanqi/100)
								WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"],"生命", -(math.modf(JY.Person[WAR.Person[i]["人物编号"]]["中毒程度"]*0.25)+math.modf(JY.Person[pid]["实战"] / 10) + math.modf(tmpanqi/100)))
								AddPersonAttrib(WAR.Person[i]["人物编号"],"中毒程度", math.modf(JY.Person[pid]["实战"] / 10) + math.modf(tmpanqi/100))
								WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
							end
						end		
						War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 30)
                        JY.Person[id]["生命"]=JY.Person[id]["生命"]+math.modf(tmpanqi/5)						
				WAR.LMC = 0
				JY.Person[id]["暗器技巧"]=tmpanqi+5
				if JY.Person[id]["暗器技巧"]>= 999 then----
				JY.Person[id]["暗器技巧"]=999
				end
				
				
      end

	if match_ID_awakened(id,55,1) and WAR.LMC == 1 and WAR.SDYG>0 and War_isEnd() ==  0 then --翔龙箭
	WarDrawMap(0); --不加这条则动画位置无法正常显示
	   CurIDTXDH(WAR.CurID, 162,1,"一马奔腾.射雕引弓",M_SeaGreen)
	   if WAR.GSWS3[id]~=nil then
	   		if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.GSWS3[id][1], WAR.GSWS3[id][2], 4, 299)
			else
			    WAR.GSWS3[id] = nil
				War_ExecuteMenu(4, 299)
			end 
       WAR.GSWS3 = {}
	   end
	   zssdz(pid)
	   	for i = 1, 30 do
			DrawStrBox(-1, 24, "射雕.翔龙箭", OliveDrab, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end
	   local x1=nil
	   local y1=nil
	   if WAR.YTJS[pid]~=nil then
	      x1=WAR.YTJS[pid][1]
	      y1=WAR.YTJS[pid][2]
	   end
	   if x1==nil or y1==nil then
	      x1=WAR.Person[WAR.CurID]["坐标X"]
	      y1=WAR.Person[WAR.CurID]["坐标Y"]
	   end
	   						CleanWarMap(4, 0)
						for i = 0, WAR.PersonNum - 1 do
							if WAR.Person[i]["人物编号"] ~= WAR.Person[WAR.CurID]["人物编号"] and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
								WAR.Person[i]["死亡"] == false and RealJL2(x1,y1, i, 5) then
								SetWarMap(WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"], 4, 2)
								local aa= math.modf(JY.Person[WAR.Person[i]["人物编号"]]["内力最大值"]/2)+WAR.SDYG*10
								WAR.Person[i]["内力点数"] = (WAR.Person[i]["内力点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"],"内力", -aa);
								WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"],"生命", -math.modf(aa*0.15))
								AddPersonAttrib(WAR.Person[i]["人物编号"],"受伤程度", math.modf(aa / 10))
								WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
							end
						end	
	   War_ShowFight(pid, 0, 0, 0, WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"], 111)
	   
	   WAR.LMC = 0
	end	  

	if match_ID_awakened(id,11,1) and WAR.LMC == 1 and War_isEnd() ==  0 then --金蛇领悟后追加攻击一
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 73,1,"秘技.超轨飞石炮",M_SeaGreen);
	local tmpanqi = JY.Person[id]["暗器技巧"]
	   if WAR.JSBD[id]~=nil then
	   		if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
				War_ExecuteMenu_Sub(WAR.JSBD[id][1], WAR.JSBD[id][2], 4, 28)
			else
			    WAR.JSBD[id] = nil
				War_ExecuteMenu(4, 28)
			end 
       WAR.JSBD[id] = nil
	   end
	local x1=nil
	local y1=nil
	if WAR.YTJS[pid]~=nil then
	x1=WAR.YTJS[pid][1]
	y1=WAR.YTJS[pid][2]
	end
	if x1==nil or y1==nil then
	x1=WAR.Person[WAR.CurID]["坐标X"]
	y1=WAR.Person[WAR.CurID]["坐标Y"]
	end
	    for i = 1, 30 do
			DrawStrBox(-1, 24, "超轨飞石炮", OliveDrab, 10 + i)
			ShowScreen()
			lib.Delay(10)
		end					
				WAR.LMC = 0
				JY.Person[id]["暗器技巧"]=tmpanqi+5
				if JY.Person[id]["暗器技巧"]>= 999 then----
				JY.Person[id]["暗器技巧"]=999
				end
				
				
      end

	if wglw(pid,54)>1 and WAR.HZD[1] ~= nil and War_isEnd() ==  0 then --何足道			
				local wgmenu = {}
				for i = 1, CC.Kungfunum do
					local tmp = JY.Person[pid]["武功" .. i]
					if tmp > 0 and skill_usable(pid, tmp)	and JY.Wugong[tmp]["攻击力10"] > 0 and JY.Wugong[tmp]["武功类型"] == 4 then
						wgmenu[#wgmenu + 1] = {i, tmp}
					end
				end
				if #wgmenu ~= 0 then
					local tmp = wgmenu[math.random(#wgmenu)]
					WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 64, 1, "无定连环·"..JY.Wugong[tmp[2]]["名称"], M_Red)
					WAR.WDLH = 1
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, tmp[1], WAR.HZD[1], WAR.HZD[2])
					else
						War_Fight_Sub(WAR.CurID, tmp[1])
					end
                    WAR.WDLH = 0					
				end
				WAR.HZD = {}
			end		

	if nglw(pid,92)>1 and WAR.SZH1[1] ~= nil and War_isEnd() ==  0 then --兽皇光速拳			
        WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 58, 1, "狮心·兽皇光速拳", M_Red)
					WAR.SZH2 = 1
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, WAR.SZH1[3], WAR.SZH1[1], WAR.SZH1[2])
					else
						War_Fight_Sub(WAR.CurID, WAR.SZH1[3])
					end
                    WAR.SZH2 = 0
		WAR.SZH1 = {}
	end	


	if wglw(pid,129)>1 and WAR.HZD1[1] ~= nil and War_isEnd() ==  0 then --旋风扫叶连环腿
				local wgmenu = {}
				for i = 1, CC.Kungfunum do
					local tmp = JY.Person[pid]["武功" .. i]
					if tmp == 129 and skill_usable(pid, tmp)	and JY.Wugong[tmp]["攻击力10"] > 0 then
						wgmenu[#wgmenu + 1] = {i, tmp}
					end
				end
				if #wgmenu ~= 0 then
					local tmp = wgmenu[math.random(#wgmenu)]
					WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 64, 1, "木叶烈风·"..JY.Wugong[tmp[2]]["名称"], M_Red)
					WAR.WDLH1 = 1
		            WAR.WDLH2 = math.random(3)
		            local str = ""
		            if  WAR.WDLH2 == 1 then
			            str = "烈风.无影腿"
		            elseif WAR.WDLH2 == 2 then
		                str = "飓风·迅影腿"
		            elseif WAR.WDLH2 == 3 then
		                str = "狂风·升天腿"
		             end 	    
                    Set_Eff_Text(id,"特效文字0",str)					
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, tmp[1], WAR.HZD1[1], WAR.HZD1[2])
					else
						War_Fight_Sub(WAR.CurID, tmp[1])
					end
                    WAR.WDLH1 = 0	
                    WAR.WDLH2 = 0					
				end
				if  JLSD(10,60,pid) and wglw(pid,129)>2 then
				    CurIDTXDH(WAR.CurID, 45, 1,"鸳鸯连环腿发动", M_Red)
				else
				WAR.HZD1 = {}
				end
	end	

	if match_ID_awakened(pid,517,1) and WAR.HZD3[1] ~= nil and War_isEnd() ==  0 then --秘剑细雪
				local wgmenu = {}
				for i = 1, CC.Kungfunum do
					local tmp = JY.Person[pid]["武功" .. i]
					if tmp == 151 and skill_usable(pid, tmp)	and JY.Wugong[tmp]["攻击力10"] > 0 then
						wgmenu[#wgmenu + 1] = {i, tmp}
					end
				end
				if #wgmenu ~= 0 then
					local tmp = wgmenu[math.random(#wgmenu)]
					WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 64, 1, "严流奥义·雪舞", M_Red)
					WAR.BFTX = 1
					if match_ID_awakened(pid,517,1) and JY.Person[517]["论剑奖励"] == 1  then
					local aa = math.random(1,3)
					local tt = {"·胧刀","·梦霞","·细雪"}
					WAR.BFTX = WAR.BFTX +aa
					CurIDTXDH(WAR.CurID, 66, 1, "秘剑"..tt[aa], M_Red)
					end
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, tmp[1], WAR.HZD3[1], WAR.HZD3[2])
					else
						War_Fight_Sub(WAR.CurID, tmp[1])
					end
                    WAR.BFTX = 0					
				end
				WAR.HZD3 = {}
			
	end	
			
   if match_ID_awakened(id,4,1) and (math.random(10)<6 or JY.Person[4]["论剑奖励"] == 1) then --沼跃鱼：阎基千金
	   local XK = nil
		local NK = nil
		local NS = nil
		local NT = nil
	    local mpdj=JY.Person[id]["医疗能力"]/2000
	    XK = math.modf(1000 * mpdj)
	    NK = XK*3
		NS = 5 + math.modf(JY.Person[pid]["受伤程度"]/10)
		NT = NS*2
	    WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", XK);
		WAR.Person[WAR.CurID]["内力点数"]=AddPersonAttrib(id, "内力", NK);
		WAR.Person[WAR.CurID]["体力点数"]=AddPersonAttrib(id, "体力", NT)
	    AddPersonAttrib(id, "受伤程度", -NS);
		CurIDTXDH(WAR.CurID, 21, 1, "千金药方.华佗养身", M_SeaGreen);
	 end
			
			--刀主大招，行动后恢复怒气
		if ((id == 0 and JY.Base["标准"] == 4) or wglw(id,58)>=1 or wglw(id,74)>1 ) and WAR.YZHYZ > 0 and BXZT(id) == 0 then
				WAR.LQZ[id] = limitX((WAR.LQZ[id] or 0) + WAR.YZHYZ, 0, 100)
				WAR.YZHYZ = 0
				if zylw(id)>2 then--
				local  aa = WAR.YZHYZ*3
				WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", aa)
				end
				if WAR.LQZ[id] ~= nil and WAR.LQZ[id] == 100 then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
				end
			if WAR.HOT[id]~=nil and WAR.HOT[id]>0 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 60, 1, "怒火攻心")
			WAR.Person[WAR.CurID]["内伤点数"]=AddPersonAttrib(id, "受伤程度", 100)
			WAR.Person[WAR.CurID]["生命点数"]=AddPersonAttrib(id, "生命", -100)
			WAR.LQZ[id] = nil
			end
			if wglw(id,58)>1 and WAR.XLEB==0 and WAR.XLD[id] == nil then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 63, 1, "雄霸天下.阿鼻三刀")
            WAR.XLEB = 3
			WAR.XLD[id]=1
			WAR.BDKY[id] = (WAR.BDKY[id] or 0) + 5
			   if YCRW(pid) == 2 and YCDJ(pid)>2 then
			   WAR.ZBX[id] = (WAR.ZBX[id] or 0) + 2
			   CurIDTXDH(WAR.CurID, 61, 1, "修罗.自在醉意")
			   end
			end
			if match_ID_awakened(id,103,1) and WAR.CHD==0 and WAR.JLL[id] == nil then
            WAR.CHD = 4
			WAR.JLL[id]=1
			WarDrawMap(0); --不加这条则动画位置无法正常显示
            CurIDTXDH(WAR.CurID, 78, 1, "明王残火刀")
			end
			
			if wglw(id,74)>1 and WAR.SHJG[id] ~= nil and WAR.SHJG[id] == 1 then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 65, 1, "咏春蛇形.化龙")
            WAR.SHJG[id] = 3
			end
			
			if Curr_NG(id,175) then
			    local HN;
				local NS;
				HN=JY.Person[id]["受伤程度"]+JY.Person[id]["灼烧程度"]+JY.Person[id]["中毒程度"]+JY.Person[id]["冰封程度"]+(WAR.LXZT[id] or 0) + (WAR.CHZ[id] or 0)+ (WAR.MBZ[id] or 0)
				WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", HN);
					JY.Person[id]["受伤程度"]=0
					JY.Person[id]["灼烧程度"]=0
					JY.Person[id]["中毒程度"]=0
					JY.Person[id]["冰封程度"]=0
					WAR.LXZT[id] = nil
					WAR.CHZ[id] = nil
					WAR.MBZ[id] = nil
			end
			
		end

	
			if (id==0 and JY.Person[49]["论剑奖励"] == 1) or MPPB_SL(id) == 1 then
				if JLSD(10, 30, id) or (JLSD(10, 50, id) and MPPB_SL(id) == 1 ) then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 78, 1, "少林绝学·金钟罩防御")
					War_DefupMenu()
				end
			end	
	        
			if Curr_JL(id,5) then
				WarDrawMap(0); --不加这条则动画位置无法正常显示
				CurIDTXDH(WAR.CurID, 71, 1, "千金要诀·自疗")
                War_AutoDoctor()
			end
	
			if WAR.GTPID4 == pid and WAR.XLZS_QL >0 then
			   War_DefupMenu()
			   if WAR.XLZS_QL>1 then
			   War_ActupMenu()
			   end
			   WAR.GTPID4 = -1
			end

			if T7DFWM(id) then --东方未明剑系特技恢复集气
				if WAR.DFWMJIQI == 1 then
					WAR.Person[p].Time = WAR.Person[p].Time + 250
					WAR.DFWMJIQI = 0
				end
			end					


			
	        if id == 0 and  JY.Base["标准"] >0 and JY.Base["天书数量"]>=4 and  WAR.XKZ>0 then 	        
			local aa=50*WAR.XKZ
			local bb= 0
			if JY.Person[0]["资质"]<80 and JY.Person[0]["资质"]>31 then
			aa=100*(WAR.XKZ+2)
			end
			if JY.Base["标准"] == 5 then
            aa=aa*2
            end
			WAR.Person[p].Time = WAR.Person[p].Time + aa
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			
		    CurIDTXDH(WAR.CurID, 25, 1, "虚空藏恢复"..aa.."点集气", M_SeaGreen)
			if JY.Base["标准"] == 5 then
			local bb=100*WAR.XKZ
			if JY.Person[0]["资质"]<80 and JY.Person[0]["资质"]>31 then
			bb=150*(WAR.XKZ+2)
			end
			AddPersonAttrib(0, "内力", bb)
			if  zylw(5)>1 then--
			    aa=aa/2
			    AddPersonAttrib(0, "生命", aa)
				CurIDTXDH(WAR.CurID, 38, 1, "虚空藏提升"..aa.."点生命", M_Pink)
			if WAR.XKZ>7  then--
			   WAR.JYS = math.modf((WAR.XKZ - 6)/2)+WAR.XKZ
                 if WAR.JYS > 3then--
                 WAR.JYS = 3
                 end				 
                CurIDTXDH(WAR.CurID, 61, 1, "真虚空藏.八步赶蝉", M_Pink)			   
			end
			           
			end
  CurIDTXDH(WAR.CurID, 40, 1, "虚空藏提升"..bb.."点内力", M_Blue)
            end			
            WAR.XKZ=0			
            end--12.27改	

	        if match_ID_awakened(id,151,1) and  WAR.XKZ>0 then 	        
			local aa=100*WAR.XKZ
			local bb=200*WAR.XKZ
			WAR.Person[p].Time = WAR.Person[p].Time + aa
			WarDrawMap(0); --不加这条则动画位置无法正常显示
		    CurIDTXDH(WAR.CurID, 39, 1, "奔雷步恢复"..aa.."点集气", M_SeaGreen)
			WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(id, "内力", bb)
            CurIDTXDH(WAR.CurID, 74, 1, "奔雷步提升"..bb.."点内力", M_Blue)		
            WAR.XKZ=0			
            end--12.27改			

			if wglw(id, 4)>2  and WAR.LQZS_HQ == 1 then
			WAR.Person[p].Time = WAR.Person[p].Time + 500
			WarDrawMap(0); --不加这条则动画位置无法正常显示
		    CurIDTXDH(WAR.CurID, 39, 1, "烈孔空牙恢复集气", PinkRed)
			WAR.LQZS_HQ = 0
			end			
			
			
	        if wglw(id,23)>2 and  WAR.YZHF>0 then 	        
			   local aa=25*WAR.YZHF
			   if aa>=800 then
			   aa=800
			   end
			   local bb=75*WAR.YZHF
			   WarDrawMap(0); --不加这条则动画位置无法正常显示
			   CurIDTXDH(WAR.CurID, 69, 1, "妊心神固元回本", M_SeaGreen)
			   WAR.Person[p].Time = WAR.Person[p].Time + aa
			   WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(id, "内力", bb)		
               WAR.YZHF=0			
            end--12.27改			
			
			
  if WAR.BYCX[pid]~=nil then
      if WAR.XKZ>=1 then
	  	 if WAR.XKZ>=8 then
		 WAR.XKZ=8
		 WAR.QBLY[pid] = 30
		 end
	  local aa=math.modf(JY.Person[id]["受伤程度"]*0.85*WAR.XKZ)
	  local bb=math.modf(aa*1.1 * WAR.XKZ)
	  WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -bb)
	  WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -aa)
	  WarDrawMap(0); --不加这条则动画位置无法正常显示
      CurIDTXDH(WAR.CurID, 88, 1, "玉箫魔音.八音穿心", M_SeaGreen)
	  end  
  end



            if WAR.GSWS1[1] ~= nil  and   match_ID_awakened(pid,69,1) and War_isEnd() ==  0 then --丐世无双		
				for i = 1, CC.Kungfunum do
					if JY.Person[pid]["武功" .. i] == 80 then
					CurIDTXDH(WAR.CurID, 69, 1, "真神丐无双·".."龙纹打狗棒", M_SeaGreen)
					WAR.HQGS=1
					WAR.HQGSTS=1
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, i, WAR.GSWS1[1], WAR.GSWS1[2])
					else
						War_Fight_Sub(WAR.CurID, i)
					end
                    WAR.HQGS=0
                    WAR.HQGSTS=0					
                    end					
				end
				WAR.GSWS1 = {}
			end	
			
			if WAR.GSWS2[1] ~= nil  and   match_ID_awakened(pid,69,1) and War_isEnd() ==  0 then --丐世无双		
				for i = 1, CC.Kungfunum do
					if JY.Person[pid]["武功" .. i] == 26 then
					CurIDTXDH(WAR.CurID, 75, 1, "真神丐无双·".."贪狼降龙掌", M_Gray)
					WAR.HQGS2=1
					WAR.HQGSTS2=1
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, i, WAR.GSWS2[1], WAR.GSWS2[2])
					else
						War_Fight_Sub(WAR.CurID, i)
					end	
					WAR.HQGS2=0
					WAR.HQGSTS2=0
                    end					
				end
				WAR.GSWS2 = {}
			end	

if WAR.HZD2[1] ~= nil and War_isEnd() ==  0 then
			local qljj2 = {"连城终剑·耳光剑势",
			"连城终剑·去刃剑势",
			"连城终剑·刺肩剑势",
			"连城终剑·轰雷剑势",
			"连城终剑·大寒无雪"}
		    local txdh = {61,67,54,75,116}
			local color = {M_DeepSkyBlue,M_YellowGreen,M_Yellow,M_Red,M_Blue}
		WAR.JX_QLJJ2 = math.random(1,4)
		WAR.JX_QLJJ = math.random(1,5)
		if match_ID_awakened(pid,589,1) and JY.Person[589]["论剑奖励"] == 2  then
		WAR.JX_QLJJ =  1
		WAR.JX_QLJJ2 = 5
		end
        local c={(WAR.LCJY1[pid] or 0),(WAR.LCJY2[pid] or 0),(WAR.LCJY3[pid] or 0),(WAR.LCJY4[pid] or 0),(WAR.LCJY5[pid] or 0)}
		WAR.LCJY1[pid] = nil
		WAR.LCJY2[pid] = nil
		WAR.LCJY3[pid] = nil
		WAR.LCJY4[pid] = nil
		WAR.LCJY5[pid] = nil
		WAR.JX_QLJJ3 = c[WAR.JX_QLJJ]
		if WAR.JX_QLJJ3 < 2 then
		WAR.JX_QLJJ3 = 2
		end
		Cls()
		NEWTXWZ(qljj2[WAR.JX_QLJJ2],color[WAR.JX_QLJJ2])       
		if WAR.JX_QLJJ2 == 4 then
		WAR.BJ = 1
		WAR.JX_QLJJ3 =WAR.JX_QLJJ3 *2
		end		
				for i = 1, CC.Kungfunum do
					if JY.Person[pid]["武功" .. i] == 114 then
					CurIDTXDH(WAR.CurID, 67, 1, "续剑·".."烽火连城荡天下", M_Red)
					CurIDTXDH(WAR.CurID, txdh[WAR.JX_QLJJ2], 1, qljj2[WAR.JX_QLJJ2], color[WAR.JX_QLJJ2])
					if WAR.AutoFight == 1 or not WAR.Person[WAR.CurID]["我方"] then
						War_Fight_Sub(WAR.CurID, i, WAR.HZD2[1], WAR.HZD2[2])
					else
						War_Fight_Sub(WAR.CurID, i)
					end	
                    end					
				end
        WAR.JX_QLJJ3 = 0
        WAR.JX_QLJJ2 = 0		
		WAR.HZD2 = {}
		else		
		WAR.LCJY1[pid] = nil
		WAR.LCJY2[pid] = nil
		WAR.LCJY3[pid] = nil
		WAR.LCJY4[pid] = nil
		WAR.LCJY5[pid] = nil
		WAR.HZD2 = {}
		end
  
	        --杨过 吼  龙儿~~
	        if WAR.XK == 1 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 58 and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
						WAR.Person[j].Time = 980
						say("１Ｒ龙儿－－－－－－！Ｈ５啊－－－－４－－－－３－－－－２－－－－１－－－－－－－－！！！", 58,0)
						WAR.XK = 2
					end
				end
	        end
	        
	        --发动 难知如阴
	        if WAR.FLHS5 == 1 then
				local z = WAR.CurID
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then					
						WAR.CurID = j
						WAR.FLHS5 = 0
					end
				end
				if WAR.FLHS5 == 0 and WAR.AutoFight == 0 then
					WAR.Person[WAR.CurID]["移动步数"] = 6
					War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
					local x, y = nil, nil
					while 1 do
						x, y = War_SelectMove()
						if x ~= nil then
							WAR.ShowHead = 0
							War_MovePerson(x, y)
							break;
						end
					end
					if JY.Base["标准"] == 7  then
				       WAR.RY[WAR.Person[WAR.CurID]["人物编号"]] = 1
				    end
				end
				WAR.FLHS5 = 0

				WAR.CurID = z
	        end
			
	        if WAR.FLHS5 == 2 then
				local z = WAR.CurID
				for j = 0, WAR.PersonNum - 1 do
					if match_ID_awakened(WAR.Person[j]["人物编号"],57,1) and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] then
						WAR.FLHS5 = 0
						WAR.Person[j].TimeAdd = 1005
						WAR.CurID = j			        
					end
				end
				WAR.FLHS5 = 0
				WAR.CurID = z
	        end

	        if WAR.FLHS5 == 3 then
				local z = WAR.CurID
				for j = 0, WAR.PersonNum - 1 do
					if qglw(WAR.Person[j]["人物编号"],147)>1 and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] then
						WAR.FLHS5 = 0						
				        WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + 500
						if WAR.Person[j].TimeAdd >= 1005 then
						WAR.Person[j].TimeAdd = 1005
						end
						WAR.CurID = j
					end
				end
				WAR.FLHS5 = 0
				WAR.CurID = z
	        end
	
	
	        --圣火神功 攻击后可移动
	        if (0 < WAR.Person[p]["移动步数"] or 0 < WAR.ZYYD) and WAR.Person[p]["我方"] == true and inteam(id) and WAR.AutoFight == 0 and PersonKF(id, 93) and 0 < JY.Person[id]["生命"] then
				if 0 < WAR.ZYYD then
					WAR.Person[p]["移动步数"] = WAR.ZYYD
					War_CalMoveStep(p, WAR.ZYYD, 0)
				else
					War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
				end
				local x, y = nil, nil
				while 1 do
					x, y = War_SelectMove()
					if x ~= nil then
						WAR.ShowHead = 0
						War_MovePerson(x, y)
						break;
					end 
				end
	        end
			
			--无酒不欢：无论是否触发了圣火再移动，这个变量都应该在这一步清除，否则会影响到下一个人的圣火判定
			WAR.ZYYD = 0
			
			--阿凡提 攻击后可移动
			if match_ID(id,606) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
				WAR.Person[p]["移动步数"] = 10
				War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
				local x, y = nil, nil
				while 1 do
					x, y = War_SelectMove()
					if x ~= nil then
						WAR.ShowHead = 0
						War_MovePerson(x, y)
						break;
					end 
				end
			end
          --上官海棠 攻击后可以再次移动
			if match_ID(id,449) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 51, 1, "无痕公子再动", PinkRed)
				WAR.Person[p]["移动步数"] = 10
				War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
				local x, y = nil, nil
				while 1 do
					x, y = War_SelectMove()
					if x ~= nil then
						WAR.ShowHead = 0
						War_MovePerson(x, y)
						break;
					end 
				end
			end

			if wglw(id, 4)>2  and WAR.LQZS_HQ == 2 then
				CurIDTXDH(WAR.CurID, 51, 1, "极隼再动", PinkRed)
				WAR.Person[p]["移动步数"] = 10
				War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
				local x, y = nil, nil
				while 1 do
					x, y = War_SelectMove()
					if x ~= nil then
						WAR.ShowHead = 0
						War_MovePerson(x, y)
						break;
					end 
				end
				WAR.LQZS_HQ = 0
			end	
			
			--穆人清狂风快剑
			if match_ID(id, 185) and WAR.KFKJ >= 1  and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
			CurIDTXDH(WAR.CurID, 51, 1, "神臂仙猿.天外再动", PinkRed)
				WAR.Person[p]["移动步数"] = 10
				War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
				local x, y = nil, nil
				while 1 do
					x, y = War_SelectMove()
					if x ~= nil then
						WAR.ShowHead = 0
						War_MovePerson(x, y)
						break;
					end 
				end
				WAR.KFKJ = 0
			end
			
	        --雪山上杀血刀老祖后，恢复我方人物
	        if WAR.ZDDH == 7 then
				for x = 0, WAR.PersonNum - 1 do
					if WAR.Person[x]["人物编号"] == 97 and JY.Person[97]["生命"] <= 0 then
						for xx = 0, WAR.PersonNum - 1 do
							if WAR.Person[xx]["人物编号"] ~= 97 then
								WAR.Person[xx]["我方"] = true
							end
						end
					end
				end
	        end


	        
			--无酒不欢：、、、
	        if WAR.ZDDH == 54 and lib.GetWarMap(11, 36, 1) == 2 and inteam(WAR.Person[p]["人物编号"]) and WAR.Person[p]["坐标X"] == 12 and WAR.Person[p]["坐标Y"] == 36 then
				lib.SetWarMap(11, 36, 1, 5420)
				WarDrawMap(0)
				say("AA")
				say("OHMYGO", 27)
				lib.SetWarMap(11, 36, 1, 0)
	        end
			
			--九剑破招减少集气
			if WAR.JJPZ[id] == 1 then
				WAR.Person[p].Time = -200
				WAR.JJPZ[id] = nil
			end
			


			if match_ID_awakened(id,64,1) and WAR.ZBT1[id]~=nil then --沼跃鱼：空明蓄力读条	
                local aa=WAR.ZBT1[id]
                if aa>=3 then
                aa=3
                end				
				WAR.Person[p].Time = WAR.Person[p].Time + 300 *aa
			end			

			if id == 645 and JY.Base["斗神"] == 64 and WAR.ZBT1[id]~=nil then --沼跃鱼：空明蓄力读条	
                local aa=WAR.ZBT1[id]
                if aa>=3 then
                aa=3
                end				
				WAR.Person[p].Time = WAR.Person[p].Time + 300 *aa
			end		
			
			if WAR.MJZS[id] ~= nil then
				WAR.Person[p].Time = -WAR.MJZS[id]
				WAR.MJZS[id] = nil
			end
			
			--太空卸劲减少集气
			if WAR.TKJQ[id] == 1 then
			    if WAR.Person[p].Time<0 then
				WAR.Person[p].Time = WAR.Person[p].Time - 120 
				else
				WAR.Person[p].Time = -120
				end
				WAR.TKJQ[id] = nil
			end			
	
    if MPPB_WD(id) == 1 and MPZJ(id,2)>=1 and WAR.WJ[id] ~= nil then	
	WAR.Person[p].Time = WAR.Person[p].Time + WAR.WJ[id]
    WAR.WJ[id] = nil
	end	
	
	if WAR.TYZH[id]~=nil then
	   if qglw(id,149)>1  then
	   WAR.Person[p].Time = WAR.Person[p].Time + WAR.TYZH[id]*10
	   end
    WAR.TYZH[id] = nil	
	end
	
			--行动后回气的效果上限500点(觉醒周伯通有蓄力时是800)
		    if D1ZSF(pid)  then
			
			elseif qglw(pid,145)>1   then
			
			elseif match_ID_awakened(id, 1,1) and JY.Person[1]["论剑奖励"] == 1 then
				WAR.Person[p].Time = 800
			elseif match_ID_awakened(WAR.Person[p]["人物编号"],64,1) and WAR.ZBT1[WAR.Person[p]["人物编号"]]~=nil and 800 < WAR.Person[p].Time then	
                WAR.Person[p].Time = 800
			elseif id== 645 and JY.Base["斗神"] == 64 and WAR.ZBT1[id]~=nil and 900 < WAR.Person[p].Time then
			    WAR.Person[p].Time = 900
	        elseif 500 < WAR.Person[p].Time then
				WAR.Person[p].Time = 500
	        end

			--重置异常状态
			reseteffect(WAR.BZ, id)
			reseteffect(WAR.WSZ, id)
			reseteffect(WAR.ZBX, id)
			reseteffect(WAR.ZBX2, id)
			reseteffect2(WAR.QMDJ,id,5)
			if WAR.KUIJUE[id] ~= nil then
			WAR.KUIJUE[id] = nil
			end
			
			--无酒不欢：袁承志，碧血长风，杀人后再动
	        if match_ID(id, 54) and WAR.BXCF == 1 and War_isEnd() == 0 then	
				for i = 12, 24 do
					NewDrawString(-1, -1, "碧血长风", C_RED, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, "碧血长风", C_RED, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
				for j = 0, WAR.PersonNum - 1 do
					WAR.Person[j].Time = WAR.Person[j].Time - 10
					if 995 < WAR.Person[j].Time then
						WAR.Person[j].Time = 995
					end
				end
				WAR.Person[WAR.CurID].Time = 1005
				if JY.Person[54]["品德"] == 80 then
					local aa=0
				    local bb=0
		            for j = 0, WAR.PersonNum - 1 do
					local tid = WAR.Person[j]["人物编号"]
					local JD = math.modf(JY.Person[pid]["内力"]/200)
			           if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                          WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0)+AddPersonAttrib(tid, "中毒程度", JD)
						  if JY.Person[54]["论剑奖励"] == 1 then
						     if JY.Person[tid]["中毒程度"]>= 50 then
							 	WAR.JJGD[tid] = 2
	                            WAR.JCGD[tid] = 1
							 end
						  end
						  bb = bb + 1
				          WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			           end
		        end			
						 if JY.Person[54]["论剑奖励"] == 1 and WAR.MDSH> 0 then
						 WAR.MDSH = math.modf(WAR.MDSH*0.2)
                          WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.MDSH)
						  WAR.MDSH = 0
						  end
				end
					
				WAR.BXCF = 0		
	        end

	        if wglw(id, 2)>1 and WAR.XYYX == 1 and War_isEnd() == 0 then
			    local str = "逍遥.雁行诀"
				local color = M_Blue
				if  YCRW(id) ==2 and YCDJ(id)>1 then
				str = "修罗.雁行诀"
				color = M_DarkRed
				end
				for i = 12, 24 do
					NewDrawString(-1, -1, str, color, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, str, color, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
				for j = 0, WAR.PersonNum - 1 do
					WAR.Person[j].Time = WAR.Person[j].Time - 10
					if 995 < WAR.Person[j].Time then
						WAR.Person[j].Time = 995
					end
				end
				WAR.Person[WAR.CurID].Time = 1005
					if  YCRW(id) ==2 and YCDJ(id)>1 then
                    	if JY.Person[pid]["内力"] + WAR.MDSH > JY.Person[pid]["内力最大值"] then----
				           local aa= JY.Person[pid]["内力最大值"]- JY.Person[pid]["内力"]
				           WAR.MDSH=WAR.MDSH-aa
                           local bb=math.modf(WAR.MDSH/20)
			             	WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa)
                           WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", bb)				
			           	else
			            	local aa=WAR.MDSH
			          	WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa)				
			        	end	    
				    end	
				WAR.XYYX = 0		
	        end
	
				--无酒不欢：任我行，魔帝噬魂，杀人后吸干内力
	        if match_ID(id, 26) and WAR.MDSH >0 and War_isEnd() == 0 then	
				for i = 12, 24 do
					NewDrawString(-1, -1, "魔帝噬魂", M_Red, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, "魔帝噬魂", M_Red, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
				if JY.Person[pid]["内力"] + WAR.MDSH > JY.Person[pid]["内力最大值"] then----
				local aa= JY.Person[pid]["内力最大值"]- JY.Person[pid]["内力"]
				WAR.MDSH=WAR.MDSH-aa
                local bb=math.modf(WAR.MDSH/20)
				WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa)
                WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", bb)				
				else
				local aa=WAR.MDSH
				WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa)				
				end				
				WAR.MDSH = 0		
	        end
			
			if match_ID(id, 26) and WAR.MDSH ==-1 and War_isEnd() == 0 then	
				for i = 12, 24 do
					NewDrawString(-1, -1, "魔帝吸魄", M_DeepSkyBlue, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, "魔帝吸魄", M_DeepSkyBlue, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
				local aa=0
				local bb=0
		for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				if JY.Person[WAR.Person[j]["人物编号"]]["内力"] > 500 then
					JY.Person[WAR.Person[j]["人物编号"]]["内力"] = JY.Person[WAR.Person[j]["人物编号"]]["内力"] - 500
					WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - 100;
                     JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 100
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 100;					
					aa=aa+500
					bb=bb +100
				else
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300
				    JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 300
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 300;	
                    bb = bb + 300					
				end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end
			WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", aa)	
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", bb)				
				WAR.MDSH = 0		
	        end
	
				--无酒不欢：一灯，燃灯，杀人后引爆内力
	        if match_ID(id, 65) and WAR.MDSH >0 and War_isEnd() == 0 then	
				for i = 12, 24 do
					NewDrawString(-1, -1, "燃灯.锭光焚天", M_Red, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, "燃灯.锭光焚天", M_Red, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
				local aa=math.modf(WAR.MDSH*0.05)
		    for j = 0, WAR.PersonNum - 1 do
			if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
				if JY.Person[WAR.Person[j]["人物编号"]]["生命"] > aa then
					JY.Person[WAR.Person[j]["人物编号"]]["生命"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"] - aa
					WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - aa;
				else
					WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300
				end
				WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
			end
		end				
				WAR.MDSH = 0		
	        end	
	
	        if WAR.HFLY == 1 and War_isEnd() == 0 and  match_ID_awakened(id, 3, 1) then	
				for i = 12, 24 do
					NewDrawString(-1, -1, "凤翼天翔.燎原", C_RED, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, "凤翼天翔.燎原", C_RED, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
       WAR.SQGJ=1
       War_Fight_Sub(pid, 1, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标X"])
      WAR.SQGJ=0	   
				WAR.HFLY = 0		
	        end


			
	        --资质越高发动几率越高
	        local pz = math.modf(JY.Person[0]["资质"] / 10)
	        --主角医生大招，直接再次行动
	        if id == 0 and JY.Base["标准"] == 8 and JY.Person[pid]["六如觉醒"] > 0 then
	        	if 0 < JY.Person[0]["体力"] then
					if WAR.HTSS == 0 and JLSD(25, 60 + pz, 0) and 0 < JY.Person[0]["武功9"] then
						CurIDTXDH(WAR.CurID, 91, 1)
						Cls()
						  --[[
						  if JY.HEADXZ == 1 then
							lib.PicLoadCache(91, 12, 270, -1, 1)
						  else
							lib.PicLoadCache(91, 12, 48, 1, 1)
						  end
						  ]]
						  
						ShowScreen()
						lib.Delay(40)
						for i = 12, 24 do
							NewDrawString(-1, -1, ZJTF[8] .. TFSSJ[8], C_GOLD, 25 + i)
							ShowScreen()
							if i == 24 then
								Cls()
								NewDrawString(-1, -1, ZJTF[8] .. TFSSJ[8], C_GOLD, 25 + i)
								ShowScreen()
								lib.Delay(500)
							else
								lib.Delay(1)
							end
						end
						for j = 0, WAR.PersonNum - 1 do
							WAR.Person[j].Time = WAR.Person[j].Time - 10
							if 995 < WAR.Person[j].Time then
								WAR.Person[j].Time = 995
							end
						end
						WAR.Person[WAR.CurID].Time = 1005
						--有低概率再次发动
						if JLSD(45, 50, 0) then
							WAR.HTSS = 0        
						else
							WAR.HTSS = 1
						end
					end
				else
					WAR.HTSS = 0
				end
	        end
	        
			if wglw(id, 4)>2  and WAR.LQAY == 1 then
			CurIDTXDH(WAR.CurID, 48, 1, "势若飞燕", PinkRed)
			            ShowScreen()
						lib.Delay(40)
						for i = 12, 24 do
							NewDrawString(-1, -1, "猛禽飞燕拳奥义.飞燕还巢", C_GOLD, 25 + i)
							ShowScreen()
							if i == 24 then
								Cls()
								NewDrawString(-1, -1, "猛禽飞燕拳奥义.飞燕还巢", C_GOLD, 25 + i)
								ShowScreen()
								lib.Delay(500)
							else
								lib.Delay(1)
							end
						end
						for j = 0, WAR.PersonNum - 1 do
							WAR.Person[j].Time = WAR.Person[j].Time - 10
							if 995 < WAR.Person[j].Time then
								WAR.Person[j].Time = 995
							end
						end
						WAR.Person[WAR.CurID].Time = 1005
			end
			
			
	        --成昆密道 100时序就跑
	        if WAR.ZDDH == 237 and 100 < WAR.SXTJ then
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] == false then
						WAR.Person[i]["死亡"] = true
					end
				end
				say("１Ｌ＜嗯，没功夫跟这"..JY.Person[0]["外号2"].."纠缠了＞Ｗ哈哈哈，"..JY.Person[0]["外号2"].."，算你走运！老夫还有要事待办，这次就放你一马！", 18,0)
	        end

			if WAR.ZDDH == 166 and 100 < WAR.SXTJ then --武骧金星：无酒不欢
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] == false then
						WAR.Person[i]["死亡"] = true
					end
				end
					say("啊？修仙时间到了，那对不起，失陪了",455,0)
					say("以后有时间再陪你玩",455,0)
					say("兄弟们，撤",455,0)
			end			

	        if WAR.ZDDH == 22 and MPPD(0) == 2 and math.modf(50 * (MPDJ(0) + 1)) < WAR.SXTJ then --武当入门战
	          for i = 0, WAR.PersonNum - 1 do
	            if WAR.Person[i]["我方"] == false then
	              WAR.Person[i]["死亡"] = true
	            end
	          end
				Cls()
				say("哈哈，小兄弟武功又大进了！",5,0)			
				Cls()
				say("前辈承让！",0,1)					
	        end	
			
		if WAR.ZDDH == 7 and 200 < WAR.SXTJ then
			for i = 0, WAR.PersonNum - 1 do
				if WAR.Person[i]["我方"] == false then
					WAR.Person[i]["死亡"] = true
				end
			end
			say("１Ｌ＜再这么耗下去，对我不利，不如分身离去＞Ｗ", 97, 0,"血刀老祖")  --对话
			say("１Ｌ＜且看我血神子术，留一个分身在这里与他们周旋，我好脱身离开＞Ｗ", 97, 0,"血刀老祖")  --对话
			JY.Person[97]["品德"] = 31
		end
	
       if WAR.ZDDH == 93 and  WAR.YJDD == 1 and WAR.SXTJ>100 and JY.Person[97]["品德"] == 31 then
	 
              NewWARPersonZJ(97, false, 20, 49, false, 1)
			  TalkEx("没想到吧，小子，今天咱们好好把以前的账算一算。", 97, 0)
			  WAR.YJDD = 0
			  JY.Person[97]["品德"] = 51
	        end
	   
	   if WAR.ZDDH == 68 and  WAR.YJDD == 1 and WAR.SXTJ>50 then
              NewWARPersonZJ(129, false, 32, 39, false, 1)
			  NewWARPersonZJ(64, false, 35, 38, false, 1)
			  TalkEx("师兄，我们好像来晚了。", 64, 0)
			  TalkEx("不晚，我们来的正好。", 129, 0)
			  WAR.YJDD = 0
			  JY.Person[129]["品德"] = 90
	        end

			
	   if WAR.ZDDH == 185 and  WAR.YJDD == 1 and WAR.SXTJ>100 then
			  NewWARPersonZJ(55, false, 30, 50, false, 1)
			  NewWARPersonZJ(56, false, 31, 50, false, 1)
			  TalkEx("爹，我们来了。", 56, 0)
			  if JY.Person[129]["品德"] ==90 then
			  NewWARPersonZJ(65, false, 32, 48, false, 1)
			  TalkEx("我一灯前来帮助王道长斩妖除魔。", 65, 0)
			  TalkEx("小贼，拿命来。", 65, 0)
			  end
			  WAR.YJDD = 0
	        end
	
	
	
	        if WAR.ZDDH == 100 and 200 < WAR.SXTJ then
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] == false then
						WAR.Person[i]["死亡"] = true
					end
				end
			if wglw(0,66)>0 and GetS(113,0,0,0) == 0 then
	           say("１Ｌ小家伙不错啊"..JY.Person[0]["外号2"].."你有资格窥伺一下我大轮明王的真传了，看清楚了,"..JY.Person[0]["外号2"].."，这也是你的机缘了", 103,0)
	              if instruct_11(0,188) == true then
	                 QZXS("顿悟九凤刀意！")
	                 instruct_0();
	                 TalkEx("多谢法王。", 0, 1) 
	                 SetS(113, 0, 0, 0,66)
					 TalkEx("哈哈，下回就是真正对决了，用我的迦楼罗琉璃火。", 103, 0)
					awakening(103, 1) 
					DrawStrBoxWaitKey("鸠摩智觉醒为迦楼罗", C_WHITE, CC.DefaultFont)
				  else
				  TalkEx("我还是算了吧", 0, 1)
				  end
	           end
				
	        end
	
	        if WAR.ZDDH == 139 and  WAR.YJDD == 1 and WAR.SXTJ>100  then
              NewWARPersonZJ(447, true, 37, 26, false, 1)
			  NewWARPersonZJ(448, true, 36, 26, false, 1)
			  NewWARPersonZJ(449, true, 35, 26, false, 1)
			  NewWARPersonZJ(450, true, 34, 26, false, 1)
			  TalkEx("我等奉神侯命令，前来支援。", 447, 0)
			  	JY.Person[447]["生命"] = 920
	            JY.Person[447]["内力"] = 4300
				JY.Person[448]["生命"] = 920
	            JY.Person[448]["内力"] = 4300
				JY.Person[449]["生命"] = 920
	            JY.Person[449]["内力"] = 4300
				JY.Person[450]["生命"] = 920
	            JY.Person[450]["内力"] = 4300
			  WAR.YJDD = 0
	        end
	
		    if WAR.ZDDH == 142 and  WAR.YJDD == 1 and WAR.SXTJ>100  then
              NewWARPersonZJ(151, true, 37, 26, false, 1)
			  NewWARPersonZJ(152, true, 36, 26, false, 1)
			  NewWARPersonZJ(153, true, 35, 26, false, 1)
			  NewWARPersonZJ(154, true, 34, 26, false, 1)
			  TalkEx("文四哥被我们救出来了。", 154, 0)
			  TalkEx("大家一起上，捉住那个姓张的。", 152, 0)
			  WAR.YJDD = 0
	        end
	
	      	 --冰糖恋：正十五大20时序胜利
	        if WAR.ZDDH == 134 and 20 < WAR.SXTJ and GetS(87,31,32,5) == 1 then
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] == false then
						WAR.Person[i]["死亡"] = true
					end
				end
				TalkEx("恭喜"..JY.Person[0]["外号"].."挺过20时序，成功过关。",269,0);
	        end
	
			--冰糖恋：邪十五大20时序胜利
	        if WAR.ZDDH == 133 and 20 < WAR.SXTJ and GetS(87,31,31,5) == 1 then
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] == false then
						WAR.Person[i]["死亡"] = true
					end
				end
				TalkEx("恭喜"..JY.Person[0]["外号"].."挺过20时序，成功过关。",269,0);
	        end
	        
	        --蓝烟清：单挑，十八铜人 800时序胜利
			--[[
	        if WAR.ZDDH == 217 and GetS(86,1,2,5) == 1 and 800 < WAR.SXTJ then
	        	for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] == false then
						WAR.Person[i]["死亡"] = true
					end
				end
				say("呼呼～～终于闯过去了～～～少林十八铜人阵果然名不虚传～～",0,1);
	        end
	        
	        --蓝烟清：群战，十八铜人 超过500时序失败
	        if WAR.ZDDH == 217 and GetS(86,1,2,5) == 2 and 500 < WAR.SXTJ then
	        	say("呼呼～～好可惜，差一点就成功了。少林十八铜人阵果然名不虚传～～",0,1);
	        	for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["我方"] then
						WAR.Person[i]["死亡"] = true
					end
				end
	        end]]
	        
	        --新华山论剑
	        if WAR.ZDDH == 238 then
	        	local life = 0
	        	WAR.NO1 = 114;
				for i = 0, WAR.PersonNum - 1 do
					if WAR.Person[i]["死亡"] == false and 0 < JY.Person[WAR.Person[i]["人物编号"]]["生命"] then
						life = life + 1
						if WAR.NO1 >= WAR.Person[i]["人物编号"] then
							WAR.NO1 = WAR.Person[i]["人物编号"]
						end
					end
				end
	          
				if 1 < life then
					local m, n = 0, 0
					while true do			--防止全部随机到已方
						if m >= 1 and n >= 1 then
							break;
						else
							m = 0;
							n = 0;
						end
						
						for i = 0, WAR.PersonNum - 1 do
							if WAR.Person[i]["死亡"] == false and 0 < JY.Person[WAR.Person[i]["人物编号"]]["生命"] then
								if WAR.Person[i]["人物编号"] == 0 then
									WAR.Person[i]["我方"] = true
									m = m + 1
								elseif math.random(2) == 1 then
									WAR.Person[i]["我方"] = true
									m = m + 1
								else
									WAR.Person[i]["我方"] = false
									n = n + 1
								end
							end
						end
					end
				end
	        end
	    end
	end
	    
		warStatus = War_isEnd()   --战斗是否结束？   0继续，1赢，2输
		if 0 < warStatus then
			break;
		end
		CleanMemory()
    end
    if 0 < warStatus then
     	break;
    end
    WarPersonSort(1)
    WAR.Delay = GetJiqi()
    startt = lib.GetTime()
    collectgarbage("step", 0)
  end
  local r = nil
  WAR.ShowHead = 0
  
  --蓝烟清：战斗结束，敌方队友状态回复
  for i = 0, WAR.PersonNum - 1 do	
  	if WAR.tmp[4000 + i] ~= nil then
  		local n = WAR.tmp[4000 + i];
  		JY.Person[n[1]]["生命最大值"] = JY.Person[n[1]]["生命最大值"] - n[2]
  		JY.Person[n[1]]["内力最大值"] = JY.Person[n[1]]["内力最大值"] - n[3]
  		JY.Person[n[1]]["攻击力"] = JY.Person[n[1]]["攻击力"] - n[4]
  		JY.Person[n[1]]["防御力"] = JY.Person[n[1]]["防御力"] - n[5]
  		JY.Person[n[1]]["轻功"] = JY.Person[n[1]]["轻功"] - n[6]
  	end
  end
 
 
	--战斗结束后的奖励
	if WAR.ZDDH == 238 then
		PlayMIDI(111)
		PlayWavAtk(41)
		DrawStrBoxWaitKey("论剑结束", C_WHITE, CC.DefaultFont)
		DrawStrBoxWaitKey("武功天下第一者：" .. JY.Person[WAR.NO1]["姓名"], C_RED, CC.DefaultFont)
		if WAR.NO1 == 0 then
		  r = true
		else
		  r = false
		end
	--战斗胜利
	elseif warStatus == 1 then
		PlayMIDI(111)
		PlayWavAtk(41)
		DrawStrBoxWaitKey("战斗胜利", C_WHITE, CC.DefaultFont)
		if WAR.ZDDH == 76 then
			DrawStrBoxWaitKey("特殊奖励：千年灵芝两枚", C_GOLD, CC.DefaultFont)
			instruct_32(14, 2)
		elseif WAR.ZDDH == 15 or WAR.ZDDH == 80 then
			DrawStrBoxWaitKey("特殊奖励：主角五系兵器值提升十点", C_RED, CC.DefaultFont,nil,C_GOLD)
			AddPersonAttrib(0, "拳掌功夫", 10)
			AddPersonAttrib(0, "指法技巧", 10)
			AddPersonAttrib(0, "御剑能力", 10)
			AddPersonAttrib(0, "耍刀技巧", 10)
			AddPersonAttrib(0, "特殊兵器", 10)
		elseif WAR.ZDDH == 100 then
			DrawStrBoxWaitKey("特殊奖励：获得天王保命丹两颗", C_GOLD, CC.DefaultFont)
			instruct_32(8, 2)
		elseif WAR.ZDDH == 172 then
			DrawStrBoxWaitKey("特殊奖励：获得蛤蟆功秘籍一本", C_GOLD, CC.DefaultFont)
			instruct_32(73, 1)
		elseif WAR.ZDDH == 173 then
			DrawStrBoxWaitKey("特殊奖励：获得天山雪莲两枚", C_GOLD, CC.DefaultFont)
			instruct_32(17, 2)
		elseif WAR.ZDDH == 188 then
			local hqjl = JYMsgBox("特殊奖励", "你完成了奖励战**请选择一项兵器值进行提高", {"拳法","指法","剑法","刀法","奇门"}, 5, 69)
			if hqjl == 1 then
				AddPersonAttrib(0, "拳掌功夫", 10)
				DrawStrBoxWaitKey("你的拳掌功夫提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 2 then
				AddPersonAttrib(0, "指法技巧", 10)
				DrawStrBoxWaitKey("你的指法技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 3 then
				AddPersonAttrib(0, "御剑能力", 10)
				DrawStrBoxWaitKey("你的御剑能力提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 4 then
				AddPersonAttrib(0, "耍刀技巧", 10)
				DrawStrBoxWaitKey("你的耍刀技巧提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			elseif hqjl == 5 then
				AddPersonAttrib(0, "特殊兵器", 10)
				DrawStrBoxWaitKey("你的特殊兵器提高了十点",C_GOLD,CC.DefaultFont,nil,LimeGreen)
				Cls()  --清屏
			end
		elseif WAR.ZDDH == 211 then
			DrawStrBoxWaitKey("特殊奖励：主角防御力和轻功各提升十点", C_GOLD, CC.DefaultFont)
			AddPersonAttrib(0, "防御力", 10)
			AddPersonAttrib(0, "轻功", 10)
		elseif WAR.ZDDH == 86 then
			instruct_2(66, 1)
		elseif WAR.ZDDH == 4 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],30));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 30
				if JY.Person[0]["实战"] > 500 then
					 if wglw(0,52)>1 and JY.Person[0]["实战"] < 1000 then
				     else
				     JY.Person[0]["实战"] = 500
				     end
				end
			end
		elseif WAR.ZDDH == 77 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],20));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 20
				if JY.Person[0]["实战"] > 500 then
					 if wglw(0,52)>1 and JY.Person[0]["实战"] < 1000 then
				     else
				     JY.Person[0]["实战"] = 500
				     end
				end
			end
		elseif WAR.ZDDH > 42 and  WAR.ZDDH < 47 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],10));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 10
				if JY.Person[0]["实战"] > 500 then
					 if wglw(0,52)>1 and JY.Person[0]["实战"] < 1000 then
				     else
				     JY.Person[0]["实战"] = 500
				     end
				end
			end
		elseif WAR.ZDDH == 161 then
			if JY.Person[0]["实战"] < 500 then
				QZXS(string.format("%s 实战增加%s点",JY.Person[0]["姓名"],30));
				JY.Person[0]["实战"] = JY.Person[0]["实战"] + 30
				if JY.Person[0]["实战"] > 500 then
					 if wglw(0,52)>1 and JY.Person[0]["实战"] < 1000 then
				     else
				     JY.Person[0]["实战"] = 500
				     end
				end
			end
		--战胜海大富
		elseif WAR.ZDDH == 259 then
			DrawStrBoxWaitKey("特殊奖励：获得化骨绵掌秘籍一本", C_GOLD, CC.DefaultFont)
			instruct_32(275,1)
		--新论剑奖励 根据敌人不同奖励不同
		elseif WAR.ZDDH == 266 then
			--老周
			if GetS(85, 40, 38, 4) == 64 then
				if JY.Person[0]["左右互搏"] == 1 then
					DrawStrBoxWaitKey("特殊奖励：你的左右互搏几率永久提高了20% ", LimeGreen, 36,nil, C_GOLD)
					JY.Person[64]["论剑奖励"] = 1
				else
					DrawStrBoxWaitKey("你似乎错过了一项奖励……", LimeGreen, 36,nil, C_GOLD)
				end
			--老王
			elseif GetS(85, 40, 38, 4) == 129 then
				DrawStrBoxWaitKey("特殊奖励：你的暴击率永久提高了30% ", LimeGreen, 36,nil, C_GOLD)
				JY.Person[129]["论剑奖励"] = 1
			--林朝英
			elseif GetS(85, 40, 38, 4) == 605 then
				DrawStrBoxWaitKey("特殊奖励：你的连击率永久提高了30% ", LimeGreen, 36,nil, C_GOLD)
				JY.Person[605]["论剑奖励"] = 1
			--阿青
			elseif GetS(85, 40, 38, 4) == 604 then
				DrawStrBoxWaitKey("特殊奖励：获得越女剑法秘籍一本", LimeGreen, 36,nil, C_GOLD)
				JY.Person[604]["论剑奖励"] = 1
				instruct_32(278,1)
			--独孤求败
			elseif GetS(85, 40, 38, 4) == 140 then
				if PersonKF(0, 47) then
					DrawStrBoxWaitKey("特殊奖励：你获得了独孤九剑的真传", LimeGreen, 36,nil, C_GOLD)
					JY.Person[592]["论剑奖励"] = 1
				else
					DrawStrBoxWaitKey("你似乎错过了一项奖励……", LimeGreen, 36,nil, C_GOLD)
				end
			--东方不败
			elseif GetS(85, 40, 38, 4) == 27 then
				DrawStrBoxWaitKey("特殊奖励：你的集气速度永久提高了5点", LimeGreen, 36,nil, C_GOLD)
				JY.Person[27]["论剑奖励"] = 1
			--扫地
			elseif GetS(85, 40, 38, 4) == 114 then
				DrawStrBoxWaitKey("特殊奖励：你的武学常识提高了100点", LimeGreen, 36,nil, C_GOLD)
				JY.Person[114]["论剑奖励"] = 1
				AddPersonAttrib(0, "武学常识", 100)
			--三丰
			elseif GetS(85, 40, 38, 4) == 5 then
				DrawStrBoxWaitKey("特殊奖励：你的攻防轻和五系兵器值全面提高了", LimeGreen, 36,nil, C_GOLD)
				JY.Person[5]["论剑奖励"] = 1
				AddPersonAttrib(0, "攻击力", 30)
				AddPersonAttrib(0, "防御力", 30)
				AddPersonAttrib(0, "轻功", 30)
				AddPersonAttrib(0, "拳掌功夫", 20)
				AddPersonAttrib(0, "指法技巧", 20)
				AddPersonAttrib(0, "御剑能力", 20)
				AddPersonAttrib(0, "耍刀技巧", 20)
				AddPersonAttrib(0, "特殊兵器", 20)
			--阿凡提
			elseif GetS(85, 40, 38, 4) == 606 then
				DrawStrBoxWaitKey("特殊奖励：你似乎感觉到女神在眷顾你", LimeGreen, 36,nil, C_GOLD)
				JY.Person[606]["论剑奖励"] = 1
			end
		end
		r = true
	--战斗失败
	elseif warStatus == 2 then
		--DrawStrBoxWaitKey("战斗失败", C_WHITE, CC.DefaultFont)
		lib.LoadPNG(1, 999 * 2 , 295, 295, 1)
		ShowScreen();
		WaitKey();
		r = false
	end
  
	War_EndPersonData(isexp, warStatus)
	lib.ShowSlow(20, 1)
	if 0 <= JY.Scene[JY.SubScene]["进门音乐"] then
		PlayMIDI(JY.Scene[JY.SubScene]["进门音乐"])
	else
		PlayMIDI(0)
	end
	CleanMemory()
	lib.PicInit()
  
	--战斗结束，重新加载场景贴图
	lib.PicLoadFile(CC.SMAPPicFile[1], CC.SMAPPicFile[2], 0)	--子场景贴图，内存区域0
	lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.ScreenW/936*100,0,100))	--人物头像，内存区域1
	lib.LoadPNGPath(CC.XTPath, 91, CC.XTNum, limitX(CC.ScreenW/936*100,0,100))	--UI		
	lib.LoadPNGPath(CC.BodyPath, 90, CC.BodyNum, limitX(CC.ScreenW/936*100,0,100))	--半身像，内存区域100
	lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.ScreenW/936*100,0,100))
	lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)	--物品贴图，内存区域2
	lib.LoadPNGPath(CC.BJPath, 98, CC.BJNum, limitX(CC.ScreenW/936*100,0,100))		--奇穴
	lib.PicLoadFile(CC.BJ[1], CC.BJ[2], 92)
	JY.Status = GAME_SMAP
	return r
end

--山洞妹妹，布阵
function buzhen()
	if not inteam(92) then
		return 
	end
	if WAR.ZDDH == 226 then
		return 
	end
	local line = "要布置阵型吗？";
	local tiles = 2;
	if (WAR.ZDDH == 133 or WAR.ZDDH == 134) and WAR.MCRS == 1 then
		if JY.Person[0]["性别"] == 0 then
			line = "哥哥你真勇敢，一个人挑战十五大高手，请千万小心。"
		else
			line = "姐姐你真勇敢，一个人挑战十五大高手，请千万小心。"
		end
		tiles = 4
	end
	say(line, 384,0,JY.Person[92]["姓名"])
	if not DrawStrBoxYesNo(-1, -1, "要布置阵型吗？", C_WHITE, CC.DefaultFont) then
		return 
	end
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["我方"] then
			WAR.CurID = i
			WAR.ShowHead = 1
			--布阵统一为2格
			War_CalMoveStep(WAR.CurID, tiles, 0)
			local x, y = nil, nil
			while true do
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
		end
	end
end

--无酒不欢：战前运功
function Pre_Yungong()
	if WAR.ZDDH == 226 then
		return 
	end
	if Num_of_Neigong(0) == 0 then
		return 
	end
	local id, x1, y1;
	for j = 0, WAR.PersonNum - 1 do
		if WAR.Person[j]["人物编号"] == 0 then
			id, x1, y1 = j, WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"]
			break
		end
	end
	if x1 == nil then
		return 
	end
	local s = WAR.CurID
	local r = JYMsgBox("战前运功", "战前强行运功是有额外代价的*要继续吗？", {"否","是"}, 2, WAR.tmp[5000+id])
	if r == 2 then
		local menu={};
		for i=1,CC.Kungfunum do
			menu[i]={JY.Wugong[JY.Person[0]["武功" .. i]]["名称"],nil,0};
			if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 6 then
				menu[i][3]=1;
			end
			--天罡不能运天赋内功
			if 0 == 0 and JY.Base["标准"] == 6 and (JY.Person[0]["武功" .. i] == JY.Person[0]["天赋内功"]) then
				menu[i][3]=0;	
			end
		end
		local main_neigong =  ShowMenu(menu,#menu,0,CC.MainSubMenuX+21+4*(CC.Fontsmall+CC.RowPixel),CC.MainSubMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
		if main_neigong ~= nil and main_neigong > 0 then
			WAR.CurID = id
			CleanWarMap(4, 0)
			SetWarMap(x1, y1, 4, 1)
			War_ShowFight(0, 0, 0, 0, 0, 0, 9)	
			AddPersonAttrib(0, "内力", -500);
			AddPersonAttrib(0, "体力", -10);
			JY.Person[0]["主运内功"] = JY.Person[0]["武功" .. main_neigong]
			WAR.CurID = s
		end
	end
end

function NEWTXWZ(str,color)
        if color == nil then
		color = C_RED
		end
        local str1="【"..str.."】"
        local size = 60
		local x = CC.ScreenW/2;
        local y = CC.ScreenH/2;
        local offx = (#str1)*size/4
        local offy = size/2
        lib.Background(0,y-50,CC.ScreenW,y+50,98)
        DrawString(x-offx,y-offy,str1,color,size);  
        ShowScreen();
        lib.Delay(500);
end

--无酒不欢：在自身位置播放动画的函数
function CurIDTXDH(id, eft, order, str, strColor, endFrame)
	--增加文字颜色控制
	if strColor == nil then
		strColor = C_GOLD
	end
	--增加强制结束帧
	if endFrame == nil then
		endFrame = CC.Effect[eft]
	end
	local x0, y0 = WAR.Person[id]["坐标X"], WAR.Person[id]["坐标Y"]
	local hb = GetS(JY.SubScene, x0, y0, 4)
	local starteft = 0
	
	for i = 0, eft - 1 do
		starteft = starteft + CC.Effect[i]
	end
	
	local px = 0
	local py = 0

	--狮王咆哮动画位置
	if eft == 118 then
		py = CC.YScale * 4
	end	
	
	--玉石俱焚动画位置
	if eft == 124 then
		py = CC.YScale * 3
	end
	
	--倾国动画位置
	if eft == 149 then
		py = CC.YScale * 11
	end
	
	--喵姐的免疫攻击动画位置
	if eft == 135 then
		py = CC.YScale * 2
	end

	if eft == 137 then
		py = CC.YScale * 60
	end
	
	--集中动画位置
	if eft == 151 then
		py = CC.YScale * 6
	end

	--冰火动画位置
	if eft == 156 then
		py = -CC.YScale * 20
		px = -CC.YScale * 5
	end



	--升龙动画位置
	--if eft == 162 then
		--py = -CC.YScale * 36
		--px = -CC.YScale * 5
	--end	
	
	--升龙动画位置
	if eft == 175 then
		py = -CC.YScale * 16
		px = -CC.YScale * 10
	end	

	--猛虎
	if eft == 176 then
		py = -CC.YScale * 16
		px = -CC.YScale * 5
	end	

	--蝴蝶
	if eft == 178 then
		py = -CC.YScale * 16
		px = -CC.YScale * 5
	end	
	
	if eft == 182 then
		py = CC.YScale * 18
		px = CC.YScale * 0
	end
	
	if eft == 183 then
		py = CC.YScale * 23
		px = CC.YScale * 0
	end
	
	local ssid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	for ii = 1, endFrame, order do
		lib.GetKey()
	--	WarDrawMap(6, 0, 0, (starteft + ii) * 2, nil, 3)
		lib.PicLoadCache(3, (starteft + ii) * 2, CC.ScreenW / 2+px, CC.ScreenH / 2 - hb + py, 2, 192)
		if str ~= nil then
			DrawString(-1, CC.ScreenH / 2 - hb, str, strColor, CC.DefaultFont)
		end
		ShowScreen()
		lib.Delay(CC.BattleDelay)
		lib.LoadSur(ssid, 0, 0)
	end
	lib.FreeSur(ssid)
	Cls()
end


function WE_xy(x, y, id)
  if id ~= nil then
    War_CalMoveStep(id, 128, 0)
  else
    CleanWarMap(3, 0)
  end
  if GetWarMap(x, y, 3) ~= 255 and War_CanMoveXY(x, y, 0) then
    return x, y
  else
    for s = 1, 128 do
      for i = 1, s do
        local j = s - i
        if x + i < 63 and y + j < 63 and GetWarMap(x + i, y + j, 3) ~= 255 and War_CanMoveXY(x + i, y + j, 0) then
          return x + i, y + j
        end
        if x + j < 63 and y - i > 0 and GetWarMap(x + j, y - i, 3) ~= 255 and War_CanMoveXY(x + j, y - i, 0) then
          return x + j, y - i
        end
        if x - i > 0 and y - j > 0 and GetWarMap(x - i, y - j, 3) ~= 255 and War_CanMoveXY(x - i, y - j, 0) then
          return x - i, y - j
        end
        if x - j > 0 and y + i < 63 and GetWarMap(x - j, y + i, 3) ~= 255 and War_CanMoveXY(x - j, y + i, 0) then
          return x - j, y + i
        end
      end
    end
  end
  for s = 1, 128 do
    for i = 1, s do
      local j = s - i
      if x + i < 63 and y + j < 63 and War_CanMoveXY(x + i, y + j, 0) then
        return x + i, y + j
      end
      if x + j < 63 and y - i > 0 and War_CanMoveXY(x + j, y - i, 0) then
        return x + j, y - i
      end
      if x - i > 0 and y - j > 0 and War_CanMoveXY(x - i, y - j, 0) then
        return x - i, y - j
      end
      if x - j > 0 and y + i < 63 and War_CanMoveXY(x - j, y + i, 0) then
        return x - j, y + i
      end
    end
  end
  return x, y
end

--计算暗器伤害
function War_AnqiHurt(pid, enemyid, thingid, emeny)
	local num = nil
	local dam = nil
	local eid = enemyid
	if JY.Person[enemyid]["受伤程度"] == 0 then
		num = JY.Thing[thingid]["加生命"] / 2 - Rnd(3)
	elseif JY.Person[enemyid]["受伤程度"] <= 33 then
		num = math.modf(JY.Thing[thingid]["加生命"] *2 / 3) - Rnd(3)
	elseif JY.Person[enemyid]["受伤程度"] <= 66 then
		num = JY.Thing[thingid]["加生命"] - Rnd(3)
	else
		num = math.modf(JY.Thing[thingid]["加生命"] *4 / 3) - Rnd(3)
	end
	local tmpanqi = JY.Person[pid]["暗器技巧"] + MPAttrib(pid, 7)  
	num = math.modf(num - tmpanqi/4)
	if wglw(enemyid,61)>1 or match_ID(enemyid,153) then----
	num=0
	end
	if WAR.ZLLY[pid] ~= nil then
	num = math.modf(num/2)
	end
	if WAR.FZLY[pid] ~= nil then
	num = math.modf(num*1.5)
	end
	if JY.Person[enemyid]["个人觉醒"] >= 1 and JLSD(10,60,enemyid) and WAR.YFZ3[pid] == nil then
	num = 0
	end
	WAR.Person[emeny]["内伤点数"] = AddPersonAttrib(enemyid, "受伤程度", math.modf(-num / 6))
	dam = num * WAR.AQBS
	if match_ID_awakened(pid,153,1) then
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -math.modf(dam))
	end
	if wglw(enemyid,47)>=1 or match_ID_awakened(enemyid,153,1) then----
	   WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", math.modf(dam))
	   dam = 0
	end
	if wglw(pid,18)>=1 and thingid == 28 then----
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.FXDS[eid] = limitX((WAR.FXDS[eid] or 0) + d, 0, 100)
	   WAR.FXXS[eid] = 1
	end
	if WAR.YFZ3[pid] ~= nil and thingid == 31 then
	   WAR.XRZT[eid] = 20
	   WAR.JHLY[eid] = 10
	end
	if match_ID_awakened(pid,161,1) and thingid == 34 then----
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.QSLZ[eid] = limitX((WAR.QSLZ[eid] or 0) + d, 0, 100)
	   WAR.BPYZ[eid] = 20
	end
	if Curr_JL(pid,2) and (thingid >= 33 and thingid <= 35)then----
	   local d = math.modf((JY.Person[pid]["内力"] - JY.Person[eid]["内力"]) / 500)
       if d < 10 then
          d = 10
       end
	   WAR.FXDS[eid] = limitX((WAR.FXDS[eid] or 0) + d, 0, 100)
	   WAR.FXXS[eid] = 1
	end
	local r = AddPersonAttrib(enemyid, "生命", math.modf(dam))
	if (enemyid == 129 or enemyid == 65) and JY.Person[enemyid]["生命"] <= 0 then
		JY.Person[enemyid]["生命"] = 1
	end
	if enemyid == 553 and JY.Person[enemyid]["生命"] <= 0 then
		WAR.YZB = 1
	end
	if WAR.AQLX == 1  then
        local lxz = 0
		lxz = math.modf((-dam)/10+3)
		if WAR.LXZT[eid] == nil then
			WAR.LXZT[eid] = lxz
		else
		    WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.LXZT[eid]*3)
			WAR.LXZT[eid] = WAR.LXZT[eid] + lxz
		end		
		WAR.LXXS[eid] = 1
		
		if 100 < WAR.LXZT[eid] then
			WAR.LXZT[eid] = 100
		end
	end
	if JY.Person[enemyid]["生命"] <= 0 then
		WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + JY.Person[enemyid]["等级"] * 5
		if match_ID(pid, 54) then
		WAR.BXCF = 1
			 if JY.Person[54]["论剑奖励"] == 1 and JY.Person[54]["品德"] == 80  then
                 WAR.MDSH = JY.Person[enemyid]["生命最大值"]  
			 end
	    end
		if wglw(pid, 2)>1 then
		    WAR.XYYX = 1
			if  YCRW(pid) ==2 and YCDJ(pid)>1 then		    
		        WAR.MDSH = JY.Person[enemyid]["内力"]       
			end	
	    end
	end
	if JY.Thing[thingid]["加中毒解毒"] > 0 then
		num = math.modf(JY.Thing[thingid]["加中毒解毒"] + JY.Person[pid]["暗器技巧"] / 4)
		num = num - JY.Person[enemyid]["抗毒能力"]
		num = limitX(num, 0, CC.PersonAttribMax["用毒能力"])
		if wglw(enemyid,18)>=1 then
		local aa= num*3
		WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", math.modf(aa))
		num = 0
	    end
		WAR.Person[emeny]["中毒点数"] = AddPersonAttrib(enemyid, "中毒程度", num)
	end
	--沉睡状态的敌人会醒来
	if WAR.CSZT[enemyid] ~= nil then
		WAR.CSZT[enemyid] = nil
		if WAR.CSSX[enemyid] == nil  then
		local aa = math.max(math.modf(JY.Person[enemyid]["生命"]*0.1),1)
		WAR.Person[emeny]["生命点数"] = (WAR.Person[emeny]["生命点数"] or 0) + AddPersonAttrib(enemyid, "生命", -math.modf(aa))
		WAR.CSSX[enemyid] = nil
		end
	end
	return r
end

--计算从(x,y)开始攻击最多能够击中几个敌人
function War_AutoCalMaxEnemy(x, y, wugongid, level)
  local wugongtype = JY.Wugong[wugongid]["攻击范围"]
  local movescope = JY.Wugong[wugongid]["移动范围" .. level]
  local fightscope = JY.Wugong[wugongid]["杀伤范围" .. level]
  local maxnum = 0
  local xmax, ymax = nil, nil
  if wugongtype == 0 or wugongtype == 3 then
    local movestep = War_CalMoveStep(WAR.CurID, movescope, 1)	--计算武功移动步数
    for i = 1, movescope do
      local step_num = movestep[i].num
      if step_num == 0 then
        break;
      end
      for j = 1, step_num do
        local xx = movestep[i].x[j]
        local yy = movestep[i].y[j]
        local enemynum = 0
        for n = 0, WAR.PersonNum - 1 do
          if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
            local x = math.abs(WAR.Person[n]["坐标X"] - xx)
            local y = math.abs(WAR.Person[n]["坐标Y"] - yy)
          end
          if x <= fightscope and y <= fightscope then
            enemynum = enemynum + 1
          end
        end
        if maxnum < enemynum then
          maxnum = enemynum
          xmax = xx
          ymax = yy
        end
      end
    end
  elseif wugongtype == 1 then
    for direct = 0, 3 do
      local enemynum = 0
      for i = 1, movescope do
        local xnew = x + CC.DirectX[direct + 1] * i
        local ynew = y + CC.DirectY[direct + 1] * i
        if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
          local id = GetWarMap(xnew, ynew, 2)
        end
        if id >= 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[id]["我方"] then
          enemynum = enemynum + 1
        end
      end
      if maxnum < enemynum then
        maxnum = enemynum
        xmax = x + CC.DirectX[direct + 1]
        ymax = y + CC.DirectY[direct + 1]
      end
    end
  elseif wugongtype == 2 then
    local enemynum = 0
    for direct = 0, 3 do
      for i = 1, movescope do
        local xnew = x + CC.DirectX[direct + 1] * i
        local ynew = y + CC.DirectY[direct + 1] * i
        if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
          local id = GetWarMap(xnew, ynew, 2)
        end
        if id >= 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[id]["我方"] then
          enemynum = enemynum + 1
        end
      end
    end
  end
  if enemynum > 0 then
    maxnum = enemynum
    xmax = x
    ymax = y
  end
  return maxnum, xmax, ymax
end


--得到可以走到攻击到敌人的最近位置。
--scope可以攻击的范围
--返回 x,y。如果无法走到攻击位置，返回空
function War_AutoCalMaxEnemyMap(wugongid, level)
  local wugongtype = JY.Wugong[wugongid]["攻击范围"]
  local movescope = JY.Wugong[wugongid]["移动范围" .. level]
  local fightscope = JY.Wugong[wugongid]["杀伤范围" .. level]
  local x0 = WAR.Person[WAR.CurID]["坐标X"]
  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
  CleanWarMap(4, 0)
  if wugongtype == 0 or wugongtype == 3 then
    for n = 0, WAR.PersonNum - 1 do
      if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
        local xx = WAR.Person[n]["坐标X"]
        local yy = WAR.Person[n]["坐标Y"]
        local movestep = War_CalMoveStep(n, movescope, 1)
        for i = 1, movescope do
          local step_num = movestep[i].num
	        if step_num == 0 then
	          
	        else
	          for j = 1, step_num do
	            SetWarMap(movestep[i].x[j], movestep[i].y[j], 4, 1)
	          end
	        end
	      end
      end
    end
  elseif wugongtype == 1 or wugongtype == 2 then
    for n = 0, WAR.PersonNum - 1 do
      if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
        local xx = WAR.Person[n]["坐标X"]
        local yy = WAR.Person[n]["坐标Y"]
        for direct = 0, 3 do
          for i = 1, movescope do
            local xnew = xx + CC.DirectX[direct + 1] * i
            local ynew = yy + CC.DirectY[direct + 1] * i
            if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
              local v = GetWarMap(xnew, ynew, 4)
              SetWarMap(xnew, ynew, 4, v + 1)
            end
          end
        end
      end
    end
  end
end

--自动医疗
function War_AutoDoctor()
  local x1 = WAR.Person[WAR.CurID]["坐标X"]
  local y1 = WAR.Person[WAR.CurID]["坐标Y"]
  War_ExecuteMenu_Sub(x1, y1, 3, -1)
end

--自动吃药
--flag=2 生命，3内力；4体力  6 解毒
function War_AutoEatDrug(flag)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local life = JY.Person[pid]["生命"]
	local maxlife = JY.Person[pid]["生命最大值"]
	local selectid = nil
	local minvalue = math.huge
	local shouldadd, maxattrib, str = nil, nil, nil
	if flag == 2 then
		maxattrib = JY.Person[pid]["生命最大值"]
		shouldadd = maxattrib - JY.Person[pid]["生命"]
		str = "加生命"
	elseif flag == 3 then
		maxattrib = JY.Person[pid]["内力最大值"]
		shouldadd = maxattrib - JY.Person[pid]["内力"]
		str = "加内力"
	elseif flag == 4 then
		maxattrib = CC.PersonAttribMax["体力"]
		shouldadd = maxattrib - JY.Person[pid]["体力"]
		str = "加体力"
	elseif flag == 6 then
		maxattrib = CC.PersonAttribMax["中毒程度"]
		shouldadd = JY.Person[pid]["中毒程度"]
		str = "加中毒解毒"
	else
		return 
	end
	local function Get_Add(thingid)
		if flag == 6 then
		  return -JY.Thing[thingid][str] / 2
		else
		  return JY.Thing[thingid][str]
		end
	end
  
	--在队
	if inteam(pid) and WAR.Person[WAR.CurID]["我方"] == true then
		local extra = 0
		for i = 1, CC.MyThingNum do
			local thingid = JY.Base["物品" .. i]
			if thingid >= 0 then
				local add = Get_Add(thingid)
				if JY.Thing[thingid]["类型"] == 3 and add > 0 then
					local v = shouldadd - add
					if v < 0 then
						extra = 1
					elseif v < minvalue then
						minvalue = v
						selectid = thingid
					end
				end
			end
		end
		if extra == 1 then
			minvalue = math.huge
			for i = 1, CC.MyThingNum do
				local thingid = JY.Base["物品" .. i]
				if thingid >= 0 then
					local add = Get_Add(thingid)
					if JY.Thing[thingid]["类型"] == 3 and add > 0 then
						local v = add - shouldadd
						if v >= 0 and v < minvalue then
							minvalue = v
							selectid = thingid
						end
					end
				end
			end
		end
		--使用物品
		if UseThingEffect(selectid, pid) == 1 then
			instruct_32(selectid, -1)
		end
	--不在队
	else
		local extra = 0
		for i = 1, 4 do
			local thingid = JY.Person[pid]["携带物品" .. i]
			local tids = JY.Person[pid]["携带物品数量" .. i]
			if thingid >= 0 and tids > 0 then
				local add = Get_Add(thingid)
				if JY.Thing[thingid]["类型"] == 3 and add > 0 then
					local v = shouldadd - add
					if v < 0 then		--可以加满生命, 用其他方法找合适药品
						extra = 1
					elseif v < minvalue then
						minvalue = v
						selectid = thingid
					end
				end
			end
		end
		if extra == 1 then
			minvalue = math.huge
			for i = 1, 4 do
				local thingid = JY.Person[pid]["携带物品" .. i]
				local tids = JY.Person[pid]["携带物品数量" .. i]
				if thingid >= 0 and tids > 0 then
					local add = Get_Add(thingid)
					if JY.Thing[thingid]["类型"] == 3 and add > 0 then
						local v = add - shouldadd
						if v >= 0 and v < minvalue then
							minvalue = v
							selectid = thingid
						end
					end
				end 
			end
		end
		--NPC使用物品
		if UseThingEffect(selectid, pid) == 1 then
			instruct_41(pid, selectid, -1)
		end
	end
	lib.Delay(500)
end

--自动逃跑
function War_AutoEscape()
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  if JY.Person[pid]["体力"] <= 5 then
    return 
  end
  local x, y = nil, nil
  War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)		 --计算移动步数
  WarDrawMap(1)
  ShowScreen()
  local array = {}
  local num = 0
  
  for i = 0, CC.WarWidth - 1 do
    for j = 0, CC.WarHeight - 1 do
      if GetWarMap(i, j, 3) < 128 then
        local minDest = math.huge
        for k = 0, WAR.PersonNum - 1 do
          if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[k]["我方"] and WAR.Person[k]["死亡"] == false then
            local dx = math.abs(i - WAR.Person[k]["坐标X"])
            local dy = math.abs(j - WAR.Person[k]["坐标Y"])
	          if dx + dy < minDest then		--计算当前距离敌人最近的位置
	            minDest = dx + dy
	          end
          end
        end
        num = num + 1
        array[num] = {}
        array[num].x = i
        array[num].y = j
        array[num].p = minDest
      end
    end
  end
  
  for i = 1, num - 1 do
    for j = i, num do
      if array[i].p < array[j].p then
        array[i], array[j] = array[j], array[i]
      end
    end
  end
  for i = 2, num do
    if array[i].p < array[1].p / 2 then
      num = i - 1
      break;
    end
  end
  for i = 1, num do
    array[i].p = array[i].p * 5 + GetMovePoint(array[i].x, array[i].y, 1)
  end
  for i = 1, num - 1 do
    for j = i, num do
      if array[i].p < array[j].p then
        array[i], array[j] = array[j], array[i]
      end
    end
  end
  x = array[1].x
  y = array[1].y

  War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
  War_MovePerson(x, y)	--移动到相应的位置
end


--自动执行战斗，此时的位置一定可以打到敌人
function War_AutoExecuteFight(wugongnum)
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  local x0 = WAR.Person[WAR.CurID]["坐标X"]
  local y0 = WAR.Person[WAR.CurID]["坐标Y"]
  local wugongid = JY.Person[pid]["武功" .. wugongnum]
  local level = math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1
  local maxnum, x, y = War_AutoCalMaxEnemy(x0, y0, wugongid, level)
  if x ~= nil then
    War_Fight_Sub(WAR.CurID, wugongnum, x, y)
    WAR.Person[WAR.CurID].Action = {"atk", x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
  end
end

--自动战斗
function War_AutoMenu()
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	WAR.AutoFight = 1
	WAR.ShowHead = 0
	Cls()
	if JY.Person[pid]["禁用自动"] == 1 then
		return 0
	else
		War_Auto()
		return 1
	end
end

--计算可移动步数
--id 战斗人id，
--stepmax 最大步数，
--flag=0  移动，物品不能绕过，1 武功，用毒医疗等，不考虑挡路。
function War_CalMoveStep(id, stepmax, flag)
  CleanWarMap(3, 255)
  local x = WAR.Person[id]["坐标X"]
  local y = WAR.Person[id]["坐标Y"]
  local steparray = {}
  for i = 0, stepmax do
    steparray[i] = {}
    steparray[i].bushu = {}
    steparray[i].x = {}
    steparray[i].y = {}
  end
  SetWarMap(x, y, 3, 0)
  steparray[0].num = 1
  steparray[0].bushu[1] = stepmax
  steparray[0].x[1] = x
  steparray[0].y[1] = y
  War_FindNextStep(steparray, 0, flag, id)
  return steparray
end

--判断x,y是否为可移动位置
function War_CanMoveXY(x, y, flag)
  if GetWarMap(x, y, 1) > 0 then
    return false
  end
  if flag == 0 then
    if CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
      return false
    end
    if GetWarMap(x, y, 2) >= 0 then
    	return false
  	end
  end
  return true
end

--解毒菜单
function War_DecPoisonMenu()
	WAR.ShowHead = 0
	local r = War_ExecuteMenu(2)
	WAR.ShowHead = 1
	Cls()
	return r
end

--判断攻击后面对的方向
function War_Direct(x1, y1, x2, y2)
	local x = x2 - x1
	local y = y2 - y1
	if x == 0 and y == 0 then
		return WAR.Person[WAR.CurID]["人方向"]
	end
	if math.abs(x) < math.abs(y) then
		if y > 0 then
			return 3
		else
			return 0
		end
	else 
		if x > 0 then
			return 1
		else
			return 2
		end
	end
end

--医疗菜单
function War_DoctorMenu()
	WAR.ShowHead = 0
	local r = War_ExecuteMenu(3)
	WAR.ShowHead = 1
	Cls()
	return r
end

---执行医疗，解毒用毒
---flag=1 用毒， 2 解毒，3 医疗 4 暗器
---thingid 暗器物品id
function War_ExecuteMenu(flag, thingid)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local step = nil
	local sts =  nil
	if flag == 1 then
		step = math.modf((JY.Person[pid]["用毒能力"]+ MPAttrib(pid, 5)) / 40)
	elseif flag == 2 then
		step = math.modf((JY.Person[pid]["解毒能力"]+ MPAttrib(pid, 6))/ 40)
	elseif flag == 3 then
		step = math.modf((JY.Person[pid]["医疗能力"]+ MPAttrib(pid, 4)) / 40)
	elseif flag == 4 then
		step = math.modf((JY.Person[pid]["暗器技巧"]+ MPAttrib(pid, 7))/ 15) + 1
	end
	War_CalMoveStep(WAR.CurID, step, 1)
	--增加部分人物的7*7显示
	if pid == 0 and JY.Base["标准"] == 8 and flag == 3 then
		sts = 1
	elseif pid == 0 and JY.Base["标准"] == 9 and flag == 1 then 
		sts = 1
	elseif match_ID(pid, 83) and flag == 4 then 
		sts = 1
	end
	local x1, y1 = War_SelectMove(sts)
	if x1 == nil then
		lib.GetKey()
		Cls()
		return 0
	else
	if WAR.LMC == 1 then----
	WAR.YTJS[pid]={x1, y1}
	end
	if WAR.YFZ3[pid]~=nil then
	WAR.YTJS[pid]={x1, y1}
	end
		return War_ExecuteMenu_Sub(x1, y1, flag, thingid)
	end
end

--选择武功的函数，手动和AI都经过这里
function War_FightSelectType(movefanwei, atkfanwei, x, y,wugong)
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	if x == nil and y == nil then
		x, y = War_KfMove(movefanwei, atkfanwei,wugong)
		if x == nil then
			lib.GetKey()
			Cls()
			return 
		end
	--无酒不欢：AI也显示选择范围
	else
		WarDrawAtt(x, y, atkfanwei, 4)
		WarDrawMap(1, x, y)
		ShowScreen()
		--张无忌逆转乾坤
		if JY.Person[614]["品德"] == 90 then
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			CurIDTXDH(WAR.CurID, 114,1,"逆转乾坤",C_ORANGE);
			WAR.CurID = z
			local ori_x, ori_y = x, y
			local min_x, min_y,max_x, max_y = x-2, y-2, x+2, y+2
			Cls()
			CleanWarMap(3, 255)
			local ssx = 0
			for i = min_x+1, max_x-1 do
				for j = min_y+1, max_y-1 do
					SetWarMap(i, j, 3, 0)
				end
			end
			SetWarMap(min_x, y, 3, 0)
			SetWarMap(max_x, y, 3, 0)
			SetWarMap(x, min_y, 3, 0)
			SetWarMap(x, max_y, 3, 0)
			WarDrawMap(1, x, y)
			ShowScreen()
			while true do
				if JY.Restart == 1 then
					break
				end
				local key, ktype, mx, my = WaitKey(1)
				if key == VK_UP then
					if (y > min_y + 1 and x > min_x and x < max_x) or (x == ori_x and y > min_y) then
						y = y - 1
					end
				elseif key == VK_DOWN then
					if (y < max_y - 1 and x > min_x and x < max_x) or (x == ori_x and y < max_y) then
						y = y + 1
					end
				elseif key == VK_LEFT then
					if (x > min_x + 1 and y > min_y and y < max_y) or (y == ori_y and x > min_x) then
						x = x - 1
					end
				elseif key == VK_RIGHT then
					if (x < max_x - 1 and y > min_y and y < max_y) or (y == ori_y and x < max_x) then
						x = x + 1
					end
				elseif key == VK_ESCAPE then
					x, y = ori_x, ori_y
					WAR.NZQK = 1
					CleanWarMap(7, 0)
					WarDrawAtt(x, y, atkfanwei, 4)
					WarDrawMap(1, x, y)
					ShowScreen()
					break
				elseif (key == VK_SPACE or key == VK_RETURN) then
					--内力大于等于300才能使用
					if JY.Person[0]["内力"] >= 300 then
						JY.Person[0]["内力"] = JY.Person[0]["内力"] - 300
						WAR.NZQK = 2
						break
					else
						x, y = ori_x, ori_y
						WAR.NZQK = 1
						CleanWarMap(7, 0)
						WarDrawAtt(x, y, atkfanwei, 4)
						WarDrawMap(1, x, y)
						ShowScreen()
						break
					end
				end
				CleanWarMap(7, 0)
				WarDrawAtt(x, y, atkfanwei, 4)
				WarDrawMap(1, x, y)
				ShowScreen()
			end
			JY.Person[614]["品德"] = 80
		end
		--主角，迷踪步躲避攻击
		if JY.Person[606]["品德"] == 90 then
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			CurIDTXDH(WAR.CurID, 129,1,"迷踪步",Violet);
		
			WAR.Person[WAR.CurID]["移动步数"] = 6
			War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
			local x, y = nil, nil
			while 1 do
				if JY.Restart == 1 then
					break
				end
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
			WAR.CurID = z
			JY.Person[606]["品德"] = 80
		end
--小昭影步
		if JY.Person[66]["品德"] == 90 then
			JY.Person[66]["品德"] = 50
			if WAR.XZ_YB[1] ~= nil then
				local z = WAR.CurID
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
						WAR.CurID = j
						break
					end
				end
				Cls()
				WarDrawMap(0)
				CurIDTXDH(WAR.CurID, 122,1, "接引离斯毒火海", C_RED)
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
				WarDrawMap(0)
				WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = WAR.XZ_YB[1], WAR.XZ_YB[2]
				WarDrawMap(0)
				CurIDTXDH(WAR.CurID, 122,1, "幻光游世常自在", C_RED)
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
				lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
				WarDrawMap(0)
				WAR.XZ_YB[1]=nil
				WAR.XZ_YB[2]=nil
				WAR.CurID = z
			end
		end
		CleanWarMap(7,0)
		lib.Delay(200)
	end
	--郭靖，北斗罡步躲避攻击
		if JY.Person[55]["品德"] == 80  then
		   JY.Person[55]["品德"] = 70
           if WAR.BDGB == 1 then		   
			local z = WAR.CurID
			for j = 0, WAR.PersonNum - 1 do
				if match_ID_awakened(WAR.Person[j]["人物编号"],55,1) and 0 < JY.Person[WAR.Person[j]["人物编号"]]["生命"] then
					WAR.CurID = j
					break
				end
			end
			Cls()
			CurIDTXDH(WAR.CurID, 129,1,"北斗罡步",Violet);
		    WAR.TZNQ2[WAR.CurID] = (WAR.TZNQ2[WAR.CurID] or 0) +20
			WAR.Person[WAR.CurID]["移动步数"] = 6
			if inteam(WAR.Person[WAR.CurID]["人物编号"]) then
			War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
			local x, y = nil, nil
			while 1 do
				if JY.Restart == 1 then
					break
				end
				x, y = War_SelectMove()
				if x ~= nil then
					WAR.ShowHead = 0
					War_MovePerson(x, y)
					break;
				end
			end
			else
			War_AutoEscape()
			end
			WAR.Person[WAR.CurID]["反击武功"] = 26
			WAR.CurID = z
			WAR.GBGJ = -1
			end
		end
	if not War_Direct(x0, y0, x, y) then
		WAR.Person[WAR.CurID]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
	else
		WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x, y)
	end
	SetWarMap(x, y, 4, 1)
	WAR.EffectXY = {}
	return x, y
end

--设置下一步可移动的坐标
function War_FindNextStep(steparray, step, flag, id)
	local num = 0
	local step1 = step + 1
  
	--ZOC判定
	local fujinnum = function(tx, ty)
		if flag ~= 0 or id == nil then
			return 0
		end
		local tnum = 0
		local wofang = WAR.Person[id]["我方"]
		local tv = nil
		tv = GetWarMap(tx + 1, ty, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 9999
		end
		tv = GetWarMap(tx - 1, ty, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 999
		end
		tv = GetWarMap(tx, ty + 1, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 999
		end
		tv = GetWarMap(tx, ty - 1, 2)
		if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
			tnum = 999
		end
		return tnum
	end
  
  for i = 1, steparray[step].num do
    if steparray[step].bushu[i] > 0 then
      steparray[step].bushu[i] = steparray[step].bushu[i] - 1
      local x = steparray[step].x[i]
      local y = steparray[step].y[i]
      if x + 1 < CC.WarWidth - 1 then
        local v = GetWarMap(x + 1, y, 3)
        if v == 255 and War_CanMoveXY(x + 1, y, flag) == true then
	        num = num + 1
	        steparray[step1].x[num] = x + 1
	        steparray[step1].y[num] = y
	        SetWarMap(x + 1, y, 3, step1)
	        steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x + 1, y)
      	end
      end
      
      if x - 1 > 0 then
        local v = GetWarMap(x - 1, y, 3)
        if v == 255 and War_CanMoveXY(x - 1, y, flag) == true then
	        num = num + 1
	        steparray[step1].x[num] = x - 1
	        steparray[step1].y[num] = y
	        SetWarMap(x - 1, y, 3, step1)
	        steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x - 1, y)
	      end
      end
      
      if y + 1 < CC.WarHeight - 1 then
        local v = GetWarMap(x, y + 1, 3)
        if v == 255 and War_CanMoveXY(x, y + 1, flag) == true then
	        num = num + 1
	        steparray[step1].x[num] = x
	        steparray[step1].y[num] = y + 1
	        SetWarMap(x, y + 1, 3, step1)
	        steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x, y + 1)
	      end
      end
      
      if y - 1 > 0 then
	      local v = GetWarMap(x, y - 1, 3)
	      if v == 255 and War_CanMoveXY(x, y - 1, flag) == true then
		      num = num + 1
		      steparray[step1].x[num] = x
		      steparray[step1].y[num] = y - 1
		      SetWarMap(x, y - 1, 3, step1)
		      steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x, y - 1)
	    	end
    	end
    end
  end
  if num == 0 then
    return 
  end
  steparray[step1].num = num
  War_FindNextStep(steparray, step1, flag, id)
end

--判断是否能打到敌人
function War_GetCanFightEnemyXY()
	local num, x, y = nil, nil, nil
	num, x, y = War_realjl(WAR.CurID)
	if num == -1 then
		return 
	end
	return x, y
end

--移动
function War_MoveMenu()
  if WAR.Person[WAR.CurID]["人物编号"] ~= -1 then
    WAR.ShowHead = 0
    if WAR.Person[WAR.CurID]["移动步数"] <= 0 then
      return 0
    end
    War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
    local r = nil
    local x, y = War_SelectMove()
    if x ~= nil then
      War_MovePerson(x, y, 1)
      r = 1
    else
      r = 0
      WAR.ShowHead = 1
      Cls()
    end
    lib.GetKey()
    return r
  else
    local ydd = {}
    local n = 1
    for i = 0, WAR.PersonNum - 1 do
      if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
        ydd[n] = i
        n = n + 1
      end
    end
    local dx = ydd[math.random(n - 1)]
    local DX = WAR.Person[dx]["坐标X"]
    local DY = WAR.Person[dx]["坐标Y"]
    local YDX = {DX + 1, DX - 1, DX}
    local YDY = {DY + 1, DY - 1, DY}
    local ZX = YDX[math.random(3)]
    local ZY = YDY[math.random(3)]
    if not SceneCanPass(ZX, ZY) or GetWarMap(ZX, ZY, 2) < 0 then
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
      WAR.Person[WAR.CurID]["坐标X"] = ZX
      WAR.Person[WAR.CurID]["坐标Y"] = ZY
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
      SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
    end
  end
  return 1
end

--人物移动
function War_MovePerson(x, y, flag)
  local x1 = x
  local y1 = y
  if not flag then
    flag = 0
  end
  local movenum = GetWarMap(x, y, 3)
  local movetable = {}
  for i = movenum, 1, -1 do
    movetable[i] = {}
    movetable[i].x = x
    movetable[i].y = y
    if GetWarMap(x - 1, y, 3) == i - 1 then
      x = x - 1
      movetable[i].direct = 1
    elseif GetWarMap(x + 1, y, 3) == i - 1 then
      x = x + 1
      movetable[i].direct = 2
    elseif GetWarMap(x, y - 1, 3) == i - 1 then
      y = y - 1
      movetable[i].direct = 3
    elseif GetWarMap(x, y + 1, 3) == i - 1 then
      y = y + 1
      movetable[i].direct = 0
    end
  end
	--减少移动步数
	movetable.num = movenum
	movetable.now = 0
	WAR.Person[WAR.CurID].Move = movetable
	if WAR.Person[WAR.CurID]["移动步数"] < movenum then
		movenum = WAR.Person[WAR.CurID]["移动步数"]
		WAR.Person[WAR.CurID]["移动步数"] = 0
	else
		WAR.Person[WAR.CurID]["移动步数"] = WAR.Person[WAR.CurID]["移动步数"] - movenum
	end
	WAR.XKZ=movenum
	--移动人物
	--标主的特殊显示
	--七夕龙女的论剑奖励代表是否学有迷踪步
	if WAR.Person[WAR.CurID]["人物编号"] == 0 and JY.Base["标准"] > 0 and JY.Person[615]["论剑奖励"] == 1 and movenum > 2 then
		local a = 0
		local gender = 0
		if JY.Person[0]["性别"] > 0 then
			gender = 1
		end
		for i = 1, movenum do
			local t1 = lib.GetTime()
			if a == 6 then
				a = 0
			end
			if i == 1 then
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
				SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
			end
			if i > 3 then
				SetWarMap(movetable[i-3].x, movetable[i-3].y, 2, -1)
				SetWarMap(movetable[i-3].x, movetable[i-3].y, 5, -1)
			end
			if i == movenum then
				SetWarMap(movetable[i-2].x, movetable[i-2].y, 2, -1)
				SetWarMap(movetable[i-2].x, movetable[i-2].y, 5, -1)
				SetWarMap(movetable[i-1].x, movetable[i-1].y, 2, -1)
				SetWarMap(movetable[i-1].x, movetable[i-1].y, 5, -1)
			end
			WAR.Person[WAR.CurID]["坐标X"] = movetable[i].x
			WAR.Person[WAR.CurID]["坐标Y"] = movetable[i].y
			WAR.Person[WAR.CurID]["人方向"] = movetable[i].direct
			if i < movenum then
				WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic2(WAR.CurID, gender) + (a)*2
			else
				WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
			end
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
			WarDrawMap(0)
			ShowScreen()
			a = a + 1
			local t2 = lib.GetTime()
			if i < movenum and t2 - t1 < CC.BattleDelay then
			  lib.Delay(CC.BattleDelay - (t2 - t1))
			end
		end
	else
		for i = 1, movenum do
			local t1 = lib.GetTime()
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
			WAR.Person[WAR.CurID]["坐标X"] = movetable[i].x
			WAR.Person[WAR.CurID]["坐标Y"] = movetable[i].y
			WAR.Person[WAR.CurID]["人方向"] = movetable[i].direct
			WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
			SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
			WarDrawMap(0)
			ShowScreen()
			local t2 = lib.GetTime()
			if i < movenum and t2 - t1 < 2 * CC.BattleDelay then
			  lib.Delay(2 * CC.BattleDelay - (t2 - t1))
			end
		end
	end
	--主运轻功的话遇到ZOC移动不清0，反之清0
	if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["主运轻功"] == 0 then
		local fujinnum = function(tx, ty)
			local tnum = 0
			local wofang = WAR.Person[WAR.CurID]["我方"]
			local tv = nil
			tv = GetWarMap(tx + 1, ty, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			tv = GetWarMap(tx - 1, ty, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			tv = GetWarMap(tx, ty + 1, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			tv = GetWarMap(tx, ty - 1, 2)
			if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
				tnum = 999
			end
			return tnum
		end
		if fujinnum(WAR.Person[WAR.CurID]["坐标X"],WAR.Person[WAR.CurID]["坐标Y"]) ~= 0 then
			WAR.Person[WAR.CurID]["移动步数"] = 0
		end
	end
end

---用毒菜单
function War_PoisonMenu()
	WAR.ShowHead = 0
	local r = War_ExecuteMenu(1)
	WAR.ShowHead = 1
	Cls()
	return r
end

--战斗休息
function War_RestMenu()
	if WAR.CurID and WAR.CurID >= 0  then
		local pid = WAR.Person[WAR.CurID]["人物编号"]
		--走火不能休息
		if WAR.tmp[1000 + pid] == 1 then
			return 1
		end
		local vv = math.modf(JY.Person[pid]["体力"] / 100 - JY.Person[pid]["受伤程度"] / 50 - JY.Person[pid]["中毒程度"] / 50) + 2
		if WAR.Person[WAR.CurID]["移动步数"] > 0 then
			vv = vv + 2
		end
		if inteam(pid) then
			vv = vv + math.random(3)
		else
			vv = vv + 6
		end
		vv = (vv) / 120
		if WAR.LUCK[pid]~=nil then----
		vv=vv*math.random(2,5)
		end
		if WAR.UNLUCK[pid]~=nil then----
		vv=0
		end
		if WAR.QXPZ==1 then----
		vv=vv*math.random(3,4)
		end
		if nglw(pid,100)>1 then----
		vv=vv*math.random(3,4)
		end
		if WAR.YZSG[pid]~=nil then
		vv = math.modf(vv*0.5)
		end
		local v = 3 + Rnd(3)
		if WAR.QXPZ==1 then----
		v=v*math.random(2,3)
		end
		if WAR.YZSG[pid]~=nil then
		v = math.modf(v*0.5)
		  if WAR.YZSY[pid]~=nil then
		  v = -v
		  end
		end
    if WAR.LXZT[pid]~=nil and WAR.LXZT[pid]>=25 and JY.Person[pid]["生命"] < math.modf(0.2*JY.Person[pid]["生命最大值"])  then
vv=vv*math.random(3,4)
  end
		WAR.Person[WAR.CurID]["体力点数"] = AddPersonAttrib(pid, "体力", v)
		if JY.Person[pid]["体力"] > 0 then
			v = 3 + math.modf(JY.Person[pid]["生命最大值"] / JY.Person[pid]["血量翻倍"] * (vv))
			WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", v)
			v = 3 + math.modf(JY.Person[pid]["内力最大值"] * (vv))
			WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(pid, "内力", v)
		end
		if WAR.YZSG[pid]~=nil and WAR.YZSY[pid]~=nil  then
		local a = -math.modf(JY.Person[pid]["中毒程度"] * 1.5)
		WAR.Person[WAR.CurID]["生命点数"] = WAR.Person[WAR.CurID]["生命点数"]+AddPersonAttrib(pid, "生命", a)
		end
		War_Show_Count(WAR.CurID);		--显示当前控制人的点数
		

		if wglw(pid,74)>=1 and WAR.SHJG[pid]~=nil then
		CurIDTXDH(WAR.CurID, 64, 1);
		DrawStrBox(-1, -1, "鹤蛇咏春.攻守互换", C_GOLD, CC.DefaultFont)
		if WAR.SHJG[pid] == 2 then
		WAR.SHJG[pid] = 1
		elseif WAR.SHJG[pid] == 1 then
		WAR.SHJG[pid] = 2
		end
		ShowScreen()
		lib.Delay(400)
	    end

		if wglw(pid,68)>=1 and WAR.YJQS[pid]~=nil then
		CurIDTXDH(WAR.CurID, 64, 1);
		DrawStrBox(-1, -1, "九转枪影.缥缈无踪", C_GOLD, CC.DefaultFont)
		if WAR.YJQS[pid] == 2 then
		WAR.YJQS[pid] = 1
		elseif WAR.YJQS[pid] == 1 then
		WAR.YJQS[pid] = 2
		end
		ShowScreen()
		lib.Delay(400)
	    end

        if WAR.LSDZ[pid] ~= nil then
        CurIDTXDH(WAR.CurID, 64, 1);
		DrawStrBox(-1, -1, "罗刹.阵势流转", C_GOLD, CC.DefaultFont)
		WAR.LSDZ[pid] = WAR.LSDZ[pid] + 1
		local aa = wglw(pid,51)*2
		if aa>6 then
		aa = 6
		end
		  if WAR.LSDZ[pid] >aa then
		  WAR.LSDZ[pid] = 1
		  end
		  if wglw(pid,51)>=2 then
		  WAR.GSSL[pid] = WAR.LSDZ[pid]
		  DrawStrBox(-1, -1, "鬼神敕令.圣魔凭依", C_GOLD, CC.DefaultFont)
		  end		  
		end
		
		--阿凡提休息带蓄力+防御
		if match_ID(pid, 606) then
			Cls()
			WAR.Actup[pid] = 2;
			WAR.Defup[pid] = 1
			CurIDTXDH(WAR.CurID, 85,1);
			DrawStrBox(-1, -1, "运筹帷幄·决胜千里", LimeGreen, CC.DefaultFont,C_GOLD)
			ShowScreen()
			lib.Delay(400)
			return 1;	
		--NPC休息会自动蓄力
		--先天调息不触发
		elseif not inteam(pid) and WAR.XTTX == 0 then
			if math.modf(JY.Person[pid]["生命最大值"] / 2) < JY.Person[pid]["生命"] then
				Cls()
				return War_ActupMenu()
			else
				Cls()
				return War_DefupMenu()
			end
		else
			return 1
		end
	end
end

--战斗查看状态
function War_StatusMenu()
	WAR.ShowHead = 0
	Menu_Status()
	WAR.ShowHead = 1
	Cls()
end

--战斗物品菜单
function War_ThingMenu()
	WAR.ShowHead = 0
	local thing = {}
	local thingnum = {}
	for i = 0, CC.MyThingNum - 1 do
		thing[i] = -1
		thingnum[i] = 0
	end
	local num = 0
	for i = 0, CC.MyThingNum - 1 do
		local id = JY.Base["物品" .. i + 1]
		if id >= 0 and (JY.Thing[id]["类型"] == 1 or JY.Thing[id]["类型"] == 3 or JY.Thing[id]["类型"] == 4) then
			thing[num] = id
			thingnum[num] = JY.Base["物品数量" .. i + 1]
			num = num + 1
		end
	end
	local r = SelectThing(thing, thingnum)
	Cls()
	local rr = 0
	if r >= 0 and UseThing(r) == 1 then
		rr = 1
	end
	WAR.ShowHead = 1
	Cls()
	return rr
end


--自动战斗判断是否能医疗
function War_ThinkDoctor()
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["医疗能力"] < 20 then
    return -1
  end
  if JY.Person[pid]["医疗能力"] + 20 < JY.Person[pid]["受伤程度"] then
    return -1
  end
  local rate = -1
  local v = JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"]
  if JY.Person[pid]["医疗能力"] < v / 4 then
    rate = 30
  elseif JY.Person[pid]["医疗能力"] < v / 3 then
      rate = 50
  elseif JY.Person[pid]["医疗能力"] < v / 2 then
      rate = 70
  else
    rate = 90
  end
  if Rnd(100) < rate then
    return 5
  end
  return -1
end

--能否吃药增加参数
--flag=2 生命，3内力；4体力  6 解毒
function War_ThinkDrug(flag)
  local pid = WAR.Person[WAR.CurID]["人物编号"]
  local str = nil
  local r = -1
  if flag == 2 then
    str = "加生命"
  elseif flag == 3 then
    str = "加内力"
  elseif flag == 4 then
    str = "加体力"
  elseif flag == 6 then
    str = "加中毒解毒"
  else
    return r
  end
  local function Get_Add(thingid)
    if flag == 6 then
      return -JY.Thing[thingid][str]
    else
      return JY.Thing[thingid][str]
    end
  end
  
  --身上是否有药品
  if inteam(pid) and WAR.Person[WAR.CurID]["我方"] == true then
    for i = 1, CC.MyThingNum do
      local thingid = JY.Base["物品" .. i]
      if thingid >= 0 and JY.Thing[thingid]["类型"] == 3 and Get_Add(thingid) > 0 then
        r = flag
        break;
      end
    end
  else
    for i = 1, 4 do
      local thingid = JY.Person[pid]["携带物品" .. i]
      if thingid >= 0 and JY.Thing[thingid]["类型"] == 3 and Get_Add(thingid) > 0 then
        r = flag
        break;
      end
    end
  end
  return r
end

--使用暗器
function War_UseAnqi(id)
	return War_ExecuteMenu(4, id)
end

--初始化战斗数据
function WarLoad(warid)
	WarSetGlobal()
	local data = Byte.create(CC.WarDataSize)
	Byte.loadfile(data, CC.WarFile, warid * CC.WarDataSize, CC.WarDataSize)
	LoadData(WAR.Data, CC.WarData_S, data)
	WAR.ZDDH = warid
end

--加载战斗地图
function WarLoadMap(mapid)
	lib.Debug(string.format("load war map %d", mapid))
	lib.LoadWarMap(CC.WarMapFile[1], CC.WarMapFile[2], mapid, 8, CC.WarWidth, CC.WarHeight)
end


function GetWarMap(x, y, level)
	if x > 63 or x < 0 or y > 63 or y < 0 then
		return 
	end
	return lib.GetWarMap(x, y, level)
end

function SetWarMap(x, y, level, v)
	if x > 63 or x < 0 or y > 63 or y < 0 then
		return 
	end
	lib.SetWarMap(x, y, level, v)
end

function CleanWarMap(level, v)
	lib.CleanWarMap(level, v)
end

--设置人物贴图
function WarSetPerson()
	CleanWarMap(2, -1)
	CleanWarMap(5, -1)
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 2, i)
			SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 5, WAR.Person[i]["贴图"])
		end
	end
end

--显示武功动画，人物受伤动画，音效等
function War_ShowFight(pid, wugong, wugongtype, level, x, y, eft, ZHEN_ID)
	--攻击时不显示血条
	WAR.ShowHP = 0
	
	--没有合击
	if not ZHEN_ID then
		ZHEN_ID = -1
	end
	
	--内功
	if wugongtype == 6 then
		wugongtype = WAR.NGXS
	end
	
	--无酒不欢：设置一下新的动画顺序
	if wugongtype == 2 then
		wugongtype = 1
	elseif wugongtype > 2 and wugongtype < 6 then
		wugongtype = wugongtype - 1
	end
  
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	local starteft = 0

	
	if pid > -1 then	
	local using_anqi = 0
	local anqi_name;
	--暗器动画
	if wugongtype == -1 then
		using_anqi = 1
		anqi_name = JY.Thing[eft]["名称"]
		--何铁手含沙射影
		if match_ID(pid, 83) then
			anqi_name = "含沙射影·"..anqi_name
		end
		eft = JY.Thing[eft]["暗器动画编号"]
	end
	
	--扫地老僧  随机动画
	if match_ID(pid, 114) then
		eft = math.random(100)
	end
	
	--黯然极意动画
	if wugong == 25 and WAR.ARJY == 1 then
		eft = 7
	end
	
	--金蛇奥义动画
	if wugong == 40 and WAR.JSAY == 1 then
		eft = 44
	end

	if wugong == 17 and WAR.QJJQ == 1 then
		eft = 38
	end	
	
	--进阶万花
	if wugong == 30 and nglw(pid, 89)>=1 then
		eft = 99
	end
	--进阶泰山
	if wugong == 31 and nglw(pid, 89)>=1 then
		eft = 98
	end
	--进阶云雾
	if wugong == 32 and nglw(pid, 89)>=1 then
		eft = 97
	end
	--进阶万岳
	if wugong == 33 and nglw(pid, 89)>=1 then
		eft = 96
	end
	--进阶太岳
	if wugong == 34 and nglw(pid, 89)>=1 then
		eft = 95
	end
	
	--无酒不欢的特效动画
	if pid == 0 and JY.Base["特殊"] == 1 then
		eft = 65
	end
	
	local ex, ey = -1, -1;
	local px = 0
	local py = 0
	
	--测试动画
	--eft = 110;
	
	--主角有几率出随机动画
	if pid == 0 and GetS(53, 0, 4, 5) == 1 and JLSD(0,30,pid)  then
		eft = 110;
	end
	
	--指定XY，那么只显示在一个点显示动画
	if eft == 110 then
		ex, ey = x, y;
	end

	if eft == 181 then
		ex, ey =x-325*CC.YScale, y-236*CC.YScale
	end

	if eft == 180 then
		ex, ey =x-325*CC.YScale, y-500*CC.YScale
	end

	if eft == 182 then
		ex, ey =x-325*CC.YScale, y-500*CC.YScale
	end

     if eft ==  179 then
		 py = CC.YScale * 23
		 px = CC.YScale * 0
	 end

     if eft ==  184 then
		 py = CC.YScale * 23
		 px = CC.YScale * 0
	 end

     if eft ==  171 then
		 py = CC.YScale * 23
		 px = CC.YScale * 0
	 end
	
	--六脉神剑的类型设置为拳法
	if wugong == 49 then
		wugongtype = 1
	end
  
	--合击动画
	local ZHEN_pid, ZHEN_type, ZHEN_startframe, ZHEN_fightframe = nil, nil, nil, nil
	if ZHEN_ID >= 0 then
		ZHEN_pid = WAR.Person[ZHEN_ID]["人物编号"]
		ZHEN_type = wugongtype
		ZHEN_startframe = 0
		ZHEN_fightframe = 0
	end
  
	local fightdelay, fightframe, sounddelay = nil, nil, nil
	if wugongtype >= 0 then
		fightdelay = JY.Person[pid]["出招动画延迟" .. wugongtype + 1]
		fightframe = JY.Person[pid]["出招动画帧数" .. wugongtype + 1]
		sounddelay = JY.Person[pid]["武功音效延迟" .. wugongtype + 1]
	else
		fightdelay = 0
		fightframe = -1
		sounddelay = -1
	end
  
	if fightdelay == 0 or fightframe == 0 then
		for i = 1, 5 do
			if JY.Person[pid]["出招动画帧数" .. i] ~= 0 then
				fightdelay = JY.Person[pid]["出招动画延迟" .. i]
				fightframe = JY.Person[pid]["出招动画帧数" .. i]
				sounddelay = JY.Person[pid]["武功音效延迟" .. i]
				wugongtype = i - 1
			end
		end
	end

	if ZHEN_ID >= 0 then
		if JY.Person[ZHEN_pid]["出招动画帧数" .. ZHEN_type + 1] == 0 then
			for i = 1, 5 do
				if JY.Person[ZHEN_pid]["出招动画帧数" .. i] ~= 0 then
					ZHEN_type = i - 1
					ZHEN_fightframe = JY.Person[ZHEN_pid]["出招动画帧数" .. i]
				end
			end
		else
			ZHEN_fightframe = JY.Person[ZHEN_pid]["出招动画帧数" .. ZHEN_type + 1]
		end
	end
  
	local framenum = fightdelay + CC.Effect[eft]
	local startframe = 0
	if wugongtype >= 0 then
		for i = 0, wugongtype - 1 do
			startframe = startframe + 4 * JY.Person[pid]["出招动画帧数" .. i + 1]
		end
	end
	if ZHEN_ID >= 0 and ZHEN_type >= 0 then
		for i = 0, ZHEN_type - 1 do
			ZHEN_startframe = ZHEN_startframe + 4 * JY.Person[ZHEN_pid]["出招动画帧数" .. i + 1]
		end
	end
  
	for i = 0, eft - 1 do
		starteft = starteft + CC.Effect[i]
	end

	WAR.Person[WAR.CurID]["贴图类型"] = 0
	WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
	if ZHEN_ID >= 0 then
		WAR.Person[ZHEN_ID]["贴图类型"] = 0
		WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
	end  
  

  
	local oldpic = WAR.Person[WAR.CurID]["贴图"] / 2		--当前贴图的位置
	local oldpic_type = 0
	local oldeft = -1
	local kfname = JY.Wugong[wugong]["名称"]
	local kfname2 = nil
	local kfname3 = nil
	local kfcolor = C_GOLD
	local kfcolor2 = C_GOLD
	local kfcolor3 = C_GOLD
	local showsize = CC.FontBig
	local showx = CC.ScreenW / 2 - showsize * string.len(kfname) / 4
	local hb = GetS(JY.SubScene, x0, y0, 4)

  
	--显示武功，放到特效文字4
	if wugong ~= 0 then
		if WAR.LHQ_BNZ == 1 then
			kfname = "般若掌"
		end

		if WAR.JGZ_DMZ == 1 then
			kfname = "达摩掌"
		end
		if WAR.WD_CLSZ >= 1 then
			kfname = "赤练神掌"
			if match_ID_awakened(pid,54,1) and JY.Person[54]["论剑奖励"] == 1 then
			kfname = "秘剑.金蛇吐信"
			end
			kfcolor = LightGreen
		end
		if WAR.BXJY >= 1 then
		   kfname = "碧血."..kfname
		   kfcolor = M_RED
		end
		if WAR.JGHJ == 22 then
		   kfname = "化境.金刚般若掌"
		end
		if WAR.JGHJ == 135 then
		   kfname = "化境.大力金刚指"
		end
		if WAR.JGHJ == 15 then
		   kfname2 = "化境.灵光波动拳"
		end
		if WAR.SZH == 1 then
		   kfname2 = "化境.闪电光速拳"
		end
		if WAR.SZH2 == 1 then
		   kfname2 = "化境.兽皇光速拳"
		end
		if WAR.JGHJ == 115 then
		   kfname2 = "化境.落花心印掌"
		end
		if WAR.JGHJ == 90 then
		   kfname2 = "破玉拳"
		   kfcolor2 = M_Blue
		end
		if WAR.JGHJ == 333 then
		   kfname = "气剑冲霄."..kfname
		   kfcolor = M_Yellow
		end
		if WAR.RWZ == 61 then
		   kfname2 = "日纹掌"
		   kfcolor2 = M_Red
		end
		if WAR.WDZ == 62 then
		   kfname2 = "午刀.一斩"
		   kfcolor2 = M_Red
		end


	    if WAR.LHQ_FM  == 1 then		--伏虎罗汉拳 伤害+70
           kfname = "化境.伏虎罗汉拳"
	    end	
		if WAR.LHQ_WX >= 1 then
		    local wxq = {"崩劲","横练","穿心","劈山","炮杀"}
			local cl = {M_LemonChiffon,M_DarkOrange,M_SeaGreen,M_Yellow,M_RED}
			kfname2 = "拳意."..wxq[WAR.LHQ_WX]
			kfcolor2 = cl[WAR.LHQ_WX]
		end
		if WAR.LHQ_WX1 >= 1 then
		    local wxq = {"金豪拳","缚龙柱","困马桩","开天斧","雷烟炮"}
			local cl = {M_LemonChiffon,M_DarkOrange,M_SeaGreen,M_Yellow,M_RED}
			kfname3 = "以炁化形."..wxq[WAR.LHQ_WX1]
			kfcolor3 = cl[WAR.LHQ_WX1]
		end
	    if WAR.RMD_FM  == 1 then		--伏虎罗汉拳 伤害+70
           kfname = "化境.流刃若火"
		   kfcolor = M_Red
	    end		
	    if WAR.FMZ_FM  == 1 then		--伏虎罗汉拳 伤害+70
           kfname2 = "化境.韦陀天降"
	    end	
		if WAR.JW_FM  == 1 then		--伏虎罗汉拳 伤害+70
           kfname = "化境.大日化天"
		   kfcolor = M_Red
	    end	
		if WAR.XLAY>0 then		--降龙奥义 
		   local xlzs = {"龙拳.庐山亢龙霸","龙拳.庐山龙飞翔","龙拳.庐山升龙霸","龙拳.庐山百龙霸"}
           kfname2 = xlzs[WAR.XLAY]
		   kfcolor2 = M_Red
	    end	
	    if 	WAR.XLZ_FM  == 1 then		--降龙罗汉掌 伤害+70
           kfname = "化境.摩诃迦叶掌"
		   kfcolor = M_RoyalBlue
	    end	
	   if WAR.ZBX[pid] ~= nil then
		  kfname = "醉·"..kfname
		  kfcolor = M_PaleGreen
	   end
	   if WAR.ZBX2[pid] ~= nil then
		  kfname = "无极·"..kfname
		  kfcolor = M_DarkRed
	   end
	end
	
	--独孤求败的反击文字
	if WAR.hit_DGQB == 1 then
		kfname = "无我无剑"
	end
	
	--金蛇奥义
	if WAR.JSAY == 1 then
		kfname = "奥义·金蛇狂舞"
	end
	if WAR.QJJQ == 1 then
		kfname = "南诏绝学·七诀剑气"
	end	

		if WAR.GBGF_LJ>= 1 and (MPPB_GB(pid) >= 2 ) then
			kfname = "污衣奔烈."..kfname
            WAR.GBGF_LJ = 0
			kfcolor = TG_Red_Bright
		end
	
	--何铁手五毒显示倍数
	if wugong == 3 and match_ID(pid, 83) and WAR.HTS > 0 then
		kfname = kfname.." X "..WAR.HTS
	end
	
	--内功显示随机到的系
	if WAR.NGXS > 0 then
		local display = {"土拳","火指","木剑","金刀","水奇"}
		kfname = kfname.."·"..display[WAR.NGXS]
	end
  
	if ZHEN_ID >= 0 then
	   if WAR.DUIZHAO > 0 then
	      if WAR.DUIZHAO == 1 and (nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>1 or D1ZSF(WAR.Person[ZHEN_ID]["人物编号"])) then
		  kfname = "太极领域·以静制动"
		  kfcolor = M_RoyalBlue
		  elseif WAR.DUIZHAO == 2 and nglw(WAR.Person[ZHEN_ID]["人物编号"],171)>2 then
		  kfname = "太极魅影·以巧拨拙"
		  kfcolor = M_DarkOrange	  		  
		  end
	   elseif WAR.HEJI > 0  then
	      if WAR.HEJI == 1 and wglw(WAR.Person[ZHEN_ID]["人物编号"],62)>1 then
		  kfname = "合体技·鸾凤"..kfname
		  kfcolor = M_Red
		  elseif WAR.HEJI == 2 and match_ID_awakened(WAR.Person[ZHEN_ID]["人物编号"], 103,1)  then
		  kfname = "合体技·虫鸟戏画"
		  kfcolor = M_Red
		  elseif WAR.HEJI == 2 and match_ID_awakened(WAR.Person[WAR.CurID]["人物编号"], 47,1)  then
		  kfname = "合体技·虫鸟戏画"
		  kfcolor = M_RoyalBlue
		  end
	   else
		kfname = "双人合击·"..kfname
	   end
	end


	
	--特效文字4和武功名称显示
	if wugong > 0 or WAR.hit_DGQB == 1 then				--使用武功时才显示，独孤求败反击也显示
		if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
			for i=1, 20 do
				local n, strs = Split(WAR.Person[WAR.CurID]["特效文字4"], "·");
				local len = string.len(WAR.Person[WAR.CurID]["特效文字4"]);
				local color = RGB(255,40,10);
				local off = 0;
				for j=1, n do
					if strs[j] == "连击" or strs[j] == "天赋外功.炉火纯青" 
					or strs[j] == "碧箫声里双鸣凤" or strs[j] == "英雄无双风流婿" or strs[j] == "刀光掩映孔雀屏" 
					or strs[j] == "闪电惊鸿" then
						color = M_LightBlue;
					elseif strs[j] == "左右互搏" then
						color = M_DarkOrange
					else
						color = RGB(255,40,10);
					end
					if j > 1 then
						strs[j] = strs[j];
						off = off + 42
					end		
					DrawStrBox(-1, 10 + off, strs[j], color, 10+i) 
					--off = off + string.len(strs[j])*(CC.DefaultFont+i/2)/4 + (CC.DefaultFont+i/2)*3/2;
				end
				ShowScreen()		  
				lib.Delay(10)
				if i == 20 then
					lib.Delay(30)
				end
				Cls()
			end
		end
		if math.max(WAR.URCHAIN, WAR.MYCHAIN) > 1 and WAR.ACT == 1 then
			for i = 15, 30 do					
				NewDrawString(-1, 100, "连锁"..math.max(WAR.URCHAIN, WAR.MYCHAIN).."段", M_DarkOrange, 15 + i)
				ShowScreen();
				if i == 30 then
					Cls();							
					NewDrawString(-1, 100, "连锁"..math.max(WAR.URCHAIN, WAR.MYCHAIN).."段", C_GOLD, 15 + i)
					ShowScreen();
					lib.Delay(500);
				else
					lib.Delay(2);
				end						
			end		
		end
		--武功显示
		for i = 5, 10 do
			KungfuString(kfname, CC.ScreenW / 2 -#kfname/2, CC.ScreenH / 3 - 20 - hb  , kfcolor, CC.FontBig+i, CC.FontName, 0)
			if kfname2 ~=nil then
			KungfuString(kfname2, CC.ScreenW / 2 -#kfname2/2, CC.ScreenH / 3 - (20 + hb)*5  , kfcolor2, CC.FontBig+i, CC.FontName, 0)
			end
			if kfname3 ~=nil then
			KungfuString(kfname3, CC.ScreenW / 2 -#kfname3/2, CC.ScreenH / 3 +(20 + hb)*5  , kfcolor3, CC.FontBig+i, CC.FontName, 0)
			end			
			ShowScreen()
			  
			lib.Delay(2)
			if i == 10 then
				lib.Delay(300)
			end
			Cls()
		end
	end
	
	--暗器显示
	if using_anqi == 1 then
		for i = 5, 10 do
			if WAR.KHSZ == 1 then
				KungfuString("归山笑红尘", CC.ScreenW / 2 -#anqi_name/2, CC.ScreenH / 3 - 20 - hb  , C_RED, CC.FontBig+i, CC.FontName, 0)
			else
				KungfuString(anqi_name.."×"..WAR.AQBS, CC.ScreenW / 2 -#anqi_name/2, CC.ScreenH / 3 - 20 - hb  , C_GOLD, CC.FontBig+i, CC.FontName, 0)
			end
			ShowScreen()
			  
			lib.Delay(2)
			if i == 10 then
				lib.Delay(300)
			end
			Cls()
		end
	end
  
 	for k = 0,WAR.PersonNum -1 do
	    local xxx,yyy = WAR.Person[k]['坐标X'],WAR.Person[k]['坐标Y']
		if WAR.Person[k]['死亡'] == false and WAR.Miss[WAR.Person[k]['人物编号']] == 1 then
		   if GetWarMap(xxx,yyy,5) ~= nil then
		      WAR.PIC[WAR.Person[k]['人物编号']] = GetWarMap(xxx,yyy,5)
		   end	  
		end   
	end 
  
  --显示攻击动画
  for i = 0, framenum - 1 do
	if JY.Restart == 1 then
		break
	end
    local tstart = lib.GetTime()
    local mytype = nil
    if fightframe > 0 then
      WAR.Person[WAR.CurID]["贴图类型"] = 1
      mytype = 4 + WAR.CurID
      if i < fightframe then
        WAR.Person[WAR.CurID]["贴图"] = (startframe + WAR.Person[WAR.CurID]["人方向"] * fightframe + i) * 2
      end
    else
      WAR.Person[WAR.CurID]["贴图类型"] = 0
      WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
      mytype = 0
    end
    
    if ZHEN_ID >= 0 then
      if ZHEN_fightframe > 0 then
        WAR.Person[ZHEN_ID]["贴图类型"] = 1
        if i < ZHEN_fightframe and i < framenum - 1 then
          WAR.Person[ZHEN_ID]["贴图"] = (ZHEN_startframe + WAR.Person[ZHEN_ID]["人方向"] * ZHEN_fightframe + i) * 2
        else
          WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
        end
      else
        WAR.Person[ZHEN_ID]["贴图类型"] = 0
        WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
      end
      SetWarMap(WAR.Person[ZHEN_ID]["坐标X"], WAR.Person[ZHEN_ID]["坐标Y"], 5, WAR.Person[ZHEN_ID]["贴图"])
    end
    
    if i == sounddelay then
      PlayWavAtk(JY.Wugong[wugong]["出招音效"])		--
    end
    
    if i == fightdelay then
      PlayWavE(eft)
    end
    
    if i == 1 and WAR.SSFwav == 1 then
      WAR.SSFwav = 0
    end
    if i == 1 and WAR.LMSJwav == 1 then
      PlayWavAtk(31)
      WAR.LMSJwav = 0
    end
    if i == 1 and WAR.DJSwav == 1 then
      PlayWavAtk(33)
      WAR.DJSwav = 0
    end  
  
    local pic = WAR.Person[WAR.CurID]["贴图"] / 2
    
    lib.SetClip(0, 0, 0, 0)
    
    oldpic = pic
    oldpic_type = mytype
    
    --无酒不欢：攻击特效文字显示 8-3
    if i < fightdelay then
		WarDrawMap(4, pic * 2, mytype, -1)
		
		--袁承志暴击倍数显示
		--仅限我方
		if match_ID(pid, 54) and inteam(pid) and using_anqi == 0 and WAR.BJ == 1 then
			local cri_factor = 1.5 + 0.1 * JY.Base["天书数量"]
			if JY.Person[54]["论剑奖励"] == 2 then
			cri_factor = cri_factor + math.modf((JY.Person[pid]["生命最大值"]-JY.Person[pid]["生命"])/20)*0.1
			end
			KungfuString("暴击×"..cri_factor, CC.ScreenW -230 +i*2, CC.ScreenH / 3 - 50 - hb -i*2, C_RED, CC.FontBig+i*2, CC.FontName, 0)
  		end
		
		if i == 1 and WAR.Person[WAR.CurID]["特效动画"] ~= -1 then
			local theeft = WAR.Person[WAR.CurID]["特效动画"]
			local py = 0
			local px = 0
			

			
			local sf = 0
			for ii = 0, theeft - 1 do
				sf = sf + CC.Effect[ii]
			end
			local ssid = lib.SaveSur(CC.ScreenW/2 - 11 * CC.XScale, CC.ScreenH/2 - hb - 18 * CC.YScale, CC.ScreenW/2 + 11 * CC.XScale, CC.ScreenH/2 - hb + 5 * CC.YScale)
       
			for ii = 1, CC.Effect[theeft] do
				lib.GetKey()
				--WarDrawMap(6, pic * 2, mytype,  (sf+ii)*2, nil, 3, nil, nil)
				lib.PicLoadCache(3, (sf+ii) * 2, CC.ScreenW / 2+px, CC.ScreenH / 2 - hb + py , 2, 192)
				if WAR.Person[WAR.CurID]["特效文字0"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字0"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
				end
				if WAR.Person[WAR.CurID]["特效文字1"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字1"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_RED, CC.FontSmall5, CC.FontName, 3)
				end
				if WAR.Person[WAR.CurID]["特效文字2"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字2"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_GOLD, CC.FontSmall5, CC.FontName, 2)
				end
				if WAR.Person[WAR.CurID]["特效文字3"] ~= nil then
					KungfuString(WAR.Person[WAR.CurID]["特效文字3"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_WHITE, CC.FontSmall5, CC.FontName, 1)
				end
				ShowScreen()
				lib.Delay(30)
				lib.LoadSur(ssid, CC.ScreenW/2 - 11 * CC.XScale, CC.ScreenH/2 - hb - 18 * CC.YScale)
			  
			end
			lib.FreeSur(ssid)
			WAR.Person[WAR.CurID]["特效动画"] = -1
		else
			if WAR.Person[WAR.CurID]["特效文字0"] ~= nil or WAR.Person[WAR.CurID]["特效文字1"] ~= nil or WAR.Person[WAR.CurID]["特效文字2"] ~= nil or WAR.Person[WAR.CurID]["特效文字3"] ~= nil then
				KungfuString(WAR.Person[WAR.CurID]["特效文字0"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
				KungfuString(WAR.Person[WAR.CurID]["特效文字1"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_RED, CC.FontSmall5, CC.FontName, 3)
				KungfuString(WAR.Person[WAR.CurID]["特效文字2"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_GOLD, CC.FontSmall5, CC.FontName, 2)
				KungfuString(WAR.Person[WAR.CurID]["特效文字3"], CC.ScreenW / 2, CC.ScreenH / 2 - hb, C_WHITE, CC.FontSmall5, CC.FontName, 1)
				lib.Delay(30)
			end
		end
    else
		starteft = starteft + 1
      
        lib.SetClip(0, 0, 0, 0)
        if ex == -1 and ey == -1 and (px~=0 and py~=0 )then
        WarDrawMap(4, pic * 2, mytype, (starteft) * 2, nil, 3, ex, ey,px,py)
		else
		WarDrawMap(4, pic * 2, mytype, (starteft) * 2, nil, 3, ex, ey,0,0)
		end

	if WAR.Dodge == 2 then
			for ii = 0,WAR.PersonNum -1 do 
				local xxx,yyy = WAR.Person[ii]['坐标X'],WAR.Person[ii]['坐标Y']
				local pc = WAR.PIC[WAR.Person[ii]['人物编号']]
				local x0 = WAR.Person[WAR.CurID]["坐标X"];
				local y0 = WAR.Person[WAR.CurID]["坐标Y"];
				local dx = xxx - x0
				local dy = yyy - y0
				local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
				local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
						
				local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
				ry = ry - hb
				if WAR.Person[ii]['死亡'] == false and WAR.Miss[WAR.Person[ii]['人物编号']] == 1 then
                   local sid = WAR.Person[ii]['人物编号']				
				   SetWarMap(xxx,yyy,5,-1)
				   if GetWarMap(xxx,yyy,4) <= 10 then 
					  SetWarMap(xxx,yyy,4,11)
				   else 
					  SetWarMap(xxx,yyy,4,1+GetWarMap(xxx,yyy,4))
				   end	
				   local gt = GetWarMap(xxx,yyy,4)		
				   if gt <= 20 then 
					  lib.PicLoadCache(0, pc, rx+(gt-10)*2, ry+(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(gt-10)*2, ry-(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx+(gt-10)*2, ry-(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(gt-10)*2, ry+(gt-10)*2, 10, 250-(gt-10)*25,nil,0,0)
				   else 
					  lib.PicLoadCache(0, pc, rx+(30-gt)*2, ry+(30-gt)*2, 10, (gt-20)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(30-gt)*2, ry-(30-gt)*2, 10, (gt-20)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx+(30-gt)*2, ry-(30-gt)*2, 10, (gt-20)*25,nil,0,0)
					  lib.PicLoadCache(0, pc, rx-(30-gt)*2, ry+(30-gt)*2, 10, (gt-20)*25,nil,0,0)
				   end	  
				end
			end
		end	
		
		oldeft = starteft
      
		local estart = lib.GetTime()
		if CC.BattleDelay - (estart - tstart) > 0 then
			lib.Delay(CC.BattleDelay - (estart - tstart));
		end
    end

	ShowScreen()
    lib.SetClip(0, 0, 0, 0)
    local tend = lib.GetTime()
    if CC.BattleDelay - (tend - tstart) > 0 then
    	lib.Delay(CC.BattleDelay - (tend - tstart));
    end
	lib.GetKey();
  end
  	for k = 0,WAR.PersonNum -1 do
	    local xxx,yyy = WAR.Person[k]['坐标X'],WAR.Person[k]['坐标Y']
		if WAR.Person[k]['死亡'] == false and WAR.Miss[WAR.Person[k]['人物编号']] == 1 then
		   if WAR.PIC[WAR.Person[k]['人物编号']] ~= nil then 
			  SetWarMap(xxx,yyy,5,WAR.PIC[WAR.Person[k]['人物编号']])
			  WAR.PIC[WAR.Person[k]['人物编号']] = nil
		   end
		end   
	end
  lib.SetClip(0, 0, 0, 0)
  WAR.Person[WAR.CurID]["贴图类型"] = 0
  WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
  
  --无酒不欢：命中的人物用白色表示
  WarSetPerson()
  WarDrawMap(0)
  ShowScreen()
  lib.Delay(200)
  WarDrawMap(2)
  ShowScreen()
  lib.Delay(200)
  WarDrawMap(0)
  ShowScreen()
end  
  --计算攻击到的人
  local HitXY = {}
  local HitXYNum = 0
  local hnum = 15;		--HitXY的长度个数
  for i = 0, WAR.PersonNum - 1 do
    local x1 = WAR.Person[i]["坐标X"]
    local y1 = WAR.Person[i]["坐标Y"]
	--被特效击中的也显示
    if WAR.Person[i]["死亡"] == false and (GetWarMap(x1, y1, 4) > 1 or WAR.TXXS[WAR.Person[i]["人物编号"]] == 1) then
      SetWarMap(x1, y1, 4, 1)
      --local n = WAR.Person[i]["点数"]
      local hp = WAR.Person[i]["生命点数"];
      local mp = WAR.Person[i]["内力点数"];
      local tl = WAR.Person[i]["体力点数"];
      local ed = WAR.Person[i]["中毒点数"];
      local dd = WAR.Person[i]["解毒点数"];
      local ns = WAR.Person[i]["内伤点数"];
      
      HitXY[HitXYNum] = {x1, y1, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil,nil,nil};		--x, y, 生命, 内力, 体力, 封穴, 流血, 中毒, 解毒, 内伤，冰封，灼烧，迟缓,麻痹

		if hp ~= nil then
	      if hp == 0 then			--显示受到的生命
	      		if WAR.Miss[WAR.Person[i]["人物编号"]] ~= nil then
					HitXY[HitXYNum][3] = "miss"
					WAR.Miss[WAR.Person[i]["人物编号"]] = nil
				else
					HitXY[HitXYNum][3] = hp
				end
	      elseif hp > 0 then
	      	HitXY[HitXYNum][3] = "+"..hp;
	      else
	      	HitXY[HitXYNum][3] = hp;
	      end
	    end
      
      
      if mp ~= nil then			--显示内力变化
      	if mp > 0 then
      		HitXY[HitXYNum][5] = "内力+"..mp;
      	elseif mp ==  0 then
      		HitXY[HitXYNum][5] = nil;			--变化为0时不显示
      	else
      		HitXY[HitXYNum][5] = "内力"..mp;
      	end
      end
      
      if tl ~= nil then			--显示体力变化
      	if tl > 0 then
      		HitXY[HitXYNum][6] = "体力+"..tl;
      	elseif tl == 0 then
      		HitXY[HitXYNum][6] = nil;
      	else
      		HitXY[HitXYNum][6] = "体力"..tl;
      	end
      end
      
      if WAR.FXXS[WAR.Person[i]["人物编号"]] ~= nil and WAR.FXXS[WAR.Person[i]["人物编号"]] == 1  then			--显示是否封穴
       	HitXY[HitXYNum][7] = "封穴 "..(WAR.FXDS[WAR.Person[i]["人物编号"]] or 0);
       	WAR.FXXS[WAR.Person[i]["人物编号"]] = 0
      end
      
      if WAR.LXXS[WAR.Person[i]["人物编号"]] ~=nil and WAR.LXXS[WAR.Person[i]["人物编号"]] == 1 then		--显示是否被流血
      	HitXY[HitXYNum][8] = "流血 "..(WAR.LXZT[WAR.Person[i]["人物编号"]] or 0);
        WAR.LXXS[WAR.Person[i]["人物编号"]] = 0
      end
         
      if ed ~= nil then				--显示中毒
      	if ed == 0 then
      		HitXY[HitXYNum][9] = nil;
      	else
      		HitXY[HitXYNum][9] = "中毒↑"..ed;
      	end
      end
      
      if dd ~= nil then			--显示解毒
      	if dd  == 0 then
      		HitXY[HitXYNum][4] = nil;
      	else
      		HitXY[HitXYNum][4] = "中毒↓"..dd;
      	end
      end
      
      if ns ~= nil then		--显示内伤
      	if ns == 0 then
      		HitXY[HitXYNum][10] = nil;
      	elseif ns > 0 then
      		HitXY[HitXYNum][10] = "内伤↑"..ns;
      	else
      		--HitXY[HitXYNum][10] = "内伤↓ "
      	end
      end
	  
		if WAR.BFXS[WAR.Person[i]["人物编号"]] == 1 then		--显示是否被冰封
			HitXY[HitXYNum][11] = "冰封+"..JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"];
			WAR.BFXS[WAR.Person[i]["人物编号"]] = 0
		end
		
		if WAR.ZSXS[WAR.Person[i]["人物编号"]] == 1 then		--显示是否被灼烧
			HitXY[HitXYNum][12] = "灼烧+"..JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"];
			WAR.ZSXS[WAR.Person[i]["人物编号"]] = 0
		end

      if WAR.CHXS[WAR.Person[i]["人物编号"]] ~= nil and WAR.CHXS[WAR.Person[i]["人物编号"]] == 1 and WAR.CHZ[WAR.Person[i]["人物编号"]]~= nil then			--显示是否迟缓
       	HitXY[HitXYNum][13] = "迟缓+"..WAR.CHZ[WAR.Person[i]["人物编号"]];
       	WAR.CHXS[WAR.Person[i]["人物编号"]] = 0
      end

      if WAR.MBXS[WAR.Person[i]["人物编号"]] ~= nil and WAR.MBXS[WAR.Person[i]["人物编号"]] == 1 and WAR.MBZ[WAR.Person[i]["人物编号"]]~= nil then			--显示是否麻痹
       	HitXY[HitXYNum][14] = "麻痹+"..WAR.MBZ[WAR.Person[i]["人物编号"]];
       	WAR.MBXS[WAR.Person[i]["人物编号"]] = 0
      end
		
		HitXYNum = HitXYNum + 1
    end
    
    --偷东西，斗转不可偷
    if WAR.TD > -1 then
		if WAR.TD == 118 then
			say("１哈哈哈－－－，想偷偶的斗转星移？没门儿！要想得斗转下次就乖乖跟偶合作吧！", 51,0)
		else
			instruct_2(WAR.TD, WAR.TDnum)
			Cls()
		end
			WAR.TD = -1
		end
	end
  
  --[[
  local TP = 0
  local TPXS = {}
  for i = 0, WAR.PersonNum - 1 do
    if WAR.Person[i]["特效动画"] ~= -1 then
      TP = TP + 1
      TPXS[i] = TP
    end
  end
  if TP ~= 0 then
    TP = math.modf(20 / (TP))
  end]]
  
  local minx = 0;
  local maxx = CC.ScreenW;
  local miny = 0;
  local maxy = CC.ScreenH;
  --[[
  if ex < 0 and ey < 0 then
	  for i = 0, WAR.PersonNum - 1 do
	  	if WAR.Person[i]["死亡"] == false  then
	  		local dx = WAR.Person[i]["坐标X"] - x
	      local dy = WAR.Person[i]["坐标Y"] - y
	      local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
	      local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2 - hb
	      
	      if rx > 0 and rx < minx then
	      	minx = rx;
	      end
	      if rx > 0 and rx > maxx and rx <= CC.ScreenW then
	      	maxx = rx;
	      end
	      
	      if ry > 0 and ry < miny then
	      	miny = ry;
	      end
	      if ry > 0 and ry > maxy and ry <= CC.ScreenH then
	      	maxy = ry;
	      end
	  	end
	  end
	else
		minx = 0;
	  maxx = CC.ScreenW;
	  miny = 0;
	  maxy = CC.ScreenH;
  end
 ]]
 
	--minx = limitX(minx - 10 * CC.XScale, 0, CC.ScreenW);
	--maxx = limitX(maxx + 10 * CC.XScale, 0, CC.ScreenW);
	--miny = limitX(miny - 18 * CC.YScale, 0, CC.ScreenH);
	-- maxy = limitX(maxy + 5 * CC.YScale, 0, CC.ScreenH);
  
	local sssid = lib.SaveSur(minx, miny, maxx, maxy)
	--挨打特效文字显示
	for ii = 1, 20 do
		if JY.Restart == 1 then
			break
		end
		local yanshi = false
		local yanshi2 = false		--无动画时的延迟
		for i = 0, WAR.PersonNum - 1 do
			lib.GetKey()
			if WAR.Person[i]["死亡"] == false then
				local theeft = WAR.Person[i]["特效动画"]
				if theeft ~= -1 and ii < CC.Effect[theeft] then
					local dx = WAR.Person[i]["坐标X"] - x0
					local dy = WAR.Person[i]["坐标Y"] - y0
					local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
					local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
					local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

					ry = ry - hb
					starteft = ii
					for i = 0, WAR.Person[i]["特效动画"] - 1 do
						starteft = starteft + CC.Effect[i]
					end
					
					lib.PicLoadCache(3, (starteft) * 2, rx, ry, 2, 192)
					
					--无酒不欢：特效文字一起出，不再用依次显示的方式
					--if ii < TPXS[i] * TP and (TPXS[i] - 1) * TP < ii then	
						KungfuString(WAR.Person[i]["特效文字3"], rx, ry, C_WHITE, CC.FontSmall5, CC.FontName, 1)
						KungfuString(WAR.Person[i]["特效文字2"], rx, ry, C_GOLD, CC.FontSmall5, CC.FontName, 2)
						KungfuString(WAR.Person[i]["特效文字1"], rx, ry, C_RED, CC.FontSmall5, CC.FontName, 3)
						KungfuString(WAR.Person[i]["特效文字0"], rx, ry, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
						yanshi = true
					--end
				else
					--蓝烟清： 修正无动画时不显示文字的BUG
					if i~= WAR.CurID and theeft == -1 and ((WAR.Person[i]["特效文字1"] ~= nil and WAR.Person[i]["特效文字1"] ~= "  ") or (WAR.Person[i]["特效文字2"] ~= nil and WAR.Person[i]["特效文字2"] ~= "  ")  or (WAR.Person[i]["特效文字3"] ~= nil and WAR.Person[i]["特效文字3"] ~= "  ") ) then
						local dx = WAR.Person[i]["坐标X"] - x0
						local dy = WAR.Person[i]["坐标Y"] - y0
						local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
						local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
						local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

						ry = ry - hb
						
						KungfuString(WAR.Person[i]["特效文字3"], rx, ry, C_WHITE, CC.FontSmall5, CC.FontName, 1)
						KungfuString(WAR.Person[i]["特效文字2"], rx, ry, C_GOLD, CC.FontSmall5, CC.FontName, 2)
						KungfuString(WAR.Person[i]["特效文字1"], rx, ry, C_RED, CC.FontSmall5, CC.FontName, 3)
						KungfuString(WAR.Person[i]["特效文字0"], rx, ry, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
						yanshi2 = true
					end
				end
			end
		end
		if yanshi then
		  lib.ShowSurface(0)
		  lib.LoadSur(sssid, minx, miny)
		  lib.Delay(30)
		elseif yanshi2 then
		  lib.ShowSurface(0)
		  lib.LoadSur(sssid, minx, miny)
		  lib.Delay(10)
		end
	end
	lib.FreeSur(sssid)
	Cls()	--显示点数前清空动画残影
  
	--无酒不欢：挨打时的掉血和状态显示
	if HitXYNum > 0 then
		local clips = {}
		for i = 0, HitXYNum - 1 do
			local dx = HitXY[i][1] - x0
			local dy = HitXY[i][2] - y0
			local hb = GetS(JY.SubScene, HitXY[i][1], HitXY[i][2], 4)		--海拔
		  
			local ll = 4;
			for y=3, hnum do
				if HitXY[i][y] ~= nil then
					ll = string.len(HitXY[i][y]);
					break;
				end
			end
			local w = ll * CC.DefaultFont / 2 + 1
			clips[i] = {x1 = CC.XScale * (dx - dy) + CC.ScreenW / 2, y1 = CC.YScale * (dx + dy) + CC.ScreenH / 2 - hb, x2 = CC.XScale * (dx - dy) + CC.ScreenW / 2 + w, y2 = CC.YScale * (dx + dy) + CC.ScreenH / 2 + CC.DefaultFont + 1}
		end
		
		local clip = clips[0]
		for i = 1, HitXYNum - 1 do
			clip = MergeRect(clip, clips[i])
		end
		
		local area = (clip.x2 - clip.x1) * (clip.y2 - clip.y1)		--绘画的范围
		local surid = lib.SaveSur(minx, miny, maxx, maxy)		--绘画句柄
		
		--显示点数
		--无酒不欢：一次显示两种状态
		for y = 3, hnum-3, 3 do
			if JY.Restart == 1 then
				break
			end
			local flag = false;
			for i = 5, 15 do
				local tstart = lib.GetTime()
				local y_off = i * 2 + CC.DefaultFont + CC.RowPixel
				
				lib.SetClip(0, 0, CC.ScreenW, CC.ScreenH)
				lib.LoadSur(surid, minx, miny)
				for j = 0, HitXYNum - 1 do
					if HitXY[j][y] ~= nil or HitXY[j][y+1] ~= nil then   		
						local c = y - 1;
						--无酒不欢：这里用字符串的首位判定是否为掉血
						if y == 3 and HitXY[j][y] ~= nil and string.sub(HitXY[j][y],1,1) == "-" then
							if CONFIG.HPDisplay == 1 then
								HP_Display_When_Hit(i) --无酒不欢：实时显血
							end
							DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], Color_Hurt1, CC.DefaultFont)
						else
							--无酒不欢：双排显示暂时这样写了
							local spacing = 0
							if HitXY[j][y] ~= nil then
								DrawString(clips[j].x1 - string.len(HitXY[j][y])*CC.DefaultFont/4, clips[j].y1 - y_off, HitXY[j][y], WAR.L_EffectColor[c], CC.DefaultFont)
								spacing = CC.DefaultFont
							end
							if HitXY[j][y+1] ~= nil then
								DrawString(clips[j].x1 - string.len(HitXY[j][y+1])*CC.DefaultFont/4, clips[j].y1 + spacing - y_off, HitXY[j][y+1], WAR.L_EffectColor[c+1], CC.DefaultFont)
								spacing = CC.DefaultFont
							end
							if HitXY[j][y+2] ~= nil then
								DrawString(clips[j].x1 - string.len(HitXY[j][y+2])*CC.DefaultFont/4, clips[j].y1 + spacing*2 - y_off, HitXY[j][y+2], WAR.L_EffectColor[c+2], CC.DefaultFont)
							end
						end
							
						flag = true;
					end
				end

				if flag then
					ShowScreen(1)
					lib.SetClip(0, 0, 0, 0)
					local tend = lib.GetTime()
					if tend - tstart < CC.BattleDelay then
						lib.Delay(CC.BattleDelay - (tend - tstart))
					end
				end
			end
		end
		lib.FreeSur(surid)
	end
  

	--清除点数
	for i = 0, HitXYNum - 1 do
		local id = GetWarMap(HitXY[i][1], HitXY[i][2], 2);
		WAR.Person[id]["生命点数"] = nil;
		WAR.Person[id]["内力点数"] = nil;
		WAR.Person[id]["体力点数"] = nil;
		WAR.Person[id]["中毒点数"] = nil;
		WAR.Person[id]["解毒点数"] = nil;
		WAR.Person[id]["内伤点数"] = nil;
	end
  
	--清除特效文字
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i]["特效动画"] = -1
		WAR.Person[i]["特效文字0"] = nil
		WAR.Person[i]["特效文字1"] = nil
		WAR.Person[i]["特效文字2"] = nil
		WAR.Person[i]["特效文字3"] = nil
		WAR.Person[i]["特效文字4"] = nil
	end
	lib.SetClip(0, 0, 0, 0)
	WarDrawMap(0)
	ShowScreen()
end


---执行医疗，解毒用毒暗器的子函数，自动医疗也可调用
function War_ExecuteMenu_Sub(x1, y1, flag, thingid)
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	local x0 = WAR.Person[WAR.CurID]["坐标X"]
	local y0 = WAR.Person[WAR.CurID]["坐标Y"]
	CleanWarMap(4, 0)
	WAR.ShowHP = 0
	WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
	SetWarMap(x1, y1, 4, 1)
	local emeny = GetWarMap(x1, y1, 2)
	if emeny >= 0 then
		if flag == 1 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
		 	if wglw(pid, 142)>=1 then
				 if wglw(pid, 142)>2 then
				 WAR.XFZ = TTFL2(pid,WAR.Person[emeny]["人物编号"])
				 else
			     WAR.XFZ = math.random(1,6)
			     end
		        local ttl ={"压制符","狂怒符","虚力符","封经符","丧魂符","劳情符"} 
		        local str = "通天箓."..ttl[WAR.XFZ]
		        CurIDTXDH(WAR.CurID, 73+WAR.XFZ,1,str,M_Blue);
	        end	
			if Kaiyan_ID(pid,17) and Curr_JL(pid,6) then
			     WAR.XFZ2 = QCQH(pid,WAR.Person[emeny]["人物编号"])
		        local ttl ={"夹竹桃","蚁酸","波斯旬","五步蛇毒"}
		        local str = "花虫混毒."..ttl[WAR.XFZ2]
		        CurIDTXDH(WAR.CurID, 34+WAR.XFZ2,1,str,M_DarkOrchid);
			end
			WAR.Person[emeny]["中毒点数"] = War_PoisonHurt(pid, WAR.Person[emeny]["人物编号"])


						
			if JY.Person[pid]["用毒能力"]>= 500    then
			   if JY.Person[WAR.Person[emeny]["人物编号"]]["中毒程度"] >= 100 then
			      local vv2 = math.modf(1*War_PoisonHurt(pid, WAR.Person[emeny]["人物编号"])*JY.Person[pid]["用毒能力"]/500)
				  WAR.Person[emeny]["生命点数"] =  AddPersonAttrib(WAR.Person[emeny]["人物编号"], "生命", -vv2)			     
			   end
			end

			SetWarMap(x1, y1, 4, 5)
			WAR.Effect = 5
			if match_ID_awakened(pid,2,1) and JY.Person[2]["论剑奖励"] == 2  then
			     for j = 0, WAR.PersonNum - 1 do
				    if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and j~= emeny then
					   local kid = WAR.Person[j]["人物编号"];
					   local add = JY.Person[pid]["用毒能力"]/40;			
					   add = math.modf(add);
                       if JY.Person[pid]["中毒程度"]>=100 then
					   add = -add*5
					   WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
					   else
					   WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(kid, "中毒程度", add);
					   end
				       WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				    end		
			     end  
			  end

		elseif flag == 2 and WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
			WAR.Person[emeny]["解毒点数"] = ExecDecPoison(pid, WAR.Person[emeny]["人物编号"])
			if JY.Person[pid]["解毒能力"]>= 300  then
			      local vv2 = math.modf(1*ExecDecPoison(pid, WAR.Person[emeny]["人物编号"])*JY.Person[pid]["解毒能力"]/300)
				  WAR.Person[emeny]["生命点数"] =  AddPersonAttrib(WAR.Person[emeny]["人物编号"], "生命", vv2)
			end
			if WAR.POISON2[WAR.Person[emeny]["人物编号"]]~=nil then
			   WAR.Person[emeny]["生命点数"] =  AddPersonAttrib(WAR.Person[emeny]["人物编号"], "生命", -math.modf(JY.Person[pid]["解毒能力"]/2))
			end
			SetWarMap(x1, y1, 4, 6)
			WAR.Effect = 6
		elseif flag == 3 then
			 if wglw(pid, 142)>=1 then
			     if wglw(pid, 142)>2 and WAR.AutoFight == 0 then
				 WAR.XFZ = TTFL1(pid,WAR.Person[emeny]["人物编号"])
				 else
			     WAR.XFZ = math.random(1,6)
			     end
		       local ttl ={"金刚符","力士符","戴院长符","阴阳符","元气神符","幸运符"} 
		       local str = "通天箓."..ttl[WAR.XFZ]
		       CurIDTXDH(WAR.CurID, 84+WAR.XFZ,1,str,PinkRed);
	          end	
			--医生单独判定
			if WAR.Person[WAR.CurID]["人物编号"] == 0 and JY.Base["标准"] == 8 then
			  
			elseif WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
			  local aa = ExecDoctor(pid, WAR.Person[emeny]["人物编号"])
			  WAR.Person[emeny]["生命点数"] = aa
			  SetWarMap(x1, y1, 4, 4)
			  WAR.Effect = 4
			  if match_ID_awakened(pid,2,1) and JY.Person[2]["论剑奖励"] == 1  then
			     for j = 0, WAR.PersonNum - 1 do
				    if WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and j~= emeny then
					   local kid = WAR.Person[j]["人物编号"];
					   local add = JY.Person[pid]["医疗能力"]/4  + math.random(30);
					   if add > JY.Person[pid]["医疗能力"]/2 then	--最大为医疗值的一半
						  add = JY.Person[pid]["医疗能力"]/2 ;
					   end				
					   add = math.modf(add);		
					   WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(kid, "受伤程度", -math.modf((add) / 5));
					   WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", add);
				       WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				    end		
			     end  
			  end
			  if match_ID_awakened(pid,28,1) and JY.Person[28]["论剑奖励"] == 1  then
			     for j = 0, WAR.PersonNum - 1 do
				 local kid = WAR.Person[j]["人物编号"];
				    if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and j~= emeny then		
					   WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", -aa);
				       WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
					   break
				    end		
			     end  
			  end	
			end
		--暗器
		elseif flag == 4 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
		
					--觉醒东方不败.归山笑红尘
			if   match_ID_awakened(WAR.Person[emeny]["人物编号"],27,1) then
				CleanWarMap(4, 0)
				local orid = WAR.CurID
				WAR.CurID = emeny
				
				WAR.Person[WAR.CurID]["人方向"] = War_Direct(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], x0, y0)
				
				Cls()
				CurIDTXDH(WAR.CurID, 110,1, "归山.笑红尘", C_GOLD)
				
				SetWarMap(x0, y0, 4, 1)
				
				WAR.Person[orid]["生命点数"] = (WAR.Person[orid]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "生命", -300)
				WAR.Person[orid]["中毒点数"] = (WAR.Person[orid]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "中毒程度", 100)
				WAR.TXXS[WAR.Person[orid]["人物编号"]] = 1
				
				WAR.KHSZ = 1
				
				War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, -1, 0, x0, y0, 35)
				
				WAR.KHSZ = 0
				
				WAR.CurID = orid
				return 1
			end
		
			if not match_ID(pid, 83) then
				--暗器随机伤害倍数
				WAR.AQBS = math.random(3)
				--袁承志用金蛇锥必定三倍
				if match_ID(pid, 54) and thingid == 30 then
					WAR.AQBS = 3
                    if  match_ID_awakened(pid,54,1) and JY.Person[54]["论剑奖励"] == 1 then
                    WAR.AQLX = 1
	                end					
				end
				if wglw(pid,40)>2 then
					 WAR.JJGD[WAR.Person[emeny]["人物编号"]] = 2
	                 WAR.JCGD[WAR.Person[emeny]["人物编号"]] = 1
				end
				if match_ID(pid, 449) then
					WAR.AQBS = 3
				end
				if match_ID(pid, 153) then
					WAR.AQBS = math.random(3,4)
				end
	            if match_ID_awakened(pid,11,1) and WAR.LMC == 1 and thingid == 28 then
	                WAR.AQBS = 10
					WAR.XRZT[WAR.Person[emeny]["人物编号"]] = 30
					WAR.MK_CP[WAR.Person[emeny]["人物编号"]] = 30
	            end
				if thingid==30 and JLSD(0,40,pid) and PersonKF(pid,40) then----
				instruct_32(30, 1)
				end
				local aa = War_AnqiHurt(pid, WAR.Person[emeny]["人物编号"], thingid, emeny)
				WAR.Person[emeny]["生命点数"] = aa
				SetWarMap(x1, y1, 4, 2)
				WAR.Effect = 2
				if wglw(pid,18)>2 and thingid == 28 then----
				     for j = 0, WAR.PersonNum - 1 do
					 local kid = WAR.Person[j]["人物编号"];
			             if WAR.Person[j]["我方"] == WAR.Person[emeny]["我方"] and WAR.Person[j]["死亡"] == false then
				             local offset1 = math.abs(WAR.Person[emeny]["坐标X"] - WAR.Person[j]["坐标X"])
				              local offset2 = math.abs(WAR.Person[emeny]["坐标Y"] - WAR.Person[j]["坐标Y"])
				               if offset1 <= 3 and offset2 <= 3 then
					              WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(kid, "生命", -aa);
				                  WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
				               end
			             end
		             end
	            end
			end
		end
	end
	--主角医生方阵医疗
	if flag == 3 and pid == 0 and JY.Base["标准"] == 8 then
	   local aa = 0
		for ex = x1 - 3, x1 + 3 do
			for ey = y1 - 3, y1 + 3 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then
						WAR.Person[ep]["生命点数"] = ExecDoctor(pid, WAR.Person[ep]["人物编号"])
						SetWarMap(ex, ey, 4, 4)
						WAR.Effect = 4
					end
				end        
			end
		end
	end
	--主角毒王方阵上毒，可以给自己上毒
	if flag == 1 and pid == 0 and JY.Base["标准"] == 9 then
		for ex = x1 - 3, x1 + 3 do
			for ey = y1 - 3, y1 + 3 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if (WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"]) or ep == WAR.CurID then
						WAR.Person[ep]["中毒点数"] = War_PoisonHurt(pid, WAR.Person[ep]["人物编号"])
						SetWarMap(ex, ey, 4, 5)
						WAR.Effect = 5
					end
				end        
			end
		end
	end
	--何铁手使用暗器为7*7方阵
	if flag == 4 and match_ID(pid, 83) then
		--暗器随机伤害倍数
		WAR.AQBS = math.random(3)
		for ex = x1 - 3, x1 + 3 do
			for ey = y1 - 3, y1 + 3 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
						WAR.Person[ep]["生命点数"] = War_AnqiHurt(pid, WAR.Person[ep]["人物编号"], thingid, ep)
						SetWarMap(ex, ey, 4, 4)
						WAR.Effect = 2
					end
				end
			end
		end
	end


	
	WAR.EffectXY = {}
	WAR.EffectXY[1] = {x1, y1}
	WAR.EffectXY[2] = {x1, y1}
	if flag == 1 then
		War_ShowFight(pid, 0, 0, 0, x1, y1, 30)
	elseif flag == 2 then
		War_ShowFight(pid, 0, 0, 0, x1, y1, 36)
	elseif flag == 3 then
		War_ShowFight(pid, 0, 0, 0, x1, y1, 0)
	elseif flag == 4 and (emeny >= 0 or match_ID(pid, 83)) then
		War_ShowFight(pid, 0, -1, 0, x1, y1, thingid)
	end
	for i = 0, WAR.PersonNum - 1 do
		WAR.Person[i]["点数"] = 0
	end
	if flag == 4 then
		if emeny >= 0 or match_ID(pid, 83) then
			instruct_32(thingid, -1)
			return 1
		else
			return 0
		end
	else
		WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 1
		AddPersonAttrib(pid, "体力", -2)
	end
  
	if inteam(pid) then
		AddPersonAttrib(pid, "体力", -4)
	end
	return 1
end

--无酒不欢：挨打后，绘画动态集气条的判定
function DrawTimeBar2()
	local x1,x2,y = CC.ScreenW * 1 / 2 - 34, CC.ScreenW * 19 / 20 - 2, CC.ScreenH/10 + 29
	local draw = false
	
	--这三个是固定的，只需要加载一次就可以了
	--无酒不欢：这里也要判定是否有需要draw，如无需要则不加载
	local drawframe = false
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			if WAR.Person[i].TimeAdd < 0 then
				drawframe =  true
				break
			end
		end
	end
	if drawframe == true then
		DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
		DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
		DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
		lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
		lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
	end
	
	local surid = lib.SaveSur(x1 - (10 + (x2 - x1) / 2), 0, x2 + 10 + 20 + 30, y * 2 + 18 + 25)
  
	while true do
		draw = false
		for i = 0, WAR.PersonNum - 1 do
			local pid = WAR.Person[i]["人物编号"];
			--首先判定人物是否活着
			if WAR.Person[i]["死亡"] == false then
				--这里TimeAdd小于0代表集气位置要减少，数值为减少总量
				if WAR.Person[i].TimeAdd < 0 then
					draw = true
					--减量以20为单位循环增加，增加到超过0时，判定将不再成立，既停止减少集气位置
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
					if WAR.Person[i].TimeAdd > 0 then
						WAR.Person[i].TimeAdd = 0;
					end
					--如果人物的集气位置没有达到-500，则减少20，向-500靠近
					if WAR.Person[i].Time > -500 then
						WAR.Person[i].Time = WAR.Person[i].Time - 20
					--如果人物的集气位置已经达到-500，则集气位置不再减少，而是转换为内伤
					else
						if JY.Person[pid]["受伤程度"] < 100 then
							if inteam(pid) then
								AddPersonAttrib(pid, "受伤程度", Rnd(4) + 2)		--我方被减集气时受到的内伤
							else
								AddPersonAttrib(pid, "受伤程度", Rnd(3) + 1)		--敌方内伤
							end     
						end
					end	
					if WAR.Person[i].Time <= -500 and PersonKF(pid, 100) then	--练了先天功后，当集气被杀到-500，内伤直接清0
						JY.Person[pid]["受伤程度"] = 0;	
					end
				--大于0代表集气位置要增加，
				elseif WAR.Person[i].TimeAdd > 0 then
					draw = true
					--增量以20为单位循环减少，减少到低于0时，判定将不再成立，既停止增加集气位置
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 20
					--人物的集气位置以20为单位增加，如果集气位置超过995，则强制定为995
					WAR.Person[i].Time = WAR.Person[i].Time + 20
					if WAR.Person[i].Time > 995 then
						WAR.Person[i].Time = 995;
					end
				end
			end
		end
			
		if draw then
			lib.LoadSur(surid, x1 - (10 + (x2 - x1) / 2), 0)
			DrawTimeBar_sub(x1, x2, y, 1)
			ShowScreen()
			lib.Delay(8)
		else
			break;
		end
	end
	lib.Delay(100)
	lib.FreeSur(surid)
end

--绘制集气条
function DrawTimeBar()
	
	local x1,x2,y = CC.ScreenW * 1 / 2 - 34, CC.ScreenW * 19 / 20 - 2, CC.ScreenH/10 + 29
	local xunhuan = true
	local xh = 0
	local surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)	--无酒不欢：修复杀到-500后集气条小头像刷新问题
	while xunhuan do
    for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			local jqid = WAR.Person[i]["人物编号"]
			local jq = WAR.Person[i].TimeAdd	--人物集气速度
			--无酒不欢：每25点内伤-1集气，每25点中毒-1集气，玩家与NPC一样
			local ns_factor = math.modf(JY.Person[jqid]["受伤程度"] / 25)
			local zd_factor = math.modf(JY.Person[jqid]["中毒程度"] / 25)
			if Curr_QG(jqid,150) and qglw(jqid,150)>=1 then
            ns_factor = -math.modf(JY.Person[jqid]["受伤程度"] / 15)
			zd_factor = -math.modf(JY.Person[jqid]["中毒程度"] / 15)
			end
			
			--毒王中毒反而增加集气
			if jqid == 0 and JY.Base["标准"] == 9 then
			    if zd_factor>0  then
				zd_factor = -(zd_factor*2)
				else
				zd_factor = (zd_factor*2)
				end
			elseif MPPD(jqid) == 7 then
			    if zd_factor>0  then
				zd_factor = -(zd_factor*2)
				else
				zd_factor = (zd_factor*2)
				end
			end
			if WAR.YZSG[jqid]~=nil then
			    if zd_factor>0  then
				zd_factor = (zd_factor*2)
				else
				zd_factor = -(zd_factor*2)
				end
				if WAR.YZSY[jqid]~=nil then
				zd_factor = (zd_factor*2)
				end
			end
			if WAR.YZSP[jqid]~=nil then
				if ns_factor>0  then
				ns_factor = (ns_factor*2)
				else
				ns_factor = -(ns_factor*2)
				end
			end

			if nglw(jqid, 87)>1 then----化功二阶
			   local num=0
		       for i = 0, WAR.PersonNum - 1 do
			       if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				   local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				   local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				         if offset1 <= 8 and offset2 <= 8 then
					     num=num+math.modf(JY.Person[WAR.Person[i]["人物编号"]]["中毒程度"]*0.05)
				         end
			       end
		       end
			if jqid == 0 and JY.Base["标准"] == 9 then
				zd_factor = zd_factor-num*2
			else
            zd_factor = -(math.modf(zd_factor+num)*1.5)
			end
			end
			
			--冰封也减少
			local bf_factor = 0;
			if JY.Person[jqid]["冰封程度"] >= 50 then
				bf_factor = 6
			elseif JY.Person[jqid]["冰封程度"] > 0 then
				bf_factor = 3
			end
			if WAR.ICE[jqid]~=nil then
			bf_factor = bf_factor*2
			end
			if WAR.HBYJ[jqid]~=nil then
			bf_factor = bf_factor*WAR.HBYJ[jqid]
			end
			if WAR.LYLZ[jqid]~=nil and WAR.LYLZ[jqid] == 5 then
			   bf_factor = 0
		    end
			if  wglw(jqid,8)>2  or match_ID_awakened(jqid, 116,1) or match_ID_awakened(jqid, 117,1) then ---三阶六阳和逍遥二老
			bf_factor = -bf_factor
			end
			if Curr_QG(jqid,150) and qglw(jqid,150)>=1 then
			    if bf_factor>0  then
				bf_factor = -bf_factor
				end
			end
			local HTC_tq = 0
			if WAR.QYZT[jqid] ~= nil then
					HTC_tq = jq * 0.01 * WAR.QYZT[jqid]
			end
                local chzt_jq = 0
				
			if WAR.LYLZ[jqid]~=nil and WAR.LYLZ[jqid] == 5 then
			   chzt_jq = 0
		    end
			if Curr_QG(jqid,150) and qglw(jqid,150)>=1 then
               chzt_jq = - jq * 0.5
			end
			--李秋水集气不受状态影响
			if match_ID(jqid, 118) == false then
				jq = jq - ns_factor - zd_factor - bf_factor-HTC_tq-chzt_jq
			end
			
	        if WAR.MK_SH[jqid]~= nil then----
	            jq  = math.modf(jq * 1.2)
	        end
			
			if WAR.SPDDOWN[jqid]~= nil then----
			    jq  = math.modf(jq * 0.8)
			end

			if WAR.SPDUP[jqid]~= nil then----
			    jq  = math.modf(jq * 1.5)
			end
			
			if WAR.MENG[jqid] ~= nil then --回魂仙梦集气
			    if WAR.Person[i].TimeAdd>0 then
				local aa = math.modf(WAR.Person[i].TimeAdd * 0.5) + 1
				jq = math.random(aa)
				end
				WAR.MENG[jqid] = WAR.MENG[jqid] - 1
				if WAR.MENG[jqid] == 0 then
					WAR.MENG[jqid] = nil
				end
			end
			
			if WAR.YINFU[jqid] ~= nil then --阴符
				jq = math.modf(WAR.Person[i].TimeAdd * 1.5) 
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 50
				WAR.YINFU[jqid] = WAR.YINFU[jqid] - 1
				if WAR.YINFU[jqid] == 0 then
					WAR.YINFU[jqid] = nil
				end
			end		

			if WAR.YANGFU[jqid] ~= nil then --阳符
				jq = math.modf(WAR.Person[i].TimeAdd * 1.5) + 1
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 20
				WAR.YANGFU[jqid] = WAR.YANGFU[jqid] - 1
				if WAR.YANGFU[jqid] == 0 then
					WAR.YANGFU[jqid] = nil
				end
			end	
			
			if WAR.YZSX[jqid] ~= nil then --心损集气
			    if WAR.Person[i].TimeAdd>1 then
				local aa = math.modf(WAR.Person[i].TimeAdd * 0.5) + 1
				local bb = math.modf(WAR.Person[i].TimeAdd ) + 1				
				jq = math.random(aa,bb)
				end
				WAR.YZSX[jqid] = WAR.YZSX[jqid] - 1
				if WAR.YZSX[jqid] == 0 then
					WAR.YZSX[jqid] = nil
				end
			end
	
	        if WAR.LSDZ[jqid]~=nil and match_ID_awakened(jqid,90,1) then
			   jq = math.modf(WAR.Person[i].TimeAdd * 1.5) 
			end
			
			if MPPB_BTNY(jqid) >= 1 then --逆运集气
			   if jq>0 then
               local jq1=math.modf(jq*1.5)
			   local jq2=math.modf(jq*2)+4
			   jq=math.random(jq1,jq2)
			   else
			   jq = -jq
			   end
			end
			if jq < 0 then
				jq = 0
			end
			--暴怒3倍集气
			if WAR.LQZ[jqid] == 100 then
			    
				if Curr_NG(jqid,180)  then
				jq = jq * 4
				else
				jq = jq * 3
				end
				if match_ID_awakened(jqid,65,1) or MPPB_BTNY(jqid) >= 1 or match_ID_awakened(jqid,647,1) then
				jq = math.modf(jq *1.35)
				end
				if WAR.GSSL[jqid]~=nil and WAR.GSSL[jqid] == 1 then
				jq = math.modf(jq *1.35)
				end
			end
	
			--没有封穴的情况下，可以集气
			if WAR.FXDS[WAR.Person[i]["人物编号"]] == nil then
				if match_ID(jqid, 60) and (math.random(10) == 8 or math.random(10) == 8) then
						jq = jq + math.random(10, 30);
				end
				if WAR.YZSP[jqid]~=nil and WAR.YZSY[jqid]~=nil then----
		           if math.random(3) == 1 then
				   jq = -200
				   end
		        end
				if WAR.JCYY[jqid]~=nil then
				   local aa = WAR.JCYY[jqid]
				   if math.random(100) <= math.modf(aa/10) then
				   jq = jq + aa*10
				   end	
				end
				if WAR.JCYY1[jqid]~=nil then
				   local aa = WAR.JCYY1[jqid]
				   if math.random(100) <= math.modf(aa/10) then
				   jq = jq - aa*10
				   end	
				end
				if WAR.LSQ2[jqid]~=nil then
				   local aa = JY.Person[jqid]["中毒程度"]
				   if math.random(100) <= math.modf(aa/2) then
				   jq = jq - aa*2
				   end	
				end
				if WAR.KQB[jqid]~=nil and jq>0  then--狂犬病集气波动
						if math.random(3) == 1 then
							WAR.Person[i].Time = WAR.Person[i].Time - math.modf(jq/2)
						else
							WAR.Person[i].Time = WAR.Person[i].Time + jq
						end
				elseif WAR.LSQ[jqid] ~= nil and jq>0 then	--被灵蛇拳击中，集气波动20时序
						if math.random(3) == 1 then
							WAR.Person[i].Time = WAR.Person[i].Time - jq
						else
							WAR.Person[i].Time = WAR.Person[i].Time + jq
						end
						WAR.LSQ[jqid] = WAR.LSQ[jqid] - 1
						if WAR.LSQ[jqid] == 0 then
							WAR.LSQ[jqid] = nil
						end
				elseif  WAR.LHFM[jqid] ~= nil  and jq>0 then----
				        WAR.Person[i].Time = WAR.Person[i].Time - math.max(jq,50)
				       if WAR.Person[i].Time <= -500 then 
				          WAR.Person[i].Time = -500
				       end 
				        WAR.LHFM[jqid] = WAR.LHFM[jqid]-1
						if WAR.LHFM[jqid] == 0 then
							WAR.LHFM[jqid] = nil
				        end
				else
						--被无招胜有招击中的人，无法集气
				if WAR.CSZT[jqid] == 1 then
					jq = 0
				elseif WAR.WZSYZ[jqid] ~= nil then
					jq = 0
					WAR.WZSYZ[jqid] = WAR.WZSYZ[jqid] - 1
					if WAR.WZSYZ[jqid] < 1 then
						WAR.WZSYZ[jqid] = nil
					end
				--冻结的敌人，无法集气				
				elseif WAR.LRHF[jqid] ~= nil then
					jq = 0
					if WAR.LRHF[jqid] >50 then
						WAR.LRHF[jqid] = 50
					end
					WAR.LRHF[jqid] = WAR.LRHF[jqid] - 1
					if WAR.LRHF[jqid] < 1 then
						WAR.LRHF[jqid] = nil
					end
			elseif WAR.YJZD[jqid] ~= nil then --以静制动
			jq = 0
			      WAR.YJZD[jqid] = WAR.YJZD[jqid] - 1
			     if WAR.YJZD[jqid] <= 0 then
				   WAR.YJZD[jqid] = nil
				   WAR.YJZDPD[jqid] = 1
				 WAR.Person[i].Time = 1005
			     end			
		   elseif WAR.SH[jqid] ~= nil then --锁喉
		   jq = 0
		  	     WAR.SH[jqid] = WAR.SH[jqid] - 1
			if WAR.SH[jqid] <= 0 then
				WAR.SH[jqid] = nil
			end
		elseif WAR.SH1[jqid] ~= nil then
		jq = 0
			WAR.SH1[jqid] = WAR.SH1[jqid] - 1
			if WAR.SH1[jqid] <= 0 then
				WAR.SH1[jqid] = nil
			end			
		elseif WAR.SDFX[jqid]~=nil  then
		       jq = 0
				end
						WAR.Person[i].Time = WAR.Person[i].Time + jq
				end
 
			--被封穴的话，不会集气，时序减少封穴
			else
			    local aa = 0
				WAR.FXDS[WAR.Person[i]["人物编号"]] = WAR.FXDS[WAR.Person[i]["人物编号"]] - 1
				aa = aa + 1
                if nokillspeed(WAR.Person[i]["人物编号"])  then----
				
				elseif nglw(WAR.Person[i]["人物编号"],104)>2 then
				jq = math.modf(jq * 1.25)
				else
				jq=0
				end
				WAR.Person[i].Time = WAR.Person[i].Time + jq
				--易筋经 封穴回复+1
				if PersonKF(jqid, 108) then
					WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
					aa = aa + 1
				end
				
				--先天+玉女，封穴回复+1
				if PersonKF(jqid, 100) and PersonKF(jqid, 154) then
					WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
					aa = aa + 1
				end
                
				if  WAR.JYHT[jqid] ~= nil then --17-2-8
				WAR.FXDS[jqid] = 0
			    end	 
				
				--九阳7时序解除封穴
				--阳内主运或者阳罡学会九阳后
				if Curr_NG(jqid, 106) and (JY.Person[jqid]["内力性质"] == 1 or (jqid == 0 and JY.Base["标准"] == 6)) then
					if WAR.JYFX[jqid] == nil then
						WAR.JYFX[jqid] = 1;
					elseif WAR.JYFX[jqid] < 7 then
						WAR.JYFX[jqid] = WAR.JYFX[jqid] + 1;
					else
						WAR.JYFX[jqid] = nil;
						WAR.FXDS[jqid] = 0;
					end
				end
								
				--暴怒时解穴速度加倍
				if WAR.LQZ[jqid] == 100 then
					WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
					aa = aa + 1
				end
				
		if WAR.SDFX[jqid] ~= nil and WAR.SDFX[jqid] > 0 then 
		    WAR.FXDS[jqid] = WAR.FXDS[jqid] + 1
			WAR.SDFX[jqid] = WAR.SDFX[jqid] - 1
			if WAR.SDFX[jqid] <= 0 then
				WAR.SDFX[jqid] = nil
			end		
		end	

				  if WAR.RMZT[jqid]~=nil then
				  JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - aa
				     if JY.Person[jqid]["内力"] < 0 then
					 JY.Person[jqid]["内力"] = 0
				     end
				  end		
				if WAR.FXDS[WAR.Person[i]["人物编号"]] < 1 then
					WAR.FXDS[WAR.Person[i]["人物编号"]] = nil
					if WAR.MKDS[WAR.Person[i]["人物编号"]]~=nil then --秘孔爆炸
					    local s = WAR.CurID
						WAR.CurID = i
						WarDrawMap(0); --不加这条则动画位置无法正常显示
					CurIDTXDH(WAR.CurID, 115,1, "秘孔爆发", C_ORANGE)
					local aa1 = WAR.MKDS[WAR.Person[i]["人物编号"]]
					reseteffect2(WAR.MKDS,WAR.Person[i]["人物编号"],aa1)
					WAR.LXBZ[WAR.Person[i]["人物编号"]] =10
					WAR.Person[i].Time =-500
					local nlDam=aa1*50
					WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", -nlDam)
					if JY.Person[WAR.Person[i]["人物编号"]]["生命"]<=0 then----
					WAR.Person[i]["死亡"] = true
					end
					WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
					   if WAR.MK_XXC[WAR.Person[i]["人物编号"]]~=nil then
					   	local aa = WAR.MK_XXC[WAR.Person[i]["人物编号"]]
					   reseteffect2(WAR.MK_XXC,WAR.Person[i]["人物编号"],aa)
					   local bb= aa1*10
					   WAR.Person[i]["内伤点数"] = (WAR.Person[i]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "受伤程度",bb)
					   end
					  if WAR.MK_YQ[WAR.Person[i]["人物编号"]]~=nil then
					   	local aa = WAR.MK_YQ[WAR.Person[i]["人物编号"]]
					   reseteffect2(WAR.MK_YQ,WAR.Person[i]["人物编号"],aa)
					   WAR.MENG[WAR.Person[i]["人物编号"]] = aa1 * 10			   
					   WAR.TKJQ[WAR.Person[i]["人物编号"]]= 1
					   end
					   if WAR.MK_XR[WAR.Person[i]["人物编号"]]~=nil then
					   local aa = WAR.MK_XR[WAR.Person[i]["人物编号"]]
					   reseteffect2(WAR.MK_XR,WAR.Person[i]["人物编号"],aa)
					   end
					   if WAR.MK_CP[WAR.Person[i]["人物编号"]]~=nil then
					   local aa = WAR.MK_CP[WAR.Person[i]["人物编号"]]
					   reseteffect2(WAR.MK_CP,WAR.Person[i]["人物编号"],aa)
					   end
					   if WAR.MK_CH[WAR.Person[i]["人物编号"]]~=nil then
					   CurIDTXDH(WAR.CurID, 118,1, "秘孔.残悔", C_ORANGE)
					   local aa = WAR.MK_CH[WAR.Person[i]["人物编号"]]
					   reseteffect2(WAR.MK_CH,WAR.Person[i]["人物编号"],aa)
					   local nlDam=math.modf(JY.Person[WAR.Person[i]["人物编号"]]["生命最大值"]/2)
					   WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", -nlDam)
					   		if JY.Person[WAR.Person[i]["人物编号"]]["生命"]<1 then----
					        WAR.Person[i]["死亡"] = true
					        end
					   WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
					   end
					   WAR.CurID = s
					end
				end
			end  
        
			--九阳神功回内
			--学会九阳并且是阳内或者天罡
			if PersonKF(jqid, 106) and (JY.Person[jqid]["内力性质"] == 1 or (jqid == 0 and JY.Base["标准"] == 6)) then
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 9
			   if (nglw(jqid,106) >2) and (WAR.JYHT[jqid] or 0)<5 then --17-2-10
              JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + (5-(WAR.JYHT[jqid] or 0))*5
			   end
			end
 
			if MPPB_WD(jqid) == 2 and MPZJ(jqid,2)>1 then
			    local aa = WAR.CYZY[jqid] or 0
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + aa * (MPZJ(jqid,2) - 1)*3
				if MPZJ(jqid,2)>2 then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + aa * (MPZJ(jqid,2) - 1)
				end
			end
 
			--天池心法回内
			if PersonKF(jqid, 166) then
			local num = 0
					for j = 0, WAR.PersonNum - 1 do					 
			           if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                          num = num + 3
			           end
		            end
			local num1 = num*nglw(jqid,166)
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + num1
			end
  
			--九阴神功回血
			--学会九阴并且是阴内或者天罡
			if PersonKF(jqid, 107) and (JY.Person[jqid]["内力性质"] == 0 or (jqid == 0 and JY.Base["标准"] == 6)) then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] +1+nglw(jqid,107)*3
			end
			
			--九阴额外回血
			--阴内主运或者阴罡学会九阴后
			if Curr_NG(jqid, 107) and (JY.Person[jqid]["内力性质"] == 0 or (jqid == 0 and JY.Base["标准"] == 6)) then
				if inteam(jqid) then
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 2
				else
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 1
				end
			end
		
	        if KUIHUA(jqid) == 1 then
			   JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 2
			   if WAR.YANG[jqid]~=nil then--
               JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 2*WAR.YANG[jqid]
               end		
            end			

	        if KUIHUA(jqid) == 0 then
			   JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 5
			   if WAR.YIN[jqid]~=nil then--
               JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 3*WAR.YIN[jqid]
               end		
            end	
			
			if WAR.WXZQ[jqid]~=nil and MPPB_MJBL(jqid) > 1 then
			   if WAR.WXZQ[jqid] == 1 then
			   JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 2*MPPB_MJBL(jqid)*MPDJ(jqid)
			   end
			   if WAR.WXZQ[jqid] == 3 then
			   JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 5*MPPB_MJBL(jqid)*MPDJ(jqid)
			   end
			
			end
			
			
			--brolycjw: 先天功回血回内
		if Curr_NG(jqid, 100) then
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 3
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + 1
								--brolycjw: 先天功回内
               if nglw(jqid,100)>=1 then 
		          AddPersonAttrib(jqid, "内力", math.random(1, 3)*nglw(jqid,100))--豸苗：先天领悟
		          AddPersonAttrib(jqid, "生命", math.random(2, 4)*nglw(jqid,100))
				  if not inteam(jqid) then
				  AddPersonAttrib(jqid, "生命", math.random(3, 6)*nglw(jqid,100))
				  AddPersonAttrib(jqid, "内力", math.random(2, 4)*nglw(jqid,100))--豸苗：先天领悟
				  end
		          if JY.Person[jqid]["受伤程度"] > 0 then 
		             AddPersonAttrib(jqid, "生命", 3*nglw(jqid,100))
			         AddPersonAttrib(jqid, "受伤程度", -1*nglw(jqid,100))
			         AddPersonAttrib(jqid, "内力", 2*nglw(jqid,100))
		          end
              end
			  if nglw(jqid,100)>1 then
				 if math.random(300) <= 3*nglw(jqid,100) then----
			     AddPersonAttrib(jqid, "生命",  100*((WAR.XTGQ[jqid] or 0)+ 1))
			     end
              end
		end

		if JY.Person[37]["论剑奖励"] == 1 and match_ID_awakened(jqid,37,1) and WAR.SZJS[jqid] ~= nil then
		          AddPersonAttrib(jqid, "内力", math.random(1, 3)*5)--豸苗：先天领悟
		          AddPersonAttrib(jqid, "生命", math.random(2, 4)*5)
				 if math.random(300) <= 3*nglw(jqid,100) then----
			     AddPersonAttrib(jqid, "生命",  100*math.random(1,2))
			     end
		end


		if MPPD(jqid) == 4 then --血魔
			if WAR.XUEMO[jqid] ~= nil then
				if JY.Person[jqid]["生命"] < math.modf(JY.Person[jqid]["生命最大值"] * 0.5) then
					WAR.XUEMO[jqid] = nil
					WAR.LQZ[jqid] = nil
				end				
				AddPersonAttrib(jqid, "生命", -5)
				if MPPB_MZ(jqid) == 3 then
				AddPersonAttrib(jqid, "生命", 5)
				end
				if JY.Person[jqid]["生命"] < 0 then JY.Person[jqid]["生命"] = 1 end --武骧金星：避免血魔流血至死
				if JY.Person[jqid]["生命"] < math.modf(JY.Person[jqid]["生命最大值"] * 0.5) then
					WAR.XUEMO[jqid] = nil
					WAR.LQZ[jqid] = nil
				end	
			end
		end
	
if WAR.YJQS1[jqid] ~= nil and WAR.YJQS1[jqid] > 0 then--崆峒门派
			WAR.YJQS1[jqid] = WAR.YJQS1[jqid] - 1
			if 	WAR.YJQS1[jqid] <= 0 then
				WAR.YJQS1[jqid] = nil 
			end
			if WAR.YJQS1[jqid] == 49 or WAR.YJQS1[jqid] == 42 or WAR.YJQS1[jqid] == 35 or WAR.YJQS1[jqid] == 28 or WAR.YJQS1[jqid] == 21 or WAR.YJQS1[jqid] == 14 or WAR.YJQS1[jqid] == 7 then
				local tmppid = WAR.CurID
					WAR.CurID = i
					WarDrawMap(0)
				local aa = math.random(1,7)
                local txwz = {"心火逆冲","肾水凝滞","肝木催折","脾土腐坏", "肺金蚀锈", "阳脉寸断", "阴络尽毁"}				
				local str = txwz[aa]
				CurIDTXDH(WAR.CurID, 9+aa, 1,str, PinkRed)
				if aa == 1 then
					AddPersonAttrib(jqid, "灼烧程度", (WAR.LQZ[jqid] or 0))
				elseif aa == 2 then
					local bb = math.modf(JY.Person[jqid]["内力"]/500)
					if bb < 10 then bb = 10 end
					AddPersonAttrib(jqid, "冰封程度", bb)
				elseif aa == 3 then
					if JY.Person[jqid]["中毒程度"] < 80 then
						WAR.L_WNGZL[jqid] = (WAR.L_WNGZL[jqid] or 0 ) + 15
					else
						WAR.L_WNGZL[jqid] = (WAR.L_WNGZL[jqid] or 0 ) + 15
						WAR.POISON[jqid] = (WAR.POISON[jqid] or 0 ) + 15
					end
				elseif aa == 4 then
					WAR.LHFM[jqid]=limitX((WAR.LHFM[jqid] or 0) + 5, 0, 100)
					WAR.L_WNGZL2[jqid] = limitX((WAR.L_WNGZL2[jqid] or 0) + 5, 0, 100)
				elseif aa == 5 then
					WAR.Person[i].Time = WAR.Person[i].Time - 250 
					WAR.LXZT[jqid] = (WAR.LXZT[jqid] or 0 ) + 20
					if WAR.LXZT[jqid]>= 100 then
					WAR.LXZT[jqid] = 100
					WAR.QBLY[jqid] = 20
					end
					if WAR.Person[i].Time < -500 then
						WAR.Person[i].Time = - 500
					end	
				elseif aa == 6 then
					JY.Person[jqid]["内力"] = (JY.Person[jqid]["内力"] or 0) - 500
					JY.Person[jqid]["受伤程度"] = (JY.Person[jqid]["受伤程度"] or 0) + 20
						if JY.Person[jqid]["内力性质"] == 1 then
							WAR.YMD[jqid] = 20
						else
							WAR.YMD[jqid] = 15
						end
				elseif aa == 7 then	
					JY.Person[jqid]["内力"] = (JY.Person[jqid]["内力"] or 0) - 500
					JY.Person[jqid]["受伤程度"] = (JY.Person[jqid]["受伤程度"] or 0) + 20
						if JY.Person[jqid]["内力性质"] == 0 then
							WAR.YMH[jqid] = 20
						else
							WAR.YMH[jqid] = 15
						end
				end
				WAR.CurID=tmppid		
			end	
		end

		if WAR.YMD[jqid] ~= nil then
			WAR.YMD[jqid] = WAR.YMD[jqid] - 1
			if WAR.YMD[jqid] <= 0 then
				WAR.YMD[jqid] = nil
			end	
		end	
		if WAR.YMH[jqid] ~= nil then
			WAR.YMH[jqid] = WAR.YMH[jqid] - 1
			if WAR.YMH[jqid] <= 0 then
				WAR.YMH[jqid] = nil
			end
		end	
	
			  if nglw(jqid,100)>1 then
			     AddPersonAttrib(jqid, "内力", math.random(5, 10))
				 if nglw(jqid,100)>2 then
		         if JY.Person[jqid]["内力"] <= math.modf(JY.Person[jqid]["内力最大值"]*0.25) then 
			     AddPersonAttrib(jqid, "内力", 25)--沼跃鱼：天南应急处理
		         end
		         if JY.Person[jqid]["生命"] <= math.modf(JY.Person[jqid]["生命最大值"]*0.5) then 
			     AddPersonAttrib(jqid, "内力", -15)--沼跃鱼：天南应急处理
			     AddPersonAttrib(jqid, "生命", 15)--沼跃鱼：天南应急处理
		         end			  
			     if math.random(100) == 3 then----
			     AddPersonAttrib(jqid, "内力",  math.random(3)*100)
			     end
				 end
              end

			  if Curr_NG(jqid,179) then
			     AddPersonAttrib(jqid, "内力", 15)
              end
		
		    if WAR.MK_BH[jqid]~=nil then
			     AddPersonAttrib(jqid, "内力", math.random(25, 50))
				 AddPersonAttrib(jqid, "生命", math.random(5, 10))
              end
		
		   if match_ID_awakened(jqid, 2,1) then
			   local num=0
			 for i = 0, WAR.PersonNum - 1 do
			    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
				local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
				local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
				    if offset1 <= 8 and offset2 <= 8 then
					num=num+math.modf(JY.Person[WAR.Person[i]["人物编号"]]["中毒程度"]*0.05)
				    end
			   end
		    end
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + num*3+math.modf(JY.Person[jqid]["中毒程度"] / 5)
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + num+math.modf(JY.Person[jqid]["中毒程度"] / 25)
			end
			

	if match_ID(jqid, 2) then ----程灵素七星海棠花粉传播领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[jqid]["医疗能力"])/300)+3		
			if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 if math.random(10)<8 or JY.Person[df]["中毒程度"]>0 then
			 if JY.Person[df]["中毒程度"]>0 then
			 local bb=math.random(1,5)
			AddPersonAttrib(df, "中毒程度", -bb)
			end
			AddPersonAttrib(df, "生命", xn)
			 end 
			end
            end		    		
	end
	
	

	if WAR.HOT2_JH[jqid]~=nil then ----程灵素七星海棠花粉传播领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf(JY.Person[df]["灼烧程度"]/10)		
			if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
            WAR.HOT[df] = limitX((WAR.HOT[df] or 0) + 1,0,50)
			end
			
        end	
        WAR.HOT2_JH[jqid] = WAR.HOT2_JH[jqid] -1
        if WAR.HOT2_JH[jqid]<1  then
        WAR.HOT2_JH[jqid] = nil
        end		
	end

	if WAR.JYWR_JH[jqid]~=nil then ----程灵素七星海棠花粉传播领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=(WAR.JYWR[jqid] or 0) + 5		
			if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
            WAR.HOT[df] = limitX((WAR.HOT[df] or 0) + 1,0,50)
			end
			
        end	
        WAR.JYWR_JH[jqid] = WAR.JYWR_JH[jqid] -1
        if WAR.JYWR_JH[jqid]<1  then
        WAR.JYWR_JH[jqid] = nil
        end		
	end

	if WAR.JYWR_JH2[jqid]~=nil then ----程灵素七星海棠花粉传播领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=(WAR.JYWR[jqid] or 0) + 5		
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
            WAR.L_HQNZL[df] = limitX((WAR.L_HQNZL[df] or 0) + 1,0,50)
			end
			
        end	
        WAR.JYWR_JH2[jqid] = WAR.JYWR_JH2[jqid] -1
        if WAR.JYWR_JH2[jqid]<1  then
        WAR.JYWR_JH2[jqid] = nil
        end		
	end

	if WAR.MZQL[jqid]~=nil and WAR.MZQL[jqid] == 2 then ----密释轮
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false  then
            AddPersonAttrib(df, "内力", math.modf((WAR.MZ_LH[jqid] or 0)*0.15+10))
			end
        end		    		
	end				

	if WAR.MZQL[jqid]~=nil and WAR.MZQL[jqid] == 3 then ----化身轮
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false  then
            AddPersonAttrib(df, "生命", math.modf((WAR.MZ_LH[jqid] or 0)*0.1+3))
			end
        end		    		
	end	
		
	if nglw(jqid, 87)>2 then ----化功领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[jqid]["用毒能力"]+MPAttrib(jqid, 5))/50)+3		
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if math.random(10)<4 then
			AddPersonAttrib(df, "中毒程度", math.modf(xx/2))
			AddPersonAttrib(df, "内力", -xx)
			if JY.Person[df]["中毒程度"]>100 then
            JY.Person[df]["中毒程度"]=100
			end
			 end 
			end
            end		    		
	end
	
	if wglw(jqid,45)>2 or Kaiyan_ID(jqid,655) then -- 重力领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 	
			   if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
			      if WAR.ZLLY[df] == nil then
			         WAR.ZLLY[df] = 1
			      end
			   end
			   if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
			      if WAR.FZLY[df] == nil then
			         WAR.FZLY[df] = 1
			      end
			   end
       end		
	
	end
	

	if wglw(jqid, 61)>2 and PersonKFJ(jqid,61) and (JY.Person[jqid]["内力性质"] == 1 or TGPD(jqid)) then ----十乌天界
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[jqid]["内力最大值"])/1000)+3		
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if math.random(10)<4 then
			AddPersonAttrib(df, "灼烧程度", math.modf(xx/2))
			if JY.Person[df]["灼烧程度"]>50 then
            JY.Person[df]["灼烧程度"]=50
			WAR.JHLY[df]=  math.modf(xx/2)
               if JuHuoLY(jqid) then
                WAR.L_HQNZL[jqid] = math.modf(xx/2)
               end			   
			end
			 end 
			end
            end		    		
	end	
	
	if wglw(jqid, 35)>2 and PersonKFJ(jqid,35) and (JY.Person[jqid]["内力性质"] == 0 or  TGPD(jqid)) then ----天霜结界
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[jqid]["内力最大值"])/1000)+3		
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if math.random(10)<4 then
			AddPersonAttrib(df, "冰封程度", math.modf(xx/2))
			if JY.Person[df]["冰封程度"]>100 then
            JY.Person[df]["冰封程度"]=100
			WAR.LRHF[df]= (WAR.LRHF[df] or 0) + math.modf(xx/4)
            AddPersonAttrib(df, "内力", -xn)			
			end
			 end 
			end
            end		    		
	end	

	if wglw(jqid, 8)>2 and WAR.LYLZ2[jqid] ~= nil and WAR.LYLZ2[jqid] == 5 then ----六阳掌元阴
for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=4			
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 if JY.Person[df]["冰封程度"] > 0 then 
			 xn = xn + math.modf(JY.Person[df]["冰封程度"]/5)
			AddPersonAttrib(df, "内力", -xn)
			 end
			end
            end		    		    		
	end	



	
	if nglw(jqid, 88)>1 and JLSD(0,30,jqid) then --吸星领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=(nglw(jqid, 88)+2)*2			
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if WAR.LXZT[WAR.Person[j]["人物编号"]] ~= nil and WAR.LXZT[WAR.Person[j]["人物编号"]] > 0 then 
                AddPersonAttrib(df, "生命", -xx)
				AddPersonAttrib(jqid, "生命", xx)
			 end
			AddPersonAttrib(df, "内力", -xn)
			AddPersonAttrib(jqid, "内力", xn)
            if nglw(jqid, 88)>2   then			
			WAR.XXQF[df]=(WAR.XXQF[df] or 0) + xx
			WAR.XXQG[jqid]=(WAR.XXQG[jqid] or 0) + xx
            end
			end
            end		    		
	end	

	if nglw(jqid, 163)>1 and JLSD(10,20,jqid) then --吸血领域
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=(nglw(jqid, 163)+2)*2			
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if WAR.LXZT[WAR.Person[j]["人物编号"]] ~= nil and WAR.LXZT[WAR.Person[j]["人物编号"]] > 0 then 
				AddPersonAttrib(jqid, "生命", xx)
			 end
			 if WAR.XQZZ[WAR.Person[j]["人物编号"]] ~= nil and WAR.XQZZ[WAR.Person[j]["人物编号"]] > 0 then 
				AddPersonAttrib(jqid, "生命", xx)
			 end
			AddPersonAttrib(jqid, "生命", xn)
			end
		if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and WAR.XDLZ2[df] == 1 then
		     local xn=10
			 if offset<=10 then
			 offset=10-offset
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			AddPersonAttrib(jqid, "生命", xn)
			AddPersonAttrib(df, "生命", xx)
			end	
			
            end		    		
	end
	
					--落英领悟，散华领域
	if  wglw(jqid,12)>2  then 
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[jqid]["拳掌功夫"]+TrueYJ(jqid))/60)+3		
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if math.random(30)<4+mpdj then
			    xx=xx*3
			 end			 
			 if math.random(10)<4+mpdj then
			 WAR.LXZT[WAR.Person[j]["人物编号"]]=(WAR.LXZT[WAR.Person[j]["人物编号"]] or 0) +math.random(1,5)
			    if WAR.LXZT[WAR.Person[j]["人物编号"]]>= 100 then----
				WAR.LXZT[WAR.Person[j]["人物编号"]] = 100
				end
			 end
			 if WAR.LXZT[WAR.Person[j]["人物编号"]] ~= nil and WAR.LXZT[WAR.Person[j]["人物编号"]] > 0 then 
                AddPersonAttrib(df, "生命", -xx)
			 end
			 if JY.Person[WAR.Person[j]["人物编号"]]["生命"] <= 0 then
			    WAR.Person[j]["死亡"] = true 					   
			 end   
			end
            end		    		
	end

	if  wglw(jqid,126)>1  then 
		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=math.modf((JY.Person[jqid]["拳掌功夫"]+TrueYJ(jqid))/60)+3		
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
		     local xn=10+mpdj
			 if offset<=10 then
			 xn=xn+math.modf(offset*2)
			 end
			 local xx=math.modf(xn/2)
			 if math.random(30)<4+mpdj then
			    xx=xx*3
			 end			 
			 if math.random(10)<4+mpdj or WAR.FXDS[WAR.Person[j]["人物编号"]] ~= nil then
			 WAR.MBZ[WAR.Person[j]["人物编号"]]=(WAR.MBZ[WAR.Person[j]["人物编号"]] or 0) +math.random(1,5)
			    if WAR.MBZ[WAR.Person[j]["人物编号"]]>= 100 then----
				WAR.MBZ[WAR.Person[j]["人物编号"]] = 100
				WAR.XRZT[WAR.Person[j]["人物编号"]] = (WAR.XRZT[WAR.Person[j]["人物编号"]] or 0) + 1
				end
			 end
			 if WAR.MBZ[WAR.Person[j]["人物编号"]] ~= nil and WAR.MBZ[WAR.Person[j]["人物编号"]] > 0 then 
                AddPersonAttrib(df, "内力", -xx)
			 end
			 if JY.Person[WAR.Person[j]["人物编号"]]["生命"] <= 0 then
			    WAR.Person[j]["死亡"] = true 					   
			 end   
			end
            end		    		
	end

	if  wglw(jqid,51)>1 and WAR.LSDZ[jqid]~=nil  then 

		for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			local offset=offset1+offset2
            local mpdj=wglw(jqid,51)*2+1		
			     if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
				 	local xn=10+mpdj
			             if offset<=10 then
			                 xn=xn+math.modf(offset*2)
			             end
			        local xx=math.modf(xn*5)
                    if WAR.LSDZ[jqid] == 4 then
					    	if math.random(30)<4+mpdj then
			                   WAR.LRHF[df]=(WAR.LRHF[df] or 0) +math.random(1,5)
			                end  
					elseif WAR.LSDZ[jqid] == 5 then
							if math.random(30)<4+mpdj then
			                   WAR.POISON[df]=(WAR.POISON[df] or 0) +math.random(1,5)
							   WAR.L_WNGZL[df] = (WAR.L_WNGZL[df] or 0) +math.random(1,5)
			                end
                            if WAR.GSSL[jqid]~=nil and WAR.GSSL[jqid] == 5  then
							local aa = JY.Person[df]["中毒程度"]
                            AddPersonAttrib(jqid, "生命", xx)
                            end							
					elseif WAR.LSDZ[jqid] == 6 then
							if math.random(30)<4+mpdj then
			                   WAR.JSCL[df]=(WAR.JSCL[df] or 0) +math.random(1,5)
			                end 					
					end
					if match_ID_awakened(jqid,90,1) and JY.Person[49]["论剑奖励"] == 1 then
					 AddPersonAttrib(df, "内力", -xx*5)
					 AddPersonAttrib(jqid, "生命", xx)
					end
					if match_ID_awakened(jqid,90,1) and JY.Person[49]["论剑奖励"] == 2 and WAR.YSLS[jqid]~=nil then
							if math.random(30)<6 then
			                   if WAR.YSLS[jqid] == 1 then
							   AddPersonAttrib(df, "中毒程度", xx)
							   elseif WAR.YSLS[jqid] == 2 then
							   WAR.LXZT[df] = limitX((WAR.LXZT[df] or 0)+xx,0,100)
							   WAR.LXXS[df] = 1
							   elseif WAR.YSLS[jqid] == 3 then
							   WAR.CHZ[df] = limitX((WAR.CHZ[df] or 0)+xx,0,100)
							   WAR.CHXS[df] = 1
							   elseif WAR.YSLS[jqid] == 4 then
							   WAR.LQZ[df] = limitX((WAR.LQZ[df] or 0)-xx,0,100)
							       if WAR.LQZ[df]<0 then
							          WAR.LQZ[df] = nil
							       end
							   end
			                end 
					end					
					 if  WAR.GSSL[jqid]~=nil and WAR.GSSL[jqid] == 3  and WAR.YY_Counter == 10  then
					 				local s = WAR.CurID
				WAR.CurID = j	
				WarDrawMap(0)
			    CurIDTXDH(WAR.CurID, 25, 1, "无量.夺魄刀气", Violet)
				lib.Delay(100)
                WAR.Person[j]["伤害爆裂"] = (WAR.Person[j]["伤害爆裂"] or 0) + xx
				        WAR.CurID = s
 
		             end
			     end
            end		    		
	end
	
	if WAR.BDYJ[jqid]~= nil  then
		if WAR.YY_Counter == 10  then
		local s = WAR.CurID
			WAR.CurID = i	
			WarDrawMap(0)
			CurIDTXDH(WAR.CurID, 52, 1, "爆弹.自爆", Violet)
			lib.Delay(100)
			local aa = 1
			if WAR.BDYJ[jqid]>1 then
				aa = math.random(1,WAR.BDYJ[jqid])
			end
			local xx = math.modf(JY.Person[jqid]["生命最大值"]* 0.1*aa)
	        AddPersonAttrib(jqid, "生命", -xx)
			if JY.Person[jqid]["生命"] <= 0 then
				local dam = math.modf(2*(JY.Person[jqid]["内力最大值"]/20))
		        WAR.MJZBZD = {dam, i, WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]}							
			end 
			WAR.CurID = s
            reseteffect2(WAR.BDYJ, jqid, aa)
		end	
	end
	if (wglw(jqid,22)>2 and PersonKFJ(jqid,22)) and WAR.Person[i]["死亡"] == false and WAR.Actup[WAR.Person[i]["人物编号"]] ~= nil  then --刚掌斗气阵
		local x1 = WAR.Person[i]["坐标X"];
		local y1 = WAR.Person[i]["坐标Y"];	
		for ex = x1 - 8, x1 + 8 do
			for ey = y1 - 8, y1 + 8 do
				SetWarMap(ex, ey, 4, 1)
				if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
					local ep = GetWarMap(ex, ey, 2)
					if WAR.Person[ep]["我方"] ~= WAR.Person[i]["我方"]   then
						if  math.random(10) == 3 then
							WAR.Person[ep].Time = WAR.Person[ep].Time - 200
							if WAR.Person[ep].Time < -500 then 
								WAR.Person[ep].Time = -500 
							end
						end
						if  math.random(10) <= 2 then
							WAR.FXDS[WAR.Person[ep]["人物编号"]]	= (WAR.FXDS[WAR.Person[ep]["人物编号"]] or 0) + math.random(3,5)
							if WAR.FXDS[WAR.Person[ep]["人物编号"]] >= 10 then
								addeffect2(WAR.MKDS,WAR.Person[ep]["人物编号"],1)
								if WAR.MKDS[WAR.Person[ep]["人物编号"]]>= 7  then
									WAR.MKDS[WAR.Person[ep]["人物编号"]] = 7
								end
							end						   
						end
					end
				end
			end
		end
	end
			--易筋经回内
			if PersonKF(jqid, 108) then
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 6
			end
			
			--运功时，内力低于500，停运
			--[[if JY.Person[jqid]["主运内功"] > 0 and JY.Person[jqid]["内力"] < 500 then
				JY.Person[jqid]["主运内功"] = 0
			end
			--运功时，体力低于10，停运
			if JY.Person[jqid]["主运内功"] > 0 and JY.Person[jqid]["体力"] < 10 then
				JY.Person[jqid]["主运内功"] = 0
			end]]
				
			--我方运功耗内		--飝
			if JY.Person[jqid]["主运内功"] > 0 and inteam(jqid) then
				--主运天内
				if JY.Person[jqid]["主运内功"] == JY.Person[jqid]["天赋内功"] then
					--队友耗3，主角不耗
					if jqid ~= 0 then
						JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - 3
					end
				--门派主运
				elseif MP_ZY(jqid) then
					if jqid ~= 0 then --队友耗3，主角不耗
						JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - 3
					end							
				else--非主运天内，耗9
				    if wglw(jqid,18) >=1 then
					   	if jqid ~= 0 then
						JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - 3
					    end
					else
					JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - 9
					end
				end
			end
	
		--蓝烟清：迟缓值回复
		if WAR.CHZ[jqid] ~= nil then
		    if WAR.CHZ[jqid] > 100 then --17-2-12--
			   WAR.CHZ[jqid] = 100
			end   
			WAR.CHZ[jqid] = WAR.CHZ[jqid] - 1;
			
			if PersonKF(jqid, 108) then --nino 易筋经回迟缓加倍
				WAR.CHZ[jqid] = WAR.CHZ[jqid] - 1;
			end
			
			if Curr_NG(jqid, 99) then --纯阳主功体 回复迟缓
				WAR.CHZ[jqid] = WAR.CHZ[jqid] - 1;
			elseif PersonKF(jqid, 99) then --nino 纯阳回复0-1
				WAR.CHZ[jqid] = WAR.CHZ[jqid] - math.random(0,1);
			end
			
			if WAR.LQZ[jqid] == 100 then --怒气值100恢复加倍
				WAR.CHZ[jqid] = WAR.CHZ[jqid] - 1;
			end
			
			if WAR.CHZ[jqid] < 1 then
				WAR.CHZ[jqid] = nil;
			end
		end
	
		if WAR.MBZ[jqid] ~= nil then
		    if WAR.MBZ[jqid] > 100 then --17-2-12--
			   WAR.MBZ[jqid] = 100
			end   
			WAR.MBZ[jqid] = WAR.MBZ[jqid] - 1;
			
			
			if WAR.LQZ[jqid] == 100 then --怒气值100恢复加倍
				WAR.MBZ[jqid] = WAR.MBZ[jqid] - 1;
			end
			if WAR.ZLBH[jqid]~= nil then
			    JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - 15*WAR.ZLBH[jqid]
				if JY.Person[jqid]["内力"] < 1 then
					JY.Person[jqid]["内力"] = 0
				end
			end
			if WAR.XSBL[jqid]~= nil then
			    JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - 5*WAR.XSBL[jqid]
				if JY.Person[jqid]["生命"] < 1  then
					JY.Person[jqid]["生命"] = 0
				end
			end			
			if WAR.BAHK[jqid]~= nil and math.random(1,20)<5 then
			    JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] - 1*WAR.BAHK[jqid]
				if JY.Person[jqid]["体力"] < 1  then
					JY.Person[jqid]["体力"] = 0
				end
			end				
			if WAR.MBZ[jqid] < 1 then
				WAR.MBZ[jqid] = nil;
				WAR.ZLBH[jqid] = nil
				WAR.XSBL[jqid] = nil
				WAR.BAHK[jqid] = nil
			end
		end
	
			--每时序回复1点流血
			if WAR.LXZT[jqid] ~= nil then
			    local aa=0
				if inteam(jqid) then
					aa = aa+ math.random(3) + math.modf(JY.Person[jqid]["受伤程度"] / 15)
					if WAR.HOT[jqid]~=nil then
					aa = aa+ math.random(5,10)
					end
				else
					aa = aa + 1 + math.modf(JY.Person[jqid]["受伤程度"] / 51)
					if WAR.HOT[jqid]~=nil then
					aa = aa+ math.random(3,5)
					end
				end
				if WAR.YZSF[jqid]~=nil or WAR.MK_XXC[jqid]~=nil then
				   aa = aa*2
				   if WAR.YZSY[jqid]~=nil and math.random(10) == 3 then
				   aa = aa*2
				   end
				end
				if WAR.KQB[jqid]~=nil  then
				   aa = aa * 5
				end
				if WAR.RXSD[jqid] ~= nil then----
				   local bb = math.modf(JY.Person[jqid]["中毒程度"]/10)
				   aa = aa + bb
				end
				if WAR.CYJY[jqid] ~=nil then
					local bb = 10*WAR.CYJY[jqid]
					aa = aa + bb
				end
				if aa>0 then
				    if nglw(jqid,163)>=1 then
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] +aa*nglw(jqid,163)
					else	
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] -aa
					end
					if WAR.L_WNGZL3[jqid]~=nil then
					   JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] -aa
					   if JY.Person[jqid]["内力"] < 1  then
					     JY.Person[jqid]["内力"] = 0
				       end
					end
				end
				
				if WAR.LXZT[jqid] >= 50 and WAR.L_HBJD[jqid]~=nil then
				   		for j = 0, WAR.PersonNum-1 do 
			                local df = WAR.Person[j]["人物编号"] 
			                local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
                            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			                 local offset=offset1+offset2	
			               if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=5 and offset2<=5) then
                              WAR.L_WNGZL3[df] = (WAR.L_WNGZL3[df] or 0) + 10
			               end			
                       end				
				end
				
				if JY.Person[jqid]["生命"] < 1 and WAR.LXBZ[jqid] == nil and WAR.YZSF[jqid]==nil and WAR.MK_XXC[jqid]==nil then
					JY.Person[jqid]["生命"] = 1
				end
				
				if WAR.YZSF[jqid]==nil then
				    WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
					if WAR.RXSD[jqid] ~= nil and WAR.RXSD[jqid] > 0 then 
			           WAR.RXSD[jqid] = WAR.RXSD[jqid] - 1
			           if WAR.RXSD[jqid] <= 0 then
				          WAR.RXSD[jqid] = nil
			           end		
		            end	
				
				--主运乾坤，罗汉额外恢复流血
				if Curr_NG(jqid, 97) or Curr_NG(jqid, 96) then
					WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
				end
				
				if  WAR.JYHT[jqid] ~= nil then --17-2-8
				WAR.LXZT[jqid] = 0
			    end	 
				

				end
				if WAR.LXZT[jqid] < 1 or (WAR.YZSF[jqid]~=nil and WAR.YZSY2[jqid]~=nil and math.random(10) == 3) then
					WAR.LXZT[jqid] = nil
					if WAR.L_WNGZL3[jqid]~=nil then
					local s = WAR.CurID
						WAR.CurID = i
                        CurIDTXDH(WAR.CurID, 25, 1, "血气凝固.崩坏")
						JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - 100
						if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						break
					    end	
                        WAR.CurID = s				
					end
					if WAR.YZSF[jqid]~=nil and WAR.YZSY2[jqid]~=nil then
					    local s = WAR.CurID
						WAR.CurID = i
                        CurIDTXDH(WAR.CurID, 49, 1, "阳亢肺损.血崩")
						JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - 400
						if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						break
					    end	
                        WAR.CurID = s
					end
					if WAR.JYWR_XF[jqid]~=nil then
					local aa = WAR.JYWR[jqid] or 0
					    for j = 0, WAR.PersonNum-1 do 
			                local df = WAR.Person[j]["人物编号"] 
			                local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
                            local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			                 local offset=offset1+offset2
                            local mpdj= aa + 2		
			               if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and (offset1<=mpdj and offset2<=mpdj) then
                              WAR.JHLY2[df] = (WAR.JHLY2[df] or 0) + 5*(aa+1)
			               end
			
                       end	
					end
				end
			end
			
			
			if (wglw(jqid,8)>2 or match_ID_awakened(jqid, 116,1)) and WAR.LYLZ[jqid]~=nil then
			   if WAR.LYLZ[jqid]>=1 and WAR.LYLZ[jqid]<=3 then
			      JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] +WAR.LYLZ[jqid]
			      if JY.Person[jqid]["灼烧程度"] >= 50 then
					JY.Person[jqid]["灼烧程度"] = 50
				   end
			   elseif WAR.LYLZ[jqid]>=4 and WAR.LYLZ[jqid]<=6 then
			   	  JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] +WAR.LYLZ[jqid]-3
			      if JY.Person[jqid]["冰封程度"] >= 100 then
					JY.Person[jqid]["冰封程度"] = 100
				   end
			   
			   end
			
			end
			
			
			--每时序回复1点冰封
			if JY.Person[jqid]["冰封程度"] > 0 then
				--每时序-5内
				local aa=5

				
				--深度冰封每时序-15内
				if JY.Person[jqid]["冰封程度"] >= 50 then
					aa=aa+5
				end
				
				if WAR.ICE[jqid]~=nil then
					aa=aa*2
					if math.random(1,10)<3 then
					aa=aa*10
					end
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] +math.random(1,3)
					if JY.Person[jqid]["冰封程度"]>=100 then
					JY.Person[jqid]["冰封程度"]=100
					end
				end

				if WAR.YZSS[jqid]~=nil then
					aa=aa*2
					if math.random(1,10)<5 then
					aa=aa*10
					end
				end				

				if PersonKF(jqid, 191) then
					aa=math.modf(aa*0.5)
				end
				
				if  wglw(jqid,8)>2 or match_ID_awakened(jqid, 116,1) or match_ID_awakened(jqid, 117,1) then
			        aa=-aa
			    end
				
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] - aa
				if JY.Person[jqid]["内力"] < 0 then
					JY.Person[jqid]["内力"] = 0
					if WAR.YZSS[jqid]~=nil and WAR.YZSY[jqid]~=nil then
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf(aa/3)
					end
					if WAR.ICE[jqid]~=nil then
					   WAR.LRHF[jqid]=(WAR.LRHF[jqid] or 0) +math.random(1,3)
					   if WAR.LRHF[jqid]>=50 then
					   WAR.LRHF[jqid]=50
					   end
					end
				end
				
				if JY.Person[jqid]["内力"] >= JY.Person[jqid]["内力最大值"] then
					JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
				end
				if WAR.HDQM[jqid]==nil then
				JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
				
				--主运纯阳，九阳，桃华额外恢复冰封
				if Curr_NG(jqid, 99) or Curr_NG(jqid, 106) or Curr_NG(jqid, 191) then
					JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
				end

				if  WAR.JYHT[jqid] ~= nil then --17-2-8
				JY.Person[jqid]["冰封程度"] = 0
			    end	 
		
				   if JY.Person[jqid]["冰封程度"] < 0 then
					  JY.Person[jqid]["冰封程度"] = 0
					  if WAR.L_HBJD[jqid]~=nil then
					    local s = WAR.CurID
						 WAR.CurID = i
                         CurIDTXDH(WAR.CurID, 78, 1, "红冰激发.血沸")
					     WAR.LSQ[jqid] = 50
						 WAR.JHLY[jqid] = 10
						 WAR.CurID = s
					  end
				   end
				end
			end
			
			--每时序回复1点灼烧
			if JY.Person[jqid]["灼烧程度"] > 0 then
			    if  wglw(jqid,8)>2 or match_ID_awakened(jqid, 116,1) or match_ID_awakened(jqid, 117,1) then
			        local aa=math.modf(JY.Person[jqid]["灼烧程度"]*0.3)
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + aa
					if JY.Person[jqid]["生命"] >= JY.Person[jqid]["生命最大值"] then
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
				    end
			    end
				
				
				JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
				
				--主运九阴额外恢复灼烧
				if Curr_NG(jqid, 107) then
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
				end
				
				--枯荣额外恢复灼烧
				if match_ID(jqid, 102) then
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
				end
				
				if WAR.HOT[jqid]~=nil then
					JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] + 1
					if JY.Person[jqid]["灼烧程度"] >= 50 then--
					JY.Person[jqid]["灼烧程度"] = 50
					end
				end
				
				if PersonKF(jqid,179) then
	                JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
					if Curr_NG(jqid,179) then
	                JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 2
	                end
	            end
			
				if JY.Person[jqid]["灼烧程度"] < 0 then
					JY.Person[jqid]["灼烧程度"] = 0
				end
				
				if  nglw(jqid,93)> 1 or WAR.JYHT[jqid] ~= nil then --17-2-8
				JY.Person[jqid]["灼烧程度"] = 0
			    end	
				
			end
			
			--无酒不欢：时序回复内伤的设定
			if JY.Person[jqid]["受伤程度"] > 0 then
				--1时序回1内伤的判定
				--碧海
				if  Curr_NG(jqid, 172)  then
                    JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
				end	
				
				--3时序回1内伤的判定
				--紫霞，逆运，九阴，金刚，九阳，化功，吸星，北冥，太玄，易筋经，玉女心经，金关，灵蛇玄功
				if Curr_NG(jqid, 89) or Curr_NG(jqid, 104) or Curr_NG(jqid, 107) or Curr_NG(jqid, 144) or Curr_NG(jqid, 106) or Curr_NG(jqid, 87) or Curr_NG(jqid, 88) or Curr_NG(jqid, 85) or Curr_NG(jqid, 102) or Curr_NG(jqid, 108) or Curr_NG(jqid, 154) or Curr_NG(jqid, 169) or Curr_NG(jqid, 178)  or Curr_NG(jqid, 180) then
					if WAR.SSX_Counter == 3 then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					end
				end

				--5时序回1内伤的判定
				--混元，圣火，葵花，八荒，先天，蛤蟆，龙象，小无，寒冰真气
				if Curr_NG(jqid, 90) or Curr_NG(jqid, 93) or Curr_NG(jqid, 105) or Curr_NG(jqid, 101) or Curr_NG(jqid, 100) or Curr_NG(jqid, 95) or Curr_NG(jqid, 103) or Curr_NG(jqid, 98) or Curr_NG(jqid, 175) or Curr_NG(jqid, 179) then
					if WAR.WSX_Counter == 5 then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					end
				end
				
				--主运天赋内功或门派主运，5时序额外回1内伤
				if JY.Person[jqid]["主运内功"] ~= 0 and JY.Person[jqid]["主运内功"] == JY.Person[jqid]["天赋内功"] then
					if WAR.WSX_Counter == 5 then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					end
				elseif MP_ZY(jqid) then
					if WAR.WSX_Counter == 5 then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					end
				end
							
				--主运三神功内伤大于50时，额外回复
				if JY.Person[jqid]["受伤程度"] > 50 and (Curr_NG(jqid, 106) or Curr_NG(jqid, 107) or Curr_NG(jqid, 108)) then
					if WAR.SSX_Counter == 3 then
						JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
					end
				end
				
				if  WAR.JYHT[jqid] ~= nil then --17-2-8
				JY.Person[jqid]["受伤程度"] = 0
			    end	
				
			end
			
			--纯阳，九阳，逆运，易筋经，每时序回复1点中毒
			if JY.Person[jqid]["中毒程度"] > 0 then	
			    local aa = JY.Person[jqid]["中毒程度"]
			    if (Curr_NG(jqid, 99) or Curr_NG(jqid, 106) or Curr_NG(jqid, 104) or Curr_NG(jqid, 108) ) then
				JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - 1
				    if nglw(jqid, 99)>1 then
					JY.Person[jqid]["中毒程度"] = 0
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + aa
					end
				end
				if  WAR.JYHT[jqid] ~= nil then --17-2-8
				JY.Person[jqid]["中毒程度"] = 0
			    end	
				
			end
			
				
			--回复体力
			if JY.Person[jqid]["体力"] < 100 then
				--主运混元，5时序回1体力
				if Curr_NG(jqid, 90) then
					if WAR.WSX_Counter == 5 then
						JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 1
					end
					if WAR.WSX_Counter == 2 and nglw(jqid,90)>1 then
						JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 3
						if nglw(jqid,90)>2 and HunZi(jqid)  then
						JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 3
						end
					end
				end
				--主运九阴，逆运，6时序回1体力
				if Curr_NG(jqid, 107) or Curr_NG(jqid, 104) then
					if WAR.LSX_Counter == 6 then
						JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 1
					end
				end
			else
			   	if nglw(jqid,90)>2 and HunZi(jqid) and WAR.WSX_Counter == 2  then
					AddPersonAttrib(jqid,"生命",30)
					AddPersonAttrib(jqid,"内力",300)
				end
			end
			
			--我方运轻功耗体
			if JY.Person[jqid]["主运轻功"] > 0 and inteam(jqid) then
				--天轻
				if JY.Person[jqid]["主运轻功"] == JY.Person[jqid]["天赋轻功"] then
					--队友每9时序耗1体力，主角不耗
					if jqid ~= 0 then
						if WAR.JSX_Counter == 9 then
							JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] - 1
						end
					end
				--非天轻，每6时序耗1体力
				else
					if WAR.LSX_Counter == 6 then
						JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] - 1
					end
				end
				--体力低于10，停运
				--[[if JY.Person[jqid]["体力"] < 10 then
					JY.Person[jqid]["主运轻功"] = 0
				end]]
			end
			
			if wglw(jqid,8)>=1  then
			  if WAR.LYLZ[jqid]==nil then
			     WAR.LYLZ[jqid]= 1
			  end
			  if WAR.YY_Counter == 10  then
			     WAR.LYLZ[jqid]= WAR.LYLZ[jqid] + 1
				 if WAR.LYLZ[jqid]==7 then
				    WAR.LYLZ[jqid] = 1
				 	if wglw(jqid,8)>=2  then
                    local s = WAR.CurID
					WAR.CurID = i
					Cls()
					lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
					CurIDTXDH(WAR.CurID, 183, 1, "阴阳逆转·阳炎爆发", PinkRed)
					WAR.CurID = s
							for j = 0, WAR.PersonNum-1 do 
			                    local df = WAR.Person[j]["人物编号"] 
			                    local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
                                local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			                    local offset=offset1+offset2
                                local mpdj=math.modf((JY.Person[jqid]["内力最大值"])/1000)+3		
			                         if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
		                                local xn=10+mpdj
			                            if offset<=10 then
			                                offset=10-offset
			                                 xn=xn+math.modf(offset*2)
			                            end
			                            local xx=math.modf(xn/2)
										WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) + AddPersonAttrib(df, "生命", -xn)
			                            AddPersonAttrib(df, "灼烧程度", math.modf(xx/2))
                                        WAR.TXXS[df] = 1
			                         end
                            end	
				    end
				 end
				 if wglw(jqid,8)>=2  then
				    if WAR.LYLZ[jqid] == 4 then
					local s = WAR.CurID
					WAR.CurID = i
					Cls()
					lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
					CurIDTXDH(WAR.CurID, 182, 1, "阴阳逆转·阴寒笼罩", PinkRed)
					WAR.CurID = s  
                        	for j = 0, WAR.PersonNum-1 do 
			                    local df = WAR.Person[j]["人物编号"] 
			                    local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
                                local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			                    local offset=offset1+offset2
                                local mpdj=math.modf((JY.Person[jqid]["内力最大值"])/1000)+3		
			                         if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
		                                local xn=10+mpdj
			                            if offset<=10 then
			                                offset=10-offset
			                                 xn=xn+math.modf(offset*2)
			                            end
			                            local xx=math.modf(xn/2)
										xn = xn*2
										WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) + AddPersonAttrib(df, "内力", -xn)
			                            AddPersonAttrib(df, "冰封程度", math.modf(xx/2))
                                        WAR.TXXS[df] = 1
			                         end
                            end						
					end
				 end
			  end
			
			end


			if wglw(jqid,47)>=1  then
			  if WAR.DGPZ1[jqid]==nil then
			     WAR.DGPZ1[jqid]= 1
			  end
			  if WAR.YY_Counter == 10  then
			     WAR.DGPZ1[jqid]= WAR.DGPZ1[jqid] + 1
				 if WAR.DGPZ1[jqid]==7 then
				    WAR.DGPZ1[jqid] = 1
				 end
			  end			
			end

            if match_ID_awakened(jqid,90,1) and WAR.ZMKZ[jqid] == nil then
			   WAR.ZMKZ[jqid] = 1
					local s = WAR.CurID
					WAR.CurID = i
					Cls()
					lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
					CurIDTXDH(WAR.CurID, 124, 1, "万劫罗刹.开阵", PinkRed)
					War_ActupMenu()
					WAR.CurID = s  
			end

            if match_ID(jqid,655) and WAR.ZBX[jqid] == nil and (WAR.SXTJ <= 1 or match_ID_awakened(jqid,655,1) ) then
			   WAR.ZBX[jqid] = 5
					local s = WAR.CurID
					WAR.CurID = i
					Cls()
					lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
					if WAR.SXTJ <= 1  then
					CurIDTXDH(WAR.CurID, 83, 1, "铁血少年团恭迎总舵主", PinkRed)
					else
					CurIDTXDH(WAR.CurID, 66, 1, "总舵主撑住", PinkRed)
					end
					WAR.CurID = s  
			end
			
            if match_ID_awakened(jqid,100,1) and WAR.ZMKZ[jqid] == nil then
			   WAR.ZMKZ[jqid] = 1
					local s = WAR.CurID
					WAR.CurID = i
					Cls()
					lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
					CurIDTXDH(WAR.CurID, 114, 1, "鹤之架构.开", PinkRed)
					War_ActupMenu()
					WAR.CurID = s  
			end			

			if WAR.DGPZ2[jqid]~=nil  then
			  if WAR.YY_Counter == 10  then
                 WAR.DGPZ2[jqid] = nil
			  end			
			end

				--虚弱状态
				if WAR.XRZT[jqid] ~= nil then
					WAR.XRZT[jqid] = WAR.XRZT[jqid] - 1
					if WAR.XRZT[jqid] < 1 then
						WAR.XRZT[jqid] = nil
					end
				end

				if WAR.RJZT[jqid] ~= nil then
					WAR.RJZT[jqid] = WAR.RJZT[jqid] - 1
					if WAR.RJZT[jqid] < 1 then
						WAR.RJZT[jqid] = nil
					end
				end
				
				if WAR.NKZT[jqid] ~= nil then
					WAR.NKZT[jqid] = WAR.NKZT[jqid] - 1
					if WAR.NKZT[jqid] < 1 then
						WAR.NKZT[jqid] = nil
					end
				end				

				--金刚斗气状态
				if WAR.JGDQ[jqid] ~= nil then
					WAR.JGDQ[jqid] = WAR.JGDQ[jqid] - 1
					if WAR.JGDQ[jqid] < 1 then
						WAR.JGDQ[jqid] = nil
					end
				end
								--虚弱状态
				if WAR.LUCK[jqid] ~= nil then
					WAR.LUCK[jqid] = WAR.LUCK[jqid] - 1
					if WAR.LUCK[jqid] < 1 then
						WAR.LUCK[jqid] = nil
					end
				end

				if WAR.UNLUCK[jqid] ~= nil then
					WAR.UNLUCK[jqid] = WAR.UNLUCK[jqid] - 1
					if WAR.UNLUCK[jqid] < 1 then
						WAR.UNLUCK[jqid] = nil
					end
				end

				if WAR.SILENCE[jqid] ~= nil then
					WAR.SILENCE[jqid] = WAR.SILENCE[jqid] - 1
					if WAR.SILENCE[jqid] < 1 then
						WAR.SILENCE[jqid] = nil
					end
				end	
				
				if WAR.HIDE[jqid] ~= nil then
					WAR.HIDE[jqid] = WAR.HIDE[jqid] - 1
					if WAR.HIDE[jqid] < 1 then
						WAR.HIDE[jqid] = nil
					end
				end	

				if WAR.DSTG[jqid] ~= nil then
					WAR.DSTG[jqid] = WAR.DSTG[jqid] - 1
					if WAR.DSTG[jqid] < 1 then
						WAR.DSTG[jqid] = nil
					end
				end	

				if WAR.LSGY[jqid] ~= nil then
					WAR.LSGY[jqid] = WAR.LSGY[jqid] - 1
					if WAR.LSGY[jqid] < 1 then
						WAR.LSGY[jqid] = nil
					end
				end	

				if WAR.HIDE2[jqid] ~= nil then
					WAR.HIDE2[jqid] = WAR.HIDE2[jqid] - 1
					if WAR.HIDE2[jqid] < 1 then
						WAR.HIDE2[jqid] = nil
					end
				end					

				if WAR.KHCM2[jqid] ~= nil then
					WAR.KHCM2[jqid] = WAR.KHCM2[jqid] - 1
					if WAR.KHCM2[jqid] < 1 then
						WAR.KHCM2[jqid] = nil
					end
				end	

				if WAR.KHCM3[jqid] ~= nil then
					WAR.KHCM3[jqid] = WAR.KHCM3[jqid] - 1
					if WAR.KHCM3[jqid] < 1 then
						WAR.KHCM3[jqid] = nil
					end
				end	

				if WAR.HIDE3[jqid] ~= nil then
					WAR.HIDE3[jqid] = WAR.HIDE3[jqid] - 1
					if WAR.HIDE3[jqid] < 1 then
						WAR.HIDE3[jqid] = nil
					end
				end	

				if WAR.BSYJ[jqid] ~= nil then
					WAR.BSYJ[jqid] = WAR.BSYJ[jqid] - 1
					if WAR.BSYJ[jqid] < 1 then
						WAR.BSYJ[jqid] = nil
					end
				end	

				if wglw(jqid,78)>=1 then
					WAR.SHAH[jqid] = (WAR.SHAH[jqid] or 0) + wglw(jqid,78)*5
					if WAR.LQZ[jqid] == 100 then
					WAR.SHAH[jqid] = (WAR.SHAH[jqid] or 0) + wglw(jqid,78)*5
					end
					if WAR.SHAH[jqid] >= 10000 then
						WAR.SHAH[jqid] = 10000
					end
			        if WAR.YY_Counter == 10  then
					   local add = WAR.SHAH[jqid] or 0
                       WAR.Person[i]["护盾"] = (WAR.Person[i]["护盾"] or 0) + math.modf(add/20)
					   WAR.SHAH[jqid] = WAR.SHAH[jqid] - math.modf(add/20)
			        end
					if wglw(jqid,78)>2 and WAR.SHAH[jqid]>2000 then
					   for j = 0, WAR.PersonNum-1 do 
			                    local df = WAR.Person[j]["人物编号"] 
			                    local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"]) 
                                local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
			                    local offset=offset1+offset2
                                local mpdj=math.modf((JY.Person[jqid]["内力最大值"])/1000)+3		
			                         if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
		                                local xn=10+mpdj
			                            if offset<=10 then
			                                offset=10-offset
			                                 xn=xn+math.modf(offset*2)
			                            end
			                            local xx=math.modf(xn/2)
										WAR.SHAH2[df] = (WAR.SHAH2[df] or 0) + xx
                                        WAR.TXXS[df] = 1
			                         end
                        end	
					end
					if wglw(jqid,78)>2 and JY.Person[jqid]["生命"]<= math.modf(JY.Person[jqid]["生命最大值"]*0.2) and WAR.SHAH[jqid]>3000 then
					   local add = WAR.SHAH[jqid] or 0
                       WAR.Person[i]["护盾"] = (WAR.Person[i]["护盾"] or 0) + math.modf(add/2)
					   WAR.SHAH[jqid] = WAR.SHAH[jqid] - math.modf(add/2)
					   WAR.L_HQNZL[jqid] = 20
					end
				end	

				if WAR.SKWJ[jqid] ~= nil then
					WAR.SKWJ[jqid] = WAR.SKWJ[jqid] - 1
					WAR.LRHF[jqid] = (WAR.LRHF[jqid] or 0)+ 1
					WAR.JHLY[jqid] = (WAR.JHLY[jqid]  or 0)+ 1
					WAR.L_WNGZL2[jqid] = (WAR.L_WNGZL2[jqid]  or 0) + 1
					WAR.POISON[jqid] = (WAR.POISON[jqid]  or 0) + 1
					if WAR.SKWJ[jqid] < 1 then
						WAR.SKWJ[jqid] = nil
					end
				end		
				
				if WAR.SFXW[jqid] ~= nil then
					WAR.SFXW[jqid] = WAR.SFXW[jqid] - 1
					if WAR.SFXW[jqid] < 1 then
						WAR.SFXW[jqid] = nil
						JY.Person[jqid]["体力"] = JY.Person[jqid]["体力"] + 10
					end
				end

				if WAR.ATKDOWN[jqid] ~= nil then
					WAR.ATKDOWN[jqid] = WAR.ATKDOWN[jqid] - 1
					if WAR.ATKDOWN[jqid] < 1 then
						WAR.ATKDOWN[jqid] = nil
					end
				end	

				if WAR.SPDDOWN[jqid] ~= nil then
					WAR.SPDDOWN[jqid] = WAR.SPDDOWN[jqid] - 1
					if WAR.SPDDOWN[jqid] < 1 then
						WAR.SPDDOWN[jqid] = nil
					end
				end	

				if WAR.DEFDOWN[jqid] ~= nil then
					WAR.DEFDOWN[jqid] = WAR.DEFDOWN[jqid] - 1
					if WAR.DEFDOWN[jqid] < 1 then
						WAR.DEFDOWN[jqid] = nil
					end
				end	

				if WAR.ATKUP[jqid] ~= nil then
					WAR.ATKUP[jqid] = WAR.ATKUP[jqid] - 1
					if WAR.ATKUP[jqid] < 1 then
						WAR.ATKUP[jqid] = nil
					end
				end	

				if WAR.SPDUP[jqid] ~= nil then
					WAR.SPDUP[jqid] = WAR.SPDUP[jqid] - 1
					if WAR.SPDUP[jqid] < 1 then
						WAR.SPDUP[jqid] = nil
					end
				end	

				if WAR.DEFUP[jqid] ~= nil then
					WAR.DEFUP[jqid] = WAR.DEFUP[jqid] - 1
					if WAR.DEFUP[jqid] < 1 then
						WAR.DEFUP[jqid] = nil
					end
				end	
				
				if WAR.JSCL[jqid] ~= nil then
					WAR.JSCL[jqid] = WAR.JSCL[jqid] - 1
					if WAR.JSCL[jqid] < 1 then
						WAR.JSCL[jqid] = nil
					end
				end
				
				if WAR.JSCL2[jqid] ~= nil then
					WAR.JSCL2[jqid] = WAR.JSCL2[jqid] - 1
					if WAR.JSCL2[jqid] < 1 then
						WAR.JSCL2[jqid] = nil
					end
				end				
				
				if WAR.JHLY3[jqid] ~= nil then
					WAR.JHLY3[jqid] = WAR.JHLY3[jqid] - 1
					if WAR.JHLY3[jqid] < 1 then
						WAR.JHLY3[jqid] = nil
					end
				end	

				if WAR.QBLY[jqid] ~= nil then
					WAR.QBLY[jqid] = WAR.QBLY[jqid] - 1
					if WAR.QBLY[jqid] < 1 then
						WAR.QBLY[jqid] = nil
					end
				end	

				if WAR.QSLZ[jqid] ~= nil then
					WAR.QSLZ[jqid] = WAR.QSLZ[jqid] - 1
					if WAR.QSLZ[jqid] < 1 then
						WAR.QSLZ[jqid] = nil
					end
				end

				if WAR.HDQM[jqid] ~= nil then
					WAR.HDQM[jqid] = WAR.HDQM[jqid] - 1
					if WAR.HDQM[jqid] < 1 then
						WAR.HDQM[jqid] = nil
					end
				end

				
				if WAR.BYCX[jqid] ~= nil then
					WAR.BYCX[jqid] = WAR.BYCX[jqid] - 1
					if WAR.BYCX[jqid] < 1 then
						WAR.BYCX[jqid] = nil
					end
				end					

				if WAR.YZSX[jqid] ~= nil then
					WAR.YZSX[jqid] = WAR.YZSX[jqid] - 1
					if WAR.YZSX[jqid] < 1 then
						WAR.YZSX[jqid] = nil
					end
				end					
	
				if WAR.YZSG[jqid] ~= nil then
					WAR.YZSG[jqid] = WAR.YZSG[jqid] - 1
					if WAR.YZSG[jqid] < 1 then
						WAR.YZSG[jqid] = nil
					end
				end	

				if WAR.YZSP[jqid] ~= nil then
					WAR.YZSP[jqid] = WAR.YZSP[jqid] - 1
					if WAR.YZSP[jqid] < 1 then
						WAR.YZSP[jqid] = nil
					end
				end				

				if WAR.YZSF[jqid] ~= nil then
					WAR.YZSF[jqid] = WAR.YZSF[jqid] - 1
					if WAR.YZSF[jqid] < 1 then
						WAR.YZSF[jqid] = nil
					end
				end	

				if WAR.YZSS[jqid] ~= nil then
					WAR.YZSS[jqid] = WAR.YZSS[jqid] - 1
					if WAR.YZSS[jqid] < 1 then
						WAR.YZSS[jqid] = nil
					end
				end	
	
				if WAR.MK_DS[jqid] ~= nil then
					WAR.MK_DS[jqid] = WAR.MK_DS[jqid] - 1
					if WAR.MK_DS[jqid] < 1 then
						WAR.MK_DS[jqid] = nil
					end
				end					
	
				if WAR.MK_SH[jqid] ~= nil then
					WAR.MK_SH[jqid] = WAR.MK_SH[jqid] - 1
					if WAR.MK_SH[jqid] < 1 then
						WAR.MK_SH[jqid] = nil
					end
				end	

				if WAR.MK_XLT[jqid] ~= nil then
					WAR.MK_XLT[jqid] = WAR.MK_XLT[jqid] - 1
					if WAR.MK_XLT[jqid] < 1 then
						WAR.MK_XLT[jqid] = nil
					end
				end				

				if WAR.MK_JM[jqid] ~= nil then
					WAR.MK_JM[jqid] = WAR.MK_JM[jqid] - 1
					if WAR.MK_JM[jqid] < 1 then
						WAR.MK_JM[jqid] = nil
					end
				end	

				if WAR.MK_BH[jqid] ~= nil then
					WAR.MK_BH[jqid] = WAR.MK_BH[jqid] - 1
					if WAR.MK_BH[jqid] < 1 then
						WAR.MK_BH[jqid] = nil
					end
				end					
				--被破军打中的敌人，内功停运50时序
				if WAR.PJZT[jqid] ~= nil then
					WAR.PJZT[jqid] = WAR.PJZT[jqid] - 1
					if WAR.PJZT[jqid] < 1 then
						WAR.PJZT[jqid] = nil
						JY.Person[jqid]["主运内功"] = WAR.PJJL[jqid]
						WAR.PJJL[jqid] = nil
					end
				end

				if WAR.NWSS[jqid] ~= nil then
					WAR.NWSS[jqid] = WAR.NWSS[jqid] - 1
					if WAR.NWSS[jqid] < 1 then
						WAR.NWSS[jqid] = nil
					end
				end
				
				if WAR.NWCX[jqid] ~= nil then
					WAR.NWCX[jqid] = WAR.NWCX[jqid] - 1
					if WAR.NWCX[jqid] < 1 then
						WAR.NWCX[jqid] = nil
						if WAR.NWHD[jqid] ~= nil then
						WAR.NWHD[jqid] = nil
						end
						if WAR.NYHD[jqid] ~= nil then
						WAR.NYHD[jqid] = nil
						end
					end
				end				

				--阿紫曼珠沙华，每时序掉1%血
				if match_ID(jqid, 47) and WAR.JYZT[jqid]~=nil then
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf(JY.Person[jqid]["生命最大值"]*0.01)
					if JY.Person[jqid]["生命"] < 1 then
					    local s = WAR.CurID
						WAR.CurID = i
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						WAR.CurID = s
						break
					end
				end

				if WAR.BPYZ[jqid]~=nil then
					WAR.BPYZ[jqid] = WAR.BPYZ[jqid] - 1
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf((JY.Person[jqid]["中毒程度"]*math.random(0,1)*0.3))
					if JY.Person[jqid]["生命"] < 1 then
					    local s = WAR.CurID
						WAR.CurID = i
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						WAR.CurID = s
						break
					end
					if WAR.BPYZ[jqid] < 1 then
					    WAR.BPYZ[jqid] = nil
					 	local s = WAR.CurID
						local say = "毒发"
						local ani_num = 6
						WAR.CurID = i
                        CurIDTXDH(WAR.CurID, 71, 1, "冰魄剧毒.毒发")
						JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf((JY.Person[jqid]["中毒程度"]*1.1))
						if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						break
					    end	
                        WAR.CurID = s
						--恢复之前的画面
						--DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						--DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						--DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						--lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						--lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						--lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						--surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
					
						
					end
				end
				
				if WAR.BS_ZT[jqid]~=nil then
					WAR.BS_ZT[jqid] = WAR.BS_ZT[jqid] - 1
					if WAR.LRHF[jqid]~=nil then
					   AddPersonAttrib(jqid, "冰封程度",5)
					end
					if JY.Person[jqid]["冰封程度"]>0 then
					   JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf((JY.Person[jqid]["冰封程度"]*1.1))
						if JY.Person[jqid]["生命"] < 1 then
					    local s = WAR.CurID
						WAR.CurID = i
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						WAR.CurID = s
						break
					    end
					end
				    if WAR.BS_ZT[jqid]<1  then
					   WAR.BS_ZT[jqid] = nil
					   	local s = WAR.CurID
						WAR.CurID = i
						CurIDTXDH(WAR.CurID, 71, 1, "霜爆")
					local dam = JY.Person[jqid]["冰封程度"]*10
		            for j = 0, WAR.PersonNum - 1 do
			        if WAR.Person[i]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				        local bdid = WAR.Person[j]["人物编号"]
			        	local offset1 = math.abs(WAR.Person[i]["坐标X"] - WAR.Person[j]["坐标X"])
				        local offset2 = math.abs(WAR.Person[i]["坐标Y"] - WAR.Person[j]["坐标Y"])
				              if offset1 <= 4 and offset2 <= 4 then
					             WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) - dam
					             WAR.BFXS[bdid] = 1
					             JY.Person[bdid]["冰封程度"] = JY.Person[bdid]["冰封程度"] + math.random(10,20)
					             if JY.Person[bdid]["冰封程度"] >= 100 then
					                JY.Person[bdid]["冰封程度"] = 100
					             end
					             JY.Person[bdid]["内力"] = JY.Person[bdid]["内力"] - dam
					             if JY.Person[bdid]["内力"] < 0 then
						            JY.Person[bdid]["内力"] = 0
					             end
					            WAR.TXXS[bdid] = 1
				              end
			       end
		           end
				   WAR.CurID = s
				   end			
				end

				if WAR.BZSC[jqid]~=nil then
					WAR.BZSC[jqid] = WAR.BZSC[jqid] - 1
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + math.modf(JY.Person[jqid]["生命最大值"]*0.015)
					if WAR.BZSC[jqid] < 1 then
					    WAR.BZSC[jqid] = nil
					 	local s = WAR.CurID
						local bb = 0
						local ani_num = 6
						WAR.CurID = i
                        CurIDTXDH(WAR.CurID, 53, 1, "败者食尘")
						bb = JY.Person[jqid]["生命"]
						local dam = bb
		                WAR.HTZD = {dam, i, WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]}
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						break					    	
                        WAR.CurID = s
						--恢复之前的画面
						--DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						--DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						--DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						--lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						--lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						--lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						--surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
					
						
					end
				end

				
			if WAR.JCGD[jqid]~=nil then
					WAR.JCGD[jqid] = WAR.JCGD[jqid] - 1
					if WAR.JCGD[jqid] < 1 then
					    WAR.JCGD[jqid] = nil
					 	local s = WAR.CurID
						local say = ".爆裂蛊"
						local ani_num = 35
						if WAR.JJGD[jqid]~=nil then
						local aa = WAR.JJGD[jqid]
						local str ={".瘴雾黑蜈",".寒潭冰蝰",".赤沙之蝎",".彩雪花蛛",".箭毒血蛙",".天傀金蚕"}
						say = str[aa]
						ani_num = ani_num + aa
						   if aa == 1 then
						   WAR.XRZT[jqid] = 30
						   WAR.PJFY[jqid] = 30
				           WAR.HMZT[jqid] = 1
						   WAR.LSQ[jqid] = 30
						   elseif aa == 2 then
						   WAR.HDQM[jqid] = 30
						   if JY.Person[jqid]["冰封程度"]>0 then
						   local nlDam = JY.Person[jqid]["冰封程度"]*5
						   WAR.Person[i]["内力点数"] = (WAR.Person[i]["内力点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "内力", -nlDam)
						   end
						   JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] + 10
						   if JY.Person[jqid]["冰封程度"] >= 100 then--
					          JY.Person[jqid]["冰封程度"] = 100
					       end
						   
						   elseif aa == 3 then
						   WAR.JHLY3[jqid] =  30
						   if JY.Person[jqid]["灼烧程度"]>0 then
						   local nlDam = JY.Person[jqid]["灼烧程度"]
						   WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", -nlDam)
						   end
						   JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] + 10
						   if JY.Person[jqid]["灼烧程度"] >= 50 then--
					          JY.Person[jqid]["灼烧程度"] = 50
					       end

						   elseif aa == 4 then
						   WAR.L_NOT_MOVE[jqid] = 1
						   WAR.MENG[jqid] = 30
						   WAR.L_WNGZL2[jqid] = 30
						   elseif aa == 5 then
						   WAR.L_WNGZL[jqid] = 30
						   WAR.POISON[jqid] = 30
						   WAR.MLZS[jqid] = 30
						   else
						   WAR.AN[jqid] = 20
						   WAR.SUZUPID = 0
						   WAR.JSCL[jqid] = 20
						   end
						WAR.JJGD[jqid] = nil
						end
						WAR.CurID = i
						WAR.Person[i]["特效动画"] = ani_num
						WarDrawMap(0);
                        CurIDTXDH(WAR.CurID, ani_num, 1, "蛊毒破体"..say)
						War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
						JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf((JY.Person[jqid]["中毒程度"]*1.1))
						if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						WarSetPerson()
						Cls()
						ShowScreen()
						break
					    end	
                        WAR.CurID = s
						--恢复之前的画面
						--DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						--DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						--DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						--lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						--lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						--lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						--surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)						
					end
				end	
				
				--引燃：每时序损失1%当前血量
				if WAR.JHLY[jqid] ~= nil then
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf(JY.Person[jqid]["生命"]*0.01)

					if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 1
					end
					WAR.JHLY[jqid] = WAR.JHLY[jqid] - 1
					
					if WAR.JHLY[jqid] < 1 then
						WAR.JHLY[jqid] = nil
					end
				end

				--燃灯：每时序损失1%当前内力，并损耗相应的生命
				if WAR.JHLY2[jqid] ~= nil then
					local aa=math.max(math.modf(JY.Person[jqid]["内力"]*0.01),40)
					JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] -aa
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.max(math.modf(aa*0.5),20)
					if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 1
					end
					WAR.JHLY2[jqid] = WAR.JHLY2[jqid] - 1					
					if WAR.JHLY2[jqid] < 1 then
						WAR.JHLY2[jqid] = nil
						if WAR.HTZD2[jqid]~=nil then
						WAR.HTZD2[jqid] = nil
					 	local s = WAR.CurID
						local say = "活体爆炸"
						local ani_num = 6
						WAR.CurID = i
                        CurIDTXDH(WAR.CurID, 71, 1, "燃木.爆裂")
						JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf((JY.Person[jqid]["内力"]*0.1))
						if JY.Person[jqid]["生命"] < 1 then
						JY.Person[jqid]["生命"] = 0
						WAR.Person[WAR.CurID]["死亡"] = true
						local dam = math.modf((JY.Person[jqid]["灼烧程度"]/5)*(JY.Person[jqid]["内力最大值"]/20))
		                WAR.HTZD = {dam, WAR.CurID, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]}
						WarSetPerson()
						Cls()
						ShowScreen()
						break
					    end	
                        WAR.CurID = s
						end
					end
				end
				
			--无酒不欢：主运蛤蟆功时序增加怒气
			if (Curr_NG(jqid, 95) or MPPD(jqid) == 7) and BXZT(jqid) == 0 then
				if WAR.LQZ[jqid] == nil then
					WAR.LQZ[jqid] = 1
				elseif WAR.LQZ[jqid] < 100 then
					WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
					if MPPD(jqid) == 7 then
					WAR.LQZ[jqid] = WAR.LQZ[jqid] + MPDJ(jqid)
					   if WAR.LQZ[jqid] >= 100 then
					   WAR.LQZ[jqid] = 100
					   end
					end
					if MPPB_BTHM(jqid)>=1 and math.random(50) < 2 + MPPB_BTHM(jqid)  then
					   WAR.LQZ[jqid] = WAR.LQZ[jqid] + 20 + 10*MPPB_BTHM(jqid)
					   if WAR.LQZ[jqid] >= 100 then
					      if MPPB_BTHM(jqid)>1 then
						  local aa = math.modf(30*(WAR.LQZ[jqid]-100))
						  AddPersonAttrib(jqid, "生命", aa)
						  end
					   WAR.LQZ[jqid] = 100
					   end
					end
					if WAR.LQZ[jqid] == 100 then
						local s = WAR.CurID
						local say = "怒气爆发"
						local ani_num = 6
						WAR.CurID = i
						--东方不败，葵花秘法·化凤为凰
						if match_ID(jqid, 27) then
							say = "葵花秘法·化凤为凰"
							ani_num = 7
						end
						if WAR.HOT[jqid]~=nil and WAR.HOT[jqid]>0 then
			              	say = "怒火攻心"
							ani_num = 60
			              AddPersonAttrib(jqid, "受伤程度", 100)
			              AddPersonAttrib(jqid, "生命", -100)
			              WAR.LQZ[jqid] = nil
			            end
			if wglw(jqid,58)>1 and WAR.XLEB==0 and WAR.XLD[jqid] == nil then
			ani_num = 63
			say =  "雄霸天下.阿鼻三刀"
            WAR.XLEB = 3
			WAR.XLD[jqid]=1
			WAR.BDKY[jqid] = (WAR.BDKY[jqid] or 0) + 5
			end
			if wglw(jqid,74)>1 and WAR.SHJG[jqid] ~= nil and WAR.SHJG[jqid] == 4 then
			local bb= math.modf(JY.Person[jqid]["生命最大值"]*0.5)*JY.Person[jqid]["血量翻倍"]
            AddPersonAttrib(jqid, "受伤程度", -100)
			AddPersonAttrib(jqid, "生命", bb)
			ani_num = 66
			say = "咏春龟形.神龟呼吸"
			end
			if match_ID_awakened(jqid,103,1) and WAR.CHD==0 and WAR.JLL[jqid] == nil then
			ani_num = 71
			say =  "迦楼罗.明王残火刀"
            WAR.CHD = 4
			WAR.JLL[jqid]=1
			end
			if wglw(jqid,74)>1 and WAR.SHJG[jqid] ~= nil and WAR.SHJG[jqid] == 1 then
			ani_num = 65
			say =  "咏春蛇形.化龙"
            WAR.SHJG[jqid] = 3
			end
			if Curr_NG(jqid,175) then
			    local HN;
				local NS;
				HN=JY.Person[jqid]["受伤程度"]+JY.Person[jqid]["灼烧程度"]+JY.Person[jqid]["中毒程度"]+JY.Person[jqid]["冰封程度"]+(WAR.LXZT[jqid] or 0) + (WAR.CHZ[jqid] or 0)+ (WAR.MBZ[jqid] or 0)+(WAR.FXDS[jqid] or 0)
				AddPersonAttrib(jqid, "生命", HN);
					JY.Person[jqid]["受伤程度"]=0
					JY.Person[jqid]["灼烧程度"]=0
					JY.Person[jqid]["中毒程度"]=0
					JY.Person[jqid]["冰封程度"]=0
					WAR.LXZT[jqid] = nil
					WAR.CHZ[jqid] = nil
					WAR.MBZ[jqid] = nil
					WAR.FXDS[jqid] = nil
			end

					if MPPB_BTHM(jqid)>=2 then
			           local bb= math.modf(JY.Person[jqid]["生命最大值"]*0.5)*JY.Person[jqid]["血量翻倍"]
                        AddPersonAttrib(jqid, "受伤程度", -100)
			            AddPersonAttrib(jqid, "生命", bb)
					end		
			
						Cls()
						lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
						WarDrawMap(0);
						CurIDTXDH(WAR.CurID, ani_num, 1, say)
						WAR.CurID = s
						--恢复之前的画面
						--DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						--DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						--DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						--lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						--lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						--lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						--surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
					end
				end
			end
				if nglw(jqid,89)>2 and PersonKF(jqid,89) then---紫霞领悟剑气时许恢复
		        if WAR.ZXJQ[jqid] == nil then
					WAR.ZXJQ[jqid] = 1
				elseif WAR.ZXJQ[jqid] < 100 then
					WAR.ZXJQ[jqid] = WAR.ZXJQ[jqid] + 1
				end	   
			end
			
		if WAR.AN[jqid] ~= nil and WAR.SUZUPID ~= -1 then --阿奴夺魂指令
			local xixue = 0
			xixue = xixue + math.modf(JY.Person[jqid]["生命"]/200)
			xixue = xixue + math.modf(JY.Person[jqid]["中毒程度"]/25)
			JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - xixue
			if JY.Person[jqid]["生命"] <= 0 then 
				JY.Person[jqid]["生命"] = 1
			end
			AddPersonAttrib(WAR.SUZUPID, "生命", xixue)
			WAR.AN[jqid] = WAR.AN[jqid] - 1
			if WAR.AN[jqid] <= 0 then
				WAR.AN[jqid] = nil
				WAR.SUZUPID = -1
			end
		end
			
			
			--无酒不欢：萧远山时序增加怒气
			if match_ID(jqid, 112) and BXZT(jqid) == 0 then
				if WAR.LQZ[jqid] == nil then
					WAR.LQZ[jqid] = 1
				elseif WAR.LQZ[jqid] < 100 then
					WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
					if WAR.LQZ[jqid] == 100 then
						local s = WAR.CurID
						WAR.CurID = i
						Cls()
						lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
						CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
						if WAR.HOT[jqid]~=nil and WAR.HOT[jqid]>0 then
			             CurIDTXDH(WAR.CurID, 60, 1, "怒火攻心")
			              AddPersonAttrib(jqid, "受伤程度", 100)
			              AddPersonAttrib(jqid, "生命", -100)
			              WAR.LQZ[jqid] = nil
			            end
			if wglw(jqid,58)>1 and WAR.XLEB==0 and WAR.XLD[jqid] == nil then
			CurIDTXDH(WAR.CurID, 63, 1, "雄霸天下.阿鼻三刀")
            WAR.XLEB = 3
			WAR.XLD[jqid]=1
			WAR.BDKY[jqid] = (WAR.BDKY[jqid] or 0) + 5
			end
			if Curr_NG(jqid,175) then
			    local HN;
				local NS;
				HN=JY.Person[jqid]["受伤程度"]+JY.Person[jqid]["灼烧程度"]+JY.Person[jqid]["中毒程度"]+JY.Person[jqid]["冰封程度"]+(WAR.LXZT[jqid] or 0) + (WAR.CHZ[jqid] or 0)
				AddPersonAttrib(jqid, "生命", HN);
					JY.Person[jqid]["受伤程度"]=0
					JY.Person[jqid]["灼烧程度"]=0
					JY.Person[jqid]["中毒程度"]=0
					JY.Person[jqid]["冰封程度"]=0
					WAR.LXZT[jqid] = nil
					WAR.CHZ[jqid] = nil
			end
						WAR.CurID = s
						--恢复之前的画面
						--DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						--DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						--DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						--lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						--lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						--lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						--surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
					end
				end
			end

			--天山童姥：转瞬红颜
			if match_ID(jqid, 117) then
				if WAR.ZSHY[jqid] == nil then
					WAR.ZSHY[jqid] = 1
				else
					WAR.ZSHY[jqid] = WAR.ZSHY[jqid] + 1
				end
				if WAR.ZSHY[jqid] == 80 then
					WAR.ZSHY[jqid] = nil
					local s = WAR.CurID
					WAR.CurID = i
					Cls()
					lib.SetClip(0, CC.ScreenH/4 + 20, CC.ScreenW, CC.ScreenH)
					CurIDTXDH(WAR.CurID, 104, 1, "红颜弹指老·刹那芳华", PinkRed)
					WAR.CurID = s
					--恢复之前的画面
					--DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
					--DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
					--DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
					--lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
					--lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
					--lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
					--surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
					JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
					JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
					JY.Person[jqid]["体力"] = 100
					JY.Person[jqid]["中毒程度"] = 0
					JY.Person[jqid]["受伤程度"] = 0
					JY.Person[jqid]["冰封程度"] = 0
					JY.Person[jqid]["灼烧程度"] = 0
					--流血
					if WAR.LXZT[jqid] ~= nil then
						WAR.LXZT[jqid] = nil
					end
					--封穴
					if WAR.FXDS[jqid] ~= nil then
						WAR.FXDS[jqid] = nil
					end
				end
			end
			
			--主角医生回血内，减内伤，减中毒
			if jqid == 0 and JY.Base["标准"] == 8 then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + math.random(5);
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + math.random(5);
				JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] - math.random(5);
				JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - math.random(5);
			end
			
			--毒王时序增加中毒
			if jqid == 0 and JY.Base["标准"] == 9 then
				JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + math.random(5)
				if JY.Person[jqid]["中毒程度"] > 100 then
					JY.Person[jqid]["中毒程度"] = 100 
				end
				if JY.Person[jqid]["六如觉醒"] > 0 then
				local aa = math.modf(JY.Person[jqid]["中毒程度"]/10)
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + aa;
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + aa*3;
				end
			end
			
			--轻云蔽月时序计数
			if WAR.QYBY[jqid] ~= nil then
				WAR.QYBY[jqid] = WAR.QYBY[jqid] - 1	
				if WAR.QYBY[jqid] < 1 then
					WAR.QYBY[jqid] = nil
				end
			end

				--进阶泰山，使用后20时序内闪避
				if WAR.TSSB[jqid] ~= nil then
					WAR.TSSB[jqid] = WAR.TSSB[jqid] - 1
					if WAR.TSSB[jqid] < 1 then
						WAR.TSSB[jqid] = nil
					end
				end

				--无明业火状态，耗损使用的内力一半的生命，50时序
				if WAR.WMYH[jqid] ~= nil then
					WAR.WMYH[jqid] = WAR.WMYH[jqid] - 1
					if WAR.WMYH[jqid] < 1 then
						WAR.WMYH[jqid] = nil
					end
				end
				
			--蓝烟清：王难姑指令，按时序中毒
			if WAR.L_WNGZL[jqid] ~= nil and WAR.L_WNGZL[jqid] > 0 then
				JY.Person[jqid]["中毒程度"] = JY.Person[jqid]["中毒程度"] + 1
				WAR.L_WNGZL[jqid] = WAR.L_WNGZL[jqid] -1;
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf(JY.Person[jqid]["中毒程度"]/5)	
				if WAR.L_WNGZL[jqid] <= 0 then
					WAR.L_WNGZL[jqid] = nil;
				end
			end

					--蓝烟清：欧阳锋化血蛇毒，按时序中毒，且流血
			if WAR.L_WNGZL2[jqid] ~= nil and WAR.L_WNGZL2[jqid] > 0 then
			    if WAR.LXZT[jqid]~=nil then
                AddPersonAttrib(jqid, "生命", - math.modf(WAR.LXZT[jqid]/5))
                end	
				AddPersonAttrib(jqid, "中毒程度", 1)
				 WAR.LXZT[jqid]=(WAR.LXZT[jqid] or 0) +math.random(1,5)
				if WAR.LXZT[jqid]>= 50 then----
				WAR.LXZT[jqid] = 50
				end
				WAR.L_WNGZL2[jqid] = WAR.L_WNGZL2[jqid] -1;	
				if WAR.L_WNGZL2[jqid] <= 0 then
					WAR.L_WNGZL2[jqid] = nil;
				end
			end	

			if WAR.L_WNGZL3[jqid] ~= nil and WAR.L_WNGZL3[jqid] > 0 then
			    if WAR.L_WNGZL2[jqid] ~= nil and WAR.L_WNGZL2[jqid] > 0  then
				   if math.random(100)<3 then	   
				    for j = 0, WAR.PersonNum-1 do 
			            local df = WAR.Person[j]["人物编号"] 
			            if WAR.Person[j]["我方"] == WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false and RealJL(j, i, 5) and j~=i then
			                AddPersonAttrib(df, "中毒程度", 2)
				            WAR.LXZT[df]=(WAR.LXZT[df] or 0) +math.random(1,5)
				            if WAR.LXZT[df]>= 50 then----
				               WAR.LXZT[df] = 50
				            end
			            end
                    end		
				   end
				end
				if WAR.L_WNGZL3[jqid] <= 0 then
					WAR.L_WNGZL3[jqid] = nil;
				end
			end	
			
		if WAR.POISON[jqid] ~= nil and WAR.POISON[jqid] > 0 then
           		if JY.Person[jqid]["受伤程度"] > 50 then
				AddPersonAttrib(jqid, "受伤程度", 2)
				else
				AddPersonAttrib(jqid, "受伤程度", 1)
				end		
			WAR.POISON[jqid] = WAR.POISON[jqid] - 1
			AddPersonAttrib(jqid, "生命", - math.modf(JY.Person[jqid]["受伤程度"]/10))
            if WAR.LXZT[jqid]~=nil then
            AddPersonAttrib(jqid, "生命", - math.modf(JY.Person[jqid]["受伤程度"]/10))
            end			
			if WAR.POISON[jqid] <= 0 then
				WAR.POISON[jqid] = nil
			end		
		end	
	
		if WAR.POISON2[jqid] ~= nil and WAR.POISON2[jqid] > 0 then
           		if JY.Person[jqid]["中毒程度"] > 50 then
					AddPersonAttrib(jqid, "中毒程度", 2)
				else
					AddPersonAttrib(jqid, "中毒程度", 1)
				end		
			WAR.POISON2[jqid] = WAR.POISON2[jqid] - 1
			AddPersonAttrib(jqid, "生命", - math.modf(JY.Person[jqid]["生命最大值"]/100))
			if WAR.POISON2[jqid] <= 0 then
				WAR.POISON2[jqid] = nil
			end		
		end	
	
		if WAR.ICE[jqid] ~= nil and WAR.ICE[jqid] > 0 then 
			WAR.ICE[jqid] = WAR.ICE[jqid] - 1
			if WAR.ICE[jqid] <= 0 then
				WAR.ICE[jqid] = nil
			end		
		end	

		if WAR.FMZZ[jqid] ~= nil and WAR.FMZZ[jqid] > 0 then 
			WAR.FMZZ[jqid] = WAR.FMZZ[jqid] - 1
			if WAR.FMZZ[jqid] <= 0 then
				WAR.FMZZ[jqid] = nil
			end		
		end	

		if WAR.PEACE[jqid] ~= nil and WAR.PEACE[jqid] > 0 then 
			WAR.PEACE[jqid] = WAR.PEACE[jqid] - 1
			if WAR.PEACE[jqid] <= 0 then
				WAR.PEACE[jqid] = nil
			end		
		end	
		
		if WAR.MZLL[jqid] ~= nil and WAR.MZLL[jqid] > 0 then 
			WAR.MZLL[jqid] = WAR.MZLL[jqid] - 1
			if WAR.MZLL[jqid] <= 0 then
				WAR.MZLL[jqid] = nil
			end		
		end	

		if WAR.MZLL2[jqid] ~= nil and WAR.MZLL2[jqid] > 0 then 
			WAR.MZLL2[jqid] = WAR.MZLL2[jqid] - 1
			if WAR.MZLL2[jqid] <= 0 then
				WAR.MZLL2[jqid] = nil
			end		
		end	

		if WAR.HJ[jqid] ~= nil and WAR.HJ[jqid] > 0 then 
			WAR.HJ[jqid] = WAR.HJ[jqid] - 1
			if WAR.HJ[jqid] <= 0 then
				WAR.HJ[jqid] = nil
			end		
		end			
		
		if WAR.YRKG[jqid] ~= nil then --以柔克刚重置
			WAR.YRKG[jqid] = WAR.YRKG[jqid] - 1
			if WAR.YRKG[jqid] <= 0 then
				WAR.YRKG[jqid] = nil
			end
		end
		
		if WAR.SJSD[jqid] ~= nil and WAR.SJSD[jqid] > 0 then 
			WAR.SJSD[jqid] = WAR.SJSD[jqid] - 1
			if WAR.SJSD[jqid] <= 0 then
				WAR.SJSD[jqid] = nil
			end		
		end	

		if WAR.JD_SJSD[jqid] ~= nil and WAR.JD_SJSD[jqid] > 0 then 
			WAR.JD_SJSD[jqid] = WAR.JD_SJSD[jqid] - 1
			if math.random(0,10)<6 then
			WAR.Person[i]["精神崩溃"] = WAR.Person[i]["精神崩溃"]+ 2
               if WAR.Person[i]["精神崩溃"]>= 50 then
               WAR.SJSD[jqid] =  1
               end				
			end
			if WAR.JD_SJSD[jqid] <= 0 then
				WAR.JD_SJSD[jqid] = nil
			end		
		end			

		if WAR.WGSD[jqid] ~= nil and WAR.WGSD[jqid] > 0 then 
			WAR.WGSD[jqid] = WAR.WGSD[jqid] - 1
			if WAR.WGSD[jqid] <= 0 then
				WAR.WGSD[jqid] = nil
			end		
		end	

		if WAR.TLXS[jqid] ~= nil and WAR.TLXS[jqid] > 0 then 
			WAR.TLXS[jqid] = WAR.TLXS[jqid] - 1
			if WAR.TLXS[jqid] <= 0 then
				WAR.TLXS[jqid] = nil
			end		
		end	

		if WAR.TLHQ[jqid] ~= nil and WAR.TLHQ[jqid][2] > 0 then 
			WAR.TLHQ[jqid][2] = WAR.TLHQ[jqid][2] - 1
			if WAR.TLHQ[jqid][2] <= 0 then
				WAR.TLHQ[jqid] = nil
			end		
		end	
		
		if WAR.HOT[jqid] ~= nil and WAR.HOT[jqid] > 0 then 
			WAR.HOT[jqid] = WAR.HOT[jqid] - 1
			if WAR.HOT[jqid] <= 0 then
				WAR.HOT[jqid] = nil
			end		
		end	

		if WAR.LXBZ[jqid] ~= nil and WAR.LXBZ[jqid] > 0 then 
			WAR.LXBZ[jqid] = WAR.LXBZ[jqid] - 1
			if WAR.LXBZ[jqid] <= 0 then
				WAR.LXBZ[jqid] = nil
			end		
		end	
		
		if WAR.BHJS[jqid] ~= nil and WAR.BHJS[jqid] > 0 then 
			WAR.BHJS[jqid] = WAR.BHJS[jqid] - 1
			if WAR.BHJS[jqid] <= 0 then
				WAR.BHJS[jqid] = nil
			end		
		end	

		if WAR.TJYM[jqid] ~= nil and WAR.TJYM[jqid] > 0 then 
			WAR.TJYM[jqid] = WAR.TJYM[jqid] - 1
			if WAR.TJYM[jqid] <= 0 then
				WAR.TJYM[jqid] = nil
			end		
		end	

		if WAR.PJFY[jqid] ~= nil and WAR.PJFY[jqid] > 0 then 
			WAR.PJFY[jqid] = WAR.PJFY[jqid] - 1
			if WAR.PJFY[jqid] <= 0 then
				WAR.PJFY[jqid] = nil
			end		
		end	

		if WAR.WFHT[jqid] ~= nil and WAR.WFHT[jqid] > 0 then 
			WAR.WFHT[jqid] = WAR.WFHT[jqid] - 1
			if WAR.WFHT[jqid] <= 0 then
				WAR.WFHT[jqid] = nil
			end		
		end	

		if WAR.PBFY[jqid] ~= nil and WAR.PBFY[jqid] > 0 then 
			WAR.PBFY[jqid] = WAR.PBFY[jqid] - 1
			if WAR.PBFY[jqid] <= 0 then
				WAR.PBFY[jqid] = nil
			end		
		end	

		if WAR.KBGJ3[jqid] ~= nil and WAR.KBGJ3[jqid] > 0 then 
			WAR.KBGJ3[jqid] = WAR.KBGJ3[jqid] - 1
			if WAR.KBGJ3[jqid] <= 0 then
				WAR.KBGJ3[jqid] = nil
			end		
		end	

		if WAR.MLZS[jqid] ~= nil and WAR.MLZS[jqid] > 0 then 
			WAR.MLZS[jqid] = WAR.MLZS[jqid] - 1
			if WAR.MLZS[jqid] <= 0 then
				WAR.MLZS[jqid] = nil
			end		
		end	
		
		if WAR.KBGJ[jqid] ~= nil and WAR.KBGJ[jqid] > 0 then 
			WAR.KBGJ[jqid] = WAR.KBGJ[jqid] - 1
			if WAR.KBGJ[jqid] <= 0 then
				WAR.KBGJ[jqid] = nil
			end		
		end	
		
		if WAR.KBGJ2[jqid] ~= nil and WAR.KBGJ2[jqid] > 0 then 
			WAR.KBGJ2[jqid] = WAR.KBGJ2[jqid] - 1
			if WAR.KBGJ2[jqid] <= 0 then
				WAR.KBGJ2[jqid] = nil
			end		
		end	
		
		if WAR.BHJS2[jqid] ~= nil and WAR.BHJS2[jqid] > 0 then 
			WAR.BHJS2[jqid] = WAR.BHJS2[jqid] - 1
			if WAR.BHJS2[jqid] <= 0 then
				WAR.BHJS2[jqid] = nil
			end		
		end			
		
		if wglw(jqid,18)>2 and WAR.TZNQ < 100 then
          WAR.TZNQ = WAR.TZNQ  + 1
          if WAR.TZNQ == 100 then
	          DrawStrBox(-1, -1, "弹指蓄势冷却完毕", C_GOLD, 30)
	          ShowScreen()
	          lib.Delay(100)
        	end
        end

		if match_ID_awakened(jqid,55,1)  then
		   if WAR.TZNQ2[jqid] == nil then
		   WAR.TZNQ2[jqid] = 0
		   else
		   WAR.TZNQ2[jqid] = (WAR.TZNQ2[jqid] or 0) + 1
		   end         
          if WAR.TZNQ2[jqid] == 100 then
	          DrawStrBox(-1, -1, "翔龙箭蓄势冷却完毕", C_GOLD, 30)
	          ShowScreen()
	          lib.Delay(100)
        	end
        end
		
		    --brolycjw：胡青牛指令，每个时序回复1%血
			if WAR.L_HQNZL[jqid] ~= nil and WAR.L_HQNZL[jqid] > 0 then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + math.modf(JY.Person[jqid]["生命最大值"]/100);
				if JY.Person[jqid]["受伤程度"] > 50 then
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 2;
				else
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1;
				end
		    	WAR.L_HQNZL[jqid] = WAR.L_HQNZL[jqid] -1;
		    	if WAR.L_HQNZL[jqid] <= 0 then
		    		WAR.L_HQNZL[jqid] = nil;
		    	end
		  	end

			if WAR.L_HQNZL2[jqid] ~= nil and WAR.L_HQNZL2[jqid] > 0 then
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + math.modf(JY.Person[jqid]["内力最大值"]/100);
				if JY.Person[jqid]["受伤程度"] > 50 then
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 2;
				else
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1;
				end
		    	WAR.L_HQNZL2[jqid] = WAR.L_HQNZL2[jqid] -1;
		    	if WAR.L_HQNZL2[jqid] <= 0 then
		    		WAR.L_HQNZL2[jqid] = nil;
		    	end
		  	end
	
			if WAR.BCB[jqid] ~= nil and WAR.BCB[jqid] > 0 and WAR.BCB1 == 1 then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + math.modf(JY.Person[jqid]["生命最大值"]/100);
				if JY.Person[jqid]["受伤程度"] > 50 then
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 2;
				else
					JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1;
				end
		    	WAR.BCB[jqid] = WAR.BCB[jqid] -1;
		    	if WAR.BCB[jqid] <= 0 then
                local s = WAR.CurID
				WAR.CurID = i				   
			    CurIDTXDH(WAR.CurID, 104, 1, "妖蝶变.破蛹化蝶", Violet)
				lib.Delay(100)
	            WAR.Person[i].Time = 1005
				WAR.CurID = s
		    		WAR.BCB[jqid] = nil;
					WAR.YDXT[jqid] = 1;
					WAR.BCB1 =2
		    	end
		  	end
	
		if wglw(jqid,47)>=1 and math.random(10)<1+wglw(jqid,47) then 
		    for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
			   if WAR.Person[j].Time >= 980 and WAR.ZYHB == 0 and WAR.Person[i].Time < WAR.Person[j].Time then 
			       WAR.Person[j].Time = 980
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end
                local s = WAR.CurID
				WAR.CurID = i				   
			    CurIDTXDH(WAR.CurID, 101, 1, "料敌先机.后发先至", Violet)
				lib.Delay(100)
	            WAR.Person[i].Time = 1005
				WAR.CurID = s
			   end
			end
            end			
		end--12.27改
		
		if nglw(jqid,102)>2 and JLSD(10,30,jqid) then 
		    for j = 0, WAR.PersonNum-1 do 
			local df = WAR.Person[j]["人物编号"] 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
			   if WAR.Person[j].Time >= 980 and WAR.ZYHB == 0 then 
			       WAR.Person[j].Time = 980
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
				local s = WAR.CurID
				WAR.CurID = i	
			    CurIDTXDH(WAR.CurID, 83, 1, "阴阳汇聚.刹那白首", Violet)
				lib.Delay(100)
	            WAR.Person[i].Time = 1005
				WAR.CurID = s
			   end
			end
            end			
		end--12.27改

		if nglw(jqid,106) >1 then --17-2-8-
		   if WAR.JYHT1 < 25 then 
		      WAR.JYHT1 = WAR.JYHT1 + 1
			  if WAR.JYHT[jqid]~=nil and WAR.JYHT[jqid]<0 then
                 WAR.JYHT[jqid] = 0
			  end
		   end
           if WAR.JYHT1 == 25 then 
		      if WAR.JYHT[jqid] == nil then 
			     WAR.JYHT[jqid] = 1 
              else			  
                 WAR.JYHT[jqid] = WAR.JYHT[jqid] + 1 
			  end
              if WAR.JYHT[jqid] >= 5*nglw(jqid,106) then 
                 WAR.JYHT[jqid] = 5*nglw(jqid,106)
			  end
              WAR.JYHT1 = 0
		   end  
		end
		
		if nglw(jqid,107)>1 then --17-2-8-
		   if WAR.JYHT2 < 25 then 
		      WAR.JYHT2 = WAR.JYHT2 + 1
			  if WAR.JYZQ[jqid]~=nil and WAR.JYZQ[jqid]<0 then
                 WAR.JYZQ[jqid] = 0
			  end
		   end
           if WAR.JYHT2 == 25 then 
		      if WAR.JYZQ[jqid] == nil then 
			     WAR.JYZQ[jqid] = 1 
			  else 	 
                 WAR.JYZQ[jqid] = WAR.JYZQ[jqid] + 1 
			  end
              if WAR.JYZQ[jqid] >= 5*nglw(jqid,107) then 
                 WAR.JYZQ[jqid] = 5*nglw(jqid,107)
			  end
              WAR.JYHT2 = 0
		   end  
		end		

		if wglw(jqid,49)>2 then --17-2-8-
		   if WAR.LM_JQZZ < 5*(1+(WAR.QXJQ[jqid] or 0)) then 
		      WAR.LM_JQZZ = WAR.LM_JQZZ + 1
			  if WAR.QXJQ[jqid]~=nil and WAR.QXJQ[jqid]<0 then
                 WAR.QXJQ[jqid] = 0
			  end
		   end
           if WAR.LM_JQZZ == 5*(1+(WAR.QXJQ[jqid] or 0)) then 
		      if WAR.QXJQ[jqid] == nil then 
			     WAR.QXJQ[jqid] = 1 
			  else 	 
                 WAR.QXJQ[jqid] = WAR.QXJQ[jqid] + 1 
			  end
              if WAR.QXJQ[jqid] >= 8 then 
                 WAR.QXJQ[jqid] = 8
			  end
              WAR.LM_JQZZ = 0
		   end  
		end

		if wglw(jqid,5)>1 then --17-2-8-
		   local a = 20 - (wglw(jqid,5)-2)*10
		   if WAR.BSCD < a then 
		      WAR.BSCD = WAR.BSCD + 1
			  if WAR.BSFW[jqid]~=nil and WAR.BSFW[jqid]<0 then
                 WAR.BSFW[jqid] = 0
			  end
		   end
           if WAR.BSCD == a then 
		      if WAR.BSFW[jqid] == nil then 
			     WAR.BSFW[jqid] = 1 
			  else 	 
                 WAR.BSFW[jqid] = WAR.BSFW[jqid] + 1 
			  end
              if WAR.BSFW[jqid] >= 5*wglw(jqid,5) then 
                 WAR.BSFW[jqid] = 5*wglw(jqid,5)
			  end
              WAR.BSCD = 0
		   end  
		end	

		if nglw(jqid,104)>1 then --17-2-8-
		   if WAR.NYHT < 25 then 
		      WAR.NYHT = WAR.NYHT + 1
			  if WAR.NYZQ[jqid]~=nil and WAR.NYZQ[jqid]<0 then
                 WAR.NYZQ[jqid] = 0
			  end
		   end
           if WAR.NYHT == 25 then 
		      if WAR.NYZQ[jqid] == nil then 
			     WAR.NYZQ[jqid] = 1 
			  else 	 
                 WAR.NYZQ[jqid] = WAR.NYZQ[jqid] + 1 
			  end
              if WAR.NYZQ[jqid] >= 5+nglw(jqid,104)*5 then 
                 WAR.NYZQ[jqid] = 5+nglw(jqid,104)*5
			  end
              WAR.NYHT = 0
		   end  
		end	

		if nglw(jqid,100)>1 then --17-2-8-
		   if WAR.XTHT < 25 then 
		      WAR.XTHT = WAR.XTHT + 1
			  if WAR.XTGQ[jqid]~=nil and WAR.XTGQ[jqid]<0 then
                 WAR.XTGQ[jqid] = 0
			  end
		   end
           if WAR.XTHT == 25 then 
		      if WAR.XTGQ[jqid] == nil then 
			     WAR.XTGQ[jqid] = 1 
			  else 	 
                 WAR.XTGQ[jqid] = WAR.XTGQ[jqid] + 1 
			  end
              if WAR.XTGQ[jqid] >= 5+nglw(jqid,100)*5 then 
                 WAR.XTGQ[jqid] = 5+nglw(jqid,100)*5
			  end
              WAR.XTHT = 0
		   end  
		end	
		
		if wglw(jqid,44)>2 and JLSD(10,15,jqid) then 
		    local tmppid=WAR.CurID
		    WAR.CurID=i
			WarDrawMap(0)
			CurIDTXDH(WAR.CurID, 101, 1, "苗剑奥义.凤凌长空", C_RED)
			   for i = 12, 24 do
					NewDrawString(-1, -1, "凤凌长空", C_RED, 25 + i)
					ShowScreen()
					if i == 24 then
						Cls()
						NewDrawString(-1, -1, "凤凌长空", C_RED, 25 + i)
						ShowScreen()
						lib.Delay(500)
					else
						lib.Delay(1)
					end
				end
	        for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end
            WAR.SQGJ=1
            War_Fight_Sub(i, 1, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标X"])
            WAR.SQGJ=0	
            WAR.WS = 1			
            WAR.CurID=tmppid
			
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
           xunhuan=false						
		end--12.27改
	
		if (nglw(jqid,95)>1 and PersonKF(jqid,95)) and WAR.Person[i]["死亡"] == false  then --蛤蟆九天17-2-23
		    WAR.HMJT[jqid] = (WAR.HMJT[jqid] or 0 ) + 1
			local str = nil
			local bb = 0
						   if (nglw(jqid,95)>2 and PersonKF(jqid,95)) then
						   local aa = math.random(1,3)
						   bb = aa
			                      if bb == 1 then 
			                      str = "毒蟾·蟾酥袭人"
			                      elseif bb == 2 then 	  
			                      str = "火蟾·烈气缠身"
			                      else
			                      str = "冰蟾·冰毒环绕"
			                     end
                           end	
			if WAR.Actup[jqid]~= nil then--
			WAR.HMJT[jqid] = (WAR.HMJT[jqid] or 0 ) + 10
			end
			if WAR.LQZ[jqid]~= nil and WAR.LQZ[jqid] >= 50 then--
			WAR.HMJT[jqid] = (WAR.HMJT[jqid] or 0 ) + 50
			end
			if math.random(100) <= math.min((1+math.modf(WAR.HMJT[jqid]/10)),4) and WAR.HMJT[jqid] ~= nil and WAR.HMJT[jqid] > 0 then 
				local s = WAR.CurID
				WAR.CurID = i	
				WarDrawMap(0)
			    CurIDTXDH(WAR.CurID, 83, 1, "气吞山河.震天", Violet)
				if str ~= nil then
				CurIDTXDH(WAR.CurID, 70-bb, 1, str, Violet)
				end
				lib.Delay(100)
			local x1 = WAR.Person[i]["坐标X"];
			local y1 = WAR.Person[i]["坐标Y"];	
			for ex = x1 - 8, x1 + 8 do
				for ey = y1 - 8, y1 + 8 do
					SetWarMap(ex, ey, 4, 1)
					if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
						local ep = GetWarMap(ex, ey, 2)
						local df = WAR.Person[ep]["人物编号"]
						if WAR.Person[i]["我方"] ~= WAR.Person[ep]["我方"] then
                           WAR.Person[ep].Time = WAR.Person[ep].Time - math.modf(WAR.HMJT[WAR.Person[i]["人物编号"]]/50)
						   if WAR.Person[ep].Time < -500 then 
						      WAR.Person[ep].Time = -500 
						   end
						   if bb>0 then
			                  if bb == 1 then 
                                  WAR.POISON[df] = (WAR.POISON[df]  or 0) + 10
								  if WAR.POISON[df] > 100 then 
			                         WAR.HOT[df] = 100 
				                     WAR.L_WNGZL[df] = 10	
			                      end
			                  elseif bb == 2 then 
			                      WAR.HOT[df] = (WAR.HOT[df] or 0) + 30
			                      if WAR.HOT[df] > 50 then 
			                         WAR.HOT[df] = 50 
				                     WAR.JHLY3[df] = 10	
			                      end	  
			                  else
			                      WAR.ICE[df] = (WAR.ICE[df] or 0) + 30
			                     if WAR.ICE[df] > 50 then 
			                        WAR.ICE[df] = 50
                                    WAR.HDQM[df] = 10				  
			                     end	
			                 end
                           end							 
						end
					end
				end
			end
			WAR.CurID = s
				DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
			end
			if WAR.HMJT[jqid] >= 5000  then
			local s = WAR.CurID
				WAR.CurID = i
                 WarDrawMap(0)				
			    CurIDTXDH(WAR.CurID, 67, 1, "气吞山河.化气长啸", Violet)
				lib.Delay(100)
			local x1 = WAR.Person[i]["坐标X"];
			local y1 = WAR.Person[i]["坐标Y"];	
			for ex = x1 - 8, x1 + 8 do
				for ey = y1 - 8, y1 + 8 do
					SetWarMap(ex, ey, 4, 1)
					if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
						local ep = GetWarMap(ex, ey, 2)
						if WAR.Person[i]["我方"] ~= WAR.Person[ep]["我方"] then
                           WAR.Person[ep].Time = -500
                           WAR.HMZT[WAR.Person[ep]["人物编号"]]	= 1					   
						end
					end
				end
			end
			WAR.CurID = s
				DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
			WAR.HMJT[jqid] = 1000
			end
		end

		if MPPB_BTNY(jqid) >= 1 and math.random(10)==8  then
			   local mpdj =MPDJ(jqid)
			   WAR.Person[i].Time = WAR.Person[i].Time +100*(mpdj-1)*MPPB_BTNY(jqid)
			   if MPPB_BTNY(jqid) >= 2 then
			   JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] +250*(mpdj-1)
			      if MPPB_BTNY(jqid) >= 3 then
			      JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] +50*(mpdj-1)
				  end
			   CurIDTXDH(WAR.CurID, 136, 1, "奇脉神功.聚灵", M_Silver)
			   end
			for j = 0, WAR.PersonNum-1 do 
			   if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end	
		  end

		if KUIHUA(jqid) == 2 and math.random(10)==8  then
			   local mpdj =nglw(jqid,105)
			   WAR.Person[i].Time = WAR.Person[i].Time +150*(mpdj-1)
		    for j = 0, WAR.PersonNum-1 do 
			    if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			    end
			end	
		 end
	
		if KUIHUA(jqid) == 0 and WAR.YIN[jqid]~=nil and WAR.YIN[jqid]  >= 10 then 

		        local tmppid=WAR.CurID
		              WAR.CurID = i
					  WarDrawMap(0)
		              CurIDTXDH(WAR.CurID, 136, 1, "阴葵汇聚.月牙天冲", M_Silver)
		    if WAR.Person[i].Time < 1005  then
			   WAR.Person[i].Time = 1005
			end 					  
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end
           WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)				
            WAR.YIN[jqid] = nil 
            WAR.KUIJUE[jqid] = 0			
		end--12.27改

		if KUIHUA(jqid) == 2 and WAR.XING[jqid]~=nil and WAR.XING[jqid]  >= 10 then 

		        local tmppid=WAR.CurID
				WarDrawMap(0)
		              WAR.CurID = i
		              CurIDTXDH(WAR.CurID, 112, 1, "星葵汇聚.北斗启明", M_Silver)
		    if WAR.Person[i].Time < 1005  then
			   WAR.Person[i].Time = 1005
			end 					  
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end
           WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)				
            WAR.XING[jqid] = nil 
            WAR.KUIJUE[jqid] = 2			
		end--12.27改

		if KUIHUA(jqid) == 1 and WAR.YANG[jqid]~=nil and WAR.YANG[jqid]>= 10 then 

		        local tmppid=WAR.CurID
		              WAR.CurID = i
					  WarDrawMap(0)
		              CurIDTXDH(WAR.CurID, 124, 1, "阳葵成型.日轮天照", M_Red)
		    if WAR.Person[i].Time < 1005  then
			   WAR.Person[i].Time = 1005
			end 					  
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end
           WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)				
            WAR.YANG[jqid] = nil 
            WAR.KUIJUE[jqid] = 1			
		end--12.27改

		if match_ID(jqid,114) and WAR.KONGQUE[jqid]~=nil and WAR.KONGQUE[jqid]>= 5 then 

		        local tmppid=WAR.CurID
		              WAR.CurID = i
					  WarDrawMap(0)
		              CurIDTXDH(WAR.CurID, 108, 1, "孔雀明王.五彩神光", M_Yellow)
		    if WAR.Person[i].Time < 1005  then
			   WAR.Person[i].Time = 1005
			end 					  
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 900
				   end 
			   end
			end
           WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)							
		end--12.27改		
		
--葵花三阶
	if Curr_NG(jqid, 105) and nglw(jqid,105)>2  and KUIHUA(jqid) == 2 then

        local aa=0
		local bb=0
		local cc=WAR.FXDS[jqid] or 0
		local dd=WAR.LXZT[jqid] or 0
        aa = (JY.Person[jqid]["受伤程度"]+JY.Person[jqid]["冰封程度"]+JY.Person[jqid]["灼烧程度"]+JY.Person[jqid]["中毒程度"])+cc+dd
		JY.Person[jqid]["受伤程度"] = 0
		JY.Person[jqid]["冰封程度"] = 0
		JY.Person[jqid]["灼烧程度"] = 0
		JY.Person[jqid]["中毒程度"] = 0
		WAR.FXDS[jqid] = nil
		WAR.LXZT[jqid] = nil 
        if  aa>= 100 then
		local tmppid=WAR.CurID
		    WAR.CurID=i
			local bb = math.random(80,120)
			WarDrawMap(0)
			CurIDTXDH(WAR.CurID, bb, 1, "吞天吐地.阴阳化解", M_DarkOrange)
			WAR.Person[i].Time = WAR.Person[i].Time +aa
            if WAR.Person[i].Time >= 1005  then
			   WAR.Person[i].Time = 1005
			end	 
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
				   WAR.Person[j].Time = WAR.Person[j].Time - bb
				   	if WAR.Person[j].Time <= -500 then
				      WAR.Person[j].Time = -500
				   end 
			   end
			end	
            WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)	
		end

	end	
	
	    if Curr_JL(jqid,4) and math.random(1000)<math.modf(JY.Person[jqid]["医疗能力"]/10) and JY.Person[jqid]["生命"]<JY.Person[jqid]["生命最大值"] then
				local s = WAR.CurID
				WAR.CurID = i	
				WarDrawMap(0)
			CurIDTXDH(WAR.CurID, 104, 1,"黄帝内经.秘术", PinkRed)	
			local bb=math.modf(JY.Person[jqid]["医疗能力"]/10)
			bb=5+bb
			local cc=math.random(bb)*10           
			if JY.Person[jqid]["生命"]+cc>=JY.Person[jqid]["生命最大值"] then
			cc=JY.Person[jqid]["生命最大值"] - JY.Person[jqid]["生命"]
			end
			JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + cc;
			CurIDTXDH(WAR.CurID, 125, 1, "生命奔流获得"..cc.."点生命", Violet)		
                        WAR.CurID=s
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)			
		end
		
		  if jqid == 0 and  JY.Base["标准"] >0 and JY.Base["天书数量"]>=2 and (math.random(1000)<JY.Base["天书数量"]+5+math.modf(JY.Person[0]["资质"]/20)) then 
		    local tmppid=WAR.CurID
		    WAR.CurID=i
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 104, 1, "临兵冲强行冲击集气", PinkRed)
			local bb=math.modf(JY.Person[jqid]["资质"]/20)
			bb=5+bb
		    local aa=math.random(bb)*50
			if JY.Base["标准"] == 8 and JY.Base["天书数量"]>=7 and (math.random(1000)<JY.Base["天书数量"]+5+math.modf(JY.Person[0]["资质"]/20)) then
			aa = 1005- WAR.Person[i].Time
			bb = aa + 100
			CurIDTXDH(WAR.CurID, 84, 1, "临兵冲奥义【八门聚万象】", M_Indigo)
			end
			WAR.Person[i].Time = WAR.Person[i].Time +aa
            if WAR.Person[i].Time >= 1005  then
			   WAR.Person[i].Time = 1005
			end
			if WAR.FXDS[jqid]~=nil then
			WAR.FXDS[jqid] = WAR.FXDS[jqid] - bb
			   if WAR.FXDS[jqid]<1 then
               WAR.FXDS[jqid] = nil			    
			   end
			end
			CurIDTXDH(WAR.CurID, 132, 1, "集气冲击完成", PinkRed)
			CurIDTXDH(WAR.CurID, 119, 1, "强行冲击"..aa.."点集气", C_GOLD)
            if JY.Base["标准"]==8 then
			local cc=math.random(bb)*15
            JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + cc;
			CurIDTXDH(WAR.CurID, 125, 1, "生命奔流获得"..cc.."点生命", Violet)
            end			 
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end	
            WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)			
		end--12.27改

       if nglw(jqid,96)>2 and JY.Person[jqid]["生命"]<= math.modf(JY.Person[jqid]["生命最大值"]*0.5) and math.random(1000)<2*math.modf((100-JY.Person[jqid]["资质"])/5) then
            local tmppid=WAR.CurID
		    WAR.CurID=i
			WarDrawMap(0); --不加这条则动画位置无法正常显示
            CurIDTXDH(WAR.CurID, 104, 1, "罗汉.福缘深厚", PinkRed)
			local cc =  math.modf(JY.Person[jqid]["生命最大值"]*0.1)
			if JY.Person[jqid]["资质"]<2 then
			cc =  math.modf(JY.Person[jqid]["生命最大值"]*0.3)
			end
			JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + cc
			CurIDTXDH(WAR.CurID, 125, 1, "回复"..cc.."点生命", Violet)

            WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)	
       end	   

        if WAR.JYHT_FK[jqid]~=nil then
		    local tmppid=WAR.CurID
		    WAR.CurID=i
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 61, 1, "九阳罡气.反馈自身", PinkRed)
			local aa = WAR.JYHT[jqid] or 0
			WAR.JYHT[jqid] = nil
            JY.Person[jqid]["内力"] = JY.Person[jqid]["内力"] + 100*aa
            if JY.Person[jqid]["内力"] >= JY.Person[jqid]["内力最大值"] then
            JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
            end			
            WAR.Person[i].Time = WAR.Person[i].Time + 110*aa
			if  WAR.Person[i].Time> 1005 then
			WAR.Person[i].Time = 1005
			end
			WAR.tmp[3000+jqid] = (WAR.tmp[3000+jqid] or 0) + 20 * aa
			if WAR.JYHT_JX[jqid]~=nil then
			WAR.tmp[3000+jqid] = (WAR.tmp[3000+jqid] or 0) + WAR.JYHT_JX[jqid]
			WAR.JYHT_JX[jqid] = nil
			end
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end	
			WAR.JYHT_FK[jqid] = nil
            WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)		
		
		end
		
		if jqid == 0 and WAR.RY[jqid]~=nil  then
		    local tmppid=WAR.CurID
		    WAR.CurID=i
			WarDrawMap(0); --不加这条则动画位置无法正常显示
			CurIDTXDH(WAR.CurID, 88, 1, "仁者无敌.如阴随性", PinkRed)		
            WAR.Person[i].Time = 1100
		    for j = 0, WAR.PersonNum-1 do 
			if WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[j]["死亡"] == false then
				   if WAR.Person[j].Time >= 1000 then
				      WAR.Person[j].Time = 980
				   end 
			   end
			end	
            WAR.CurID=tmppid
						DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
						DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
						DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
						lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
						lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
						lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)
						surid = lib.SaveSur( x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)	
		
		end
		
			
			--无酒不欢：集气读数获取位置
			WAR.JQSDXS[jqid] = jq

			if WAR.Person[i].Time >= 1000 and WAR.FXDS[jqid]~=nil  then
            WAR.Person[i].Time = 999
			end 

 
			if WAR.Person[i].Time >= 1000  then
				if WAR.ZYHB == 1 then
					if i ~= WAR.ZYHBP then
						WAR.Person[i].Time = 990
					else
						WAR.Person[i].Time = 1001
					end
				end
				xunhuan = false
			end
	    end
    end

		--local warStatus = War_isEnd2()   --战斗是否结束？   0继续，1赢，2输
		--if 0 < warStatus then
			--break;
		--end
	
		--local num = math.ceil(CC.BattleDelay/10)
		--xh = xh + 1
		--if xh == num then 
			--Rtime()
			--xh = 0
		--end
		--WarDrawMap(0) 
	
		--这三个是固定的，只需要加载一次就可以了
	DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
	DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
	DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
	lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
	lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)
  
	lib.SetClip(x1 - (x2-x1)/2-100, 0, CC.ScreenW, CC.ScreenH/4 + 50)

		DrawTimeBar_sub(x1, x2, nil, 0)
		ShowScreen(1)
		WAR.SXTJ = WAR.SXTJ + 1
		--无酒不欢：三时序，五时序，六时序，九时序的计数器
		WAR.SSX_Counter = WAR.SSX_Counter + 1
		if WAR.SSX_Counter == 4 then
			WAR.SSX_Counter = 1
		end
		WAR.WSX_Counter = WAR.WSX_Counter + 1
		if WAR.WSX_Counter == 6 then
			WAR.WSX_Counter = 1
		end
		WAR.LSX_Counter = WAR.LSX_Counter + 1
		if WAR.LSX_Counter == 7 then
			WAR.LSX_Counter = 1
		end
		WAR.JSX_Counter = WAR.JSX_Counter + 1
		if WAR.JSX_Counter == 10 then
			WAR.JSX_Counter = 1
		end
		WAR.YY_Counter = WAR.YY_Counter  + 1
		if WAR.YY_Counter == 11 then
			WAR.YY_Counter = 1
		end
		lib.Delay(10) -- 无酒不欢：减缓集气条速度
		
		
		--集气过程中按空格或回车停止自动
		local keypress = lib.GetKey()
		if (keypress == VK_SPACE or keypress == VK_RETURN) then
			if WAR.AutoFight == 1 then 
				WAR.AutoFight = 0
			end	
		end
	  
		lib.LoadSur(surid, x1 - ((x2 - x1) / 2)-100, 0)	--无酒不欢：修复杀到-500后集气条小头像刷新问题
	end
  
	--时序结束结算
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["死亡"] == false then
			WAR.Person[i].TimeAdd = 0
			local jqid=WAR.Person[i]["人物编号"]
			
			--判断是否在正常数据范围之内
			if JY.Person[jqid]["中毒程度"] < 0 then
				JY.Person[jqid]["中毒程度"] = 0;
			end
			if JY.Person[jqid]["受伤程度"] < 0 then
				JY.Person[jqid]["受伤程度"] = 0;
			end
			if JY.Person[jqid]["内力最大值"] < JY.Person[jqid]["内力"] then
				JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
			end
			if JY.Person[jqid]["生命最大值"] < JY.Person[jqid]["生命"] then
				JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
			end
			if JY.Person[jqid]["体力"] > 100 then
				JY.Person[jqid]["体力"] = 100
			end
		end
	end
  
	WAR.ZYHBP = -1
	lib.SetClip(0, 0, 0, 0)
	lib.FreeSur(surid)
end

--绘画整体集气条
function DrawTimeBar_sub(x1, x2, y, flag)

	--无酒不欢：绘画部分增加破绽区显示
	if not x2 then
		x2 = CC.ScreenW * 19 / 20 - 2
	end
	if not y then
		y = CC.ScreenH/10 + 29
	end
	if not x1 then
		x1 = CC.ScreenW * 1 / 2 - 34
		DrawBox_1(x1 - 3, y, x2 + 3, y + 3, C_ORANGE)
		DrawBox_1(x1 - (x2 - x1) / 2, y, x1 - 3, y + 3, C_RED)
		DrawString(x1 - (x2 - x1) / 2 - 20, y - 23, "连锁", C_WHITE, 15) --连锁显示
  if math.max(WAR.URCHAIN, WAR.MYCHAIN) < 2 then
	DrawString(x1 - (x2 - x1) / 2 - 20, y - 3, "0", C_GOLD, 20)  
  else
	DrawString(x1 - (x2 - x1) / 2 - 20, y - 3, math.max(WAR.URCHAIN, WAR.MYCHAIN), C_GOLD, 20)  
  end
		DrawString(x2 + 10, y - 20, "时序", C_WHITE, CC.FontSMALL)
		lib.FillColor(x1+1, y+1, x1+90, y+3,C_ORANGE)
		lib.FillColor(x1-94, y+1, x1-6, y+3,C_RED)	
	end
  
	for i = 0, WAR.PersonNum - 1 do
		if not WAR.Person[i]["死亡"] then
			--无酒不欢：修正集气条显示，不会飞过1000
			if WAR.Person[i].Time > 1001 then
				WAR.Person[i].Time = 1001
			end
			local id = WAR.Person[i]["人物编号"]
			local cx = x1 + math.modf(WAR.Person[i].Time*(x2 - x1)/1000)
			local headid = WAR.tmp[5000+i];
			if headid == nil then
				headid = JY.Person[id]["头像代号"]
			end
			if match_ID(id,646) then
			   headid = 584
			end
			local w, h = limitX(CC.ScreenW/25,12,35),limitX(CC.ScreenW/25,12,35)
			local jq_color = C_WHITE
			if JY.Person[id]["中毒程度"] == 100 then
				jq_color = RGB(56, 136, 36)
			elseif JY.Person[id]["中毒程度"] >= 50 then
				jq_color = RGB(120, 208, 88)
			end
			if WAR.LQZ[id] == 100 then
				jq_color = C_RED
			end
			if WAR.Person[i]["我方"] then
				drawname(cx, 1, id, CC.FontSmall)
				lib.LoadPNG(99, headid*2, cx - w / 2, y - h - 4, 1, 0)
				DrawString(cx-21, y-10-9, string.format("%3d",(WAR.JQSDXS[id] or 0)), jq_color, CC.FontSMALL)	--集气速度
				if JY.Person[id]["灼烧程度"] ~= 0 then
					DrawString(cx, y-10-33, string.format("%3d",JY.Person[id]["灼烧程度"]), C_ORANGE, CC.FontSMALL)	--灼烧数值
				end
				if WAR.FXDS[id] ~= nil and WAR.FXDS[id] ~= 0 then
					DrawString(cx-21, y-10-33, string.format("%3d",WAR.FXDS[id]), C_GOLD, CC.FontSMALL)	--封穴数值
				end
			else
				drawname(cx, y+h, id, CC.FontSmall)
				lib.LoadPNG(99, headid*2, cx - w / 2, y + 6, 1, 0)
				DrawString(cx-21, y+h-9, string.format("%3d",(WAR.JQSDXS[id] or 0)), jq_color, CC.FontSMALL)	--集气速度
				if JY.Person[id]["灼烧程度"] ~= 0 then
					DrawString(cx, y+h-33, string.format("%3d",JY.Person[id]["灼烧程度"]), C_ORANGE, CC.FontSMALL)	--灼烧数值
				end
				if WAR.FXDS[id] ~= nil and WAR.FXDS[id] ~= 0 then
					DrawString(cx-21, y+h-33, string.format("%3d",WAR.FXDS[id]), C_GOLD, CC.FontSMALL)	--封穴数值
				end
			end
		end
	end
	DrawString(x2 + 10, y , WAR.SXTJ, C_GOLD, CC.FontSMALL)
end

--绘画集气条上的名字
function drawname(x, y, id, size)
	local name = JY.Person[id]["姓名"]
	local color = C_WHITE
	--名字颜色随冰封和内伤变化
	if JY.Person[id]["受伤程度"] > JY.Person[id]["冰封程度"] then
		if JY.Person[id]["受伤程度"] > 99 then
			color = RGB(232, 32, 44)
		elseif JY.Person[id]["受伤程度"] > 66 then
			color = RGB(244, 128, 32)
		elseif JY.Person[id]["受伤程度"] > 33 then
			color = RGB(236, 200, 40)
		end
	else
		if JY.Person[id]["冰封程度"] >= 50 then
			color = M_RoyalBlue
		elseif JY.Person[id]["冰封程度"] > 0 then
			color = LightSkyBlue
		end
	end
	x = x - math.modf(size / 2)
	local namelen = string.len(name) / 2
	local zi = {}
	for i = 1, namelen do
		zi[i] = string.sub(name, i * 2 - 1, i * 2)
		DrawString(x, y, zi[i], color, size)
		y = y + size
	end
end

--判断两人之间的距离
function RealJL(id1, id2, len)
	if not len then
		len = 1
	end
	local x1, y1 = WAR.Person[id1]["坐标X"], WAR.Person[id1]["坐标Y"]
	local x2, y2 = WAR.Person[id2]["坐标X"], WAR.Person[id2]["坐标Y"]
	local s = math.abs(x1 - x2) + math.abs(y1 - y2)
	if len == nil then
		return s
	end
	if s <= len then
		return true
	else
		return false
	end
end

function RealJL2(x1,y1, id2, len)
	if not len then
		len = 1
	end
	local x2, y2 = WAR.Person[id2]["坐标X"], WAR.Person[id2]["坐标Y"]
	local s = math.abs(x1 - x2) + math.abs(y1 - y2)
	if len == nil then
		return s
	end
	if s <= len then
		return true
	else
		return false
	end
end

--计算武功范围
function refw(wugong, level,id)
  --无酒不欢：参数说明
  --m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：卍字，9：卐字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	local m1, m2, a1, a2, a3, a4, a5 = nil, nil, nil, nil, nil, nil, nil
	if JY.Wugong[wugong]["攻击范围"] == -1 then
		return JY.Wugong[wugong]["加内力1"], JY.Wugong[wugong]["加内力2"], JY.Wugong[wugong]["未知1"], JY.Wugong[wugong]["未知2"], JY.Wugong[wugong]["未知3"], JY.Wugong[wugong]["未知4"], JY.Wugong[wugong]["未知5"]
	end
	--0：点
	--1：线
	--2：十字
	--3：面
	local fightscope = JY.Wugong[wugong]["攻击范围"]
	local kfkind = JY.Wugong[wugong]["武功类型"]
	local pid 
	if id == nil then 
		 pid = WAR.Person[WAR.CurID]["人物编号"]
	  else 
		 pid = id
	  end
	if wglw(pid,77)>1 and wugong == 77 then----
       WAR.DJZS=math.random(1,2)
	   if WAR.ZYHB==2 then
	   WAR.DJZS=math.random(1,2)+2
	   end
	   if WAR.DJZS==1 then
	   kfkind = 4
	   fightscope = 2
	   elseif WAR.DJZS == 3 then
	   kfkind = 4
	   fightscope = 1
	   elseif WAR.DJZS == 2 then
	   kfkind = 3 
	   fightscope = 3
	   elseif WAR.DJZS == 4 then
	   kfkind = 3
	   fightscope = 1
	   end
	end
	
	
	
	--六脉神剑算剑法的范围
	if wugong == 49 then
		kfkind = 3
	end
	--玄女剑法算奇门的范围
	if wugong == 161 then
		kfkind = 5
	end

	--逍遥神剑算刀法的范围
	if wugong == 168 then
		kfkind = 4
	end
	--阴风刀算剑法的范围
	if wugong == 174 then
		kfkind = 3
	end
	--王语嫣妙法无形
	local MiaofaWX = 0
	

	if  JY.Status == GAME_WMAP then	
	   for i = 0, WAR.PersonNum - 1 do
		local id = WAR.Person[i]["人物编号"]
		if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] and match_ID(id, 76) and inteam(pid) then
			MiaofaWX = MiaofaWX + 1
			break
		end
	   end
	if wglw(pid,74) >= 1 then
	   if  WAR.SHJG[pid] ~=nil and WAR.SHJG[pid] == 2 and  WAR.DZXYLV[pid] ~= nil then
	      local aa = math.modf(WAR.DZXYLV[pid]/40)
		  MiaofaWX = MiaofaWX + aa
	   end
	end

	if wglw(pid,81) >= 1 and wugong ==81 then
	   if  WAR.SPXT[pid] ~=nil  then
	      local aa = math.modf(WAR.SPXT[pid]/3)
		  MiaofaWX = MiaofaWX + aa
	   end
	end

	if wglw(pid,9) >= 1 and wugong ==9 then
	   if  WAR.SPXT[pid] ~=nil  then
	      local aa = math.modf(WAR.SPXT[pid]/5)
		  MiaofaWX = MiaofaWX + aa
	   end
	end
	
	if wglw(pid,26) >= 1 and wugong ==26 then
	   if  WAR.LHXT[pid] ~=nil  then
	      local aa = math.modf(WAR.LHXT[pid]/2)
		  MiaofaWX = MiaofaWX + aa
	   end
	end	
	
	if WAR.YJQS[pid]~=nil and WAR.YJQS[pid] == 3 and wugong == 68 then
	local aa = math.modf(sixi(pid,5)/60)
	MiaofaWX = MiaofaWX + aa
	fightscope = 3	
	end

     if WAR.DGPZ1[pid] ~= nil and wugong == 47 then
	    if WAR.DGPZ1[pid] == 3 then
		MiaofaWX = MiaofaWX + 5	
		end
	 end
	 
if WAR.FZLY[pid]~= nil then
   MiaofaWX = MiaofaWX+3
end

if WAR.ZLLY[pid]~= nil then
   MiaofaWX = MiaofaWX -5
   if MiaofaWX <=-1 then
   MiaofaWX = -1
   end
end	 
	if WAR.DJZS>0 then
	MiaofaWX = MiaofaWX +5
	end
	end	
	
	if HunZi(pid) then
	    MiaofaWX = MiaofaWX + math.modf((JY.Person[pid]["内力"]/500)*sixi(pid,3)/160)
	end
	

	

	--天罗地网也增加攻击范围
	if Curr_QG(pid,148) then
		MiaofaWX = MiaofaWX + wglw(pid,77)+4
	end
	--阴阳倒乱刃的刀系数增加攻击范围
	if wglw(pid,77)>=1 and wugong == 77 then
		MiaofaWX = MiaofaWX + math.modf(sixi(pid,4)/30)
	end	
	
	--闪电貂和妙手空空范围不增加
	if wugong == 113 or wugong == 116 then
		MiaofaWX = 0
	end



	--点
	if fightscope == 0 then
		if level > 10 then
			m1 = 1
			m2 = JY.Wugong[wugong]["移动范围" .. 10]
			a1 = 1
			a2 = 3 + MiaofaWX
			a3 = 3 + MiaofaWX
		else
			m1 = 0
			m2 = JY.Wugong[wugong]["移动范围" .. level]
			a1 = 1
			a2 = math.modf(level / 5) + MiaofaWX
			a3 = math.modf(level / 8) + MiaofaWX
		end
	--线
	elseif fightscope == 1 then
		--拳指
		if kfkind == 1 or kfkind == 2 then
			a1 = 12
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
			end
		--剑
		elseif kfkind == 3 then
			a1 = 10
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] + MiaofaWX
				a3 = a2 - 1
				a4 = a3 - 1
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
			end
			if level > 7 then
				a3 = a2 - 1
			end
		--刀
		elseif kfkind == 4 then
			a1 = 11
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
			end
		--奇
		elseif kfkind == 5 then
			m1 = 2
			if level > 10 then
				m2 = JY.Wugong[wugong]["移动范围" .. 10] - 1
				a1 = 7
				a2 = 1 + math.modf(level / 3) + MiaofaWX
				a3 = a2
			else
				m2 = JY.Wugong[wugong]["移动范围" .. level] - 1
				a1 = 1
				a2 = 1 + math.modf(level / 3) + MiaofaWX
			end
		else
			a1 = 11
			if level > 10 then
				m1 = 3
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
			else
				m1 = 2
				m2 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
			end
		end
	--十字
	elseif fightscope == 2 then
		m1 = 0
		m2 = 0
		--刀
		if kfkind == 4 then
			if level > 10 then
				a1 = 6
				a2 = JY.Wugong[wugong]["移动范围" .. 10] + MiaofaWX
			else
				a1 = 8
				a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
			end
		elseif level > 10 then
			--拳指
			if kfkind == 1 or kfkind == 2 then
				a1 = 5
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
				a3 = a2 - 3
			--剑
			elseif kfkind == 3 then
				a1 = 1
				a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
				a3 = a2
			else
				a1 = 2
				a2 = 1 + math.modf(JY.Wugong[wugong]["移动范围" .. 10] / 2) + MiaofaWX
			end
		else
			  a1 = 1
			  a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
			  a3 = 0
		end
	--面
	elseif fightscope == 3 then
		m1 = 0
		a1 = 3
		if level > 10 then
			m2 = JY.Wugong[wugong]["移动范围" .. 10] + 1
			a2 = JY.Wugong[wugong]["杀伤范围" .. 10] + MiaofaWX
			a3 = a2
		else
			m2 = JY.Wugong[wugong]["移动范围" .. level]
			a2 = JY.Wugong[wugong]["杀伤范围" .. level] + MiaofaWX
		end
  
	end
	
	--张三丰，太极拳范围随着蓄力变化
	--斗转时范围不变化
	--七夕张无忌也变化
	if wugong == 16 and level == 11 and WAR.tmp[3000 + pid] ~= nil and WAR.tmp[3000 + pid] > 0 and (match_ID(pid, 5) or match_ID(pid, 608))and WAR.DZXY == 0 then
		if WAR.tmp[3000 + pid] > 600 then
			m1 = 0
			m2 = 4
			a1 = 3
			a2 = 3 + MiaofaWX
			a3 = a2
		elseif WAR.tmp[3000 + pid] > 300 then
			a2 = a2 + 2
			a3 = a3 + 2
		else
			a2 = a2 + 1
			a3 = a3 + 1
		end
	end
	
	--玉箫剑法，配合桃花绝技范围增加
	if wugong == 38 and level == 11 and TaohuaJJ(pid) then
		a2 = 8 + MiaofaWX
		a3 = a2 - 1
		a4 = a3 - 1
	end
	
	--落英神剑掌，配合桃花绝技可移动
	if wugong == 12 and level == 11 and TaohuaJJ(pid) then
		m1 = 0
		m2 = 6
	end
	
	--神雕的玄铁可移动
	if wugong == 45 and match_ID(pid, 628) then
		m1 = 0
		m2 = 4
	end

    if match_ID_awakened(pid, 35, 1) and wugong == 47  then
		m1 = 0
		m2 = 4	
	end

	
	if wugong == 58 and match_ID(pid, 448) then
		a2 = 8 + MiaofaWX
		a3 = a2 - 1
		a4 = a3 - 1
		m1 = 0
		m2 = 6
	end

	
	if wugong == 52 and wglw(pid,52)>=1 then
	    local cc = math.modf(JY.Person[pid]["实战"]/10)
	    MiaofaWX = MiaofaWX + cc*wglw(pid,52)
		a2 = 8 + MiaofaWX
		a3 = a2 - 1
		a4 = a3 - 1
		m1 = 0
		m2 = 6+MiaofaWX
	end
	
	--进阶万花，范围+1
	if wugong == 30 and nglw(pid, 89)>=1 then
		a2 = a2 + 1
	end
	


	if  JY.Status == GAME_WMAP then
	    if WAR.GSSL[pid]~=nil and WAR.GSSL[pid]== 3  and yongdao(wugong) then
	       local aa = math.modf(sixi(pid,4)/30)
	       a2 = a2 + aa
	       m2 = m2 + aa
	   end
        if wglw(pid,74)>2 and WAR.SHJG[pid]~=nil and WAR.SHJG[pid] == 4 and wugong == 74 and (WAR.LQZ[pid] or 0) == 100 then
		
		local cc = math.modf(JY.Person[pid]["实战"]/10)
		MiaofaWX = MiaofaWX + cc
		a2 = 8 + MiaofaWX
		a3 = a2 - 1
		a4 = a3 - 1
		m1 = 0
		m2 = 6
	    end

	   if WAR.SHAH[pid]~=nil and wglw(pid,78)>=1 and yongte(wugong) then
       local  cc = math.modf(WAR.SHAH[pid]/250)
	   MiaofaWX = MiaofaWX + cc
	   a2 = 8 + MiaofaWX
	   m2 = 6+ MiaofaWX
	   end		
		
	end	
	



	
	--辟邪剑法手动选择范围
	if wugong == 48 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 then
		m1, m2, a1, a2, a3, a4 = BiXieZhaoShi(pid,MiaofaWX)
	end
	--太玄神功手动选择系数
	if wugong == 102  and match_ID_awakened(pid, 38, 1) and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 then
		TaiXuanZhaoShi()
	end	
	
	if wugong == 25 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and wglw(pid,25)>1 then
	    MiaofaWX=MiaofaWX+wglw(pid,25)
		if WAR.LQZ[pid]~=nil and WAR.LQZ[pid] == 100 and wglw(pid,25)>2  then
		MiaofaWX=MiaofaWX+math.modf(JY.Person[pid]["实战"]/100)
		end
        m1, m2, a1, a2, a3, a4, a5 = AnRanZhaoShi(pid,MiaofaWX)
	end 

	if wugong == 4 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and wglw(pid,4)>1 then
	    MiaofaWX=MiaofaWX+wglw(pid,4)
        m1, m2, a1, a2, a3, a4, a5 = LQZhaoShi(pid,MiaofaWX)
	end 	

	if wugong == 49 and level == 11 and inteam(pid) and WAR.AutoFight == 0 and WAR.DZXY == 0 and wglw(pid,49)>1 and  WAR.LM_JQ == 0 then
	    MiaofaWX=MiaofaWX+wglw(pid,49)
        m1, m2, a1, a2, a3, a4, a5 = LiuMai(pid,MiaofaWX)
	end 
	
	return m1, m2, a1, a2, a3, a4, a5
end

--用CC表判断人物是否为队友，不管在不在队
function isteam(p)
	local r = false
	for i,v in pairs(CC.PersonExit) do
		if v[1] == p then
			r = true
			break;
		end
	end
	if p == 0 then
		r = true
	end
  
	return r;
end

function MP_ZY(pid)
local MPZY={ {99,2},
{171,2},
{96,3},
{108,3},
{144,3},
{103,4},
{169,4},
{163,4},
{106,5},
{90,6},
{89,6},
{179,6},
{95,7},
{104,7},
{180,7},
}
	local r = false
	local mp = MPPD(pid)
	for i,v in ipairs(MPZY) do
		if Curr_NG(pid,v[1]) and v[2] == mp then
			r = true
			break;
		end
	end

	return r;
end

--判断人物是否有某种武功
function PersonKF(p, kf)
	if  JY.Status == GAME_WMAP then
	    if  WAR.WGSD[p]~= nil then
	    return false;
	    end
	end
	for i = 1, CC.Kungfunum do
		if JY.Person[p]["武功" .. i] <= 0 then
			return false;
		elseif JY.Person[p]["武功" .. i] == kf then
			return true

		end
	end
	return false
end

--判断人物是否有某种技能
function PersonJL(p, kf)
	for i = 1, CC.Skillnum do
		if JY.Person[p]["技能" .. i] <= 0 then
			return false;
		elseif JY.Person[p]["技能" .. i] == kf then
			return true

		end
	end
	return false
end

--判断人物是否有某种武功，并且等级为极
function PersonKFJ(p, kf)
	if  JY.Status == GAME_WMAP then
	    if  WAR.WGSD[p]~= nil then
	    return false;
	    end
	end
	for i = 1, CC.Kungfunum do
		if JY.Person[p]["武功" .. i] == -1 then
			return false;
		elseif JY.Person[p]["武功" .. i] == kf and JY.Person[p]["武功等级" .. i] == 999 then
			return true
		end
	end
	return false
end

function PersonNWQS(p, kf)
	if  JY.Status == GAME_WMAP then
	    if  WAR.NWSS[p]~= nil and JY.Person[p]["天赋内功"] == kf then
	    return true;
	    end
	end
	return false
end

function PersonNWHD(p, kf)
	if  JY.Status == GAME_WMAP then
	    if  (WAR.NWHD[p] or 0) == kf and WAR.NWCX[p]~= nil then
	    return true;
	    end
	end
	return false
end

--判断触发机率
function myrandom(p, id)
	--太玄神功+30
	if PersonKF(id, 102) then
		p = p + 30
	end
	--生命越低，几率越高，最多10
	p = p + math.modf((JY.Person[id]["生命最大值"]/JY.Person[id]["血量翻倍"] - JY.Person[id]["生命"]/JY.Person[id]["血量翻倍"])/100 + 1);	
	
	--体力越高，几率越高，最多10
	p = p + math.modf(JY.Person[id]["体力"] / 10)
	
	--林朝英+10
	if match_ID(id, 605) then
		p = p + 10
	end

		if WAR.SPIRIT[id] >= 100 then --战意的几率加成
			p = p + limitX(math.modf((WAR.SPIRIT[id] - 100) * 0.5), 0, 20)
		end

	--旧版逆运走火+30
	if WAR.tmp[1000 + id] == 1 then
		p = p + 30
	end

	--每25点实战+1，上限20
	local jp = math.modf(JY.Person[id]["实战"] / 25 + 1)
	if jp > 20 then
		jp = 20
	end
	p = p + jp

	--每500内力+1，最多20
	p = p + limitX(math.modf(JY.Person[id]["内力"] / 500), 0, 20)
	
	--每50点攻击力+1，最多10
	p = p + limitX(math.modf(JY.Person[id]["攻击力"] / 50), 0, 10)
	
	--每50点防御力+1，最多10
	p = p + limitX(math.modf(JY.Person[id]["防御力"] / 50), 0, 10)
	
	--每50点轻功+1，最多10
	p = p + limitX(math.modf(JY.Person[id]["轻功"] / 50), 0, 10)
	
	--基础判定次数为一次
	local times = 1
	--如果是我方
	if inteam(id) then
		--我方天书增加几率
		p = p + JY.Base["天书数量"]
		--50%几率二次判定
		if math.random(2) == 2 then
			times = 2
		end
		--石破天必定二次判定
		if match_ID(id, 38) and times == 1 then
			times = 2
		end
	--NPC默认为三次判定且几率+60
	else
		times = 3
		p = p + 60
	end
	
	if nglw(id,102)>=1 then
	   times = times+2
	end
	
	if wglw(id,68) >=1 then
	   p = p + 15*wglw(id,68)
	end
	
	if WAR.SJSD[id] ~= nil then----
	   p=0
	end
	
	for i = 1, times do
		local bd = math.random(120)
		if bd <= p then
			return true
		end
	end
	return false
end


--自动选择敌人
function War_AutoSelectEnemy()
	local enemyid = War_AutoSelectEnemy_near()
	WAR.Person[WAR.CurID]["自动选择对手"] = enemyid
	return enemyid
end

--选择最近敌人
function War_AutoSelectEnemy_near()
	War_CalMoveStep(WAR.CurID, 100, 1)			--标记每个位置的步数
	local maxDest = math.huge
	local nearid = -1
	for i = 0, WAR.PersonNum - 1 do		--查找最近步数的敌人
		if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
			local step = GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 3)
			if step < maxDest then
				nearid = i
				maxDest = step
			end
		end
	end
	return nearid
end

--战斗中加入新人物
function NewWARPersonZJ(id, dw, x, y, life, fx)
	WAR.Person[WAR.PersonNum]["人物编号"] = id
	WAR.Person[WAR.PersonNum]["我方"] = dw
	WAR.Person[WAR.PersonNum]["坐标X"] = x
	WAR.Person[WAR.PersonNum]["坐标Y"] = y
	WAR.Person[WAR.PersonNum]["死亡"] = life
	WAR.Person[WAR.PersonNum]["人方向"] = fx
	WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)
	lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[id]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[id]["头像代号"]), 4 + WAR.PersonNum)
	SetWarMap(x, y, 2, WAR.PersonNum)
	SetWarMap(x, y, 5, WAR.Person[WAR.PersonNum]["贴图"])
	if WAR.SPIRIT[id] == nil then
	WAR.SPIRIT[id] = 100
    end
	WAR.PersonNum = WAR.PersonNum + 1
end

--无酒不欢：判定合击用的函数
function between(num_1, num_2, num_3, flag)
    if not flag then
		flag = 0
    end
    if num_3 < num_2 then
		num_2, num_3 = num_3, num_2
    end
    if flag == 0 and num_2 < num_1 and num_1 < num_3 then
		return true
    elseif flag == 1 and num_2 <= num_1 and num_1 <= num_3 then
		return true
    else
		return false
    end
end

--无酒不欢：独孤求败反击的伤害判定
function First_strike_dam_DG(pid, eid)
	--根据双方御剑系数和内力差计算伤害
	local dam;
	local NL_factor;
	dam = (TrueYJ(pid)*2 - TrueYJ(eid))*3
	NL_factor = (getnl(pid) - getnl(eid))/10000
	dam = math.modf(dam * (1+NL_factor))
	if dam > 1999 then
		dam = 1999
	end
	return dam
end

--伤害公式中的内力，当前内力和最大内力都参与计算
function getnl(id)
	return (JY.Person[id]["内力"] * 2 + JY.Person[id]["内力最大值"]) / 3
end

--无酒不欢：血量翻倍函数
function Health_in_Battle()
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		--加一个变量避免重复翻倍
		if JY.Person[pid]["血量翻倍"] > 1 and WAR.HP_Bonus_Count[pid] == nil then
			JY.Person[pid]["生命最大值"] = JY.Person[pid]["生命最大值"] * JY.Person[pid]["血量翻倍"]
			JY.Person[pid]["生命"] = JY.Person[pid]["生命"] * JY.Person[pid]["血量翻倍"]
			WAR.HP_Bonus_Count[pid] = 1
		end
		--无酒不欢：非我方自动运功
		if not inteam(pid) then
			if JY.Person[pid]["天赋内功"] > 0 then
				JY.Person[pid]["主运内功"] = JY.Person[pid]["天赋内功"]
			end
			if JY.Person[pid]["天赋轻功"] > 0 then
				JY.Person[pid]["主运轻功"] = JY.Person[pid]["天赋轻功"]
			end
		end
	end
end

--无酒不欢：血量还原函数
function Health_in_Battle_Reset()
	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		if JY.Person[pid]["血量翻倍"] > 1 and WAR.HP_Bonus_Count[pid] ~= nil then
			JY.Person[pid]["生命最大值"] = JY.Person[pid]["生命最大值"] / JY.Person[pid]["血量翻倍"]
			WAR.HP_Bonus_Count[pid] = nil
		end
	end
end

--战斗中查看敌方简易信息
function MapWatch()
	local x = WAR.Person[WAR.CurID]["坐标X"];
	local y = WAR.Person[WAR.CurID]["坐标Y"];
	WAR.ShowHead = 0
	War_CalMoveStep(WAR.CurID,128,1);
	WarDrawMap(1,x,y);
	ShowScreen();
	x,y=War_SelectMove()
	if x == nil then
		return
	end
	WAR.ShowHead = 1
end

--无酒不欢：等待指令
function War_Wait()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	WAR.Wait[id] = 1
	Cls()
  	CurIDTXDH(WAR.CurID, 72, 1, "伺机待发", LightGreen, 15);
	 if wglw(id,74)>2 then
		 local aa =  WAR.SHJG[id] or 0
		 WAR.SHJG[id] = aa +1
		 if WAR.SHJG[id] == 5 then
		 WAR.SHJG[id] = 1
		 end
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 37+aa, 1, "咏春演化.蛇鹤四形", M_Blue);
		return 20
	end
	 if wglw(id,51)>=1 then
	 local  k = 0
        if WAR.LSDZ[id] == nil then
		WAR.LSDZ[id] = 3
		k = 1
		elseif wglw(id,51)>1  then 
		WAR.LSDZ[id] = WAR.LSDZ[id] + 3
		  if WAR.LSDZ[id] >6 then
		  WAR.LSDZ[id] = 3
		  end
		k=1
		else
		
		end
		if k == 1  then
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 28, 1, "罗刹阵图.魔煞轮回", M_Blue);
		  if wglw(id,51)>=2 then
		  WAR.GSSL[id] = WAR.LSDZ[id]
		  DrawStrBox(-1, -1, "鬼神敕令.圣魔凭依", C_GOLD, CC.DefaultFont)
		  end
		return 20
		end
	end
	if wglw(id,68)>=1 and WAR.YJQS[id]~=nil then
		local aa =  WAR.YJQS[id] or 0
		 WAR.YJQS[id] = aa +1
		 if WAR.YJQS[id] == 5 then
		 WAR.YJQS[id] = 1
		 end
		 WarDrawMap(0); --不加这条则动画位置无法正常显示
		CurIDTXDH(WAR.CurID, 64+aa, 1, "杨家枪势.转", M_Blue);
		return 20
	 end
  	return 1;
end

--无酒不欢：撤退
function War_Retreat()
	local id = WAR.Person[WAR.CurID]["人物编号"]
	local r = JYMsgBox(JY.Person[id]["姓名"], "确定要我撤退吗？", {"否","是"}, 2, WAR.tmp[5000+WAR.CurID])
	if r == 2 then
		WAR.Person[WAR.CurID]["死亡"] = true
		return 1;
	end
end

--无酒不欢：常态血条显示
function HP_Display_When_Idle()
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
	for k = 0, WAR.PersonNum - 1 do
		local tmppid = WAR.Person[k]["人物编号"]
		if WAR.Person[k]["死亡"] == false then
			local dx = WAR.Person[k]["坐标X"] - x0
			local dy = WAR.Person[k]["坐标Y"] - y0

			local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
	 
			local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
					ry = ry - hb - CC.YScale*7
					
			local pid = WAR.Person[k]["人物编号"]

			local Color = RGB(238,44, 44)
			--local Color1 = RGB(30, 144, 255)
			
			local HP_MAX = JY.Person[pid]["生命最大值"]
			
			local Current_HP = JY.Person[pid]["生命"]
			
			if Current_HP < 0 then
				Current_HP = 0
			end

			--友军NPC显示为绿色血条
			if WAR.Person[k]["我方"] == true then
				Color = RGB(0, 238, 0)
			end
			
			--刺目显示
			if WAR.KHCM[pid] == 2 then
				lib.PicLoadCache(0, 3812 * 2, rx, ry-10, 2, 192)
			end
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9,grey21)	--背景
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx-CC.XScale*1.4+(Current_HP/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color)  --生命
		
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9, C_BLACK)
		end
	end
end

--无酒不欢：挨打掉血显示
function HP_Display_When_Hit(ssxx)
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
	--掉血渐变显示			
	ssxx = ssxx - 4
	for k = 0, WAR.PersonNum - 1 do
		local tmppid = WAR.Person[k]["人物编号"]
		--血量有变化才显示
		if WAR.Person[k]["死亡"] == false and WAR.Person[k]["生命点数"] ~= nil then
			local dx = WAR.Person[k]["坐标X"] - x0
			local dy = WAR.Person[k]["坐标Y"] - y0

			local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
			local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
	 
			local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
					ry = ry - hb - CC.YScale*7
					
			local pid = WAR.Person[k]["人物编号"]

			local Color = RGB(238,44, 44)
			--local Color1 = RGB(30, 144, 255)
			
			--计算掉血
			local HP_MAX = JY.Person[pid]["生命最大值"]
			
			local HP_AfterHit = JY.Person[pid]["生命"]
			if HP_AfterHit > HP_MAX then
				HP_AfterHit = HP_MAX
			end
			if HP_AfterHit < 0 then
				HP_AfterHit = 0
			end
			
			local HP_Loss = -WAR.Person[k]["生命点数"]
			
			--天山童姥的特别判定
			if match_ID(pid, 117) then
				HP_Loss = HP_Loss - 80
			end
				
			local HP_BeforeHit;
			local Gradual_HP_Loss;
			local Gradual_HP_Display;
			
			if HP_Loss > 0 then
				if HP_Loss > HP_MAX then
					HP_Loss = HP_MAX
				end
				HP_BeforeHit = JY.Person[pid]["生命"]+ HP_Loss
				if HP_BeforeHit > HP_MAX then
					HP_BeforeHit = HP_MAX
				end
				Gradual_HP_Loss = HP_Loss*(ssxx/11)
				Gradual_HP_Display = HP_BeforeHit - Gradual_HP_Loss
				--防止血条显示异常
				if Gradual_HP_Display < HP_AfterHit then
					Gradual_HP_Display = HP_AfterHit
				end
			end
			
			--友军NPC显示为绿色血条
			if WAR.Person[k]["我方"] == true then
				Color = RGB(0, 238, 0)
			end
			
			--刺目显示
			if WAR.KHCM[pid] == 2 then
				lib.PicLoadCache(0, 3812 * 2, rx, ry-10, 2, 192)
			end
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9,grey21)	--背景
			
			lib.FillColor(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx-CC.XScale*1.4+(HP_AfterHit/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color)  --生命
			
			--掉血显示
			if HP_Loss > 0 then
				lib.FillColor(rx-CC.XScale*1.4+(HP_AfterHit/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*20/9, rx-CC.XScale*1.4+(Gradual_HP_Display/HP_MAX)*(2.8*CC.XScale), ry-CC.YScale*15/9, Color)  --失去生命
			end
		
			DrawBox3(rx-CC.XScale*1.4, ry-CC.YScale*20/9, rx+CC.XScale*1.4, ry-CC.YScale*15/9, C_BLACK)
		end
	end
end

--苍天泰坦：被战场显血函数调用
function DrawBox3(x1, y1, x2, y2, color)
	lib.DrawRect(x1, y1, x2, y1, color)
	lib.DrawRect(x1, y2, x2, y2, color)
	lib.DrawRect(x1, y1, x1, y2, color)
	lib.DrawRect(x2, y1, x2, y2, color)
	--无酒不欢：生命和内力的分隔线
	--lib.DrawRect(x1, y1+(y2-y1)/2+1, x2, y1+(y2-y1)/2+1, color)
end

--显示出招动画的选择出战人物界面
function WarSelectTeam_Enhance()
	if JY.Restart == 1 then
		do return end
	end
	local T_Num=GetTeamNum();
	--无酒不欢：高度以3为单位增加
	local h_factor = 3
	if T_Num > 12 then
		h_factor = 15
	elseif T_Num > 9 then
		h_factor = 12
	elseif T_Num > 6 then
		h_factor = 9
	elseif T_Num > 3 then
		h_factor = 6
	end
	local p={};
	local pic_w=CC.ScreenW/6--160;
	local pic_h=CC.ScreenW/6*3/4--128;
	local width=pic_w*3+CC.DefaultFont*5+4*8;
	local height=math.max((h_factor+2)*(CC.DefaultFont+4)+4*3,pic_h*math.modf((h_factor+1)/4))+CC.FontBig;
	local x=(CC.ScreenW-width)/2;
	local y=(CC.ScreenH-height-4*2)/2+CC.FontBig/2+8;
	local x0=x+4*4;
	local x1=x0+4;
	local y1=(CC.ScreenH-((T_Num+2)*(CC.DefaultFont+4)+4*3))/2;
	local x2=x0+4*3+CC.DefaultFont*5+pic_w/2
	local y2=y;
	local ts=(width-(CC.FontBig*4+16)*2)/3;
	local tx1=x+ts+4;
	local tx2=tx1+(CC.FontBig*4+16)+ts;
	local ty=y+pic_h+30+CC.DefaultFont;
	
	--剪裁的背景图
	--没有自动选择出战人时才显示
	--单挑陈达海战特殊判定
	if WAR.Data["自动选择参战人1"] == -1 and not (WAR.ZDDH == 92 and GetS(87,31,33,5) == 1) then
		Clipped_BgImg((CC.ScreenW - width) / 2,(CC.ScreenH - height) / 2,(CC.ScreenW + width) / 2,(CC.ScreenH + height) / 2,1000)
		Clipped_BgImg((CC.ScreenW - (CC.DefaultFont+4)*4) / 2,(CC.ScreenH - height) / 2-(CC.DefaultFont+4)/2,(CC.ScreenW + (CC.DefaultFont+4)*4) / 2,(CC.ScreenH - height) / 2+(CC.DefaultFont+4)/2,1000)
	end
	for i=1,T_Num do
		local pid=JY.Base["队伍"..i];
		if pid <0 then
			break;
		end
	  
	  --冰糖恋：单挑陈达海
		if WAR.ZDDH == 92 and GetS(87,31,33,5) == 1 then
			WAR.Data["自动选择参战人1"] = 0;
			WAR.Data["我方X1"] = 33
			WAR.Data["我方Y1"] = 24
		end

		if WAR.ZDDH > 0 and GetS(87,31,33,5) == 1 then
			WAR.Data["自动选择参战人1"] = 0;
			WAR.Data["我方X1"] = 33
			WAR.Data["我方Y1"] = 24
		end
		
		--战三渡，如果周芷若在队则周芷若必出战
		if WAR.ZDDH == 253 and inteam(631) then
			WAR.Data["手动选择参战人2"] = 631
		end
		
		--畅想杨过绝情谷两战
		if (WAR.ZDDH == 272 or WAR.ZDDH == 273) and JY.Base["畅想"] == 58 then
			WAR.Data["自动选择参战人2"] = 59
		end
		
		if WAR.ZDDH == 292 then --大地图挑战
		WAR.Data["自动选择参战人1"] = GetS(106, 63, 1, 0)
	    end		
		
		if WAR.Data["自动选择参战人1"] == 0 and WAR.Data["自动选择参战人5"] == -1 and JY.Base["特殊"]> 0 and JY.Base["斗神"]> 0 then
		   WAR.Data["自动选择参战人5"] = 645
		   	WAR.Data["我方X5"] = WAR.Data["我方X1"]-1
			WAR.Data["我方Y5"] = WAR.Data["我方X1"]-1
		end
	
	
		for i = 1, 6 do
			local id = WAR.Data["自动选择参战人" .. i]
			if id >= 0 then
				--畅想的情况，畅想主角会取代强制出战的队友
				if id == JY.Base["畅想"] then
					WAR.Person[WAR.PersonNum]["人物编号"] = 0
				else
					WAR.Person[WAR.PersonNum]["人物编号"] = id
				end
				WAR.Person[WAR.PersonNum]["我方"] = true
				WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
				WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
				WAR.Person[WAR.PersonNum]["死亡"] = false
				WAR.Person[WAR.PersonNum]["人方向"] = 2
				--无酒不欢：调整战斗初始面向
				--战海大富
				if WAR.ZDDH == 259 then
					WAR.Person[WAR.PersonNum]["人方向"] = 1
				end
				--双挑公孙止
				if WAR.ZDDH == 273 then
					WAR.Person[WAR.PersonNum]["人方向"] = 1
				end
				--杨过单金轮
				if WAR.ZDDH == 275 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--战杨龙
				if WAR.ZDDH == 75 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--蒙哥
				if WAR.ZDDH == 278 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				--周芷若夺掌门
				if WAR.ZDDH == 279 then
					WAR.Person[WAR.PersonNum]["人方向"] = 0
				end
				WAR.PersonNum = WAR.PersonNum + 1
			end
		end

	
		if WAR.PersonNum > 0 and WAR.ZDDH ~= 235 then
			return 
		end

		lib.PicLoadFile(string.format(CC.FightPicFile[1],JY.Person[pid]["头像代号"]),
		string.format(CC.FightPicFile[2],JY.Person[pid]["头像代号"]), 4+i);
		local n=0;
		local m=0;
		for j=1,5 do
			if JY.Person[pid]['出招动画帧数'..j]>0 then
				if j>1 then
					m=j;
					break;
				end
				n=n+JY.Person[pid]['出招动画帧数'..j]
			end
		end
		p[i]= {id=pid, name=JY.Person[pid]["姓名"]; 
		Pic=n*8+JY.Person[pid]['出招动画帧数'..m]*6, PicNum=JY.Person[pid]['出招动画帧数'..m], idx=0, 
		x=x2+((i+3)%4)*pic_w, y=y2+math.modf((i+3)/4)*pic_h, x=x2+((i+2)%3)*pic_w, y=y2+math.modf((i+2)/3)*pic_h, picked=0,
		};
		--无酒不欢：强制出战的队友
		for j = 1, 6 do
			if WAR.Data["手动选择参战人" .. j] == p[i].id then
				p[i].picked = 1
				WAR.MCRS = WAR.MCRS + 1
			end
		end
	end
	
	--战三渡
	if WAR.ZDDH == 253 then
		WAR.MCRS = WAR.MCRS + 3
	end
	
	--逍遥御风 天池怪侠 太白诗仙 金蛇郎君
	--限定1人
	if WAR.ZDDH == 281 or WAR.ZDDH == 283 or WAR.ZDDH == 284 or WAR.ZDDH == 286 then
		WAR.MCRS = WAR.MCRS + 5
	end
	
	--刀剑合璧 九阴九阳
	--限定2人
	if WAR.ZDDH == 280 or WAR.ZDDH == 285 then
		WAR.MCRS = WAR.MCRS + 4
	end
	
 
	p[0]={name="全部选择"};

	if T_Num>T_Num+1 then
		p[0]={name="自动选择"}
	end

	p[T_Num+1]={name="开始战斗"};
	local leader=-1;
	--无酒不欢：强制出战的预设leader
	for i=1,T_Num do
		if p[i].picked == 1 then
			leader = i
			break
		end
	end
	DrawBoxTitle(width,height,'出战准备',C_ORANGE);
	local select=1;
	local sid=lib.SaveSur(0,0,CC.ScreenW,CC.ScreenH);
	local function redraw(zdrs)
		lib.LoadSur(sid,0,0);
		DrawBox(x0,y1,x0+CC.DefaultFont*5+4*2,y1+CC.DefaultFont*(T_Num+2)+4*(T_Num+3),C_WHITE);
		for i=0,T_Num+1 do
			local str=p[i].name;
			--选中时的名字显示
			--小于7人，名字前显示√表示已选择
			--大于等于7人，名字前显示×表示需要取消方可开始战斗
			if i > 0 and i < T_Num+1 and p[i].picked > 0 then
				if zdrs < 13 then
					str="√"..str;
				else
					str="×"..str
				end
			--未选中的只显示名字
			else
				str=" "..str;
			end
			if select==i then
				lib.Background(x1,y1+(CC.DefaultFont+4)*(i)+4,x1+CC.DefaultFont*5,y1+(CC.DefaultFont+4)*(i+1),128,C_ORANGE)
				DrawString(x1,y1+(CC.DefaultFont+4)*(i)+4,str,C_WHITE,CC.DefaultFont,C_ORANGE);
			elseif i>0 and i<=T_Num then
				DrawString(x1,y1+(CC.DefaultFont+4)*(i)+4,str,C_ORANGE,CC.DefaultFont);
			else
				DrawString(x1,y1+(CC.DefaultFont+4)*(i)+4,str,C_GOLD,CC.DefaultFont);
			end
		end
		for i=1,T_Num do
			local color;
			if p[i].picked > 0 then
				--DrawString(p[i].x-CC.DefaultFont,p[i].y-CC.DefaultFont/2,"出战",C_WHITE,CC.DefaultFont*2/3)
				color=C_WHITE;
				lib.PicLoadCache(4+i,p[i].Pic+p[i].idx*2,p[i].x,p[i].y)
				p[i].idx=p[i].idx+1;
				if p[i].idx>=p[i].PicNum then
					p[i].idx=0;
				end
			else
				color=M_Gray;
				lib.PicLoadCache(4+i,p[i].Pic,p[i].x,p[i].y)
				lib.PicLoadCache(4+i,p[i].Pic,p[i].x,p[i].y,6,180)
			end
		end
	end
	
	--local zdrs=0
	while true do
		if JY.Restart == 1 then
			break
		end
		redraw(WAR.MCRS);
		ShowScreen();
		lib.Delay(65);
		local k=lib.GetKey();
		if k==VK_UP then
			select=select-1;
		elseif k==VK_DOWN then
			select=select+1;
		elseif k==VK_SPACE or k==VK_RETURN then
			if select==0 then
				if p[0].name=="全部选择" or p[0].name=="自动选择" then
					local zrs=T_Num
					if zrs>6 then
						zrs=6
					end
					for i=1,zrs do
						if p[i].picked == 0 then
							p[i].picked=2;
							WAR.MCRS=WAR.MCRS+1
						end
					end
					if leader<0 then
						leader=1;
					end
					p[0].name="全部取消";
				elseif p[0].name=="全部取消" then
					for i=1,T_Num do
						if p[i].picked == 2 then
							p[i].picked=0;
							WAR.MCRS=WAR.MCRS-1
						end
					end
					leader=-1;
					--无酒不欢：强制出战的预设leader
					for i=1,T_Num do
						if p[i].picked == 1 then
							leader = i
							break
						end
					end
					p[0].name="全部选择"

					if T_Num>12 then
						p[0].name="自动选择"
					end
				end
			elseif select==T_Num+1 then
				if leader<0 then
					select=1;
				elseif WAR.MCRS>12 then
					select=1
				else
					local px={}
					local wz=0
					for i=1,T_Num do
						if p[i].picked > 0 then
							wz=wz+1
							px[wz]=i
						end
					end

					for i=1,6 do
						if px[i]~=nil then
							WAR.Person[WAR.PersonNum]["人物编号"]=JY.Base["队伍" ..px[i]]
							WAR.Person[WAR.PersonNum]["我方"]=true
							WAR.Person[WAR.PersonNum]["坐标X"]=WAR.Data["我方X"..i]
							WAR.Person[WAR.PersonNum]["坐标Y"]=WAR.Data["我方Y"..i]
							WAR.Person[WAR.PersonNum]["死亡"]=false
							WAR.Person[WAR.PersonNum]["人方向"]=2
							--无酒不欢：调整战斗初始面向
							--战海大富
							if WAR.ZDDH == 259 then
								WAR.Person[WAR.PersonNum]["人方向"] = 1
							end
							--双挑公孙止
							if WAR.ZDDH == 273 then
								WAR.Person[WAR.PersonNum]["人方向"] = 1
							end
							--杨过单金轮
							if WAR.ZDDH == 275 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--战杨龙
							if WAR.ZDDH == 75 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--蒙哥
							if WAR.ZDDH == 278 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							--周芷若夺掌门
							if WAR.ZDDH == 279 then
								WAR.Person[WAR.PersonNum]["人方向"] = 0
							end
							WAR.PersonNum=WAR.PersonNum+1
						end
					end

	for i = 7, wz do
		if px[i]~=nil then
							WAR.Person[WAR.PersonNum]["人物编号"]=JY.Base["队伍" ..px[i]]
							WAR.Person[WAR.PersonNum]["我方"]=true
							WAR.Person[WAR.PersonNum]["坐标X"]=WAR.Data["我方X"..i-6]+1
							WAR.Person[WAR.PersonNum]["坐标Y"]=WAR.Data["我方Y"..i-6]+1
							WAR.Person[WAR.PersonNum]["死亡"]=false
							WAR.Person[WAR.PersonNum]["人方向"]=2
							WAR.PersonNum=WAR.PersonNum+1
		end
	end	

					break;
				end
			else
				if p[select].picked == 2 then
					p[select].picked=0;
					WAR.MCRS=WAR.MCRS-1
					if leader==select then
						leader=-1;
						for i=1,T_Num do
							if p[i].picked > 0 then
								leader=i;
								break;
							end
						end
					end
					if leader==-1 then
						p[0].name="全部选择"

						if T_Num>6 then
							p[0].name="自动选择"
						end
					end
				elseif p[select].picked == 0 then
					p[select].picked=2;
					WAR.MCRS=WAR.MCRS+1
					if leader<0 then
						leader=select;
					end
					for i=1,T_Num do
						if p[i].picked == 0 then
							break;
						end
						if i==T_Num then
							p[0].name="全部取消";
						end
					end
				end
			end
		end
		if select<0 then
			select=T_Num+1;
		elseif select>T_Num+1 then
			select=0;
		end
	end
	lib.FreeSur(sid);
end

--葵花魅影
function kuihuameiying()
	local x, y
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["人物编号"] == 0 then
			x, y = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
			break
		end
	end
	local function vacant(x,y)
		local r = true
		if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
			r = false
	    elseif CC.SceneWater[lib.GetWarMap(x, y, 0)] ~= nil then
	       	r = false
	    end
		if x < 1 or x > 63 then
			r = false
		end
		if y < 1 or y > 63 then
			r = false
		end
		return r
	end
	local telx, tely = 0, 0
	local can_tele = 0
	for i = -3, 3 do
		for j = -3, 3 do
			if vacant(x+i,y+j) then
				telx, tely = x+i, y+j
				can_tele = 1
			end
		end
	end
	if can_tele == 1 then
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 120, 1, "葵花魅影", C_GOLD)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
		WarDrawMap(0)
		WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = telx, tely
		WarDrawMap(0)
		CurIDTXDH(WAR.CurID, 120, 1, "葵花魅影", C_GOLD)
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
		lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
		WarDrawMap(0)
		return true
	else
		return false
	end
end

--辟邪招式
function BiXieZhaoShi(id,MiaofaWX)
	WAR.BXZS = 0
	if not WAR.BXLQ[id] then
		WAR.BXLQ[id] = {0,0,0,0,0,0}
	end
	local zs={
	{name="【天剑】指打奸邪",Usable=true,m1=1,m2=1,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX},
	{name="【快剑】飞燕穿柳",Usable=true,m1=3,m2=1,a1=10,a2=8+MiaofaWX,a3=7+MiaofaWX,a4=6+MiaofaWX},
	{name="【花剑】花开见佛",Usable=true,m1=0,m2=0,a1=5,a2=6+MiaofaWX,a3=3+MiaofaWX},
	{name="【利剑】锺馗抉目",Usable=true,m1=0,m2=5,a1=2,a2=4+MiaofaWX},
	{name="【重剑】扫荡群魔",Usable=true,m1=3,m2=1,a1=11,a2=6+MiaofaWX},
	{name="【气剑】紫气东来",Usable=true,m1=0,m2=6,a1=3,a2=3+MiaofaWX,a3=3+MiaofaWX},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if not PersonKF(id,105) then
		for i = 3, 6 do
			zs[i].Usable=false
		end
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.BXLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, "招式气攻："..CC.KFMove[48][choice][2], C_WHITE, size)
		if WAR.BXCD[choice] == 0 or match_ID(id, 36) then
			DrawString(500, 570, "冷却时间：无", C_WHITE, size)
		else
			DrawString(500, 570, "冷却时间："..WAR.BXCD[choice].."回合", C_WHITE, size)
		end
		if choice > 2 and not PersonKF(id,105) then
			DrawString(500, 620, "习得葵花神功后方可使用", C_WHITE, size)
		elseif WAR.BXLQ[id][choice] > 0 then
			DrawString(500, 620, "冷却中，"..WAR.BXLQ[id][choice].."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.BXZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end

--太玄招式
function TaiXuanZhaoShi()
	WAR.TXZS = 0
	local zs={
	{name="太玄神功·拳"},
	{name="太玄神功·指"},
	{name="太玄神功·剑"},
	{name="太玄神功·刀"},
	{name="太玄神功·奇"}
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)

	local choice = 1

	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE

			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 123+i*50, zs[i].name, color, size*0.9)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, CC.KFMove[102][choice][1], C_WHITE, size)

		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			break
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs then
				choice = input
				break
			end
		end
	end
	WAR.TXZS = choice
	return
end

--黯然招式
function AnRanZhaoShi(id,MiaofaWX)
	WAR.ARZS = 0
	if not WAR.ARLQ[id] then
		WAR.ARLQ[id] = {0,0,0,0,0,0}
	end
	local zs={
	{name="杞人忧天",Usable=true,m1=0,m2=7+MiaofaWX,a1=3,a2=5+MiaofaWX,a3=5+MiaofaWX,a4=1,a5=1},
	{name="无中生有",Usable=true,m1=3,m2=1,a1=5,a2=4+MiaofaWX,a3=7+MiaofaWX,a4=6+MiaofaWX,a5=1},
	{name="拖泥带水",Usable=true,m1=0,m2=5,a1=7,a2=6+MiaofaWX,a3=3+MiaofaWX},
	{name="行尸走肉",Usable=true,m1=0,m2=5,a1=2,a2=4+MiaofaWX,a3=7+MiaofaWX,a4=1,a5=1},
	{name="倒行逆施",Usable=true,m1=3,m2=1,a1=11,a2=6+MiaofaWX},
	{name="面无人色",Usable=true,m1=0,m2=6,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	if wglw(id,25)<3 then
		for i = 5, 6 do
			zs[i].Usable=false
		end
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.ARLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, "招式气攻："..CC.KFMove[25][choice][2], C_WHITE, size)
		if WAR.ARCD[choice] == 0 or match_ID(id, 58) then
			DrawString(500, 570, "冷却时间：无", C_WHITE, size)	
		else
			DrawString(500, 570, "冷却时间："..WAR.ARCD[choice].."回合", C_WHITE, size)
		end
		if choice > 4 and wglw(id,25)<3 then
			DrawString(500, 620, "黯然三阶后方可使用", C_WHITE, size)
		elseif WAR.ARLQ[id][choice] > 0 then
			DrawString(500, 620, "冷却中，"..WAR.ARLQ[id][choice].."回合后可再次使用", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.ARZS = choice
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end


function LiuMai(id,MiaofaWX)
	WAR.LMZS = 0
	if not WAR.LMLQ[id] then
		WAR.LMLQ[id] = {0,0,0,0,0,0}
	end
	local zs={
	{name=LMSJ[1],Usable=true,m1=1,m2=1,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX,Effect="攻击判定倍率上升，根据阶层有提升效果"},
	{name=LMSJ[2],Usable=true,m1=3,m2=1,a1=10,a2=8+MiaofaWX,a3=7+MiaofaWX,a4=6+MiaofaWX,Effect="高几率打中破绽，且打中破绽时造成暴击"},
	{name=LMSJ[3],Usable=true,m1=0,m2=0,a1=5,a2=6+MiaofaWX,a3=3+MiaofaWX,Effect="额外杀气根据伤害与内力值提升"},
	{name=LMSJ[4],Usable=true,m1=0,m2=5,a1=2,a2=4+MiaofaWX,Effect="削弱敌人防御力"},
	{name=LMSJ[5],Usable=true,m1=3,m2=1,a1=11,a2=6+MiaofaWX,Effect="高连击，根据自身轻功值提升伤害与连击伤害"},
	{name=LMSJ[6],Usable=true,m1=0,m2=6,a1=3,a2=3+MiaofaWX,a3=3+MiaofaWX,Effect="高几率造成流血或者封穴"},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1, m2, a1, a2, a3, a4, a5
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.LMLQ[id][i] > 0 then
				zs[i].Usable=false
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(520, 520, "招式气攻：".."2000", C_WHITE, size)
		DrawString(520, 620, zs[choice].Effect, C_ORANGE, size)
		if WAR.LMCD[choice] == 0  then
			DrawString(520, 570, "冷却时间：无", C_WHITE, size)	
		else
			DrawString(520, 570, "冷却时间："..WAR.LMCD[choice].."回合", C_WHITE, size)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.LMZS  = choice
addeffect2(WAR.QXJQ, id, math.random(1,3),2+wglw(id,49)*2) 
	m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end


function TTFL1(id1,id2)
	local ttl ={"金刚符","力士符","戴院长符","阴阳符","元气神符","幸运符"} 
    local ky = {0,0,0,0,0,0}
	local zs={
	{name=ttl[1],Usable=true,Effect="强化防御，4层降低伤害，7层高几率发动如山"},
	{name=ttl[2],Usable=true,Effect="强化力量，4层无视部分防御，7层附带真实伤害"},
	{name=ttl[3],Usable=true,Effect="强化轻功，4层移动距离上升，7层几率奔流"},
	{name=ttl[4],Usable=true,Effect="时序回血回内，4层行动后回复，7层几率生命内力奔流"},
	{name=ttl[5],Usable=true,Effect="强化加力护体，4层双倍气攻气防，7层增强或减免杀气"},
	{name=ttl[6],Usable=true,Effect="强化概率，4层增加二次判定，7层视同于幸运状态"},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 910, 118+i*50, 1)
			local color = C_WHITE
			if WAR.FZ[id2] == nil then
			   WAR.FZ[id2] = {nil,nil,nil,nil,nil,nil}
			   end
            if (WAR.FZ[id2][i] or 0) > 9 then
				zs[i].Usable=false
				ky[i] = 1
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(920, 123+i*50, i, color, size*0.8)
			DrawString(951, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 880, 500, 1)
		DrawString(900, 520, zs[choice].Effect, C_ORANGE, size*0.5)
		if ky[choice] == 0  then
			DrawString(900, 570, "可用", C_WHITE, size*0.5)	
		else
			DrawString(900, 570, "已达上限", C_WHITE, size*0.5)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	return choice
end


function QCQH(id1,id2)
    local ttl ={"夹竹桃","蚁酸","波斯旬","五步蛇毒"}
   local ky = {0,0,0,0}
    local zs={
	     {name=ttl[1],Usable=true,Effect="出现幻觉，导致中毒者精神错乱"},
	     {name=ttl[2],Usable=true,Effect="导致中毒者虚弱"},
	     {name=ttl[3],Usable=true,Effect="导致中毒者陷入【无名业火】状态"},
	     {name=ttl[4],Usable=true,Effect="导致中毒者陷入【八音穿心】状态"},
	     }
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 1010, 168+i*50, 1)
			local color = C_WHITE
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(1180, 172+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(1020, 173+i*50, i, color, size*0.8)
			DrawString(1051, 172+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 880, 520, 1)
		DrawString(1000, 540, zs[choice].Effect, C_ORANGE, size*0.5)
		if ky[choice] == 0  then
			DrawString(1000, 590, "可用", C_WHITE, size*0.5)	
		else
			DrawString(1000, 790, "不可用", C_WHITE, size*0.5)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	return choice
end

function TTFL2(id1,id2)
	local ttl ={"压制符","狂怒符","虚力符","封经符","丧魂符","劳情符"} 
    local ky = {0,0,0,0,0,0}
	local zs={
	{name=ttl[1],Usable=true,Effect="弱化轻功，4层降低移动距离，7层几率集气倒退"},
	{name=ttl[2],Usable=true,Effect="弱化怒气爆发效果，4层怒气爆发后扣除生命，7层怒气爆发后杀气降低"},
	{name=ttl[3],Usable=true,Effect="弱化力量，4层攻击力减半，7层伤害减半"},
	{name=ttl[4],Usable=true,Effect="弱化封穴抗性，4层时序几率产生封穴，7层时序几率内功停运"},
	{name=ttl[5],Usable=true,Effect="弱化战意效果，4层行动后几率精神错乱，7层几率被震慑"},
	{name=ttl[6],Usable=true,Effect="弱化概率，4层集气方向紊乱，7层视同于不幸状态"},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if WAR.FZ2[id2] == nil then
			   WAR.FZ2[id2] = {nil,nil,nil,nil,nil,nil}
			   end
            if (WAR.FZ2[id2][i] or 0) > 9 then
				zs[i].Usable=false
				ky[i] = 1
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, zs[choice].Effect, C_ORANGE, size*0.5)
		if ky[choice] == 0  then
			DrawString(500, 570, "可用", C_WHITE, size*0.5)	
		else
			DrawString(500, 570, "已达上限", C_WHITE, size*0.5)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	return choice
end

function LDZL(id)
	local ttl ={"灵貂","玄蛇","风枭","心猿"} 
    local ky = {0,0,0,0,0,0}
	local zs={
	{name=ttl[1],Usable=true,Effect="偷取敌人物品，附加中毒，毒满则扣除生命，消耗5点体力",haoti=5},
	{name=ttl[2],Usable=true,Effect="注入10时序神经蛇毒与溶血蛇毒，消耗10点体力",haoti=10},
	{name=ttl[3],Usable=true,Effect="集气倒走20时序，若集气位置小于0则根据位置扣除生命，消耗20点体力",haoti=20},
	{name=ttl[4],Usable=true,Effect="附加灼烧，清空怒气并造成相应的伤害，消耗30点体力",haoti=30},
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
	local m1
	local choice = 1
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
            if JY.Person[id]["体力"] <= zs[i].haoti  then
				zs[i].Usable=false
				ky[i] = 1
			end
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, zs[choice].Effect, C_ORANGE, size*0.5)
		if ky[choice] == 0  then
			DrawString(500, 570, "可用", C_WHITE, size*0.5)	
		else
			DrawString(500, 570, "体力不够", C_WHITE, size*0.5)
		end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	return choice
end

--六禽招式
function LQZhaoShi(id,MiaofaWX)
  --无酒不欢：参数说明
  --m1为移动范围斜向延伸：
	--0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
  --m2为移动范围直线延伸；
	--数字即等于延伸距离
  --a1为攻击范围类型：
	--0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：卍字，9：卐字，10：直线，11：正三角，12：倒三角，13：横线
  --a2为攻击范围长度距离：
	--0：点攻，大于0时，距离 = a2
  --a3为攻击范围宽度(偏移1格)距离：
	--0：点攻，大于0时，距离 = a3  
  --a4为攻击范围宽度(偏移2格)距离：
	--0：点攻，大于0时，距离 = a4
  --a5为攻击范围宽度(偏移3格)距离：
	--0：点攻，大于0时，距离 = a5
	WAR.LQZS = 0
	local zs={
	{name="飞燕势·回风流波",Usable=true,m1=0,m2=3+MiaofaWX,a1=2,a2=3+MiaofaWX,a3=3+MiaofaWX,a4=1,a5=1},
	{name="孤鹫势·狱屠长空",Usable=true,m1=2,m2=1,a1=11,a2=4+MiaofaWX,a3=7+MiaofaWX,a4=1+MiaofaWX,a5=1},
	{name="水鸟势·凌波亮翅",Usable=true,m1=0,m2=5,a1=7,a2=4+MiaofaWX,a3=3+MiaofaWX},
	{name="红鹤势·血喙梳妆",Usable=true,m1=2,m2=3,a1=5,a2=4+MiaofaWX,a3=7+MiaofaWX,a4=1+MiaofaWX,a5=1},
	{name="白鹭势·信步涉滩",Usable=true,m1=3,m2=1,a1=9,a2=6+MiaofaWX,a4=1+MiaofaWX,a5=1},
	{name="凤凰势·翙羽天炽",Usable=true,m1=0,m2=6,a1=1,a2=3+MiaofaWX,a3=3+MiaofaWX}
	}
	local size = CC.DefaultFont
	local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
local m1, m2, a1, a2, a3, a4, a5
	local choice = 1

		for i = 3, 6 do
			zs[i].Usable=false
		end	
	
	if (WAR.SATA[id] or 0) >= 2 then
			zs[5].Usable= true
	end	

	if (WAR.DR[id] or 0) >= 2 then
			zs[6].Usable= true
	end		
	
	if (WAR.SATA[id] or 0) >= 1 then
			zs[3].Usable= true
	end	

	if (WAR.DR[id] or 0) >= 1 then
			zs[4].Usable= true
	end		
	
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		for i = 1, #zs do
			lib.LoadPNG(1, 997 * 2 , 510, 118+i*50, 1)
			local color = C_WHITE
			if zs[i].Usable==false then
				color = M_Gray
				if i == choice then
					DrawString(680, 122+i*50, "X", C_RED, size)
				end
			end
			if i == choice then
				color = C_GOLD
			end
			DrawString(520, 123+i*50, i, color, size*0.8)
			DrawString(551, 122+i*50, zs[i].name, color, size)
		end
		
		lib.LoadPNG(1, 996 * 2 , 480, 500, 1)
		DrawString(500, 520, "招式气攻："..CC.KFMove[4][choice][2], C_RED, size)
		
		
  if  choice <=2 then
      DrawString(500, 570, "可用", C_WHITE, size)
  else
		if zs[choice].Usable==false then
			DrawString(500, 620, "需要满足条件方能使用", C_GOLD, size)
		else
		    DrawString(500, 620, "可用", C_WHITE, size)	
		end
  end
		ShowScreen()
		
		local keyPress, ktype, mx, my = lib.GetKey()
		lib.Delay(CC.Frame)
		
		if keyPress==VK_SPACE or keyPress==VK_RETURN then
			if zs[choice].Usable then
				break
			end
		elseif keyPress == VK_UP then
			choice = choice - 1
			if choice < 1 then
				choice = #zs
			end
		elseif keyPress == VK_DOWN then
			choice = choice + 1
			if choice > #zs then
				choice = 1
			end
		elseif keyPress >= 49 and keyPress <= 57 then
			local input = keyPress - 48
			if input <= #zs and zs[input].Usable then
				choice = input
				break
			end
		end
	end
	WAR.LQZS = choice
    m1, m2, a1, a2, a3, a4, a5 = zs[choice].m1, zs[choice].m2, zs[choice].a1, zs[choice].a2, zs[choice].a3, zs[choice].a4, zs[choice].a5
	return m1, m2, a1, a2, a3, a4, a5
end



--判定可否使用某武功
function skill_usable(pid, tmp)
	local r = true
	--内功
	if JY.Wugong[tmp]["武功类型"] == 6 then
		--游坦之可以
		if match_ID(pid, 48) then
			r = true
		elseif pid == 0 and JY.Base["标准"] == 6 then
			r = true
		elseif pid == 0 and JY.Base["畅想"] > 0 and JY.Person[0]["武功1"] == tmp then
			r = true
		else
			r = false
		end
	end
	
	--轻功无法攻击
	if JY.Wugong[tmp]["武功类型"] == 7 then
		r = false
	end
			
	--斗转星移
	if tmp == 43 then
		if match_ID(pid, 51) then
			r = true
		else
			r = false
		end
	end
		  
	--林平之 东方 多蒙 显示葵花神功
	if tmp == 105 and (match_ID(pid, 36) or match_ID(pid, 27) or match_ID_awakened(pid, 38,2) or nglw(pid,105)>1) then
		r = true
	end
		   
	--石破天 显示太玄神功
	if tmp == 102 and match_ID(pid, 38) then
		r = true
	end
		  
	--张无忌 显示九阳神功
	if tmp == 106 and match_ID(pid, 9) then
		r = true
	end
		  
	--狄云 显示神经照
	if tmp == 94 and match_ID(pid, 37) then
		r = true
	end
		  
	--欧阳锋 显示逆运
	if tmp == 104 and match_ID(pid, 60) then
		r = true
	end
			
	--小昭 显示圣火
	if tmp == 93 and match_ID(pid, 66) then
		r = true
	end
	return r
end

G["NPC内功补完系统"] = function(id)
	if id ==0 and JY.Base["畅想"]~= 0 then -- 主角参与
       id = JY.Base["畅想"]
	end
	local l = {}
	l[1]={"冷月飞狐诀",500}	--胡斐
	l[3]={"金佛功",800}		--苗人凤
	l[6]={"峨眉九阳功",900}	--灭绝
	l[7]={"两仪微尘功",700}	--何太冲
	l[8]={"七伤心法",700}	--唐文亮
	l[12]={"天鹰神功",700}	--殷天正
	l[14]={"邪蝠心诀",700}	--韦一笑
	l[15]={"圣女心法",700}	--黛绮丝
	l[20]={"衡山心法",600}	--莫大
	l[21]={"恒山心法",600}	--定闲
	l[22]={"嵩阳真气",600}	--左冷禅
	l[23]={"泰山心法",600}	--天门
	l[24]={"青冥玄功",500}	--余沧海
	l[43]={"自在极意功",500}	--白万剑
	l[44]={"吐纳心法",600}	--岳老三
	l[46]={"龟息功",1000}	--丁春秋
	l[51]={"慕容心法",800}	--慕容复

	l[68]={"全真内功",800}	--丘处机
	l[72]={"天龙心法",500}	--田归农
	l[75]={"天池心法",800}	--陈家洛
	l[83]={"五仙毒诀",800}	--何红药
	l[98]={"天南易阳决",800}--段延庆
	l[99]={"吐纳心法",600}	--叶二娘
	l[100]={"吐纳心法",600}	--云中鹤
	l[107]={"反两仪心法",700}	--矮老者
	l[108]={"反两仪心法",700}	--高老者
	l[109]={"华山心法",700}	--鲜于通
	l[114]={"少林九阳功",700}	--鲜于通
	l[119]={"天南易阳决",800}	--点苍渔隐
	l[120]={"天南易阳决",800}	--樵夫
	l[121]={"天南易阳决",800}	--武三通
	l[122]={"天南易阳决",800}	--朱子柳
	l[123]={"全真内功",800}
	l[124]={"全真内功",800}
	l[125]={"全真内功",800}
	l[126]={"全真内功",800}
	l[127]={"全真内功",800}
	l[128]={"全真内功",800}
	l[141]={"华山心法",700} --成不忧
	l[142]={"狂风心诀",700}	--封不平
	l[150]={"昆仑心法",700}	--冯锡范
	l[151]={"红花心法",500}
	l[152]={"红花心法",500}
	l[153]={"红花心法",500}
	l[154]={"红花心法",500}
	l[155]={"红花心法",500}
	l[156]={"红花心法",500}
	l[157]={"鬼王心经",1000}	--潇湘子
	l[158]={"商贾秘法",1000}	--尹克西
	l[159]={"释迦掷象功",1000}	--尼摩星
	l[162]={"丁氏心法",500} --丁不三
	l[163]={"丁氏心法",500} --丁不四
	--何红药，华山众咸鱼
	for i = 176, 183 do
		l[i]={"培息功",500}
	end
	for i = 461, 496 do
		l[i]={"少林基础心法",500}
	end
	l[41]={"培息功",500}
	l[42]={"培息功",500}
	l[186]={"培息功",500}
	l[187]={"培息功",500}
	l[188]={"培息功",500}
	--其他咸鱼
	for i = 130, 139 do
		l[i]={"养元功",500}
	end
	--其他咸鱼
	for i = 31, 34 do
		l[i]={"养元功",500}
	end
	if l[id] then
		return l[id][1], l[id][2]
	else
		return nil
	end
end

Ct['菜单'] = function(me,num,x,y,color,size,lx,color2,h)
	local bx,by = CC.ScreenW/936,CC.ScreenH/701 
	local menu = {}
	local size = CC.FontSmall
	local cot = 1
	local cot1 = 0
	for i = 1,#me do 
		if me[i][3] == 1 then 
			menu[#menu+1] = {me[i][1],i}
		end
	end
	if #menu == 0 then 
		return 0 
	end	
	if num == nil then 
		num = #menu 
	else 
		if num > #menu  then 
			num = #menu
		end
	end
	while true do
		if JY.Restart == 1 then
			break
		end
		Cls()
		
		Cls()
		
		for i = 1,num do 
			lib.PicLoadCache(92,1*2,x+(i-1)*bx*40,y,2,255)
			local cl = C_WHITE
			if i == cot then 
				cl = C_RED
			end
			if lx == nil then
				draw2(menu[i+cot1][1],x+(i-1)*bx*40,y - size*2 , cl, size,color2,h)	
			else 
				local stn = string.len(menu[i+cot1][1])/2
				local hsize = bx*100/stn
				draw3(menu[i+cot1][1],x+(i-1)*bx*40,y - ((stn-1)*hsize+size)/2, cl, size,color2,hsize)	
			end
		end
		ShowScreen()
		lib.Delay(CC.BattleDelay)
		
		local X, ktype, mx, my = lib.GetKey();
		if X == VK_SPACE or X == VK_RETURN then
			return menu[cot+cot1][2]
		elseif X == VK_ESCAPE or ktype == 4 then
			return 0
		elseif X == VK_UP then	
			
		elseif X == VK_DOWN then
			
		elseif X == VK_LEFT then
			if cot > 1 then 
				cot = cot - 1 
			else 
				if cot1 > 0 then 
					cot1 = cot1 - 1
				else 
					cot = num
					cot1 = #menu - num
				end
			end
		elseif X == VK_RIGHT then
			if cot + cot1 < #menu then 
				if cot < num then 
					cot = cot + 1
				else 
					cot1 = cot1 + 1
				end
			else 
				cot = 1
				cot1 = 0
			end		
		elseif menu[1] ~= nil and string.sub(menu[1][1],1,4) == '蓄力' and X == VK_P then 
			return 1
		elseif menu[2] ~= nil and string.sub(menu[2][1],1,4) == '防御' and X == VK_D then 
			return 2
		elseif menu[3] ~= nil and string.sub(menu[3][1],1,4) == '等待' and X == VK_W then 
			return 3
		elseif menu[4] ~= nil and string.sub(menu[4][1],1,4) == '集中' and X == VK_J then 
			return 4
		elseif menu[5] ~= nil and string.sub(menu[5][1],1,4) == '休息' and X == VK_R then 
			return 5
		else 	
			local mxx = false 
			for i = 1,#menu do 
				if mx >= bx*25+(i-1)*bx*40 - bx*20 and mx <= bx*25+(i-1)*bx*40 + bx*20 and 
					my >= CC.ScreenH-by*60 - by*55 and my <= CC.ScreenH-by*60 + by*55 then 
					cot = i 
					mxx = true
					break
				end
			end
			if ktype == 3 and mxx == true then
				return menu[cot+cot1][2]
			end
		end
		
	end
end

--[[
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	--local isEsc = 0
	
	local warmenu = {
	{"移动", War_MoveMenu, 1},	--1
	{"攻击", War_FightMenu, 1},	--2
	{"运功", War_YunGongMenu, 1},	--3
	{"战术", War_TacticsMenu, 1},	--4
     {"其它", War_OtherMenu, 1},	--13  --5		

	{"特色", War_TgrtsMenu, 1},	--11 --6
	{"撤退", War_Retreat, 1},	--12  --7
	{"自动", War_AutoMenu, 1}	--13  --8
	
	}
]]
Ct['战斗菜单'] = function()
	
	local bx,by = CC.ScreenW/936,CC.ScreenH/701 
	
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	
	local warmenu = {
					{'移动Ｍ','移动',1},
					{'武功Ａ','武功',1},
					{'绝技Ｌ','绝技',1},
					{'运功Ｇ','运功',1},
					{'战术Ｓ','战术',1},
					{'物品Ｅ','物品',1},
					{'其他Ｈ','其他',1},
					{'撤退Ｃ','撤退',1},
					{'自动Ｔ','自动',1},
	
				}
	
    if MPPD(pid) == 0 then
		warmenu[14][3] = 0
	else
		local mptype = MPPD(pid)
		local mpdj = MPDJ(pid)
		if mpdj < 2 or JY.Person[pid]["体力"] <= 50 then
			warmenu[14][3] = 0
		end
	end	
	
	--特色指令
	if JY.Person[pid]["特色指令"] == 1 then
		--如果是畅想
		if pid == 0 then
			warmenu[3][1] = GRTS[JY.Base["畅想"]]
		else
			warmenu[3][1] = GRTS[pid]
		end
	else
		warmenu[3][3] = 0
	end
  	
	--虚竹
	if match_ID(pid, 49) then
		--如果没有中生死符的人物则不显示特色指令
		local t = 0
		for i = 0, WAR.PersonNum - 1 do
			local wid = WAR.Person[i]["人物编号"]
			if WAR.TZ_XZ_SSH[wid]~=nil and WAR.TZ_XZ_SSH[wid] >= 1 and WAR.Person[i]["死亡"] == false then
				t = 1
			end
		end
		if t == 0 then
			warmenu[3][3] = 0
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[3][3] = 0
		end
	end
 
  if WAR.BZ[pid] ~= nil then
	warmenu[2][3] = 0
warmenu[3][3] = 0	
  end
 
   if WAR.BCB[pid] ~= nil then
	warmenu[2][3] = 0
warmenu[3][3] = 0	
  end
 
   if WAR.WSZ[pid] ~= nil then
      local aa= WAR.WSZ[pid]
	  if math.random(40)< aa then
	  	warmenu[2][3] = 0	
		warmenu[3][3] = 0
	  end
  end
 
   if WAR.LXZT[pid]~=nil and WAR.LXZT[pid]>=25 and JY.Person[pid]["生命"] < math.modf(0.2*JY.Person[pid]["生命最大值"])  then
  warmenu[2][3] = 0	
  warmenu[3][3] = 0
  end
	--祖千秋
	if match_ID(pid, 88) then
		--如果周围没有队友不显示特色指令
		local yes = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and i ~= WAR.CurID then
				yes = 1
			end
		end
		if yes == 0 then
			warmenu[3][3] = 0
		end
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[3][3] = 0
		end
	end

	--人厨子
	if match_ID(pid, 89) then
		--如果周围没有队友不显示特色指令
		local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
		local mxy = {
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1}, 
					{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1}, 
					{WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]}, 
					{WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}

		local yes = 0
		for i = 1, 4 do
			if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
			local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
			if inteam(WAR.Person[mid]["人物编号"]) then
				yes = 1
				end
			end  
		end
		if yes == 0 then
			warmenu[3][3] = 0
		end
		--体力小于25不显示特色指令
		if JY.Person[pid]["体力"] < 25 then
			warmenu[3][3] = 0
		end
	end

	--张无忌
	if match_ID(pid, 9) then
		--如果周围没有队友不显示特色指令
		local yes = 0
		for i = 0, WAR.PersonNum - 1 do
			if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and i ~= WAR.CurID then
				yes = 1
			end
		end
		if yes == 0 then
			warmenu[3][3] = 0
		end
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[3][3] = 0
		end
	end
 
	--蓝烟清：霍青桐统率指令
	if match_ID(pid, 74) then
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[3][3] = 0
		end
	end

	--慕容复指令 幻梦
	if match_ID(pid, 51) then
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[3][3] = 0
		end
	end
	
	--小昭指令 影步
	if match_ID(pid, 66) then
		--体力小于30，或内力小于2000不显示特色指令
		if JY.Person[pid]["体力"] < 30  then
			warmenu[3][3] = 0
		end
	end
 
 
	--钟灵指令 灵貂
	if match_ID(pid, 90) then
		--体力小于10不显示特色指令
		if JY.Person[pid]["体力"] < 10 then
			warmenu[3][3] = 0
		end
	end
	
	--胡斐指令 飞狐
	if match_ID(pid, 1) then
		--体力小于20不显示特色指令
		if JY.Person[pid]["体力"] < 20 then
			warmenu[3][3] = 0
		end
	end
	
	--鸠摩智指令 幻化
	if match_ID(pid, 103) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[3][3] = 0
		end
	end	
 
 	--黄蓉 遁甲
	if match_ID(pid, 56) then
		if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
			warmenu[3][3] = 0
		end
	end
	
--出左右时，移动，解毒，医疗，物品，特色，自动不可见
	if WAR.ZYHB == 2 then
		for i = 1,#warmenu do
			if i == 2 or i == 4 or i == 5  then
				warmenu[i][3] = 1
			else 	
				warmenu[i][3] = 0
			end
		end
	end
  
	--体力小于5或者已经移动过时，移动不可见
	if JY.Person[pid]["体力"] <= 5 or WAR.Person[WAR.CurID]["移动步数"] <= 0 then
		warmenu[1][3] = 0
		--isEsc = 1
	end
  
	--判断最小内力，是否可显示攻击
	local minv = War_GetMinNeiLi(pid)
	if JY.Person[pid]["内力"] < minv or JY.Person[pid]["体力"] < 10 then
		warmenu[2][3] = 0
	end
  
  
	--新华山论剑，不可使用物品
	if WAR.ZDDH == 238 then
		warmenu[6][3] = 0
	end
	
	local menu = {}
	for i = 1,#warmenu do
		if warmenu[i][3] == 1 then 
			menu[#menu+1] = {warmenu[i][2],i,warmenu[i][1]}
		end
	end	
	local size = CC.FontSmall
	local cot = 1
	while true do 
		if JY.Restart == 1 then
			break
		end	
		
		Cls()
		DrawTimeBar_sub()
		for i = 1,#menu do 
			lib.PicLoadCache(92,1*2,bx*25+(i-1)*bx*40,CC.ScreenH-by*60,2,255)
			local cl = C_WHITE
			if i == cot then 
				cl = C_RED
			end
			draw2(menu[i][3],bx*25+(i-1)*bx*40,CC.ScreenH-by*60 - size*2, cl, size,LimeGreen)	
		end
		ShowScreen()
		lib.Delay(CC.BattleDelay)
		
		local X, ktype, mx, my = lib.GetKey();
		if X == VK_SPACE or X == VK_RETURN then
			local r
			if menu[cot][2] ~= nil then
				r = Cat(menu[cot][1])
				if r == 1 then 
					if menu[cot][2] == 1 then 
						return 1
					else 
						break
					end
				end
			end
		elseif X == VK_ESCAPE or ktype == 4 then
			return 0
		elseif X == VK_UP then	
			
		elseif X == VK_DOWN then
			
		elseif X == VK_LEFT then
			cot = cot - 1 
			if cot < 1 then
				cot = #menu
			end
		elseif X == VK_RIGHT then
			cot = cot + 1 
			if cot > #menu then 
				cot = 1
			end
			--移动
		elseif X == VK_M then
			if warmenu[1][3] == 1 then
				local r = Cat(warmenu[1][2])
				if r == 1 then 
					return 1 
				end
			end	
			--武功
		elseif X == VK_A then
			if warmenu[2][3] == 1 then
				local r = Cat(warmenu[2][2])
				if r == 1 then 
					break
				end
			end	
			--绝技
		elseif X == VK_L then
			if warmenu[3][3] == 1 then
				local r = Cat(warmenu[3][2])
				if r == 1 then 
					break
				end
			end	
			--运功
		elseif X == VK_G then
			if warmenu[4][3] == 1 then
				local r = Cat(warmenu[4][2])
				if r == 1 then 
					break
				end
			end	
			--战术
		elseif X == VK_S then
			if warmenu[5][3] == 1 then
				local r = Cat(warmenu[5][2])
				if r == 1 then 
					break
				end
			end	
			--物品
		elseif X == VK_E then
			if warmenu[6][3] == 1 then
				local r = Cat(warmenu[6][2])
				if r == 1 then 
					break
				end
			end	
			--其他
		elseif X == VK_H then
			if warmenu[7][3] == 1 then
				local r = Cat(warmenu[7][2])
				if r == 1 then 
					break
				end
			end	
			--撤退
		elseif X == VK_C then
			if warmenu[8][3] == 1 then
				local r = Cat(warmenu[8][2])
				if r == 1 then 
					break
				end
			end	
			--自动
		elseif X == VK_T then
			if warmenu[9][3] == 1 then
				local r = Cat(warmenu[9][2])
				if r == 1 then 
					break
				end
			end	
		elseif X >= 49 and X <= 57 and warmenu[2][3] == 1 then
			local r = War_FightMenu(nil, nil, X-48);
			if r == 1 then 
				break
			end
		elseif X == VK_P and warmenu[5][3] == 1 then
			War_ActupMenu()
			break
		elseif X == VK_D and warmenu[5][3] == 1 then
			War_DefupMenu()
			break
		elseif X == VK_W and warmenu[5][3] == 1 then
			War_Wait()
			break
		elseif X == VK_J and warmenu[5][3] == 1 then
			War_Focus()
		elseif X == VK_R and warmenu[5][3] == 1 then
			War_RestMenu()
			break
		elseif X == VK_V and warmenu[7][3] == 1 then 
			local r = War_PoisonMenu()
			--解毒
				if r == 1 then 
					break
				end
		elseif X == VK_Q and warmenu[7][3] == 1 then 
			local r = War_DecPoisonMenu()
			--医疗
				if r == 1 then 
					break
				end
		elseif X == VK_F and warmenu[7][3] == 1 then 
			local r = War_DoctorMenu()
				if r == 1 then 
					break
				end
		elseif X == VK_Z and warmenu[7][3] == 1 then 
			Ckstatus()
		else 	
			local mxx = false 
			for i = 1,#menu do 
				if mx >= bx*25+(i-1)*bx*40 - bx*20 and mx <= bx*25+(i-1)*bx*40 + bx*20 and 
					my >= CC.ScreenH-by*60 - by*55 and my <= CC.ScreenH-by*60 + by*55 then 
					cot = i 
					mxx = true
					break
				end
			end
			if ktype == 3 and mxx == true then
				local r
				if menu[cot][2] ~= nil then
					r = Cat(menu[cot][1])
					if r == 1 then 
						if menu[cot][2] == 1 then 
							return 1
						else 
							break
						end
					end
				end
			end
		end
		
	end
end

Ct['移动'] = function()
	return War_MoveMenu()
end

Ct['武功'] = function()
	local bx,by = CC.ScreenW/936,CC.ScreenH/701 
	
	local pid = WAR.Person[WAR.CurID]["人物编号"]
	
	local numwugong = 0
	local kfmenu = {}

	for i = 1, JY.Base["武功数量"] do
		local tmp = JY.Person[pid]["武功" .. i]
		if tmp > 0 then
			kfmenu[i] = {tmp, i, 1}
	
			if skill_usable(pid, tmp) then
				menu[i][3] = 1
			else
				menu[i][3] = 0
			end
		  
			--内力少不显示
			if JY.Person[pid]["内力"] < JY.Wugong[tmp]["消耗内力点数"] then
				kfmenu[i][3] = 0
			end

			--体力低于10不显示
			if JY.Person[pid]["体力"] < 10 then
				kfmenu[i][3] = 0
			end
			  
			numwugong = numwugong + 1
		  
		end
	end
	
	
	local menu = {}
	for i = 1,#kfmenu do
		if kfmenu[i][3] == 1 then 
			menu[#menu+1] = {kfmenu[i][1],i}
		end
	end	
	
	if #menu == 0 then
		return 0
	end
	local num = 15
	if num > #menu then 
		num = #menu 
	end	
	local size = CC.FontSmall--*0.95
	local cot = 1
	local cot1 = 0
	while true do 
		if JY.Restart == 1 then
			break
		end
		Cls()
		
		Cls()
		
		for i = 1,num do 
			lib.PicLoadCache(92,1*2,bx*25+(i-1)*bx*40,CC.ScreenH-by*60,2,255)
			local cl = C_WHITE
			if i == cot then 
				cl = C_RED
			end
			local stn = string.len(JY.Wugong[menu[i+cot1][1]]['名称'])/2
			local hsize = bx*100/stn
			draw3(JY.Wugong[menu[i+cot1][1]]['名称'],bx*25+(i-1)*bx*40,CC.ScreenH-by*60- ((stn-1)*hsize+size)/2, cl, size,nil,hsize)	
			--draw3(menu[i+cot1][1],x+(i-1)*bx*40,y - ((stn-1)*hsize+size)/2, cl, size,color2,hsize)	
		end
		ShowScreen()
		lib.Delay(CC.BattleDelay)
		
		local X, ktype, mx, my = lib.GetKey();
		if X == VK_SPACE or X == VK_RETURN then
			return War_Fight_Sub(WAR.CurID, menu[cot+cot1][2])
		elseif X == VK_ESCAPE or ktype == 4 then
			return 0
		elseif X == VK_UP then	
			
		elseif X == VK_DOWN then
			
		elseif X == VK_LEFT then
			if cot > 1 then 
				cot = cot - 1 
			else 
				if cot1 > 0 then 
					cot1 = cot1 - 1
				else 
					cot = num
					cot1 = #menu - num
				end
			end
		elseif X == VK_RIGHT then
			if cot + cot1 < #menu then 
				if cot < num then 
					cot = cot + 1
				else 
					cot1 = cot1 + 1
				end
			else 
				cot = 1
				cot1 = 0
			end	
		elseif X >= 49 and X <= 57 then
			local r = War_FightMenu(nil, nil, X-48);
			if r == 1 then 
				return 1
			end
		else 	
			local mxx = false 
			for i = 1,#menu do 
				if mx >= bx*25+(i-1)*bx*40 - bx*20 and mx <= bx*25+(i-1)*bx*40 + bx*20 and 
					my >= CC.ScreenH-by*60 - by*55 and my <= CC.ScreenH-by*60 + by*55 then 
					cot = i 
					mxx = true
					break
				end
			end
			if ktype == 3 and mxx == true then
				return War_Fight_Sub(WAR.CurID, menu[cot][2])
			end
		end
		
	end
end

Ct['绝技'] = function()
	return War_TgrtsMenu()
end

Ct['运功'] = function()
	return War_YunGongMenu()
end

Ct['战术'] = function()
	return War_TacticsMenu()
end

Ct['其他'] = function()
	return War_OtherMenu()
end

Ct['物品'] = function()
	return War_ThingMenu()
end

Ct['撤退'] = function()
	return War_Retreat()
end

Ct['自动'] = function()
	return War_AutoMenu()
end

function Rtime()
CleanWarMap(9,-1)

	local bx,by = CC.ScreenW/936,CC.ScreenH/701 
	for i = 0,WAR.PersonNum-1 do 
		local id = WAR.Person[i]['人物编号']
		local xx,yy = WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y']
		   
		local x0 = WAR.Person[WAR.CurID]["坐标X"]
		local y0 = WAR.Person[WAR.CurID]["坐标Y"]
		local dx = WAR.Person[i]["坐标X"] - x0
		local dy = WAR.Person[i]["坐标Y"] - y0
		local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
		local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
		local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)*CONFIG.Zoom/100
		ry = ry - hb
				
		--'挪移'
				if WAR.Person[i]["护盾"] ~= nil and WAR.Person[i]["护盾"] > 0 then
					local hd = WAR.Person[i]["护盾"]
					if CC.HD[hd] ~= nil then
						local ys = math.ceil(30/CC.BattleDelay)
						local t1 = CC.HD[hd].tt
						local t2 = CC.HD[hd].tt1
						if WAR.Person[i]["护盾延迟"] == nil then 
							WAR.Person[i]["护盾延迟"] = 1 
						else 
							if WAR.Person[i]["护盾延迟"] < ys then
								WAR.Person[i]["护盾延迟"] = WAR.Person[i]["护盾延迟"] + 1
							end
						end
						if WAR.Person[i]["护盾延迟"] == ys then 
							if WAR.Person[i]["护盾贴图"] == -1 then 
								WAR.Person[i]["护盾贴图"] = t1 
							else 
								WAR.Person[i]["护盾贴图"] = WAR.Person[i]["护盾贴图"] + 1
							end	
							if WAR.Person[i]["护盾贴图"] > t2 then 
								WAR.Person[i]["护盾贴图"] = t1 
							end	
							SetWarMap(xx,yy,9,WAR.Person[i]["护盾贴图"]*2)	
							WAR.Person[i]["护盾延迟"] = 0
						else	
							if WAR.Person[i]["护盾贴图"] == -1 then 
								WAR.Person[i]["护盾贴图"] = t1 
							end
							SetWarMap(xx,yy,9,WAR.Person[i]["护盾贴图"]*2)
						end	
					end
				end	
				if WAR.Person[i]["斗气"] ~= nil and WAR.Person[i]["斗气"] > 0 then
					local hd = WAR.Person[i]["斗气"]
					if CC.DOUQI[hd] ~= nil then
						local ys = math.ceil(30/CC.BattleDelay)
						local t1 = CC.DOUQI[hd].tt
						local t2 = CC.DOUQI[hd].tt1
						if WAR.Person[i]["斗气延迟"] == nil then 
							WAR.Person[i]["斗气延迟"] = 1 
						else 
							if WAR.Person[i]["斗气延迟"] < ys then
								WAR.Person[i]["斗气延迟"] = WAR.Person[i]["斗气延迟"] + 1
							end
						end
						if WAR.Person[i]["斗气延迟"] == ys then 
							if WAR.Person[i]["斗气贴图"] == -1 then 
								WAR.Person[i]["斗气贴图"] = t1 
							else 
								WAR.Person[i]["斗气贴图"] = WAR.Person[i]["斗气贴图"] + 1
							end	
							if WAR.Person[i]["斗气贴图"] > t2 then 
								WAR.Person[i]["斗气贴图"] = t1 
							end	
							SetWarMap(xx,yy,9,WAR.Person[i]["斗气贴图"]*2)	
							WAR.Person[i]["斗气延迟"] = 0
						else	
							if WAR.Person[i]["斗气贴图"] == -1 then 
								WAR.Person[i]["斗气贴图"] = t1 
							end
							SetWarMap(xx,yy,9,WAR.Person[i]["斗气贴图"]*2)
						end	
					end
				end	
	end

end

Ct['实时特效动画'] = function(s)
	CleanWarMap(9,-1)

	local bx,by = CC.ScreenW/936,CC.ScreenH/701 
	for i = 0,WAR.PersonNum-1 do
		local id = WAR.Person[i]['人物编号']
		local xx,yy = WAR.Person[i]['坐标X'],WAR.Person[i]['坐标Y']
		   
		local x0 = WAR.Person[WAR.CurID]["坐标X"]
		local y0 = WAR.Person[WAR.CurID]["坐标Y"]
		local dx = WAR.Person[i]["坐标X"] - x0
		local dy = WAR.Person[i]["坐标Y"] - y0
		local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
		local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
		local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)*CONFIG.Zoom/100
		ry = ry - hb
		
        if	WAR.Person[i]['死亡'] == false then

				if WAR.Person[i]['护盾'] ~= nil and WAR.Person[i]['护盾'] > 0 then
					local hd = WAR.Person[i]['护盾']
					if CC.HD[hd] ~= nil then
						local ys = math.ceil(30/CC.BattleDelay)
						local t1 = CC.HD[hd].tt
						local t2 = CC.HD[hd].tt1
						if WAR.Person[i]['护盾延迟'] == nil then 
							WAR.Person[i]['护盾延迟'] = 1 
						else 
							if WAR.Person[i]['护盾延迟'] < ys then
								WAR.Person[i]['护盾延迟'] = WAR.Person[i]['护盾延迟'] + 1
							end
						end
						if WAR.Person[i]['护盾延迟'] == ys then 
							if WAR.Person[i]['护盾贴图'] == -1 then 
								WAR.Person[i]['护盾贴图'] = t1 
							else 
								WAR.Person[i]['护盾贴图'] = WAR.Person[i]['护盾贴图'] + 1
							end	
							if WAR.Person[i]['护盾贴图'] > t2 then 
								WAR.Person[i]['护盾贴图'] = t1 
							end	
							SetWarMap(xx,yy,9,WAR.Person[i]['护盾贴图']*2)	
							WAR.Person[i]['护盾延迟'] = 0
						else	
							if WAR.Person[i]['护盾贴图'] == -1 then 
								WAR.Person[i]['护盾贴图'] = t1 
							end
							SetWarMap(xx,yy,9,WAR.Person[i]['护盾贴图']*2)
						end	
					end
                end	

        end       
	end
end

function Delay(tt,x,y)
	for i = 1, tt do
		Cat('实时特效动画')
		if x ~= nil and y ~= nil then 
		   WarDrawMap(1, x, y) 
		else 
		   WarDrawMap(0) 
        end
        Cat('实时特效动画2')
		ShowScreen()
		lib.Delay(CC.BattleDelay)
	end
end

function Ckstatus()
--function MapWatch()
 --WAR.ShowHead = 0
	local x = WAR.Person[WAR.CurID]["坐标X"];
	local y = WAR.Person[WAR.CurID]["坐标Y"];
	local page = 1

	War_CalMoveStep(WAR.CurID,255,1)
	WarDrawMap(1,x,y);	
	ShowScreen()
	lib.Delay(CC.BattleDelay)
	x,y=War_SelectMove()
	if x == nil then
		return
	end
	local i
	local id = -1
	for i = 0,WAR.PersonNum do
		if WAR.Person[i]["坐标X"] == x and WAR.Person[i]["坐标Y"] == y and WAR.Person[i]["死亡"] == false then
			id =  i-- WAR.Person[i]["人物编号"]
			break;
		end
	end

	if id >= 0 then
		--Cat('显示状态',id,page)
		ShowPersonStatus(id)
	end

--end
end
